{"version":3,"mappings":";ssBAiGa,MAAAA,GAA2B,OAAO,oBAAoB,EAKtDC,GACXC,GAEI,OAAOA,GAAQ,UAAYA,IAAQ,KAAa,GAElDF,MAA4BE,GAAOA,EAAIF,EAAwB,IAAM,GC3G7D,IAAAG,OACVA,IAAA,oBAAsB,CAAtB,wBACAA,EAAAC,EAAA,2CACAD,EAAAC,EAAA,2CACAD,EAAAC,EAAA,mCACAD,EAAAC,EAAA,mCACAD,EAAAC,EAAA,2CACAD,EAAAC,EAAA,iCACAD,EAAAC,EAAA,mCACAD,EAAAC,EAAA,6CACAD,EAAAC,EAAA,wCACAD,EAAAC,EAAA,0CACAD,EAAAC,EAAA,oEACAD,EAAAC,EAAA,8CACAD,EAAAC,EAAA,gCACAD,EAAAC,EAAA,gDACAD,EAAAC,EAAA,oCACAD,EAAAC,EAAA,gDACAD,EAAAC,EAAA,kDACAD,EAAAC,EAAA,4CACAD,EAAAC,EAAA,gCACAD,EAAAC,EAAA,oCACAD,EAAAC,EAAA,oCAGAD,IAAA,kBAAoB,GAApB,sBACAA,EAAAC,EAAA,2CACAD,EAAAC,EAAA,iDACAD,EAAAC,EAAA,qDA5BUD,OAAA,ICEL,MAAME,UAAwB,KAAM,CAOzC,YAAYC,EAAiBC,EAAiBC,EAA4B,CACxE,MAAMD,EAASC,CAAO,EACtB,KAAK,KAAO,kBACZ,KAAK,KAAOF,EACZ,KAAK,QAAUA,GAAQ,IAE3B,CAbaD,EACJ,UAAYF,EAcd,SAASM,GAAYC,EAAc,CACpC,KAAEA,aAAiBL,GACf,MAAAK,EAGR,GAAIA,EAAM,QACR,MAAM,IAAI,MACR,iFACA,CAAE,MAAOA,CAAM,CACjB,EAGM,cACN,yGACF,EACQ,cAAMA,EAAM,KAAK,CAC3B,CC1BO,MAAMC,EAAN,MAAMA,EAAI,CAuiBf,OAAO,MAAMC,EAAWC,EAAaC,EAAsB,CAClD,YAAK,IAAID,EAAKC,IAAQ,OAAY,KAAK,IAAIF,EAAGE,CAAG,EAAIF,CAAC,EAe/D,OAAO,OAAOG,EAAaF,EAAaC,EAAwB,CAC9D,OAAOC,EAAE,IACP,GAAAD,IAAQ,OAAYH,GAAI,MAAM,EAAGE,EAAKC,CAAG,EAAIH,GAAI,MAAM,EAAGE,CAAG,CAC/D,EAOF,OAAO,MAAMG,EAAaC,EAAaC,EAAqB,CAClD,OAAAD,EAAE,CAAC,EAAID,EAAE,CAAC,IAAME,EAAE,CAAC,EAAIF,EAAE,CAAC,IAAME,EAAE,CAAC,EAAIF,EAAE,CAAC,IAAMC,EAAE,CAAC,EAAID,EAAE,CAAC,GAYpE,OAAO,KAAKG,EAAaC,EAAO,EAAG,CACjC,MAAO,CAAC,KAAK,MAAMD,EAAE,CAAC,EAAIC,CAAI,EAAIA,EAAM,KAAK,MAAMD,EAAE,CAAC,EAAIC,CAAI,EAAIA,CAAI,EAE1E,EAjlBaT,EAMJ,IAAOI,GACL,CAAC,KAAK,IAAIA,EAAE,CAAC,CAAC,EAAG,KAAK,IAAIA,EAAE,CAAC,CAAC,CAAC,EAP7BJ,EAeJ,IAAM,CAACI,EAAaM,IAClB,CAACN,EAAE,CAAC,EAAIM,EAAE,CAAC,EAAGN,EAAE,CAAC,EAAIM,EAAE,CAAC,CAAC,EAhBvBV,EAwBJ,UAAY,CAACI,EAAaH,IACxB,CAACG,EAAE,CAAC,EAAIH,EAAGG,EAAE,CAAC,EAAIH,CAAC,EAzBjBD,EAiCJ,IAAM,CAACI,EAAaM,IAClB,KAAK,MAAMV,EAAI,IAAII,EAAGM,CAAC,EAAGV,EAAI,IAAII,EAAGM,CAAC,CAAC,EAlCrCV,EA2CJ,KAAO,CAACW,EAAUC,EAAUC,IAAqB,CAEtD,MAAMC,EAAKd,EAAI,IAAIY,EAAID,CAAE,EACnBI,EAAKf,EAAI,IAAIY,EAAIC,CAAE,EAClB,OAAAb,EAAI,IAAIc,EAAIC,CAAE,CACvB,EAhDWf,EAuDJ,MAAQ,CAACI,EAASM,IAChB,KAAK,MAAMA,EAAE,CAAC,EAAIN,EAAE,CAAC,EAAGM,EAAE,CAAC,EAAIN,EAAE,CAAC,CAAC,EAxDjCJ,EAiEJ,UAAY,CAACW,EAAcC,EAAcC,IACvCb,EAAI,OAAOW,EAAIC,EAAIC,CAAE,EAAI,EAlEvBb,EA0EJ,IAAM,CAACI,EAAaM,IAClBN,EAAE,CAAC,EAAIM,EAAE,CAAC,EAAIA,EAAE,CAAC,EAAIN,EAAE,CAAC,EA3EtBJ,EAmFJ,KAAO,CAACI,EAAaM,IACnB,KAAK,MAAMN,EAAE,CAAC,EAAIM,EAAE,CAAC,EAAGN,EAAE,CAAC,EAAIM,EAAE,CAAC,CAAC,EApFjCV,EA4FJ,MAAQ,CAACI,EAASM,IAChBV,EAAI,KAAKA,EAAI,IAAII,EAAGM,CAAC,CAAC,EA7FpBV,EAsGJ,iBAAmB,CACxBgB,EAMAC,IAEOjB,EAAI,KAAKiB,EAAGjB,EAAI,qBAAqBgB,EAAQC,CAAC,CAAC,EA/G7CjB,EA0HJ,sBAAwB,CAC7BI,EACAM,EACAO,EACAC,EAAQ,KAEDlB,EAAI,KAAKiB,EAAGjB,EAAI,0BAA0BI,EAAGM,EAAGO,EAAGC,CAAK,CAAC,EAhIvDlB,EA0IJ,2BAA6B,CAACI,EAASe,EAASF,IAC9CjB,EAAI,KAAKiB,EAAGjB,EAAI,+BAA+BI,EAAGe,EAAGF,CAAC,CAAC,EA3IrDjB,EAmJJ,IAAM,CAACI,EAASH,IACd,CAACG,EAAE,CAAC,EAAIH,EAAGG,EAAE,CAAC,EAAIH,CAAC,EApJjBD,EA4JJ,KAAO,CAACI,EAASM,IACf,CAACN,EAAE,CAAC,EAAIM,EAAE,CAAC,EAAGN,EAAE,CAAC,EAAIM,EAAE,CAAC,CAAC,EA7JvBV,EAqKJ,IAAM,CAACI,EAAaM,IAClBN,EAAE,CAAC,EAAIM,EAAE,CAAC,EAAIN,EAAE,CAAC,EAAIM,EAAE,CAAC,EAtKtBV,EA+KJ,SAAW,CAACI,EAAaM,IAA0B,CACxD,MAAMU,EAAI,CAACV,EAAE,CAAC,EAAIN,EAAE,CAAC,EAAGM,EAAE,CAAC,EAAIN,EAAE,CAAC,CAAC,EAC7BiB,EAAK,CAAC,KAAK,IAAID,EAAE,CAAC,CAAC,EAAG,KAAK,IAAIA,EAAE,CAAC,CAAC,CAAC,EACtC,IAAAE,EAAI,EAAI,KAAK,IAAID,EAAG,CAAC,EAAGA,EAAG,CAAC,CAAC,EAC7B,OAAAC,KAAK,SAAWD,EAAG,CAAC,EAAIA,EAAG,CAAC,GAAKC,EAAI,QAClC,CAACF,EAAE,CAAC,EAAIE,EAAGF,EAAE,CAAC,EAAIE,CAAC,CAC5B,EArLWtB,EA+LJ,IAAM,CAACI,EAASM,EAASa,EAAcC,EAAYC,EAAI,IAAY,CACxE,MAAMC,GAAK1B,EAAI,MAAMuB,EAAMC,CAAE,EAAID,IAASC,EAAKD,GAC/C,OAAOvB,EAAI,IAAIA,EAAI,IAAII,EAAG,EAAIsB,CAAC,EAAG1B,EAAI,IAAIU,EAAGe,CAAC,CAAC,CACjD,EAlMWzB,EAyMJ,QAAU,CAACI,EAAaM,IACtBN,EAAE,CAAC,IAAMM,EAAE,CAAC,GAAKN,EAAE,CAAC,IAAMM,EAAE,CAAC,EA1M3BV,EAmNJ,OAAS,CAACW,EAAcC,EAAcC,KAKxCD,EAAG,CAAC,EAAID,EAAG,CAAC,IAAME,EAAG,CAAC,EAAIF,EAAG,CAAC,IAAME,EAAG,CAAC,EAAIF,EAAG,CAAC,IAAMC,EAAG,CAAC,EAAID,EAAG,CAAC,GAxN5DX,EAgOJ,IAAOI,GACL,KAAK,MAAMA,EAAE,CAAC,EAAGA,EAAE,CAAC,CAAC,EAjOnBJ,EAwOJ,KAAQI,GACNA,EAAE,CAAC,EAAIA,EAAE,CAAC,EAAIA,EAAE,CAAC,EAAIA,EAAE,CAAC,EAzOtBJ,EAkPJ,IAAM,CAACI,EAASM,EAASgB,IACvB1B,EAAI,IAAII,EAAGJ,EAAI,IAAIA,EAAI,IAAIU,EAAGN,CAAC,EAAGsB,CAAC,CAAC,EAnPlC1B,EAyPJ,IAAM,IAAI2B,IACR,CAAC,KAAK,IAAI,GAAGA,EAAE,IAAInB,GAAKA,EAAE,CAAC,CAAC,CAAC,EAAG,KAAK,IAAI,GAAGmB,EAAE,OAASnB,EAAE,CAAC,CAAC,CAAC,CAAC,EA1P3DR,EAkQJ,IAAM,CAACI,EAASM,IACdV,EAAI,IAAIA,EAAI,IAAII,EAAGM,CAAC,EAAG,EAAG,EAnQxBV,EAyQJ,IAAM,IAAI2B,IACR,CAAC,KAAK,IAAI,GAAGA,EAAE,IAAInB,GAAKA,EAAE,CAAC,CAAC,CAAC,EAAG,KAAK,IAAI,GAAGmB,EAAE,OAASnB,EAAE,CAAC,CAAC,CAAC,CAAC,EA1Q3DR,EAkRJ,IAAM,CAACI,EAASH,IACd,CAACG,EAAE,CAAC,EAAIH,EAAGG,EAAE,CAAC,EAAIH,CAAC,EAnRjBD,EA2RJ,KAAO,CAACI,EAASM,IACf,CAACN,EAAE,CAAC,EAAIM,EAAE,CAAC,EAAGN,EAAE,CAAC,EAAIM,EAAE,CAAC,CAAC,EA5RvBV,EAqSJ,qBAAuB,CAC5BgB,EAMAC,IAEO,CACLjB,EAAI,MAAMiB,EAAE,CAAC,EAAGD,EAAO,KAAMA,EAAO,IAAI,EACxChB,EAAI,MAAMiB,EAAE,CAAC,EAAGD,EAAO,KAAMA,EAAO,IAAI,CAC1C,EAjTShB,EA4TJ,0BAA4B,CACjCI,EACAM,EACAO,EACAC,EAAQ,KACC,CACT,MAAMC,EAAInB,EAAI,IAAIA,EAAI,IAAIU,EAAGN,CAAC,CAAC,EACzBwB,EAAI5B,EAAI,IAAII,EAAGJ,EAAI,IAAImB,EAAGnB,EAAI,IAAIA,EAAI,IAAIiB,EAAGb,CAAC,EAAGe,CAAC,CAAC,CAAC,EAE1D,GAAID,EAAO,CACT,GAAIU,EAAE,CAAC,EAAI,KAAK,IAAIxB,EAAE,CAAC,EAAGM,EAAE,CAAC,CAAC,SAAUN,EAAE,CAAC,EAAIM,EAAE,CAAC,EAAIN,EAAIM,EAC1D,GAAIkB,EAAE,CAAC,EAAI,KAAK,IAAIxB,EAAE,CAAC,EAAGM,EAAE,CAAC,CAAC,SAAUN,EAAE,CAAC,EAAIM,EAAE,CAAC,EAAIN,EAAIM,EAC1D,GAAIkB,EAAE,CAAC,EAAI,KAAK,IAAIxB,EAAE,CAAC,EAAGM,EAAE,CAAC,CAAC,SAAUN,EAAE,CAAC,EAAIM,EAAE,CAAC,EAAIN,EAAIM,EAC1D,GAAIkB,EAAE,CAAC,EAAI,KAAK,IAAIxB,EAAE,CAAC,EAAGM,EAAE,CAAC,CAAC,SAAUN,EAAE,CAAC,EAAIM,EAAE,CAAC,EAAIN,EAAIM,CAAA,CAGrD,OAAAkB,CACT,EA7UW5B,EAsVJ,+BAAiC,CAACI,EAASe,EAASF,IAClDjB,EAAI,IAAII,EAAGJ,EAAI,IAAImB,EAAGnB,EAAI,IAAIA,EAAI,IAAIiB,EAAGb,CAAC,EAAGe,CAAC,CAAC,CAAC,EAvV9CnB,EA8VJ,IAAOI,GACL,CAAC,CAACA,EAAE,CAAC,EAAG,CAACA,EAAE,CAAC,CAAC,EA/VXJ,EAsWJ,UAAaI,GACXJ,EAAI,IAAII,CAAC,EAvWPJ,EAiXJ,MAAQ,CAACI,EAASM,EAASmB,IAC5B7B,EAAI,QAAQI,EAAGM,CAAC,EAAUN,EACvBJ,EAAI,IAAII,EAAGJ,EAAI,IAAIA,EAAI,IAAIA,EAAI,IAAIU,EAAGN,CAAC,CAAC,EAAGyB,CAAC,CAAC,EAnX3C7B,EA4XJ,aAAe,CAACI,EAAaI,EAAWqB,IACtC,CAAC,KAAK,IAAIrB,CAAC,EAAIqB,EAAIzB,EAAE,CAAC,EAAG,KAAK,IAAII,CAAC,EAAIqB,EAAIzB,EAAE,CAAC,CAAC,EA7X7CJ,EAoYJ,IAAOI,GACL,CAACA,EAAE,CAAC,EAAG,CAACA,EAAE,CAAC,CAAC,EArYVJ,EAwYJ,YAAc,CAACI,EAASM,EAASoB,IAAyB,CAC/D,IAAIX,EAAInB,EAAI,IAAIA,EAAI,IAAIU,EAAGN,CAAC,CAAC,EAC7B,OAAIJ,EAAI,QAAQI,EAAGM,CAAC,IAAOS,EAAAf,GACpBJ,EAAI,IAAII,EAAGJ,EAAI,IAAImB,EAAGW,CAAM,CAAC,CACtC,EA5YW9B,EAoZJ,cAAgB,CAACI,EAASM,EAASqB,EAAQ,IACzC,MAAM,KAAK,CAAE,OAAQA,CAAO,GAAE,IAAI,CAACC,EAAGC,IAAM,CAC3C,MAAAP,EAAIO,GAAKF,EAAQ,GACjBG,EAAI,KAAK,IAAI,EAAG,GAAM,KAAK,IAAI,GAAMR,CAAC,CAAC,EACtC,OAAC,GAAG1B,EAAI,IAAII,EAAGM,EAAGgB,CAAC,EAAGQ,CAAC,EAC/B,EAzZQlC,EAiaJ,IAAM,CAACI,EAAaM,IAClBV,EAAI,IAAII,EAAGM,CAAC,EAAIV,EAAI,IAAIU,CAAC,EAlavBV,EAqaJ,QAAU,CAACQ,EAAaP,IAAwB,CAC/C,MAAAkC,EAAInC,EAAI,IAAIQ,CAAC,EACZ,OAAEP,EAAIO,EAAE,CAAC,EAAK2B,EAAIlC,EAAIO,EAAE,CAAC,EAAK2B,CAAC,CACxC,EAxaWnC,EA+aJ,IAAM,CAACI,EAAakB,EAAI,IACtB,CACLlB,EAAE,CAAC,EAAI,KAAK,IAAIkB,CAAC,EAAIlB,EAAE,CAAC,EAAI,KAAK,IAAIkB,CAAC,EACtClB,EAAE,CAAC,EAAI,KAAK,IAAIkB,CAAC,EAAIlB,EAAE,CAAC,EAAI,KAAK,IAAIkB,CAAC,CACxC,EAnbStB,EA4bJ,QAAU,CAACI,EAASwB,EAASN,EAAI,IAAY,CAC9C,GAAAA,IAAM,EAAU,OAAAlB,EAEd,MAAAqB,EAAI,KAAK,IAAIH,CAAC,EACdc,EAAI,KAAK,IAAId,CAAC,EAEde,EAAKjC,EAAE,CAAC,EAAIwB,EAAE,CAAC,EACfU,EAAKlC,EAAE,CAAC,EAAIwB,EAAE,CAAC,EAEfW,EAAKF,EAAKD,EAAIE,EAAKb,EACnBe,EAAKH,EAAKZ,EAAIa,EAAKF,EAElB,OAACG,EAAKX,EAAE,CAAC,EAAGY,EAAKZ,EAAE,CAAC,CAAC,CAC9B,EAzcW5B,EAgdJ,MAAQ,CAACI,EAAaM,IACvBN,EAAE,CAAC,IAAMM,EAAE,CAAC,EAAU,KAClBN,EAAE,CAAC,EAAIM,EAAE,CAAC,IAAMN,EAAE,CAAC,EAAIM,EAAE,CAAC,GAldzBV,EA0dJ,IAAM,CAACI,EAASM,IACd,CAACN,EAAE,CAAC,EAAIM,EAAE,CAAC,EAAGN,EAAE,CAAC,EAAIM,EAAE,CAAC,CAAC,EA3dvBV,EAmeJ,UAAY,CAACI,EAASH,IACpB,CAACG,EAAE,CAAC,EAAIH,EAAGG,EAAE,CAAC,EAAIH,CAAC,EApejBD,EA6eJ,QAAU,CAACI,EAASM,IAClBV,EAAI,IAAIA,EAAI,IAAII,EAAGM,CAAC,CAAC,EA9enBV,EAqfJ,QAAWQ,GACTA,EAAE,IAASmB,GAAA,KAAK,MAAMA,EAAI,GAAG,EAAI,GAAG,EAtflC3B,EAyfJ,QAAW2B,IACT,CACL,EAAGA,EAAE,CAAC,EACN,EAAGA,EAAE,CAAC,CACR,GA7fS3B,EAqgBJ,YAAc,CAACQ,EAAaP,EAAI,IAC9B,CAAC,CAACO,EAAE,CAAC,EAAE,YAAYP,CAAC,EAAG,CAACO,EAAE,CAAC,EAAE,YAAYP,CAAC,CAAC,EAtgBzCD,EAygBJ,MAAS2B,GAAsC,CAACA,EAAE,EAAGA,EAAE,CAAC,EAzgBpD3B,EA+gBJ,IAAOI,GACLJ,EAAI,IAAII,EAAGJ,EAAI,IAAII,CAAC,CAAC,EAhhBnBJ,EAwhBJ,IAAM,CAACI,EAASM,IAEd,CAACA,EAAE,CAAC,EAAIN,EAAE,CAAC,EAAGM,EAAE,CAAC,EAAIN,EAAE,CAAC,CAAC,EA1hB7B,IAAMqC,EAANzC,ECDA,MAAM0C,WAAsB,KAA8B,CAgD/D,YACEC,EAAc,CAAC,EAAG,CAAC,EACnBC,EAAgB,CAAC,EAAG,CAAC,EACrBC,EAAc,CAAC,EAAG,CAAC,EACnBC,EAAe,CAAC,EAAG,CAAC,EACpB,CACA,MAAM,CAAC,EArDG,UAAC,EAAG,CAAC,EAEJ,WAAC,EAAG,CAAC,EAGD,eAAC,EAAG,CAAC,EAiDf,MAAC,EAAIH,EAAM,CAAC,EACZ,MAAC,EAAIA,EAAM,CAAC,EACjB,KAAK,SAAWC,EAChB,KAAK,IAAMC,EACX,KAAK,KAAOC,CAAA,CA/Cd,IAAI,OAAQ,CACV,OAAOL,EAAI,IAAI,KAAM,KAAK,GAAG,EAG/B,IAAI,QAAS,CACX,OAAOA,EAAI,IAAI,KAAM,KAAK,IAAI,EAGhC,IAAI,IAAK,CACP,OAAO,KAAK,IAGd,IAAI,GAAGM,EAAa,CAClB,KAAK,IAAMA,CAAA,CAGb,IAAa,QAAS,CACpB,OAAO,MAAM,OAGf,IAAI,KAAM,CACR,OAAO,KAAK,KAGd,IAAI,IAAIA,EAAa,CACnB,KAAK,KAAOA,CAAA,CAGd,IAAI,SAAU,CACZ,OAAO,KAAK,SAGd,IAAI,QAAQA,EAAa,CACvB,KAAK,SAAWA,CAAA,CAiBlB,OAAO,QAAQC,EAAW,CAClB,MAAAL,EAAQ,IAAID,GACZ,OAAAC,EAAA,CAAC,EAAIK,EAAI,CAAC,EACVL,EAAA,CAAC,EAAIK,EAAI,CAAC,EACTL,CAAA,CAGT,OAAQ,CACN,OAAO,IAAID,GACT,KACA,KAAK,SACL,KAAK,IACL,KAAK,IACP,EAGF,OAAOM,EAAW,CACX,aAAC,EAAIA,EAAI,CAAC,EACV,MAAC,EAAIA,EAAI,CAAC,EACR,KAGT,OAAc,CACZ,MAAO,CAAC,KAAK,CAAC,EAAG,KAAK,CAAC,CAAC,EAE5B,CCzFO,MAAMC,GAAU,MACVC,GAAkB,QAClBC,GAAM,KAAK,GAAK,EAChBC,GAAoB,KAE1B,SAASC,IAAqB,CACnC,OAAO,KAAK,MAAM,KAAK,OAAO,EAAI,GAAK,EAAE,CAC3C,CAoBO,SAASC,GACdC,EACAC,EACAC,EACAC,EACAC,EAAW,GACE,CACb,MAAM7C,EAAK2B,EAAI,IAAIe,EAAID,CAAE,EACnBxC,EAAK0B,EAAI,IAAIiB,EAAKD,CAAG,EACrBG,EAAQnB,EAAI,IAAI3B,EAAIC,CAAE,EAE5B,GAAI8C,GAAYD,EAAO,EAAGV,EAAe,EAAU,YACnD,MAAMrB,EAAIY,EAAI,IAAIc,EAAIE,CAAG,EACzB,IAAIK,EAAKrB,EAAI,IAAI1B,EAAIc,CAAC,EAAI+B,EAC1B,MAAMG,EAAKtB,EAAI,IAAI3B,EAAIe,CAAC,EAAI+B,EAI1BI,EAAiBf,GACjBgB,EAAO,CAACD,EACRE,EAAO,EAAIF,EAET,OAAAL,GAAaM,EAAOH,GAAMA,EAAKI,GAAQD,EAAOF,GAAMA,EAAKG,GAGtDP,IACEG,EAAA5C,GAAM4C,EAAI,EAAG,CAAC,GAEdrB,EAAI,IAAIc,EAAIC,EAAIM,CAAE,GAGpB,IACT,CAUgB,SAAAK,GAAoBC,EAAgBzB,EAAa,CAC/D,MAAM0B,EAAMD,EAAO,OACnB,GAAIC,EAAM,EACF,UAAI,MAAM,qCAAqC,EAGnD,IAAAC,EAAYF,EAAO,CAAC,EACpBG,EAAM9B,EAAI,KAAK2B,EAAO,CAAC,EAAGzB,CAAK,EAEnC,QAAS,EAAI,EAAG,EAAI0B,EAAK,IAAK,CACtB,MAAAG,EAAIJ,EAAO,CAAC,EACZvD,EAAKuD,GAAQ,EAAI,GAAKC,CAAG,EACzBI,EAAOhC,EAAI,0BAA0B+B,EAAG3D,EAAI8B,EAAO,EAAI,EACvD+B,EAASjC,EAAI,KAAKgC,EAAM9B,CAAK,EAC/B+B,EAASH,IACLA,EAAAG,EACAJ,EAAAG,EACR,CAEK,OAAAH,CACT,CAEgB,SAAAK,GAAqBP,EAAgBzB,EAAa,CAC1D,MAAAiC,EAAUT,GAAoBC,EAAQzB,CAAK,EAC1C,OAAAF,EAAI,KAAKmC,EAASjC,CAAK,CAChC,CAEgB,SAAAkC,GACdT,EACAU,EACAC,EACK,CACC,MAAAC,EAAMC,GAASF,CAAM,EACpB,OAAAX,EAAO,IAASI,GAAA/B,EAAI,QAAQ+B,EAAGM,EAAQE,CAAG,CAAC,CACpD,CAEgB,SAAAE,GACdvC,EACAmC,EACAC,EACkB,CACZ,MAAAC,EAAMC,GAASF,CAAM,EACpB,OAAAtC,EAAI,IAAIqC,EAAQrC,EAAI,IAAIA,EAAI,IAAIE,EAAOmC,CAAM,EAAGE,CAAG,CAAC,CAI7D,CAEO,SAASC,GAASE,EAAe,CAC9B,OAAAA,EAAQ,KAAK,GAAM,GAC7B,CAEgB,SAAAC,GAAqBzC,EAAa0C,EAAc,CACxD,MAAC9B,EAAIC,CAAE,EAAI6B,EACXvE,EAAK2B,EAAI,IAAIE,EAAOY,CAAE,EACtBxC,EAAK0B,EAAI,IAAIE,EAAOa,CAAE,EAC5B,OAAOK,GAAYpB,EAAI,IAAI3B,EAAIC,CAAE,EAAG,EAAG,GAAI,GAAK0B,EAAI,IAAI3B,EAAIC,CAAE,GAAK,CACrE,CAEgB,SAAAuE,GAAuBlB,EAAgBzB,EAAmB,CACxE,MAAM0B,EAAMD,EAAO,OACnB,QAASnC,EAAI,EAAGA,EAAIoC,EAAKpC,IAAK,CACtB,MAAAuC,EAAIJ,EAAOnC,CAAC,EACZpB,EAAKuD,GAAQnC,EAAI,GAAKoC,CAAG,EAC/B,GAAIe,GAAqBzC,EAAO,CAAC6B,EAAG3D,CAAE,CAAC,EACrC,OAAO4B,EAAI,UAAUA,EAAI,IAAI5B,EAAI2D,CAAC,CAAC,CACrC,CAEK,OAAC,EAAG,CAAC,CACd,CAEgB,SAAAe,GACdhC,EACAC,EACAY,EACwB,CACxB,MAAMoB,EAA0B,CAAC,EAC3BnB,EAAMD,EAAO,OAEnB,QAAS,EAAI,EAAG,EAAIC,EAAK,IAAK,CACtB,MAAAG,EAAIJ,EAAO,CAAC,EACZvD,EAAKuD,GAAQ,EAAI,GAAKC,CAAG,EACzBC,EAAMhB,GAAeC,EAAIC,EAAIgB,EAAG3D,CAAE,EACxC,GAAIyD,EAAK,CACD,MAAA3C,EAAI,IAAIe,GAAc4B,CAAG,EAC/B3C,EAAE,QAAUc,EAAI,UAAUA,EAAI,IAAI5B,EAAI2D,CAAC,CAAC,EACxCgB,EAAO,KAAK7D,CAAC,EACf,CAGK,OAAA6D,EAAO,OAASA,EAAS,IAClC,CAEgB,SAAAC,GACdlC,EACAC,EACAY,EACwB,CACxB,MAAMoB,EAA0B,CAAC,EAC3BnB,EAAMD,EAAO,OAEnB,QAAS,EAAI,EAAG,EAAIC,EAAM,EAAG,IAAK,CAC1B,MAAAG,EAAIJ,EAAO,CAAC,EACZvD,EAAKuD,EAAO,EAAI,CAAC,EACjBE,EAAMhB,GAAeC,EAAIC,EAAIgB,EAAG3D,CAAE,EACpCyD,GACFkB,EAAO,KAAK,IAAI9C,GAAc4B,EAAK7B,EAAI,UAAUA,EAAI,IAAI5B,EAAI2D,CAAC,CAAC,CAAC,CAAC,CACnE,CAGK,OAAAgB,EAAO,OAASA,EAAS,IAClC,CAEgB,SAAAE,GAAqBtB,EAAgBzB,EAAa,CAChE,MAAM0B,EAAMD,EAAO,OACf,IAAAE,EACAC,EAAM,IACV,QAAS,EAAI,EAAG,EAAIF,EAAM,EAAG,IAAK,CAC1B,MAAAG,EAAIJ,EAAO,CAAC,EACZvD,EAAKuD,EAAO,EAAI,CAAC,EACjBK,EAAOhC,EAAI,0BAA0B+B,EAAG3D,EAAI8B,EAAO,EAAI,EACvD+B,EAASjC,EAAI,KAAKgC,EAAM9B,CAAK,EAC/B+B,EAASH,IACLA,EAAAG,EACAJ,EAAAG,EACR,CAEK,OAAAH,CACT,CAEO,SAASqB,GACdC,EACAxB,EACAW,EACAc,EACAC,EACS,CAGL,IAAAzF,EACAC,EAEJ,GAAIyE,IAAW,EACT1E,EAAAwF,EAAS,CAAC,EAAID,EAAQ,EACtBtF,EAAAuF,EAAS,CAAC,EAAID,EAAQ,MACrB,CAEL,KAAM,CAAE,KAAAG,EAAM,KAAAC,EAAM,KAAAC,EAAM,KAAAC,CAAS,EAAAN,EAC7BO,EAAejB,GACnBW,EACA,CAACE,GAAQE,EAAOF,GAAQ,EAAGC,GAAQE,EAAOF,GAAQ,CAAC,EACnD,CAACjB,CACH,EACI1E,EAAA8F,EAAa,CAAC,EAAIP,EAAQ,EAC1BtF,EAAA6F,EAAa,CAAC,EAAIP,EAAQ,EAG5B,IAACxF,EAAGM,CAAC,EAAI0D,EACTnD,EAIF,GAAAmF,GAAWhG,EAAE,CAAC,EAAGA,EAAE,CAAC,EAAGC,EAAGC,CAAC,EAAIwF,GAC/BM,GAAW1F,EAAE,CAAC,EAAGA,EAAE,CAAC,EAAGL,EAAGC,CAAC,EAAIwF,EAExB,SAIT,QAAS7D,EAAI,EAAGA,EAAImC,EAAO,OAAQnC,IAAK,CACtC,MAAMoE,EAAQ,CAAC3F,EAAE,CAAC,EAAIN,EAAE,CAAC,EAAGM,EAAE,CAAC,EAAIN,EAAE,CAAC,CAAC,EACjCkG,EAAS,KAAK,MAAMD,EAAM,CAAC,EAAGA,EAAM,CAAC,CAAC,EAEtCE,EAAI,CAACF,EAAM,CAAC,EAAIC,EAAQD,EAAM,CAAC,EAAIC,CAAM,EACzC1E,EAAI,CAACvB,EAAID,EAAE,CAAC,EAAGE,EAAIF,EAAE,CAAC,CAAC,EACvByB,GAAKD,EAAE,CAAC,EAAI2E,EAAE,CAAC,EAAI3E,EAAE,CAAC,EAAI2E,EAAE,CAAC,GAAK,KAAK,MAAMA,EAAE,CAAC,EAAGA,EAAE,CAAC,CAAC,EAC7DtF,EAAI,CAACb,EAAE,CAAC,EAAImG,EAAE,CAAC,EAAI1E,EAAGzB,EAAE,CAAC,EAAImG,EAAE,CAAC,EAAI1E,CAAC,EAErC,MAAM2E,EAAKJ,GAAWnF,EAAE,CAAC,EAAGA,EAAE,CAAC,EAAGb,EAAE,CAAC,EAAGA,EAAE,CAAC,CAAC,EACtCqG,EAAKL,GAAWnF,EAAE,CAAC,EAAGA,EAAE,CAAC,EAAGP,EAAE,CAAC,EAAGA,EAAE,CAAC,CAAC,EAIxC,GAFAO,EAAAwF,EAAKD,GAAMA,EAAKF,EAAS5F,EAAI8F,EAAKC,GAAMA,EAAKH,EAASlG,EAAIa,EAE1D,KAAK,MAAMX,EAAIW,EAAE,CAAC,EAAGZ,EAAIY,EAAE,CAAC,CAAC,EAAI6E,EAC5B,SAGL1F,EAAAM,EACAA,EAAA0D,EAAOnC,EAAI,CAAC,EAGX,QACT,CAEO,MAAMmE,GAAa,CAACM,EAAYC,EAAYC,EAAYC,IAAe,CAC5E,MAAMC,EAAKF,EAAKF,EACVK,EAAKF,EAAKF,EACT,YAAK,MAAMG,EAAIC,CAAE,CAC1B,EAEA,SAASC,GAAOC,EAAa,CAC3B,OAAOA,EAAMA,CACf,CAEA,SAASC,GAAOvF,EAASwF,EAAS,CAChC,OAAOH,GAAOrF,EAAE,CAAC,EAAIwF,EAAE,CAAC,CAAC,EAAIH,GAAOrF,EAAE,CAAC,EAAIwF,EAAE,CAAC,CAAC,CACjD,CAEA,SAASC,GAAqB5C,EAAS7C,EAASwF,EAAS,CACjD,MAAAE,EAAKH,GAAOvF,EAAGwF,CAAC,EAEtB,GAAIE,GAAM,EAAU,OAAAH,GAAO1C,EAAG7C,CAAC,EAC3B,IAAAD,IAAM8C,EAAE,CAAC,EAAI7C,EAAE,CAAC,IAAMwF,EAAE,CAAC,EAAIxF,EAAE,CAAC,IAAM6C,EAAE,CAAC,EAAI7C,EAAE,CAAC,IAAMwF,EAAE,CAAC,EAAIxF,EAAE,CAAC,IAAM0F,EAE1E,OAAA3F,EAAI,KAAK,IAAI,EAAG,KAAK,IAAI,EAAGA,CAAC,CAAC,EAEvBwF,GAAO1C,EAAG,CAAC7C,EAAE,CAAC,EAAID,GAAKyF,EAAE,CAAC,EAAIxF,EAAE,CAAC,GAAIA,EAAE,CAAC,EAAID,GAAKyF,EAAE,CAAC,EAAIxF,EAAE,CAAC,EAAE,CAAC,CACvE,CAEA,SAAS2F,GAAc9C,EAAS7C,EAASwF,EAAS,CAChD,OAAO,KAAK,KAAKC,GAAqB5C,EAAG7C,EAAGwF,CAAC,CAAC,CAChD,CAMgB,SAAAI,GAAW/G,EAAWgH,EAAoB,CAEtD,OAAAhH,EAAE,EAAIgH,EAAE,EAAIA,EAAE,GAAKhH,EAAE,EAAIA,EAAE,EAAIgH,EAAE,GAAKhH,EAAE,EAAIgH,EAAE,EAAIA,EAAE,GAAKhH,EAAE,EAAIA,EAAE,EAAIgH,EAAE,CAE3E,CAEO,SAAS3D,GAAYrD,EAAWgH,EAAWxD,EAAU,KAAQ,CAClE,OAAO,KAAK,IAAIxD,EAAIgH,CAAC,EAAIxD,CAC3B,CAEO,SAASyD,GAAU9F,EAAS,CACjC,OAAOA,EAAE,MAAW1B,GAAAyH,GAAOzH,CAAC,CAAC,CAC/B,CAEO,SAASyH,GAAOrH,EAAW,CACzB,OAAAA,GAAK,CAAC4C,IAAW5C,GAAK4C,EAC/B,CAMgB,SAAA/B,GAAMjB,EAAWC,EAAaC,EAAsB,CAC3D,YAAK,IAAID,EAAKC,IAAQ,OAAY,KAAK,IAAIF,EAAGE,CAAG,EAAIF,CAAC,CAC/D,CAEO,SAAS0H,GACdvH,EACAwB,EACAgG,EACAC,EACAC,EAAW,EACF,CACH,MAAAC,EAAM,KAAK,IAAID,CAAQ,EACvBE,EAAM,KAAK,IAAIF,CAAQ,EACvBzB,EAAQ5D,EAAI,IAAIrC,EAAGwB,CAAC,EACpBqG,EAAMF,EAAM1B,EAAM,CAAC,EAAI2B,EAAM3B,EAAM,CAAC,EACpC6B,EAAMF,EAAM3B,EAAM,CAAC,EAAI0B,EAAM1B,EAAM,CAAC,EAE1C,OAAQ4B,EAAMA,GAAQL,EAAKA,GAAOM,EAAMA,GAAQL,EAAKA,IAAO,CAC9D,CAEgB,SAAAM,GAAe3D,EAASJ,EAAyB,CAC/D,IAAIgE,EAAK,EAEF,OAAAhE,EAAA,QAAQ,CAAC5D,EAAGyB,IAAM,CACvB,MAAMuF,EAAIpD,GAAQnC,EAAI,GAAKmC,EAAO,MAAM,EACpC5D,EAAE,CAAC,GAAKgE,EAAE,CAAC,EACTgD,EAAE,CAAC,EAAIhD,EAAE,CAAC,GAAK/B,EAAI,MAAMjC,EAAGgH,EAAGhD,CAAC,EAAI,IAChC4D,GAAA,GAECZ,EAAE,CAAC,GAAKhD,EAAE,CAAC,GAAK/B,EAAI,MAAMjC,EAAGgH,EAAGhD,CAAC,EAAI,IACxC4D,GAAA,EACR,CACD,EAEMA,IAAO,CAChB,CAuBgB,SAAAC,GACd7D,EACAJ,EACA0B,EACS,CACT,QAAS7D,EAAI,EAAGA,EAAImC,EAAO,OAAQ,EAAEnC,EAAG,CACtC,MAAMqG,EAAOrG,EAAI,IAAMmC,EAAO,OAAS,EAAInC,EAAI,EAC3C,GAAAqF,GAAc9C,EAAGJ,EAAOnC,CAAC,EAAGmC,EAAOkE,CAAI,CAAC,GAAKxC,EACxC,QACT,CAGK,QACT,CAsBgB,SAAAyC,GAAqBnE,EAAgBoE,EAAS,GAAc,CAC1E,MAAMnE,EAAMD,EAAO,OAEnB,GAAIC,EAAM,EACD,SAGL,IAAA7D,EAAI4D,EAAO,CAAC,EACZoD,EAAIpD,EAAO,CAAC,EACV,MAAAhC,EAAIgC,EAAO,CAAC,EAElB,IAAIoB,EAAS,IAAIhF,EAAE,CAAC,EAAE,QAAQ,CAAC,CAAC,IAAIA,EAAE,CAAC,EAAE,QAAQ,CAAC,CAAC,KAAKgH,EAAE,CAAC,EAAE,QAC3D,EACD,IAAIA,EAAE,CAAC,EAAE,QAAQ,CAAC,CAAC,IAAIiB,GAAQjB,EAAE,CAAC,EAAGpF,EAAE,CAAC,CAAC,EAAE,QAAQ,CAAC,CAAC,IAAIqG,GACxDjB,EAAE,CAAC,EACHpF,EAAE,CAAC,GACH,QAAQ,CAAC,CAAC,KAEZ,QAASH,EAAI,EAAG9B,EAAMkE,EAAM,EAAGpC,EAAI9B,EAAK8B,IACtCzB,EAAI4D,EAAOnC,CAAC,EACRuF,EAAApD,EAAOnC,EAAI,CAAC,EACNuD,GAAA,GAAGiD,GAAQjI,EAAE,CAAC,EAAGgH,EAAE,CAAC,CAAC,EAAE,QAAQ,CAAC,CAAC,IAAIiB,GAAQjI,EAAE,CAAC,EAAGgH,EAAE,CAAC,CAAC,EAAE,QACjE,CACD,KAGH,OAAIgB,IACQhD,GAAA,KAGLA,CACT,CAEA,SAASiD,GAAQjI,EAAWgH,EAAmB,CAC7C,OAAQhH,EAAIgH,GAAK,CACnB,CAGO,SAASkB,GACdtI,EACAM,EACAkB,EACAgG,EACAC,EACA7C,EAAM,EACN,CACI5E,EAAAqC,EAAI,IAAIA,EAAI,IAAIrC,EAAGwB,CAAC,EAAG,CAACoD,CAAG,EAC3BtE,EAAA+B,EAAI,IAAIA,EAAI,IAAI/B,EAAGkB,CAAC,EAAG,CAACoD,CAAG,EAEzB4C,KACAC,KAEN,MAAMvD,EAAc,CAAC,EAEf3C,EAAIc,EAAI,IAAI/B,EAAGN,CAAC,EAEhBI,EAAIoH,EAAKjG,EAAE,CAAC,EAAIA,EAAE,CAAC,EAAIkG,EAAKlG,EAAE,CAAC,EAAIA,EAAE,CAAC,EACtC6F,EAAI,GAAKI,EAAKxH,EAAE,CAAC,EAAIuB,EAAE,CAAC,EAAIkG,EAAKzH,EAAE,CAAC,EAAIuB,EAAE,CAAC,GAC3CS,EAAIwF,EAAKxH,EAAE,CAAC,EAAIA,EAAE,CAAC,EAAIyH,EAAKzH,EAAE,CAAC,EAAIA,EAAE,CAAC,EAAIwH,EAAKC,EAE/Cc,EAAInB,EAAIA,EAAI,EAAIhH,EAAI4B,EAE1B,GAAIuG,GAAK,EAAG,CACJ,MAAAC,EAAQ,KAAK,KAAKD,CAAC,EACnBE,GAAM,CAACrB,EAAIoB,IAAU,EAAIpI,GACzBsI,GAAM,CAACtB,EAAIoB,IAAU,EAAIpI,GAE3B,GAAKqI,GAAMA,GAAM,GACnBvE,EAAI,KAAK7B,EAAI,IAAIA,EAAI,IAAIA,EAAI,IAAIA,EAAI,IAAId,EAAGkH,CAAE,EAAGzI,CAAC,EAAG4E,CAAG,EAAGpD,CAAC,CAAC,EAE3D,GAAKkH,GAAMA,GAAM,GAAK,KAAK,IAAID,EAAKC,CAAE,EAAI,OAC5CxE,EAAI,KAAK7B,EAAI,IAAIA,EAAI,IAAIA,EAAI,IAAIA,EAAI,IAAId,EAAGmH,CAAE,EAAG1I,CAAC,EAAG4E,CAAG,EAAGpD,CAAC,CAAC,EAG7D,OAAA0C,EAAI,SAAW,EAAU,KAEtBA,EAAI,IAAI3C,GAAK,CACZ,MAAAoH,EAAK,IAAIrG,GAAcf,CAAC,EACxBqH,EAAevG,EAAI,IAAIA,EAAI,KAAKA,EAAI,IAAId,EAAGC,CAAC,EAAG,CAACgG,EAAKA,EAAIC,EAAKA,CAAE,CAAC,CAAC,EACrE,OAAAkB,EAAA,QAAU,CAAC,CAACC,EAAa,CAAC,EAAGA,EAAa,CAAC,CAAC,EACxCD,CAAA,CACR,CACH,CAEO,SAASE,GAAKC,EAAgB,CAC5B,OAAAA,EAAS,EAAI,EAAI,EAC1B,CAEgB,SAAAC,GACdnI,EACA2B,EACM,CACN,KAAM,CAAE,EAAAtC,EAAG,EAAAC,EAAG,EAAA6G,EAAG,EAAAiC,EAAG,OAAArE,GAAW/D,EAE3B,IAAC+D,EAAe,OAAApC,EAEd,MAAA0G,EAAKhJ,EAAI8G,EAAI,EACbmC,EAAKhJ,EAAI8I,EAAI,EAEbG,EAAI,IAAI,UAAU,EACrB,cAAcF,EAAIC,CAAE,EACpB,WAAWvE,CAAM,EACjB,cAAc,CAACsE,EAAI,CAACC,CAAE,EAEnB9E,EAAI,IAAI,SAAS,GAAG7B,CAAK,EAAE,gBAAgB4G,CAAC,EAClD,MAAO,CAAC/E,EAAE,EAAGA,EAAE,CAAC,CAClB,CAEO,SAASgF,GAAkBrE,EAAe,CAC3C,OAAAA,EAAQ,IAAYA,GAAA,KACfA,GAAA,IACFA,CACT,CAEO,SAASsE,GAASC,EAAgB,CAC/B,OAAAA,EAAS,IAAO,KAAK,EAC/B,CAGO,SAASC,GACdC,EACAC,EACAC,EACAC,EAAS,GACT,CACM,MAAAC,EAAOD,EACT,CAACvJ,EAAWgH,IAAchH,EAAIgH,EAC9B,CAAChH,EAAWgH,IAAchH,GAAKgH,EACnC,MAAO,EACLwC,EACE,KAAK,IAAIJ,EAAM,CAAC,EAAEE,CAAI,EAAGF,EAAM,CAAC,EAAEE,CAAI,CAAC,EACvC,KAAK,IAAID,EAAM,CAAC,EAAEC,CAAI,EAAGD,EAAM,CAAC,EAAEC,CAAI,CAAC,IAEzCE,EACE,KAAK,IAAIH,EAAM,CAAC,EAAEC,CAAI,EAAGD,EAAM,CAAC,EAAEC,CAAI,CAAC,EACvC,KAAK,IAAIF,EAAM,CAAC,EAAEE,CAAI,EAAGF,EAAM,CAAC,EAAEE,CAAI,CAAC,GAG7C,CAEgB,SAAAG,GAAoBjJ,EAAgBkJ,EAAe,CACjE,KAAM,CAAE,EAAA7J,EAAG,EAAAC,EAAG,EAAA6G,EAAG,EAAAiC,EAAG,OAAArE,GAAW/D,EACzBqI,EAAKhJ,EAAI8G,EAAI,EACbmC,EAAKhJ,EAAI8I,EAAI,EACbe,EAAKhD,EAAI+C,EACTE,EAAKhB,EAAIc,EACR,OACL,EAAGb,EAAKc,EAAK,EACb,EAAGb,EAAKc,EAAK,EACb,EAAGD,EACHC,EACA,OAAArF,CACF,CACF,CC9iBO,SAASsF,GACdhK,EACAC,EACA6G,EACAiC,EACgB,CAChB,MAAO,IAAI/I,CAAC,IAAIC,CAAC,IAAI6G,CAAC,IAAIiC,CAAC,GAC7B,CAEO,SAASkB,GAAgBC,EAAoB,CAC9C,IACK,YAAK,MAAMA,CAAI,QACfC,EAAG,CACF,qBAAM,6BAA8BD,CAAI,EAChD,QAAQ,MAAMC,CAAC,EAER,CAAC,EAAG,EAAG,EAAG,CAAC,EAEtB,CCvBgB,SAAAC,GACdrG,EACA0D,EAAW,EAMX,CACA,IAAI/B,EAAO,IACPC,EAAO,IACPC,EAAO,KACPC,EAAO,KAEP,GAAA9B,EAAO,OAAS,EACX2B,EAAA,EACAC,EAAA,EACAC,EAAA,EACAC,EAAA,MAEP,UAAW,CAAC7F,EAAGC,CAAC,IAAK8D,EACZ2B,EAAA,KAAK,IAAI1F,EAAG0F,CAAI,EAChBC,EAAA,KAAK,IAAI1F,EAAG0F,CAAI,EAChBC,EAAA,KAAK,IAAI5F,EAAG4F,CAAI,EAChBC,EAAA,KAAK,IAAI5F,EAAG4F,CAAI,EAI3B,OAAI4B,IAAa,EACR2C,GACLrG,EAAO,IACLsG,GAAAjI,EAAI,QAAQiI,EAAI,EAAE3E,EAAOE,GAAQ,GAAID,EAAOE,GAAQ,CAAC,EAAG4B,CAAQ,EAEpE,EAGK,CACL,KAAA/B,EACA,KAAAC,EACA,KAAAC,EACA,KAAAC,EACA,EAAGH,EACH,EAAGC,EACH,EAAGC,EAAOF,EACV,EAAGG,EAAOF,CACZ,CACF,CAaO,MAAM2E,EAAwB,CASnC,IAAI,IAAW,CACb,MAAO,CAAC,KAAK,EAAG,KAAK,EAAI,KAAK,CAAC,EAGjC,IAAI,IAAW,CACN,OAAC,KAAK,EAAI,KAAK,EAAG,KAAK,EAAI,KAAK,CAAC,EAG1C,IAAI,QAAe,CACV,OAAC,KAAK,EAAI,KAAK,EAAI,EAAG,KAAK,EAAI,KAAK,EAAI,CAAC,EAGlD,IAAI,OAAO,CAACtB,EAAIC,CAAE,EAAS,CACzB,KAAM,CAACjH,EAAIC,CAAE,EAAI,KAAK,OACtB,KAAK,GAAK+G,EAAKhH,EACf,KAAK,GAAKiH,EAAKhH,CAAA,CAGjB,IAAI,gBAAyB,CACpB,OACL,CAAC,KAAK,EAAG,KAAK,EAAI,KAAK,EAAI,CAAC,EAC5B,CAAC,KAAK,EAAI,KAAK,EAAG,KAAK,EAAI,KAAK,EAAI,CAAC,CACvC,EAGF,IAAI,UAAmB,CACd,OACL,CAAC,KAAK,EAAG,KAAK,CAAC,EACf,CAAC,KAAK,EAAG,KAAK,EAAI,KAAK,CAAC,CAC1B,EAGF,IAAI,WAAoB,CACf,OACL,CAAC,KAAK,EAAG,KAAK,EAAI,KAAK,CAAC,EACxB,CAAC,KAAK,EAAI,KAAK,EAAG,KAAK,EAAI,KAAK,CAAC,CACnC,EAGF,IAAI,MAAO,CACF,YAAK,EAAI,KAAK,EAGvB,IAAI,MAAO,CACF,YAAK,EAAI,KAAK,EAGvB,IAAI,WAAoB,CACf,OACL,CAAC,KAAK,EAAI,KAAK,EAAI,EAAG,KAAK,CAAC,EAC5B,CAAC,KAAK,EAAI,KAAK,EAAG,KAAK,EAAI,KAAK,EAAI,CAAC,EACrC,CAAC,KAAK,EAAI,KAAK,EAAI,EAAG,KAAK,EAAI,KAAK,CAAC,EACrC,CAAC,KAAK,EAAG,KAAK,EAAI,KAAK,EAAI,CAAC,CAC9B,EAGF,IAAI,MAAO,CACT,OAAO,KAAK,EAGd,IAAI,MAAO,CACT,OAAO,KAAK,EAGd,IAAI,QAAiB,CACZ,OACL,CAAC,KAAK,EAAG,KAAK,CAAC,EACf,CAAC,KAAK,EAAI,KAAK,EAAG,KAAK,CAAC,EACxB,CAAC,KAAK,EAAI,KAAK,EAAG,KAAK,EAAI,KAAK,CAAC,EACjC,CAAC,KAAK,EAAG,KAAK,EAAI,KAAK,CAAC,CAC1B,EAGF,IAAI,WAAoB,CACf,OACL,CAAC,KAAK,EAAI,KAAK,EAAG,KAAK,CAAC,EACxB,CAAC,KAAK,EAAI,KAAK,EAAG,KAAK,EAAI,KAAK,CAAC,CACnC,EAGF,IAAI,IAAW,CACb,MAAO,CAAC,KAAK,EAAG,KAAK,CAAC,EAGxB,IAAI,IAAW,CACb,MAAO,CAAC,KAAK,EAAI,KAAK,EAAG,KAAK,CAAC,EAGjC,IAAI,WAAoB,CACf,OACL,CAAC,KAAK,EAAG,KAAK,CAAC,EACf,CAAC,KAAK,EAAI,KAAK,EAAG,KAAK,CAAC,CAC1B,EAGF,IAAI,cAAuB,CAClB,OACL,CAAC,KAAK,EAAI,KAAK,EAAI,EAAG,KAAK,CAAC,EAC5B,CAAC,KAAK,EAAI,KAAK,EAAI,EAAG,KAAK,EAAI,KAAK,CAAC,CACvC,EAGF,YAAYjC,EAAI,EAAGC,EAAI,EAAG6G,EAAI,EAAGiC,EAAI,EAAG,CACtC,KAAK,EAAI/I,EACT,KAAK,EAAIC,EACT,KAAK,EAAI6G,EACT,KAAK,EAAIiC,CAAA,CAGX,OAAO,YAAY3H,EAAW,CAC5B,KAAM,CAACpB,EAAGC,EAAG6G,EAAGiC,CAAC,EAAIkB,GAAgB7I,CAAC,EACtC,OAAO,IAAIkJ,GAAMtK,EAAGC,EAAG6G,EAAGiC,CAAC,EAG7B,OAAO,KAAKwB,EAAc,CACjB,WAAID,GAAMC,EAAK,EAAGA,EAAK,EAAGA,EAAK,EAAGA,EAAK,CAAC,EAGjD,OAAO,WAAW9F,EAAc+F,EAAeC,EAAgB,CACvD,MAACzK,EAAGC,CAAC,EAAIwE,EACR,WAAI6F,GAAMtK,EAAIwK,EAAQ,EAAGvK,EAAIwK,EAAS,EAAGD,EAAOC,CAAM,EAG/D,OAAO,YAAY,CAAE,KAAAC,EAAM,IAAAC,EAAK,MAAAH,EAAO,OAAAC,GAAmB,CACxD,OAAO,IAAIH,GAAMI,EAAMC,EAAKH,EAAOC,CAAM,EAG3C,OAAO,WAAW1G,EAAgB,CAChC,OAAOuG,GAAM,KAAKF,GAAoBrG,CAAM,CAAC,EAG/C,OAAO,SAASmG,EAAY,CAC1B,OAAO,IAAII,GAAMJ,EAAK,CAAC,EAAGA,EAAK,CAAC,EAAGA,EAAK,CAAC,EAAGA,EAAK,CAAC,CAAC,EAGrD,OAAO,UAAUU,EAAe,CACvB,OAAAZ,GAAcY,EAAM,EAAGA,EAAM,EAAGA,EAAM,EAAGA,EAAM,CAAC,EAGzD,OAAe,CACN,WAAIN,GAAM,KAAK,EAAG,KAAK,EAAG,KAAK,EAAG,KAAK,CAAC,EAGjD,SAASM,EAAc,CACrB,OACEA,EAAM,GAAK,KAAK,GAChBA,EAAM,GAAK,KAAK,GAChBA,EAAM,MAAQ,KAAK,MACnBA,EAAM,MAAQ,KAAK,KAIvB,cAAc,CAAC5K,EAAGC,CAAC,EAAkB,CACnC,KAAM,CAAE,KAAAyF,EAAM,KAAAC,EAAM,KAAAC,EAAM,KAAAC,CAAS,OACnC,OAAOH,GAAQ1F,GAAKA,GAAK4F,GAAQD,GAAQ1F,GAAKA,GAAK4F,CAAA,CAKrD,OACE6E,EACAC,EACAE,EACAC,EACA,CACI,SAAM,QAAQJ,CAAI,EAAG,CACjB,MAAC1K,EAAGC,CAAC,EAAIyK,EACf,OAAO,IAAIJ,GAAM,KAAK,EAAItK,EAAG,KAAK,EAAIC,EAAG,KAAK,EAAID,EAAI,EAAG,KAAK,EAAIC,EAAI,CAAC,EAGjE,OAAA0K,MAAAD,GACEG,MAAAH,GACCI,MAAAH,GAEJ,IAAIL,GACT,KAAK,EAAII,EACT,KAAK,EAAIC,EACT,KAAK,EAAID,EAAOG,EAChB,KAAK,EAAIF,EAAMG,CACjB,EAGF,iBAAiB,CAAC9K,EAAGC,CAAC,EAAe,CAC5B,OAAC,KAAK,EAAID,EAAI,KAAK,EAAG,KAAK,EAAIC,EAAI,KAAK,CAAC,EAGlD,yBAA0B,CACxB,MAAO,CAAC,GAAG,KAAK,OAAQ,GAAG,KAAK,SAAS,EAG3C,mBAAmB2K,EAAc,CAC/B,OAAO,KAAK,IACV,KAAK,IAAI,KAAK,KAAOA,EAAM,IAAI,EAC/B,KAAK,IAAI,KAAK,KAAOA,EAAM,IAAI,CACjC,EAGF,QAAQtI,EAAa,CACnB,MAAM+D,EAAK,KAAK,IAAI,KAAK,EAAG/D,EAAM,CAAC,CAAC,EAClCgE,EAAK,KAAK,IAAI,KAAK,EAAGhE,EAAM,CAAC,CAAC,EAC9BiE,EAAK,KAAK,IAAI,KAAK,KAAMjE,EAAM,CAAC,CAAC,EACjCkE,EAAK,KAAK,IAAI,KAAK,KAAMlE,EAAM,CAAC,CAAC,EACnC,OAAO,IAAIgI,GAAMjE,EAAIC,EAAIC,EAAKF,EAAIG,EAAKF,CAAE,EAG3C,cAAcpD,EAAUC,EAAUG,EAAW,GAAO,CAClD,MAAMW,EAAc,CAAC,EAEnB,OACE,CAAC,KAAK,GAAI,KAAK,EAAE,EACjB,CAAC,KAAK,GAAI,KAAK,EAAE,EACjB,CAAC,KAAK,GAAI,KAAK,EAAE,EACjB,CAAC,KAAK,GAAI,KAAK,EAAE,GAEnB,QAAQ,CAAC,CAAC3D,EAAIE,CAAE,IAAM,CACtB,MAAM2D,EAAIlB,GAAeC,EAAIC,EAAI7C,EAAIE,EAAI8C,CAAQ,EAC7Ca,GAAOF,EAAA,KAAKE,CAAC,EAClB,EACMF,EAAI,SAAW,EAAI,KAAOA,CAAA,CAGnC,kBAAkB2G,EAAc,CAC9B,MAAO,EAAE,KAAK,KAAOA,EAAM,MAAQ,KAAK,KAAOA,EAAM,MAGvD,qBAAqBA,EAAcjH,EAAUf,GAAS,CACpD,OACEgI,EAAM,KAAO,KAAK,KAAOjH,GACzBiH,EAAM,KAAO,KAAK,KAAOjH,GACzBiH,EAAM,KAAO,KAAK,KAAOjH,GACzBiH,EAAM,KAAO,KAAK,KAAOjH,GACzB,CAAC,KAAK,SAASiH,CAAK,GACpB,CAACA,EAAM,SAAS,IAAI,EAIxB,mBAAmBA,EAAcjH,EAAUf,GAAS,CAClD,OACEgI,EAAM,KAAO,KAAK,KAAOjH,GACzBiH,EAAM,KAAO,KAAK,KAAOjH,GACzBiH,EAAM,KAAO,KAAK,KAAOjH,GACzBiH,EAAM,KAAO,KAAK,KAAOjH,CAAA,CAI7B,eAAe,CAAC3D,EAAGC,CAAC,EAAS8K,EAAY,IAAM,CAC7C,OACE/K,EAAI,KAAK,KAAO+K,GAChB/K,EAAI,KAAK,KAAO+K,GAChB9K,EAAI,KAAK,KAAO8K,GAChB9K,EAAI,KAAK,KAAO8K,CAAA,CAIpB,iBAAiB,CAAC/K,EAAGC,CAAC,EAAS8K,EAAY,IAAM,CAC/C,OAAOzG,GAAqB,KAAK,OAAQ,CAACtE,EAAGC,CAAC,CAAC,EAAI8K,CAAA,CAGrD,gBAAgBH,EAAc,CAC5B,MAAO,EAAE,KAAK,KAAOA,EAAM,MAAQ,KAAK,KAAOA,EAAM,MAGvD,UAAUI,EAAYC,EAAY,CACzB,WAAIX,GAAM,KAAK,EAAIU,EAAI,KAAK,EAAIC,EAAI,KAAK,EAAG,KAAK,CAAC,EAG3D,WAA4B,CACnB,OAAAjB,GAAc,KAAK,EAAG,KAAK,EAAG,KAAK,EAAG,KAAK,CAAC,EAQrD,WAAW,CAAChK,EAAGC,CAAC,EAAe,CACvB,MAAAiL,EAAc,KAAK,IAAM,EAAI,GAAKlL,EAAI,KAAK,GAAK,KAAK,EACrDmL,EAAc,KAAK,IAAM,EAAI,GAAKlL,EAAI,KAAK,GAAK,KAAK,EACpD,OAACiL,EAAaC,CAAW,EAGlC,QAAe,CACN,OAAC,KAAK,EAAG,KAAK,EAAG,KAAK,EAAG,KAAK,CAAC,EAGxC,MAAMP,EAAc,CAClB,MAAMvE,EAAK,KAAK,IAAI,KAAK,EAAGuE,EAAM,CAAC,EACjCtE,EAAK,KAAK,IAAI,KAAK,EAAGsE,EAAM,CAAC,EAC7BrE,EAAK,KAAK,IAAI,KAAK,KAAMqE,EAAM,IAAI,EACnCpE,EAAK,KAAK,IAAI,KAAK,KAAMoE,EAAM,IAAI,EACrC,OAAO,IAAIN,GAAMjE,EAAIC,EAAIC,EAAKF,EAAIG,EAAKF,CAAE,EAG3C,iBAAiBsE,EAAc,CAC7B,OAAO,KAAK,IACV,KAAK,IAAI,KAAK,KAAOA,EAAM,IAAI,EAC/B,KAAK,IAAI,KAAK,KAAOA,EAAM,IAAI,CACjC,EAEJ,CCjXA,SAASQ,GAAiBjL,EAAWgH,EAAmB,CACtD,MAAMzB,EAAO,KAAK,IAAIvF,EAAE,EAAGgH,EAAE,CAAC,EACxBxB,EAAO,KAAK,IAAIxF,EAAE,EAAGgH,EAAE,CAAC,EACxBvB,EAAO,KAAK,IAAIzF,EAAE,EAAIA,EAAE,EAAGgH,EAAE,EAAIA,EAAE,CAAC,EACpCtB,EAAO,KAAK,IAAI1F,EAAE,EAAIA,EAAE,EAAGgH,EAAE,EAAIA,EAAE,CAAC,EACpCqD,EAAQ,KAAK,IAAI5E,EAAOF,CAAI,EAC5B+E,EAAS,KAAK,IAAI5E,EAAOF,CAAI,EAE5B,OACL,EAAGD,EACH,EAAGC,EACH,EAAG6E,EACH,EAAGC,CACL,CACF,CAEgB,SAAAY,GACd1K,EACA2K,EAAwC,CAAC,CAAE,EAAAtL,EAAG,EAAAC,EAAG,EAAA6G,EAAG,EAAAiC,KAAgB,CAElE,CAAC/I,EAAGC,CAAC,EAEL,CAACD,EAAI8G,EAAG7G,CAAC,EAET,CAACD,EAAI8G,EAAG7G,EAAI8I,CAAC,EAEb,CAAC/I,EAAGC,EAAI8I,CAAC,CACX,EACAwC,EAA+B,CAAC,EAAG,CAAC,EAC5B,CACF,MAAE,OAAA7G,GAAW/D,EACnB,IAAIoD,EAASuH,EAAU,CACrB,EAAG3K,EAAO,EAAI4K,EAAW,CAAC,EAC1B,EAAG5K,EAAO,EAAI4K,EAAW,CAAC,EAC1B,EAAG5K,EAAO,EAAI4K,EAAW,CAAC,EAAI,EAC9B,EAAG5K,EAAO,EAAI4K,EAAW,CAAC,EAAI,EAC/B,EAED,GAAI7G,EAAQ,CACV,KAAM,CAAE,EAAA1E,EAAG,EAAAC,EAAG,EAAA6G,EAAG,EAAAiC,CAAM,EAAApI,EACjBqI,EAAKhJ,EAAI8G,EAAI,EACbmC,EAAKhJ,EAAI8I,EAAI,EAEbG,EAAI,IAAI,UAAU,EACrB,cAAcF,EAAIC,CAAE,EACpB,WAAWvE,CAAM,EACjB,cAAc,CAACsE,EAAI,CAACC,CAAE,EAEhBlF,IAAO,IAAazB,GAAA,CAC3B,KAAM,CAAE,EAAAtC,EAAG,EAAAC,CAAE,EAAI,IAAI,SAAS,GAAGqC,CAAK,EAAE,gBAAgB4G,CAAC,EAClD,OAAClJ,EAAGC,CAAC,EACb,EAGI,OAAA8D,CACT,CAEO,SAASyH,GAAyB7K,EAAyB,CAChE,KAAM,CAAE,EAAAX,EAAG,EAAAC,EAAG,EAAA6G,EAAG,EAAAiC,EAAG,OAAArE,GAAW/D,EACzB8K,EAAO,IAAI,QAAQzL,EAAGC,EAAG6G,EAAGiC,CAAC,EAE/B,OAACrE,EAEE,IAAI,QACT,GAAG2G,GAA+B1K,CAAM,EAAE,IAC/B2B,GAAA,IAAI,SAAS,GAAGA,CAAK,IAEhC,UAAU,EANQmJ,CAOtB,CAEO,SAASC,GAAqBd,EAAuB,CACpD,MAAE,EAAA5K,EAAG,EAAAC,EAAG,MAAO6G,EAAG,OAAQiC,CAAA,EAAMyC,GAAyBZ,CAAK,EACpE,MAAO,CAAE,EAAA5K,EAAG,EAAAC,EAAG,EAAA6G,EAAG,EAAAiC,CAAE,CACtB,CAQO,SAAS4C,GAAehL,EAAgC,CACzD,IAACA,EAAO,OACH,YAGL,GAAAA,EAAO,SAAW,EAAG,CACvB,KAAM,CAAE,EAAAX,EAAG,EAAAC,EAAG,EAAA6G,EAAG,EAAAiC,CAAE,EAAIpI,EAAO,CAAC,EAC/B,OAAO,IAAI2J,GAAMtK,EAAGC,EAAG6G,EAAGiC,CAAC,EAGzB,IAAA5D,EAASxE,EAAO,CAAC,EAErB,QAASiB,EAAI,EAAGA,EAAIjB,EAAO,OAAQiB,IACjCuD,EAASiG,GAAiBjG,EAAQxE,EAAOiB,CAAC,CAAC,EAGtC,WAAI0I,GAAMnF,EAAO,EAAGA,EAAO,EAAGA,EAAO,EAAGA,EAAO,CAAC,CACzD,CAMO,SAASyG,GAA2BjL,EAAyB,CAC9D,OAAAA,EAAO,SAAW,EACb,IAAI2J,GAAM,EAAG,EAAG,EAAG,CAAC,EAGtB3J,EAAO,OACZ,CAACkL,EAAKjB,IACGiB,EAAI,MACTjB,aAAiBN,GAAQM,EAAQN,GAAM,KAAKoB,GAAqBd,CAAK,CAAC,CACzE,EAEFN,GAAM,KAAKoB,GAAqB/K,EAAO,CAAC,CAAC,CAAC,CAC5C,CACF,CAEO,SAASmL,GAAmB/H,EAAgB,CACjD,OAAOuG,GAAM,KAAKF,GAAoBrG,CAAM,CAAC,CAC/C,CAEgB,SAAAgI,GAAanB,EAAe5E,EAAe,CACzD,MAAMgG,EAAOhG,EAAQ,EAEfiG,EAAW,IAAI3B,GACnBM,EAAM,EAAIoB,EACVpB,EAAM,EAAIoB,EACVpB,EAAM,EAAI5E,EACV4E,EAAM,EAAI5E,CACZ,EAEA,GAAIiG,EAAS,GAAK,GAAKA,EAAS,GAAK,EAC7B,UAAI,MAAM,oCAAoC,EAG/C,OAAAA,CACT,CAEO,SAASC,GACdnI,EACAoI,EACAC,EACAH,EACAI,EACA,CACA,MAAMC,EAAiBF,EAAY,EAC7BG,EAAiBF,EAAY,EAC7BG,EAAO,KAAK,IAAIL,EAAS,EAAIG,EAAgB,CAAC,EAC9CG,EAAO,KAAK,IAAIN,EAAS,EAAIG,EAAgB,CAAC,EAC9CI,EAAO,KAAK,IAAIT,EAAS,EAAIM,EAAgB,CAAC,EAC9CI,EAAO,KAAK,IAAIV,EAAS,EAAIM,EAAgB,CAAC,EAU7C,OACL,OATwBxI,EAAO,IAASI,IACjC,CACL,GAAGA,EACH,EAAGuI,IAASvI,EAAE,EAAIiI,GAAaI,GAAQH,EACvC,EAAGM,IAASxI,EAAE,EAAIiI,GAAaK,GAAQJ,CACzC,EACD,EAIC,MAAO,IAAI/B,GACT2B,EAAS,EACTA,EAAS,EACTS,EAAOH,EACPI,EAAOJ,CAAA,CAEX,CACF,w/SC9KsB,eAAAK,GAAMC,EAAYC,EAAqC,CACpE,WAAI,QAAmBC,GAAA,CAC5B,MAAY,QAAS,CACXA,EAAA,EACR,OAEF,IAAIC,EAAW,GACPF,GAAA,iBAAiB,QAAS,IAAM,CACjCE,IACH,aAAaC,CAAM,EACXF,EAAA,EACV,CACF,EAEM,MAAAE,EAAS,WAAW,IAAM,CACnBD,EAAA,GACHD,EAAA,GACPF,CAAE,EACN,CACH,CAEO,SAASK,GAAKvL,EAAa,CAElC,CAEA,eAAsBwL,IAAW,CAE/B,MAAI,cAAe,QAAU,UAAW,OAAO,UAEtC,OAAO,UAAU,MAAM,EACrB,OAAO,oBAAwB,IACjC,IAAI,QAAmBJ,GAAA,oBAAoBA,CAAO,CAAC,EAEnD,IAAI,QAAQA,GAAW,WAAWA,EAAS,CAAC,CAAC,CAExD;;ut0BC/BO,MAAeK,EAGpB,CAHK,cAIK,gBACRC,IAOO,CACL,IAAAA,EACA,MAAO,GACP,OAAQ,IACV,GAGQ,gBAAa,CAACC,EAAsBC,IAAwB,CAvBxE,IAAAC,EAAAC,EAAAC,EAAAC,KAyBMH,EAAAF,EAAM,YAAY,SAAlB,YAAAE,EAA0B,SAAU,MACnCC,EAAAH,EAAM,YAAY,SAAlB,YAAAG,EAA0B,SAAU,KAClC,CAACH,EAAM,YAAY,OAClBA,EAAM,YAAY,kBAAkBM,MAEhCL,EAAA,EAGJ,MAAAM,EACJ,CAACP,EAAM,YAAY,QACnB,CAAC,KAAK,SAAS,KACfA,EAAM,YAAY,kBAAkBM,IACpCN,EAAM,YAAY,OAAO,MACrB,GACAA,EAAM,YAAY,SAAW,KAAK,SAAS,IAAI,UAErDK,GAAAD,EAAA,KAAK,WAAL,YAAAA,EAAe,WAAf,MAAAC,EAAA,KAAAD,EAA0B,KAAK,OAAQG,CAAA,CACzC,EAMA,KAAU,UAAY,GAIH,kBAAe,IAExB,eAAY,CAACR,EAAYS,IAAmB,CACpDT,EAAI,SAASS,EAAI,KAAK,WAAWT,CAAG,CAAC,CACvC,EAEU,qBAAmBS,GAAmB,CAC1C,KAAK,YAGT,KAAK,UAAY,GACdA,EAAA,EACH,KAAK,UAAY,GACnB,EAIA,IAAI,OAAQ,CACV,OAAO,KAAK,OAKhB,CC3EO,MAAMC,GACX,6DAEWC,GAAuB,6BACvBC,GAAyB,+BAEzBC,OAAe,IAAI,CAAC,KAAM,UAAW,WAAY,SAAS,CAAC,ECqB3DC,GAAN,KAA6B,CA+ElC,YAAYzL,EAAc,CAlB1B,cAAW,IACF,KAAK,KAAK,IAAI,OAAO,EAQ9B,cAAYA,GACH,KAAK,KAAK,IAAI,QAASA,CAAK,EAUjCA,aAAiB0L,IACjB1L,EAAM,KACNA,EAAM,IAAI,MAAM,IAAMuL,GAEtB,KAAK,KAAOvL,GAEP,UAAO,IAAI0L,GACX,UAAK,IAAI,OAAQH,EAA+B,EAChD,UAAK,IAAI,QAASvL,CAAK,GAEzB,UAAK,YAAsB2L,GAAA,CAC9BA,EAAO,QAAiBf,GAAA,CAvH9B,IAAAE,EAwHc,MAAAK,EACJ,CAACP,EAAM,YAAY,QACnB,CAAC,KAAK,KAAK,KACXA,EAAM,YAAY,kBAAkBM,IACpCN,EAAM,YAAY,OAAO,MACrB,GACAA,EAAM,YAAY,SAAW,KAAK,KAAK,IAAI,UACjDE,EAAA,KAAK,YAAL,MAAAA,EAAA,UAAiB,KAAK,WAAYK,CAAA,EACnC,EACF,EA3BH,IAAI,MAAO,CACT,OAAO,KAAK,KA8Bd,KAAKS,EAAyB,CAC5B,KAAK,UAAYA,CAAA,CAErB,EA7GaH,GAqBJ,KAAO,CACZI,EAEAD,IACiB,CACjB,MAAME,EAAQ,IAAIL,GAAaI,EAAI,IAAI,OAAO,CAAU,EACxD,OAAID,GACFE,EAAM,KAAKF,CAAQ,EAEdE,CACT,EA/BWL,GAgDJ,GAAMzL,GAETA,aAAiB0L,IAAS1L,EAAM,IAAI,MAAM,IAAMuL,GAlD/C,IAAMQ,GAANN,GCzBM,MAAAO,OAAc,QCFpB,SAASC,GAAajM,EAAiC,CAE1D,OAAAA,IAAU,MACV,OAAOA,GAAU,UACjB,OAAO,UAAU,SAAS,KAAKA,CAAK,IAAM,mBAC1C,CAAC,OAAQ,OAAW,IAAI,EAAE,KAAK1C,GAAKA,IAAM0C,EAAM,WAAW,CAE/D,yn0DCLakM,GAAqBC,GAAS,CACzC,KAAMC,GAAU,EAAI,EAAE,SAAW,WAAW,QAAM,MAAS,EAC3D,OAAQA,GAAU,EAAI,EAAE,SAAW,WAAW,QAAM,MAAS,EAC7D,UAAWA,GAAU,EAAI,EAAE,SAAW,WAAW,QAAM,MAAS,EAChE,OAAQA,GAAU,EAAI,EAAE,SAAW,WAAW,QAAM,MAAS,EAC7D,KAAMA,GAAU,EAAI,EAAE,SAAW,WAAW,QAAM,MAAS,EAC3D,KAAMC,GAAS,EAAE,SAAW,aAAW,MAAM,MAAS,CACxD,CAAC,ECgBM,IAAAC,GAAA,MAAMC,EAEX,CAYA,IAAI,SAAU,CACZ,OAAO,KAAK,SAGd,IAAI,QAAS,CACX,OAAO,KAAK,SAAS,MAGvB,IAAI,OAAQ,CACV,OAAO,KAAK,OAMd,YAAYC,EAAyD,CACnE,IAAIjJ,EAAS,EACT,UAAOiJ,GAAU,SAAU,CAC7B,MAAMC,EAAOD,EAAM,WAAW;AAAA,EAAQ;AAAA,CAAI,EAC1CjJ,EAASkJ,EAAK,OACd,KAAK,OAAS,IAAIC,GAAOD,CAAI,UACpBD,aAAiBE,GAC1B,KAAK,OAASF,EACVA,EAAM,MACRjJ,EAASiJ,EAAM,gBAERA,aAAiB,MAAO,CACjC,UAAWlJ,KAASkJ,EACdlJ,EAAM,SACRA,EAAM,OAASA,EAAM,OAAO,WAAW;AAAA,EAAQ;AAAA,CAAI,EACnDC,GAAUD,EAAM,OAAO,QAGrB,MAAAqJ,EAAQ,IAAID,GAClBC,EAAM,WAAWH,CAAK,EACtB,KAAK,OAASG,CAAA,MAET,YAAS,IAAID,GAGf,cAAWtC,GAAO7G,CAAM,EACxB,cAAW6G,GAAO,KAAK,OAAO,IAAM,KAAK,OAAO,QAAY,IAAE,EAC9D,YAAO,QAAiBQ,GAAA,CAjFjC,IAAAE,EAkFY,MAAAK,EACJ,CAACP,EAAM,YAAY,QACnB,CAAC,KAAK,OAAO,KACbA,EAAM,YAAY,kBAAkBM,IACpCN,EAAM,YAAY,OAAO,MACrB,GACAA,EAAM,YAAY,SAAW,KAAK,OAAO,IAAI,SAC9C,cAAS,MAAQ,KAAK,OAAO,OAClC,KAAK,SAAS,MAAQ,KAAK,OAAO,QAAQ,GACrCE,EAAA,iBAAL,MAAiBA,EAAA,eAAK,OAAQK,CAAA,EAC/B,EAGK,UAAUyB,EAAsB,CAChC,MAAAjC,EAAM,KAAK,OAAO,IACxB,GAAI,CAACA,EACH,MAAM,IAAIhO,EACRF,EAAU,mBACV,yDACF,EAEFkO,EAAI,SAAS,IAAM,CACRiC,EAAA,GACRjC,EAAI,QAAQ,EAcjB,WAAWrH,EAAyB,CAClC,KAAK,UAAU,IAAM,CAxHzB,IAAAwH,GAyHWA,EAAA,cAAL,QAAa,WAAWxH,CAAA,EACzB,EAMH,KAAKsI,EAAyB,CAC5B,KAAK,UAAYA,CAAA,CAMnB,OAAQ,CACD,KAAK,OAAO,QAGjB,KAAK,UAAU,IAAM,CACnB,KAAK,OAAO,OAAO,EAAG,KAAK,OAAO,MAAM,EACzC,EAQH,OAAQ,CACN,MAAMa,EAAO,IAAIF,GAAK,KAAK,OAAO,OAAO,EACpC,OAAAE,EAAA,KAAK,KAAK,SAAS,EACjBA,CAAA,CAST,OAAOI,EAAetJ,EAAgB,CACpC,GAAIA,IAAW,EAGX,IAAAsJ,EAAQ,GAAKtJ,EAAS,GAAKsJ,EAAQtJ,EAAS,KAAK,OAAO,OAC1D,MAAM,IAAI5G,EACRF,EAAU,mBACV,+DACEoQ,EACA,aACAtJ,EACA,kBACA,KAAK,OAAO,MAChB,EAEF,KAAK,UAAU,IAAM,CACd,YAAO,OAAOsJ,EAAOtJ,CAAM,EACjC,GAgBH,OAAOsJ,EAAetJ,EAAgBuJ,EAAiC,CACrE,GAAIvJ,IAAW,EAGX,IAAAsJ,EAAQ,GAAKtJ,EAAS,GAAKsJ,EAAQtJ,EAAS,KAAK,OAAO,OAC1D,MAAM,IAAI5G,EACRF,EAAU,mBACV,+DACEoQ,EACA,aACAtJ,EACA,kBACA,KAAK,OAAO,MAChB,EAEF,KAAK,UAAU,IAAM,CACnB,KAAK,OAAO,OAAOsJ,EAAOtJ,EAAQuJ,CAAM,EACzC,GAeH,OAAOC,EAAiBF,EAAeG,EAAsC,CACvE,GAACD,EAAQ,OAGb,IAAIF,EAAQ,GAAKA,EAAQ,KAAK,OAAO,OACnC,MAAM,IAAIlQ,EACRF,EAAU,mBACV,+DACEoQ,EACA,aACAE,EAAQ,OACR,kBACA,KAAK,OAAO,MAChB,EAEF,KAAK,UAAU,IAAM,CACnB,KAAK,OAAO,OAAOF,EAAOE,EAASC,CAAU,EAC9C,GAeH,KAAKC,EAAa,CACZ,CAACA,GAAS,CAACA,EAAM,UAAU,QAG/B,KAAK,UAAU,IAAM,CAEb,MAAA3J,EADS2J,EAAM,OACkB,QAAQ,EAC/C3J,EAAM,QAAQ,CAAE,OAAQ,KAAK,OAAO,OAAQ,EACvC,YAAO,WAAWA,CAAK,EAC7B,EAiBH,QACEuJ,EACAtJ,EACAwJ,EACAC,EACA,CACI,GAAAH,EAAQ,GAAKtJ,EAAS,GAAKsJ,EAAQtJ,EAAS,KAAK,OAAO,OAC1D,MAAM,IAAI5G,EACRF,EAAU,mBACV,oDACE,KAAK,OAAO,OACZ,uCACAoQ,EACA,KACAA,EACAtJ,CACJ,EAEF,KAAK,UAAU,IAAM,CACd,YAAO,OAAOsJ,EAAOtJ,CAAM,EAChC,KAAK,OAAO,OAAOsJ,EAAOE,EAASC,CAAU,EAC9C,EAWH,aAAaE,EAAeC,EAAgC,CAC1D,MAAM1K,EAA2B,CAAC,EAC9B,GAAA0K,GAAOD,GAASC,EACX,OAAA1K,EAGL,GAAAyK,IAAU,GAAKC,IAAQ,EACzB,MAAO,CAAC,EAGJ,MAAA7J,EAAQ,KAAK,QAAQ,EACvB,GAAA4J,EAAQ,GAAK,CAACC,EACT,OAAA7J,EAGL,GAAAA,GAASA,aAAiB,MAAO,CACnC,IAAI8J,EAAU,EAEd,QAASlO,EAAI,EAAGA,EAAIoE,EAAM,OAAQpE,IAAK,CAC/B,MAAA6N,EAAUzJ,EAAMpE,CAAC,EACnB,IAAAmO,EAAsBN,EAAQ,QAAU,GAC5C,MAAMO,EAAaD,EAAY,OAEzBE,EAAWJ,GAAOC,EAAUE,EAAaH,EACzCK,EAAYJ,EAAUE,EAAaJ,GAASzK,EAAO,SAAW,EACpE,GAAI+K,GAAaD,EAAU,CACzBF,EAAcA,EAAY,MAAMH,EAAQE,EAASD,EAAMC,CAAO,EAC9D3K,EAAO,KAAK,CACV,GAAGsK,EACH,OAAQM,CAAA,CACT,EACD,WACSG,GAAaD,GACRF,EAAAE,EACVF,EAAY,MAAM,EAAGF,EAAMC,CAAO,EAClCC,EAAY,MAAMH,EAAQE,CAAO,EAErC3K,EAAO,KAAK,CACV,GAAGsK,EACH,OAAQM,CAAA,CACT,GAED5K,EAAO,OAAS,GAAKA,EAAO,KAAKsK,CAAO,EAGtC,GAAAI,GAAOC,EAAUE,EAAaH,EAChC,MAGFC,EAAUA,EAAUE,CAAA,CACtB,CAEK,OAAA7K,CAAA,CAkCT,MAAMoK,EAAetJ,EAAS,EAAS,CACjC,GAAAsJ,EAAQ,GAAKtJ,EAAS,GAAKsJ,EAAQtJ,EAAS,KAAK,OAAO,OAC1D,MAAM,IAAI5G,EACRF,EAAU,mBACV,8DACEoQ,EACA,aACAtJ,EACA,kBACA,KAAK,OAAO,MAChB,EAEI,MAAAkK,EAAS,KAAK,OAAO,QAAQ,EAC/B,KAAEA,aAAkB,OACtB,MAAM,IAAI9Q,EACRF,EAAU,mBACV,sEACF,EAEF,IAAIiR,EAAW,EACf,MAAMC,EAA6C,CAAC,EACpD,QAASzO,EAAI,EAAGA,EAAIuO,EAAO,OAAQvO,IAAK,CAChC,MAAA0O,EAASH,EAAOvO,CAAC,EAAE,OACrB,UAAO0O,GAAW,SAAU,CAC9B,GAAIF,EAAWE,EAAO,QAAUf,EAAQtJ,EAAQ,CAC9C,MAAMsK,EAAcD,EAAO,MAAMf,EAAQtJ,EAASmK,CAAQ,EAC1DC,EAAY,KAAK,CACf,OAAQE,EACR,WAAYJ,EAAOvO,CAAC,EAAE,WACvB,EACDyO,EAAY,KAAK,GAAGF,EAAO,MAAMvO,EAAI,CAAC,CAAC,EACvC,MAEFwO,GAAYE,EAAO,WAEnB,OAAM,IAAIjR,EACRF,EAAU,mBACV,kEACF,CACF,CAGF,KAAK,OAAOoQ,EAAO,KAAK,OAASA,CAAK,EAChC,MAAAiB,EAAa,IAAIpB,GACvBoB,EAAW,WAAWH,CAAW,EAC3B,MAAAI,EAAY,IAAIxB,GAAKuB,CAAU,EAC3B,OAAAC,EAAA,KAAK,KAAK,SAAS,EAEtBA,CAAA,CAQT,SAA4B,CA1c9B,IAAAjD,EA2cI,QAAOA,EAAK,cAAL,KAAa,OAAAA,EAAA,YAAa,CAAC,EASpC,UAAW,CApdb,IAAAA,EAqdW,QAAAA,EAAA,KAAK,SAAL,YAAAA,EAAa,SAAc,OAEtC,EChdgB,SAAAkD,GACdhO,EACA,CAAE,KAAAiO,EAAO,GAAM,UAAAC,EAAiB5Q,IAAwB,KAC3C,CACb,GAAI0C,aAAiB+L,GACZ,OAAAmC,EAAUlO,EAAM,KAAMA,CAAK,EAEpC,GAAIA,aAAiBuM,GACf,OAAAvM,EAAM,MAAM,IACPkO,EAAUlO,EAAM,MAAM,QAASA,CAAK,EAEtCkO,EAAUlO,EAAM,MAAOA,CAAK,EAEjC,SAAM,QAAQA,CAAK,EAAG,CAClB,MAAAmO,EAA0B,IAAIC,GAC9B3L,EAASzC,EAAM,IAAYqO,GACxBJ,EAAOD,GAASK,EAAM,CAAE,KAAAJ,EAAM,UAAAC,CAAW,GAAIG,CACrD,EACM,OAAAF,EAAA,OAAO,EAAG1L,CAAM,EAEhByL,EAAUC,EAAQnO,CAAK,EAE5B,GAAAiM,GAAajM,CAAK,EAAG,CACjB,MAAAsO,EAAO,IAAIC,GACV,sBAAQvO,CAAK,EAAE,QAAQ,CAAC,CAACwO,EAAKxO,CAAK,IAAM,CACzCsO,EAAA,IAAIE,EAAKP,EAAOD,GAAShO,EAAO,CAAE,KAAAiO,EAAM,UAAAC,EAAW,EAAIlO,CAAK,EAClE,EAEMkO,EAAUI,EAAMtO,CAAK,EAGvB,OAAAkO,EAAUlO,EAAOA,CAAK,CAC/B,CAEgB,SAAAyO,GACdC,EACA,CAAE,KAAAT,EAAO,GAAM,UAAAC,EAAiB5Q,IAAwB,KACxD,CACI,GAAAyO,GAAM,GAAG2C,CAAS,EAAG,CACjB,MAAAC,EAAO,IAAI5C,GAAM2C,CAAS,EACzB,OAAAR,EAAUS,EAAMD,CAAS,EAElC,GAAIA,aAAqBE,GAAO,CACxB,MAAAD,EAAO,IAAIpC,GAAKmC,CAAS,EACxB,OAAAR,EAAUS,EAAMD,CAAS,EAElC,GAAIA,aAAqBN,GAAQ,CAC/B,MAAMO,EAAkBD,EACrB,QAAQ,EACR,IAAaL,GAAAJ,EAAOQ,GAASJ,EAAM,CAAE,KAAAJ,EAAM,UAAAC,CAAW,GAAIG,CAAK,EAE3D,OAAAH,EAAUS,EAAMD,CAAS,EAElC,GAAIA,aAAqBH,GAAM,CAC7B,MAAMI,EAAgC,OAAO,YAC3C,MAAM,KAAKD,EAAU,QAAS,GAAE,IAAI,CAAC,CAACF,EAAKxO,CAAK,IACvC,CAACwO,EAAKP,EAAOQ,GAASzO,EAAO,CAAE,KAAAiO,EAAM,UAAAC,EAAW,EAAIlO,CAAK,CAIjE,CACH,EACO,OAAAkO,EAAUS,EAAMD,CAAS,EAG3B,OAAAR,EAAUQ,EAAWA,CAAS,CACvC,CC9DO,MAAMG,WAAuBnE,EAGlC,CAuLA,YACqBoE,EACAC,EACAC,EACnB,CACM,QAJa,aAAAF,EACA,cAAAC,EACA,cAAAC,EAzLJ,eAAapE,GAAgC,CACvD,gBAAWA,EAAO,IAAM,CAC3B,IAAIqE,EAAS,EACPrE,EAAA,QAAQ,MAAM,QAAkBsE,GAAA,CACpC,GAAIA,EAAO,OAAQ,CACjBD,GAAUC,EAAO,OACjB,OAEF,GAAIA,EAAO,OAAQ,CACjB,KAAK,gBAAgB,IAAM,CACzB,KAAK,QAAQ,OAAOD,EAAQC,EAAO,MAAM,EAC1C,EACD,OAEF,GAAIA,EAAO,OAAQ,CAGjB,MAAMC,EAFO,CAACD,EAAO,MAAM,EAAE,KAAK,EAEX,IAAalP,GAAAoP,GAAapP,CAAK,CAAC,EAEvD,KAAK,gBAAgB,IAAM,CACzB,KAAK,QAAQ,OAAOiP,EAAQ,EAAG,GAAGE,CAAS,EAC5C,EAEDF,GAAUC,EAAO,OAAO,OAC1B,CACD,EACF,CACH,EAEA,KAAU,UAAY,IACb,IAAI,MAAM,KAAK,QAAS,CAC7B,IAAK,CAACG,EAAQ5N,IACL,QAAQ,IAAI4N,EAAQ5N,CAAC,EAE9B,IAAK,CAAC4N,EAAQ5N,EAAGzB,EAAOsP,IAAa,CAjD3C,IAAAxE,EAAAC,EAkDY,UAAOtJ,GAAM,SACf,MAAM,IAAI9E,EACRF,EAAU,mBACV,wBACF,EAGI,MAAAoQ,EAAQ,OAAOpL,CAAC,EACtB,GAAI,KAAK,WAAa,OAAO,MAAMoL,CAAK,EACtC,OAAO,QAAQ,IAAIwC,EAAQ5N,EAAGzB,EAAOsP,CAAQ,EAG/C,GAAI,KAAK,SAAS,IAAIzC,CAAK,EAAG,CAC5B,MAAMpK,EAAS,QAAQ,IAAI4M,EAAQ5N,EAAGzB,EAAOsP,CAAQ,EACrD,OAAAvE,GAAAD,EAAA,KAAK,UAAS,WAAd,MAAyBC,EAAA,KAAAD,EAAA,KAAK,OAAQ,IAC/BrI,CAAA,CAIT,GAAI,CADauJ,GAAQ,IAAI,KAAK,QAAQ,EAExC,MAAM,IAAIrP,EACRF,EAAU,mBACV,wCACF,EAEI,MAAAkO,EAAM,KAAK,SAAS,IAC1B,GAAI,CAACA,EACH,MAAM,IAAIhO,EACRF,EAAU,mBACV,+BACF,EAGI,MAAA8S,EAAQvB,GAAShO,CAAK,EACvB,eAAU2K,EAAK,IAAM,CACpBkC,EAAQ,KAAK,SAAS,QACnB,cAAS,OAAOA,EAAO,CAAC,EAE/B,KAAK,SAAS,OAAOA,EAAO,CAAC0C,CAAK,CAAC,EACpC,EACD,MAAMZ,EAAOS,GAAaG,EAAO,KAAK,QAAQ,EAC9C,OAAO,QAAQ,IAAIF,EAAQ5N,EAAGkN,EAAMW,CAAQ,CAC9C,EACA,IAAK,CAACD,EAAQ5N,EAAG6N,IACX7N,IAAM,SACD,CAAC+N,EAAeC,KAAyBC,IAAqB,CAC7D,MAAA/E,EAAM,KAAK,SAAS,IAC1B,GAAI,CAACA,EACH,MAAM,IAAIhO,EACRF,EAAU,mBACV,+BACF,EAEI,MAAAkT,EAAQF,GAAeJ,EAAO,OAASG,EACvCI,EAASF,EAAM,IAAYrB,GAAAL,GAASK,CAAI,CAAC,EAC1C,sBAAU1D,EAAK,IAAM,CACnB,cAAS,OAAO6E,EAAOG,CAAK,EAC5B,cAAS,OAAOH,EAAOI,CAAM,EACnC,EAEc,MAAM,UAAU,OAAO,MAAMP,EAAQ,CAClDG,EACAG,EACA,GAAGC,EAAO,IAAIC,GAAST,GAAaS,EAAO,KAAK,QAAQ,CAAC,EAC1D,CAGH,EAEEpO,IAAM,QACD,IAAM,CACL,MAAAkJ,EAAM,KAAK,SAAS,IAC1B,GAAI,CAACA,EACH,MAAM,IAAIhO,EACRF,EAAU,mBACV,+BACF,EAEE,GAAA4S,EAAO,SAAW,EACb,OAET,MAAM5M,EAAS,MAAM,UAAU,MAAM,KAAK4M,CAAM,EAC3C,sBAAU1E,EAAK,IAAM,CACnB,cAAS,OAAO,EAAG,CAAC,EAC1B,EACMlI,CACT,EAEEhB,IAAM,UACD,IAAIiO,IAAqB,CACxB,MAAA/E,EAAM,KAAK,SAAS,IAC1B,GAAI,CAACA,EACH,MAAM,IAAIhO,EACRF,EAAU,mBACV,+BACF,EAEF,MAAMmT,EAASF,EAAM,IAAYrB,GAAAL,GAASK,CAAI,CAAC,EAC1C,sBAAU1D,EAAK,IAAM,CACnB,cAAS,OAAO,EAAGiF,CAAM,EAC/B,EACM,MAAM,UAAU,QAAQ,MAC7BP,EACAO,EAAO,IAAIC,GAAST,GAAaS,EAAO,KAAK,QAAQ,CAAC,CACxD,CACF,EAEK,QAAQ,IAAIR,EAAQ5N,EAAG6N,CAAQ,EAExC,eAAgB,CAACD,EAAQ5N,IAAe,CAClC,UAAOA,GAAM,SACf,MAAM,IAAI9E,EACRF,EAAU,mBACV,wBACF,EAIF,GAAI,CADYuP,GAAQ,IAAI,KAAK,QAAQ,EAEvC,MAAM,IAAIrP,EACRF,EAAU,mBACV,wCACF,EAEI,MAAAkO,EAAM,KAAK,SAAS,IAC1B,GAAI,CAACA,EACH,MAAM,IAAIhO,EACRF,EAAU,mBACV,+BACF,EAGI,MAAAoQ,EAAQ,OAAOpL,CAAC,EACtB,OAAI,KAAK,WAAa,OAAO,MAAMoL,CAAK,GAInC,eAAUlC,EAAK,IAAM,CACnB,cAAS,OAAOkC,EAAO,CAAC,EAC9B,EACM,QAAQ,eAAewC,EAAQ5N,CAAC,EACzC,CACD,EAWI,YAAS,KAAK,UAAU,EACrBuK,GAAA,IAAI+C,EAAU,IAAI,EACjBA,EAAA,QAAQ,KAAK,SAAS,EAGjC,IAAIe,EAAc,CACV,MAAA9P,EAAQ,KAAK,QAAQ8P,CAAI,EAC1B,cAAS,OAAOA,CAAI,EACpB,YAAOA,CAAI,EAAI9P,CAAA,CAGtB,MAAM8P,EAAc,CACb,cAAS,IAAIA,CAAI,EAE1B,CAEO,MAAMC,WAAqBrF,EAA2C,CA6G3E,YACqBoE,EACAC,EACAC,EACnB,CACM,QAJa,aAAAF,EACA,cAAAC,EACA,cAAAC,EA/GJ,eAAapE,GAA8B,CACrD,gBAAWA,EAAO,IAAM,CACrBA,EAAA,YAAY,QAAe4D,GAAA,CAC/B,MAAMwB,EAAOpF,EAAM,QAAQ,KAAK,IAAI4D,CAAG,EACvC,GAAKwB,GAGD,GAAAA,EAAK,SAAW,SAClB,KAAK,gBAAgB,IAAM,CAClB,YAAK,QAAQxB,CAAG,EACxB,UACQwB,EAAK,SAAW,OAASA,EAAK,SAAW,SAAU,CAC5D,MAAMC,EAAU,KAAK,SAAS,IAAIzB,CAAG,EACrC,KAAK,gBAAgB,IAAM,CACzB,KAAK,QAAQA,CAAG,EAAIxC,GAAQ,IAAIiE,CAAO,EACnCjE,GAAQ,IAAIiE,CAAO,EACnBb,GAAaa,EAAS,KAAK,QAAQ,EACxC,GACH,CACD,EACF,CACH,EAEA,KAAU,UAAY,IACb,IAAI,MAAM,KAAK,QAAS,CAC7B,IAAK,CAACZ,EAAQ5N,IACL,QAAQ,IAAI4N,EAAQ5N,CAAC,EAE9B,IAAK,CAAC4N,EAAQ5N,EAAGzB,EAAOsP,IAAa,CAxP3C,IAAAxE,EAAAC,EAyPY,UAAOtJ,GAAM,SACf,MAAM,IAAI9E,EACRF,EAAU,mBACV,wBACF,EAEF,GAAI,KAAK,UACP,OAAO,QAAQ,IAAI4S,EAAQ5N,EAAGzB,EAAOsP,CAAQ,EAG/C,GAAI,KAAK,SAAS,IAAI7N,CAAC,EAAG,CACxB,MAAMgB,EAAS,QAAQ,IAAI4M,EAAQ5N,EAAGzB,EAAOsP,CAAQ,EACrD,OAAAvE,GAAAD,EAAA,KAAK,UAAS,WAAd,MAAyBC,EAAA,KAAAD,EAAA,KAAK,OAAQ,IAC/BrI,CAAA,CAIT,GAAI,CADauJ,GAAQ,IAAI,KAAK,QAAQ,EAExC,MAAM,IAAIrP,EACRF,EAAU,mBACV,wCACF,EAEI,MAAAkO,EAAM,KAAK,SAAS,IAC1B,GAAI,CAACA,EACH,MAAM,IAAIhO,EACRF,EAAU,mBACV,+BACF,EAGI,MAAA8S,EAAQvB,GAAShO,CAAK,EACvB,eAAU2K,EAAK,IAAM,CACnB,cAAS,IAAIlJ,EAAG8N,CAAK,EAC3B,EACD,MAAMZ,EAAOS,GAAaG,EAAO,KAAK,QAAQ,EAC9C,OAAO,QAAQ,IAAIF,EAAQ5N,EAAGkN,EAAMW,CAAQ,CAC9C,EACA,IAAK,CAACD,EAAQ5N,EAAG6N,IACR,QAAQ,IAAID,EAAQ5N,EAAG6N,CAAQ,EAExC,eAAgB,CAACD,EAAQ5N,IAAM,CACzB,UAAOA,GAAM,SACf,MAAM,IAAI9E,EACRF,EAAU,mBACV,wBACF,EAEF,GAAI,KAAK,UACA,eAAQ,eAAe4S,EAAQ5N,CAAC,EAIzC,GAAI,CADYuK,GAAQ,IAAI,KAAK,QAAQ,EAEvC,MAAM,IAAIrP,EACRF,EAAU,mBACV,wCACF,EAEI,MAAAkO,EAAM,KAAK,SAAS,IAC1B,GAAI,CAACA,EACH,MAAM,IAAIhO,EACRF,EAAU,mBACV,+BACF,EAGG,sBAAUkO,EAAK,IAAM,CACnB,cAAS,OAAOlJ,CAAC,EACvB,EAEM,QAAQ,eAAe4N,EAAQ5N,CAAC,EACzC,CACD,EAYI,YAAS,KAAK,UAAU,EACrBuK,GAAA,IAAI+C,EAAU,IAAI,EACjBA,EAAA,QAAQ,KAAK,SAAS,EAIjC,IAAIe,EAAc,CACV,MAAA9P,EAAQ,KAAK,QAAQ8P,CAAI,EAC1B,cAAS,OAAOA,CAAI,EACpB,YAAOA,CAAI,EAAI9P,CAAA,CAGtB,MAAM8P,EAAc,CACb,cAAS,IAAIA,CAAI,EAE1B,CAEO,SAASV,GACdV,EACA5R,EAA8B,GACxB,CACF,OAAAkP,GAAQ,IAAI0C,CAAS,EAChB1C,GAAQ,IAAI0C,CAAS,EAAG,MAgC1BD,GAASC,EAAW,CAAE,UA7BoB,CAAC1O,EAAOkQ,IACnDlQ,aAAiBuM,IAIjBR,GAAM,GAAGmE,CAAM,GAChBlQ,EAAgB,KAAKlD,EAAQ,QAAyB,EAChDkD,GAELkQ,aAAkB9B,GACP,IAAIS,GACf7O,EACAkQ,EACApT,CACF,EACY,MAEVoT,aAAkB3B,GACP,IAAIwB,GACf/P,EACAkQ,EACApT,CACF,EACY,MAGPkD,EAG+B,CAC1C,CChYO,MAAMmQ,GAAoB3B,GAAgBA,EAAI,QAAQ,cAAe,EAAE,EAEjE4B,GAAiB5B,GAC5BhD,GAAS,IAAIgD,CAAG,EAAI,OAAOA,CAAG,GAAK,QAAQA,CAAG,GAE1C6B,GAAc,OAAO,OAAO,EAE3B,SAASC,GAAQtQ,EAAyB,CACxC,OAAAqQ,MAAe,OAAO,eAAerQ,CAAK,CACnD,CAEO,SAASuQ,GAAUvQ,EAA2B,CACnD,cAAO,eAAeA,EAAO,CAC3B,CAACqQ,EAAW,EAAG,GAChB,EACMrQ,CACT,CAEO,SAASwQ,GAAcC,EAAwB,CACpD,OAAO,OAAO,KAAKA,CAAG,EAAE,SAAW,CACrC,CAEgB,SAAAC,GACdD,EACAjC,EACAmC,EACM,CACFH,GAAcC,CAAG,GACnB,OAAOE,EAAOnC,CAAG,CAErB,CAEO,SAASoC,GAAYpC,EAAqB,CAC/C,MAAM/L,EAAS+L,EAAI,MAAM,GAAG,EAAE,GAAG,CAAC,EAClC,GAAI,CAAC/L,EACH,MAAM,IAAI,MAAM,oBAAoB+L,CAAG,EAAE,EAEpC,OAAA/L,CACT,CAEgB,SAAAoO,GAAmB7Q,EAAgB4L,EAA4B,EACzE5L,aAAiBuM,IAAQR,GAAM,GAAG/L,CAAK,IACzCA,EAAM,KAAK4L,CAAQ,CAEvB,CCnCO,MAAMkF,GAAiB,CAAC,CAC7B,SAAAC,EACA,UAAA7C,EACA,KAAAI,CACF,IAAuC,CACrC,MAAM0C,EAAiB,CAAC,EAClB,kBAAK1C,EAAK,QAAS,GAAE,QAAQ,CAAC,CAACE,EAAKxO,CAAK,IAAM,CAC/C,GAAAwO,EAAI,WAAW,KAAK,EACtB,OAEF,MAAMyC,EAAOd,GAAiB3B,CAAG,EAAE,MAAM,GAAG,EACtC0C,EAAWD,EAAK,CAAC,EAEvB,IAAIE,EAAYnR,EACZ,GAAA+L,GAAM,GAAG/L,CAAK,EAChBmR,EAAYjD,EAAUgD,EAAU,IAAInF,GAAM/L,CAAK,EAAGA,CAAK,UAC9CA,aAAiBoO,GAC1B+C,EAAYjD,EAAUgD,EAAUlR,EAAM,UAAWA,CAAK,UAC7CA,aAAiB4O,GAAO,CAC3B,MAAArJ,EAAO,IAAIgH,GAAKvM,CAAK,EACfmR,EAAAjD,EAAUgD,EAAU3L,EAAMvF,CAAK,MAC7C,IAAWA,aAAiBuO,GAC1B,MAAM,IAAI5R,EACRA,EAAgB,UAAU,mBAC1B,uDACF,EAEYwU,EAAAjD,EAAUgD,EAAUlR,EAAOA,CAAK,EAE9C,MAAMoR,EAAYH,EAAK,OAClBA,EAAK,OAAO,CAACI,EAAe7C,EAAK3B,IAAU,CAC9C,GAAI,CAACwE,EAAI7C,CAAG,GAAK3B,IAAUuE,EAAY,EAAG,CAClC,MAAAE,EAAOL,EAAK,MAAM,EAAGpE,EAAQ,CAAC,EAAE,KAAK,GAAG,EACxC8B,EAAOoC,EAAS,GAAgBC,EAAMM,CAAI,EAChDD,EAAI7C,CAAG,EAAIG,CAAA,CAET,OAAA9B,IAAUuE,EAAY,IACxBC,EAAI7C,CAAG,EAAI2C,GAENE,EAAI7C,CAAG,GACbwC,CAAI,EACR,EAEMA,CACT,ECzCO,SAASO,GAAc,CAC5B,KAAAP,EACA,SAAAE,EACA,mBAAAM,EACA,mBAAAC,EACA,SAAA7F,EACA,SAAA8F,EACA,MAAA1R,EACA,mBAAA2R,EACA,gBAAAC,CACF,EAA8B,CAC5B,MAAMC,EAAS,CAACH,EAChB,GAAIF,IACF,OAGI,MAAAM,EAAY,GAAGZ,CAAQ,IACzB,KAAEY,KAAad,GAAO,CACxB,GAAI,CAACa,EACH,OAEFF,EAAmBG,CAAS,EAC5B,OAEFL,EAAmB,IAAM,CACjB,MAAAM,EAAOf,EAAKE,CAAQ,EACpB3L,EAAOsM,EACT7R,EACAiM,GAAa8F,CAAI,EACf,CAAE,GAAGA,CAAK,EACV,MAAM,QAAQA,CAAI,EAChB,CAAC,GAAGA,CAAI,EACRA,EAEHf,EAAAc,CAAS,EAAE,MAAQvM,EAEnBqM,KACHhG,IAAWsF,EAAU,GACvB,CACD,CACH,CCvCO,SAASc,GAAY,CAC1B,gBAAAJ,EACA,KAAAtD,EACA,YAAA2D,EACA,SAAArG,EACA,SAAAsG,EACA,MAAAlS,CACF,EAAgB,CAzBhB,IAAA8K,EA0BQ,MAAAoG,EAAWN,GAAYsB,CAAQ,EACrC,GAAIN,IACF,OAEF,MAAMO,EAA0B,CAAC,EAC5B7D,EAAA,QAAQ,CAACrP,EAAGuP,IAAQ,CACnByD,EAAiB,GAAA9B,GAAiB3B,CAAG,EAAE,WAAW0D,CAAQ,GAC5D5D,EAAK,OAAOE,CAAG,CACjB,CACD,EACK,MAAA4D,EAAM,CAAC3B,EAAaiB,IAAqB,CACtC,eAAQjB,CAAG,EAAE,QAAQ,CAAC,CAACjC,EAAKxO,CAAK,IAAM,CAC5C,MAAMkS,EAAWR,EAAW,GAAGA,CAAQ,IAAIlD,CAAG,GAAKA,EAC/CvC,GAAajM,CAAK,EACpBoS,EAAIpS,EAAOkS,CAAQ,EAEnBC,EAAK,KAAK,IAAM,CACdtB,GAAmB7Q,EAAO,IAAM,CAC9B4L,IAAWsF,EAAU,IACtB,EACD5C,EAAK,IAAI8B,GAAc8B,CAAQ,EAAGlE,GAAShO,CAAK,CAAC,EAClD,CACH,CACD,CACH,EACAoS,EAAIpS,EAAiBkS,CAAQ,EACzBC,EAAK,QAAUF,OACjBnH,EAAAwD,EAAK,MAAL,MAAUxD,EAAA,SACR,IAAM,CACCqH,EAAA,QAAc/G,KAAA,CAAI,CACzB,EACA,CAAE,MAAO,EAAK,GAGpB,CC5CO,SAASiH,GAAYvV,EAAuC,CAC3D,MAAE,KAAAwV,GAASxV,EAEb,GAAAwT,GAAQgC,CAAI,EACP,OAAAA,EAGTC,GAAgBzV,CAAO,EAEjB,MAAA0V,EAAeC,GAAmB3V,CAAO,EACzC4V,EAAQ,IAAI,MAAMJ,EAAME,CAAY,EAC1C,OAAAjC,GAAUmC,CAAK,EAERA,CACT,CAEA,SAASH,GAAgBzV,EAA6B,CACpD,KAAM,CAAE,SAAA4U,EAAU,KAAApD,EAAM,KAAAgE,EAAM,KAAAtB,CAAS,EAAAlU,EAEhC,eAAQwV,CAAI,EAAE,QAAQ,CAAC,CAAC9D,EAAKxO,CAAK,IAAM,CAC7C,GAAIiM,GAAajM,CAAK,GAAK,CAACsQ,GAAQtQ,CAAK,EAAG,CAC1C,MAAM0S,EAAQL,GAAY,CACxB,GAAGvV,EACH,KAAAwR,EACA,KAAMtO,EACN,KAAAgR,EACA,SAAUU,EAAW,GAAGA,CAAQ,IAAIlD,CAAG,GAAKA,CAAA,CAC7C,EACD8D,EAAK9D,CAAG,EAAIkE,CAAA,CACd,CACD,CACH,CAEA,SAASC,GACP3S,EACA8P,EACAR,EACAxS,EACA,CACM,MACJ,KAAAkU,EACA,mBAAAQ,EACA,mBAAAC,EACA,SAAA7F,EACA,SAAA8F,EACA,YAAAO,EACA,UAAAW,EACA,gBAAAhB,CAAA,EACE9U,EAEEoV,EAAWR,EAAW,GAAGA,CAAQ,IAAI5B,CAAI,GAAKA,EAC9CoB,EAAWN,GAAYsB,CAAQ,EACvBX,GAAA,CACZ,KAAAP,EACA,SAAAE,EACA,mBAAAM,EACA,gBAAAI,EACA,mBAAAH,EACA,SAAA7F,EACA,SAAA8F,EACA,MAAA1R,EACA,mBAAqB8R,GAAsB,CACzC,GAAI9R,IAAU,OAAW,CACvB,OAAOgR,EAAKc,CAAS,EACrB,OAGI,MAAAe,EAAazI,GAAOpK,CAAK,EAC/BgR,EAAKc,CAAS,EAAIe,EACZ,MAAAC,EAAcD,EAAW,UAAkBtN,GAAA,CAC1C0M,KAGLR,EAAmB,IAAM,CACvBnC,EAASQ,CAAI,EAAIvK,EACjBqG,IAAWsF,EAAU,IACtB,EACF,EACK6B,EAAeH,EAAU,UAAU,IAAM,CAC7CG,EAAa,YAAY,EACbD,EAAA,EACb,EACH,CACD,CACH,CAEA,SAASL,GACP3V,EACwB,CAClB,MACJ,KAAAwR,EACA,gBAAAsD,EACA,SAAAF,EACA,SAAA9F,EACA,YAAAqG,EACA,UAAA/D,EACA,QAAA8E,CAAA,EACElW,EAEG,OACL,IAAK,CAACuS,EAAQ5N,IACL,QAAQ,IAAI4N,EAAQ5N,CAAC,EAE9B,IAAK,CAAC4N,EAAQ5N,EAAG6N,IACR,QAAQ,IAAID,EAAQ5N,EAAG6N,CAAQ,EAExC,IAAK,CAACD,EAAQ5N,EAAGzB,EAAOsP,IAAa,CA1HzC,IAAAxE,EA2HU,UAAOrJ,GAAM,SAAU,CACzB,MAAMyQ,EAAWR,EAAW,GAAGA,CAAQ,IAAIjQ,CAAC,GAAKA,EAC3CyP,EAAWN,GAAYsB,CAAQ,EAC/Be,EAAYD,EAAQ,IAAI9B,CAAQ,EAElC,GAAAjF,GAAajM,CAAK,EAAG,CAWlBiT,GATHjB,GAAY,CACV,gBAAAJ,EACA,KAAAtD,EACA,YAAA2D,EACA,SAAArG,EACA,SAAAsG,EACA,MAAAlS,CAAA,CACD,EAMH,MAAMuF,EAAO8M,GAAY,CACvB,GAAGvV,EACH,SAAUoV,EACV,KAAMlS,CAAA,CACP,EAEKyC,EAAS,QAAQ,IAAI4M,EAAQ5N,EAAG8D,EAAM+J,CAAQ,EACvC/J,YAAM9D,EAAG6N,EAAUxS,CAAO,EAChC2F,CAAA,CAGToO,GAAmB7Q,EAAO,IAAM,CAC9B4L,IAAWsF,EAAU,IACtB,EACK,MAAAgC,EAASlF,GAAShO,CAAK,EACvBuF,EAAO2I,EAAUgD,EAAUlR,EAAOkT,CAAM,EAE1C,CAACD,GAAahB,KAAiB,CAACL,OAClC9G,EAAAwD,EAAK,MAAL,MAAUxD,EAAA,SACR,IAAM,CACJwD,EAAK,IAAI8B,GAAc8B,CAAQ,EAAGgB,CAAM,CAC1C,EACA,CAAE,MAAO,EAAK,IAIlB,MAAMzQ,EAAS,QAAQ,IAAI4M,EAAQ5N,EAAG8D,EAAM+J,CAAQ,EACvC,OAAAqD,GAAApN,EAAM9D,EAAG6N,EAAUxS,CAAO,EAChC2F,CAAA,CAET,OAAO,QAAQ,IAAI4M,EAAQ5N,EAAGzB,EAAOsP,CAAQ,CAC/C,EACA,eAAgB,CAACD,EAAQ5N,IAAM,CA/KnC,IAAAqJ,EAgLU,UAAOrJ,GAAM,SAAU,CACzB,MAAMyQ,EAAWR,EAAW,GAAGA,CAAQ,IAAIjQ,CAAC,GAAKA,EAC3CyP,EAAWN,GAAYsB,CAAQ,EAGjC,CAFcc,EAAQ,IAAI9B,CAAQ,GAEpBe,KAAiB,CAACL,OAClC9G,EAAAwD,EAAK,MAAL,MAAUxD,EAAA,SACR,IAAM,CACE,MAAAqI,EAAU/C,GAAc8B,CAAQ,EACjC5D,EAAA,QAAQ,CAACrP,EAAGuP,IAAQ,CACnBA,EAAI,WAAW2E,CAAO,GACxB7E,EAAK,OAAOE,CAAG,CACjB,CACD,CACH,EACA,CAAE,MAAO,EAAK,IAIlB,MAAM/L,EAAS,QAAQ,eAAe4M,EAAQ5N,CAAC,EAClC,OAAAkR,GAAA,OAAWlR,EAAG,OAAW3E,CAAO,EACtC2F,CAAA,CAEF,eAAQ,eAAe4M,EAAQ5N,CAAC,EAE3C,CACF,CCpLa,MAAA2R,GAAoBtW,GAAkC,CAC3D,MAAE,MAAA8N,GAAU9N,EACZ,CAAE,YAAAuW,EAAa,QAAAC,CAAA,EAAY1I,EAEjCyI,EAAY,QAAe7E,GAAA,CACzB,MAAMwB,EAAOsD,EAAQ,KAAK,IAAI9E,CAAG,EACjC,GAAKwB,EAEL,IAAIA,EAAK,SAAW,UAAYA,EAAK,SAAW,MACvC,OAAAuD,GAAkB/E,EAAK1R,CAAO,EAEnC,GAAAkT,EAAK,SAAW,SACX,OAAAwD,GAAahF,EAAK1R,CAAO,EAClC,CACD,CACH,EAEA,SAASmW,GAAUzE,EAAawE,EAA+B,CACvD,MAAAS,EAAkBtD,GAAiB3B,CAAG,EACtC0C,EAAWN,GAAY6C,CAAO,EAC7B,OAAAT,EAAQ,IAAI9B,CAAQ,CAC7B,CAEA,SAASqC,GACP/E,EACA,CACE,KAAAF,EACA,MAAAoE,EACA,QAAAM,EACA,kBAAAU,EACA,UAAAxF,EACA,SAAAtC,CACF,EACA,CACI,GAAAqH,GAAUzE,EAAKwE,CAAO,EACxB,OAEI,MAAAS,EAAkBtD,GAAiB3B,CAAG,EACtC0C,EAAWN,GAAY6C,CAAO,EACpCC,EAAkB,IAAM,CAChB,MAAA1T,EAAQsO,EAAK,IAAIE,CAAG,EACbiF,EAAQ,MAAM,GAAG,EACpB,OAAO,CAACpC,EAAK7C,EAAK3B,EAAO8G,KAC7B,CAACtC,EAAI7C,CAAG,GAAK3B,IAAU8G,EAAI,OAAS,IAClCnF,GAAG,EAAI,CAAC,GAEV3B,IAAU8G,EAAI,OAAS,IACrBnF,GAAG,EAAIC,GAASzO,EAAO,CACzB,UAAW,CAACA,EAAOkQ,IAAWhC,EAAUgD,EAAUlR,EAAOkQ,CAAM,EAChE,GAEImB,EAAI7C,CAAG,GACbkE,CAAiB,EACrB,EACD9G,IAAWsF,EAAU,GACvB,CAEA,SAASsC,GACPhF,EACA,CAAE,MAAAkE,EAAO,QAAAM,EAAS,kBAAAU,EAAmB,SAAA9H,GACrC,CACI,GAAAqH,GAAUzE,EAAKwE,CAAO,EACxB,OAEI,MAAAS,EAAkBtD,GAAiB3B,CAAG,EACtC0C,EAAWN,GAAY6C,CAAO,EACpCC,EAAkB,IAAM,CAChB,MAAAzC,EAAOwC,EAAQ,MAAM,GAAG,EACzBxC,EAAK,OAAO,CAACI,EAAK7C,EAAK3B,IAAU,CAChC,GAAAA,IAAUoE,EAAK,OAAS,EAAG,CAC7B,OAAOI,EAAI7C,CAAG,EACd,IAAIoF,EAAOvC,EACPwC,EAAY5C,EAAKpE,EAAQ,CAAC,EAC1B8D,EAAS+B,EACTpB,EAAOL,EAAK,MAAM,EAAG,EAAE,EAE3B,QAAS/R,EAAI+R,EAAK,OAAS,EAAG/R,EAAI,EAAGA,IAAK,CACxC,UAAW4U,KAAWxC,EACpBX,EAASA,EAAOmD,CAAO,EAErB,IAACtD,GAAcoD,CAAI,EACrB,MAEgBlD,GAAAkD,EAAMC,EAAWlD,CAAM,EAClCiD,EAAAjD,EACKkD,EAAA5C,EAAK/R,EAAI,CAAC,EACfoS,IAAK,MAAM,EAAG,EAAE,EACdX,EAAA+B,CAAA,CACX,CAEF,OAAOrB,EAAI7C,CAAG,GACbkE,CAAiB,EACrB,EACD9G,IAAWsF,EAAU,GACvB,CCtGO,MAAM6C,WAAyBrJ,EAGpC,CAiFA,YACqBqE,EACFiF,EACAC,EACjB,CACM,QAJa,cAAAlF,EACF,gBAAAiF,EACA,eAAAC,EA7EF,eAAarJ,GAA8B,CAC1D,MAAM0D,EAAO,KAAK,SACZoE,EAAQ,KAAK,OACd,gBAAW9H,EAAO,IAAM,CACVwI,GAAA,CACf,KAAA9E,EACA,MAAAoE,EACA,QAAS,KAAK,SACd,kBAAmB,KAAK,mBACxB,UAAW,KAAK,WAChB,SAAU,KAAK,UACf,MAAA9H,CAAA,CACD,EACF,CACH,EAEA,KAAiB,WAAa,CAC5B4D,EACAxO,EACAkQ,IACG,CACG,MAAAtE,EAAW,KAAK,iBAAiB4C,CAAG,EAKtC,OAJAxO,aAAiBuM,IAIjBR,GAAM,GAAGmE,CAAM,GAChBlQ,EAAgB,KAAK4L,CAAyB,EACxC5L,GAELkQ,aAAkB9B,GACP,IAAIS,GAAe7O,EAAoBkQ,EAAQ,CAC1D,SAAAtE,CAAA,CACD,EACW,MAGP5L,CACT,EAEiB,sBAAoBwO,GAC5B,CAACvP,EAAYkM,IAAqB,CAjE7C,IAAAL,GAkEWA,EAAA,iBAAL,kBAAiB0D,EAAKrD,CAAA,CACxB,EAGF,KAAQ,WAAa,GAErB,KAAiB,UAAY,CAC3B+I,EACAlD,EACAM,IAEAe,GAAY,CACV,KAAM,KAAK,SACX,KAAM6B,EACN,KAAAlD,EACA,UAAW,KAAK,WAChB,mBAAoB,IAAM,KAAK,UAC/B,mBAAoB,KAAK,gBACzB,gBAAiB,IAAM,KAAK,WAC5B,SAAUM,EACV,SAAU,KAAK,UACf,UAAW,KAAK,WAChB,QAAS,KAAK,SACd,YAAa,IAAM,KAAK,aACzB,EAEc,wBAAsBlG,GAAmB,CACxD,KAAK,WAAa,GACfA,EAAA,EACH,KAAK,WAAa,EACpB,EAyCA,SAAO0E,GAAuB,CACtB,MAAA9P,EAAQ,KAAK,QAAQ8P,CAAI,EAC1B,cAAS,OAAOA,CAAI,EACpB,YAAOA,CAAI,EAAI9P,CACtB,EAEA,WAAS8P,GAAuB,CACzB,cAAS,IAAIA,CAAI,CACxB,EAzCE,KAAK,aAAe,GACpB,MAAMoE,EAASpD,GAAe,CAC5B,SAAU,KAAK,UACf,UAAW,KAAK,WAChB,KAAM,KAAK,SACZ,EACD,KAAK,QAAUoD,EAEf,MAAMxB,EAAQ,KAAK,UAAUwB,EAAQA,CAAM,EAEpC,eAAQA,CAAM,EAAE,QAAQ,CAAC,CAAC1F,EAAKxO,CAAK,IAAM,CACzC,MAAA6S,EAAazI,GAAOpK,CAAK,EACxBkU,EAAA,GAAG1F,CAAG,GAAG,EAAIqE,EACd,MAAAC,EAAcD,EAAW,UAAkBtN,GAAA,CAC1C,KAAK,cAGV,KAAK,gBAAgB,IAAM,CAzHnC,IAAAuF,EA0HU4H,EAAMlE,CAAG,EAAIjJ,GACRuF,EAAA,iBAAL,kBAAiB0D,EAAK,IACvB,EACF,EACKuE,EAAeiB,EAAW,UAAU,IAAM,CAC9CjB,EAAa,YAAY,EACbD,EAAA,EACb,EACF,EAED,KAAK,OAASJ,EACT,cAAS,QAAQ,KAAK,SAAS,EACpC,KAAK,aAAe,GAYxB;;y8XClJA,IAAA5H,GAcA,MAAMqJ,GAAa,OAAO,aAAa,EAEhC,MAAMC,EAA0C,CAmGrD,aAAc,CAlGG,eAAYhK,GAAiB,EAAE,EAI/B,kBAAeiK,GAAS,IAAM,CAC7C,MAAMrU,EAAsB,CAAC,EACxB,sBAAU,MAAM,QAAcsU,GAAA,CACjC,MAAMC,EAAQ,KAAK,OAAO,UAAUD,CAAE,EAClCC,GACIvU,EAAA,KAAKuU,EAAM,KAAK,CACxB,CACD,EACMvU,CAAA,CACR,EAMU,cAAAqU,GAAS,IAClB,KAAK,UAAU,MAAM,OAAO,CAACxI,EAAKyI,EAAIzH,KAChChB,EAAA,IAAIyI,EAAIzH,CAAK,EACVhB,GACF,OAAqB,CAC9B,EAEA,aAAU,IAAI2I,GAEd,aAAU,IAAIA,GAad,KAAC1J,EAAqB,oBAItB,kBAAe,IAAI0J,GAsDjB,KAAK,WAAa,CAChB,QAAS,KAAK,QAAQ,KAAKC,GAAK,CAAC,CAAC,EAAE,UAAU,IAAM,CAClD,KAAK,UAAU,MAAQ,KAAK,OAAO,IAAI,cAAc,EAAE,QAAQ,EAC/D,KAAK,OAAO,IAAI,cAAc,EAAE,QAAiB7J,GAAA,CAC/C,KAAK,UAAU,MAAQA,EAAM,OAAO,QAAQ,EAC7C,EACI,YAAO,QAAiBA,GAAA,CACvBA,EAAM,YAAY,IAAI,cAAc,IACtC,KAAK,UAAU,MAAQ,KAAK,OAAO,IAAI,cAAc,EAAE,QAAQ,EACjE,CACD,EACF,EAAE,WACL,EACA,KAAK,WAAa,CAChB,QAAS,KAAK,QAAQ,KAAK6J,GAAK,CAAC,CAAC,EAAE,UAAU,IAAM,CAClD,KAAK,WAAW,QAAQ,EACzB,EAAE,WACL,EAlFF,SAAU,CACD,YAAK,SAAS,SAAW,EAclC,IAAI,MAAyB,CAC3B,OAAQ,KAAK,MAA0B,KAGzC,IAAI,KAAKhI,EAAY,CACf,KAAK,KAAK,SAAS,MAAM,IAC1B,KAAK,MAA0B,KAAOA,EACzC,CAOF,IAAI,OAAQ,CACN,IAAC,KAAK,OACF,UAAI,MAAM,4CAA4C,EAE9D,OAAO,KAAK,OAGd,IAAI,SAAkB,CACb,YAAK,OAAO,MAAM,QAG3B,IAAI,SAAU,CACZ,OAAO,KAAK,OAAO,QAGrB,IAAI,UAAW,CACb,OAAO,KAAK,aAAa,MAG3B,IAAI,OAAQ,CACV,OAAO,KAAK,OAGd,IAAI,MAAM9B,EAAY,CACpB,KAAK,OAASA,CAAA,CAGhB,IAAI,QAAS,CACJ,YAAK,MAAM,UAAU,IAAI,EAGlC,IAAI,MAAO,CACF,YAAK,OAAO,MAAM,KAwB3B,SAAU,CACR,KAAK,QAAQ,SAAS,EACtB,KAAK,QAAQ,SAAS,EACtB,KAAK,aAAa,SAAS,EAG7B,YAAgC,CACvB,YAAK,SAAS,CAAC,GAAK,KAG7B,WAA+B,CACzB,OAAC,KAAK,SAAS,OAGZ,KAAK,SAAS,KAAK,SAAS,OAAS,CAAC,EAAE,UAAU,EAFhD,IAEgD,CAG3D,EA/FCG,GAAAqJ,GA+FA,OAAO,WAAW,CACjB,KAAK,WAAW,QAAQ,EACxB,KAAK,WAAW,QAAQ,EAE5B,CCtJA,MAAMO,GAAgBrI,GAAS,EACzBsI,GAAeC,GAAQvI,GAAU,GAAE,SAAS,EAC5CwI,GAAgBD,GAAQvI,GAAU,GAAE,SAAS,EAC7CyI,GAAazI,GAAS,EASf0I,GAAyC,OAAO,OAAO,CAClE,KAAM,CAACvI,EAAyB,KAAO,IAAID,GAAKC,CAAK,EACrD,MAAWA,GAAa,IAAIT,GAAMS,CAAK,CACzC,CAAC,EAEYwI,GAAc7I,GAAS,CAClC,QAAS8I,GAAS,EAClB,MAAO9I,GAAS,CACd,KAAM2I,GACN,QAASJ,GACT,OAAQC,GACR,SAAUE,GACV,WAAYK,GAAU,EAAE,SAAS,EACjC,MAAOC,GACJ,EACA,KAAKC,GAA8B,GACnC,QAAQC,GAASC,IAAO,CAAC,EACzB,SAAS,EACZ,QAASH,GAAE,EAAW,OAAO,QAAQC,GAAsB,GAAE,SAAS,EACvE,EACD,YAAaD,GACD,EACT,KAAKC,GAAgC,GACrC,QAAQA,GAAgC,GACxC,SAAS,CACd,CAAC,EAoCM,SAASG,GAAkB,CAChC,QAAAC,EACA,MAAAC,EACA,SAAAC,EACA,QAAAC,EACA,YAAAC,CACF,EAcoB,CAClB,MAAMC,EAAS,CACb,QAASH,EAAS,QAClB,MAAO,CACL,KAAMA,EAAS,KACf,OAAQA,EAAS,OACjB,SAAUA,EAAS,SACnB,QAAAF,EACA,MAAAC,EACA,QAAAE,EACA,WAAYD,EAAS,UACvB,EACA,YAAAE,CACF,EACA,OAAAZ,GAAY,MAAMa,CAAM,EACjBA,CACT,CC1GO,MAAMC,EAAmB,CAa9B,YACWD,EACAE,EACApL,EACAiB,EACT,CAJS,YAAAiK,EACA,YAAAE,EACA,SAAApL,EACA,cAAAiB,EAEH,MAAE,GAAA0I,EAAI,QAAAkB,EAAS,QAAAQ,EAAS,UAAAC,EAAW,MAAAR,CAAM,EAAI,KAAK,aAAa,EAErE,KAAK,GAAKnB,EACV,KAAK,QAAUkB,EACf,KAAK,UAAYS,EACjB,KAAK,QAAUD,EAEV,WAAQ,KAAK,aAAaP,CAAK,EAG9B,aAAaA,EAAoB,CAvC3C,IAAA3K,EAAAC,EAAAC,EAAAC,EAAAiL,EAwCI,MAAML,EAAS,KAAK,OAAO,iBAAiB,IAAI,KAAK,OAAO,EAC5D,GAAI,CAACA,EACH,MAAM,IAAIlZ,EACRF,EAAU,eACV,uBAAuB,KAAK,OAAO,YACrC,EAGF,MAAM0Z,GAAQnL,GAAOD,GAAAD,EAAA+K,EAAA,OAAM,UAAb,YAAA9K,EAAA,KAAAD,CAAA,SAAAE,EAA4B,IAAIoJ,GAC9C+B,EAAM,OAASN,EAEfM,EAAM,GAAK,KAAK,GACVA,EAAA,KAAO,MAAM,KAAKV,CAAK,EAC7BU,EAAM,OAAS,KAAK,OACpB,MAAMC,EAAW,IAAIrC,GACnB,KAAK,OACLoC,EAAM,QACN,KAAK,QACP,EACA,KAAK,UAAYC,EACjB,MAAM1D,EAAQ0D,EAAS,MACvBD,EAAM,OAASzD,EACfyD,EAAM,MAAQ,KAAK,MACnBA,EAAM,IAAM,KAAK,IACb,KAAK,MACPA,EAAM,MAAQ,KAAK,KAGrB,MAAME,GAAeH,GAAAjL,EAAA4K,EAAO,OAAM,QAAb,KAAqB,OAAAK,EAAA,KAAAjL,EAAA8J,EAAA,EAC1C,OAAIsB,GACK,eAAQA,CAAY,EAAE,QAAQ,CAAC,CAAC7H,EAAKxO,CAAK,IAAM,CACjDwO,KAAOkE,GAGP1S,IAAU,SACd0S,EAAMlE,CAAG,EAAIxO,EAAA,CACd,EAGImW,CAAA,CAGD,cAAe,CAlFzB,IAAArL,EAAAC,EAmFQ,IAAAuJ,EACAkB,EACAQ,EACAC,EACE,MAAAR,MAAyB,IA4B/B,GA1BA,KAAK,OAAO,QAAQ,CAACzV,EAAOwO,IAAQ,CAClC,GAAIA,IAAQ,UAAY,OAAOxO,GAAU,SAAU,CAC5CsU,EAAAtU,EACL,OAEF,GAAIwO,IAAQ,eAAiB,OAAOxO,GAAU,SAAU,CAC5CwV,EAAAxV,EACV,OAEF,GAAIwO,IAAQ,gBAAkBxO,aAAiBsW,GAAS,CAC1CL,EAAAjW,EACZ,OAEF,GAAIwO,IAAQ,eAAiB,OAAOxO,GAAU,SAAU,CAC5CgW,EAAAhW,EACV,OAEE,GAAAwO,EAAI,WAAW,OAAO,EAAG,CAGrB,MAAA+H,EAFU/H,EAAI,QAAQ,QAAS,EAAE,EAClB,MAAM,GAAG,EACT,CAAC,EACtBiH,EAAM,IAAIc,CAAO,EACjB,OACF,CACD,EAEG,CAACjC,EACH,MAAM,IAAI3X,EACRF,EAAU,eACV,2CACF,EAEF,GAAI,CAAC+Y,EACH,MAAM,IAAI7Y,EACRF,EAAU,eACV,gDACF,EAEF,GAAI,CAACwZ,EACH,MAAM,IAAItZ,EACRF,EAAU,eACV,iDACF,EAGF,MAAMoZ,EAAS,KAAK,OAAO,iBAAiB,IAAIL,CAAO,EACvD,GAAI,CAACK,EACH,MAAM,IAAIlZ,EACRF,EAAU,eACV,uBAAuB+Y,CAAO,YAChC,EAGE,OAAOQ,GAAY,WAErBA,EAAUH,EAAO,SAGnB,MAAMQ,GAAetL,GAAAD,EAAA+K,EAAO,OAAM,QAAb,KAAqB,OAAA9K,EAAA,KAAAD,EAAAiK,EAAA,EAE1C,OAAIsB,GACF,OAAO,KAAKA,CAAY,EAAE,QAAe7H,GAAA,CACnCiH,EAAM,IAAIjH,CAAG,GACjBiH,EAAM,IAAIjH,CAAG,EACd,EAGI,CACL,GAAA8F,EACA,QAAAkB,EACA,QAAAQ,EACA,MAAAP,EACA,UAAAQ,CACF,EAGF,IAAI,OAAQ,CACV,OAAO,KAAK,UAAU,MAGxB,IAAI,KAAM,CACR,OAAO,KAAK,UAAU,IAE1B,8FClJO,MAAMO,EAAe,CAoF1B,YACWX,EACAE,EACApL,EACAiB,EACT,CAJS,YAAAiK,EACA,YAAAE,EACA,SAAApL,EACA,cAAAiB,EAvFX,KAAQ,aAAwB,GAEf,mBAAiBR,GAAmB,CACnD,KAAK,aAAe,GACjBA,EAAA,EACH,KAAK,aAAe,EACtB,EAEA,KAAiB,OAASqL,GAAY,EAEtC,KAAiB,sBAAwB,IAAM,CACxC,YAAO,QAAiB7L,GAAA,CACrBA,EAAA,YAAY,QAAe4D,GAAA,CAvCvC,IAAA1D,EAAAC,EAwCQ,MAAMiF,EAAOpF,EAAM,QAAQ,KAAK,IAAI4D,CAAG,EACvC,GAAI,CAACwB,EACH,OAEI,MAAA7E,EACJ,CAAC,KAAK,OAAO,KACb,CAACP,EAAM,YAAY,QACnBA,EAAM,YAAY,kBAAkBM,IACpCN,EAAM,YAAY,OAAO,MACrB,GACAA,EAAM,YAAY,SAAW,KAAK,OAAO,IAAI,SACnD,GAAIoF,EAAK,SAAW,UAAYA,EAAK,SAAW,MAAO,CACrD,MAAMhQ,EAAQ,KAAK,OAAO,IAAIwO,CAAG,EAC3BiF,EAAUjF,EAAI,QAAQ,QAAS,EAAE,EACjCkE,EAAQ,KAAK,eAAee,EAASzT,CAAK,EAChD,KAAK,cAAc,IAAM,CAElB,WAAM,MAAMyT,CAAO,EAAIf,EACtB,MAAAZ,EAAY,GAAG2B,CAAO,IAC5B,KAAK,OAAO,IAAM,CACZ3B,KAAa,KAAK,MAAM,QAE1B,KAAK,MAAM,MAAMA,CAAS,EAAE,MAAQrD,GAASzO,CAAK,EACpD,CACD,EACF,GACI8K,EAAA,gBAAL,kBAAgB2I,EAAStI,CAAA,EACzB,OAEE,GAAA6E,EAAK,SAAW,SAAU,CAC5B,MAAMyD,EAAUjF,EAAI,QAAQ,QAAS,EAAE,EACvC,KAAK,cAAc,IAAM,CAEhB,YAAK,MAAM,MAAMiF,CAAO,EAC3B,GAAGA,CAAO,MAAO,KAAK,MAAM,QAE9B,KAAK,MAAM,MAAM,GAAGA,CAAO,GAAG,EAAE,MAAQ,OAC1C,CACD,GACI1I,EAAA,gBAAL,kBAAgB0I,EAAStI,CAAA,EACzB,OACF,CACD,EACF,CACH,EAEiB,kBAAe,IAQvB,SAAO2E,GAAiB,CAC1B,KAAK,SAAS,IAAIA,CAAI,GAC3B,KAAK,SAASA,CAAI,CACpB,EAES,WAASA,GAAiB,CAC7B,KAAK,SAAS,IAAIA,CAAI,IAErB,cAAS,IAAIA,CAAI,EACtB,KAAK,WAAWA,CAAI,EACtB,EAYQ,MAAE,GAAAwE,EAAI,QAAAkB,EAAS,QAAAQ,EAAS,UAAAC,EAAW,MAAAR,CAAM,EAAI,KAAK,aAAa,EAErE,KAAK,GAAKnB,EACV,KAAK,QAAUkB,EACf,KAAK,UAAYS,EACjB,KAAK,QAAUD,EAEV,WAAQ,KAAK,aAAaP,CAAK,EAEpC,KAAK,sBAAsB,EAGrB,aAAaA,EAAiB,CAhIxC,IAAA3K,EAAAC,EAAAC,EAiII,MAAM0L,EAAS,KAAK,OACdb,EAAS,KAAK,OAAO,iBAAiB,IAAI,KAAK,OAAO,EAC5D,GAAI,CAACA,EACH,MAAM,IAAIlZ,EACRF,EAAU,eACV,uBAAuB,KAAK,OAAO,YACrC,EAGF,MAAM0Z,GAAQnL,GAAOD,GAAAD,EAAA+K,EAAA,OAAM,UAAb,YAAA9K,EAAA,KAAAD,CAAA,SAAAE,EAA4B,IAAIoJ,GAC9C+B,EAAM,OAASN,EACf,MAAMc,EAAkB,OAAO,QAAQlB,CAAK,EAAE,OAC5C,CAACpE,EAAK,CAAC7C,EAAKxO,CAAK,IAAM,CACf,MAAA2O,EAAOvE,GAAOpK,CAAK,EACnB4W,EAAUC,GAAO,IAAM,CAC3B,MAAM7W,EAAQ2O,EAAK,MACd,KAAK,OACV+H,EAAO,IAAM,CAEN,WAAM,MAAMlI,CAAG,EAAIxO,CAAA,CACzB,EACF,EACK+S,EAAeoD,EAAM,QAAQ,UAAU,IAAM,CACjDpD,EAAa,YAAY,EACjB6D,EAAA,EACT,EACM,OACL,GAAGvF,EACH,CAAC,GAAG7C,CAAG,GAAG,EAAGG,EACb,CAACH,CAAG,EAAGxO,CACT,CACF,EACA,EACF,EAEAmW,EAAM,GAAK,KAAK,GACVA,EAAA,KAAO,OAAO,KAAKV,CAAK,EAC9BU,EAAM,OAAS,KAAK,OACpBA,EAAM,MAAQ,KAAK,MACnBA,EAAM,IAAM,KAAK,IACb,KAAK,MACPA,EAAM,MAAQ,KAAK,KAGf,MAAAzD,EAAQ,IAAI,MAAMiE,EAAiB,CACvC,IAAK,CAACtH,EAAQ5N,IACL,QAAQ,IAAI4N,EAAQ5N,CAAC,EAE9B,IAAK,CAAC4N,EAAQ5N,EAAGzB,EAAOsP,IAAa,CAjL3CxE,MAmLU,IAAC,KAAK,cACN,OAAOrJ,GAAM,UACb0U,EAAM,KAAK,SAAS1U,CAAC,EACrB,CACA,GAAI,KAAK,SAAS,IAAIA,CAAC,EAAG,CACfqV,EAAAzH,EAAQ5N,EAAGzB,CAAK,EACzB,MAAMyC,EAAS,QAAQ,IAAI4M,EAAQ5N,EAAGzB,EAAOsP,CAAQ,EACrD,OAAAxE,EAAA,KAAK,WAAL,MAAAA,EAAA,UAAgBrJ,EAAG,IACZgB,CAAA,CAGH,MAAAyQ,EAASlF,GAAShO,CAAK,EAC7B,GAAI,KAAK,OAAO,IAAI,QAAQyB,CAAC,EAAE,IAAMyR,EACnC,OAAO,QAAQ,IAAI7D,EAAQ5N,EAAGzB,EAAOsP,CAAQ,EAE/C,KAAK,OAAO,IAAI,QAAQ7N,CAAC,GAAIyR,CAAM,EACnC,MAAMR,EAAQ,KAAK,eAAejR,EAAGyR,CAAM,EAClC,OAAA4D,EAAAzH,EAAQ5N,EAAGzB,CAAK,EAClB,QAAQ,IAAIqP,EAAQ5N,EAAGiR,EAAOpD,CAAQ,EAG/C,OAAO,QAAQ,IAAID,EAAQ5N,EAAGzB,EAAOsP,CAAQ,CAC/C,EACA,IAAK,CAACD,EAAQ5N,EAAG6N,IACR,QAAQ,IAAID,EAAQ5N,EAAG6N,CAAQ,EAExC,eAAgB,CAACD,EAAQ5N,KAErB,CAAC,KAAK,cACN,OAAOA,GAAM,UACb0U,EAAM,KAAK,SAAS1U,CAAC,IAErB,KAAK,OAAO,OAAO,QAAQA,CAAC,EAAE,EACrBqV,EAAAzH,EAAQ5N,EAAG,MAAS,GAGxB,QAAQ,eAAe4N,EAAQ5N,CAAC,EACzC,CACD,EACD0U,EAAM,OAASzD,EAEN,SAAAoE,EAASzH,EAAkB5N,EAAWzB,EAAgB,CAC7D0W,EAAO,IAAM,CAEXrH,EAAO,GAAG5N,CAAC,GAAG,EAAE,MAAQzB,CAAA,CACzB,EAEI,OAAAmW,CAAA,CAGD,eAAeY,EAAc/W,EAAgB,CACnD,OAAOoP,GAAapP,EAAO,CACzB,SAAU,CAACf,EAAGkM,IAAY,CAvOhC,IAAAL,GAwOaA,EAAA,gBAAL,kBAAgBiM,EAAM5L,CAAA,EAChB,MAAA2G,EAAY,GAAGiF,CAAI,IACrBjF,KAAa,KAAK,MAAM,OAC1B,KAAK,OAAO,IAAM,CAEhB,KAAK,MAAM,MAAMA,CAAS,EAAE,MAAQrD,GAASzO,CAAK,EACnD,CACH,CACF,CACD,EAGK,cAAe,CApPzB,IAAA8K,EAAAC,EAqPQ,IAAAuJ,EACAkB,EACAQ,EACAC,EACJ,MAAMR,EAAiC,CAAC,EA0BxC,GAxBA,KAAK,OAAO,QAAQ,CAACzV,EAAOwO,IAAQ,CAC9B,GAAAA,EAAI,WAAW,OAAO,EAAG,CAC3B,MAAMiF,EAAUjF,EAAI,QAAQ,QAAS,EAAE,EACvCiH,EAAMhC,CAAO,EAAI,KAAK,eAAeA,EAASzT,CAAK,EACnD,OAEF,GAAIwO,IAAQ,UAAY,OAAOxO,GAAU,SAAU,CAC5CsU,EAAAtU,EACL,OAEF,GAAIwO,IAAQ,eAAiB,OAAOxO,GAAU,SAAU,CAC5CwV,EAAAxV,EACV,OAEF,GAAIwO,IAAQ,gBAAkBxO,aAAiBsW,GAAS,CAC1CL,EAAAjW,EACZ,OAEF,GAAIwO,IAAQ,eAAiB,OAAOxO,GAAU,SAAU,CAC5CgW,EAAAhW,EACV,OACF,CACD,EAEG,CAACsU,EACH,MAAM,IAAI3X,EACRF,EAAU,eACV,2CACF,EAEF,GAAI,CAAC+Y,EACH,MAAM,IAAI7Y,EACRF,EAAU,eACV,gDACF,EAEF,GAAI,CAACwZ,EACH,MAAM,IAAItZ,EACRF,EAAU,eACV,iDACF,EAGF,MAAMoZ,EAAS,KAAK,OAAO,iBAAiB,IAAIL,CAAO,EACvD,GAAI,CAACK,EACH,MAAM,IAAIlZ,EACRF,EAAU,eACV,uBAAuB+Y,CAAO,YAChC,EAEF,MAAMa,GAAetL,GAAAD,EAAA+K,EAAO,OAAM,QAAb,KAAqB,OAAA9K,EAAA,KAAAD,EAAAiK,EAAA,EAEtC,cAAOiB,GAAY,WAErBA,EAAUH,EAAO,SAIfQ,GACK,eAAQA,CAAY,EAAE,QAAQ,CAAC,CAAC7H,EAAKxO,CAAK,IAAM,CACrD,GAAIwO,KAAOiH,EAAO,OAEZ,MAAAvC,EAASlF,GAAShO,CAAK,EACzBA,IAAU,QACZ,KAAK,OAAO,IAAI,QAAQwO,CAAG,GAAI0E,CAAM,EAEvCuC,EAAMjH,CAAG,EAAI,KAAK,eAAeA,EAAK0E,CAAM,EAC7C,EAGI,CACL,GAAAoB,EACA,QAAAkB,EACA,QAAAQ,EACA,MAAAP,EACA,UAAAQ,CACF,EAGM,SAASnG,EAAc,CAC7B,MAAMqG,EAAQ,KAAK,MAEbnW,EAAQmW,EAAM,MAAMrG,CAAI,EACzB,cAAS,OAAOA,CAAI,EACnBqG,EAAA,MAAMrG,CAAI,EAAI9P,CAAA,CAGd,WAAW8P,EAAc,CAC9B,KAAK,MAA8C,MAAMA,CAAI,EAAIrB,GAChE,KAAK,OAAO,IAAI,QAAQqB,CAAI,EAAE,EAC9B,CACE,UAAW,CAAC9P,EAAOkQ,IACbnE,GAAM,GAAGmE,CAAM,EACVlQ,EAELkQ,aAAkBxE,GACb,IAAI,MAAM1L,EAAmB,CAClC,IAAK,CAACqP,EAAQ5N,EAAG6N,IACR,QAAQ,IAAID,EAAQ5N,EAAG6N,CAAQ,EAExC,IAAK,CAACD,EAAQ5N,EAAGzB,EAAOsP,IAAa,CA/VnD,IAAAxE,EAgWgB,MAAMrI,EAAS,QAAQ,IAAI4M,EAAQ5N,EAAGzB,EAAOsP,CAAQ,EAChD,OAAAxE,EAAA,gBAAL,kBAAgBgF,EAAM,IACfrN,CACT,EACA,eAAgB,CAAC4M,EAAQ5N,IAAM,CApW7C,IAAAqJ,EAqWgB,MAAMrI,EAAS,QAAQ,eAAe4M,EAAQ5N,CAAC,EAC1C,OAAAqJ,EAAA,gBAAL,kBAAgBgF,EAAM,IACfrN,CAAA,CACT,CACD,EAECyN,aAAkBoG,GACb,IAAI,MAAMtW,EAAoB,CACnC,IAAK,CAACqP,EAAQ5N,EAAG6N,IACR,QAAQ,IAAID,EAAQ5N,EAAG6N,CAAQ,EAExC,IAAK,CAACD,EAAQ5N,EAAGzB,EAAOsP,IAAa,CAhXnD,IAAAxE,EAiXsB,MAAA+B,EAAQ,OAAOpL,CAAC,EAClB,UAAO,MAAMoL,CAAK,EACpB,OAAO,QAAQ,IAAIwC,EAAQ5N,EAAGzB,EAAOsP,CAAQ,EAE/C,MAAM7M,EAAS,QAAQ,IAAI4M,EAAQ5N,EAAGzB,EAAOsP,CAAQ,EAChD,OAAAxE,EAAA,gBAAL,kBAAgBgF,EAAM,IACfrN,CACT,EACA,eAAgB,CAAC4M,EAAQ5N,IAAM,CAzX7C,IAAAqJ,EA0XgB,MAAMrI,EAAS,QAAQ,eAAe4M,EAAQ5N,CAAC,EAC1C,OAAAqJ,EAAA,gBAAL,kBAAgBrJ,EAAa,IACtBgB,CAAA,CACT,CACD,EAGIzC,CACT,CAEJ,EAEJ,CC9XO,MAAMgX,EAAM,CA6BjB,YACWnB,EACAE,EACApL,EACA7N,EAAwB,GACjC,CAJS,YAAA+Y,EACA,YAAAE,EACA,SAAApL,EACA,aAAA7N,EA9BoB,6BAgC7B,MAAM8O,EAAY9O,EAAQ,SAEtB,CAAC0R,EAAarD,IAAqB,CA7C3C,IAAAL,EA8Cc,CAAC,KAAK,iBAAmB,CAAC,KAAK,QAG3BA,EAAAhO,EAAA,WAAR,MAAmBgO,EAAA,KAAAhO,EAAA,KAAM0R,EAAKrD,CAAA,CAChC,EANA,OAOEqK,EAAUO,EAAO,IAAI,aAAa,EAClCkB,EAAc,KAAK,OAAO,IAAIzB,CAAO,EACvCyB,GAAa,MAAM,WACrB,KAAK,gBAAkB,IAAInB,GACzBD,EACAE,EACApL,EACAiB,CACF,EAEA,KAAK,gBAAkB,IAAI4K,GAAeX,EAAQE,EAAQpL,EAAKiB,CAAQ,CACzE,CAjDF,IAAI,SAAU,CACZ,OAAO,KAAK,gBAAgB,QAG9B,IAAI,IAAK,CACP,OAAO,KAAK,gBAAgB,GAG9B,IAAI,OAAQ,CACV,OAAO,KAAK,gBAAgB,MAG9B,IAAI,KAAM,CACR,OAAO,KAAK,gBAAgB,IAG9B,IAAI,OAAQ,CACV,OAAO,KAAK,gBAAgB,MAG9B,IAAI,SAAU,CACZ,OAAO,KAAK,gBAAgB,QA8BhC,CC/CO,SAASsL,GACdhH,EACmB,CACb,MAAE,GAAAoE,EAAI,QAAA0B,EAAS,QAAAR,EAAS,KAAA2B,EAAM,KAAAlG,EAAM,KAAAxE,EAAM,SAAA2K,GAAalH,EAEvDuF,EAAQvF,EAAO,KAAK,OAAO,CAACmB,EAAK7C,IAAQ,CAEvC,MAAAxO,EADSkQ,EAAO,MACD1B,CAA0B,EACxC,OACL,GAAG6C,EACH,CAAC7C,CAAG,EAAGxO,CACT,CACF,EAAG,EAAuB,EAEnB,OACL,GAAAsU,EACA,QAAA0B,EACA,QAAAR,EACA,KAAA2B,EACA,KAAAlG,EACA,KAAAxE,EACA,SAAU2K,EAAS,IAAIF,EAAY,EACnC,MAAAzB,CACF,CACF,CCvCO,MAAM4B,GAA0C,UAC1CC,GAAa,CAAC,ECApB,MAAMC,WAA4B,KAAM,CAC7C,aAAc,CACZ,MAAM,yCAAyC,EAEnD,CAEO,MAAMC,WAAgC,KAAM,CACjD,YAAqBC,EAA2C,CAC9D,MACE;AAAA,EACEC,GAAyBD,CAAe,CAC5C,EAJmB,qBAAAA,CAAA,CAMvB,CAEO,MAAME,WAA6B,KAAM,CAC9C,YAAqBC,EAAoC,CACvD,MAAM,WAAWC,GAAoBD,CAAU,CAAC,yBAAyB,EADtD,gBAAAA,CAAA,CAGvB,CAEO,MAAME,WAA+B,KAAM,CAChD,YACWtZ,EACA6Q,EACAoI,EACT,CACA,MACE,sBAAsBI,GACpBxI,CACD,yBAAwBwI,GACvBrZ,CAAA,CACD;AAAA,EAAMkZ,GAAyBD,CAAe,CAAC,EAClD,EAVS,UAAAjZ,EACA,YAAA6Q,EACA,qBAAAoI,CAAA,CAUb,CAEO,MAAMM,WAAwC,KAAM,CACzD,YAAqBH,EAAoC,CACvD,MAAM,WAAWC,GAAoBD,CAAU,CAAC,iBAAiB,EAD9C,gBAAAA,CAAA,CAGvB,CAEA,SAASC,GAAoBD,EAAoC,CACxD,UAAIA,EAAW,cAAc,IAClCA,EAAW,UAAYP,GACnB,IAAIO,EAAW,OAAO,IACtB,EACN,EACF,CAEA,SAASF,GAAyBD,EAA2C,CACpE,OAAAA,EACJ,IAAIG,GAAc,GAAGC,GAAoBD,CAAU,CAAC,EAAE,EACtD,KAAK,MAAM,CAChB,CCrDA,MAAMI,OAAY,QAGlB,IAAIC,GAAU,EAUP,SAASC,GAAWC,EAAkB,CAC3C,MAAMnI,EAAO,OAAOmI,EACdC,EAAcD,GAAOA,EAAI,YACzBE,EAASD,IAAgB,KAE/B,GAAI,OAAOD,CAAG,IAAMA,GAAO,CAACE,GAAUD,IAAgB,OAAQ,CAGxD,IAAA3V,EAASuV,GAAM,IAAIG,CAAG,EAC1B,GAAI1V,EAAe,OAAAA,EAInBA,EAAS,EAAEwV,GAAU,IACfD,GAAA,IAAIG,EAAK1V,CAAM,EACjB,IAAAoK,EAEJ,GAAIuL,IAAgB,MAAO,CAGzB,IADS3V,EAAA,IACJoK,EAAQ,EAAGA,EAAQsL,EAAI,OAAQtL,IAClCpK,GAAUyV,GAAWC,EAAItL,CAAK,CAAC,EAAI,IAE/BmL,GAAA,IAAIG,EAAK1V,CAAM,UACZ2V,IAAgB,OAAQ,CAExB3V,EAAA,IACT,MAAMwO,EAAO,OAAO,KAAKkH,CAAG,EAAE,KAAK,EACnC,MAAQtL,EAAQoE,EAAK,IAAI,KAAiB,QACpCkH,EAAItL,CAAK,IAAM,SACjBpK,GAAUoK,EAAQ,IAAMqL,GAAWC,EAAItL,CAAK,CAAC,EAAI,KAG/CmL,GAAA,IAAIG,EAAK1V,CAAM,EAEhB,OAAAA,CAAA,CAEL,OAAA4V,EAAeF,EAAI,OAAO,EAC1BnI,IAAS,SAAiBmI,EAAI,SAAS,EACpCnI,IAAS,SAAW,KAAK,UAAUmI,CAAG,EAAI,GAAKA,CACxD,CCmBgB,SAAAG,GACdvB,EACAwB,EAA0BlB,GAE2C,CACrE,OAAO,OAAO,OACMkB,GACTD,GAAoBvB,EAAMwB,CAAO,EAE1C,CACE,eAAgBxB,EAChB,QAAAwB,CAAA,CAEJ,CACF,CAQO,SAASC,GACdnJ,EACsB,CACf,OAAAiJ,GAAoB,GAAGjJ,EAAO,IAAI,GAAG6I,GAAW7I,CAAM,CAAC,EAAE,CAClE,CAEO,SAASoJ,GAAgBjM,EAAoC,CAClE,GAAIA,EAAM,eACD,OAAAA,EACE,UAAOA,GAAU,YAAcA,EAAM,KAC9C,OAAOgM,GAAgChM,CAAK,EAEtC,UAAI,MAAM,oCAAoC,CAExD,CC9FO,MAAekM,EAAgB,CAGpC,IAAOd,EAAyC9a,EAA6B,CAC3E,OAAO,KAAK,OAAO2b,GAAgBb,CAAU,EAAG,CAC9C,GAAG9a,EACH,SAAU,GACX,EAGH,OACE8a,EACA9a,EACwB,CACxB,OAAO,KAAK,UAAU2b,GAAgBb,CAAU,EAAG,CACjD,GAAG9a,CAAA,CACJ,EAQH,YACE8a,EACA9a,EACU,CACV,OAAO,KAAK,OAAO2b,GAAgBb,CAAU,EAAG,CAC9C,GAAG9a,EACH,SAAU,GACX,EAOL,CAEO,MAAM6b,EAAiB,CAAvB,cACL,eAAY,GAAsC,CAElD,YAAYf,EAAoChK,EAAmB,CA9DrE,IAAA9C,EA+DU,MAAA8N,GAAQ9N,OAAK,MAAM,IAAI8M,EAAW,cAAc,IAAxC,KAA6C9M,EAAA,IAAI,IAC1D8N,EAAM,IAAIhB,EAAW,OAAO,GAC/BgB,EAAM,IAAIhB,EAAW,QAAShK,EAAA,CAAQ,EAExC,MAAMiL,EAASD,EAAM,IAAIhB,EAAW,OAAO,EAC3C,YAAK,MAAM,IAAIA,EAAW,eAAgBgB,CAAK,EACxCC,CAAA,CAEX,CAEO,MAAMC,WAAwBJ,EAAgB,CAGnD,YACWK,EACAC,EAAQ,EACRC,EAAkC,GAC3C,CACM,QAJG,cAAAF,EACA,WAAAC,EACA,WAAAC,EALX,eAAY,KAAK,SAAS,UAU1B,UACErB,EACA,CAAE,UAAAsB,EAAY,EAAM,EAAoB,GACd,CACpB,MAAAC,EAAO,KAAK,SAAS,UAAU,cACnCvB,EACA,KAAK,SAAS,KAChB,EAEA,GAAIuB,IAAS,OACX,OAAI,KAAK,SAAS,QAAU,CAACD,EACpB,KAAK,SAAS,OAAO,UAAUtB,CAAU,MAGvC,IAGP,MAAAnV,MAAa,IAEnB,SAAW,CAAC8V,EAASa,CAAO,IAAKD,EAAM,CAC/B,MAAAE,EAAU,KAAK,SAAS,MAAM,YAClC,CAAE,eAAgBzB,EAAW,eAAgB,QAAAW,CAAQ,EACrD,IAAM,CACE,MAAAe,EAAe,KAAK,MAAM1B,CAAU,EACtC,IACF,OAAOwB,EAAQE,CAAY,QACpBC,EAAK,CACZ,MAAIA,aAAe5B,GACX,IAAIG,GACRF,EACA2B,EAAI,WACJ,KAAK,KACP,EAEIA,CAAA,CACR,CAEJ,EACO9W,EAAA,IAAI8V,EAASc,CAAO,EAGtB,OAAA5W,CAAA,CAGT,OACEmV,EACA,CAAE,UAAAsB,EAAY,GAAO,SAAAM,EAAW,EAA0B,KAC1D,CACM,MAAAJ,EAAU,KAAK,SAAS,UAAU,WACtCxB,EACA,KAAK,SAAS,KAChB,EACA,GAAI,CAACwB,EAAS,CACZ,GAAI,KAAK,SAAS,QAAU,CAACF,EAC3B,OAAO,KAAK,SAAS,OAAO,OAAOtB,EAAY,CAC7C,UAAAsB,EACA,SAAAM,CAAA,CACD,EAGH,GAAIA,EACK,OAEH,UAAI7B,GAAqBC,CAAU,EAG3C,OAAO,KAAK,SAAS,MAAM,YAAYA,EAAY,IAAM,CACjD,MAAA0B,EAAe,KAAK,MAAM1B,CAAU,EACtC,IACF,OAAOwB,EAAQE,CAAY,QACpBC,EAAK,CACZ,MAAIA,aAAe5B,GACX,IAAIG,GACRF,EACA2B,EAAI,WACJ,KAAK,KACP,EAEIA,CAAA,CACR,CACD,EAGH,MAAM3B,EAAqD,CACnD,MAAAoB,EAAQ,KAAK,MAAQ,EAC3B,GAAIA,GAAS,IACX,MAAM,IAAIzB,GAOZ,GALiB,KAAK,MAAM,QAExBrY,EAAE,iBAAmB0Y,EAAW,gBAChC1Y,EAAE,UAAY0Y,EAAW,OAC7B,EAEE,MAAM,IAAIJ,GAAwB,CAAC,GAAG,KAAK,MAAOI,CAAU,CAAC,EAG/D,OAAO,IAAIkB,GAAgB,KAAK,SAAUE,EAAO,CAC/C,GAAG,KAAK,MACRpB,CAAA,CACD,EAEL,CAEO,MAAM6B,WAA6Bf,EAAgB,CAKxD,YACEgB,EACSC,EACAhJ,EACT,CACM,QAHG,WAAAgJ,EACA,YAAAhJ,EAPF,WAAQ,IAAIgI,GAUd,eAAYe,EAAU,MAAM,EAC5B,eAAU,SAAShB,GAAiB,KAAM,CAC7C,MAAAiB,EACA,SAAU,GACX,EAGH,UACE/B,EACA9a,EAC0B,CAEnB,OADU,IAAIgc,GAAgB,IAAI,EACzB,UAAUlB,EAAY9a,CAAO,EAG/C,OAAO8a,EAAoC9a,EAA0B,CAE5D,OADU,IAAIgc,GAAgB,IAAI,EACzB,OAAOlB,EAAY9a,CAAO,EAE9C,CCvNgB,SAAA8c,GACd7C,EACAzE,EAAqBgF,GACP,CACP,OAAC,GAAGhF,EAAMyE,CAAI,CACvB,CAEO,SAAS8C,GAAeF,EAA6B,CACnD,OAAAA,EAAM,KAAK,GAAG,CACvB,CCwFO,MAAMG,EAAU,CAAhB,cACY,kBAAe,GAG9B,CAKF,IAAI,KAAM,CACD,WAAIC,GAAgB,IAAI,EAAE,IAMnC,IAAI,SAAU,CACL,WAAIA,GAAgB,IAAI,EAAE,QAQnC,WAAW,OAAQ,CACjB,OAAO,IAAID,EAAU,CAMvB,IAAI,UAAW,CACN,WAAIC,GAAgB,IAAI,EAAE,SAMnC,IAAI,OAAQ,CACH,WAAIA,GAAgB,IAAI,EAAE,MAMnC,IAAI,MAAO,CACT,IAAIC,EAAO,EACX,SAAW,CAAG,CAAAC,CAAW,IAAK,KAAK,SACjC,SAAW,EAAGC,CAAQ,IAAKD,EACzBD,GAAQE,EAAS,KAGd,OAAAF,CAAA,CAMT,WACEpC,EACAwB,EACA,CAAE,MAAAO,EAAO,SAAAQ,CAAS,EAAkD,GACpE,CAnKJ,IAAArP,EAAAC,EAAAC,EAqKU,MAAAoP,EAAkBP,GAAeF,GAASrC,EAAU,EACpD+C,EAAuB5B,GAAgBb,CAAU,EACjD0C,GACJxP,EAAqBuP,EAAA,UAArB,KAAgCvP,EAAAuM,GAE5BkD,GACJxP,OAAK,SAAS,IAAIqP,CAAe,IAAjC,KAAArP,MACI,IAEAmP,GACJlP,IAAS,IAAIqP,EAAqB,cAAc,IAAhD,KAAArP,MACI,IAGN,GAAIkP,EAAS,IAAII,CAAiB,GAAK,CAACH,EAChC,UAAIpC,GAAgCsC,CAAoB,EAEvDH,EAAA,IAAII,EAAmBlB,CAAO,EAC9BmB,EAAA,IAAIF,EAAqB,eAAgBH,CAAQ,EACrD,cAAS,IAAIE,EAAiBG,CAAQ,EAM7C,SACE3C,EACA5X,EACA,CAAE,MAAA2Z,EAAO,SAAAQ,CAAS,EAAkD,GACpE,CACK,gBACH1B,GAAgBb,CAAU,EAC1B,IAAM5X,EACN,CACE,MAAA2Z,EACA,SAAAQ,CAAA,CAEJ,EAUF,OAAmB,CACX,MAAAK,EAAK,IAAIV,GACf,SAAW,CAACH,EAAOM,CAAW,IAAK,KAAK,SAAU,CAC1C,MAAAvb,MAAQ,IACd,SAAW,CAACkZ,EAAYsC,CAAQ,IAAKD,EACnCvb,EAAE,IAAIkZ,EAAY,IAAI,IAAIsC,CAAQ,CAAC,EAElCM,EAAA,SAAS,IAAIb,EAAOjb,CAAC,EAEnB,OAAA8b,CAAA,CAMT,WACE5C,EACA+B,EAAsBrC,GACM,CAtOhC,IAAAxM,EAAAC,EAAAC,EAuOI,OAAOA,GAAKF,EAAA,cACT,IAAI+O,GAAeF,CAAK,CAAC,IADrB,KAEH,OAAA7O,EAAA,IAAI8M,EAAW,cAFZ,gBAAA5M,EAGH,KAAID,EAAA6M,EAAW,UAAX,KAAsB7M,EAAAsM,EAAA,EAMhC,cACEO,EACA+B,EAAsBrC,GACe,CAnPzC,IAAAxM,EAoPI,OAAO,IAAI,KACTA,EAAA,KAAK,SAAS,IAAI+O,GAAeF,CAAK,CAAC,IAAvC,KAA0C,OAAA7O,EAAA,IAAI8M,EAAW,eAC3D,EAeF,SACE+B,EAAsBrC,GACtB3G,EAAiC,KAChB,CACjB,OAAO,IAAI8I,GAAqB,KAAME,EAAOhJ,CAAM,EAEvD,CAKA,MAAMoJ,EAAgB,CA0IpB,YAA6BL,EAAsB,CAAtB,eAAAA,EAzI7B,KAAQ,aAA6BpC,GAYrC,SAAM,CAMJmD,KACG,CAACC,CAAI,KAER,KAAK,UAAU,WACbD,EACAE,GAAsBF,EAAKC,CAAW,EACtC,CAAE,MAAO,KAAK,YAAa,CAC7B,EAEO,MAiBT,aAAU,CAWR9C,EACAgD,KACG,CAACC,CAAI,KAEJD,aAAgB,SAClB,KAAK,UAAU,WACbhD,EACA+C,GAAsBC,EAAMC,CAAa,EACzC,CAAE,MAAO,KAAK,YAAa,CAC7B,EAEK,eAAU,SAASjD,EAAYgD,EAAa,CAC/C,MAAO,KAAK,aACb,EAGI,MAmBT,cAAW,CAWThD,EACAgD,KACG,CAACC,CAAI,KAEJD,aAAgB,SAClB,KAAK,UAAU,WACbhD,EACA+C,GAAsBC,EAAMC,CAAa,EACzC,CAAE,MAAO,KAAK,aAAc,SAAU,EAAK,CAC7C,EAEK,eAAU,SAASjD,EAAYgD,EAAa,CAC/C,MAAO,KAAK,aACZ,SAAU,GACX,EAGI,MAcT,WAASjB,IACP,KAAK,aAAeA,EACb,KACT,CAGF,CAKA,SAASgB,GACPF,EACAC,EAAc,GACO,CACrB,OAAQ3B,GAA8B,CACpC,MAAM+B,EAAO,CAAC,EACd,UAAWC,KAAOL,EAAM,CAClB,IAAAM,EACApD,EACA,SAAM,QAAQmD,CAAG,EAAG,CAClB,GAAAA,EAAI,SAAW,EACX,UAAI,MAAM,oBAAoB,EAE9BC,EAAA,GACRpD,EAAamD,EAAI,CAAC,OAEVC,EAAA,GACKpD,EAAAmD,EAEXC,EACGF,EAAA,KAAK,MAAM,KAAK/B,EAAS,OAAOnB,CAAU,EAAE,OAAO,CAAC,CAAC,EAE1DkD,EAAK,KAAK/B,EAAS,IAAInB,CAAU,CAAC,CACpC,CAEE,OAAAqD,GAAcR,CAAG,EACZ,IAAIA,EAAI,GAAGK,EAAM/B,CAAQ,EAEzB0B,EAAI,GAAGK,EAAM/B,CAAQ,CAEhC,CACF,CAIA,SAASkC,GAAcR,EAAc,CAC/B,IACF,eAAQ,UAAU,UAAY,GAAI,GAAIA,CAAY,EAC3C,EACD,OACC,SAEX,CCtca,MAAAS,GAAkB5C,GAAwB,OAAO,mqTCmB9C,SAAA6C,GAASC,EAAc7G,EAAc,CAC7C,MAAA8G,EAAgBC,GAAiBF,EAAO7G,CAAK,EAGnD,GAFAA,EAAM,cAAgB8G,EAElBA,IAAkB,SAAU,CAC9B,MAAME,EAAYH,EAAM,KACxBI,GAA8BD,EAAWhH,CAAK,EAElD,CAEA,SAAS+G,GAAiBF,EAAc7G,EAA6B,CAC7D,MAAAiB,EAAUjB,EAAM,MAAM,QACtBD,EAAKC,EAAM,MAAM,GACjBgH,EAAYH,EAAM,KAClB3F,EAAQlB,EAAM,MAAM,KAAK,OAC7B,CAAClD,EAAK7C,KACG,CACL,GAAG6C,EACH,CAAC7C,CAAG,EAAG+F,EAAM,MAAM,MAAM/F,CAAgC,CAC3D,GAEF,EACF,EACI,IAAA6M,EACFE,IAAc,QAAU,UAAY,SAEhC,OAAAH,EAAA,MAAM,KAAoBK,GAAA,CACxB,MACJ,GAAIC,EACJ,QAASC,EACT,MAAOC,EACP,SAAAC,CAAA,EACEJ,EACEK,EAAeJ,GAAW,KAAO,GAAOA,IAAYpH,EACpDyH,EACJJ,GAAgB,KAAO,GAAOA,IAAiBnG,EAC3CwG,EACJJ,GAAc,KAAO,GAAOK,GAAQxG,EAAOmG,CAAU,EACnD,OAAAE,GAAgBC,GAAqBC,GACvBX,EAAAQ,EACT,IAEF,GACR,EAEMR,CACT,CAEA,SAASG,GAA8BU,EAAiB3H,EAAc,CAC9D,MAAA5J,EAAM4J,EAAM,MAAM,MACxB,IAAI5D,EAAShG,EAAI,UAAU4J,EAAM,KAAK,EACtC,KAAO5D,GAAQ,CACb,MAAMwL,EAAcxR,EAAI,SAASgG,EAAO,EAAE,EACtCwL,GAAeA,EAAY,gBAAkB,WACnCA,EAAA,cAAgBD,IAAS,UAAY,UAAY,UAEtDvL,EAAAhG,EAAI,UAAUgG,CAAM,EAEjC,CCnEO,MAAMyL,EAAgB,CAAtB,cACL,KAAQ,aAAmC,CAAC,EAE5C,KAAQ,UAAY,GAEpB,IAAI,UAAW,CACb,OAAO,KAAK,UAOd,IAAItd,EAAqB,CACvB,GAAI,KAAK,UAAW,CAClBud,GAAcvd,CAAC,EACf,OAEG,kBAAa,KAAKA,CAAC,EAkC1B,aACEuQ,EACAW,EACAnF,EACAyR,EACA,CACA,KAAK,IAAI,CACP,QAAS,IAAM,CACNjN,EAAA,oBAAoBW,EAAMnF,EAAuByR,CAAY,EACtE,CACD,EACMjN,EAAA,iBAAiBW,EAAMnF,EAAuByR,CAAY,EAGnE,SAAU,CACRC,GAAW,KAAK,YAAY,EAC5B,KAAK,aAAe,CAAC,EACrB,KAAK,UAAY,GAErB,CAEO,SAASF,GAAcG,EAA8B,CACtD,IACEA,aAAsBC,GACxBD,EAAW,YAAY,EACdA,aAAsBhI,GAC/BgI,EAAW,SAAS,EACX,OAAOA,GAAe,WACpBA,EAAA,EAEXA,EAAW,QAAQ,QAEd/U,EAAG,CACV,QAAQ,MAAMA,CAAC,EAEnB,CAEA,SAAS8U,GAAWG,EAAiC,CACnDA,EAAY,QAAQL,EAAa,CACnC,CCoBO,MAAeM,EAAU,CAC9B,OAAO,MAAMC,EAAsB,EAGrC,CCjIA,IAAA9R,GAAAC,GAOa,MAAA8R,GACXvE,GAAiC,gBAAgB,EAEtCwE,GAAuB,OAAO,gBAAgB,EAQ9C,MAAAC,WAAuBhS,GAqBjB4R,GAAA7R,GAAAgS,GArBiB/R,GAAU,CAO5C,YAAqBiS,EAAc,CAC3B,QADa,WAAAA,CAAA,CAOrB,QAAS,EAKT,UAAW,EAIX,OAAgB,MAAMxC,EAAe,CAC/B,IAAC,KAAK,IACR,MAAM,IAAI7d,EACRF,EAAU,eACV,0CACF,EAGF+d,EAAG,IAAI,KAAM,CAACU,EAAe,CAAC,EAC3BV,EAAA,QAAQqC,GAAyB,KAAK,GAAG,EAAG9D,GAC7CA,EAAS,IAAI,IAAI,CACnB,EAEJ,CApCagE,GAqBMjS,EAAwB,KAiBpC,SAASmS,GACdC,EACoC,CACpC,OAAOJ,MAAwBI,CACjC,CCrDO,MAAMC,WAAyBJ,EAAe,CAWnD,YAAYC,EAAc,CACxB,MAAMA,CAAK,EAPI,cAAW5S,GAAO,EAAK,EAEvB,cAAWA,GAAO,EAAK,EAE/B,eAAY,IAAIoK,GAUzB,KAAiB,0BAA4B,IAAM,CAC3C,MAAA4I,EAAU,KAAK,SAAS,QAAQ,EAChCC,EAAU,KAAK,SAAS,QAAQ,EAClC,KAAK,SAAS,KAAK,IAAMD,IAC3B,KAAK,SAAS,MAAQA,GAEpB,KAAK,SAAS,KAAK,IAAMC,IAC3B,KAAK,SAAS,MAAQA,EAE1B,EA8BA,KAAiB,iBAAmB,IAAM,CACxC,KAAK,0BAA0B,EAC/B,KAAK,UAAU,KAAK,CACtB,EA/CO,cAAW,IAAInS,GAAc,CAAC,KAAK,MAAM,IAAI,OAAO,EAAG,CAC1D,mBAAoB,IAAI,CAAC,KAAK,MAAM,IAAI,SAAS,QAAQ,CAAC,EAC3D,EAcH,IAAI,SAAU,CACL,YAAK,SAAS,KAAK,EAG5B,IAAI,SAAU,CACL,YAAK,SAAS,KAAK,EAG5B,IAAI,UAAW,CACb,OAAO,KAAK,SAGd,IAAI,UAAW,CACb,OAAO,KAAK,SAGd,IAAI,aAAc,CAChB,OAAO,KAAK,SAGL,QAAS,CAChB,KAAK,0BAA0B,EAC/B,KAAK,SAAS,GAAG,gBAAiB,KAAK,gBAAgB,EACvD,KAAK,SAAS,GAAG,mBAAoB,KAAK,gBAAgB,EAC1D,KAAK,SAAS,GAAG,oBAAqB,KAAK,gBAAgB,EAC3D,KAAK,SAAS,GAAG,qBAAsB,KAAK,gBAAgB,EAQrD,UAAW,CAClB,MAAM,SAAS,EACf,KAAK,SAAS,IAAI,gBAAiB,KAAK,gBAAgB,EACxD,KAAK,SAAS,IAAI,mBAAoB,KAAK,gBAAgB,EAC3D,KAAK,SAAS,IAAI,oBAAqB,KAAK,gBAAgB,EAC5D,KAAK,SAAS,IAAI,qBAAsB,KAAK,gBAAgB,EAC7D,KAAK,UAAU,SAAS,EAE5B,CAvEaiS,GACc,IAAM,UCHpB,MAAAG,GACXhF,GAAkC,aAAa,EAE1C,SAASiF,GACdtG,EACe,CACR,OACL,MAAauD,GAAA,CACRA,EAAA,QACD8C,GAAsBrG,EAAY,MAAM,OAAO,EAC/C,IAAMA,CACR,EAEJ,CACF,CCXO,MAAeuG,EAAc,CASlC,IAAI,OAAgB,CAClB,OAAQ,KAAK,YAAqC,MAGpD,IAAI,MAAe,CACjB,OAAQ,KAAK,YAAqC,KAGpD,YAAY,CAAE,QAAAC,GAAiC,CAC7C,KAAK,QAAUA,CAAA,CAGjB,OAAO,SAASxe,EAA2C,CACzD,MAAM,IAAItC,EACRF,EAAU,eACV,+BACF,EAKF,GACEuT,EAC6D,CACtD,YAAK,OAASA,EAAK,KAI9B,CArCsBwN,GAKJ,YAAuB,GCR5B,MAAAE,GACXpF,GAAuC,WAAW,EAE7C,SAASqF,GACdC,EACe,CACR,OACL,MAAapD,GAAA,CACXA,EAAG,QAAQkD,GAAoBE,EAAc,IAAI,EAAG,IAAMA,CAAa,EAE3E,CACF,wLCXO,MAAMC,GAAsB,IAC1BC,GAAkB,EAGdC,GAAsB,IAC1BC,GAAgB,EAAE,ECCpB,MAAMC,WAAgClB,EAAe,CAArD,kCAGL,KAAiB,IAAM,GAAG,KAAK,MAAM,EAAE,IAAIgB,IAAQ,GACnD,KAAQ,uBAA+D,CAAC,EACvD,iBAAc3T,GAAwB,EAAE,EACzD,KAAiB,kBAAoBA,OAC/B,GACN,EAEiB,gBAAcQ,GAAoC,CACjEA,EAAM,UAAU,KAAK,IAAI,kBAAmB,KAAK,YAAY,KAAK,CACpE,EAEiB,iBAAeA,GAAoC,CAClE,MAAMsT,EAAYtT,EAAM,UAAU,KAAK,IAAI,iBAAiB,EACxDsT,GACF,KAAK,IAAIA,CAA4B,CAEzC,EAEiB,sBAAoBC,GAAkC,CACrE,MAAMC,EAAO,KAAK,uBAAuBD,EAAK,IAAc,EAC5D,GAAI,CAACC,EACH,MAAM,IAAIzhB,EACRF,EAAU,eACV,2BAA2B0hB,EAAK,IAAI,EACtC,EAEK,OAAAC,EAAK,SAASD,CAAI,CAC3B,EAEQ,YACN,QAAS,IAAI3J,GACb,cAAe,IAAIA,EACrB,EAES,QAAS,CAChB,KAAK,MAAM,SAAS,OAAOkJ,EAAmB,EAAE,QAAgBU,GAAA,CAC9D,CAACA,CAAI,EAAE,KAAO,UAAQA,GAAQ,CACvB,4BAAuBA,EAAK,IAAI,EAAIA,CAAA,CAC1C,EACF,EAEI,WAAM,eAAe,UAAU,GAClC,SACClP,GAAsE,CAC/D,MAAAmP,EAAMnP,EAAO,QAAQ,OAAOA,EAAO,KAAK,EAAE,OAAOA,EAAO,OAAO,EAC/DoP,EAAgB,KAAK,MAAM,eAAe,UAAU,SAItD,GAHgBD,EAAI,OAAO/J,GAAMA,IAAOgK,CAAa,EAGzC,OAAS,EAAG,CACpB,MAAAzS,MAAU,IAChB,KAAK,MAAM,eAAe,YAAY,QAAQ,CAAC0S,EAAOjK,IAAO,CAC3D,GAAIA,IAAO,KAAK,MAAM,eAAe,UAAU,SAAU,OAMnD,MAAAkK,EAJY,OAAO,QAAQD,EAAM,WAAW,EAC/C,OAAO,CAAC,CAAC/P,CAAG,IAAMA,EAAI,WAAW,KAAK,MAAM,EAAE,CAAC,EAC/C,QAAQ,CAAC,CAACvP,EAAGif,CAAS,IAAMA,CAAS,EAGrC,IAAYC,GAAA,CACP,IACK,YAAK,iBAAiBA,CAAI,QAC1BnhB,EAAO,CACN,qBACN,iCACAsX,EACA6J,EACAnhB,CACF,EACO,KAEV,GACA,OAAQyhB,GAA8B,CAAC,CAACA,CAAG,EAE1C5S,EAAA,IAAIyI,EAAIkK,CAAU,EACvB,EACD,KAAK,kBAAkB,MAAQ3S,EAC1B,WAAM,cAAc,KAAKA,CAAG,EACnC,CAEJ,EAEA,KAAK,MAAM,QAAQ,YAAY,GAAG,mBAAoB,KAAK,UAAU,EACrE,KAAK,MAAM,QAAQ,YAAY,GAAG,oBAAqB,KAAK,WAAW,EAGhE,UAAW,CAClB,MAAM,SAAS,EACf,KAAK,MAAM,QAAQ,YAAY,IAAI,mBAAoB,KAAK,UAAU,EACtE,KAAK,MAAM,QAAQ,YAAY,IAAI,oBAAqB,KAAK,WAAW,EAG1E,IAAI,OAAQ,CACV,OAAO,KAAK,YAAY,MAG1B,IAAI,kBAAmB,CACrB,OAAO,KAAK,kBAAkB,MAGhC,MAAM6S,EAAkB,CACtB,GAAIA,EAAO,CACH,MAAAC,EAAS,KAAK,MAAM,OACXT,GAAA,CAACQ,EAAM,SAASR,EAAU,IAAI,CAC7C,EACA,KAAK,IAAIS,CAAM,OAEV,SAAI,EAAE,CACb,CAGF,OACEC,KACG9D,EACc,CACV,WAAI8D,EAAK,GAAG9D,CAAI,EAGzB,SAAS+D,EAAe,CACtB,OAAO,KAAK,MAAM,OAAY,KAAE,QAAUA,CAAK,EAGjD,OAAuC7O,EAAS,CACvC,YAAK,QAAQA,CAAI,EAAE,MAG5B,QAAwCA,EAAS,CACxC,OAAAqE,GAAS,IACd,KAAK,MAAM,OAAQoK,GAAgCA,EAAI,GAAGzO,CAAI,CAAC,CACjE,EAGF,KAAqCA,EAAS,CACrC,YAAK,MAAMA,CAAI,EAAE,MAG1B,MAAsCA,EAAS,CACtC,OAAAqE,GAAS,IACd,KAAK,MAAM,KAAMoK,GAAgCA,EAAI,GAAGzO,CAAI,CAAC,CAC/D,EAGF,IAAIwO,EAA6B,CAC/B,KAAK,MAAM,eAAe,kBACxB,KAAK,IACLA,EAAW,IAAS,KAAE,OAAQ,EAChC,EACA,KAAK,YAAY,MAAQA,EACpB,WAAM,QAAQ,KAAKA,CAAU,EAGpC,SAASK,EAAeL,EAA6B,CACnD,MAAMvO,EAAU,KAAK,MAAM,OAAYvR,KAAE,QAAUmgB,CAAK,EACxD,KAAK,IAAI,CAAC,GAAG5O,EAAS,GAAGuO,CAAU,CAAC,EAMtC,aAAc,CACZ,KAAK,MAAM,eAAe,kBAAkB,KAAK,IAAK,EAAE,EAG1D,OAAOpT,EAA6D,CAC5D,MAAAoT,EAAapT,EAAG,KAAK,KAAK,EAChC,KAAK,IAAIoT,CAAU,EAGrB,SAASL,EAAiC,CACxC,MAAMK,EAAaL,EAAK,IAAIA,GACnB,KAAK,iBAAiBA,CAAI,CAClC,EACM,YAAK,IAAIK,CAAU,EAE9B,CAjLaP,GACc,IAAM,YCyBpB,MAAAa,GAAgBxG,GAAsB,WAAW;;qyECnCvD,MAAMyG,WAA4BpiB,CAAgB,CACvD,YAAY6Y,EAAiB3Y,EAAiB,CAC5C,MACEJ,EAAU,oBACV,sBAAsB+Y,CAAO,KAAK3Y,CAAO,EAC3C,EAEJ,CCCO,MAAMmiB,EAAO,CAAb,cAII,0BAAuB,IAWjB,mBACbxJ,EACAyJ,EACAC,IACY,CACR,IACG,qBAAS1J,EAASyJ,EAAeC,CAAa,EAC5C,EACD,OACC,SAEX,EAqBW,eACT1J,EACAyJ,EACAC,IACS,CACT,MAAMrJ,EAAS,KAAK,iBAAiB,IAAIL,CAAO,EAChD,GAAI,CAACK,EACG,UAAIkJ,GAAoBvJ,EAASnK,EAAwB,EAGjE,MAAM8T,EAAmB,IAAM,CAC7BD,GAAe,QAAwBE,GAAA,CACrC,MAAMC,EAAc,KAAK,iBAAiB,IAAID,CAAY,EAC1D,GAAI,CAACC,EACG,UAAIN,GAAoBK,EAAc/T,EAAwB,EAEjE,oBAAegU,EAAaxJ,CAAM,EACzC,CACF,EAEI,GAAAA,EAAO,MAAM,OAAS,OAAQ,CAChC,GAAIoJ,EACF,MAAM,IAAIF,GACRlJ,EAAO,MAAM,QACb,gCACF,EAGesJ,EAAA,EACjB,OAGF,GAAI,CAACF,EACH,MAAM,IAAIF,GACRlJ,EAAO,MAAM,QACb,mCACF,EAGF,MAAMyJ,EAAe,KAAK,iBAAiB,IAAIL,CAAa,EAC5D,GAAI,CAACK,EACG,UAAIP,GAAoBE,EAAe5T,EAAwB,EAElE,oBAAewK,EAAQyJ,CAAY,EACvBH,EAAA,CACnB,EA1DA,IAAI3J,EAAiB,CACZ,YAAK,iBAAiB,IAAIA,CAAO,EA8D1C,IAAI,UAAW,CACb,OAAO,OAAO,YACZ,MAAM,KAAK,KAAK,iBAAiB,QAAQ,EAAE,IACxCK,GAA6B,CAACA,EAAO,MAAM,QAASA,EAAO,OAAO,EAEvE,EAUM,cAAcuJ,EAAsBH,EAAuB,CACjE,OACEM,GAAUH,EAAcH,CAAa,GACrCM,GAAUN,EAAeG,CAAY,EAajC,oBACNI,EACAC,EACAC,EACAC,EACS,CAEH,MAAAC,EAAcJ,EAAW,WAAW,GAAG,EACvCK,EAAeJ,EAAY,WAAW,GAAG,EAG/C,OAAIG,GAAeC,EACVL,IAAeC,EAGpBG,EACKJ,IAAe,IAAIG,CAAU,GAGlCE,EACKJ,IAAgB,IAAIC,CAAS,GAG/B,KAAK,cAAcF,EAAYC,CAAW,EAU3C,gBACNK,EACAnP,EACS,CACH,MAAAoP,EAAgBD,EAAM,MAAM,QAC5BE,EAAiBrP,EAAO,MAAM,QAC9BsP,EAAaH,EAAM,MAAM,KACzBI,EAAcvP,EAAO,MAAM,KAE3BwP,EAA0BL,EAAM,MAAM,QAAU,CAAC,GAAG,EAGnD,OAF0BnP,EAAO,MAAM,UAAY,CAAC,GAAG,GAE9B,KAAKyP,GAC5BD,EAAwB,KAAKA,GAEhCC,IAA6B,KAC7BD,IAA4B,IAErB,GAGLC,IAA6B,IACxB,KAAK,oBACVD,EACAH,EACAC,EACAC,CACF,EAGEC,IAA4B,IACvB,KAAK,oBACVJ,EACAK,EACAH,EACAC,CACF,EAIA,KAAK,oBACHH,EACAK,EACAH,EACAC,IAEF,KAAK,oBACHC,EACAH,EACAC,EACAC,CACF,CAEH,CACF,EAWK,cAAcJ,EAAwBnP,EAAyB,CAC/D,MAAA+O,EAAYI,EAAM,MAAM,KACxBV,EAAeU,EAAM,MAAM,QAC3Bb,EAAgBtO,EAAO,MAAM,QAEnC,GAAI+O,IAAc,OAChB,MAAM,IAAIX,GACRK,EACA,kCAAkCH,CAAa,GACjD,CACF,CAUF,QAAQa,EAAenP,EAAgB,CACrC,MAAM0O,EAAc,KAAK,iBAAiB,IAAIS,CAAK,EAC7CR,EAAe,KAAK,iBAAiB,IAAI3O,CAAM,EACjD,IAAC0O,GAAe,CAACC,EACZ,SAEL,IACG,2BAAeD,EAAaC,CAAY,EACtC,EACD,OACC,SACT,CASF,SAASrI,EAAgC,CACvC,OAAAA,EAAY,QAAkBpB,GAAA,CAC5Bb,GAAY,MAAMa,CAAM,EACxB,KAAK,iBAAiB,IAAIA,EAAO,MAAM,QAASA,CAAM,EACvD,EACM,KAQT,QAAS,CACP,OAAO,OAAO,YACZ,MAAM,KAAK,KAAK,iBAAiB,QAAQ,EAAE,IACxCA,GAA8C,CAC7CA,EAAO,MAAM,QACb,CACE,KAAMA,EAAO,MAAM,KACnB,OAAQA,EAAO,MAAM,OACrB,SAAUA,EAAO,MAAM,SACzB,CACF,CAEJ,EAWF,eAAeiK,EAAwBnP,EAAyB,CAK9D,GAJK,mBAAcmP,EAAOnP,CAAM,EAI5B,CAFyB,KAAK,gBAAgBmP,EAAOnP,CAAM,EAG7D,MAAM,IAAIoO,GACRe,EAAM,MAAM,QACZ,6BAA6BnP,EAAO,MAAM,OAAO,GACnD,CACF,CAEJ,+kCC3TA,SAAS0P,GAAwBC,EAAoBvJ,EAAc,CATnE,IAAAjM,EAUE,IAAI5L,EAAI,EACF,MAAAqhB,GAAMzV,IAAK,MAAM,GAAG,EAAE,GAAG,EAAE,IAArB,KAA0BA,EAAA,GACtC,IAAI0V,EAAUzJ,EAAK,QAAQ,IAAI,OAAO,IAAIwJ,CAAG,GAAG,EAAG,KAAKrhB,CAAC,KAAKqhB,CAAG,EAAE,EAC5D,KAAAD,EAAM,IAAIE,CAAO,GACtBA,EAAUzJ,EAAK,QAAQ,IAAI,OAAO,IAAIwJ,CAAG,GAAG,EAAG,KAAKrhB,CAAC,KAAKqhB,CAAG,EAAE,EAC/DrhB,IAEK,OAAAshB,CACT,CAEO,MAAMC,EAAc,CAmBzB,YAAY3jB,EAA8B,CAjBjC,4BAAyB,IASjB,oBAAiB,IAIjB,gBAAa,IAEb,wBAAqB,IAGpC,KAAK,MAAQA,EAAQ,KAGvB,SAAU,CACR,KAAK,WAAW,MAAM,EACtB,KAAK,OAAO,MAAM,EAGpB,WAAY,CACV,OAAO,KAAK,WAGd,kBAAmB,CACjB,OAAO,KAAK,eAGd,SAAU,CACD,YAAK,WAAW,OAAS,EAGlC,MAAM,aAAa4jB,EAAgB,CACjC,GAAI,KAAK,WAAW,IAAIA,CAAM,EAAG,OACjC,MAAMC,EAAO,MAAM,KAAK,MAAM,IAAID,CAAM,EACxC,GAAI,CAACC,EAAM,CACD,cAAM,QAAQD,CAAM,4BAA4B,EACxD,OAEF,GAAIC,aAAgB,KAAM,CACxB,IAAIC,EAAOD,EACX,GAAI,KAAK,OAAO,IAAIA,EAAK,IAAI,EAAG,CAC9B,MAAMH,EAAUH,GAAwB,KAAK,OAAQM,EAAK,IAAI,EACvDC,EAAA,IAAI,KAAK,CAACD,CAAI,EAAGH,EAAS,CAAE,KAAMG,EAAK,KAAM,EAEjD,gBAAW,IAAID,EAAQE,CAAI,EAC3B,YAAO,IAAIA,EAAK,IAAI,EACzB,OAEF,GAAID,EAAK,MAAQA,EAAK,OAAS,2BAA4B,CACpD,gBAAW,IAAID,EAAQC,CAAI,EAChC,OAGI,MAAAE,EAAS,MAAMF,EAAK,YAAY,EAEhCG,EAAW,MADA,MAAMC,GAAA,WAAO,oBAAW,2BACT,mBAAmBF,CAAM,EACzD,GAAIC,EAAU,CACN,MAAAF,EAAO,IAAI,KAAK,CAACD,CAAI,EAAG,GAAI,CAAE,KAAMG,EAAS,KAAM,EACpD,gBAAW,IAAIJ,EAAQE,CAAI,EAChC,OAEG,gBAAW,IAAIF,EAAQC,CAAI,EAGlC,MAAM,YAAYD,EAAgB,CAChC,MAAMC,EAAO,KAAK,WAAW,IAAID,CAAM,EACvC,GAAI,CAACC,EACH,MAAM,IAAIhkB,EACRF,EAAU,iBACV,QAAQikB,CAAM,8BAChB,EAGF,MAAM,KAAK,MAAM,IAAIA,EAAQC,CAAI,EAErC,CCnGO,SAASK,GAAOhhB,EAAyB,CAC9C,OAAIA,aAAiB+L,GACZ,CACL,CAACR,EAAsB,EAAG,GAC1B,MAAOvL,EAAM,SAAS,CACxB,EAEEA,aAAiBuM,GACZ,CACL,CAACjB,EAAoB,EAAG,GACxB,MAAOtL,EAAM,MAAM,QAAQ,CAC7B,EAEE,MAAM,QAAQA,CAAK,EACdA,EAAM,IAAIghB,EAAM,EAErB/U,GAAajM,CAAK,EACb,OAAO,YACZ,OAAO,QAAQA,CAAK,EAAE,IAAI,CAAC,CAACwO,EAAKxO,CAAK,IAC7B,CAACwO,EAAKwS,GAAOhhB,CAAK,CAAC,CAC3B,CACH,EAEKA,CACT,CAEO,SAASihB,GAASjhB,EAAyB,CAC5C,aAAM,QAAQA,CAAK,EACdA,EAAM,IAAIihB,EAAQ,EAEvB,OAAOjhB,GAAU,UAAYA,GAAS,KACpC,QAAQ,IAAIA,EAAOuL,EAAsB,EACpC,IAAIQ,GAAM,QAAQ,IAAI/L,EAAO,OAAO,CAAC,EAE1C,QAAQ,IAAIA,EAAOsL,EAAoB,EAClC,IAAIiB,GAAK,QAAQ,IAAIvM,EAAO,OAAO,CAAC,EAEtC,OAAO,YACZ,OAAO,QAAQA,CAAK,EAAE,IAAI,CAAC,CAACwO,EAAKxO,CAAK,IAC7B,CAACwO,EAAKyS,GAASjhB,CAAK,CAAC,CAC7B,CACH,EAGKA,CACT,CCjBO,MAAMkhB,EAAoD,CA0B/D,YAA4BC,EAA0C,CAA1C,wBAAAA,EAzB5B,KAAU,UAAgCpM,EAAA,CAEhC,mBAAmBqM,EAAoC,CAC/D,OAAO,OAAO,YACZ,OAAO,QAAQA,CAAS,EAAE,IAAI,CAAC,CAAC5S,EAAKxO,CAAK,IACjC,CAACwO,EAAKyS,GAASjhB,CAAK,CAAC,CAC7B,CACH,EAGQ,iBAAiBmW,EAAgC,CACrD,IAAAkL,EACJ,OAAIlL,aAAiB/B,GACnBiN,EAAanK,GAAaf,CAAK,EAElBkL,EAAAlL,EAER,OAAO,YACZkL,EAAW,KAAK,IAAW7S,GAAA,CACnB,MAAAxO,EAAQqhB,EAAW,MAAM7S,CAAoC,EACnE,MAAO,CAACA,EAAKwS,GAAOhhB,CAAK,CAAC,CAC3B,EACH,EAKF,aAAa,CACX,KAAAme,CAAA,EAC0E,CAC1E,KAAM,CAAE,QAAA3I,EAAS,GAAAlB,EAAI,QAAA0B,EAAS,MAAOsL,GAAWnD,EAE1C1I,EAAQ,KAAK,mBAAmB6L,CAAM,EAErC,OACL,GAAAhN,EACA,QAAAkB,EACA,QAASQ,GAAW,GACpB,MAAAP,CACF,EAGF,WAAW,CAAE,MAAAU,GAAsD,CACjE,KAAM,CAAE,GAAA7B,EAAI,QAAAkB,EAAS,QAAAQ,CAAY,EAAAG,EAE3BV,EAAQ,KAAK,iBAAiBU,CAAK,EAElC,OACL,GAAA7B,EACA,QAAAkB,EACA,QAAAQ,EACA,MAAAP,CACF,EAEJ,CC3EO,MAAM8L,EAAM,CAajB,YAAqB5S,EAAiB,CAAjB,UAAAA,CAAA,CAZrB,IAAI,SAAU,CACZ,OAAO,KAAK,KAAK,QAGnB,IAAI,OAAQ,CACV,OAAO,KAAK,KAAK,OAGnB,IAAI,aAAc,CAChB,OAAO,KAAK,KAAK,YAKnB,OAAO,WAAWhE,EAAY6W,EAAqC,CAC3D,MAAAC,EAAcD,EAAO,IAAarL,GAClCA,aAAiB/B,GACZ8C,GAAaf,CAAK,EAEpBA,CACR,EACD,OAAO,IAAIoL,GAAM,CACf,QAASE,EACT,YAAa9W,EAAI,UAAU,GAC3B,OAAQA,EAAI,GACb,EAEL,CC3Ba,MAAA+W,GAAgDvV,GAAS,CACpE,KAAMC,GAAU,OAAO,EACvB,GAAIC,GAAS,EACb,QAASA,GAAS,EAClB,QAAS4I,GAAS,EAAE,SAAS,EAC7B,MAAOI,GAASsM,IAAW,EAC3B,SAAUC,GAAO,IAAMF,GAAoB,MAAO,EACpD,CAAC,EASYG,GAAgD1V,GAAS,CACpE,KAAMC,GAAU,OAAO,EACvB,QAASsV,GAAoB,MAAM,EACnC,YAAarV,GAAS,EACtB,OAAQA,GAAS,CACnB,CAAC,EAcKyV,GAAgB3V,GAAS,CAC7B,GAAIE,GAAS,EACb,MAAOA,GAAS,EAChB,WAAY4I,GAAS,EACrB,KAAML,GAAQvI,GAAU,EAC1B,CAAC,EAEY0V,GAA4C5V,GAAS,CAChE,KAAMC,GAAU,MAAM,EACtB,KAAM0V,GACN,OAAQJ,EACV,CAAC,ECHKM,GAAa,IAEZ,MAAMC,EAAY,CA6SvB,YAAY,CACV,SAAAC,EACA,OAAArM,EACA,QAAAsM,EACA,YAAAC,EAAc,EAAC,EACM,CAjTN,yBAAsB,IAEtB,6BAA0B,IAQ1B,kBAAgC,IAAIhG,GAErD,KAAiB,OAA2B,CAC1C,aAAc,IAAI5H,GAClB,YAAa,IAAIA,GACjB,aAAc,IAAIA,GAClB,YAAa,IAAIA,EACnB,EAEA,qBACE2B,GAC8B,CAC1B,IACF,MAAMkL,EACJlL,aAAiB/B,GAAa8C,GAAaf,CAAK,EAAIA,EAEhDkM,EAAW,KAAK,iBAAiBhB,CAAU,EAEjD,OAAKgB,GAILX,GAAoB,MAAMW,CAAQ,EAE3BA,GALL,aAMKrlB,EAAO,CACd,QAAQ,MAAM,4CAA4C,EAC1D,QAAQ,MAAMA,CAAK,EACnB,OAEJ,EAEA,mBAAiB2N,GAAwC,CACnD,IACG,YAAO,aAAa,KAAK,CAC5B,KAAM,OACN,KAAMA,CAAA,CACP,EACD,MAAM2X,EAAY3X,EAAI,KAChB4X,EAAO,KAAK,eAAe5X,CAAG,EACpC,GAAI,CAAC2X,EACH,MAAM,IAAI3lB,EACRF,EAAU,iBACV,6BACF,EAEF,MAAM+lB,EAAS,KAAK,gBAAgBtL,GAAaoL,CAAS,CAAC,EAC3D,GAAI,CAACE,EACH,OAEF,MAAMC,EAA2B,CAC/B,KAAM,OACN,KAAAF,EACA,OAAAC,CACF,EACK,mBAAO,YAAY,KAAK,CAC3B,KAAM,OACN,KAAM7X,EACN,SAAU8X,CAAA,CACX,EACDV,GAAkB,MAAMU,CAAW,EAE5BA,QACAzlB,EAAO,CACd,QAAQ,MAAM,0CAA0C,EACxD,QAAQ,MAAMA,CAAK,EACnB,OAEJ,EAEA,qBAAmB0lB,GAA4C,CACzD,IACG,YAAO,aAAa,KAAK,CAC5B,KAAM,QACN,MAAAA,CAAA,CACD,EACD,KAAM,CAAE,QAAA3V,EAAS,OAAA4V,EAAQ,YAAAC,GAAgBF,EAAM,KACzCG,EAAkB,CAAC,EACzB,UAAWtO,KAASxH,EAAS,CACrB,MAAA+V,EAAgB,KAAK,gBAAgBvO,CAAK,EAChD,GAAI,CAACuO,EACH,OAEFD,EAAgB,KAAKC,CAAa,EAEpC,MAAMT,EAA0B,CAC9B,KAAM,QACN,YAAAO,EACA,OAAAD,EACA,QAASE,CACX,EACK,mBAAO,YAAY,KAAK,CAC3B,KAAM,QACN,MAAAH,EACA,SAAAL,CAAA,CACD,EACDR,GAAoB,MAAMQ,CAAQ,EAE3BA,QACArlB,EAAO,CACd,QAAQ,MAAM,4CAA4C,EAC1D,QAAQ,MAAMA,CAAK,EACnB,OAEJ,EAEA,qBAAkB,MAChBqlB,EACA1X,EACAgG,EACA9D,IACoC,CAChC,IACF6U,GAAoB,MAAMW,CAAQ,EAClC,MAAMlM,EAAQ,MAAM,KAAK,iBAAiBkM,EAAU1X,EAAKgG,EAAQ9D,CAAK,EACtE,OAAKsJ,GAAO,aAELnZ,EAAO,CACd,QAAQ,MAAM,4CAA4C,EAC1D,QAAQ,MAAMA,CAAK,EACnB,OAEJ,EAEA,mBAAgB,MAAOqlB,GAAsD,CACvE,IACG,YAAO,aAAa,KAAK,CAC5B,KAAM,OACN,SAAAA,CAAA,CACD,EACDN,GAAkB,MAAMM,CAAQ,EAC1B,MAAE,KAAAE,EAAM,OAAAC,CAAA,EAAWH,EACnB1X,EAAM,KAAK,QAAQ,OAAO4X,EAAK,EAAE,EACvC,OAAA5X,EAAI,KAAK,EACH,WAAK,gBAAgB6X,EAAQ7X,CAAG,EACjC,YAAO,YAAY,KAAK,CAC3B,KAAM,OACN,SAAA0X,EACA,KAAM1X,CAAA,CACP,EAEMA,QACA3N,EAAO,CACd,QAAQ,MAAM,0CAA0C,EACxD,QAAQ,MAAMA,CAAK,EACnB,OAEJ,EAEA,yBAAsB,MAAOqlB,GAA4B,CACnD,IACF,KAAM,CAAE,SAAAjL,EAAU,QAAA5B,EAAS,MAAAC,EAAO,GAAAnB,CAAO,EAAA+N,EAEnCxM,EAAS,KAAK,WAAWL,CAAO,EAChCuN,EAAe,CACnB,GAAAzO,EACA,QAAAkB,EACA,MAAAC,CACF,EAQO,OANW,MADE,KAAK,gBAAgBI,CAAM,EACX,aAAa,CAC/C,KAAMkN,EACN,OAAQ,KAAK,eACb,SAAA3L,CAAA,CACD,QAGMpa,EAAO,CACd,QAAQ,MAAM,iDAAiD,EAC/D,QAAQ,MAAMA,CAAK,EACnB,OAEJ,EAEA,qBAAkB,MAChBqlB,EACA1X,EACAgG,EACA9D,IAC+B,CAzPnC,IAAA/B,EA0PQ,IACF+W,GAAoB,MAAMQ,CAAQ,EAE7B,YAAO,aAAa,KAAK,CAC5B,KAAM,QACN,SAAAA,CAAA,CACD,EAED,KAAM,CAAE,QAAAtV,EAAS,YAAA6V,EAAa,OAAAD,CAAW,EAAAN,EAGnCW,EAAiC,CACrC,GAAI,iBACJ,QAAS,cACT,MAAO,CAAC,EACR,KAAM,QACN,SAAUjW,CACZ,EAEA,UAAWwH,KAASxH,EACb,+BAA0BwH,EAAO5D,EAAQ9D,CAAK,EAErD,MAAMoW,EAAgC,CAAC,EACvC,KAAK,iBAAiBD,EAAiBC,EAAetS,EAAQ9D,CAAK,EAEnE,MAAMqW,EAAY,MAAM,KAAK,sBAAsBD,CAAa,EAC1DE,EAAQpW,EAAQ,CAAC,EAGvB,GAAIoW,GAASxY,EAAI,SAASwY,EAAM,EAAE,EAAG,CAE7B,MAAA3B,EAASzU,EACZ,IAAUwH,GAAA,CA1RrBzJ,MA0RwB,OAAAA,EAAAH,EAAI,SAAS4J,EAAM,EAAE,IAArB,YAAAzJ,EAAwB,MAAK,EAC1C,OAAO,OAAO,EACXsY,EAAczS,GAAS7F,EAAAH,EAAI,SAASgG,CAAM,IAAnB,cAAsB,MAAQ,OAC3D,GAAI,CAACyS,EACH,MAAM,IAAIzmB,EACRF,EAAU,iBACV,iDACF,EAEF,MAAM4mB,EACJxW,IAAU,OAAYuW,EAAY,SAASvW,CAAK,EAAI,KAClDlC,EAAA,WAAW6W,EAAQ4B,EAAaC,CAAa,OAEjD,MAAM,KAAK,iBAAiBH,EAAU,SAAUvY,EAAKgG,EAAQ9D,CAAK,EAG9D,MAAAyW,EAAgBJ,EAAU,SAC7B,OAAYvY,EAAI,aAAa4Y,EAAK,MAAM,EAAE,CAAC,EAC3C,OAAQjmB,GAAuBA,IAAM,IAAI,EACzC,IAAI6Y,GAASe,GAAaf,CAAK,CAAC,EAE7BuM,EAAQ,IAAInB,GAAM,CACtB,QAAS+B,EACT,YAAAV,EACA,OAAAD,CAAA,CACD,EAEI,mBAAO,YAAY,KAAK,CAC3B,KAAM,QACN,SAAAN,EACA,MAAAK,CAAA,CACD,EAEMA,QACA1lB,EAAO,CACd,QAAQ,MAAM,4CAA4C,EAC1D,QAAQ,MAAMA,CAAK,EACnB,OAEJ,EAEO,WAACqlB,EAAuBzV,IAA6C,CACpE,MAAA4W,EAAQjP,GAAyB,CACjC,IACF3H,EAAS2H,CAAK,QACPvX,EAAO,CACd,QAAQ,MAAM,8BAA8B,EAC5C,QAAQ,MAAMA,CAAK,EAGjBuX,EAAM,UACFA,EAAA,SAAS,QAAQiP,CAAI,CAE/B,EAEAA,EAAKnB,EAAS,MAAM,CACtB,EA4BE,KAAK,eAAiB,IAAI5B,GAAc,CAAE,KAAMyB,EAAU,EAC1D,KAAK,QAAUrM,EACf,KAAK,SAAWsM,EAEhBC,EAAY,QAAsBqB,GAAA,CAChC,MAAMC,EAAUD,EAAW,CACzB,MAAO,KAAK,OACZ,QAAS,KAAK,SACd,cAAe,KAAK,eACpB,eAAgB,KAAK,gBACrB,mBAAoB,KAAK,oBAC1B,EACGC,GACG,kBAAa,IAAIA,CAAO,CAC/B,CACD,EAzCH,IAAI,gBAAiB,CACnB,OAAO,KAAK,gBAGd,IAAI,QAAS,CACJ,YAAK,eAAe,UAAU,EAGvC,IAAI,eAAgB,CAClB,OAAO,KAAK,eAGd,IAAI,QAAS,CACX,OAAO,KAAK,QAGd,IAAI,SAAU,CACZ,OAAO,KAAK,SA2BN,iBAAiBvN,EAAyC,CAC3D,YAAO,aAAa,KAAK,CAC5B,KAAM,QACN,MAAAA,CAAA,CACD,EAED,MAAMN,EAAS,KAAK,WAAWM,EAAM,OAAO,EAEtC4M,EADc,KAAK,gBAAgBlN,CAAM,EACd,WAAW,CAC1C,MAAAM,EACA,OAAQ,KAAK,eACd,EACKiB,EAAWjB,EAAM,SACpB,IAAa2J,GACL,KAAK,iBAAiBA,CAAK,CACnC,EACA,OAAO,OAAO,EACXuC,EAA0B,CAC9B,KAAM,QACN,GAAGU,EACH,SAAA3L,CACF,EACK,mBAAO,YAAY,KAAK,CAC3B,KAAM,QACN,MAAAjB,EACA,SAAAkM,CAAA,CACD,EAEMA,CAAA,CAGT,MAAc,sBAAsBY,EAA+B,CAGjE,MAAMxB,EAAc,CAAC,EACrB,UAAWkC,KAAQV,EAAe,CAChC,MAAMW,EAAQ,MAAM,KAAK,6BAA6BD,CAAI,EACtDC,IACIA,EAAA,GAAKD,EAAK,SAAS,IAE3BlC,EAAY,KAAK,CACf,MAAAmC,EACA,SAAUD,EAAK,SACf,SAAUA,EAAK,SACf,MAAOA,EAAK,MACb,EAIH,MAAME,EAAmBpC,EAAY,UAAe,CAAC,CAACpT,EAAK,KAAK,EASzD,OADW,KAAK,kBAAkBwV,CAAgB,CAClD,CAGT,MAAc,6BACZF,EACiC,CAC7B,IACF,KAAM,CAAE,SAAAvM,EAAU,QAAA5B,CAAQ,EAAImO,EAAK,SAC7B9N,EAAS,KAAK,WAAWL,CAAO,EAChCI,EAAc,KAAK,gBAAgBC,CAAM,EACzC,CAAE,MAAAJ,CAAA,EAAU,MAAMG,EAAY,aAAa,CAC/C,KAAM,CACJ,GAAI+N,EAAK,SAAS,GAClB,QAASA,EAAK,SAAS,QACvB,MAAOA,EAAK,SAAS,KACvB,EACA,OAAQ,KAAK,eACb,SAAAvM,CAAA,CACD,EAEM,OACL,GAAIuM,EAAK,SAAS,GAClB,QAASA,EAAK,SAAS,QACvB,SAAU,CAAC,EACX,MAAAlO,CACF,QACOzY,EAAO,CACd,QAAQ,MAAM,iDAAiD,EAC/D,QAAQ,MAAMA,CAAK,EACnB,OACF,CAGM,eAAe2N,EAAiC,CACtD,MAAMmZ,EAAUnZ,EAAI,KAEpB,GAAI,CAACmZ,EACH,MAAM,IAAInnB,EACRF,EAAU,iBACV,oBACF,EAEK,OACL,GAAIqnB,EAAQ,GACZ,MAAOA,EAAQ,MACf,WAAYA,EAAQ,WACpB,KAAM,EACR,EAGM,iBACNzB,EACAY,EACAc,EACAlX,EACA,CACAoW,EAAc,KAAK,CAAE,SAAAZ,EAAU,SAAA0B,EAAU,MAAAlX,EAAO,EAC5CwV,EAAS,UACXA,EAAS,SAAS,QAAQ,CAACvC,EAAOkE,IAAQ,CACxC,KAAK,iBAAiBlE,EAAOmD,EAAeZ,EAAS,GAAI2B,CAAG,EAC7D,CACH,CAGM,WAAWxO,EAAiB,CAClC,MAAMK,EAAS,KAAK,OAAO,iBAAiB,IAAIL,CAAO,EACvD,GAAI,CAACK,EACH,MAAM,IAAIlZ,EACRF,EAAU,iBACV,gCAAgC+Y,CAAO,EACzC,EAEK,OAAAK,CAAA,CAGD,gBAAgBA,EAAyB,CArgBnD,IAAA/K,EAAAC,EAugBM,OAAAA,GAAAD,EAAA+K,EAAO,cAAP,KAAqB,OAAA/K,EAAA,KAAA+K,EAAA,KAAK,uBAA1B,KACA9K,EAAA,IAAImW,GAAqB,KAAK,mBAAmB,EAIrD,MAAc,iBACZ+C,EACAtZ,EACAoZ,EACAG,EACAjM,EAAkB,EAClB,CAlhBJ,IAAAnN,EAmhBI,QAAS+B,EAAQ,EAAGA,EAAQoX,EAAM,OAAQpX,IAAS,CAC3C,MAAAsX,EAAOF,EAAMpX,CAAK,EAClB,CAAE,MAAA+W,GAAUO,EACZ,CAAE,GAAA7P,EAAI,QAAAkB,EAAS,MAAAC,CAAU,EAAAmO,EAEzBQ,EACJF,IAAe,OAAYA,EAAarX,EAAQ,OAC9ClC,EAAA,SAAS6K,EAAS,CAAE,GAAAlB,EAAI,GAAGmB,CAAM,EAAGsO,EAAUK,CAAW,EAE7D,MAAMjO,GAAQrL,EAAAH,EAAI,SAAS2J,CAAE,IAAf,KAAkB,OAAAxJ,EAAA,MAChC,GAAI,CAACqL,EACH,MAAM,IAAIxZ,EACRF,EAAU,iBACV,yBAAyB6X,CAAE,EAC7B,EAGG,YAAO,YAAY,KAAK,CAC3B,KAAM,QACN,MAAA6B,EACA,SAAUgO,EAAK,SAChB,EAEDlM,IACIA,EAAU+J,KAAe,GAC3B,MAAMvX,GAAS,EAGb0Z,EAAK,SAAS,OAAS,IACzBlM,EAAU,MAAM,KAAK,iBACnBkM,EAAK,SACLxZ,EACA2J,EACA,OACA2D,CACF,EACF,CAGK,OAAAA,CAAA,CAGD,kBACNwJ,EAMoB,CACd,MAAA4C,MAAc,IAEpB5C,EAAY,QAAQ,CAAC,CAAE,MAAAmC,EAAO,SAAAvB,KAAe,CACnCgC,EAAA,IAAIT,EAAM,GAAI,CAAE,MAAAA,EAAO,SAAAvB,EAAU,SAAU,GAAI,EACxD,EACD,MAAMrR,EAAOqT,EAAQ,IAAI5C,EAAY,CAAC,EAAE,MAAM,EAAE,EAehD,GAZAA,EAAY,QAAQ,CAAC,CAAE,MAAAmC,EAAO,SAAAG,EAAU,MAAAlX,KAAY,CAClD,MAAMsX,EAAOE,EAAQ,IAAIT,EAAM,EAAE,EACjC,GAAKO,GAEDJ,EAAU,CACN,MAAAO,EAAaD,EAAQ,IAAIN,CAAQ,EACnCO,GAAczX,IAAU,SACfyX,EAAA,SAASzX,CAAK,EAAIsX,EAC/B,CACF,CACD,EAEG,CAACnT,EACG,UAAI,MAAM,gCAAgC,EAG3C,OAAAA,CAAA,CAGT,MAAc,iBACZqR,EACA1X,EACAgG,EACA9D,EAC4B,CArmBhC,IAAA/B,EAAAC,EAsmBS,+BAA0BsX,EAAU1R,EAAQ9D,CAAK,EAEtD,MAAMoW,EAAgC,CAAC,EACvC,KAAK,iBAAiBZ,EAAUY,EAAetS,EAAQ9D,CAAK,EAE5D,MAAMqW,EAAY,MAAM,KAAK,sBAAsBD,CAAa,EAEhE,aAAM,KAAK,iBAAiB,CAACC,CAAS,EAAGvY,EAAKgG,EAAQ9D,CAAK,GAEpD9B,OAAI,SAASsX,EAAS,EAAE,IAAxB,YAAAvX,EAA2B,QAA3B,KAAoCC,EAAA,KAGrC,0BACNsX,EACA1R,EACA9D,EACA,CACA,MAAM0X,EAAqB,CACzBJ,EACAxT,EACA9D,IACG,CACE,YAAO,aAAa,KAAK,CAC5B,KAAM,QACN,SAAUsX,EACV,OAAQxT,EACR,MAAO9D,CAAA,CACR,EACGsX,EAAK,UACPA,EAAK,SAAS,QAAQ,CAACrE,EAAOkE,IAAQ,CACjBO,EAAAzE,EAAOqE,EAAK,GAAIH,CAAG,EACvC,CAEL,EACmBO,EAAAlC,EAAU1R,EAAQ9D,CAAK,EAG5C,OAAQ,CACN,KAAK,eAAe,QAAQ,EAG9B,CAAC,OAAO,OAAO,GAAI,CACjB,KAAK,aAAa,QAAQ,EAC1B,KAAK,eAAe,QAAQ,EAEhC,CC1oBO,MAAM2X,EAAQ,CAenB,YACmBC,EACAC,EACjB,CAFiB,cAAAD,EACA,aAAAC,CAAA,CAhBnB,IAAI,MAAsB,CACxB,IAAIC,EAAwB,KACvB,qBAAS,QAAkB5O,GAAA,CACxB,MAAAP,EAAUO,EAAO,IAAI,aAAa,EAClCF,EAAS,KAAK,QAAQ,iBAAiB,IAAIL,CAAO,EACnDK,GAEDA,EAAO,MAAM,OAAS,SACf8O,EAAA5O,EAAO,IAAI,QAAQ,EAC9B,CACD,EACM4O,CAAA,CAQD,aACNrQ,EACAlJ,EACA,CACM,MAAA2Y,EAAW,KAAK,UAAUzP,CAAE,EAC9B,IAACyP,EAAiB,YACtB,MAAMpT,EAAS,KAAK,SAAS,IAAIoT,CAAQ,EACrC,IAACpT,EAAe,YAGpB,MAAM9D,EADW8D,EAAO,IAAI,cAAc,EACnB,QAAQ,EAAE,QAAQ2D,CAAE,EACvC,OAAAzH,IAAU,GAAW,KAElBzB,EAAGyB,EAAO8D,CAAM,EAGzB,SACE2D,EACAkB,EACAoP,EAAwC,CAAC,EACzCjU,EACAkU,EACA,CAnDJ,IAAA/Z,EAAAC,EAAAC,EAAAC,EAAAiL,EAoDI,MAAML,EAAS,KAAK,QAAQ,iBAAiB,IAAIL,CAAO,EACxD,GAAI,CAACK,EACH,MAAM,IAAIlZ,EACRF,EAAU,eACV,uBAAuB+Y,CAAO,YAChC,EAIF,GADiB,KAAK,SAAS,IAAIlB,CAAE,EAEnC,MAAM,IAAI3X,EACRF,EAAU,eACV,kCAAkC6X,CAAE,EACtC,EAGI,MAAA2K,EAAgBtO,GAClB7F,EAAK,cAAS,IAAI6F,CAAM,IAAxB,KAA2B,OAAA7F,EAAA,IAAI,aAC/B,SAEC,aAAQ,SAAS0K,EAASyJ,CAAuB,EAEhD,MAAAlJ,EAAS,IAAIrK,GACd,cAAS,IAAI4I,EAAIyB,CAAM,EAE5B,MAAMC,EAAUH,EAAO,QACjBuB,GACJrM,EAAa6Z,EAAA,WAAb,KACC,OAAA7Z,EAAA,OAAc,OAAO+U,GAAU,SAAWA,EAAQA,EAAM,IAEpD/J,EAAA,IAAI,SAAUzB,CAAE,EAChByB,EAAA,IAAI,cAAeP,CAAO,EAC1BO,EAAA,IAAI,cAAeC,CAAO,EAC1BD,EAAA,IAAI,eAAgBO,GAAQ,KAAKc,GAAY,EAAE,CAAC,EAGvD,MAAM3B,EAAQ,CACZ,IAFmBS,GAAOjL,GAAAD,EAAA6K,EAAA,OAAM,QAAb,KAAqB,OAAA5K,EAAA,KAAAD,EAAA+J,EAAA,IAArB,OAA4C,CAAC,EAGhE,GAAG6P,CACL,EAOA,GALA,OAAOnP,EAAM,GACb,OAAOA,EAAM,QACb,OAAOA,EAAM,SAEMI,EAAO,MAAM,WAChB,CACR,MAAAzD,EAAM,CAAC3B,GAAciB,IAAqB,CAC1CzF,GAAawE,EAAG,EACX,eAAQA,EAAG,EAAE,QAAQ,CAAC,CAACjC,GAAKxO,CAAK,IAAM,CAC5C,MAAMkS,GAAWR,EAAW,GAAGA,CAAQ,IAAIlD,EAAG,GAAKA,GACnD4D,EAAIpS,EAAOkS,EAAQ,EACpB,EAED6D,EAAO,IAAI,QAAQrE,CAAQ,GAAI1D,GAASyC,EAAG,CAAC,CAEhD,EACA2B,EAAIqD,EAAO,EAAE,OAEN,eAAQA,CAAK,EAAE,QAAQ,CAAC,CAACjH,EAAKxO,EAAK,IAAM,CAC1CA,KAAU,QAEd+V,EAAO,IAAI,QAAQvH,CAAG,GAAIR,GAAShO,EAAK,CAAC,EAC1C,EAGH,MAAM+jB,EACJpT,IAAWkF,EAAO,MAAM,OAAS,OAAS,KAAO,KAAK,MAExD,GAAI,CAACkO,EAAU,OAEf,MAAMe,EAAU,KAAK,SAAS,IAAIf,CAAQ,EAC1C,GAAI,CAACe,EAAS,OAER,MAAAC,EAAkBD,EAAQ,IAAI,cAAc,EAC5CjY,EACJgY,GAAe,KACXA,EAAcE,EAAgB,OAC5BA,EAAgB,OAChBF,EACFE,EAAgB,OACtBA,EAAgB,OAAOlY,EAAO,CAACyH,CAAE,CAAC,EAGpC,YACEA,EACAxX,EAGI,CACF,eAAgB,IAElB,CACM,MAAE,gBAAAkoB,EAAiB,eAAAC,CAAA,EAAmBnoB,EAC5C,GAAIkoB,GAAmBC,EAAgB,CAC7B,cACN,yEACF,EACA,OAGF,MAAMC,EAAS,KAAK,SAAS,IAAI5Q,CAAE,EACnC,GAAI,CAAC4Q,EAAQ,OAEP,MAAAC,EAAiBD,EAAO,IAAI,cAAc,EAE1CvU,EAAS,KAAK,UAAU2D,CAAE,EAEhC,GAAI,CAAC3D,EAAQ,OAEP,MAAAoU,EADU,KAAK,SAAS,IAAIpU,CAAM,EACR,IAAI,cAAc,EAC5CyU,EAAaL,EAAgB,QAAQ,EAAE,QAAQzQ,CAAE,EAEnD8Q,EAAa,IACCL,EAAA,OAAOK,EAAY,CAAC,GAGxB,IAAM,CAClB,GAAIJ,EAAiB,EACU,IAAM,CACjC,GAAI,CAACA,EACH,MAAM,IAAIroB,EACRF,EAAU,eACV,qDACF,EAEF,MAAM0Z,EAAQ,KAAK,SAAS,IAAI6O,CAAe,EAC/C,GAAI,CAAC7O,EAAO,OACN,MAAAkP,EAAelP,EAAM,IAAI,aAAa,EAW5C,GATAgP,EAAe,QAAiBrF,GAAA,CAC9B,MAAMwF,EAAa,KAAK,SAAS,IAAIxF,CAAK,EACrCwF,GACL,KAAK,QAAQ,SACXA,EAAW,IAAI,aAAa,EAC5BD,CACF,EACD,EAEGL,IAAoBrU,EAAQ,CAE9BoU,EAAgB,OAAOK,EAAYD,EAAe,SAAS,EAC3D,OAGF,MAAMI,EAAmB,KAAK,SAAS,IAAIP,CAAe,EAC1D,GAAI,CAACO,EAAkB,OAEUA,EAAiB,IAChD,cACF,EACyB,KAAKJ,EAAe,SAAS,CACxD,GAEqB,EACrB,OAGF,GAAIF,EAAgB,CAEZ,MAAAO,EAAclR,GAAe,CAClB,KAAK,SAAS,IAAIA,CAAE,EAEV,IAAI,cAAc,EACjC,QAAQA,GAAMkR,EAAWlR,CAAE,CAAC,EAEjC,cAAS,OAAOA,CAAE,CACzB,EAEA6Q,EAAe,QAAQ7Q,GAAMkR,EAAWlR,CAAE,CAAC,EAE/C,GAEM,EAED,cAAS,OAAOA,CAAE,EAGzB,QAAQA,EAAY,CAClB,OAAO,KAAK,aACVA,EACA,CAACzH,EAAO8D,IAAQ,CAzOtB,IAAA7F,EA2OW,OAAAA,EAAA6F,EAAA,IAAI,cAAc,EAClB,UACA,GAAG9D,EAAQ,CAAC,IAHf,KAGoB/B,EAAA,KACxB,EAGF,UAAU2a,EAAiC,CACzC,MAAMzU,EAAO,KAAK,KAClB,GAAI,CAACA,GAAQA,IAASyU,EAAiB,YAEjC,MAAAC,EAAc3B,GAAoC,CACtD,MAAM4B,EAAe,KAAK,SAAS,IAAI5B,CAAQ,EAC3C,IAAC4B,EAAqB,YAEpB,MAAAvO,EAAWuO,EAAa,IAAI,cAAc,EAErC,UAAAC,KAAWxO,EAAS,UAAW,CACpC,GAAAwO,IAAYH,EAAiB,OAAA1B,EAE3B,MAAApT,EAAS+U,EAAWE,CAAO,EAC7B,GAAAjV,GAAU,KAAa,OAAAA,CAAA,CAGtB,WACT,EAEA,OAAO+U,EAAW1U,CAAI,EAGxB,QAAQsD,EAAY,CAClB,OAAO,KAAK,aACVA,EACA,CAACzH,EAAO8D,IAAQ,CA3QtB,IAAA7F,EA6QW,OAAAA,EAAA6F,EAAA,IAAI,cAAc,EAClB,UACA,GAAG9D,EAAQ,CAAC,IAHf,KAGoB/B,EAAA,KACxB,EAGF,WACE+a,EACAC,EACAzC,EAA+B,KAC/B0C,EAA4B,GAC5B,CACA,GACEF,EAAa,OAAS,GACtBxC,GACAwC,EAAa,SAASxC,CAAa,EACnC,CACQ,cACN,qEACF,EACA,OAGF,GAAIwC,EAAa,SAAW,GAAKxC,IAAkBwC,EAAa,CAAC,EAC/D,OAGE,GAAAA,EAAa,SAASC,CAAS,EAAG,CAC5B,cACN,iEACF,EACA,OAII,MAAAE,MAA2B,IAE3B7J,EAAc,KAAK,SAAS,IAAI2J,CAAS,EAC/C,GAAI,CAAC3J,EAAa,OAEZ,MAAA8C,EAAgB9C,EAAY,IAAI,aAAa,EAEnD0J,EAAa,QAAmBpI,GAAA,CACxB,MAAA9M,EAAS,KAAK,UAAU8M,CAAO,EACrC,GAAI,CAAC9M,EAAQ,OAEb,MAAM4D,EAAQ,KAAK,SAAS,IAAIkJ,CAAO,EACvC,GAAI,CAAClJ,EAAO,OAEZ,KAAK,QAAQ,SACXA,EAAM,IAAI,aAAa,EACvB0K,CACF,EAEM,MAAA7H,EAAW4O,EAAqB,IAAIrV,CAAM,EAChD,GAAI,CAACyG,EAAU,CACb4O,EAAqB,IAAIrV,EAAQ,CAAC8M,CAAO,CAAC,EAC1C,OAGF,MAAMwI,EAAO7O,EAASA,EAAS,OAAS,CAAC,EACzC,GAAI,KAAK,QAAQ6O,CAAI,IAAMxI,EACzB,MAAM,IAAI9gB,EACRF,EAAU,eACV,0DACF,EAGF2a,EAAS,KAAKqG,CAAO,EACtB,EAED,IAAIyI,EAAc,EAClB,MAAM,KAAKF,EAAqB,QAAQ,CAAC,EAAE,QACzC,CAAC,CAAC7J,EAAa0J,CAAY,EAAGhZ,IAAU,CACtC,MAAMsZ,EAAoB,KAAK,SAAS,IAAIL,CAAS,EACrD,GAAI,CAACK,EAAmB,OAClB,MAAAC,EAAuBD,EAAkB,IAAI,cAAc,EAC3DE,EAAoB,KAAK,SAAS,IAAIlK,CAAW,EACvD,GAAI,CAACkK,EAAmB,OAClB,MAAAC,EAAuBD,EAAkB,IAAI,cAAc,EAI3DnC,EAAaoC,EAChB,UACA,UAAgBhS,OAAOuR,EAAa,CAAC,CAAC,EACpBS,EAAA,OAAOpC,EAAY2B,EAAa,MAAM,GAEjC,IAAM,CAE9B,GAAI,EADUhZ,IAAU,GACZ,CACVqZ,IACA,OAGF,GAAI,CAAC7C,EAAe,CAClB6C,EAAcE,EAAqB,OACnC,OAGF,IAAIG,EAAcH,EACf,UACA,UAAU9R,GAAMA,IAAO+O,CAAa,EACnCkD,IAAgB,KAClB,QAAQ,MAAM,kDAAkD,EAChEA,EAAcH,EAAqB,QAEvBF,EAAAH,EACVQ,EACAA,EAAc,CACpB,GAEkB,EAEGH,EAAA,OAAOF,EAAaL,CAAY,EAEzD,EAGF,oBAAoBvR,EAAY8C,EAAoB,CAClD,MAAMrB,EAAS,KAAK,SAAS,IAAIzB,CAAE,EACnC,GAAI,CAACyB,EAAQ,OAEP,MAAAyQ,EAAiBzQ,EAAO,IAAI,cAAc,EACjCyQ,EAAA,OAAO,EAAGA,EAAe,MAAM,EAC9CA,EAAe,KAAKpP,CAAQ,EAEhC,CCpYO,SAASqP,GACd5Q,EACAM,EACAJ,EACAN,EACA,CAbF,IAAA3K,EAAAC,EAAAC,EAcE,MAAMqL,GAAerL,GAAOD,GAAAD,EAAA+K,EAAA,OAAM,QAAb,KAAqB,OAAA9K,EAAA,KAAAD,EAAAiK,EAAA,IAArB,OAA4C,CAAC,EAE3D,eAAQU,CAAK,EAAE,QAAQ,CAAC,CAACjH,EAAKxO,CAAK,IAAM,CAC1CwL,GAAS,IAAIgD,CAAG,GAChBxO,IAAU,SAGRmW,EAAA,MAAM3H,CAAG,EAAIxO,EAAA,CACpB,EAGM,eAAQqW,CAAY,EAAE,QAAQ,CAAC,CAAC7H,EAAKxO,CAAK,IAAM,EAEnD,CAAC+V,EAAO,IAAI,QAAQvH,CAAG,EAAE,GAAKuH,EAAO,IAAI,QAAQvH,CAAG,EAAE,IAAM,UAM9D2H,EAAM3H,CAAG,EAAIxO,EAAA,CACd,CACH,CCoJA,MAAM0mB,GAAqB,CAACzI,GAAyBd,EAAgB,EAW9D,MAAMwJ,EAAM,CA+WjB,YAAY,CAAE,SAAAC,EAAU,MAAAxL,EAAO,SAAArC,EAAU,WAAA8N,GAA4B,CAtWrE,qBAAkB,IAAIzK,GAItB,KAAQ,gBAAkB,GAET,eAAa7H,GAAiB,CACpC4G,GAAA,KAAK,OAAQ5G,CAAK,CAC7B,EAIiB,aAAUnK,GAA8B,EAAE,EAI3D,KAAiB,OAAgB,CAC/B,MAAO,CAAC,EACR,KAAM,OACR,EAEiB,eAAYA,GAAO,EAAK,EAExB,cAAWiK,GAAS,IAAM,CAlO7C,IAAAvJ,EAAAC,EAmOI,OAAOA,GAAKD,EAAA,YAAL,KAAW,OAAAA,EAAA,YAAX,KAAwBC,EAAA,GAChC,EAmGD,UAAO,IAAM,CACX,GAAI,KAAK,SAAU,CACjB,QAAQ,MAAM,8BAA8B,EAC5C,OAEG,cAAS,YAAY,KAAK,CACjC,EAOA,UAAO,IAAM,CACX,GAAI,KAAK,SAAU,CACjB,QAAQ,MAAM,8BAA8B,EAC5C,OAEG,cAAS,YAAY,KAAK,CACjC,EAOA,kBAAe,IACN,KAAK,SAAS,YAAY,MAAM,EAoEzC,iBAAc,IAAM,CACb,cAAS,YAAY,cAAc,CAC1C,EA8HA,KAAQ,YAAc,GA4DtB,KAAiB,kBAAoB,IAAM,CACzC,KAAK,gBAAgB,IACnB,KAAK,MAAM,cAAc,UAAU,CAAC,CAAE,KAAAiF,EAAM,GAAAsE,EAAI,QAAAnJ,KAAc,CAC5D,OAAQ6E,EAAM,CACZ,IAAK,MAAO,CACL,mBAAcsE,EAAInJ,EAAS,EAAK,EACrC,OAEF,IAAK,SAAU,CACR,qBAAgBmJ,EAAInJ,CAAO,EAChC,OACF,CAEH,EACH,EACA,KAAK,gBAAgB,IAAI,KAAK,MAAM,KAAK,EACzC,KAAK,gBAAgB,IAAI,KAAK,MAAM,YAAY,EAChD,KAAK,gBAAgB,IAAI,KAAK,MAAM,SAAS,EAC7C,KAAK,gBAAgB,IAAI,KAAK,MAAM,WAAW,CACjD,EAypBiB,oBAAkBQ,GAAwC,CACzEA,EAAO,QAAQf,GAAS,KAAK,cAAcA,CAAK,CAAC,CACnD,EA9tBE,KAAK,MAAQ,CACX,MAAO,IAAI4J,GACX,UAAW,IAAIA,GACf,YAAa,IAAIA,GACjB,aAAc,IAAIA,GAClB,cAAe,IAAIA,EACrB,EACK,aAAU,IAAIwK,GAEb,MAAAtF,EAAY,IAAII,GACZJ,EAAA,QAAQwB,GAAiB,IAAM,IAAI,EAE7CwL,GAAmB,QAAenG,GAAA,CAChCA,EAAI,MAAM7G,CAAS,EACpB,EAEK,MAAAoN,EAAiBD,GAAc,CAAC,EACtC,KAAK,eAAiBC,EACtBA,EAAe,QAAqB5J,GAAA,CAClCA,EAAU,MAAMxD,CAAS,EAC1B,EAED,KAAK,UAAYA,EAAU,SAAS,OAAWX,CAAQ,EACvD,KAAK,UAAU,OAAOuE,EAAqB,EAAE,QAAkBzH,GAAA,CAC7D,KAAK,QAAQ,SAAS,CAACA,CAAM,CAAC,EAC/B,EACD,KAAK,KAAO,KAAK,UAAU,IAAIiJ,EAAa,EAC5C,KAAK,MAAQ,IAAI0F,GAAQ,KAAK,SAAU,KAAK,OAAO,EAChDoC,IAAa,SACf,KAAK,UAAU,MAAQA,GAErBxL,IACF,KAAK,OAASA,GAGX,cAAS,YAAY,KAAK,cAAc,EAC7C,KAAK,SAAS,QAAQ,CAACnc,EAAGqV,IAAO,CAC1B,sBAAiBA,EAAI,EAAK,EAE3B,EAAAA,KAAM,KAAK,QAAQ,SAGlB,mBAAcA,EAAI,GAAO,EAAI,EACnC,EAED,KAAK,kBAAkB,EAlXzB,IAAI,IAAK,CACP,OAAO,KAAK,KAAK,GAUnB,IAAY,UAAW,CACrB,OAAO,KAAK,KAAK,QAMnB,IAAI,gBAAiB,CACnB,OAAO,KAAK,KAAK,eAQnB,IAAI,UAAW,CACb,OAAO,KAAK,UAMd,IAAI,UAAW,CACb,OAAO,KAAK,UAAU,SAMxB,IAAI,KAAM,CACR,OAAO,KAAK,KAMd,IAAI,QAAS,CACX,OAAO,KAAK,QAQd,IAAI,WAAY,CACd,OAAO,OAAO,OAAO,KAAK,QAAQ,KAAM,GAAE,OAQ5C,IAAI,SAAU,CACZ,OAAI,KAAK,SACA,GAEF,KAAK,SAAS,QAQvB,IAAI,SAAU,CACZ,OAAI,KAAK,SACA,GAEF,KAAK,SAAS,QAmDvB,SAASlJ,EAAgB2b,EAA0B,KAAK,gBAAiB,CACjE,MAAAC,EAAW,KAAK,KAAK,SAClBA,EAAA,SACP,IAAM,CACA,IACC5b,EAAA,QACI3D,EAAG,CACF,cACN,iCAAiCuf,EAAS,IAAI,eAChD,EACA,QAAQ,MAAMvf,CAAC,EAEnB,EACAsf,EAAiB,KAAK,SAAS,SAAW,IAC5C,EAgBF,gBAAgB3b,EAAgB,CAC9B,KAAK,gBAAkB,GACpBA,EAAA,EACH,KAAK,gBAAkB,GA0BzB,IAAI,WAAY,CACd,OAAO,KAAK,KAAK,UAQnB,IAAI,SAAU,CACZ,OAAO,KAAK,SAQd,IAAI,SAAU,CACL,YAAK,SAAS,KAAK,EAQ5B,IAAI,UAAW,CACb,OAAO,KAAK,SAQd,IAAI,QAAS,CACX,OAAO,KAAK,KAAK,OAQnB,IAAI,MAAO,CACT,OAAO,KAAK,KAAK,KAQnB,IAAI,UAAW,CACN,YAAK,UAAU,QAAU,GAQlC,IAAI,WAAY,CACd,OAAO,KAAK,UAQd,IAAI,SAASpL,EAAgB,CAC3B,KAAK,UAAU,MAAQA,CAAA,CASzB,IAAI,OAAQ,CACV,OAAO,KAAK,KAAK,MAQnB,IAAI,MAAO,CAxgBb,IAAA8K,EAAAC,EAygBU,MAAA4Z,EAAS,KAAK,MAAM,KACtB,OAACA,IACE5Z,UAAK,SAAS4Z,CAAM,IAApB,YAAA7Z,EAAuB,QAAvB,KAAgCC,EADnB,IACmB,CAQzC,IAAI,SAAU,CACZ,OAAO,KAAK,KAAK,QAMnB,IAAI,QAAS,CACX,OAAO,KAAK,QAOd,IAAI,UAAW,CACb,OAAO,KAAK,KAAK,SAKnB,IAAY,UAAW,CACd,YAAK,UAAU,IAAIoS,EAAgB,EA8EpC,aACN5I,EACAnJ,EACA,CA1nBJ,IAAAN,EA2nBU,MAAA6F,EAAS,KAAK,UAAU4D,CAAK,EAC/B,IAAC5D,EAAe,YAEd,MAAAsW,EACJ,OAAO1S,GAAU,UAAWzJ,OAAK,SAASyJ,CAAK,IAAnB,YAAAzJ,EAAsB,MAAQyJ,EACxD,IAAC0S,EAAmB,YAExB,MAAMpa,EAAQ8D,EAAO,SAAS,QAAQsW,CAAU,EAC5C,OAAApa,IAAU,GAAW,KAElBzB,EAAGuF,EAAQ9D,CAAK,EAGjB,cAAcyH,EAAYnJ,EAAkB+b,EAAe,CAC7D,IACF,GAAI5S,KAAM,KAAK,QAAQ,OACrB,OAEF,MAAMyB,EAAS,KAAK,SAAS,IAAIzB,CAAE,EACnC,GAAI,CAACyB,EAAQ,CACH,aAAK,gCAAgCzB,CAAE,EAAE,EACjD,OAGF,MAAMxX,EAAwB,CAC5B,SAAU,CAACyX,EAAO/F,EAAKrD,IAAY,CAC7BqD,GACF+F,EAAM,MAAM,aAAa,KAAK,CAAE,IAAA/F,EAAK,EAGlC,WAAM,aAAa,KAAK,CAC3B,KAAM,SACN,GAAA8F,EACA,QAASC,EAAM,QACf,MAAO,CAAE,IAAA/F,CAAI,EACb,QAAArD,CAAA,CACD,EAEL,EAEMoJ,EAAQ,IAAIyC,GAAM,KAAK,QAASjB,EAAQ,KAAMjZ,CAAO,EAC3D,KAAK,UAAUyX,CAAK,EAEpB,KAAK,QAAQ,MAAQ,CACnB,GAAG,KAAK,QAAQ,MAChB,CAACD,CAAE,EAAGC,CACR,EACMA,EAAA,MAAM,QAAQ,KAAK,EAErBA,EAAM,MAAM,OAAS,QAClB,WAAM,UAAU,KAAKD,CAAE,EAGzB,WAAM,aAAa,KAAK,CAC3B,KAAM,MACN,GAAAA,EACA,KAAA4S,EACA,QAAS3S,EAAM,MAAM,QACrB,MAAOA,EAAM,MACb,QAAApJ,CAAA,CACD,QACM1D,EAAG,CACV,QAAQ,MAAM,uCAAuC,EACrD,QAAQ,MAAMA,CAAC,EACjB,CAGM,gBAAgB6M,EAAYnJ,EAAkB,CA9rBxD,IAAAL,EAAAC,EA+rBQ,IACI,MAAAwJ,EAAQ,KAAK,SAASD,CAAE,EAC9B,GAAI,CAACC,EAAO,OAERA,EAAM,MAAM,OAAS,QAClB,WAAM,YAAY,KAAKD,CAAE,EAG3B,WAAM,aAAa,KAAK,CAC3B,KAAM,SACN,GAAAA,EACA,QAASC,EAAM,QACf,QAAQxJ,UAAK,UAAUwJ,EAAM,KAAK,IAA1B,YAAAzJ,EAA6B,KAA7B,KAAmCC,EAAA,GAC3C,MAAOwJ,EAAM,MACb,QAAApJ,CAAA,CACD,EAEK,MAAE,CAACmJ,CAAE,EAAGrV,EAAG,GAAGujB,CAAO,EAAI,KAAK,QAAQ,KAAK,EACjD,KAAK,QAAQ,MAAQA,EAEfjO,EAAA,MAAM,QAAQ,KAAK,EACzBA,EAAM,MAAM,QAAQ,QACb9M,EAAG,CACV,QAAQ,MAAM,yCAAyC,EACvD,QAAQ,MAAMA,CAAC,EACjB,CAcF,SACE+N,EACA2R,EAAsE,GACtExW,EACAkU,EACQ,CA3uBZ,IAAA/Z,EA4uBI,GAAI,KAAK,SACP,MAAM,IAAInO,EACRF,EAAU,eACV,qCACF,EAGF,MAAM6X,GAAKxJ,EAAWqc,EAAA,KAAX,OAAiB,KAAK,KAAK,UAAU,YAAY,EAE5D,YAAK,SAAS,IAAM,CAClB,KAAK,MAAM,SACT7S,EACAkB,EACA,CAAE,GAAG2R,CAAW,EAChB,OAAOxW,GAAW,SAAWA,EAAiBA,GAAA,GAC9CkU,CACF,EACD,EAEMvQ,CAAA,CAYT,UACEkO,EAIA7R,EACAkU,EACU,CACV,MAAMuC,EAAgB,CAAC,EACvB,OAAA5E,EAAO,QAAiBjO,GAAA,CApxB5B,IAAAzJ,EAqxBM,MAAMwJ,EAAK,KAAK,SACdC,EAAM,SACNzJ,EAAAyJ,EAAM,aAAN,KAAAzJ,EAAoB,CAAC,EACrB6F,EACAkU,CACF,EACAuC,EAAI,KAAK9S,CAAE,EACX,OAAOuQ,GAAgB,UAAYA,GAAA,CACpC,EAEMuC,CAAA,CAYT,iBACEC,EACA5R,EACA6R,EAAgC,QACtB,CA/yBd,IAAAxc,EAAAC,EAgzBI,GAAI,CAAC0K,EAAM,OAAQ,MAAO,CAAC,EACrB,MAAA9E,EAAS,KAAK,UAAU0W,CAAW,EACrC,IAAC1W,EAAQ,MAAO,CAAC,EAErB,MAAM4V,GACJzb,EAAA6F,EAAO,SAAS,UAAU,CAAC,CAAE,GAAA2D,CAAG,IAAMA,IAAO+S,EAAY,EAAE,IAA3D,KAAgEvc,EAAA,EAC5Dob,EAAcoB,IAAc,SAAWf,EAAcA,EAAc,EAErE,GAAA9Q,EAAM,QAAU,EAAG,CACrB,GAAI,GAAC1K,EAAM0K,EAAA,CAAC,IAAP,MAAU1K,EAAA,eAAgB,CAAC,EAChC,KAAM,CAAE,QAAAyK,EAAS,GAAG2R,CAAW,EAAI1R,EAAM,CAAC,EAO1C,MAAO,CANI,KAAK,SACdD,EACA2R,EACAxW,EAAO,GACPuV,CACF,CACU,EAGZ,MAAM1D,EAGD,CAAC,EACN,OAAA/M,EAAM,QAAgB3F,GAAA,CACpB,KAAM,CAAE,QAAA0F,EAAS,GAAG2R,CAAA,EAAerX,EAC9B0F,GACLgN,EAAO,KAAK,CAAE,QAAAhN,EAAS,WAAA2R,CAAA,CAAY,EACpC,EACM,KAAK,UAAU3E,EAAQ7R,EAAO,GAAIuV,CAAW,EAYtD,YACEqB,EACAC,EAGA,CA91BJ,IAAA1c,EAAAC,EA+1BI,GAAI,KAAK,SAAU,CACjB,QAAQ,MAAM,qCAAqC,EACnD,OAGI,MAAA0c,EAAa,OAAOD,GAAoB,WAExCrR,EACJ,OAAOoR,GAAc,UACjBzc,OAAK,SAASyc,CAAS,IAAvB,YAAAzc,EAA0B,MAC1Byc,EACN,GAAI,CAACpR,EACH,MAAM,IAAIxZ,EACRF,EAAU,eACV,mBAAmB8qB,CAAS,YAC9B,EAGF,GAAI,CAACE,EAAY,CACT,MAAA9W,EAAS,KAAK,UAAUwF,CAAK,EACnC,KAAK,OAAO,SACVA,EAAM,QACExF,GAAA,SACR5F,EAAgByc,EAAA,WAAhB,KAA0B,OAAAzc,EAAA,OAAa+U,EAAM,QAC/C,EAGF,MAAM/J,EAAS,KAAK,SAAS,IAAII,EAAM,EAAE,EACzC,GAAI,CAACJ,EACH,MAAM,IAAIpZ,EACRF,EAAU,eACV,mBAAmB0Z,EAAM,EAAE,YAC7B,EAGF,MAAM5B,EAAQ,KAAK,SAAS4B,EAAM,EAAE,EAC/B5B,GAEL,KAAK,SAAS,IAAM,CAClB,GAAIkT,EAAY,CACED,EAAA,EAChB,KAAK,UAAUjT,CAAK,EACpB,OAGEiT,EAAgB,UAClB,KAAK,MAAM,oBACTrR,EAAM,GACNqR,EAAgB,SAAS,IAAI1H,GAASA,EAAM,EAAE,CAChD,EAGF,MAAMjK,EAAS,KAAK,OAAO,iBAAiB,IAAIM,EAAM,OAAO,EAC7D,GAAI,CAACN,EACH,MAAM,IAAIlZ,EACRF,EAAU,eACV,uBAAuB0Z,EAAM,OAAO,YACtC,EAEasQ,GAAA5Q,EAAQM,EAAOJ,EAAQyR,CAAe,EACrD,KAAK,UAAUjT,CAAK,CACpB,CACD,EAYH,YACE4B,EACArZ,EAGI,CACF,eAAgB,IAElB,CACA,GAAI,KAAK,SAAU,CACjB,QAAQ,MAAM,qCAAqC,EACnD,OAGI,MAAA4qB,EACJ5qB,GAAWA,EAAQ,gBACf,CACE,GAAGA,EACH,gBAAiBA,EAAQ,gBAAgB,IAE3CA,EAMN,KAAK,SAAS,IAAM,CAClB,KAAK,MAAM,YACT,OAAOqZ,GAAU,SAAWA,EAAQA,EAAM,GAC1CuR,CACF,EACD,EAUH,SAASpT,EAA+B,CACtC,OAAO,KAAK,QAAQ,KAAK,EAAEA,CAAE,EAU/B,UAAUA,EAA+B,CAChC,YAAK,QAAQ,MAAMA,CAAE,EAU9B,aACEA,EACc,CA1+BlB,IAAAxJ,EAAAC,EA2+BI,OAAQA,UAAK,SAASuJ,CAAE,IAAhB,YAAAxJ,EAAmB,QAAnB,KAA4BC,EAAA,KAUtC,mBAAmB4c,EAA0C,CAC3D,MAAMC,EACJ,OAAOD,GAAiB,SAAW,CAACA,CAAY,EAAIA,EAEtD,OAAO,OAAO,OAAO,KAAK,QAAQ,KAAM,GAAE,OAAO,CAAC,CAAE,QAAAnS,CAAA,IAClDoS,EAAS,SAASpS,CAAO,CAC3B,EASF,cAAe,CACN,cAAO,OAAO,KAAK,QAAQ,MAAM,EAAE,IAAajB,KAAM,KAAK,EAUpE,mBAAmBoT,EAA+C,CAChE,OAAO,KAAK,mBAAmBA,CAAY,EAAE,IAAIrqB,GAAKA,EAAE,KAAK,EAU/D,UAAU+R,EAAgD,CACxD,MAAMoW,EAAW,OAAOpW,GAAW,SAAWA,EAASA,EAAO,GACxD0U,EAAW,KAAK,MAAM,UAAU0B,CAAQ,EAC1C,IAAC1B,EAAiB,YAEtB,MAAMpT,EAAS,KAAK,QAAQ,OAAOoT,CAAQ,EACvC,OAACpT,EAEEA,EAAO,MAFM,IAEN,CAUhB,QAAQ4D,EAA4B,CAClC,OAAO,KAAK,aACVA,EACA,CAAC5D,EAAQ9D,IAAO,CA/iCtB,IAAA/B,EA+iCyB,OAAAA,EAAA6F,EAAO,SAAS9D,EAAQ,CAAC,IAAzB,KAA8B/B,EAAA,KACnD,EAUF,SAASyJ,EAA4B,CA1jCvC,IAAAzJ,EA2jCI,OACEA,EAAK,kBAAayJ,EAAO,CAAC5D,EAAQ9D,IAChC8D,EAAO,SAAS,MAAM,EAAG9D,CAAK,KADhC,OAEK,CAAC,EAWV,QAAQ0H,EAA4B,CAClC,OAAO,KAAK,aACVA,EACA,CAAC5D,EAAQ9D,IAAO,CA5kCtB,IAAA/B,EA4kCyB,OAAAA,EAAA6F,EAAO,SAAS9D,EAAQ,CAAC,IAAzB,KAA8B/B,EAAA,KACnD,EAUF,SAASyJ,EAA4B,CAvlCvC,IAAAzJ,EAwlCI,OACEA,EAAK,kBAAayJ,EAAO,CAAC5D,EAAQ9D,IAChC8D,EAAO,SAAS,MAAM9D,EAAQ,CAAC,KADjC,OAEK,CAAC,EAWV,SAASyH,EAAY,CACZ,OAAAA,KAAM,KAAK,QAAQ,KAAK,EAYjC,WACEuR,EACAC,EACAzC,EAAmC,KACnC0C,EAA4B,GAC5B,CACA,GAAI,KAAK,SAAU,CACjB,QAAQ,MAAM,sCAAsC,EACpD,OAGF,KAAK,SAAS,IAAM,CA9nCxB,IAAAjb,EA+nCM,KAAK,MAAM,WACT+a,EAAa,IAAa1P,KAAM,EAAE,EAClC2P,EAAU,IACVhb,EAAAuY,GAAe,KAAf,KAAqBvY,EAAA,KACrBib,CACF,EACD,EAUH,eAAe3D,EAAuC,GAAI,CACxD,OAAO,IAAIH,GAAY,CACrB,OAAQ,KAAK,OACb,SAAU,KAAK,UAAU,SACzB,QAAS,CACP,OAAS3N,GAAe,KAAK,UAAU,UAAUA,CAAE,EAAE,SAAS,CAAE,GAAAA,EAAI,EACpE,IAAMA,GAAY,CArpC1B,IAAAxJ,EAAAC,EAspCe,OAAAA,GAAAD,EAAA,eAAU,OAAOwJ,CAAE,IAAxB,cAA2B,SAAS,CAAE,GAAAA,CAAG,KAAzC,KAA+CvJ,EAAA,MACjD,OAASuJ,GAAe,KAAK,UAAU,UAAUA,CAAE,CACrD,EACA,YAAA8N,CAAA,CACD,EAcH,IAAI,KAAM,CACR,OAAO,KAAK,SAAS,IAAI,KAAK,KAAK,QAAQ,EAgB7C,IAAI,aAAc,CAChB,OAAO,KAAK,SAAS,YAAY,KAAK,KAAK,QAAQ,EAUrD,KAAKyF,EAAqB,CApsC5B,IAAA/c,EAAAC,EAqsCI,OAAI,KAAK,cACF,qBAAkB,IAAIqR,GAC3B,KAAK,kBAAkB,EACvB,KAAK,YAAc,IAGhB,UAAK,KAAKyL,CAAM,EACrB,KAAK,UAAU,OAAOhL,EAAwB,EAAE,QAAe0D,GAAA,CAC7DA,EAAI,OAAO,EACZ,EACI,WAAM,MAAM,KAAK,EACjB,WAAM,UAAU,MAAKxV,GAAAD,EAAA,KAAK,OAAL,KAAW,OAAAA,EAAA,KAAX,OAAiB,EAAE,EACtC,KAQT,SAAU,CACR,KAAK,UAAU,OAAO+R,EAAwB,EAAE,QAAe0D,GAAA,CAC7DA,EAAI,SAAS,EACd,EACG,KAAK,KAAK,OACP,cAAS,cAAc,KAAK,cAAc,EAE5C,WAAM,MAAM,SAAS,EACrB,WAAM,UAAU,SAAS,EACzB,WAAM,YAAY,SAAS,EAC3B,WAAM,aAAa,SAAS,EAC5B,WAAM,cAAc,SAAS,EAClC,KAAK,gBAAgB,QAAQ,EAC7B,KAAK,YAAc,GAGb,iBAAiBjM,EAAYnJ,EAAkB,CAChD,WAAM,cAAc,KAAK,CAAE,KAAM,MAAO,GAAAmJ,EAAI,QAAAnJ,EAAS,EAGpD,oBAAoBmJ,EAAYnJ,EAAkB,CACnD,WAAM,cAAc,KAAK,CAAE,KAAM,SAAU,GAAAmJ,EAAI,QAAAnJ,EAAS,EAGvD,cAAcP,EAAqD,CAErE,GAAAA,EAAM,SAAW,KAAK,SACxB,OAEI,MAAAO,EACJ,CAACP,EAAM,YAAY,QACnB,CAAC,KAAK,SAAS,KACfA,EAAM,YAAY,kBAAkBM,IACpCN,EAAM,YAAY,OAAO,MACrB,GACAA,EAAM,YAAY,SAAW,KAAK,SAAS,IAAI,SACrDA,EAAM,KAAK,QAAQ,CAAC5K,EAAOsU,IAAO,CAC5B,IACE,GAAAtU,EAAM,SAAW,MAAO,CACrB,sBAAiBsU,EAAInJ,CAAO,EACjC,OAEE,GAAAnL,EAAM,SAAW,SAAU,CACxB,yBAAoBsU,EAAInJ,CAAO,EACpC,cAEK1D,EAAG,CACV,QAAQ,MAAM,6CAA6C,EAC3D,QAAQ,MAAMA,CAAC,EACjB,CACD,EAML,CCtvCO,SAASqgB,GAAeC,EAAkC,CACzD,MAAAC,EAAU,IAAI,IAAID,CAAQ,EAEhC,OAAAA,EAAW,CAAC,GAAG,IAAI,IAAIA,CAAQ,CAAC,EAEhCA,EAAS,QAAcE,GAAA,CACrBF,EAAS,QAAcG,GAAA,CACjB3rB,GAA0B0rB,CAAE,GAAKA,EAAG,cAAcC,CAAE,GACtDF,EAAQ,OAAOE,CAAE,CACnB,CACD,EACF,EAEM,CAAC,GAAGF,CAAO,CACpB,CAEA,SAASG,GACPtlB,EACAulB,EACAC,EACA,CAEM,MAAAC,MAAc,IAEdC,EAAiB1lB,GAAsB,CACvCylB,EAAQ,IAAIzlB,CAAO,IACvBylB,EAAQ,IAAIzlB,CAAO,EAEf,EAAAulB,GACgBA,EAAYvlB,CAAO,IAInCtG,GAA0BsG,CAAO,GACnCA,EAAQ,cAAc,QAAiBid,GAAA,CACrCyI,EAAczI,CAAK,EACpB,EAIL,EAEAyI,EAAc1lB,CAAO,CACvB,CAEO,SAAS2lB,GACd9O,EACY,CACZ,MAAMsO,EAAsB,CAAC,EACnB,OAAAtO,EAAA,cAAc,QAAiBoG,GAAA,CACvCqI,GAASrI,EAAkBjd,GAAA,CACzBmlB,EAAQ,KAAKnlB,CAAO,EACrB,EACF,EACMmlB,CACT,CAEgB,SAAAS,GACd/O,EACA7W,EACS,CACT,IAAI6lB,EAAa7lB,EAAQ,MACzB,KAAO6lB,GAAY,CACb,GAAAA,IAAehP,EAAkB,SACrCgP,EAAaA,EAAW,MAEnB,QACT,CAKgB,SAAAC,GACdjP,EACA7W,EACA,CAEE,QAAAA,IAAY6W,GACXnd,GAA0BsG,CAAO,GAAKA,EAAQ,cAAc6W,CAAS,EAK1E,CAEO,SAASkP,GACd/lB,EACS,CACF,OAAAA,EAAQ,OAAO,KAAKgmB,EAAkB,CAC/C,CAEO,SAASA,GAAmBhmB,EAA0C,CAtH7E,IAAAiI,EAuHS,OAAAA,EAAAjI,EAAQ,eAAR,KAAwBiI,EAAA,EACjC,CAEO,SAASge,GAAajmB,EAA0C,CACrE,OAAOgmB,GAAmBhmB,CAAO,GAAK+lB,GAAuB/lB,CAAO,CACtE,CAEgB,SAAAkmB,GAAgBpe,EAAY9H,EAAiC,CAC3E8H,EAAI,SAAS,IAAM,CACjB9H,EAAQ,aAAe,GACxB,CACH,CAEgB,SAAAmmB,GAAkBre,EAAY9H,EAAiC,CAC7E8H,EAAI,SAAS,IAAM,CACjB9H,EAAQ,aAAe,GACxB,CACH,CCrFO,MAAMomB,WAGH7U,EAEV,CALO,kCAML,KAAQ,eAAgC,KAExC,KAAQ,gBAA+B,KAEvC,KAAQ,cAA4C,OAEtC,oBAqDwB,wBAAC,EAAG,CAAC,EAnD3C,IAAI,MAAO,CACT,OAAO,KAAK,MAAM,KAGpB,IAAI,OAAQ,CACV,OAAO,KAAK,MAAM,MAGpB,IAAI,KAAK5M,EAAsB,CAC7B,KAAK,MAAM,KAAOA,CAAA,CAGpB,IAAI,OAAQ,CACV,OAAO,KAAK,MAAM,MAGpB,IAAI,QAAS,CACX,OAAO,KAAK,MAAM,OAGpB,IAAI,MAAMqF,EAAe,CACvB,KAAK,MAAM,MAAQA,CAAA,CAGrB,IAAI,cAAoC,CACtC,OAAO,KAAK,MAAM,aAGpB,IAAI,eAAgB,CAClB,OAAO,KAAK,MAAM,cAGpB,IAAI,aAAaqc,EAAmC,CAClD,KAAK,MAAM,aAAeA,CAAA,CAoB5B,IAAI,QAAS,CACP,iBAAY,KAAK,MACZ,KAAK,MAAM,OAGb,EAGT,IAAI,OAAOlnB,EAAgB,CACrB,WAAY,KAAK,QACnB,KAAK,MAAM,OAASA,EACtB,CAGF,IAAI,kBAAmB,CACrB,OAAI,KAAK,iBAAmB,KAAK,MAAQ,CAAC,KAAK,mBAC7C,KAAK,eAAiB,KAAK,KACtB,qBAAkBuF,GAAgB,KAAK,IAAI,GAG3C,KAAK,gBAGd,IAAI,cAAe,CACjB,OAAOK,GAAM,KAAKoB,GAAqB,IAAI,CAAC,EAG9C,IAAI,eAA8B,CAChC,OAAO,KAAK,cAAgBpB,GAAM,YAAY,KAAK,aAAa,EAAI,KAGtE,IAAI,cAA2C,CAC7C,OAAO,KAAK,cAGd,IAAI,aAAaJ,EAAkC,CACjD,KAAK,cAAgBA,CAAA,CAGvB,IAAI,OAA8B,CA7JpC,IAAAsD,EA8JQ,OAAC,KAAK,UAEHA,OAAK,QAAQ,SAAS,KAAK,EAAE,IAA7B,KAAkCA,EAFf,IAEe,CAG3C,IAAI,QAA0B,CAC5B,OAAK,KAAK,QAEH,KAAK,QAAQ,UAAU,KAAK,EAAE,EAFX,CAAC,CAEU,CAGvC,IAAI,GAAI,CACC,YAAK,iBAAiB,CAAC,EAGhC,IAAI,eAAgB,CAClB,OAAO,KAAK,aAAa,OAAO,KAAK,iBAAiB,EAGxD,IAAI,SAAoC,CACtC,MAAMrI,EAAS,KAAK,MAAM,mBAAmB,gBAAgB,EACzD,OAAAA,EAAO,SAAW,EAAU,KACzBA,EAAO,CAAC,EAAE,MAGnB,IAAI,GAAI,CACC,YAAK,iBAAiB,CAAC,EAGhC,IAAI,GAAI,CACC,YAAK,iBAAiB,CAAC,EAGhC,IAAI,GAAI,CACC,YAAK,iBAAiB,CAAC,EAGhC,cAAcxE,EAAwB,CACpC,MAAMiK,EAAQN,GAAM,YAAY,KAAK,IAAI,EAQzC,OAPee,GAA+B,CAC5C,EAAGT,EAAM,EACT,EAAGA,EAAM,EACT,EAAGA,EAAM,EACT,EAAGA,EAAM,EACT,OAAQ,KAAK,OACd,EACa,KAAKtI,GAAS3B,EAAO,cAAc2B,CAAK,CAAC,EAGzD,qBAAqB4P,EAAarC,EAAmC,CA/MvE,IAAArC,EAgNI,MAAM5C,EAAQN,GAAM,YAAY,KAAK,IAAI,EAElC,OAAApF,GACLgN,EACArC,EACArL,GAAaoG,EAAM,OAAQA,EAAM,QAAQ4C,EAAK,cAAL,OAAe,CAAC,CAC3D,EAGF,gBAAgBlL,EAAmB,CAzNrC,IAAAkL,EA0NI,MAAM5C,EAAQN,GAAM,YAAY,KAAK,IAAI,EAClC,OAAAxG,GACLU,GAAaoG,EAAM,OAAQA,EAAM,QAAQ4C,EAAK,cAAL,OAAe,CAAC,EACzDlL,CACF,EAGF,yBAAyBupB,EAAoC,CAjO/D,IAAAre,EAAAC,EAkOI,MAAM7C,EAAQN,GAAM,YAAY,KAAK,IAAI,EACnChI,EAAQsI,EAAM,iBAAiBihB,CAAa,EAC5ChnB,EAAcL,GAClB,CAAClC,CAAK,EACNsI,EAAM,QACN4C,EAAA,KAAK,SAAL,KAAeA,EAAA,GACf,CAAC,EACGzJ,EAASS,GAAaoG,EAAM,OAAQA,EAAM,QAAQ6C,EAAA,KAAK,SAAL,KAAAA,EAAe,CAAC,EAClElL,EAAU0C,GAAuBlB,EAAQc,CAAW,EAEnD,WAAIxC,GAAcwC,EAAatC,CAAO,EAG/C,cACEvC,EACAC,EACA6rB,EACAC,EACS,CAET,OADcD,EAAI,gBAAkB,KAAK,aAAe,KAAK,eAChD,eAAe,CAAC9rB,EAAGC,CAAC,EAAG,CAAC,EAGvC,gBAAgB2K,EAAuB,CACrC,OACE,KAAK,cAAcA,CAAK,GACxBA,EAAM,OAAO,KAAK,CAACtI,EAAOV,EAAGmC,IAC3B,KAAK,qBAAqBzB,EAAOyB,GAAQnC,EAAI,GAAKmC,EAAO,MAAM,CAAC,CAClE,EAIJ,UAAoB,CAClB,OAAOynB,GAAa,IAAI,EAG1B,oBAA8B,CAC5B,OAAOF,GAAuB,IAAI,EAGpC,gBAA0B,CACxB,OAAOC,GAAmB,IAAI,EAGhC,MAAO,CACWE,GAAA,KAAK,MAAO,IAAI,EAGlC,QAAS,CACWC,GAAA,KAAK,MAAO,IAAI,EAEtC,CAOO,SAASM,GAGdC,EAAyB,CACzB,GAAIA,IAAyBnV,GACpB,OAAA6U,GACF,CACL,IAAIO,EAAeD,EAEnB,KACE,OAAO,eAAeC,EAAa,SAAS,IAAMpV,GAAW,WAC7D,OAAO,eAAeoV,EAAa,SAAS,IAAM,MAElDA,EAAe,OAAO,eAAeA,EAAa,SAAS,EAAE,YAG/D,GAAI,OAAO,eAAeA,EAAa,SAAS,IAAM,KACpD,MAAM,IAAI7sB,EACRF,EAAU,qBACV,gDACF,EAGK,sBACL+sB,EAAa,UACbP,GAAqB,SACvB,EAGK,OAAAM,CACT,CClTa,MAAAE,GACXnR,GAA+B,cAAc,EAElCoR,GAAyBpR,GACpC,cACF,EAEaqR,GAAoBrR,GAA0B,UAAU,EAExDsR,GACXtR,GAA0C,QAAQ,EAEvCuR,GAAsBvR,GAAgC,WAAW,EAEjEwR,GACXxR,GAAiC,YAAY,EAElCyR,GACXzR,GAAmC,kBAAkB,EAE1C0R,GAAgB1R,GAAgC,KAAK,EAErD2R,GAAmB3R,GAG7B,QAAQ,2uBC5BJ,MAAM4R,GAAmB,gBAEnBC,GAA0BJ,GACrCG,EACF,yhDCGA,SAASE,GAAOpqB,EAAeqqB,EAAankB,EAAc,CAExD,OADIA,EAAO,GAAKlG,EAAQqqB,GACpBnkB,EAAO,GAAKlG,EAAQqqB,EAAYA,EAC7BrqB,CACT,CAEO,MAAMsqB,GAAW,EACXC,GAAW,GACXC,GAAY,IACZC,GAAe,EAEfC,GAAwB,IAWrB,SAAAC,GACdC,EACAC,EACM,CACN,KAAM,CAAE,KAAA7iB,EAAM,IAAAC,EAAK,UAAA6iB,EAAW,UAAAC,EAAW,KAAAC,EAAM,UAAAC,GAAcL,EAEvD,CAACM,EAASC,CAAO,EAAIN,EACrBO,EAAoBF,EAAUljB,EAC9BqjB,EAAoBF,EAAUljB,EAC9BqjB,EAASR,EAAYM,EAAoBJ,EAAOC,EAChDM,EAASR,EAAYM,EAAoBL,EAAOC,EAC/C,OAACK,EAAQC,CAAM,CACxB,CAEO,MAAMC,EAAS,CAoEpB,aAAc,CAnEd,KAAQ,0BAA4C,KAEpD,KAAQ,mBAAoC,KAE5C,KAAQ,gBAAyC,KAEhC,oBAAiB,IAAIhX,GAOtC,KAAQ,YAAc,GACtB,KAAQ,gBAA+B,KAEvC,KAAU,QAAkB,CAAE,EAAG,EAAG,EAAG,CAAE,EAEzC,KAAU,OAA6B,KAEvC,KAAU,SAAsC,KAEhD,KAAU,QAAU,EAEpB,KAAU,MAAQ,EAElB,KAAU,QAAU,GAEpB,KAAU,OAAwB,KAElC,KAAU,KAAO,EAEjB,KAAU,OAAS,EAEnB,KAAU,MAAgB,EAE1B,kBAAe,IAAIA,GAEnB,iBAAc,IAAIA,GAOlB,mBAAgB,IAAIA,GAEpB,qBAAkB,IAAIA,GAKX,kBAAIiX,GAAyB,EAAK,EAClC,kBAAIA,GAAyB,EAAK,EAElC,cAAAnB,GAEA,cAAAC,GAEM,mBAAgBmB,GAAS,IAAM,CACzC,cAAS,KAAK,EAAK,GACvB,GAAG,EAEW,mBAAgBA,GAAS,IAAM,CACzC,cAAS,KAAK,EAAK,GACvB,GAAG,EAGJ,MAAM3Y,EAAe,KAAK,aAAa,UAAgB4Y,GAAA,CACrD,KAAK,SAAWA,EAChB5Y,EAAa,YAAY,EAC1B,EAED,KAAK,qBAAqB,EAGpB,sBAAuB,CAC7B,KAAK,eACF,KAAK6Y,GAAa,GAAG,CAAC,EACtB,UAAU,CAAC,CAAE,MAAA9jB,EAAO,OAAAC,EAAQ,KAAAC,EAAM,IAAAC,KAAU,CACvC,CAAC,KAAK,QAAU,CAAC,KAAK,iBAC1B,KAAK,gBAAgBH,EAAOC,EAAQC,EAAMC,CAAG,EAC9C,EAGG,gBACNH,EACAC,EACAC,EACAC,EACA,CACI,IAAC,KAAK,gBAAiB,OAE3B,KAAM,CAAC4jB,EAAiBC,CAAe,EAAI,KAAK,gBAC1CC,EAAaF,EAAkB/jB,GAAS,EAAI,KAAK,MACjDkkB,EAAaF,EAAkB/jB,GAAU,EAAI,KAAK,MAEnD,eAAUgkB,EAAYC,EAAY,EAAK,EAC5C,KAAK,OAASlkB,EACd,KAAK,QAAUC,EACf,KAAK,MAAQC,EACb,KAAK,KAAOC,EACZ,KAAK,YAAc,GACnB,KAAK,gBAAkB,KAEvB,KAAK,YAAY,KAAK,CACpB,KAAAD,EACA,IAAAC,EACA,MAAAH,EACA,OAAAC,CAAA,CACD,EAGK,sBAAuB,CACzB,QAAK,aAAe,KAAK,OAAQ,CACnC,KAAM,CAAE,MAAAD,EAAO,OAAAC,EAAQ,KAAAC,EAAM,IAAAC,CAAA,EAAQ,KAAK,mBAC1C,KAAK,gBAAgBH,EAAOC,EAAQC,EAAMC,CAAG,EAC/C,CAGF,IAAI,oBAAqB,CACnB,OAAC,KAAK,QACL,KAAK,4BACH,+BAA4B,KAAK,OAAO,sBAAsB,GAE9D,KAAK,2BAJa,IAAI,QAAQ,EAAG,EAAG,EAAG,CAAC,CAInC,CAGd,IAAI,SAAU,CACZ,OAAO,KAAK,SAGd,IAAI,QAAS,CACX,OAAO,KAAK,QAGd,IAAI,SAAU,CACZ,OAAO,KAAK,QAAQ,EAGtB,IAAI,SAAU,CACZ,OAAO,KAAK,QAAQ,EAGtB,IAAI,QAAS,CACX,OAAO,KAAK,mBAAmB,OAGjC,IAAI,MAAO,CACT,OAAO,KAAK,MAId,IAAI,QAAS,CACX,OAAO,KAAK,QAGd,IAAI,OAAOgkB,EAAiB,CAC1B,KAAK,QAAUA,CAAA,CAQjB,IAAI,WAAY,CACd,MACE,CAAC,KAAK,QACN,KAAK,qBAAuB,MAC5B,KAAK,qBAAuB,EAErB,EACF,KAAK,mBAAmB,MAAQ,KAAK,mBAG9C,IAAI,KAAM,CACR,OAAO,KAAK,KAGd,IAAI,YAAa,CACR,OAAC,KAAK,UAAY,KAAK,KAGhC,IAAI,YAAa,CACR,OAAC,KAAK,UAAY,KAAK,KAGhC,IAAI,gBAAiB,CACb,MAAE,cAAAC,EAAe,cAAAC,CAAA,EAAkB,KAEzC,OAAOvkB,GAAM,KAAK,CAChB,GAAGskB,EACH,EAAGC,EAAc,EAAID,EAAc,EACnC,EAAGC,EAAc,EAAID,EAAc,EACpC,EAGH,IAAI,eAAgB,CAClB,KAAM,CAAE,QAAAE,EAAS,QAAAC,EAAS,MAAAvkB,EAAO,OAAAC,EAAQ,KAAAijB,GAAS,KAC3C,OACL,EAAGoB,EAAUtkB,EAAQ,EAAIkjB,EACzB,EAAGqB,EAAUtkB,EAAS,EAAIijB,CAC5B,EAGF,IAAI,eAAgB,CAClB,KAAM,CAAE,QAAAoB,EAAS,QAAAC,EAAS,MAAAvkB,EAAO,OAAAC,EAAQ,KAAAijB,GAAS,KAC3C,OACL,EAAGoB,EAAUtkB,EAAQ,EAAIkjB,EACzB,EAAGqB,EAAUtkB,EAAS,EAAIijB,CAC5B,EAGF,IAAI,WAAY,CACd,KAAM,CAAE,QAAAoB,EAAS,MAAAtkB,EAAO,KAAAkjB,CAAS,OAC1B,OAAAoB,EAAUtkB,EAAQ,EAAIkjB,CAAA,CAG/B,IAAI,WAAY,CACd,KAAM,CAAE,QAAAqB,EAAS,OAAAtkB,EAAQ,KAAAijB,CAAS,OAC3B,OAAAqB,EAAUtkB,EAAS,EAAIijB,CAAA,CAGhC,IAAI,OAAQ,CACV,OAAO,KAAK,mBAAmB,MAGjC,IAAI,MAAO,CACT,OAAO,KAAK,MAGd,iBAAiBsB,EAAgBC,EAAgB,CAC/C,KAAK,UAAU,KAAK,QAAUD,EAAQ,KAAK,QAAUC,CAAM,EAG7D,sBAAuB,CACjB,KAAK,iBAAmB,KAAK,SAC1B,qBAAgB,UAAU,KAAK,MAAM,EAC1C,KAAK,gBAAgB,WAAW,GAElC,KAAK,gBAAkB,KACvB,KAAK,OAAS,KACd,KAAK,0BAA4B,KACjC,KAAK,mBAAqB,KAG5B,SAAU,CACR,KAAK,qBAAqB,EAC1B,KAAK,YAAY,SAAS,EAC1B,KAAK,cAAc,SAAS,EAC5B,KAAK,gBAAgB,SAAS,EAC9B,KAAK,eAAe,SAAS,EAC7B,KAAK,SAAS,SAAS,EACvB,KAAK,SAAS,SAAS,EAGzB,mBACEtuB,EACAuuB,EAA4C,CAAC,EAAG,EAAG,EAAG,CAAC,EACvDC,EAAUnC,GACVoC,EAAqB,IACrB,CACA,GAAI,CAAE,QAAAN,EAAS,QAAAC,EAAS,KAAArB,CAAS,OAEjC,GAAI,CAAC/sB,EACI,OAAE,KAAA+sB,EAAM,QAAAoB,EAAS,QAAAC,CAAQ,EAGlC,KAAM,CAAE,EAAA/uB,EAAG,EAAAC,EAAG,EAAA6G,EAAG,EAAAiC,CAAM,EAAApI,EACjB,CAAC0J,EAAIglB,EAAIC,EAAI5mB,CAAE,EAAIwmB,EACnB,CAAE,MAAA1kB,EAAO,OAAAC,CAAA,EAAW,KAE1B,OAAAijB,EAAO,KAAK,KACTljB,EAAQ4kB,GAAsBC,EAAK3mB,IAAO5B,GAC1C2D,EAAS2kB,GAAsB/kB,EAAKilB,IAAOvmB,CAC9C,EACA2kB,EAAO7sB,GAAM6sB,EAAMT,GAAUpsB,GAAMsuB,EAASlC,GAAUD,EAAQ,CAAC,EAE/D8B,EAAU9uB,GAAK8G,EAAIuoB,EAAK3B,GAAQ,EAAIhlB,EAAKglB,EAAO,EAChDqB,EAAU9uB,GAAK8I,EAAIumB,EAAK5B,GAAQ,EAAIrjB,EAAKqjB,EAAO,EAEzC,CAAE,KAAAA,EAAM,QAAAoB,EAAS,QAAAC,CAAQ,EAGlC,aAAankB,EAAc,CACzB,MAAM2kB,EAAiBjlB,GAAM,KAAK,KAAK,cAAc,EACrD,OACEilB,EAAe,SAAS3kB,CAAK,GAC7B2kB,EAAe,qBAAqB3kB,CAAK,EAI7C,UAAW,CACL,IAAC,KAAK,OAAQ,OAEb,KAAK,cACR,KAAK,YAAc,GACnB,KAAK,gBAAkB,KAAK,aAAa,EAAG,CAAC,GAG/C,KAAM,CAAE,KAAAF,EAAM,IAAAC,EAAK,MAAAH,EAAO,OAAAC,CAAA,EAAW,KAAK,mBACrC,wBAAqB,KAAK,OAAO,YAEtC,KAAK,MAAQC,EACb,KAAK,KAAOC,EACZ,KAAK,eAAe,KAAK,CACvB,KAAAD,EACA,IAAAC,EACA,MAAAH,EACA,OAAAC,CAAA,CACD,EASH,UAAUqkB,EAAiBC,EAAiBS,EAAc,GAAM,CAC1DA,GAAe,KAAK,aACtB,KAAK,qBAAqB,EAG5B,KAAK,QAAQ,EAAIV,EACjB,KAAK,QAAQ,EAAIC,EACZ,cAAS,KAAK,EAAI,EACvB,KAAK,gBAAgB,KAAK,CACxB,KAAM,KAAK,KACX,OAAQ3sB,EAAI,MAAM,KAAK,MAAM,EAC9B,EACD,KAAK,cAAc,EAGrB,QAAQsI,EAAcC,EAAaH,EAAeC,EAAgB,CAChE,GAAI,KAAK,YAAa,CACpB,KAAK,MAAQC,EACb,KAAK,KAAOC,EACZ,OAGF,KAAK,MAAQD,EACb,KAAK,KAAOC,EACZ,KAAK,YAAY,KAAK,CACpB,KAAAD,EACA,IAAAC,EACA,MAAAH,EACA,OAAAC,CAAA,CACD,EAUH,YACEglB,EACAC,EAAYttB,EAAI,MAAM,KAAK,MAAM,EACjCutB,EAAS,GACTH,EAAc,GACd,CAEIA,GAAe,KAAK,aACtB,KAAK,qBAAqB,EAG5B,MAAMI,EAAU,KAAK,MACrB,GAAID,EAAQ,CACV,MAAME,EAAaD,EAAUH,EAC7B,GAAII,IAAe,EACjB,KAAK,gBAAgBH,EAAU,CAAC,EAAGA,EAAU,CAAC,CAAC,MAC1C,CACL,MAAMjrB,EAAS,CAAC,KAAK,QAAS,KAAK,OAAO,EACpCqrB,EAAa1tB,EAAI,IACrBA,EAAI,IAAIstB,EAAWttB,EAAI,IAAIqC,EAAQorB,CAAU,CAAC,EAC9C,GAAK,EAAIA,EACX,EACA,KAAK,WAAWJ,EAASrtB,EAAI,QAAQ0tB,CAAU,CAAC,EAClD,MAEK,aAAQ,EAAIJ,EAAU,CAAC,EACvB,aAAQ,EAAIA,EAAU,CAAC,EAC5B,KAAK,QAAQD,EAAS,OAAW,GAAOD,CAAW,CACrD,CAYF,mBACE5kB,EACAskB,EAA4C,CAAC,EAAG,EAAG,EAAG,CAAC,EACvDS,EAAS,GACTH,EAAc,GACd,CACA,GAAI,CAACnlB,EAAIglB,EAAIC,EAAI5mB,CAAE,EAAIwmB,EAGnB7kB,EAAK,GAAKA,EAAK,OAAS,KAAK,QAC7BglB,EAAK,GAAKA,EAAK,OAAS,KAAK,OAC7BC,EAAK,GAAKA,EAAK,OAAS,KAAK,QAC7B5mB,EAAK,GAAKA,EAAK,OAAS,KAAK,OAGjC,IAAIglB,EAAO,KAAK,KACb,KAAK,OAAS2B,EAAK3mB,IAAOkC,EAAM,GAChC,KAAK,QAAUP,EAAKilB,IAAO1kB,EAAM,CACpC,EAGI,GAAA8iB,EAAO,KAAK,SAAU,CACxBA,EAAO,KAAK,SACZ,MAAMqC,EAAoB,KAAK,MAAQnlB,EAAM,EAAI8iB,EAC3CsC,EAAqB,KAAK,OAASplB,EAAM,EAAI8iB,EACnD2B,EAAK3mB,EAAK,KAAK,IAAIqnB,EAAoB,EAAG,CAAC,EAC3C1lB,EAAKilB,EAAK,KAAK,IAAIU,EAAqB,EAAG,CAAC,EAI1CtC,EAAO,KAAK,WACdA,EAAO,KAAK,UAGd,MAAMjpB,EAAS,CACbmG,EAAM,GAAKA,EAAM,EAAIykB,EAAK3B,GAAQ,EAAIhlB,EAAKglB,EAAO,EAClD9iB,EAAM,GAAKA,EAAM,EAAI0kB,EAAK5B,GAAQ,EAAIrjB,EAAKqjB,EAAO,CACpD,EAEA,KAAK,YAAYA,EAAMjpB,EAAQkrB,EAAQH,CAAW,EAIpD,gBAAgBnB,EAAiB,CAC/B,KAAK,OAASA,EACT,+BAA4BA,EAAG,sBAAsB,EAC1D,KAAK,mBAAqBA,EAAG,YAE7B,KAAM,CAAE,KAAA3jB,EAAM,IAAAC,EAAK,MAAAH,EAAO,OAAAC,CAAA,EAAW,KAAK,0BAC1C,KAAK,QAAQC,EAAMC,EAAKH,EAAOC,CAAM,EAEhC,qBAAkB,IAAI,eAAe,IAAM,CAC9C,KAAK,0BAA4B,KACjC,KAAK,mBAAqB,KAC1B,KAAK,SAAS,EACf,EACI,qBAAgB,QAAQ4jB,CAAE,EAUjC,QACEX,EACAoC,EACAG,EAAQ,GACRT,EAAc,GACd,CACIA,GAAe,KAAK,aACtB,KAAK,qBAAqB,EAG5B,MAAMU,EAAW,KAAK,KACtBJ,EAAcA,GAAc,KAAK,QACjC,KAAK,MAAQjvB,GAAM6sB,EAAM,KAAK,SAAU,KAAK,QAAQ,EACrD,MAAM+B,EAAU,KAAK,KAEfhuB,EAASW,EAAI,IAAIA,EAAI,MAAM,KAAK,MAAM,EAAGA,EAAI,MAAM0tB,CAAU,CAAC,EAC9DJ,EAAYttB,EAAI,IACpBA,EAAI,MAAM0tB,CAAU,EACpB1tB,EAAI,IAAIX,EAAQyuB,EAAWT,CAAO,CACpC,EACIQ,GACG,cAAS,KAAK,EAAI,EAEzB,KAAK,UAAUP,EAAU,CAAC,EAAGA,EAAU,CAAC,EAAGF,CAAW,EACtD,KAAK,gBAAgB,KAAK,CACxB,KAAM,KAAK,KACX,OAAQptB,EAAI,MAAM,KAAK,MAAM,EAC9B,EACD,KAAK,cAAc,EAGrB,gBAAgBpC,EAAWC,EAAWkwB,EAAW,GAAI,CAC7C,MAAE,OAAA1rB,GAAW,KACbuB,EAAQ,CAAE,EAAGhG,EAAIyE,EAAO,EAAG,EAAGxE,EAAIwE,EAAO,CAAE,EAC3C2rB,EAAuB,IAAM,CAC7B,KAAK,QAA6B,0BAAK,MAAM,EAC5C,YAAS,sBAAsB,IAAM,CAClC,MAAAhwB,EAAO,CAAE,EAAG4F,EAAM,EAAImqB,EAAU,EAAGnqB,EAAM,EAAImqB,CAAS,EACtDE,EAAa,CACjB,EAAG,KAAK,QAAUjwB,EAAK,EACvB,EAAG,KAAK,QAAUA,EAAK,CACzB,EACMkwB,EAAQtqB,EAAM,EAAI,EAAI,EAAI,GAC1BuqB,EAAQvqB,EAAM,EAAI,EAAI,EAAI,GAChCqqB,EAAW,EAAIvD,GAAOuD,EAAW,EAAGrwB,EAAGswB,CAAK,EAC5CD,EAAW,EAAIvD,GAAOuD,EAAW,EAAGpwB,EAAGswB,CAAK,EAC5C,KAAK,UAAUF,EAAW,EAAGA,EAAW,EAAG,EAAI,GAE3CA,EAAW,GAAKrwB,GAAKqwB,EAAW,GAAKpwB,IAAwBmwB,EAAA,EAClE,CACH,EACqBA,EAAA,EAGvB,WAAW1C,EAAcoC,EAAqBK,EAAW,GAAI,CACrD,MAAAnqB,EAAQ0nB,EAAO,KAAK,KACtB,KAAK,QAA6B,0BAAK,MAAM,EAEjD,MAAM8C,EAAkB,IAAM,CACvB,YAAS,sBAAsB,IAAM,CAClC,MAAA5nB,EAAO5C,EAAQ,EAAI,EAAI,GACvB5F,EAAO4F,EAAQmqB,EACfM,EAAW3D,GAAO,KAAK,KAAO1sB,EAAMstB,EAAM9kB,CAAI,EAEpD,KAAK,QAAQ6nB,EAAUX,EAAY,OAAW,EAAI,EAE9CW,GAAY/C,GAAsB8C,EAAA,EACvC,CACH,EACgBA,EAAA,EAGlB,aAAa5lB,EAAc,CACnB,MAAE,EAAA9D,EAAG,EAAAiC,CAAA,EAAM6B,EACX,CAAC5K,EAAGC,CAAC,EAAI,KAAK,aAAa2K,EAAM,EAAGA,EAAM,CAAC,EAE1C,WAAIN,GAAMtK,EAAGC,EAAG6G,EAAI,KAAK,KAAMiC,EAAI,KAAK,IAAI,EAGrD,aACE2nB,EACAC,EACAjD,EAAO,KAAK,KACZjpB,EACM,CACA,MAAE,UAAAkpB,GAAc,KAChBH,EAAY/oB,EACdA,EAAO,EAAI,KAAK,MAAQ,EAAIipB,EAC5B,KAAK,UACHD,EAAYhpB,EACdA,EAAO,EAAI,KAAK,OAAS,EAAIipB,EAC7B,KAAK,UAEF,OACLF,EAAYkD,EAAQhD,EAAOC,EAC3BF,EAAYkD,EAAQjD,EAAOC,CAC7B,EAGF,4BAA4B,CAAC3tB,EAAGC,CAAC,EAAe,CAC9C,OAAOotB,GAAmB,KAAM,CAACrtB,EAAGC,CAAC,CAAC,EAGxC,YAAY2K,EAAc,CAClB,MAAE,EAAA9D,EAAG,EAAAiC,CAAA,EAAM6B,EACX,CAAC5K,EAAGC,CAAC,EAAI,KAAK,YAAY2K,EAAM,EAAGA,EAAM,CAAC,EAEzC,WAAIN,GAAMtK,EAAGC,EAAG6G,EAAI,KAAK,KAAMiC,EAAI,KAAK,IAAI,EAGrD,YAAYilB,EAAgBC,EAAsB,CAChD,KAAM,CAAE,UAAAT,EAAW,UAAAC,EAAW,KAAAC,EAAM,UAAAC,CAAc,OAC3C,QACJK,EAASR,GAAaE,EAAOC,GAC7BM,EAASR,GAAaC,EAAOC,CAChC,EAGF,2BAA2B,CAAC3tB,EAAGC,CAAC,EAAe,CACvC,MAAE,KAAAyK,EAAM,IAAAC,CAAA,EAAQ,KACtB,MAAO,CAAC3K,EAAI0K,EAAMzK,EAAI0K,CAAG,EAG3B,iBAAkB,CAChB,OAAO,KAAK,UAAU,CACpB,KAAM,KAAK,KACX,IAAK,KAAK,IACV,UAAW,KAAK,UAChB,UAAW,KAAK,UAChB,KAAM,KAAK,KACX,UAAW,KAAK,UACjB,EAGH,kBAAkBimB,EAAiB,CAC7B,IACF,MAAMzrB,EAAS,KAAK,MAAMyrB,GAAU,IAAI,EACpC,MAAE,SAAUzrB,EACTA,EADyB,WAEzBzF,EAAO,CACN,qBAAM,yCAA0CA,CAAK,EACtD,KACT,CAEJ,CC/oBA,MAAMmxB,GAAuB3wB,GAAE,OAAO,CACpC,QAASA,GAAE,OAAO,CACpB,CAAC,EAEY4wB,GAAN,MAAMA,WAAuB5Q,EAAc,CAKhD,OAAgB,SAASW,EAA+C,CAChE,MAAA1b,EAAS0rB,GAAqB,MAAMhQ,CAAI,EACvC,WAAIiQ,GAAe3rB,CAAM,EAGzB,OAAOwK,EAA+B,CAC7C,OAAIA,aAAiBmhB,GACZ,KAAK,UAAYnhB,EAAM,QAEzB,GAGA,QAAkC,CAClC,OACL,KAAM,QACN,QAAS,KAAK,OAChB,EAEJ,EAvBamhB,GACK,MAAQ,OADbA,GAGK,KAAO,QAHlB,IAAMC,GAAND,GAyBM,MAAAE,GAA0B3Q,GAAmB0Q,EAAc,EC7BlEE,GAAyB/wB,GAAE,OAAO,CACtC,QAASA,GAAE,OAAO,EAClB,SAAUA,GAAE,MAAMA,GAAE,QAAQ,EAC5B,QAASA,GAAE,QAAQ,EACnB,WAAYA,GAAE,QAAQ,EAAE,SAAS,CACnC,CAAC,EAEYgxB,GAAN,MAAMA,WAAyBhR,EAAc,CAalD,YACEC,EACAsK,EACA0G,EACAC,EAAa,GACb,CACM,OAAE,QAAAjR,EAAS,EAEjB,KAAK,SAAWsK,EAChB,KAAK,QAAU0G,EACf,KAAK,WAAaC,CAAA,CAGpB,OAAgB,SAASvQ,EAAiD,CAClE,MAAE,QAAAV,EAAS,SAAAsK,EAAU,QAAA0G,EAAS,WAAAC,GAClCH,GAAuB,MAAMpQ,CAAI,EACnC,OAAO,IAAIqQ,GAAiB/Q,EAASsK,EAAU0G,EAASC,CAAU,EAG3D,OAAOzhB,EAA+B,CAC7C,OAAIA,aAAiBuhB,GAEjB,KAAK,UAAYvhB,EAAM,SACvB,KAAK,UAAYA,EAAM,SACvB,KAAK,aAAeA,EAAM,YAC1B,KAAK,SAAS,SAAWA,EAAM,SAAS,QACxC,KAAK,SAAS,MAAM,CAACqH,EAAI0P,IAAQ1P,IAAOrH,EAAM,SAAS+W,CAAG,CAAC,EAIxD,GAGT,SAAU,CACR,OAAO,KAAK,SAAS,SAAW,GAAK,CAAC,KAAK,QAGpC,QAAkC,CAClC,OACL,KAAM,UACN,QAAS,KAAK,QACd,SAAU,KAAK,SACf,QAAS,KAAK,QACd,WAAY,KAAK,UACnB,EAEJ,EA3DawK,GACK,MAAQ,MADbA,GAGK,KAAO,UAHZA,GAKK,YAAc,GALzB,IAAMG,GAANH,GA6DM,MAAAI,GAA4BjR,GAAmBgR,EAAgB,ECjE/DE,GAAY,CACvB,OAAS7uB,GAAmB,OAAOA,GAAU,SAC7C,OAASA,GAAmB,OAAOA,GAAU,SAC7C,QAAUA,GAAmB,OAAOA,GAAU,UAC9C,OAASA,GAAmB,OAAOA,GAAU,SAC7C,MAAQA,GAAmB,MAAM,QAAQA,CAAK,EAC9C,WAAa8uB,GAAgC9uB,GAC3CA,aAAiB8uB,EACnB,QAAUC,GAAkC/uB,GAC1C,MAAM,QAAQA,CAAK,GAAKA,EAAM,MAAM+uB,CAAS,EAC/C,SAAWA,GAAkC/uB,GACvC,OAAOA,GAAU,UAAYA,IAAU,KAAa,GACjD,OAAO,OAAOA,CAAK,EAAE,MAAM+uB,CAAS,EAE7C,GAAKA,GAAkC/uB,GAAmB+uB,EAAU/uB,CAAK,CAC3E,EAEA,SAASgvB,GACPC,EACAC,EACA,CACA,SAAW,CAACC,EAAUJ,CAAS,IAAK,OAAO,QAAQG,CAAS,EAAG,CAC7D,MAAM1gB,EAAM2gB,EACR,GAAAF,EAASzgB,CAAG,IAAM,OACpB,MAAM,IAAI7R,EACRF,EAAU,oBACV,YAAY0yB,CAAQ,mBAAmBF,EAAS,YAAY,IAAI,GAClE,EAEF,GAAIF,GAAa,CAACA,EAAUE,EAASzgB,CAAG,CAAC,EACvC,MAAM,IAAI7R,EACRF,EAAU,oBACV,YAAY0yB,CAAQ,kBAAkBF,EAAS,YAAY,IAAI,GACjE,CACF,CAEJ,CAEO,SAASG,GACdF,EACA,CACA,OAAO,SAAU9W,EAAsC,CAC/C,MAAAiX,EAAoBjX,EAAY,UAAU,kBAEpCA,EAAA,UAAU,kBAAoB,UAAY,CAChDiX,GACFA,EAAkB,KAAK,IAAI,EAE7BL,GAAkB,KAAME,CAAS,CACnC,CACF,CACF,CCzDA;AAAA;AAAA;AAAA;AAAA,GAkBO,SAASI,GACdC,EACG,CACH,MAAeD,UAAsBC,CAAK,CAG/B,mBAA0B,CACjC,MAAM,kBAAkB,EAGxB,KAAK,cAAc,EAGZ,sBAA6B,CA/B1C,IAAAzkB,EAgCM,MAAM,qBAAqB,GAC3BA,EAAA,KAAK,YAAL,MAAAA,EAAA,WAGO,eAAgB,CApC7B,IAAAA,EAwCM,GAAI,KAAK,kBAAoB,IAAS,KAAK,cAAgB,GACzD,QAGFA,EAAA,KAAK,YAAL,MAAAA,EAAA,WAIA,IAAI0kB,EAAgB,GAUf,eAAY3Y,GAAO,IAAM,CACxB2Y,GACcA,EAAA,GAChB,MAAM,cAAc,GAKpB,KAAK,cAAc,CACrB,CACD,EACH,CAEKF,QACT;;;;;;;;;;;;;;;;;;kjCC3CO,SAASG,GACdC,EACA,CACA,MAAMC,UAAqBD,CAAW,CAAtC,kCACY,kBAAe,IAAItT,EAAgB,CAE7C,IAAI,aAAc,CAChB,OAAO,KAAK,aAGL,mBAAoB,CAC3B,MAAM,kBAAkB,EACpB,KAAK,aAAa,WACf,kBAAe,IAAIA,GAC1B,CAGO,sBAAuB,CAC9B,MAAM,qBAAqB,EAC3B,KAAK,aAAa,QAAQ,EAC5B,CAEK,OAAAuT,CACT;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;yYC/CaC,GAAyC,QACzCC,GAA6C,UAC7CC,GAAuB,OAAO,gBAAgB,EAC9CC,GAAiB,iBACjBC,GAAgB;;;;ktCCLtB,MAAMC,WAA0BC,EAAW,CAehD,OAA0B,eACxBC,EACqB,CACf,MAAAC,EAAgB,MAAM,eAAeD,CAAM,EAGnC,OAAAC,EAAA,QAAS1xB,GAAyB,CAC9C,GAAIA,aAAa2xB,IAAa,OAAO,SAAa,IAAa,CAC7D,MAAMC,EAAY,SAAS,KACrBC,EAAQ,SAAS,cAAc,OAAO,EAC5CA,EAAM,YAAc7xB,EAAE,QACtB4xB,EAAU,OAAOC,CAAK,EACxB,CACD,EACMH,CAAA,CAGD,mBAAoB,CApC9B,IAAAtlB,EAAAC,EAqCI,MAAMylB,EAAK,KAAK,YACT,OAAAzlB,GAAAD,EAAA0lB,EAAG,eAAe,IAAIA,CAAE,IAAxB,cAA2B,IAAI,KAAK,YAAY,KAAhD,KAAsDzlB,EAAA,EAGvD,kBAAkB4E,EAAe,CAzC3C,IAAA7E,EA0CI,MAAM0lB,EAAK,KAAK,YAEXA,EAAG,eAAe,IAAIA,CAAE,GAC3BA,EAAG,eAAe,IAAIA,EAAI,IAAI,OAAS,GAGtC1lB,EAAA0lB,EAAA,eAAe,IAAIA,CAAE,IAAxB,QAA2B,IAAI,KAAK,cAAe7gB,CAAA,EAG5C,mBAA0B,CAnDrC,IAAA7E,EAoDI,MAAM,kBAAkB,EAClB,MAAA2lB,EAAa,KAAK,YAAY,EAC9BD,EAAK,KAAK,YACVE,EAAmBD,aAAsB,WACzCE,EAAqB,KAAK,kBAAkB,EAE9C,GAAAA,IAAuB,GAAKD,EAAkB,CAChD,MAAMN,EAAgBI,EAAG,cACnBI,EAAqC,CAAC,EAC9BR,EAAA,QAAS1xB,GAAyB,CAC9C,GAAIA,aAAa2xB,IAAa,OAAO,SAAa,IAAa,CACvD,MAAAE,EAAQ,SAAS,cAAc,OAAO,EAC5CA,EAAM,YAAc7xB,EAAE,QACtB+xB,EAAW,QAAQF,CAAK,EACxBK,EAAe,KAAKL,CAAK,EAC3B,CACD,EACIC,EAAG,kBAAkB,IAAIA,CAAE,GAC9BA,EAAG,kBAAkB,IAAIA,EAAI,IAAI,OAAS,GAE5C1lB,EAAA0lB,EAAG,kBAAkB,IAAIA,CAAE,IAA3B,MAA8B1lB,EAAA,IAAI2lB,EAAY,IAAM,CAClDG,EAAe,QAAQL,GAASA,EAAM,QAAQ,EAChD,EAEG,uBAAkBI,EAAqB,CAAC,EAGtC,kBAAmB,CACnB,YAGA,sBAA6B,CAnFxC,IAAA7lB,EAAAC,EAoFU,MAAA0lB,EAAa,KAAK,YAAY,EACpC,MAAM,qBAAqB,EAC3B,MAAMD,EAAK,KAAK,YACZ,IAAAG,EAAqB,KAAK,kBAAkB,EAChDA,IACA,KAAK,kBAAkBA,CAAkB,EAErCA,IAAuB,KAEzB5lB,GAAAD,EAAA0lB,EAAG,kBAAkB,IAAIA,CAAE,IAA3B,YAAA1lB,EAA8B,IAAI2lB,CAAlC,UAAA1lB,EAAA,EACF,CAEJ,CA5FaklB,GAGJ,mBAAqB,QAHjBA,GAQJ,sBAAwB,u/DCZjCY,GAAAC,GAAAhmB,GAAAimB,GAAAC,GAAAC,GAAAC,GA2Ba,MAAAC,GAAoC,QACpCC,GAA0C,MAEvDL,GAAA,CAAC3B,GAAmB,CAClB,MAAOP,GAAU,WAAWlI,EAAK,EACjC,IAAKkI,GAAU,MACjB,CAAC,GACM,MAAMwC,WAAmBvmB,GAAAwkB,GAC9BG,GAAeQ,EAAiB,CAClC,EAmJEa,GAAA,CAACQ,GAAQ,CAAE,QAASH,GAAc,EACjCI,EAAS,CAAE,UAAW,EAAO,IAG9BV,IAACS,GAAQ,CAAE,QAASF,GAAY,EAC/BG,EAAS,CAAE,UAAW,GAAO,GA1JAzmB,GAE9B,CAFK,kCAYY,kBAAgBqL,GAAsC,CAC/D,MAAE,QAAAX,GAAYW,EACd5B,EAAQ,KAAK,MAAM,SAAS4B,EAAM,EAAE,EAC1C,GAAI,CAAC5B,GAASA,EAAM,gBAAkB,SACpC,OAAOid,KAAOC,EAAO,GAEvB,MAAM5b,EAAS,KAAK,MAAM,OAAO,iBAAiB,IAAIL,CAAO,EACvDkc,EAAO,KAAK,IAAI,QAAQlc,CAAO,EACjC,IAACK,GAAU,CAAC6b,EACN,oBAAK,8BAA8Blc,CAAO,GAAG,EAC9Cgc,KAAOC,EAAO,GAGvB,MAAME,EAAc,KAAK,IAAI,SAAS,OAAO7H,EAAoB,EAC3D8H,EAAU,MAAM,KAAKD,EAAY,QAAS,GAAE,OAChD,CAACE,EAAS,CAACrjB,EAAKsjB,CAAG,IAAM,CACvB,KAAM,CAACC,EAAezd,CAAE,EAAI9F,EAAI,MAAM,GAAG,EACzC,GAAIujB,IAAkBvc,EAAS,CACvB,MAAAwc,EAAWR,MAAQM,CAAG,IAAIG,GAAalC,EAAc,CAAC,IAAIzb,CAAE,MAAMwd,CAAG,IAC3ED,EAAQvd,CAAE,EAAI0d,CAAA,CAET,OAAAH,CACT,EACA,EACF,EAEMC,EAAM,OAAOJ,GAAS,WAAaA,EAAKvb,CAAK,EAAIub,EACvD,OAAOF,MAAQM,CAAG;AAAA,QACdG,GAAajC,EAAa,CAAC,IAAI7Z,EAAM,EAAE;AAAA,iBAC9Byb,CAAO;AAAA,kBACNrd,EAAM,aAAa;AAAA,SAC5Bud,CAAG,GACV,EAEiB,qBACf3b,EACA+b,IAEOV,KAAOW,GACZhc,EAAM,SAAS,OAAO+b,IAAW,IAAM,GAAK,KACnCpS,EAAM,GACfA,GAAS,KAAK,aAAaA,CAAK,EACjC,GAiGHsS,GAAA,KAASnB,GAAToB,GAAArB,GAAA,SAAAqB,GAAArB,GAAA,SAIAoB,GAAA,KAASlB,GAATmB,GAAArB,GAAA,UAAAqB,GAAArB,GAAA,SAlGA,IAAI,SAA0B,CAC5B,OAAO,KAAK,IAAI,QAGlB,IAAI,OAA2B,CAC7B,OAAO,KAAK,IAAI,MAGlB,IAAI,OAAsB,CACxB,OAAO,KAAK,IAAI,MAGlB,IAAI,WAAqC,CACvC,OAAO,KAAK,IAAI,UAGlB,IAAI,MAAkB,CACpB,OAAO,KAAK,IAAI,KAGT,mBAAoB,CAGvB,GAFJ,MAAM,kBAAkB,EAEpB,CAAC,KAAK,MAAM,KACd,MAAM,IAAIr0B,EACRF,EAAU,iBACV,oHACF,EAGF,KAAK,IAAI,MAAM,EACf,KAAK,SAAW,EAGT,sBAAuB,CAC9B,MAAM,qBAAqB,EAC3B,KAAK,IAAI,QAAQ,EAGnB,MAAe,mBAAsC,CAC/C,IACI,MAAAgG,EAAS,MAAM,MAAM,kBAAkB,EACvC6f,EAAY,KAAK,MAAM,KACzB,IAACA,EAAkB,OAAA7f,EAEvB,MAAMivB,EAAO,KAAK,IAAI,QAAQpP,EAAU,OAAO,EAC3C,IAACoP,EAAa,OAAAjvB,EAEZ,MAAAkvB,EAAc,KAAK,IAAI,SAAS,OACpC7H,GAAqBxH,EAAU,OAAO,CACxC,EACMgQ,EAAa,OAAO,QAAQX,CAAW,EAAE,OAC7C,CAACE,EAAS,CAACrjB,EAAKsjB,CAAG,IAAM,CACvB,KAAM,CAACC,EAAezd,CAAE,EAAI9F,EAAI,MAAM,GAAG,EACrC,OAAAujB,IAAkBzP,EAAU,UAC9BuP,EAAQvd,CAAE,EAAIwd,GAETD,CACT,EACA,EACF,EACMU,EAA8B,CAClC,OAAOb,GAAS,WAAaA,EAAKpP,CAAS,EAAIoP,EAC/C,GAAG,OAAO,OAAOY,CAAU,CAC7B,EACA,aAAM,QAAQ,IACZC,EAAa,IAAWT,GAAA,CACtB,MAAMjvB,EAAU,KAAK,WAAW,cAAcivB,EAAI,YAAY,EAC9D,OAAIjvB,aAAmBqtB,GACdrtB,EAAQ,eAEV,IACR,EACH,EACOJ,QACAgF,EAAG,CACV,OAAIA,aAAa,MACf1K,GAAY0K,CAAC,EAEb,QAAQ,MAAMA,CAAC,EAEV,GACT,CAGO,QAAS,CACV,MAAE,KAAAuJ,GAAS,KAAK,MAClB,OAACA,EAEE,KAAK,aAAaA,CAAI,EAFXygB,EAEW,CAUjC,CA5JOT,GAAAwB,GAAA1nB,EAAA,EAuJImmB,GAAA,YAIAC,GAAA,YAJTuB,GAASzB,GAAA,UAFTF,GArJWO,GAuJFJ,EAAA,EAITwB,GAASzB,GAAA,QAFTH,GAzJWQ,GA2JFH,EAAA,EA3JEG,GAANoB,qBAJP1B,GAIaM,EAAA,EAAAA,GAGK,OAASqB;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA,IAHpBL,GAAMrB,GAAA,EAAAK,EAAA,i/DClCbsB,GAAAC,GAAA9B,GAAA+B,GAAAC,GAAAC,GAAAjoB,GAAA+lB,GAAA9lB,GAAAioB,GAAAhC,GAAAE,GAAA+B,GAAAC,GAAAC,GAAAlC,GAAAmC,GAAAC,GA0BAL,GAAA,CAAC5D,GAAmB,CAClB,MAAOP,GAAU,WAAWlI,EAAK,EACjC,IAAKkI,GAAU,OACf,QAASA,GAAU,SAASA,GAAU,MAAM,CAC9C,CAAC,GACY,MAAAyE,WAIHvoB,MAAc0kB,GAAeQ,EAAiB,CAAC,EACvDY,GAAA,CAAC0C,GAAQ,CAAE,QAASnC,EAAY,EAW/B,EAAAtmB,GAAAglB,GAwODiD,GAAC,CAAAzB,GAAQ,CAAE,QAAS1B,GAAuB,EAC1CrR,IAAM,EAGPuU,GAAC,CAAAvU,MAODsU,GAAC,CAAAvB,GAAQ,CAAE,QAASzB,GAAyB,EAC5CtR,GAGD,GAAAuS,GAAA,CAACyC,GAAQ,CAAE,QAASpC,GAAc,CAGlC,EAAAyB,GAAA,CAACrB,EAAS,CAAE,UAAW,GAAO,CAG9B,EAAAoB,GAAA,CAACpB,EAAS,CACR,UAAW,GACX,WAAWvxB,EAAOwzB,EAAU,CACtB,OAACxzB,GAAS,CAACwzB,EACNxzB,IAAUwzB,EAGf,CAAC,OAAO,KAAKxzB,CAAK,EAAE,QAAU,CAAC,OAAO,KAAKwzB,CAAQ,EAAE,OAChD,GAEFxzB,IAAUwzB,CAAA,CAErB,CAAC,GArROzoB,GAAiD,CAJpD,kCAMLqnB,GAAA,KAASlB,GAATmB,GAAArB,GAAA,SAAAqB,GAAArB,GAAA,SAEA,eAAY3c,GAAS,IAAM,CACzB,MAAM6J,EAAY,KAAK,IAAI,UAAU,MAAM,KACzCA,GAAU,CAzChBpT,MAyCmB,OAAAoT,EAAU,YAAYpT,EAAA,KAAK,QAAL,YAAAA,EAAY,IACjD,EACI,OAACoT,EACEA,EAAU,GAAGmQ,EAAc,EADX,EACW,CACnC,EAED,KAACvjB,EAAwB,KAEX,kBACZiM,EACAlM,EACA/N,IACG,CArDPgO,MAsDI,KAAK,aAAa,IAChB,KAAK,IAAI,MAAM,IAAIiM,EAAMlM,EAAS,CAChC,QAAkB/N,GAAA,OACd,OACAA,GAAS,SACPgO,EAAA,KAAK,QAAL,KAAAA,SAAY,QACZ,OACN,QAAkBhO,GAAA,QAAmBA,GAAA,QAAU,OAAY,KAAK,OACjE,EACH,CACF,EAyNiBs1B,GAAA,KAAAa,GAAuBZ,GAAxCrB,GAAA,QAAwC,IAAxC,GAAAqB,GAAArB,GAAA,SAGmBoB,GAAA,KAAAc,GAAmDb,GAAtErB,GAAsE,SACpE,KAAK,YACL,KAAK,qBACL,KAAK,eAHP,IAAAqB,GAAArB,GAAA,SAQiBoB,GAAA,KAAAe,GAA2Bd,GAA5CrB,GAAA,QAA4C,IAA5C,GAAAqB,GAAArB,GAAA,SAGAoB,GAAA,KAASnB,GAAToB,GAAArB,GAAA,UAAAqB,GAAArB,GAAA,SAGSoB,GAAA,KAAAgB,GAA0Bf,GAAnCrB,GAAA,QAAmC,SAAnC,GAAAqB,GAAArB,GAAA,SAeAoB,GAAA,KAASiB,GAAThB,GAAArB,GAAA,UAAAqB,GAAArB,GAAA,SAvPA,IAAI,SAAU,CACZ,OAAO,KAAK,QAAQ,QAGtB,IAAI,aAAc,CAET,OADa,KAAK,MAAM,SAE5B,IAAalR,GACL,KAAK,IAAI,KAAK,SAASA,EAAM,EAAE,CACvC,EACA,OAAQxiB,GAA2B,CAAC,CAACA,CAAC,EAG3C,IAAI,SAAkB,CACpB,OAAO,KAAK,MAAM,QAGpB,IAAI,MAAO,CACT,OAAO,KAAK,IAAI,KAGlB,IAAI,mBAAoB,CAChB,MAAAuY,EAAS,KAAK,MAAM,OAAO,iBAAiB,IAAI,KAAK,MAAM,OAAO,EACxE,GAAI,CAACA,EACK,oBACN,8BAA8B,KAAK,MAAM,EAAE,aAAa,KAAK,MAAM,OAAO,EAC5E,EACO,GAET,MAAM4d,EAAkB5d,EAAO,QACzB6d,EAAgB,KAAK,MAAM,QACjC,OAAID,IAAoBC,GACd,aACN,8BAA8B,KAAK,MAAM,EAAE,cAAcD,CAAe,YAAYC,CAAa,EACnG,EACO,IAGF,GAGT,IAAI,OAAQ,CACV,GAAI,KAAK,OACP,OAAO,KAAK,OAEd,MAAMvd,EAAQ,KAAK,MAAM,aAAoB,KAAK,OAAO,EACzD,GAAI,CAACA,EACH,MAAM,IAAIxZ,EACRF,EAAU,sBACV,kCAAkC,KAAK,OAAO,EAChD,EAEF,YAAK,OAAS0Z,EACPA,CAAA,CAGT,IAAI,iBAAyC,CACrC,MAAAxF,EAAS,KAAK,MAAM,OACtB,OAACA,EACE,KAAK,IAAI,KAAK,SAASA,EAAO,EAAE,EADnB,IACmB,CAGzC,IAAI,gBAAiB,CACnB,OAAO,KAAK,KAAK,eAAe,KAAK,IAAI,EAG3C,IAAI,eAAuC,CApI7C7F,MAqII,MAAM6Z,GAAS7Z,EAAA,KAAK,MAAM,OAAX,YAAAA,EAAiB,GAChC,GAAI,CAAC6Z,EACI,YAET,MAAMgP,EAAgB,KAAK,IAAI,KAAK,SAAShP,CAAM,EACnD,OAAOgP,GAAiB,KAG1B,IAAI,WAAY,CACd,OAAO,KAAK,IAAI,UAGlB,IAAI,SAAmB,CACrB,GAAI,KAAK,SACP,OAAO,KAAK,SAER,MAAAta,EAAU,KAAK,IAAI,YACvBoQ,GAAuB,KAAK,MAAM,OAAO,CAC3C,EACA,YAAK,SAAWpQ,EACTA,CAAA,CAGT,IAAI,2BAAmD,CACrD,OAAO,KAAK,cAGd,IAAI,kBAAiE,CACnE,OAAO,OAAO,KAAK,KAAK,OAAO,EAAE,OAC/B,CAACwY,EAASrjB,KAAS,CACjB,GAAGqjB,EACH,CAACrjB,CAAG,EAAG,KAAK,IAAI,KAAK,UAAUA,EAAK,KAAK,OAAO,IAElD,EACF,EAGM,qBAAqBzB,EAAkB,CACtC,OAAA6mB,GACL,KAAK,kBACL,IAAM,CA7KZ9oB,MA8Kc,MAAA4oB,EAAgB,KAAK,MAAM,QAC3B7d,EAAS,KAAK,MAAM,OAAO,iBAAiB,IAChD,KAAK,MAAM,OACb,EACM4d,GAAkB3oB,EAAQ+K,GAAA,UAAR,KAAA/K,EAAmB,GACpC,YAAK,sBAAsB2oB,EAAiBC,CAAa,CAClE,EACA,IAAM3mB,CACR,EAGM,gBAAgBA,EAAkB,CACjC,OAAA8mB,GAAO,KAAK,SAAU,CAC3B,CAAC,UAAW,IAAM9mB,CAAO,EACzB,CAAC,SAAU,IAAM0kB,EAAO,EACxB,CAAC,SAAU,IAAM,KAAK,eAAe,KAAK,KAAK,CAAC,EACjD,EAGH,YAAYqC,EAAyC,CAC9C,gBAAW,KAAKA,CAAQ,EAG/B,WACEC,EACAj3B,EACA,CACA,MAAM8Z,EAAU,KAAK,IAAI,MAAM,WAAWmd,EAAQ,CAChD,WAAkB,OACd,UACS,QACP,KAAK,MAAM,QACX,OACN,QAAkBj3B,GAAA,QAAmBA,GAAA,QAAU,OAAY,KAAK,QACjE,EACI,yBAAa,IAAI8Z,CAAO,EACtBA,CAAA,CAGA,mBAAoB,CAC3B,MAAM,kBAAkB,EAEnB,SAAI,KAAK,SAAS,IAAI,EAE3B,MAAM4F,EAAa,KAAK,IAAI,MAAM,MAAM,aAAa,UACnD,CAAC,CAAE,KAAAxM,EAAM,GAAAsE,KAAS,CACZA,IAAO,KAAK,MAAM,IAAMtE,IAAS,WAC9B,SAAI,KAAK,YAAY,IAAI,EAC9BwM,EAAW,YAAY,EACzB,CAEJ,EACK,kBAAa,IAAIA,CAAU,EAEhC,KAAK,aAAa,IAChB,KAAK,MAAM,aAAa,UAAU,IAAM,CACtC,KAAK,cAAc,CACpB,EACH,EAGF,MAAyB,mBAAsC,CACvD,MAAA/Z,EAAS,MAAM,MAAM,kBAAkB,EACvC,qBAAQ,IAAI,KAAK,YAAY,IAAUkpB,KAAG,cAAc,CAAC,EACxDlpB,CAAA,CAGA,QAAS,CAChB,OAAO,KAAK,WAAW,OACrB,CAAC4O,EAAK2iB,IAAQA,EAAI,KAAK,KAAM3iB,CAAG,EAChCogB,EACF,EAGF,aAAuB,CACd,OAAAA,EAAA,CAST,sBACEgC,EACAC,EACgB,CACT,OAAAlC;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA,0CAO+B,KAAK,MAAM,OAAO;AAAA;AAAA;AAAA,oCAGxBiC,CAAe;AAAA,kCACjBC,CAAa;AAAA;AAAA;AAAA,MAyC/C,CA3RO1C,GAAAwB,GAAAznB,EAAA,EAMImmB,GAAA,YAoPQ+B,GAAA,YAGEC,GAAA,YAQFC,GAAA,YAGRlC,GAAA,YAGAmC,GAAA,YAeAC,GAAA,YApRTZ,GAASzB,GAAA,QADTH,GALWyC,GAMFpC,EAAA,EAoPTuB,GAAiBzB,GAAA,WAFjB+B,GAxPWO,GA0PML,EAAA,EAGjBR,GAAmBzB,GAAA,eADnB8B,GA5PWQ,GA6PQJ,EAAA,EAQnBT,GAAiBzB,GAAA,aAFjB6B,GAnQWS,GAqQMH,EAAA,EAGjBV,GAASzB,GAAA,UADTF,GAvQWwC,GAwQFrC,EAAA,EAGTwB,GAASzB,GAAA,aADT4B,GA1QWU,GA2QFF,EAAA,EAeTX,GAASzB,GAAA,YAbT2B,GA7QWW,GA0RFD,EAAA,EA1REC,GAANb,yBALPO,GAKaM,EAAA,EAANjB,GAAMrB,GAAA,EAAAsC,EAAA,EC/Bb,IAAAxoB,GAAAC,GAgBO,SAASkpB,GACdpxB,EAC8B,CAC9B,WAAwCqxB,EAAsB,MAChE,CAEa,MAAAA,GAAmB,OAAO,YAAY,EAEnD,SAASC,GAAgBtxB,EAA4B,CAC/C,GAAAA,EAAQ,gBAAgB,QAAU,OAAQ,OAExC,MAAE,SAAA+nB,GAAa/nB,EAAQ,IACrBA,EAAA,QAAQ,cAAgB+nB,EAAS,gBAAgB,EACzD/nB,EAAQ,MAAM,gBAAkB,MACxBA,EAAA,MAAM,UAAYA,EAAQ,gBAAgB,CACpD,CAEA,SAASuxB,GAAsB1C,EAAyB,CAClDA,EAAK,gBAAgB,QAAU,UACjCA,EAAK,MAAM,WAAa,UACxBA,EAAK,MAAM,cAAgB,OACtBA,EAAA,UAAU,OAAO,YAAY,EAC7BA,EAAA,UAAU,IAAI,cAAc,IAEjCA,EAAK,MAAM,WAAa,SACxBA,EAAK,MAAM,cAAgB,OACtBA,EAAA,UAAU,OAAO,cAAc,EAC/BA,EAAA,UAAU,IAAI,YAAY,EAEnC,CAEA,SAAS2C,GAAoBpF,EAA6B,CACxDA,EAAS,MAAM,SAAW,WAE1BA,EAAS,YAAY,IACnBA,EAAS,IAAI,SAAS,gBAAgB,UAAU,IAAM,CACpDkF,GAAgBlF,CAAQ,CACzB,EACH,EAEAA,EAAS,YAAY,IACnBA,EAAS,MAAM,MAAM,aAAa,UAAU,CAAC,CAAE,KAAAjf,EAAM,GAAAsE,KAAS,CACxDA,IAAO2a,EAAS,MAAM,IAAMjf,IAAS,UACvCmkB,GAAgBlF,CAAQ,CAE3B,EACH,EAEAA,EAAS,YAAY,IACnBpY,GAAO,IAAM,CACXud,GAAsBnF,CAAQ,EAC9BkF,GAAgBlF,CAAQ,CACzB,EACH,CACF,CAEsB,MAAAqF,WAKZvpB,GAGPuoB,GAAAxoB,GAAAopB,GAHOnpB,GAEV,CAPO,kCAQL,KAACD,EAAoB,KAEZ,qBAAkBV,GAA0B,QAAQ,EAW7D,gBAAa,CAAC,CAAE,GAAA9B,EAAI,GAAAC,EAAI,aAAAgsB,KAAoC,CAC1D,KAAK,MAAM,KAAOA,EAAa,UAAUjsB,EAAIC,CAAE,EAAE,UAAU,CAC7D,EAXA,IAAI,KAAM,CACD,YAAK,IAAI,IAAI4hB,EAAuB,EAGpC,mBAA0B,CACjC,MAAM,kBAAkB,EACxBkK,GAAoB,IAAI,EAO1B,aAAc,CACP,WAAM,MAAM,MAAM,EAGzB,WAAY,CACL,WAAM,IAAI,MAAM,EAGvB,cAAcp1B,EAAwB,EAEtC,iBAAkB,CACV,MAAA2rB,EAAW,KAAK,IAAI,SACpB,CAAE,WAAA4J,EAAY,WAAAC,EAAY,KAAAzJ,CAAS,EAAAJ,EACnC1iB,EAAQN,GAAM,YAAY,KAAK,MAAM,IAAI,EAEzC8sB,EAAUxsB,EAAM,EAAI8iB,EACpB2J,EAAUzsB,EAAM,EAAI8iB,EACpBsB,EAASoI,EAAUxsB,EAAM,EACzBqkB,EAASoI,EAAUzsB,EAAM,EAE/B,MAAO,aAAassB,EAAalI,CAAM,OAAOmI,EAAalI,CAAM,aAAavB,CAAI,IAGpF,kBAAmB,CACX,MAAE,MAAA4J,GAAU,KAAK,MAEvB,GAAI,CAACA,EACH,MAAM,IAAIj4B,EACRF,EAAU,qBACV,uBAAuB,KAAK,MAAM,OAAO,mDAC3C,EAGI,MAACa,EAAGC,EAAG6G,EAAGiC,CAAC,EAAI,KAAK,MAAMuuB,EAAM,KAAK,EAEpC,OAAE,EAAAt3B,EAAG,EAAAC,EAAG,EAAA6G,EAAG,EAAAiC,EAAG,OAAQ,KAAK,UAAW,EAGtC,aAAc,CACf,MAAE,EAAA/I,EAAG,EAAAC,EAAG,EAAA6G,EAAG,EAAAiC,EAAG,OAAAwuB,CAAO,EAAI,KAAK,iBAAiB,EAEjD,YAAK,MAAM,OAAS,GAAGv3B,CAAC,OAAW,WAAM,KAAO,GAAGA,CAAC,MACpD,KAAK,MAAM,MAAQ,GAAGC,CAAC,OAAW,WAAM,IAAM,GAAGA,CAAC,MAClD,KAAK,MAAM,QAAU,GAAG6G,CAAC,OAAW,WAAM,MAAQ,GAAGA,CAAC,MACtD,KAAK,MAAM,SAAW,GAAGiC,CAAC,OAAW,WAAM,OAAS,GAAGA,CAAC,MACxD,KAAK,MAAM,SAAWwuB,IAAQ,KAAK,MAAM,OAASA,GAE/C,KAAK,eAAe,EAG7B,gBAA0B,CACjB,OAAApD,EAAA,CAGT,mBAA6B,CACpB,OAAAA,EAAA,CAGT,MAAe,gBAAiB,CAC9B,MAAM9gB,EAAS,KAAK,cAEpB,OAAI,KAAK,YAAc,CAACA,GAAU,EAAE,2BAA4BA,GACvD,MAAM,eAAe,GAE5B,MAAOA,EAAO,uBACZ,KAAK,MAAM,EACb,EAEO,MAAM,eAAe,EAC9B,CAGF,UAAmB,CAzKrB7F,MA0KWA,SAAA,KAAK,IAAI,MAAM,UAAU,KAAK,KAAK,EAAE,aAArC,KAAAA,EAAmD,IAG5D,cAAqB,CACd,WAAM,OAAS,KAAK,SAAS,EAEtC,CAEO,SAASgqB,GAKdC,EAAgB,CAvLlB,IAAAjqB,EAAAC,EAyLE,OAAO,cAAcA,EAAAgqB,EAClBjqB,EAAAopB,GADkBnpB,EAAY,CAA1B,kCACL,KAACD,CAAoB,KAEZ,qBAAkBV,GAA0B,QAAQ,EAEpD,eAAYiK,GAAS,IAAM,CAClC,MAAM6J,EAAY,KAAK,IAAI,UAAU,MAAM,KACzCA,GAAU,CAhMlBpT,MAgMqB,OAAAoT,EAAU,YAAYpT,EAAA,KAAK,QAAL,YAAAA,EAAY,IACjD,EACI,OAACoT,EACEA,EAAU,GAAGyQ,EAAgB,EADb,EACa,CACrC,EAED,WAAW,CAAE,GAAArmB,EAAI,GAAAC,EAAI,aAAAgsB,GAAiC,CACpD,KAAK,MAAM,KAAOA,EAAa,UAAUjsB,EAAIC,CAAE,EAAE,UAAU,EAG7D,aAAc,CACP,WAAM,MAAM,MAAM,EAGzB,WAAY,CACL,WAAM,IAAI,MAAM,EAGvB,cAActJ,EAAwB,EAEtC,IAAI,KAAM,CACD,YAAK,IAAI,IAAIkrB,EAAuB,EAGpC,mBAA0B,CACjC,MAAM,kBAAkB,EACxBkK,GAAoB,IAAI,EAI1B,iBAAkB,CACV,MAAAzJ,EAAW,KAAK,IAAI,SACpB,CAAE,WAAA4J,EAAY,WAAAC,EAAY,KAAAzJ,CAAS,EAAAJ,EACnC1iB,EAAQN,GAAM,YAAY,KAAK,MAAM,IAAI,EAEzC8sB,EAAUxsB,EAAM,EAAI8iB,EACpB2J,EAAUzsB,EAAM,EAAI8iB,EACpBsB,EAASoI,EAAUxsB,EAAM,EACzBqkB,EAASoI,EAAUzsB,EAAM,EAE/B,MAAO,aAAassB,EAAalI,CAAM,OAAOmI,EAAalI,CAAM,aAAavB,CAAI,IAIpF,kBAME,CACM,MAAE,MAAA4J,GAAU,KAAK,MAEvB,GAAI,CAACA,EACH,MAAM,IAAIj4B,EACRF,EAAU,qBACV,uBAAuB,KAAK,MAAM,OAAO,mDAC3C,EAGI,MAACa,EAAGC,EAAG6G,EAAGiC,CAAC,EAAI,KAAK,MAAMuuB,EAAM,KAAK,EAEpC,OAAE,EAAAt3B,EAAG,EAAAC,EAAG,EAAA6G,EAAG,EAAAiC,EAAG,OAAQ,KAAK,UAAW,EAGtC,aAAc,CACf,MAAE,EAAA/I,EAAG,EAAAC,EAAG,EAAA6G,EAAG,EAAAiC,EAAG,OAAAwuB,CAAO,EAAI,KAAK,iBAAiB,EAEhD,kBAAM,KAAO,GAAGv3B,CAAC,KACjB,WAAM,IAAM,GAAGC,CAAC,KACrB,KAAK,MAAM,MAAQ,OAAO6G,GAAM,SAAW,GAAGA,CAAC,KAAOA,EACtD,KAAK,MAAM,OAAS,OAAOiC,GAAM,SAAW,GAAGA,CAAC,KAAOA,EACvD,KAAK,MAAM,OAASwuB,EAEb,KAAK,eAAe,EAG7B,gBAA0B,CACxB,OAAO,KAAK,kBAAkB,EAGhC,mBAAoB,CAClB,OAAO,MAAM,YAAY,EAI3B,MAAe,gBAAiB,CAC9B,MAAMlkB,EAAS,KAAK,cAEpB,OAAI,KAAK,YAAc,CAACA,GAAU,EAAE,2BAA4BA,GACvD,MAAM,eAAe,GAE5B,MAAOA,EAAO,uBACZ,KAAK,MAAM,EACb,EAEO,MAAM,eAAe,EAC9B,CAGF,UAAmB,CApSvB7F,MAqSaA,SAAA,KAAK,IAAI,MAAM,UAAU,KAAK,KAAK,EAAE,aAArC,KAAAA,EAAmD,IAG5D,cAAqB,CACd,WAAM,OAAS,KAAK,SAAS,EAEtC,CAGF,g/DC9SAkqB,GAAAC,GAAAC,GAAAC,GAAAC,GAAAtqB,GAAAuqB,GAAArE,GAAAsE,GAAAC,GAAAC,GAAAC,GAAAC,GAkBgB,SAAAC,GAEdC,EAAS/yB,EAA0B,CACnC,IAAIgzB,EACAC,EAAwB,CAAC,EAE7B,MAAQ,IAAIhb,IAAoB,CACjBgb,EAAAhb,EAET+a,IAAU,SACZA,EAAQ,sBAAsB,IAAM,CAC1BA,EAAA,QAEJ,CAAChzB,GAAWA,EAAQ,cACtB+yB,EAAK,GAAGE,CAAU,CACpB,CACD,EAEL,CACF,CAEAT,GAAA,CAACjG,GAAmB,CAClB,SAAUP,GAAU,WAAWrD,EAAQ,CACzC,CAAC,GACM,MAAMuK,WAA2BjrB,GAAe2kB,GAAAQ,EAAiB,EAgJtEmF,GAAA,CAAC7D,EAAS,CAAE,UAAW,EAAM,CAAC,GAI9B4D,GAAC,CAAA5D,EAAS,CAAE,UAAW,GAAO,CAG9B,EAAA2D,GAAA,CAAC3D,EAAS,CAAE,KAAM,OAAQ,GAG1B0D,GAAC,CAAA1D,EAAS,CAAE,UAAW,EAAO,IAG9ByD,IAACzD,EAAS,CAAE,UAAW,EAAO,IA7JQzmB,GAAkC,CAAnE,kCA0BL,KAAiB,+BAAiC,IAAM,CAClD,IAAC,KAAK,KAAM,OAEhB,MAAMkrB,EAAM,KAAK,KAAK,IAAI,IAAI7L,EAAuB,EAC/C8L,EAAwB,KAAK,oBAAoB,EACjDC,EAAwB,KAAK,mBAAmB,EAChDC,MAAsB,IAAI,CAC9B,GAAGF,EACH,GAAGC,CAAA,CACJ,EAEKE,EAAkB,KAAK,mBACzB,IAAI,IAAI,KAAK,kBAAkB,EAC/B,IAAI,IAERC,GAAM,IAAM,CAEVF,EAAgB,QAAiBhgB,GAAA,CAC/B,MAAMub,EAAOsE,EAAI,KAAK,IAAI7f,CAAK,EAC1B8d,GAAoBvC,CAAI,IAC7BA,EAAK,gBAAgB,MAAQ,UAC9B,EAGD0E,EAAgB,QAAiBjgB,GAAA,CAC3B,GAAAggB,EAAgB,IAAIhgB,CAAK,EAAG,OAEhC,MAAMub,EAAOsE,EAAI,KAAK,IAAI7f,CAAK,EAC1B8d,GAAoBvC,CAAI,IAC7BA,EAAK,gBAAgB,MAAQ,QAC9B,EACF,EAED,KAAK,mBAAqByE,CAC5B,EAEA,KAAQ,mBAAR,OAEA,KAAiB,wBAGX,CAAC,EAEU,sBAAmBR,GAA+B,IAAM,CACvE,KAAK,+BAA+B,GACnC,IAAI,EAEP,KAAQ,sBAAwB,GA0BhC,4BAA2BrhB,GAAe,CACxC,KAAM,CAAE,QAAAgiB,EAAS,QAAAjsB,GAAY,QAAQ,cAAoB,EAIrD,GAFJ,KAAK,wBAAwB,KAAK,CAAE,GAAAiK,EAAI,QAAAjK,EAAS,EAE7C,CAAC,KAAK,sBAAuB,CAC/B,KAAK,sBAAwB,GAC7B,MAAMksB,EAAW,IAAM,CACjB,KAAK,wBAAwB,SACR,KAAK,wBAAwB,OAClD,EACA,KAAK,oBACP,EAEe,QAAQ,CAAC,CAAE,QAAAlsB,CAAQ,IAAMA,GAAS,EAE7C,KAAK,wBAAwB,OAC/B,sBAAsB,IAAM,CAC1B,KAAK,aAAeksB,EAAS,EAC9B,EAED,KAAK,sBAAwB,GAGnC,EAEA,sBAAsB,IAAM,CAC1B,KAAK,aAAeA,EAAS,EAC9B,EAGI,OAAAD,CACT,EAcAlE,GAAA,KAASkD,GAAuDjD,GAAhErB,GAAA,OAAgE,IAC9D,IAAI,GADN,GAAAqB,GAAArB,GAAA,SAIAoB,GAAA,KAASmD,GAATlD,GAAArB,GAAA,UAAAqB,GAAArB,GAAA,SAGSoB,GAAA,KAAAoD,GAA+BnD,GAAxCrB,GAAA,QAAwC,CAAxC,GAAAqB,GAAArB,GAAA,SAGSoB,GAAA,KAAAqD,GAAkCpD,GAA3CrB,GAAA,QAA2C,EAA3C,GAAAqB,GAAArB,GAAA,SAGAoB,GAAA,KAASsD,GAATrD,GAAArB,GAAA,UAAAqB,GAAArB,GAAA,SAnFS,mBAA0B,CACjC,MAAM,kBAAkB,EAExB,MAAMwF,EAAyB,IAAM,CACnC,KAAK,iBAAiB,CACxB,EAEK,KAAK,wBACR,OAAO,KAAK,uBAGd,KAAK,+BAA+B,EACpC,KAAK,YAAY,IACf,KAAK,SAAS,gBAAgB,UAAU,IAAMA,EAAwB,EACxE,EACA,KAAK,YAAY,IACf,KAAK,SAAS,YAAY,UAAU,IAAMA,EAAwB,EACpE,EAGO,QAAS,CACT,OAAAhF,GAAA,CAqCD,oBAAgD,CACtD,GAAI,CAAC,KAAK,KAAM,WAAW,IAC3B,MAAMwE,EAAM,KAAK,KAAK,IAAI,IAAI7L,EAAuB,EACrD,OAAO,IAAI,IACT6L,EAAI,UAAU,kBACX,QAAQ,CAAC,CAAE,SAAAjO,KAAeA,CAAQ,EAClC,IAAUzT,GAAA0hB,EAAI,eAAe1hB,CAAE,CAAC,EAChC,OAAO7M,GAAKA,aAAawhB,EAAoB,CAClD,EAmBF,gBAAgBwN,EAA0B,CACpC,IAAC,KAAK,KAAM,OAChB,MAAMT,EAAM,KAAK,KAAK,IAAI,IAAI7L,EAAuB,EAErDkM,GAAM,IAAM,CACVI,EAAS,QAAcniB,GAAA,CACrB,MAAMod,EAAOsE,EAAI,KAAK,IAAI1hB,CAAE,EACxB2f,GAAoBvC,CAAI,IAC1BA,EAAK,gBAAgB,MAAQ,SAC/B,CACD,EACF,EAGH,cAAc+E,EAA0B,CAClC,IAAC,KAAK,KAAM,OAChB,MAAMT,EAAM,KAAK,KAAK,IAAI,IAAI7L,EAAuB,EAErDkM,GAAM,IAAM,CACVI,EAAS,QAAcniB,GAAA,CACrB,MAAMod,EAAOsE,EAAI,KAAK,IAAI1hB,CAAE,EACxB2f,GAAoBvC,CAAI,IAC1BA,EAAK,gBAAgB,MAAQ,OAC/B,CACD,EACF,EAEL,CA3LOV,GAAAwB,GAAA1nB,EAAA,EAiJIwqB,GAAA,YAIAC,GAAA,YAGAC,GAAA,YAGAC,GAAA,YAGAC,GAAA,YAbTjD,GAASzB,GAAA,wBADToE,GAhJWW,GAiJFT,EAAA,EAIT7C,GAASzB,GAAA,SADTmE,GApJWY,GAqJFR,EAAA,EAGT9C,GAASzB,GAAA,yBADTkE,GAvJWa,GAwJFP,EAAA,EAGT/C,GAASzB,GAAA,2BADTiE,GA1JWc,GA2JFN,EAAA,EAGThD,GAASzB,GAAA,aADTgE,GA7JWe,GA8JFL,EAAA,EA9JEK,GAANtD,6BAHP4C,GAGaU,EAAA,EAAAA,GACK,OAASrD;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA,IADpBL,GAAMrB,GAAA,EAAA+E,EAAA,EC1Cb,IAAAjrB,GAAAC,GAAAC,GAAAC,GAAAiL,GAAAwgB,GAAAC,GAAA,MAAMC,IAAQ7rB,IAAAD,GAAA,WAAW,YAAX,YAAAA,GAAsB,YAAtB,KAAmCC,GAAA,GAC3C8rB,KAAW7rB,GAAW,uBAAX,eAAsB,aAAYC,GAAA,WAAW,UAAX,KAAoB,OAAAA,GAAA,UAE1D6rB,GACX,OAAO,OAAW,KAAe,OAAO,SAAa,IAI1CC,GAAY,iBAAiB,MAAK7gB,GAAW,uBAAX,eAAsB,MAAM,EAE9D8gB,GACXF,IAAU,UAAU,UAAU,cAAc,QAAQ,SAAS,EAAI,GAEtDG,GAAa,aAAa,KAAKL,EAAK,EAEpCM,GACXH,KACC,cAAc,KAAKH,EAAK,KAAKF,GAAA,WAAW,YAAX,YAAAA,GAAsB,gBAAiB,GAE1DS,GAAS,OAAO,KAAKN,EAAQ,GAAK,SAAS,KAAKA,EAAQ,EAExDO,GACX,QAAQ,KAAKP,EAAQ,GACrB,QAAQ,KAAKD,EAAK,GACjB,aAAa,KAAKA,EAAK,KAAKD,GAAW,uBAAX,eAAsB,gBAAiB,EAEzDU,GAAa,MAAM,KAAKR,EAAQ,GAAK,QAAQ,KAAKA,EAAQ,EAI1DS,GAAYJ,IAAUE,IAAWH;;;;i1BC5BjCM,GAA4BR,GAAY,IAAW,IACnDS,GAA4BT,GAAY,IAAW,IAEnDU,GAAmB,cCHhB,SAAAC,GACdj6B,EACAgH,EACS,CACT,OAAOhH,IAAMgH,IAAMhH,GAAKgH,EAAIkzB,GAAmBl6B,EAAGgH,CAAC,EAAI,GACzD,CAMgB,SAAAkzB,GAAmBl6B,EAAgBgH,EAAyB,CAC1E,OAAOhH,EAAE,QAAUgH,EAAE,OAAShH,EAAE,SAAWgH,EAAE,MAC/C,CAEgB,SAAAmzB,GACdn6B,EACAgH,EACS,CACF,OAAAhH,EAAE,OAASgH,EAAE,MAAQA,EAAE,QAAUhH,EAAE,MAAQA,EAAE,QAAUgH,EAAE,KAClE,CAyCgB,SAAAozB,GACdp6B,EACAgH,EACoB,CACpB,GAAI,CAACmzB,GAAuBn6B,EAAGgH,CAAC,EACvB,YAET,MAAMoI,EAAQ,KAAK,IAAIpP,EAAE,MAAOgH,EAAE,KAAK,EACjClB,EAAS,KAAK,IAAI9F,EAAE,MAAQA,EAAE,OAAQgH,EAAE,MAAQA,EAAE,MAAM,EAAIoI,EAC3D,OAAE,MAAAA,EAAO,OAAAtJ,CAAO,CACzB,m/CCzEAu0B,GAAAC,GAAAC,GAAAC,GAAAC,GAAAptB,GAAAkmB,GAAAmH,GAAAC,GAAAC,GAAAC,GAAAC,GAaO,MAAMC,WAEH1tB,GAAcwkB,GAAAY,EAAU,EA2EhCgI,GAAA,CAAC3G,EAAS,CAAE,KAAM,MAAO,CAAC,GAK1B0G,GAAC,CAAA1G,EAAS,CAAE,UAAW,GAAO,CAG9B,EAAAyG,GAAA,CAACzG,EAAS,CAAE,UAAW,GAAO,GAG9BwG,GAAC,CAAAxG,EAAS,CAAE,UAAW,EAAO,IAG9BuG,IAACvG,EAAS,CAAE,UAAW,EAAO,IAzFtBzmB,GAA0B,CAF7B,kCAGI,iBAAc,IAAIsR,GAElB,cAAWhS,GAAO,EAAK,EAyEvBgoB,GAAA,KAAA+F,GAAwB9F,GAAjCrB,GAAiC,QAC/B,OAAQuG,EADV,IAAAlF,GAAArB,GAAA,SAKAoB,GAAA,KAASgG,GAAT/F,GAAArB,GAAA,UAAAqB,GAAArB,GAAA,SAGAoB,GAAA,KAASiG,GAAThG,GAAArB,GAAA,UAAAqB,GAAArB,GAAA,SAGAoB,GAAA,KAASkG,GAATjG,GAAArB,GAAA,UAAAqB,GAAArB,GAAA,SAGAoB,GAAA,KAASmG,GAATlG,GAAArB,GAAA,UAAAqB,GAAArB,GAAA,SArFS,mBAA0B,CACjC,MAAM,kBAAkB,EAExB,KAAK,YAAY,IACfna,GAAO,IAAM,CAxBnB/L,MAyBQ,MAAM2tB,GAAc3tB,EAAA,KAAK,eAAL,YAAAA,EAAmB,aAAa,MACpD,KAAK,SAAS,MACZ,CAAC,CAAC2tB,GACFb,GAAuBa,EAAa,CAClC,MAAO,KAAK,YACZ,OAAQ,KAAK,UAAY,KAAK,YAC/B,CACJ,EACH,EAGO,kBAAmB,CACnB,YAGT,MAAe,mBAAsC,CAC7C,MAAAh2B,EAAS,MAAM,MAAM,kBAAkB,EAG7C,MAFa,KAAK,cAAc,yBAAyB,EACzC,kBACP,eACT,MAAMi2B,EAAS,MAAM,KAAK,KAAK,iBAAiB,QAAQ,CAAC,EACzD,aAAM,QAAQ,IAAIA,EAAO,IAAaC,KAAM,cAAc,CAAC,EACpDl2B,CAAA,CAGA,QAAS,CAChB,MAAMm2B,EAAe,KAAK,aACpBC,EAAoBD,EAAa,iBAAiB,kBAClDE,EAAuD,CAC3D,MAAO,KAAK,MACZ,SAAU,KAAK,SAAS,MACxB,YAAa,KAAK,YAClB,UAAW,KAAK,UAChB,UAAW,KAAK,UAChB,OAAQF,CACV,EAGA,GADgBA,EAAa,QAAQ,KAAK,KAAK,EAClC,CACX,GAAI,KAAK,MAAM,OAAO,SAAW,EAC/B,MAAM,IAAIj8B,EACRF,EAAU,kBACV;AAAA;AAAA;AAAA,wBAIF,EAGK,OAAA+0B;AAAAA;AAAAA;AAAAA;AAAAA,gBAIGuH,GAAS,CAAE,WAAY,OAAQ,CAAC;AAAA,WACrCF,EAAkBC,CAAW,CAAC;AAAA,SAM9B,OAAAtH;AAAAA,SACFqH,EAAkBC,CAAW,CAAC;AAAA,OAoBvC,CA7FO9H,GAAAwB,GAAA1nB,EAAA,EA8EIqtB,GAAA,YAKAC,GAAA,YAGAC,GAAA,YAGAC,GAAA,YAGAC,GAAA,YAdT9F,GAASzB,GAAA,UADTkH,GA7EWM,GA8EFL,EAAA,EAKT1F,GAASzB,GAAA,cADTiH,GAlFWO,GAmFFJ,EAAA,EAGT3F,GAASzB,GAAA,iBADTgH,GArFWQ,GAsFFH,EAAA,EAGT5F,GAASzB,GAAA,cADT+G,GAxFWS,GAyFFF,EAAA,EAGT7F,GAASzB,GAAA,gBADT8G,GA3FWU,GA4FFD,EAAA,EA5FJS,GAAMhI,GAAAwH,EAAA,ECVN,MAAMS,GAAWzH;AAAAA;AAAAA,UAEduH,GAAS,CACf,WAAY,OACZ,QAAS,UACT,QAAS,MACX,CAAC,CAAC;AAAA;AAAA,4/CCTJjB,GAAAoB,GAAAjB,GAAAkB,GAAAruB,GAAAkmB,GAAAoI,GAAAhB,GAAAiB,GAAAd,GAUO,MAAMe,WAAcxuB,GAAAolB,GAgIzBiJ,GAAC,CAAA5H,EAAS,CAAE,UAAW,EAAO,EAG9B,EAAA0G,GAAA,CAAC1G,EAAS,CAAE,UAAW,EAAM,CAAC,CAG9B,EAAA2H,GAAA,CAAC3H,EAAS,CAAE,UAAW,EAAO,IAG9BuG,GAAC,CAAAvG,EAAS,CAAE,UAAW,EAAM,CAAC,GAzILzmB,GAAW,CAA/B,kCAiILsnB,GAAA,KAASgH,GAA+C/G,GAAxDrB,GAAwD,SAAxD,GAAAqB,GAAArB,GAAA,SAGAoB,GAAA,KAASgG,GAAT/F,GAAArB,GAAA,UAAAqB,GAAArB,GAAA,SAGAoB,GAAA,KAASiH,GAAThH,GAAArB,GAAA,UAAAqB,GAAArB,GAAA,SAGAoB,GAAA,KAASmG,GAATlG,GAAArB,GAAA,UAAAqB,GAAArB,GAAA,SAzIA,IAAI,cAAe,CACjB,MAAMuI,EAAc,KAAK,QACvB,IAAI9B,EAAgB,GACtB,EACA,GAAI,CAAC8B,EACH,MAAM,IAAI58B,EACRA,EAAgB,UAAU,eAC1B,gCACF,EAEF,MAAMi8B,EAAeW,EAAY,aACjC,GAAI,CAACX,EACH,MAAM,IAAIj8B,EACRA,EAAgB,UAAU,eAC1B,mDACF,EAGK,OAAAi8B,CAAA,CAGT,IAAI,WAAY,CACd,OAAO,MAAM,KAAK,KAAK,iBAAiB,WAAW,CAAC,EAGtD,IAAI,cAAe,CACV,YAAK,UAAU,OAAO,CAACvnB,EAAKsa,IAAOta,EAAMsa,EAAG,MAAM,OAAQ,EAAE,EAGrE,IAAI,aAAc,CACT,YAAK,UAAU,OAAO,CAACta,EAAKsa,IAAOta,EAAMsa,EAAG,MAAM,OAAO,OAAQ,CAAC,EAI3E,IAAI,QAAS,CACX,OAAO,MAAM,KAAK,KAAK,iBAAiB,QAAQ,CAAC,EAG1C,kBAAmB,CACnB,YAGU,cAAqB,CACtC,KAAK,MAAM,QAAU,QAEhB,sBAAiB,YAAkBlkB,GAAA,CACtC,GAAIA,EAAE,QAAU,GAAK,KAAK,cAAgB,KAAK,UAAW,CACxDA,EAAE,eAAe,EACjB,OAGEA,EAAE,QAAU,IACdA,EAAE,eAAe,EACjB,KAAK,aAAa,eAAe,CAC/B,MAAO,KAAK,YACZ,OAAQ,KAAK,UAAY,KAAK,YAC/B,EACH,CACD,EAIH,MAAe,mBAAoB,CAC3B,MAAAhF,EAAS,MAAM,MAAM,kBAAkB,EACvC,qBAAQ,IAAI,KAAK,UAAU,IAAUkpB,KAAG,cAAc,CAAC,EACtDlpB,CAAA,CAGA,QAAS,CACZ,GAAC,KAAK,YAEN,YAAK,aAAa,cACb,KAAK,aAAa,cAAc,IAAI,EAEtC,KAAK,gBAAgB,EAG9B,iBAAkB,CACZ,QAAK,SAAS,SAAW,EAEpB,OAAA+uB;AAAAA,4BACe+F,EAAyB;AAAA,QAIjD,MAAMqB,EAAe,KAAK,aACpBY,EAAiB,KAAK,SAAS,QAAQ,CAAC,CAACxH,EAAU1uB,CAAK,EAAGuJ,IAAU,CAjG/E,IAAA/B,EAAAC,EAkGU,GAAA6tB,EAAa,QAAQt1B,CAAK,EAAG,CAC3B,GAAAA,EAAM,OAAO,SAAW,EAC1B,MAAM,IAAI3G,EACRF,EAAU,kBACV;AAAA;AAAA;AAAA,0BAIF,EAGF,GAAIoQ,IAAU,EAAG,CACT,MAAA4sB,GAAY3uB,EAAA,KAAK,SAAS+B,EAAQ,CAAC,IAAvB,YAAA/B,EAA2B,GAC7C,MAAI,CAAC2uB,GAAab,EAAa,QAAQa,CAAS,EACvC,CAACR,GAAUjH,EAAUiH,EAAQ,EAE7B,CAACA,GAAUjH,CAAQ,CAC5B,KACK,CACL,MAAMyH,GAAY1uB,EAAK,cAAS8B,EAAQ,CAAC,IAAvB,KAA2B,OAAA9B,EAAA,GAC7C,MAAI,CAAC0uB,GAAab,EAAa,QAAQa,CAAS,EACvC,CAACzH,EAAUiH,EAAQ,EAEnB,CAACjH,CAAQ,CAClB,CACF,CAEK,OAAAA,CAAA,CACR,EAID,OAAOR,eAAkBuH,GAAS,CAGhC,QAAS,UACT,QAAS,eACV,CAAC,IAAIS,CAAc,SAcxB,CA3IOxI,GAAAwB,GAAA1nB,EAAA,EAiIIsuB,GAAA,YAGAhB,GAAA,YAGAiB,GAAA,YAGAd,GAAA,YATT9F,GAASzB,GAAA,aADTmI,GAhIWG,GAiIFF,EAAA,EAGT3G,GAASzB,GAAA,cADTiH,GAnIWqB,GAoIFlB,EAAA,EAGT3F,GAASzB,GAAA,UADTkI,GAtIWI,GAuIFD,EAAA,EAGT5G,GAASzB,GAAA,gBADT8G,GAzIWwB,GA0IFf,EAAA,EA1IJS,GAAMhI,GAAAsI,EAAA,o/CCVbI,GAAA5uB,GAAAkmB,GAAA2I,GAMa,MAAAC,WAAc9uB,MAmBzB4uB,GAAC,CAAAnI,EAAS,CAAE,UAAW,GAAO,GAnBLzmB,GAAW,CAA/B,kCAoBIsnB,GAAA,KAAAuH,GAActH,GAAvBrB,GAAA,OAAuBuG,EAAvB,GAAAlF,GAAArB,GAAA,SAnBS,kBAAmB,CACnB,YAGA,QAAS,CAGT,OAAAQ;AAAAA,cACGuH,GAAS,CACf,aAAc,aACd,YAAa,OACb,uBAAwB,eACzB,CAAC;AAAA;AAAA,SAEC,KAAK,GAAG;AAAA,OAMjB,CArBO/H,GAAAwB,GAAA1nB,EAAA,EAoBI6uB,GAAA,YAATlH,GAASzB,GAAA,QADT0I,GAnBWE,GAoBFD,EAAA,EApBJX,GAAMhI,GAAA4I,EAAA,ECAb,SAASC,GACPpkB,EAC6B,CAC7B,IAAIqkB,EAAkB,GAClBrkB,EAAM,YACWqkB,GAAA,aAEjBrkB,EAAM,SACWqkB,GAAA,iBAGrB,IAAIC,EAAkB,CAAC,EACvB,OAAItkB,EAAM,OACUskB,EAAA,CAChB,cACE,sFACF,cAAe,SACf,WAAY,yBACZ,MAAO,UACP,gBAAiB,MACjB,YAAa,MACb,QAAS,aACX,GAGKhB,GAAS,CACd,cAAetjB,EAAM,KAAO,OAAS,SACrC,aAAcA,EAAM,OAAS,SAAW,SACxC,kBAAmBqkB,EAAgB,OAAS,EAAIA,EAAkB,OAClE,GAAGC,CAAA,CACJ,CACH,CAEO,MAAMC,GACX,IACA,CAAC,CAAE,MAAA12B,KAAY,CACP,MAAAitB,EAAQjtB,EAAM,WAChBu2B,GAAiBv2B,EAAM,UAAU,EACjCy1B,GAAS,EAAE,EACf,OAAOvH,gBAAmBjB,CAAK;AAAA,sBACbjtB,EAAM,MAAM;AAAA,aAEhC,ECtBK,MAAM22B,EAA6D,CACxE,YACWC,EACAC,EAGL,GACJ,CALS,YAAAD,EACA,WAAAC,CAAA,CAKb,CChCO,SAASC,GACd92B,EACwC,CACxC,MAAMb,EAAiD,CAAC,EAExD,IAAI43B,EAAY/2B,EAAM,OACf,KAAA+2B,EAAU,OAAS,GAAG,CACrB,MAAAxtB,EAAQwtB,EAAU,QAAQ;AAAA,CAAI,EACpC,GAAIxtB,IAAU,GAAI,CAChBpK,EAAO,KAAK,CACV,OAAQ43B,EACR,WAAY/2B,EAAM,WACnB,EACD,MAGE+2B,EAAU,MAAM,EAAGxtB,CAAK,EAAE,OAAS,GACrCpK,EAAO,KAAK,CACV,OAAQ43B,EAAU,MAAM,EAAGxtB,CAAK,EAChC,WAAYvJ,EAAM,WACnB,EAGHb,EAAO,KAAK;AAAA,CAAI,EACJ43B,IAAU,MAAMxtB,EAAQ,CAAC,EAGhC,OAAApK,CACT,CAKO,SAAS63B,GACdh3B,EACiC,CAC7B,GAAAA,EAAM,SAAW,EACZ,OAAC,EAAE,EAGN,MAAAi3B,EAAmBj3B,EAAM,QAAQ82B,EAAc,EAErD,SAAUI,EAAgB7mB,EAA6C,CACrE,IAAInE,EAAQ,EACZ,QAAS,EAAI,EAAG,EAAImE,EAAI,OAAQ,IAC1B,GAAAA,EAAI,CAAC,IAAM;AAAA,EAAM,CACnB,MAAM8mB,EAAQ9mB,EAAI,MAAMnE,EAAO,CAAC,EAChCA,EAAQ,EAAI,EACN,MAAAirB,CACG,UAAM9mB,EAAI,OAAS,IACtB,MAAAA,EAAI,MAAMnE,CAAK,GAIrBmE,EAAI,GAAG,EAAE,IAAM;AAAA,IACjB,KAAM,CAAC,EACT,CAGF,OAAO,MAAM,KAAK6mB,EAAgBD,CAAgB,CAAC,CACrD,CCzDO,SAASG,GAAiBvW,EAAqB,CALtD,IAAArZ,EAME,OAAIqZ,aAAgB,QACdA,aAAgBqU,GACXrU,EAAK,cAAc,uBAAuB,IAAM,KAGlD,CAAC,CADSA,EAAK,QAAQ,uBAAuB,EAI9C,CAAC,GADSrZ,EAAAqZ,EAAK,gBAAL,YAAArZ,EAAoB,QAAQ,yBAGjD,CAEO,SAAS6vB,GAAaxW,EAAqB,CAChD,MAAMwH,EAAKxH,aAAgB,QAAUA,EAAOA,EAAK,cAC7C,OAACwH,EACE,CAAC,CAACA,EAAG,QAAQ,2BAA2B,EAD/B,EAElB,CAEgB,SAAAiP,GAGdV,EACAzsB,EAC+B,CAI/B,MAAMhL,EAAwC,CAAC,EAC/C,UAAWa,KAASmK,EACd,GAAAysB,EAAO,QAAQ52B,CAAK,EAAG,CACzB,MAAMu3B,EAAgB,CAAC,GAAGv3B,EAAM,MAAM,EAAE,IAAkBw3B,IAAA,CACxD,OAAQA,EACR,WAAYx3B,EAAM,YAClB,EACKb,EAAA,KAAK,GAAGo4B,CAAa,OAE5Bp4B,EAAO,KAAKa,CAAK,EAGd,OAAAb,CACT,CC5CO,SAASs4B,GAAoBtuB,EAA6B,CAFjE,IAAA3B,EAGE,OAAO2B,aAAgB,QAAQ3B,EAAA2B,EAAK,gBAAL,YAAA3B,EAAoB,QAAQ,SAAU,MACvE,CAEO,SAASkwB,GAAWn4B,EAA0C,CACnE,OACEA,aAAmB,cAClBA,EAAQ,QAAQ,WAAa,QAAUA,aAAmB21B,GAE/D,CAEO,SAASyC,GAAQp4B,EAA0C,CAChE,OACEA,aAAmB,cAClBA,aAAmBy2B,IAASz2B,EAAQ,yBAAyBy2B,GAElE,CAEO,SAAS4B,GAAcr4B,EAAe,CAC3C,MAAM8oB,EAAK9oB,aAAmB,QAAUA,EAAUA,EAAQ,cACpDs4B,KAAY,QAAe,UACjC,MAAO,CAAC,CAACA,GAASA,EAAM,cAAgB,CAC1C,CAEO,SAASC,GAAav4B,EAA0C,CACrE,OAAOA,aAAmB,aAAeA,EAAQ,QAAQ,QAAU,MACrE,CC1BO,SAASw4B,GAAoB5uB,EAAoB,CAClD,OAAAA,EAAK,YAAc8qB,GACd,EAEA9qB,EAAK,UAAU,MAE1B,CAEO,SAAS6uB,GAAwBz4B,EAA0B,CAazD,OAZkB,MAAM,KAC7BA,EAAQ,iBAAiB,sBAAsB,CACjD,EACmC,QAA2B04B,GAAA,CAC5D,MAAMC,EAAW,MAAM,KAAKD,EAAgB,UAAU,EAAE,KACrDpX,GAAuBA,aAAgB,IAC1C,EACI,OAACqX,GAAiB,CAAC,CAEhB,CACR,CAGH,CCXgB,SAAAC,GACdtX,EACAplB,EACkB,CAhBpB,IAAA+L,EAiBM,GAAAiwB,GAAoB5W,CAAI,EACnB,OAACA,EAAMplB,CAAM,EAGlB,GAAAi8B,GAAW7W,CAAI,EAAG,CACd,MAAAuX,EAAQJ,GAAwBnX,CAAI,EACpCwX,GAAW7wB,EAAM4wB,EAAA,CAAC,EAAE,gBAAT,cAAwB,QAAQ,2BAG/C,GAAAA,EAAM,SAAW,GACjBC,aAAoB,aACpBA,EAAS,QAAQ,SAAW,OAE5B,MAAO,CAACD,EAAM,CAAC,EAAG,CAAC,EAGjB,GAAAA,EAAM,OAAS,EACV,OAAAA,EAAM38B,CAAM,EAAI,CAAC28B,EAAM38B,CAAM,EAAG,CAAC,EAAI,IAC9C,CAGF,GAAIk8B,GAAQ9W,CAAI,GAAKiX,GAAajX,CAAI,EAC7B,OAAAyX,GAAuCzX,EAAMplB,EAAQ,EAAI,EAG9D,KAAEolB,aAAgB,MACb,YAGH,MAAA0X,EAASC,GAAkB3X,CAAI,EAErC,OAAI0X,EACKE,GAAuBF,EAAQ1X,EAAMplB,CAAM,EAG7C,IACT,CAEgB,SAAAi9B,GACdvvB,EACA1N,EACAw6B,EACiB,CACb,GAAAA,EAAY,QAAQ,QAAU,OAChC,MAAM,IAAI58B,EACRF,EAAU,kBACV,+DACF,EAGF,GAAI,CAAC88B,EAAY,SAAS9sB,CAAI,EAAU,YAElC,MAAAivB,EAAQJ,GAAwB/B,CAAW,EAC7C,GAAAmC,EAAM,SAAW,EAAU,YAEzB,MAAAO,EAAYP,EAAM,QAAQjvB,CAAI,EACpC,IAAII,EAAQ,EACZ,UAAWJ,KAAQivB,EAAM,MAAM,EAAGO,CAAS,EACzCpvB,GAASwuB,GAAoB5uB,CAAI,EAG/BA,EAAK,YAAc8qB,KACZ1qB,GAAA9N,GAGX,MAAMm9B,EAAoBzvB,EAAK,cAC/B,GAAI,CAACyvB,EACH,MAAM,IAAIv/B,EACRF,EAAU,kBACV,+BACF,EAGI,MAAA0/B,EAAcD,EAAkB,QAAQ,QAAQ,EAEtD,GAAI,CAACC,EACH,MAAM,IAAIx/B,EACRF,EAAU,kBACV,wBACF,EAGF,MAAM2/B,EAAY,MAAM,KAAK7C,EAAY,iBAAiB,QAAQ,CAAC,EAAE,QACnE4C,CACF,EAEA,MAAO,CAAE,KAAA1vB,EAAM,MAAOI,EAAQuvB,CAAU,CAC1C,CAEA,SAASN,GAAkB3X,EAAyC,CA1GpE,IAAArZ,EAAAC,EA2GE,MAAMowB,GAAQrwB,EAAAqZ,EAAK,gBAAL,YAAArZ,EAAoB,QAAQ,UAE1C,GAAIqwB,EACF,OAAO,MAAM,KAAKA,EAAM,iBAAiB,WAAW,CAAC,EAGvD,MAAMzhB,EACJyK,aAAgB,QACZA,EAAK,QAAQ,IAAIsT,EAAgB,GAAG,GACpC1sB,EAAKoZ,EAAA,gBAAL,KAAoB,OAAApZ,EAAA,QAAQ,IAAI0sB,EAAgB,KAEtD,OAAI/d,EACK,MAAM,KAAKA,EAAU,iBAAiB,QAAQ,CAAC,EAGjD,IACT,CAEA,SAASqiB,GACPF,EACA1X,EACAplB,EACkB,CACZ,MAAAokB,EAAQ0Y,EAAO,CAAC,EACtB,QAAS38B,EAAI,EAAGA,EAAI28B,EAAO,OAAQ38B,IAAK,CAChC,MAAAm9B,EAAQR,EAAO38B,CAAC,EAEtB,GAAIA,IAAM,GAAKo9B,GAAanY,EAAMkY,CAAK,EAC9B,OAAAT,GAAuCzY,EAAOpkB,EAAQ,EAAI,EAG/D,GAAAw9B,GAASpY,EAAMkY,CAAK,EACf,OAAAT,GAAuCzY,EAAOpkB,EAAQ,EAAK,EAOpE,GAJIG,IAAM28B,EAAO,OAAS,GAAKW,GAAarY,EAAMkY,CAAK,GAKrDn9B,EAAI28B,EAAO,OAAS,GACpBW,GAAarY,EAAMkY,CAAK,GACxBC,GAAanY,EAAM0X,EAAO38B,EAAI,CAAC,CAAC,EAEhC,OAAOu9B,GAA+BJ,CAAK,CAC7C,CAGK,WACT,CAEA,SAASI,GAA+B55B,EAAoC,CACpE,MAAA64B,EAAQJ,GAAwBz4B,CAAO,EACzC,GAAA64B,EAAM,SAAW,EAAU,YAC/B,MAAMjvB,EAAOivB,EAAMA,EAAM,OAAS,CAAC,EACnC,MAAO,CAACjvB,EAAM4uB,GAAoB5uB,CAAI,CAAC,CACzC,CAEA,SAASmvB,GACP/4B,EACA9D,EACA29B,EACkB,CACZ,MAAAhB,EAAQJ,GAAwBz4B,CAAO,EACzC,GAAA64B,EAAM,SAAW,EAAU,YACzB,MAAAjvB,EAAOiwB,EAAYhB,EAAM,CAAC,EAAIA,EAAMA,EAAM,OAAS,CAAC,EAC1D,MAAO,CAACjvB,EAAM1N,IAAW,EAAIA,EAAS0N,EAAK,MAAM,CACnD,CAEA,SAAS8vB,GAAS9+B,EAASgH,EAAkB,CAC3C,OACEA,EAAE,wBAAwBhH,CAAC,IAAM,KAAK,gCACtCgH,EAAE,wBAAwBhH,CAAC,KACxB,KAAK,+BAAiC,KAAK,4BAElD,CAEA,SAAS6+B,GAAa7+B,EAASgH,EAAkB,CAC/C,OAAOhH,EAAE,wBAAwBgH,CAAC,IAAM,KAAK,2BAC/C,CAEA,SAAS+3B,GAAa/+B,EAASgH,EAAkB,CAC/C,OAAOhH,EAAE,wBAAwBgH,CAAC,IAAM,KAAK,2BAC/C,CCjKA,MAAMk4B,GAAkC,CAAC,CACvC,YAAApD,EACA,UAAAqD,EACA,QAAAC,CACF,IACStD,EAAY,SAASqD,CAAS,GAAKrD,EAAY,SAASsD,CAAO,EAGlEC,GAAyC,CAAC,CAC9C,YAAAvD,EACA,UAAAqD,EACA,QAAAC,EACA,gBAAAE,EACA,cAAAC,CACF,IAAM,CACJ,MAAMC,EAAiBjB,GACrBY,EACAG,EACAxD,CACF,EACM2D,EAAgBlB,GACpBa,EACAG,EACAzD,CACF,EAEI,OAAC0D,GAAkB,CAACC,EACf,KAGF,CACL,MAAO,KAAK,IAAID,EAAe,MAAOC,EAAc,KAAK,EACzD,OAAQ,KAAK,IAAID,EAAe,MAAQC,EAAc,KAAK,CAC7D,CACF,EAEMC,GAA6B,CAAC,CAAE,YAAA5D,EAAa,UAAAqD,EAAW,QAAAC,KACrD,CAACtD,EAAY,SAASqD,CAAS,GAAKrD,EAAY,SAASsD,CAAO,EAGnEO,GAAoC,CAAC,CACzC,YAAA7D,EACA,QAAAsD,EACA,cAAAG,CACF,IAAM,CACJ,MAAME,EAAgBlB,GACpBa,EACAG,EACAzD,CACF,EAEA,OAAK2D,EAIE,CACL,MAAO,EACP,OAAQA,EAAc,KACxB,EANS,IAOX,EAEMG,GAA8B,CAAC,CAAE,YAAA9D,EAAa,UAAAqD,EAAW,QAAAC,KACtDtD,EAAY,SAASqD,CAAS,GAAK,CAACrD,EAAY,SAASsD,CAAO,EAGnES,GAAqC,CAAC,CAC1C,MAAA3wB,EACA,YAAA4sB,EACA,UAAAqD,EACA,gBAAAG,CACF,IAAM,CACJ,MAAMQ,EAAgBvB,GACpBY,EACAG,EACAxD,CACF,EAEA,OAAKgE,EAIE,CACL,MAAOA,EAAc,MACrB,OAAQ5wB,EAAM,OAAS4wB,EAAc,KACvC,EANS,IAOX,EAEMC,GAAoC,CAAC,CACzC,YAAAjE,EACA,UAAAqD,EACA,QAAAC,EACA,MAAAY,CACF,IAEI,CAAClE,EAAY,SAASqD,CAAS,GAC/B,CAACrD,EAAY,SAASsD,CAAO,GAC7BY,EAAM,eAAelE,CAAW,EAI9BmE,GAA2C,CAAC,CAAE,MAAA/wB,MAC3C,CACL,MAAO,EACP,OAAQA,EAAM,MAChB,GAGIgxB,GAAe,CACnBF,EACAlE,EACA5sB,IACoC,CACpC,KAAM,CAAE,eAAAixB,EAAgB,YAAAC,EAAa,aAAAC,EAAc,UAAAC,CAAc,EAAAN,EAE3DO,EAAiBvC,GAAuBmC,EAAgBC,CAAW,EACnEI,EAAexC,GAAuBqC,EAAcC,CAAS,EAE/D,IAACC,GAAkB,CAACC,EACf,YAGH,MAACrB,EAAWG,CAAe,EAAIiB,EAC/B,CAACnB,EAASG,CAAa,EAAIiB,EAE1B,OACL,YAAA1E,EACA,MAAAkE,EACA,MAAA9wB,EACA,UAAWixB,EACX,YAAAC,EACA,QAASC,EACT,UAAAC,EACA,UAAAnB,EACA,gBAAAG,EACA,QAAAF,EACA,cAAAG,CACF,CACF,EA4BgB,SAAAkB,GACdT,EACAlE,EACA5sB,EACoB,CACpB,MAAMwxB,EAAUR,GAAaF,EAAOlE,EAAa5sB,CAAK,EAElD,IAACwxB,EAAgB,YAInB,GAAAA,EAAQ,WACRA,EAAQ,YAAcA,EAAQ,SAC9BzD,GAAiByD,EAAQ,SAAS,EAClC,CACA,MAAMlB,EAAiBjB,GACrBmC,EAAQ,UACRA,EAAQ,gBACR5E,CACF,EAEA,GAAI0D,EACK,OACL,MAAOA,EAAe,MACtB,OAAQ,CACV,CACF,CAIE,OAAAN,GAAuBwB,CAAO,EACzBrB,GAA8BqB,CAAO,EAI1ChB,GAAkBgB,CAAO,EACpBf,GAAyBe,CAAO,EAIrCd,GAAmBc,CAAO,EACrBb,GAA0Ba,CAAO,EAItCX,GAAyBW,CAAO,EAC3BT,GAAgCS,CAAO,EAGzC,IACT,CAKgB,SAAAC,GACd7E,EACAd,EACc,CA5PhB,IAAA3tB,EAAAC,EA6PE,MAAMszB,EAAe,MAAM,KAAK9E,EAAY,iBAAiB,QAAQ,CAAC,EAGtE,IAAIqD,EAAyB,KACzBC,EAAuB,KACvByB,EAAe,EACfC,EAAc,EACd1xB,EAAQ,EAGZ,QAAS3N,EAAI,EAAGA,EAAIm/B,EAAa,QAC3B,EAAAzB,GAAaC,GADsB39B,IAAK,CAK5C,MAAMw8B,EAAQJ,GAAwB+C,EAAan/B,CAAC,CAAC,EACjD,GAAAw8B,EAAM,SAAW,EACZ,YAGT,UAAWjvB,KAAQivB,EAAO,CAClB,MAAA8C,EAAanD,GAAoB5uB,CAAI,EAc3C,GAZI,CAACmwB,GAAa/vB,EAAQ2xB,GAAc/F,EAAY,QACtCmE,EAAAnwB,EACZ6xB,EAAe7F,EAAY,MAAQ5rB,GAGnC,CAACgwB,GACDhwB,EAAQ2xB,GAAc/F,EAAY,MAAQA,EAAY,SAE5CoE,EAAApwB,EACI8xB,EAAA9F,EAAY,MAAQA,EAAY,OAAS5rB,GAGrD+vB,GAAaC,EACf,MAGOhwB,GAAA2xB,CAAA,CAIF3xB,GAAA,EAGP,IAAC+vB,GAAa,CAACC,EACV,YAGL,GAAAnC,GAAiBkC,CAAS,EAAG,CAC/B,MAAM6B,GAAiB3zB,EAAA8xB,EAAU,gBAAV,YAAA9xB,EAAyB,QAAQ,aACxD,GAAI,CAAC2zB,EACH,MAAM,IAAI9hC,EACRF,EAAU,kBACV,6DACF,EAEF,MAAMiiC,EAAcD,EAAe,mBACnC,GAAI,CAACC,EACH,MAAM,IAAI/hC,EACRF,EAAU,kBACV,wDACF,EAGI,MAAAi/B,EAAQJ,GAAwBoD,CAAW,EAC7C,GAAAhD,EAAM,SAAW,EACnB,MAAM,IAAI/+B,EACRF,EAAU,kBACV,+BACF,EAEEiiC,aAAuBlG,IACboE,EAAAlB,EAAMA,EAAM,OAAS,CAAC,EAClC4C,EAAejD,GAAoBuB,CAAS,IAG5CA,EAAYlB,EAAM,CAAC,EACJ4C,EAAA,EACjB,CAEE,GAAA5D,GAAiBmC,CAAO,EAAG,CAC7B,MAAM8B,GAAgB5zB,EAAA8xB,EAAQ,gBAAR,YAAA9xB,EAAuB,QAAQ,aACrD,GAAI,CAAC4zB,EACH,MAAM,IAAIhiC,EACRF,EAAU,kBACV,6DACF,EAEF,MAAMiiC,EAAcC,EAAc,mBAClC,GAAI,CAACD,EACH,MAAM,IAAI/hC,EACRF,EAAU,kBACV,wDACF,EAGI,MAAAi/B,EAAQJ,GAAwBoD,CAAW,EAC7C,GAAAhD,EAAM,SAAW,EACnB,MAAM,IAAI/+B,EACRF,EAAU,kBACV,+BACF,EAEFogC,EAAUnB,EAAM,CAAC,EACH6C,EAAA,EAGV,MAAAd,EAAQ,SAAS,YAAY,EAC7B,OAAAA,EAAA,SAASb,EAAW0B,CAAY,EAChCb,EAAA,OAAOZ,EAAS0B,CAAW,EAE1Bd,CACT,CC1WA,SAASmB,GACPnG,EACA9pB,EACAurB,EACAltB,EACA,CACK2B,IACEurB,EAAA,WAAWzB,EAAa9pB,EAAM3B,CAAU,EAC/CktB,EAAO,eAAe,CACpB,MAAOzB,EAAY,MAAQ9pB,EAAK,OAChC,OAAQ,EACT,EACH,CAEA,SAASkwB,GACPpG,EACA9pB,EACAurB,EACAltB,EACA,CACAktB,EAAO,uBAAuBzB,CAAW,EAAE,QAAsBqG,GAAA,CAC/D9xB,EAAa,CAAE,GAAG8xB,EAAW,CAAC,EAAE,WAAY,GAAG9xB,CAAW,EAC3D,EACG2B,IACKurB,EAAA,WAAWzB,EAAa9pB,EAAM3B,CAAU,EAC/CktB,EAAO,eAAe,CACpB,MAAOzB,EAAY,MAAQ9pB,EAAK,OAChC,OAAQ,EACT,EAEL,CAEA,SAASowB,GAAsBtG,EAA0ByB,EAAsB,CAC7EA,EAAO,gBAAgBzB,CAAW,EAClCyB,EAAO,eAAe,CACpB,MAAOzB,EAAY,MAAQ,EAC3B,OAAQ,EACT,CACH,CAEA,SAASjlB,GAAailB,EAA0ByB,EAAsB,CACpEA,EAAO,WAAWzB,CAAW,EAC7ByB,EAAO,eAAe,CACpB,MAAOzB,EAAY,MACnB,OAAQ,EACT,CACH,CAEO,SAASuG,GACdC,EACAtwB,EACA3B,EACAyrB,EACAyB,EACA,CACA,GAAKA,EAAO,mBAAmBzB,CAAW,EAE1C,GAAIwG,IAAc,aACCL,GAAAnG,EAAa9pB,EAAMurB,EAAQltB,CAAU,UAEtDiyB,IAAc,mBACdA,IAAc,kBAEdF,GAAsBtG,EAAayB,CAAM,UAChC+E,EAAU,WAAW,QAAQ,EACtCzrB,GAAailB,EAAayB,CAAM,UACvB+E,IAAc,wBAEKJ,GAAApG,EAAa9pB,EAAMurB,EAAQltB,CAAU,MAEjE,OAEJ,CCtEO,MAAMkyB,EAA4D,CAiGvE,YAAqBhF,EAAsC,CAAtC,YAAAA,EAhGrB,KAAQ,mBACNF,GAA4C,EAE9C,KAAQ,iBACN9tB,GAEF,KAAQ,OAAgC,KAE5B,gBAACusB,EAA0B0G,EAAQ,KAA0B,CAejE,MAAAC,EAdS,KAAK,OAAO,aACxB,uBAAuB3G,CAAW,EAClC,OAAO,CAAC,CAACx5B,EAAGogC,CAAQ,IAAM,CACzB,MAAMC,EAAaD,EAAS,MACtBE,EAAWF,EAAS,MAAQA,EAAS,OACrCG,EAAc/G,EAAY,MAC1BgH,EAAYhH,EAAY,MAAQA,EAAY,OAElD,OAAI+G,IAAgBC,EACXH,EAAaE,GAAeA,GAAeD,EAE3CA,EAAWC,GAAeF,GAAcG,CACjD,CACD,EACgC,IAAI,CAAC,CAACn8B,CAAK,IAAMA,EAAM,UAAU,EACpE,OAAI67B,EACKC,EAAoB,OACzB,CAAC/tB,EAAK2iB,KAAS,CAAE,GAAG3iB,EAAK,GAAG2iB,CAAI,GAChC,EACF,EAGA,CAACoL,EAAoB,QAErBA,EAAoB,KAAmBpyB,GAAA,CAACA,CAAU,EAE3C,CAAC,EAEaoyB,EACD,OAAO,CAAC/tB,EAAK2iB,IAAQ,CACzC,MAAM0L,EAAY,CAAC,EACnB,UAAWlxB,KAAO6C,EAAK,CACrB,MAAMsuB,EAAWnxB,EAIb6C,EAAIsuB,CAAQ,IAAM3L,EAAI2L,CAAQ,IAGtBD,EAAAC,CAAQ,EAAItuB,EAAIsuB,CAAQ,EACpC,CAEK,OAAAD,CAAA,CACR,CACH,EAEA,yBAAuBE,GAAoC,CACzD,GAAI,CAACA,EACI,OAET,MAAMC,EAAkB,KAAK,iBAAiB,UAAUD,CAAc,EAClE,IAACC,EAAgB,QAAS,CACpB,cAAMA,EAAgB,KAAK,EAC5B,OAET,OAAO,OAAO,YAEZ,OAAO,QAAQA,EAAgB,IAAI,EAAE,OAAO,CAAC,CAAC5gC,EAAGL,CAAC,IAAMA,IAAM,MAAS,CACzE,CACF,EAEA,gBAAa,IAAY,CACvB,KAAK,OAAS,IAChB,EAEA,0BAAwBk1B,GAAgD,CACtE,KAAK,mBAAqBA,CAC5B,EAEA,wBACEje,GACG,CACH,KAAK,iBAAmBA,CAC1B,EAEA,cAAYiqB,GAAgC,CAC1C,KAAK,OAASA,CAChB,EAEA,IAAI,mBAAoB,CACtB,OAAO,KAAK,mBAGd,IAAI,OAAQ,CACV,OAAO,KAAK,OAIhB,CCnGO,MAAMC,EAAwD,CAiJnE,YAAqB7F,EAAsC,CAAtC,YAAAA,EAvHrB,0BAAwB8F,GAAuB,CACvC,MAAAvyB,EAAS,KAAK,OAAO,YAE3B,IAAIZ,EAAQ,EACZ,UAAWvJ,KAASmK,EAAQ,CAC1B,GAAIZ,EAAQvJ,EAAM,OAAO,QAAU08B,EAC1B,OAAA18B,EAETuJ,GAASvJ,EAAM,OAAO,OAGjB,WACT,EA0DA,4BACEm1B,GAEO,KAAK,uBACVA,EACA,CAACn1B,EAAOuJ,IAAsC,CAC5CvJ,EACA,CAAE,MAAAuJ,EAAO,OAAQvJ,EAAM,OAAO,MAAO,EAEzC,EAGuB,6BACvBm1B,EACA7rB,IAKG,CACG,MAAAa,EAAS,KAAK,OAAO,YACrBhL,EAAmB,CAAC,EAG1B,OAAAgL,EAAO,OAAO,CAACuyB,EAAY18B,EAAO28B,IAAe,CACzC,MAAA18B,EAASD,EAAM,OAAO,OACtB9E,EAAOi6B,EAAY,MAAQl1B,EAC3B9E,EAAKg6B,EAAY,MAAQA,EAAY,OAO3C,GAJEuH,GAAcxhC,IACbwhC,EAAavhC,GACXg6B,EAAY,SAAW,GAAKuH,IAAevH,EAAY,OAE1C,CAChB,MAAMz4B,EAAQ4M,EAAStJ,EAAO08B,EAAYC,CAAU,EACpDx9B,EAAO,KAAKzC,CAAK,EAGnB,OAAOggC,EAAaz8B,GACnB,CAAC,EAEGd,CACT,EAEA,IAAI,aAAc,CAChB,OAAOm4B,GAA6B,KAAK,OAAQ,KAAK,OAAO,WAAW,EAI5E,CC3IO,MAAMsF,EAAwD,CA+WnE,YAAqBhG,EAAsC,CAAtC,YAAAA,EA9WrB,KAAQ,wBAA8C,KAEtD,KAAQ,aAAe,GAEN,8BAA4BuD,GAAiB,CAC5D,GAAIA,EAAM,wBAAwB,gBAAkB,SAAiB,SAE/D,MAAAlE,EAAc,KAAK,OAAO,YAC5B,IAACA,EAAoB,SAEnB,MAAA4G,EAAY,SAAS,YAAY,EAGvC,OAFAA,EAAU,WAAW5G,CAAW,EAG9BkE,EAAM,eAAe,wBAAwBA,EAAM,YAAY,EAC/D,KAAK,4BAGH0C,EAAU,aAAa1C,EAAM,eAAgBA,EAAM,WAAW,GAAK,GACnE0C,EAAU,aAAa1C,EAAM,aAAcA,EAAM,SAAS,GAAK,EAI/D0C,EAAU,aAAa1C,EAAM,aAAcA,EAAM,WAAW,GAAK,GACjE0C,EAAU,aAAa1C,EAAM,eAAgBA,EAAM,SAAS,GAAK,CAGvE,EAEiB,oBAAkB7yB,GAAsB,CA3C3D,IAAAE,EAAAC,EAAAC,EAAAC,EAAAiL,EAAAwgB,EA4CI,MAAM+G,EAAQ,KAAK,OAAO,aAAa,eAAe,EAEpD,QAAK,OAAO,YACZ,KAAK,cACL,CAACA,GACD,CAAC,KAAK,yBAAyBA,CAAK,EAEpC,OAEF,IAAIhF,EAAc,KAAK,OAAO,cAAcgF,CAAK,EACjD,GAAI,CAAChF,EAAa,OAElB,IAAI2H,EAAsB,GA6B1B,GA3BIx1B,EAAM,UAAU,WAAW,QAAQ,IAEnC+vB,GAAa8C,EAAM,uBAAuB,GAC1ChF,EAAY,SAAW,GACvBA,EAAY,MAAQ,GAENA,EAAA,CACZ,MAAOA,EAAY,MAAQ,EAC3B,OAAQ,CACV,EACsB2H,EAAA,IAEtBlF,GAAcuC,EAAM,uBAAuB,GAC3ChF,EAAY,SAAW,GACvBA,EAAY,MAAQ,IAKNA,EAAA,CACZ,MAAOA,EAAY,MAAQ,EAC3B,OAAQ,CACV,EACsB2H,EAAA,KAItBA,EAAqB,CACjB,MAAAC,EAAez1B,EAAM,gBAAgB,EACvC,GAAAy1B,EAAa,OAAS,EAAG,CACrB,MAAAC,EAAcD,EAAa,CAAC,EAC5B5C,EAAQ,SAAS,YAAY,EACnCA,EAAM,SAAS6C,EAAY,eAAgBA,EAAY,WAAW,EAClE7C,EAAM,OAAO6C,EAAY,aAAcA,EAAY,SAAS,EAC5D,MAAMC,EAAoB,KAAK,OAAO,cAAc9C,CAAK,EAEpD/F,GAAwBe,EAAa8H,CAAiB,IAC3C9H,EAAA8H,EAChB,CACF,CAGF,GAAI,CAAC9H,EAAa,OAElB7tB,EAAM,eAAe,EAErB,MAAM41B,EAA0C,CAC9C,aAAc,KAAK,OACnB,IAAK51B,EACL,YAAA6tB,EACA,MAAMztB,OAAM,OAAN,KAAAD,GAAcD,IAAM,eAAN,YAAAA,EAAoB,QAAQ,gBAA1C,KAA2DE,EAAA,KACjE,WAAY,EACd,GACKkL,GAAAjL,EAAA,YAAO,OAAM,cAAlB,MAAgCiL,EAAA,KAAAjL,EAAAu1B,CAAA,EAEhCxB,GACEwB,EAAI,IAAI,UACRA,EAAI,KACJA,EAAI,WACJA,EAAI,YACJ,KAAK,MACP,EAEA,KAAK,OAAO,MAAM,UAAU,MAAK9J,EAAM9rB,EAAA,OAAN,OAAc,EAAE,CACnD,EAEiB,cAAYA,GAAsB,CA5HrD,IAAAE,EA8HI,GAAIF,EAAM,kBAAkB,MAAQ8vB,GAAiB9vB,EAAM,MAAM,EAAG,CAC5D,MAAAsT,EAAY,SAAS,aAAa,EACxC,GAAI,CAACA,EAAW,OACZ,GAAAtT,EAAM,kBAAkB,YAAa,CACvC,MAAM+wB,EAAW/wB,EAAM,OAAO,QAAQ,WAAW,EAC7C+wB,GACFzd,EAAU,kBAAkByd,CAAQ,CACtC,KACK,CACL,MAAMA,GAAW7wB,EAAAF,EAAM,OAAO,gBAAb,cAA4B,QAAQ,aACjD+wB,GACFzd,EAAU,kBAAkByd,CAAQ,CACtC,CACF,CAEJ,EAEiB,uBAAoB,MAAO/wB,GAA4B,CA/I1E,IAAAE,EAAAC,EAAAC,EAiJQ,GADJ,KAAK,aAAe,GAChB,CAAC,KAAK,OAAO,aAAe,CAAC,KAAK,OAAO,YAAY,YACvD,OAGF,MAAMyyB,EAAQ,KAAK,OAAO,aAAa,eAAe,EAEpD,QAAK,OAAO,YACZ,CAACA,GACD,CAAC,KAAK,yBAAyBA,CAAK,EAEpC,OAEF,KAAK,OAAO,oBAAoB,EAC1B,WAAK,OAAO,cAAc,EAEhC,MAAMhF,EAAc,KAAK,wBACzB,GAAI,CAACA,EAAa,OAElB7tB,EAAM,eAAe,EAErB,MAAM41B,EAA6C,CACjD,aAAc,KAAK,OACnB,IAAK51B,EACL,YAAA6tB,EACA,KAAM7tB,EAAM,KACZ,WAAY,EACd,GACKG,GAAAD,EAAA,YAAO,OAAM,iBAAlB,MAAmCC,EAAA,KAAAD,EAAA01B,CAAA,EAEnC,KAAM,CAAE,YAAaC,EAAgB,KAAMC,CAAY,EAAAF,EACnDE,GAAWA,EAAQ,OAAS,IAC9B,KAAK,OAAO,WAAWD,EAAgBC,EAASF,EAAI,UAAU,EAC9D,KAAK,OAAO,eAAe,CACzB,MAAOC,EAAe,MAAQC,EAAQ,OACtC,OAAQ,EACT,GAGH,KAAK,OAAO,MAAM,UAAU,MAAK11B,EAAMJ,EAAA,OAAN,OAAc,EAAE,CACnD,EAEiB,yBAAuBA,GAA4B,CA1LtE,IAAAE,EA4LQ,GADJ,KAAK,aAAe,GAChB,CAAC,KAAK,OAAO,YAAa,OAEf,KAAK,OAAO,YAAY,iBACrC,uBACF,EACO,QAAiB61B,GAAA,CACtBA,EAAM,gBAAgB,iBAAiB,EACxC,EAED,MAAMlD,EAAQ,KAAK,OAAO,aAAa,eAAe,EAClDA,EACF,KAAK,wBAA0B,KAAK,OAAO,cAAcA,CAAK,EAE9D,KAAK,wBAA0B,KAGjC,KAAK,OAAO,MAAM,UAAU,MAAK3yB,EAAMF,EAAA,OAAN,OAAc,EAAE,CACnD,EAEiB,0BAAwBA,GAA4B,CA/MvE,IAAAE,EAgNQ,IAAC,KAAK,OAAO,aAAe,CAAC,KAAK,OAAO,YAAY,YACvD,OAGF,MAAM2yB,EAAQ,KAAK,OAAO,aAAa,eAAe,EAEpD,KAAK,OAAO,YACZ,CAACA,GACD,CAAC,KAAK,yBAAyBA,CAAK,GAItC,KAAK,OAAO,MAAM,UAAU,MAAK3yB,EAAMF,EAAA,OAAN,OAAc,EAAE,CACnD,EAEiB,gBAAcA,GAAyB,CAChD,MAAA6tB,EAAc,KAAK,OAAO,eAAe,EAC/C,GAAKA,IAEL,KAAK,OAAO,MAAM,QAAQ,KAAK7tB,CAAK,EAGlC,CAACA,EAAM,WACNA,EAAM,MAAQ,aAAeA,EAAM,MAAQ,eAC5C,CACI,GAAA6tB,EAAY,SAAW,EAAG,OAE9B,MAAMmI,EAAU,IAAM,CACpBh2B,EAAM,eAAe,EACrBA,EAAM,gBAAgB,CACxB,EAEM6C,EAAS,KAAK,OAAO,uBAAuBgrB,CAAW,EACzD,GAAAhrB,EAAO,SAAW,EAChB7C,EAAM,MAAQ,aAAe,KAAK,OAAO,QAAQ6C,EAAO,CAAC,EAAE,CAAC,CAAC,GACvDmzB,EAAA,EACR,KAAK,OAAO,eAAe,CACzB,MAAOnI,EAAY,MAAQ,EAC3B,OAAQ,EACT,GAED7tB,EAAM,MAAQ,cACd,KAAK,OAAO,QAAQ6C,EAAO,CAAC,EAAE,CAAC,CAAC,IAExBmzB,EAAA,EACR,KAAK,OAAO,eAAe,CACzB,MAAOnI,EAAY,MACnB,OAAQ,EACT,WAEMhrB,EAAO,SAAW,EAAG,CAC9B,MAAMnK,EAAQmK,EAAO,CAAC,EAAE,CAAC,EACrB,KAAK,OAAO,QAAQnK,CAAK,IACvBsH,EAAM,MAAQ,aAAe6tB,EAAY,MAAQ,GAAK,GAChDmI,EAAA,EACR,KAAK,OAAO,eAAe,CACzB,MAAOnI,EAAY,MAAQ,EAC3B,OAAQ,EACT,GAED7tB,EAAM,MAAQ,cACd6tB,EAAY,MAAQ,GAAK,KAAK,OAAO,cAE7BmI,EAAA,EACR,KAAK,OAAO,eAAe,CACzB,MAAOnI,EAAY,MACnB,OAAQ,EACT,GAEL,CACF,CAEJ,EAEA,KAAiB,mBAAqB,IAAM,CACpC,MAAAc,EAAc,KAAK,OAAO,YAChC,GAAI,CAACA,EAAa,OAEZ,MAAAsH,EAAsB,KAAK,OAAO,eAAe,EACvD,GAAI,KAAK,aACP,OAGI,MAAA3iB,EAAY,SAAS,aAAa,EACxC,GAAI,CAACA,EAAW,OACZ,GAAAA,EAAU,aAAe,EAAG,CAC1B2iB,IAAwB,MACrB,YAAO,eAAe,IAAI,EAGjC,OAGI,MAAApD,EAAQvf,EAAU,WAAW,CAAC,EACpC,GAAI,CAACuf,EAAM,eAAelE,CAAW,EAUnC,GAREkE,EAAM,aAAa,SAASlE,CAAW,GACvC,MAAM,KAAKkE,EAAM,aAAa,UAAU,EAAE,UAChCtZ,aAAgB,WACxB,WAAW,GACbsZ,EAAM,eAAe,SAASlE,CAAW,GACzC,MAAM,KAAKkE,EAAM,eAAe,UAAU,EAAE,UAClCtZ,aAAgB,aACxB,SAAW,EACU,CACvB,KAAK,OAAO,SAAS,EACrB,WACK,CACD0c,IAAwB,MACrB,YAAO,eAAe,IAAI,EAEjC,OAIJ,MAAMpI,EAAc,KAAK,OAAO,cAAcva,EAAU,WAAW,CAAC,CAAC,EAChEwZ,GAAwBmJ,EAAqBpI,CAAW,IACtD,YAAO,aAAa,oBAAoB,EACxC,YAAO,eAAeA,CAAW,EACjC,YAAO,aAAa,sBAAsB,EAEnD,EAEA,WAAQ,IAAM,CACN,MAAAqI,EAAc,KAAK,OAAO,YAC1BvH,EAAc,KAAK,OAAO,YAUhC,GARK,KAAK,OAAO,6BACf,KAAK,OAAO,YAAY,aACtB,SACA,kBACA,KAAK,kBACP,EAGE,CAACuH,EAAa,CAChB,QAAQ,MAAM,gDAAgD,EAC9D,OAGF,KAAK,OAAO,YAAY,aACtBA,EACA,cACA,KAAK,cACP,EACA,KAAK,OAAO,YAAY,aACtBA,EACA,mBACA,KAAK,mBACP,EACA,KAAK,OAAO,YAAY,aACtBA,EACA,oBACA,KAAK,oBACP,EACA,KAAK,OAAO,YAAY,aAAaA,EAAa,iBAAuBr5B,GAAA,CACvE,KAAK,kBAAkBA,CAAC,EAAE,MAAM,QAAQ,KAAK,EAC9C,EACD,KAAK,OAAO,YAAY,aACtBq5B,EACA,UACA,KAAK,UACP,EACIvH,GACF,KAAK,OAAO,YAAY,aAAaA,EAAa,QAAS,KAAK,QAAQ,CAE5E,EAEA,IAAI,aAAc,CAChB,OAAO,KAAK,aAIhB,CC9WO,MAAMwH,EAAwD,CAyXnE,YAAqB7G,EAAsC,CAAtC,YAAAA,EAxXrB,KAAQ,yBAAsD,KAE9D,KAAQ,2BAAwD,KAEhE,cAAW,IAAY,CACrB,KAAK,OAAO,eAAe,CACzB,MAAO,KAAK,OAAO,YACnB,OAAQ,EACT,CACH,EAEA,gBAAcrtB,GAAwB,CACpC,KAAK,OAAO,eAAe,CACzB,MAAAA,EACA,OAAQ,EACT,CACH,EAEA,gBAAa,IAAY,CACvB,KAAK,OAAO,eAAe,CACzB,MAAO,EACP,OAAQ,EACT,CACH,EAEA,+BAA6BhK,GAAyC,CAzCxE,IAAAiI,EAAAC,EA0CU,MAAA0yB,EAAQ,SAAS,YAAY,EAC7BhxB,EAAO5J,EAAQ,cAAc,eAAe,EAClD,GAAI,CAAC4J,EACI,YAEH,MAAA+uB,EAAW/uB,EAAK,WAAW,CAAC,EAC9B,OAAE+uB,aAAoB,MAGpBiC,EAAA,SAASjC,EAAU,CAAC,EAC1BiC,EAAM,OAAOjC,GAAUzwB,GAAAD,EAAA0wB,EAAS,cAAT,KAAsB,OAAA1wB,EAAA,SAAtB,OAAgC,CAAC,EACpC,KAAK,cAAc2yB,CAAK,GAJnC,IAMX,EAGA,aACEuC,GAKU,CACJ,MAAAzG,EAAc,KAAK,OAAO,YAC5B,IAACA,EAAoB,YAEzB,MAAM8E,EAAe,MAAM,KAAK9E,EAAY,iBAAiB,QAAQ,CAAC,EAEtE,IAAIyH,EAAc,EAClB,SAAW,CAAC5E,EAAWD,CAAW,IAAKkC,EAAa,UAAW,CAC7D,GACE2B,GAAcgB,GACdhB,EAAagB,EAAc7E,EAAY,YAAc,EAE9C,OACL,KAAMA,EACN,UAAAC,EACA,wBAAyB4D,EAAagB,CACxC,EAEFA,GAAe7E,EAAY,YAAc,EAG3C,eAAQ,MAAM,qBAAqB,EAC5B,IACT,EAEA,oBAAiB,IAAoB,CAC7B,MAAAje,EAAY,KAAK,mBAAmB,EACtC,OAACA,EACEA,EAAU,WAAW,CAAC,EADN,IAEzB,EAEA,wBAAqB,IAAwB,CACrC,MAAAA,EAAY,SAAS,aAAa,EAEpC,MADA,CAACA,GACDA,EAAU,aAAe,EAAU,KAEhCA,CACT,EAEA,kBAAgB8hB,GAAuD,CAC/D,MAAAzG,EAAc,KAAK,OAAO,YAC5B,IAACA,EAAoB,YAEzB,MAAM0H,EAAS,MAAM,KAAK1H,EAAY,iBAAiB,QAAQ,CAAC,EAEhE,IAAI1sB,EAAQ,EACZ,UAAWsuB,KAAS8F,EAAQ,CACpB,MAAAvF,EAAQJ,GAAwBH,CAAK,EACvC,GAAAO,EAAM,SAAW,EACZ,YAGE,UAAAjvB,KAAQivB,EAAM,OAAOjvB,GAAQ,CAACkuB,GAAaluB,CAAI,CAAC,EAAG,CACxD,IAACA,EAAK,YACD,YAET,GAAII,EAAQJ,EAAK,YAAY,QAAUuzB,EAC9B,OAACvzB,EAAMuzB,EAAanzB,CAAK,EAElCA,GAASwuB,GAAoB5uB,CAAI,EAG1BI,GAAA,EAGJ,WACT,EAOA,iBAAe4rB,GAA6C,CAC1D,GAAI,CAACA,GAAeA,EAAY,OAAS,EAAU,SAE7C,MAAAgF,EAAQ,KAAK,WAAWhF,CAAW,EACzC,GAAI,CAACgF,EACH,eAAQ,MAAM,4CAA4C,EACnD,GAKL,GADe,KAAK,OAAO,YAAY,MAAM,EAAGhF,EAAY,KAAK,EACtD,SAAS;AAAA,CAAI,EACnB,SAWH,MAAA/e,EAAY+jB,EAAM,wBAAwB,cAChD,GAAI,CAAC/jB,EACH,eAAQ,MAAM,yBAAyB,EAChC,GAEH,MAAAwnB,EAAgBxnB,EAAU,sBAAsB,EAIhDynB,EAAa1D,EAAM,eAAe,EAGlC2D,EAAYD,EAAWA,EAAW,OAAS,CAAC,EAElD,OAAO,KAAK,IAAIC,EAAU,IAAMF,EAAc,GAAG,EAD/B,CAEpB,EAOA,gBAAczI,GAA6C,CAKrD,GAJA,CAACA,GAAeA,EAAY,OAAS,GAGvB,KAAK,OAAO,YAAY,MAAMA,EAAY,KAAK,EACnD,SAAS;AAAA,CAAI,EAClB,SAGH,MAAAgF,EAAQ,KAAK,WAAWhF,CAAW,EACzC,GAAI,CAACgF,EACH,eAAQ,MAAM,4CAA4C,EACnD,GAWH,MAAA/jB,EAAY+jB,EAAM,wBAAwB,cAChD,GAAI,CAAC/jB,EACH,eAAQ,MAAM,yBAAyB,EAChC,GAEH,MAAAwnB,EAAgBxnB,EAAU,sBAAsB,EAIhDynB,EAAa1D,EAAM,eAAe,EAGlC2D,EAAYD,EAAWA,EAAW,OAAS,CAAC,EAGlD,OAAO,KAAK,IAAIC,EAAU,OAASF,EAAc,MAAM,EADrC,CAEpB,EAEA,wBAAsBzI,GACb,EACLA,IACCA,EAAY,MAAQ,GACnBA,EAAY,MAAQA,EAAY,OAAS,KAAK,OAAO,MAAM,SAIjE,WAAQ,IAAM,CACZ,MAAMyB,EAAS,KAAK,OAChB,IAAAmH,EAAsCnH,EAAO,aAAa,MAC9DA,EAAO,YAAY,IACjBrjB,GAAO,IAAM,CACL,MAAA4pB,EAAiBvG,EAAO,aAAa,MAI3C,GAHI,CAACA,EAAO,SAEDxC,GAAwB2J,EAAiBZ,CAAc,EAC1D,OACUY,EAAAZ,EAElB,MAAM9zB,EAAQutB,EAAO,MAarB,GAZIuG,GACF,KAAK,2BACHa,GAAsC30B,EAAO8zB,EAAe,KAAK,EACnE,KAAK,yBAA2Ba,GAC9B30B,EACA8zB,EAAe,MAAQA,EAAe,MACxC,IAEA,KAAK,2BAA6B,KAClC,KAAK,yBAA2B,MAG9B,CAAAvG,EAAO,4BAEP,QAAK,OAAO,cAAc,UAAW,CACvC,MAAMnnB,EAAemnB,EAAO,MAAM,eAAe,UAAU,IAAM,CAC/DnnB,EAAa,YAAY,EACzB,KAAK,gBAAgB0tB,CAAc,EACpC,OAED,KAAK,gBAAgB,CAExB,EACH,CACF,EAEA,eAAY,IAAY,CACtB,KAAK,OAAO,eAAe,CACzB,MAAO,EACP,OAAQ,KAAK,OAAO,YACrB,CACH,EAEA,KAAQ,qBAAuB,GAC/B,yBAAsB,IAAM,CAC1B,KAAK,qBAAuB,EAC9B,EACA,2BAAwB,IAAM,CAC5B,KAAK,qBAAuB,EAC9B,EAIA,qBAAmBhI,GAAqC,CACtD,GAAI,CAAC,KAAK,OAAO,SAAW,KAAK,qBAAsB,OACzCA,KAAe,KAAK,OAAO,eAAe,EAExD,MAAM5tB,EAAU,IAAM,CACd,MAAAqT,EAAY,SAAS,aAAa,EACxC,GAAKA,GACA,KAAK,OAAO,YAEjB,GAAIua,IAAgB,KACdva,EAAU,WAAa,GACXA,EAAU,WAAW,CAAC,EAC1B,eAAe,KAAK,OAAO,WAAW,GAC9CA,EAAU,gBAAgB,MAI1B,KACI,MAAAqjB,EAAW,KAAK,WAAW9I,CAAW,EAC5C,GAAI8I,EACFrjB,EAAU,gBAAgB,EAC1BA,EAAU,SAASqjB,CAAQ,EACtB,YAAO,YAAY,MAAM,EAE9B,KAAK,OAAO,MAAM,gBAAgB,KAAKA,CAAQ,MAC1C,CACL,MAAMxuB,EAAe,KAAK,OAAO,MAAM,eAAe,UACpD,IAAM,CACJA,EAAa,YAAY,EACzB,KAAK,gBAAgB0lB,CAAW,EAEpC,SAEKz7B,EAAO,CACd,QAAQ,MAAM,8BAA8B,EAC5C,QAAQ,MAAMA,CAAK,EAGzB,EAEI,QAAK,OAAO,cAAc,UAAW,CACvC,MAAM+V,EAAe,KAAK,OAAO,MAAM,eAAe,UAAU,IAAM,CACpEA,EAAa,YAAY,EACjBlI,EAAA,EACT,OAEOA,EAAA,CAEZ,EAKA,gBAAc4tB,GAA2C,CACjD,MAAAc,EAAc,KAAK,OAAO,YAC5B,OAACA,EACE6E,GAAsB7E,EAAad,CAAW,EAD5B,IAE3B,EAkCA,mBAAiBgF,GAAqC,CACpD,KAAM,CAAE,YAAAlE,EAAa,MAAA5sB,CAAM,EAAI,KAAK,OACpC,MAAI,CAAC4sB,GAAe,CAAC5sB,EAAc,KAC5BuxB,GAAsBT,EAAOlE,EAAa5sB,CAAK,CACxD,EAEA,IAAI,yBAA0B,CAC5B,OAAO,KAAK,yBAGd,IAAI,2BAA4B,CAC9B,OAAO,KAAK,2BAIhB,CC9XO,MAAM60B,EAAyD,CA4KpE,YAAqBtH,EAAsC,CAAtC,YAAAA,EA3KJ,oBAAiB,CAChCj7B,EACAwiC,IACG,CAKH,GAJK,YAAO,MAAM,WAAW,KAAK,EAEpB,KAAK,OAAO,MAEhB,WAAW,SAAS,IAAI,EAChC,MAAM,IAAI9kC,EACRF,EAAU,kBACV,8EACF,EAME,GAHJ,KAAK,OAAO,EAGR,CADgB,KAAK,OAAO,aAAa,KAAK,GAC9BglC,EAAY,MAAO,OAEjC,MAAAC,EAA4B,KAAK,OAAO,0BACxCC,EAA0B,KAAK,OAAO,wBACxC,IAACD,GAA6B,CAACC,EAAyB,OAEtD,MAAAh3B,EAAM,KAAK,OAAO,MAAM,IAC9B,GAAI,CAACA,EAAK,CACR,QAAQ,MAAM,qCAAqC,EACnD,OAEF,MAAMi3B,EAAgBC,GACpBH,EACA/2B,CACF,EACMm3B,EAAcD,GAClBF,EACAh3B,CACF,EAEMuZ,EAA4B0d,GAAA,MAC5BG,EAAwBD,GAAA,MAC1B,IAAC5d,GAAc,CAAC6d,EAAU,OAE9B,MAAMtB,EAA8B,CAClC,MAAOvc,EACP,OAAQ6d,EAAW7d,CACrB,EACK,KAAK,OAAO,mBAAmBuc,CAAc,IAE7C,YAAO,eAAeA,CAAc,EACzC,KAAK,OAAO,gBAAgB,EAC9B,EAEA,WAAQ,IAAM,CACZ,MAAMvG,EAAS,KAAK,OACdvtB,EAAQutB,EAAO,MAEfvtB,EAAA,QAAQ,KAAK,cAAc,EACjCutB,EAAO,YAAY,IAAI,CACrB,QAAS,IAAM,CACPvtB,EAAA,UAAU,KAAK,cAAc,EACrC,CACD,CACH,EAEA,KAAQ,WAAa,GAKrB,YAAS,IAAM,CACT,IAAC,KAAK,OAAO,YAAa,OAE9B,KAAK,WAAa,GAEZ,MAAA4sB,EAAc,KAAK,OAAO,YAC1ByI,EAAc,KAAK,OAAO,aAAa,YACvCC,EAAS3H,GAAqB0H,CAAW,EAE/C,IAAI/B,EAAa,EAEjB,MAAMiC,EAAQD,EAAO,IAAI,CAACxH,EAAO2B,IAAc,CACzCA,EAAY,IACA6D,GAAA,GAGhB,MAAMkC,EAAkBlC,EACpB,GAAAxF,EAAM,OAAS,EAAG,CACd,MAAA1S,EAA8B0S,EAAM,IAAan3B,GAAA,CACrD,MAAMu6B,EAAcoC,EACpBA,GAAc38B,EAAM,OAAO,OAC3B,MAAMy6B,EAAYkC,EAEX,OACLzO;AAAAA,8BACkB,KAAK,MAAM;AAAA,uBAClB,CACP,OAAQluB,EAAM,OACd,WAAY,KAAK,OAAO,iBAAiB,oBACvCA,EAAM,WAET;AAAA,6BACcu6B,CAAW;AAAA,2BACbE,CAAS;AAAA,2BACT3B,CAAS;AAAA,2BAExB94B,CACF,EACD,EAEM,OAAAkuB;AAAAA,sBACOzJ,CAAQ;AAAA,mBACXqU,CAAS;AAAA,yBACH+F,CAAe;AAAA,uBACjBlC,CAAU;AAAA,wBAGlB,QAAAzO;AAAAA,sBACO,CAAE;AAAA,mBACL4K,CAAS;AAAA,yBACH+F,CAAe;AAAA,uBACjBlC,CAAU;AAAA,mBAE3B,CACD,EAEG,IACFmC,GACEjQ,GACE+P,EAAM,IAAI,CAAC5/B,EAAMpD,KAAO,CAAE,KAAAoD,EAAM,MAAOpD,CAAA,EAAI,KAClCmjC,EAAM,SACNA,EAAM,IACjB,EACA9I,CACF,CACM,OAEN,KAAK,OAAO,oBAAoB,EAGlC,KAAK,OACF,cACA,OAAK,IAAM,CACV,KAAK,WAAa,GACb,YAAO,MAAM,eAAe,KAAK,EACtC,KAAK,OAAO,gBAAgB,EAC7B,EACA,MAAM,QAAQ,KAAK,CACxB,EAEA,yBAAsB,IAAM,CACpB,MAAAA,EAAc,KAAK,OAAO,YAE5B,CAACA,GAAe,CAACA,EAAY,cAEjCA,EAAY,gBAAgB,EAK5B,OAAQA,EAAoB,WAC5B,KAAK,OAAO,EACd,EAEA,mBAAgB,SAAY,CACtB,IAAC,KAAK,OAAO,YAAa,OAC9B,MAAM0H,EAAS,MAAM,KACnB,KAAK,OAAO,YAAY,iBAAiB,QAAQ,CACnD,EACA,MAAM,QAAQ,IAAIA,EAAO,IAAY3+B,KAAK,cAAc,CAAC,CAC3D,EAxGA,IAAI,WAAY,CACd,OAAO,KAAK,WA0GhB,CClLO,MAAMggC,EAA6D,CAoIxE,YAAqBpI,EAAsC,CAAtC,YAAAA,EAnIrB,gBAAczB,GAAmC,CAC3C,KAAK,OAAO,YAEhB,KAAK,SAAS,IAAM,CAClB,KAAK,MAAM,OAAOA,EAAY,MAAOA,EAAY,MAAM,EACxD,CACH,EAEA,gBAAa,CACXA,EACAzrB,EACAlQ,EAII,KACK,CACL,QAAK,OAAO,WAAY,OAEtB,MACJ,MAAAylC,EAAQ,IAAM,GACd,KAAArmB,EAAO,QACP,gBAAAsmB,EAAkB,IAChB1lC,EACW,KAAK,OAAO,aAAa,uBAAuB27B,CAAW,EAGvE,OAAO,CAAC,CAACn1B,EAAOm/B,CAAgB,IAAMF,EAAMj/B,EAAOm/B,CAAgB,CAAC,EACpE,QAAQ,CAAC,CAACtK,EAAQsK,CAAgB,IAAM,CACvC,MAAMC,EACJ,KAAK,OAAO,iBAAiB,oBAAoB11B,CAAU,EAC7D,GAAI,CAAC01B,EAAsB,OAE3B,MAAMnC,EAAoB1I,GACxBY,EACAgK,CACF,EACKlC,IAEDrkB,IAAS,WACX,KAAK,UAAUqkB,CAAiB,EAGlC,KAAK,SAAS,IAAM,CAClB,KAAK,MAAM,OACTA,EAAkB,MAClBA,EAAkB,OAClBmC,CACF,GACCF,CAAe,GACnB,CACL,EAEA,qBAAmB/J,GAAmC,CAChD,KAAK,OAAO,YAEhB,KAAK,SAAS,IAAM,CAClB,KAAK,MAAM,OAAOA,EAAY,MAAOA,EAAY,MAAM,EACvD,KAAK,MAAM,OAAOA,EAAY,MAAO;AAAA,CAAI,EAC1C,CACH,EAEA,gBAAa,CACXA,EACAhsB,EACAO,EAA6B,KACpB,CAGT,GAFI,KAAK,OAAO,YAEZ,CAACP,GAAQ,CAACA,EAAK,OAAQ,OAEvB,KAAK,OAAO,iBAAiB,QAC/BO,EAAa,CAAE,GAAGA,EAAY,GAAG,KAAK,OAAO,iBAAiB,KAAM,GAEtE,MAAM01B,EACJ,KAAK,OAAO,iBAAiB,oBAAoB11B,CAAU,EAE7D,KAAK,SAAS,IAAM,CAClB,KAAK,MAAM,OAAOyrB,EAAY,MAAOA,EAAY,MAAM,EACvD,KAAK,MAAM,OAAOA,EAAY,MAAOhsB,EAAMi2B,CAAoB,EAChE,CACH,EAEA,eAAajK,GAAmC,CAC1C,QAAK,OAAO,WAAY,OAE5B,MAAMkK,EAA6B,CAAC,EAE9B,UAAIlK,EAAY,MACpB,GAAKA,EAAY,MAAQA,EAAY,OACrC,IACA,CACA,MAAMn1B,EAAQ,KAAK,OAAO,qBAAqB,CAAC,EAC5CA,GACFq/B,EAAY,KAAKr/B,CAAK,CACxB,CAGF,MAAMs/B,EAAQ,OAAO,YACnBD,EAAY,QACVr/B,KAAM,WACF,OAAO,KAAKA,EAAM,UAAU,EAAE,OAAW,CAACkL,EAAK,IAAI,CAAC,EACpD,EAAC,CAET,EAEA,KAAK,SAAS,IAAM,CAClB,KAAK,MAAM,OAAOiqB,EAAY,MAAOA,EAAY,OAAQ,CACvD,GAAGmK,CAAA,CACJ,EACF,CACH,EAEA,aAAU,CACRn2B,EACAO,EAA6B,KACpB,CACL,KAAK,OAAO,YAEhB,KAAK,SAAS,IAAM,CAClB,KAAK,MAAM,OAAO,EAAG,KAAK,MAAM,MAAM,EACtC,KAAK,MAAM,OAAO,EAAGP,EAAMO,CAAU,EACtC,CACH,EAES,cAAW,KAAK,OAAO,SAEhC,IAAI,OAAQ,CACV,OAAO,KAAK,OAAO,MAIvB,CCzGO,MAAM61B,EAEX,CA2JA,YACEl2B,EACAm2B,EAKI,GACJ,CACI,GA7JG,iBAAc,IAAI1mB,GAElB,sBACP,IAAI8iB,GAAiC,IAAI,EAC3C,eAAY,KAAK,iBAAiB,UAClC,yBAAsB,KAAK,iBAAiB,oBAC5C,gBAAa,KAAK,iBAAiB,WACnC,0BAAuB,KAAK,iBAAiB,qBAC7C,wBAAqB,KAAK,iBAAiB,mBAC3C,cAAW,KAAK,iBAAiB,SAKxB,iBACP,IAAIoD,GAAkC,IAAI,EAC5C,gBAAa,KAAK,YAAY,WAC9B,gBAAa,KAAK,YAAY,WAC9B,qBAAkB,KAAK,YAAY,gBACnC,gBAAa,KAAK,YAAY,WAC9B,eAAY,KAAK,YAAY,UAC7B,aAAU,KAAK,YAAY,QAElB,kBACP,IAAIvC,GAA6B,IAAI,EACvC,0BAAuB,KAAK,aAAa,qBACzC,4BAAyB,KAAK,aAAa,uBAC3C,4BAAyB,KAAK,aAAa,uBAKlC,kBACP,IAAIgB,GAA6B,IAAI,EACvC,cAAW,KAAK,aAAa,SAC7B,gBAAa,KAAK,aAAa,WAC/B,gBAAa,KAAK,aAAa,WAC/B,+BAA4B,KAAK,aAAa,0BAC9C,iBAAc,KAAK,aAAa,YAChC,gBAAa,KAAK,aAAa,WAC/B,wBAAqB,KAAK,aAAa,mBACvC,eAAY,KAAK,aAAa,UAC9B,qBAAkB,KAAK,aAAa,gBACpC,gBAAa,KAAK,aAAa,WAC/B,mBAAgB,KAAK,aAAa,cAClC,aAAU,KAAK,aAAa,QAC5B,oBAAiB,KAAK,aAAa,eACnC,wBAAqB,KAAK,aAAa,mBACvC,kBAAe,KAAK,aAAa,aAQxB,kBACP,IAAIb,GAA6B,IAAI,EAK9B,mBACP,IAAIsB,GAA8B,IAAI,EACxC,mBAAgB,KAAK,cAAc,cACnC,yBAAsB,KAAK,cAAc,oBACzC,YAAS,KAAK,cAAc,OAU5B,KAAQ,aAAmC,KAK3C,KAAQ,YAAc,GAKtB,KAAQ,SAAW,GAKnB,KAAQ,aAAyD,KASjE,KAAS,oBAA2C,CAClD,aAAcp3B,GAAO,IAAI,EACzB,eAA+BquB,GAAA,CAC7B,KAAK,aAAa,MAAQA,CAAA,CAE9B,EAIA,oBAAkBA,GAAoC,CAC/C,yBAAoB,eAAeA,CAAW,CACrD,EACA,oBAAiB,IACR,KAAK,aAAa,KAAK,EAGhC,KAAS,MAAQ,CACf,QAAS,IAAIjkB,GACb,UAAW,IAAIA,GACf,eAAgB,IAAIA,GACpB,WAAY,IAAIA,GAChB,gBAAiB,IAAIA,GAKrB,UAAW,IAAIA,GAIf,QAAS,IAAIA,EACf,EA0BM,CAAC7H,EAAM,IACT,MAAM,IAAIhQ,EACRF,EAAU,kBACV,mCACF,EAGF,GAAIkQ,EAAM,WAAW,SAAS,IAAI,EAChC,MAAM,IAAIhQ,EACRF,EAAU,kBACV,8EACF,EAGI,MACJ,QAAAsmC,EAAU,IAAM,GAChB,MAAA5I,EAAQ,CAAC,EACT,oBAAA6I,EACA,cAAAC,EAAgB,MACdH,EACJ,KAAK,6BAA+B,GACpC,KAAK,MAAQn2B,EACb,KAAK,QAAUo2B,EACf,KAAK,cAAgBE,EACrB,KAAK,aAAe,IAAIhJ,GAAkB,KAAME,CAAK,EACjD6I,IACF,KAAK,oBAAsBA,EAC3B,KAAK,6BAA+B,GACtC,CA/KF,IAAI,OAAQ,CACV,OAAO,KAAK,iBAAiB,MAiB/B,IAAI,aAAc,CAChB,OAAO,KAAK,aAAa,YAoB3B,IAAI,2BAA4B,CAC9B,OAAO,KAAK,aAAa,0BAE3B,IAAI,yBAA0B,CAC5B,OAAO,KAAK,aAAa,wBAK3B,IAAI,aAAc,CAChB,OAAO,KAAK,aAAa,YAQ3B,IAAI,WAAY,CACd,OAAO,KAAK,cAAc,UAI5B,IAAI,OAAQ,CACV,OAAO,KAAK,aAAa,MAI3B,IAAI,aAAc,CAChB,OAAO,KAAK,aAId,IAAI,YAAa,CACf,OAAO,KAAK,YAId,IAAI,SAAU,CACZ,OAAO,KAAK,SAId,IAAI,aAAc,CAChB,OAAO,KAAK,aAId,IAAI,6BAA8B,CAChC,OAAO,KAAK,6BAQd,IAAI,cAAe,CACjB,OAAO,KAAK,oBAAoB,aA6BlC,IAAI,aAAc,CACT,YAAK,MAAM,QAAQ,EAE5B,IAAI,aAAc,CAChB,OAAO,KAAK,MAAM,OAEpB,IAAI,aAAc,CACT,YAAK,MAAM,SAAS,EA6C7B,MACEzJ,EACAuH,EAA2BvH,EAC3B2J,EAAa,GACb,CACA,MAAMC,EAAa5J,EACnB4J,EAAW,aAAe,KAC1B,KAAK,aAAeA,EACpB,KAAK,aAAerC,EACf,kBAAa,MAAM,QAAU,OAC7B,kBAAa,QAAQ,MAAQ,OAClC,KAAK,YAAYoC,CAAU,EAE3B,KAAK,aAAa,gBAAgB,EAE1B,YAAK,YAAoB,WAEjC,KAAK,aAAa,MAAM,EACxB,KAAK,aAAa,MAAM,EACxB,KAAK,cAAc,MAAM,EAEzB,KAAK,SAAW,GACX,WAAM,QAAQ,KAAK,EAExB,KAAK,OAAO,EAGd,SAAU,CACJ,KAAK,cACH,KAAK,YAAY,aACZd,GAAA3Q,GAAS,KAAK,WAAW,EAE7B,iBAAY,gBAAgBgG,EAAgB,GAEnD,KAAK,aAAe,KACpB,KAAK,SAAW,GAChB,KAAK,YAAY,QAAQ,EACpB,WAAM,UAAU,KAAK,EAG5B,YAAYyL,EAA2B,CAC/B,MAAAljC,EAAQkjC,EAAa,QAAU,OAEjC,KAAK,aAAe,KAAK,YAAY,kBAAoBljC,IAC3D,KAAK,YAAY,gBAAkBA,GAGrC,KAAK,YAAckjC,CAAA,CAMrB,SAAS93B,EAAgBo3B,EAAkB,GAAa,CAChD,MAAA73B,EAAM,KAAK,MAAM,IACvB,GAAI,CAACA,EACH,MAAM,IAAIhO,EACRF,EAAU,kBACV,gCACF,EAGFkO,EAAI,SAASS,EAAIo3B,EAAkB,KAAO73B,EAAI,QAAQ,EAE1D,CArQak4B,GAGJ,wBAA0BvH,GAHtBuH,GAKJ,uBAAyBpH,GALrBoH,GAOJ,oBAAsB7G;;;;;;;;;;;;;;;;;;;;qiBCrCxB,SAASoH,IAAU,CAET,sBAAO,cAAe/R,EAAU,EAEhC,sBAAO,eAAgB0E,EAAkB,EAEzC,sBAAO,YAAayC,EAAQ,EAC5B,sBAAO,SAAUc,EAAK,EACtB,sBAAO,SAAUM,EAAK,CACvC","names":["gfxGroupCompatibleSymbol","isGfxGroupCompatibleModel","elm","ErrorCode","ErrorCode2","BlockSuiteError","code","message","options","handleError","error","_Vec","n","min","max","A","x","y","z","a","step","B","p1","pc","p2","v1","v2","bounds","P","clamp","u","V","aV","r","from","to","s","t","v","C","d","offset","steps","_","i","k","l","c","px","py","nx","ny","Vec","PointLocation","point","tangent","inVec","outVec","value","vec","EPSILON","MACHINE_EPSILON","PI2","CURVETIME_EPSILON","randomSeed","lineIntersects","sp","ep","sp2","ep2","infinite","cross","almostEqual","u1","u2","epsilon","uMin","uMax","polygonNearestPoint","points","len","rst","dis","p","temp","curDis","polygonPointDistance","nearest","rotatePoints","center","rotate","rad","toRadian","rotatePoint","angle","isPointOnLineSegment","line","polygonGetPointTangent","linePolygonIntersects","result","linePolylineIntersects","polyLineNearestPoint","isPointOnlines","element","hitPoint","threshold","minX","minY","maxX","maxY","rotatedPoint","distance2d","delta","length","U","da","db","x1","y1","x2","y2","xd","yd","square","num","sumSqr","w","distToSegmentSquared","l2","distToSegment","intersects","b","isVecZero","isZero","pointInEllipse","rx","ry","rotation","cos","sin","tdx","tdy","pointInPolygon","wn","pointOnPolygonStoke","next","getSvgPathFromStroke","closed","average","lineEllipseIntersects","D","sqrtD","t1","t2","pl","normalVector","sign","number","getPointFromBoundsWithRotation","h","cx","cy","m","normalizeDegAngle","toDegree","radian","isOverlap","line1","line2","axis","strict","less","getCenterAreaBounds","ratio","nw","nh","serializeXYWH","deserializeXYWH","xywh","e","getIBoundFromPoints","pt","Bound","arg1","width","height","left","top","bound","right","bottom","tolerance","dx","dy","normalizedX","normalizedY","getExpandedBound","getPointsFromBoundWithRotation","getPoints","resPadding","getQuadBoundWithRotation","rect","getBoundWithRotation","getCommonBound","getCommonBoundWithRotation","pre","getBoundFromPoints","inflateBound","half","newBound","transformPointsToNewBound","oldBound","oldMargin","newMargin","wholeOldMargin","wholeNewMargin","oldW","oldH","newW","newH","sleep","ms","signal","resolve","resolved","timeId","noop","nextTick","BaseReactiveYData","doc","event","handler","_a","_b","_c","_d","Y.UndoManager","isLocal","fn","SCHEMA_NOT_FOUND_MESSAGE","TEXT_UNIQ_IDENTIFIER","NATIVE_UNIQ_IDENTIFIER","SYS_KEYS","_Boxed","Y.Map","events","onChange","map","boxed","Boxed","proxies","isPureObject","baseTextAttributes","z.object","z.literal","z.string","Text$1","Text","input","text","Y.Text","yText","callback","index","format","content","attributes","other","begin","end","charNum","contentText","contentLen","isLastOp","isFirstOp","deltas","tmpIndex","rightDeltas","insert","insertRight","rightYText","rightText","native2Y","deep","transform","yArray","YArray","item","yMap","YMap","key","y2Native","yAbstract","data","YText","ReactiveYArray","_source","_ySource","_options","retain","change","proxyList","createYProxy","target","receiver","yData","start","deleteCount","items","count","yItems","yItem","prop","ReactiveYMap","type","current","origin","keyWithoutPrefix","keyWithPrefix","proxySymbol","isProxy","markProxy","isEmptyObject","obj","deleteEmptyObject","parent","getFirstKey","bindOnChangeIfNeed","initializeData","getProxy","root","keys","firstKey","finalData","allLength","acc","path","signalUpdater","shouldByPassSignal","byPassSignalUpdate","basePath","handleNestedUpdate","shouldByPassYjs","isRoot","signalKey","prev","yMapUpdater","initialized","fullPath","list","run","createProxy","base","initializeProxy","proxyHandler","createProxyHandler","proxy","updateSignal","onDispose","signalData","unsubscribe","subscription","stashed","isStashed","yValue","fullKey","getYEventHandler","keysChanged","changes","handleUpdateOrAdd","handleDelete","keyName","updateWithYjsSkip","arr","curr","parentKey","pathKey","ReactiveFlatYMap","_onDispose","_onChange","source","modelLabel","BlockModel","computed","id","block","Subject","take","FlavourSchema","ParentSchema","z.array","ContentSchema","RoleSchema","internalPrimitives","BlockSchema","z.number","z.boolean","z.function","z.custom","z.record","z.any","defineBlockSchema","flavour","props","metadata","toModel","transformer","schema","FlatSyncController","yBlock","version","yChildren","_e","model","reactive","defaultProps","Y.Array","propKey","SyncController","createMutex","_mutex","signalWithProps","dispose","effect","setValue","name","Block","blockSchema","toDraftModel","role","children","DEFAULT_SERVICE_VARIANT","ROOT_SCOPE","RecursionLimitError","CircularDependencyError","dependencyStack","stringifyDependencyStack","ServiceNotFoundError","identifier","stringifyIdentifier","MissingDependencyError","DuplicateServiceDefinitionError","table","counter","stableHash","arg","constructor","isDate","createIdentifier","variant","createIdentifierFromConstructor","parseIdentifier","ServiceProvider","ServiceCachePool","cache","cached","ServiceResolver","provider","depth","stack","sameScope","vars","factory","service","nextResolver","err","optional","BasicServiceProvider","container","scope","createScope","stringifyScope","Container","ContainerEditor","size","identifiers","variants","override","normalizedScope","normalizedIdentifier","normalizedVariant","services","di","cls","deps","dependenciesToFactory","arg2","arg3","args","dep","isAll","isConstructor","StoreIdentifier","runQuery","query","blockViewType","getBlockViewType","queryMode","setAncestorsToDisplayIfHidden","queryObject","queryId","queryFlavour","queryProps","viewType","matchQueryId","matchQueryFlavour","matchQueryProps","isMatch","mode","parentBlock","DisposableGroup","disposeMember","eventOptions","disposeAll","disposable","Subscription","disposables","Extension","_di","StoreExtensionIdentifier","storeExtensionSymbol","StoreExtension","store","isStoreExtensionConstructor","extension","HistoryExtension","canRedo","canUndo","BlockSchemaIdentifier","BlockSchemaExtension","BaseSelection","blockId","SelectionIdentifier","SelectionExtension","selectionCtor","uuidv4","uuidv4IdGenerator","nanoid","nanoidGenerator","StoreSelectionExtension","selection","json","ctor","all","localClientID","state","selections","sel","types","values","Type","group","DocIdentifier","SchemaValidateError","Schema","parentFlavour","childFlavours","validateChildren","childFlavour","childSchema","parentSchema","minimatch","childValue","parentValue","childRole","parentRole","isChildRole","isParentRole","child","_childFlavour","_parentFlavour","_childRole","_parentRole","childValidFlavourOrRole","parentValidFlavourOrRole","makeNewNameWhenConflict","names","ext","newName","AssetsManager","blobId","blob","file","buffer","fileType","__vitePreload","toJSON","fromJSON","BaseBlockTransformer","transformerConfigs","propsJson","draftModel","_props","Slice","models","draftModels","BlockSnapshotSchema","z.unknown","z.lazy","SliceSnapshotSchema","DocMetaSchema","DocSnapshotSchema","BATCH_SIZE","Transformer","blobCRUD","docCRUD","middlewares","snapshot","rootModel","meta","blocks","docSnapshot","slice","pageId","workspaceId","contentSnapshot","blockSnapshot","snapshotLeaf","tmpRootSnapshot","flatSnapshots","blockTree","first","parentModel","targetSibling","contentBlocks","tree","walk","middleware","cleanup","flat","draft","validDraftModels","docMeta","parentId","idx","nodes","startIndex","node","actualIndex","nodeMap","parentNode","traverseAndTrigger","DocCRUD","_yBlocks","_schema","rootId","initialProps","parentIndex","yParent","yParentChildren","bringChildrenTo","deleteChildren","yModel","yModelChildren","modelIndex","bringFlavour","childModel","yBringChildrenTo","deleteById","targetId","findParent","parentYBlock","childId","blocksToMove","newParent","shouldInsertBeforeSibling","childBlocksPerParent","last","insertIndex","targetParentBlock","targetParentChildren","sourceParentBlock","sourceParentChildren","targetIndex","yChildrenArray","syncBlockProps","internalExtensions","Store","readonly","extensions","userExtensions","shouldTransact","spaceDoc","blockModel","init","blockProps","ids","targetModel","placement","modelOrId","callBackOrProps","isCallback","opts","blockFlavour","flavours","initFn","getTopElements","elements","results","e1","e2","traverse","preCallback","postCallBack","visited","innerTraverse","descendantElementsImpl","hasDescendantElementImpl","_container","canSafeAddToContainer","isLockedByAncestorImpl","isLockedBySelfImpl","isLockedImpl","lockElementImpl","unlockElementImpl","GfxBlockElementModel","lockedBySelf","relativePoint","opt","__","GfxCompatibleBlockModel","BlockModelSuperClass","currentClass","BlockServiceIdentifier","BlockFlavourIdentifier","CommandIdentifier","ConfigIdentifier","BlockViewIdentifier","WidgetViewIdentifier","LifeCycleWatcherIdentifier","StdIdentifier","KeymapIdentifier","gfxControllerKey","GfxControllerIdentifier","cutoff","ref","ZOOM_MAX","ZOOM_MIN","ZOOM_STEP","ZOOM_INITIAL","FIT_TO_SCREEN_PADDING","clientToModelCoord","viewport","clientCoord","viewportX","viewportY","zoom","viewScale","clientX","clientY","viewportInternalX","viewportInternalY","modelX","modelY","Viewport","BehaviorSubject","debounce","el","debounceTime","initialTopLeftX","initialTopLeftY","newCenterX","newCenterY","locked","viewportMinXY","viewportMaxXY","centerX","centerY","deltaX","deltaY","padding","maxZoom","fitToScreenPadding","pr","pb","viewportBounds","forceUpdate","newZoom","newCenter","smooth","preZoom","cofficient","focusPoint","totalPaddingWidth","totalPaddingHeight","wheel","prevZoom","numSteps","innerSmoothTranslate","nextCenter","signX","signY","innerSmoothZoom","nextZoom","viewX","viewY","record","BlockSelectionSchema","_BlockSelection","BlockSelection","BlockSelectionExtension","SurfaceSelectionSchema","_SurfaceSelection","editing","inoperable","SurfaceSelection","SurfaceSelectionExtension","PropTypes","expectedClass","validator","validatePropTypes","instance","propTypes","propName","requiredProperties","connectedCallback","SignalWatcher","Base","updateFromLit","WithDisposable","SuperClass","DerivedClass","modelContext","serviceContext","blockComponentSymbol","WIDGET_ID_ATTR","BLOCK_ID_ATTR","ShadowlessElement","LitElement","styles","elementStyles","CSSResult","styleRoot","style","SE","parentRoot","insideShadowRoot","styleInjectedCount","injectedStyles","_std_dec","_store_dec","_EditorHost_decorators","_init","_store","_std","storeContext","stdContext","EditorHost","provide","property","html","nothing","view","widgetViews","widgets","mapping","tag","widgetFlavour","template","unsafeStatic","filter","repeat","__privateAdd","__runInitializers","widgetTags","elementsTags","__decoratorStart","__decorateElement","css","_widgets_dec","_viewType_dec","__service_dec","__renderers_dec","__model_dec","_BlockComponent_decorators","__model","__renderers","__service","_viewType","_widgets","BlockComponent","consume","oldValue","expectedVersion","actualVersion","rootComponent","when","choose","renderer","keymap","cur","isGfxBlockComponent","GfxElementSymbol","updateTransform","updateBlockVisibility","handleGfxConnection","GfxBlockComponent","currentBound","translateX","translateY","scaledX","scaledY","xywh$","zIndex","toGfxBlockComponent","CustomBlock","_viewport_dec","_enableChildrenSchedule_dec","_maxConcurrentRenders_dec","_host_dec","_getModelsInViewport_dec","_GfxViewportElement_decorators","_getModelsInViewport","_host","_maxConcurrentRenders","_enableChildrenSchedule","_viewport","requestThrottledConnectedFrame","func","raqId","latestArgs","GfxViewportElement","gfx","currentViewportModels","currentSelectedModels","shouldBeVisible","previousVisible","batch","promise","schedule","viewportUpdateCallback","blockIds","_f","_g","agent","platform","IS_WEB","IS_SAFARI","IS_FIREFOX","IS_ANDROID","IS_IOS","IS_MAC","IS_IPAD","IS_WINDOWS","IS_MOBILE","ZERO_WIDTH_FOR_EMPTY_LINE","ZERO_WIDTH_FOR_EMBED_NODE","INLINE_ROOT_ATTR","isMaybeInlineRangeEqual","isInlineRangeEqual","isInlineRangeIntersect","intersectInlineRange","_startOffset_dec","_lineIndex_dec","_inlineEditor_dec","_endOffset_dec","_delta_dec","_delta","_endOffset","_inlineEditor","_lineIndex","_startOffset","VElement","inlineRange","vTexts","vText","inlineEditor","attributeRenderer","renderProps","styleMap","__decoratorMetadata","EmbedGap","_index_dec","_elements_dec","_elements","_index","VLine","rootElement","renderElements","nextDelta","_str_dec","_str","VText","inlineTextStyles","textDecorations","inlineCodeStyle","getDefaultAttributeRenderer","InlineHookService","editor","hooks","transformDelta","tmpString","deltaInsertsToChunks","transformedDelta","chunksGenerator","chunk","isInEmbedElement","isInEmbedGap","transformDeltasToEmbedDeltas","dividedDeltas","subInsert","isNativeTextInVText","isVElement","isVLine","isInEmptyLine","vLine","isInlineRoot","calculateTextLength","getTextNodesFromElement","textSpanElement","textNode","nativePointToTextPoint","texts","vElement","getTextPointRoughlyFromElementByOffset","vNodes","getVNodesFromNode","getTextPointFromVNodes","textPointToDomPoint","goalIndex","textParentElement","lineElement","lineIndex","vNode","AFollowedByB","AInsideB","APrecededByB","getTextPointRoughlyFromElement","fromStart","rangeHasAnchorAndFocus","startText","endText","rangeHasAnchorAndFocusHandler","startTextOffset","endTextOffset","anchorDomPoint","focusDomPoint","rangeOnlyHasFocus","rangeOnlyHasFocusHandler","rangeOnlyHasAnchor","rangeOnlyHasAnchorHandler","startDomPoint","rangeHasNoAnchorAndFocus","range","rangeHasNoAnchorAndFocusHandler","buildContext","startContainer","startOffset","endContainer","endOffset","startTextPoint","endTextPoint","domRangeToInlineRange","context","inlineRangeToDomRange","lineElements","anchorOffset","focusOffset","textLength","anchorVElement","nextSibling","focusVElement","handleInsertText","handleInsertReplacementText","deltaEntry","handleInsertParagraph","transformInput","inputType","AttributeService","loose","maybeAttributesList","position","deltaStart","deltaEnd","inlineStart","inlineEnd","newFormat","typedKey","textAttributes","attributeResult","marks","DeltaService","rangeIndex","deltaIndex","EventService","rootRange","ifHandleTargetRange","targetRanges","staticRange","targetInlineRange","ctx","newInlineRange","newData","embed","prevent","previousInlineRange","eventSource","RangeService","beforeIndex","vLines","containerRect","rangeRects","rangeRect","lastInlineRange","Y.createRelativePositionFromTypeIndex","newRange","RenderService","transaction","lastStartRelativePosition","lastEndRelativePosition","absoluteStart","Y.createAbsolutePositionFromRelativePosition","absoluteEnd","endIndex","embedDeltas","chunks","lines","lineStartOffset","render","entry","InlineTextService","match","withoutTransact","deltaInlineRange","normalizedAttributes","coverDeltas","unset","InlineEditor","ops","isEmbed","inlineRangeProvider","vLineRenderer","isReadonly","inlineRoot","effects"],"ignoreList":[],"sources":["../../../framework/std/src/gfx/model/base.ts","../../../framework/global/src/exceptions/code.ts","../../../framework/global/src/exceptions/index.ts","../../../framework/global/src/gfx/model/vec.ts","../../../framework/global/src/gfx/model/point-location.ts","../../../framework/global/src/gfx/math.ts","../../../framework/global/src/gfx/xywh.ts","../../../framework/global/src/gfx/model/bound.ts","../../../framework/global/src/gfx/bound.ts","../../../framework/global/src/utils/function.ts","../../../framework/store/src/reactive/base-reactive-data.ts","../../../framework/store/src/consts.ts","../../../framework/store/src/reactive/boxed.ts","../../../framework/store/src/reactive/memory.ts","../../../framework/store/src/reactive/is-pure-object.ts","../../../framework/store/src/reactive/text/attributes.ts","../../../framework/store/src/reactive/text/text.ts","../../../framework/store/src/reactive/native-y.ts","../../../framework/store/src/reactive/proxy.ts","../../../framework/store/src/reactive/flat-native-y/utils.ts","../../../framework/store/src/reactive/flat-native-y/initialize.ts","../../../framework/store/src/reactive/flat-native-y/signal-updater.ts","../../../framework/store/src/reactive/flat-native-y/y-map-updater.ts","../../../framework/store/src/reactive/flat-native-y/proxy.ts","../../../framework/store/src/reactive/flat-native-y/y-event-handler.ts","../../../framework/store/src/reactive/flat-native-y/index.ts","../../../framework/store/src/model/block/block-model.ts","../../../framework/store/src/model/block/zod.ts","../../../framework/store/src/model/block/flat-sync-controller.ts","../../../framework/store/src/model/block/sync-controller.ts","../../../framework/store/src/model/block/block.ts","../../../framework/store/src/model/block/draft.ts","../../../framework/global/src/di/consts.ts","../../../framework/global/src/di/error.ts","../../../framework/global/src/di/stable-hash.ts","../../../framework/global/src/di/identifier.ts","../../../framework/global/src/di/provider.ts","../../../framework/global/src/di/scope.ts","../../../framework/global/src/di/container.ts","../../../framework/store/src/model/store/identifier.ts","../../../framework/store/src/model/store/query.ts","../../../framework/global/src/disposable/index.ts","../../../framework/store/src/extension/extension.ts","../../../framework/store/src/extension/store-extension.ts","../../../framework/store/src/extension/history/history-extension.ts","../../../framework/store/src/extension/schema.ts","../../../framework/store/src/extension/selection/base.ts","../../../framework/store/src/extension/selection/identifier.ts","../../../framework/store/src/utils/id-generator.ts","../../../framework/store/src/extension/selection/selection-extension.ts","../../../framework/store/src/extension/workspace/doc.ts","../../../framework/store/src/schema/error.ts","../../../framework/store/src/schema/schema.ts","../../../framework/store/src/transformer/assets.ts","../../../framework/store/src/transformer/json.ts","../../../framework/store/src/transformer/base.ts","../../../framework/store/src/transformer/slice.ts","../../../framework/store/src/transformer/type.ts","../../../framework/store/src/transformer/transformer.ts","../../../framework/store/src/model/store/crud.ts","../../../framework/store/src/model/store/utils.ts","../../../framework/store/src/model/store/store.ts","../../../framework/std/src/utils/tree.ts","../../../framework/std/src/gfx/model/gfx-block-model.ts","../../../framework/std/src/identifier.ts","../../../framework/std/src/gfx/identifiers.ts","../../../framework/std/src/gfx/viewport.ts","../../../framework/std/src/selection/block.ts","../../../framework/std/src/selection/surface.ts","../../../framework/std/src/view/decorators/required.ts","../../../framework/global/src/lit/signal-watcher.ts","../../../framework/global/src/lit/with-disposable.ts","../../../framework/std/src/view/element/consts.ts","../../../framework/std/src/view/element/shadowless-element.ts","../../../framework/std/src/view/element/lit-host.ts","../../../framework/std/src/view/element/block-component.ts","../../../framework/std/src/view/element/gfx-block-component.ts","../../../framework/std/src/gfx/viewport-element.ts","../../../framework/global/src/env/index.ts","../../../framework/std/src/inline/consts.ts","../../../framework/std/src/inline/utils/inline-range.ts","../../../framework/std/src/inline/components/v-element.ts","../../../framework/std/src/inline/components/embed-gap.ts","../../../framework/std/src/inline/components/v-line.ts","../../../framework/std/src/inline/components/v-text.ts","../../../framework/std/src/inline/utils/attribute-renderer.ts","../../../framework/std/src/inline/services/hook.ts","../../../framework/std/src/inline/utils/delta-convert.ts","../../../framework/std/src/inline/utils/embed.ts","../../../framework/std/src/inline/utils/guard.ts","../../../framework/std/src/inline/utils/text.ts","../../../framework/std/src/inline/utils/point-conversion.ts","../../../framework/std/src/inline/utils/range-conversion.ts","../../../framework/std/src/inline/utils/transform-input.ts","../../../framework/std/src/inline/services/attribute.ts","../../../framework/std/src/inline/services/delta.ts","../../../framework/std/src/inline/services/event.ts","../../../framework/std/src/inline/services/range.ts","../../../framework/std/src/inline/services/render.ts","../../../framework/std/src/inline/services/text.ts","../../../framework/std/src/inline/inline-editor.ts","../../../framework/std/src/effects.ts"],"sourcesContent":["import type {\n  Bound,\n  IBound,\n  IVec,\n  PointLocation,\n  SerializedXYWH,\n  XYWH,\n} from '@blocksuite/global/gfx';\n\nimport type { EditorHost } from '../../view/element/lit-host.js';\nimport type { GfxGroupModel, GfxModel } from './model.js';\n\n/**\n * The methods that a graphic element should implement.\n * It is already included in the `GfxCompatibleInterface` interface.\n */\nexport interface GfxElementGeometry {\n  containsBound(bound: Bound): boolean;\n  getNearestPoint(point: IVec): IVec;\n  getLineIntersections(start: IVec, end: IVec): PointLocation[] | null;\n  getRelativePointLocation(point: IVec): PointLocation;\n  includesPoint(\n    x: number,\n    y: number,\n    options: PointTestOptions,\n    host: EditorHost\n  ): boolean;\n  intersectsBound(bound: Bound): boolean;\n}\n\n/**\n * All the model that can be rendered in graphics mode should implement this interface.\n */\nexport interface GfxCompatibleInterface extends IBound, GfxElementGeometry {\n  xywh: SerializedXYWH;\n  index: string;\n\n  /**\n   * Defines the extension of the response area beyond the element's bounding box.\n   * This tuple specifies the horizontal and vertical margins to be added to the element's bound.\n   *\n   * The first value represents the horizontal extension (added to both left and right sides),\n   * and the second value represents the vertical extension (added to both top and bottom sides).\n   *\n   * The response area is computed as:\n   * `[x - horizontal, y - vertical, w + 2 * horizontal, h + 2 * vertical]`.\n   *\n   * Example:\n   * - xywh: `[0, 0, 100, 100]`, `responseExtension: [10, 20]`\n   *   Resulting response area: `[-10, -20, 120, 140]`.\n   * - `responseExtension: [0, 0]` keeps the response area equal to the bounding box.\n   */\n  responseExtension: [number, number];\n\n  readonly group: GfxGroupCompatibleInterface | null;\n\n  readonly groups: GfxGroupCompatibleInterface[];\n\n  readonly deserializedXYWH: XYWH;\n\n  /**\n   * The bound of the element without considering the response extension.\n   */\n  readonly elementBound: Bound;\n\n  /**\n   * The bound of the element considering the response extension.\n   */\n  readonly responseBound: Bound;\n\n  /**\n   * Indicates whether the current block is explicitly locked by self.\n   * For checking the lock status of the element, use `isLocked` instead.\n   * For (un)locking the element, use `(un)lock` instead.\n   */\n  lockedBySelf?: boolean;\n\n  /**\n   * Check if the element is locked. It will check the lock status of the element and its ancestors.\n   */\n  isLocked(): boolean;\n  isLockedBySelf(): boolean;\n  isLockedByAncestor(): boolean;\n\n  lock(): void;\n  unlock(): void;\n\n  /**\n   * Whether to disable fallback rendering for this element, e.g., during zooming.\n   * Defaults to false (fallback to placeholder rendering is enabled).\n   */\n  forceFullRender?: boolean;\n}\n\n/**\n * The symbol to mark a model as a container.\n */\nexport const gfxGroupCompatibleSymbol = Symbol('GfxGroupCompatible');\n\n/**\n * Check if the element is a container element.\n */\nexport const isGfxGroupCompatibleModel = (\n  elm: unknown\n): elm is GfxGroupModel => {\n  if (typeof elm !== 'object' || elm === null) return false;\n  return (\n    gfxGroupCompatibleSymbol in elm && elm[gfxGroupCompatibleSymbol] === true\n  );\n};\n\n/**\n * GfxGroupCompatibleElement is a model that can contain other models.\n * It just like a group that in common graphic software.\n */\nexport interface GfxGroupCompatibleInterface extends GfxCompatibleInterface {\n  [gfxGroupCompatibleSymbol]: true;\n\n  /**\n   * All child ids of this container.\n   */\n  childIds: string[];\n\n  /**\n   * All child element models of this container.\n   * Note that the `childElements` may not contains all the children in `childIds`,\n   * because some children may not be loaded.\n   */\n  childElements: GfxModel[];\n\n  descendantElements: GfxModel[];\n\n  addChild(element: GfxCompatibleInterface): void;\n  removeChild(element: GfxCompatibleInterface): void;\n  hasChild(element: GfxCompatibleInterface): boolean;\n\n  hasDescendant(element: GfxCompatibleInterface): boolean;\n}\n\n/**\n * The options for the hit testing of a point.\n */\nexport interface PointTestOptions {\n  /**\n   * The threshold of the hit test. The unit is pixel.\n   */\n  hitThreshold?: number;\n\n  /**\n   * If true, the element bound will be used for the hit testing.\n   * By default, the response bound will be used.\n   */\n  useElementBound?: boolean;\n\n  /**\n   * The padding of the response area for each element when do the hit testing. The unit is pixel.\n   * The first value is the padding for the x-axis, and the second value is the padding for the y-axis.\n   */\n  responsePadding?: [number, number];\n\n  /**\n   * If true, the transparent area of the element will be ignored during the point inclusion test.\n   * Otherwise, the transparent area will be considered as filled area.\n   *\n   * Default is true.\n   */\n  ignoreTransparent?: boolean;\n\n  /**\n   * The zoom level of current view when do the hit testing.\n   */\n  zoom?: number;\n}\n","export enum ErrorCode {\n  DefaultRuntimeError = 1,\n  ReactiveProxyError,\n  DocCollectionError,\n  ModelCRUDError,\n  ValueNotExists,\n  ValueNotInstanceOf,\n  ValueNotEqual,\n  MigrationError,\n  SchemaValidateError,\n  TransformerError,\n  InlineEditorError,\n  TransformerNotImplementedError,\n  EdgelessExportError,\n  CommandError,\n  EventDispatcherError,\n  SelectionError,\n  GfxBlockElementError,\n  MissingViewModelError,\n  DatabaseBlockError,\n  ParsingError,\n  UserAbortError,\n  ExecutionError,\n\n  // Fatal error should be greater than 10000\n  DefaultFatalError = 10000,\n  NoRootModelError,\n  NoSurfaceModelError,\n  NoneSupportedSSRError,\n}\n","import { ErrorCode } from './code.js';\n\nexport class BlockSuiteError extends Error {\n  static ErrorCode = ErrorCode;\n\n  code: ErrorCode;\n\n  isFatal: boolean;\n\n  constructor(code: ErrorCode, message: string, options?: { cause: Error }) {\n    super(message, options);\n    this.name = 'BlockSuiteError';\n    this.code = code;\n    this.isFatal = code >= 10000;\n  }\n}\n\nexport function handleError(error: Error) {\n  if (!(error instanceof BlockSuiteError)) {\n    throw error;\n  }\n\n  if (error.isFatal) {\n    throw new Error(\n      'A fatal error for BlockSuite occurs, please contact the team if you find this.',\n      { cause: error }\n    );\n  }\n\n  console.error(\n    \"A runtime error for BlockSuite occurs, you can ignore this error if it won't break the user experience.\"\n  );\n  console.error(error.stack);\n}\n\nexport * from './code.js';\n","// Inlined from https://raw.githubusercontent.com/tldraw/tldraw/24cad6959f59f93e20e556d018c391fd89d4ecca/packages/vec/src/index.ts\n// Credits to tldraw\n\nexport type IVec = [number, number];\n\nexport type IVec3 = [number, number, number];\n\nexport class Vec {\n  /**\n   * Absolute value of a vector.\n   * @param A\n   * @returns\n   */\n  static abs = (A: number[]): number[] => {\n    return [Math.abs(A[0]), Math.abs(A[1])];\n  };\n\n  /**\n   * Add vectors.\n   * @param A\n   * @param B\n   */\n  static add = (A: number[], B: number[]): IVec => {\n    return [A[0] + B[0], A[1] + B[1]];\n  };\n\n  /**\n   * Add scalar to vector.\n   * @param A\n   * @param B\n   */\n  static addScalar = (A: number[], n: number): IVec => {\n    return [A[0] + n, A[1] + n];\n  };\n\n  /**\n   * Angle between vector A and vector B in radians\n   * @param A\n   * @param B\n   */\n  static ang = (A: number[], B: number[]): number => {\n    return Math.atan2(Vec.cpr(A, B), Vec.dpr(A, B));\n  };\n\n  /**\n   * Get the angle between the three vectors A, B, and C.\n   * @param p1\n   * @param pc\n   * @param p2\n   */\n  static ang3 = (p1: IVec, pc: IVec, p2: IVec): number => {\n    // this,\n    const v1 = Vec.vec(pc, p1);\n    const v2 = Vec.vec(pc, p2);\n    return Vec.ang(v1, v2);\n  };\n\n  /**\n   * Angle between vector A and vector B in radians\n   * @param A\n   * @param B\n   */\n  static angle = (A: IVec, B: IVec): number => {\n    return Math.atan2(B[1] - A[1], B[0] - A[0]);\n  };\n\n  /**\n   * Get whether p1 is left of p2, relative to pc.\n   * @param p1\n   * @param pc\n   * @param p2\n   */\n  static clockwise = (p1: number[], pc: number[], p2: number[]): boolean => {\n    return Vec.isLeft(p1, pc, p2) > 0;\n  };\n\n  /**\n   * Cross product (outer product) | A X B |\n   * @param A\n   * @param B\n   */\n  static cpr = (A: number[], B: number[]): number => {\n    return A[0] * B[1] - B[0] * A[1];\n  };\n\n  /**\n   * Dist length from A to B\n   * @param A\n   * @param B\n   */\n  static dist = (A: number[], B: number[]): number => {\n    return Math.hypot(A[1] - B[1], A[0] - B[0]);\n  };\n\n  /**\n   * Dist length from A to B squared.\n   * @param A\n   * @param B\n   */\n  static dist2 = (A: IVec, B: IVec): number => {\n    return Vec.len2(Vec.sub(A, B));\n  };\n\n  /**\n   * Distance between a point and the nearest point on a bounding box.\n   * @param bounds The bounding box.\n   * @param P The point\n   * @returns\n   */\n  static distanceToBounds = (\n    bounds: {\n      minX: number;\n      minY: number;\n      maxX: number;\n      maxY: number;\n    },\n    P: number[]\n  ): number => {\n    return Vec.dist(P, Vec.nearestPointOnBounds(bounds, P));\n  };\n\n  /**\n   * Distance between a point and the nearest point on a line segment between A and B\n   * @param A The start of the line segment\n   * @param B The end of the line segment\n   * @param P The off-line point\n   * @param clamp Whether to clamp the point between A and B.\n   * @returns\n   */\n  static distanceToLineSegment = (\n    A: IVec,\n    B: IVec,\n    P: IVec,\n    clamp = true\n  ): number => {\n    return Vec.dist(P, Vec.nearestPointOnLineSegment(A, B, P, clamp));\n  };\n\n  /**\n   * Distance between a point and a line with a known unit vector that passes through a point.\n   * @param A Any point on the line\n   * @param u The unit vector for the line.\n   * @param P A point not on the line to test.\n   * @returns\n   */\n  static distanceToLineThroughPoint = (A: IVec, u: IVec, P: IVec): number => {\n    return Vec.dist(P, Vec.nearestPointOnLineThroughPoint(A, u, P));\n  };\n\n  /**\n   * Vector division by scalar.\n   * @param A\n   * @param n\n   */\n  static div = (A: IVec, n: number): IVec => {\n    return [A[0] / n, A[1] / n];\n  };\n\n  /**\n   * Vector division by vector.\n   * @param A\n   * @param n\n   */\n  static divV = (A: IVec, B: IVec): IVec => {\n    return [A[0] / B[0], A[1] / B[1]];\n  };\n\n  /**\n   * Dot product\n   * @param A\n   * @param B\n   */\n  static dpr = (A: number[], B: number[]): number => {\n    return A[0] * B[0] + A[1] * B[1];\n  };\n\n  /**\n   * A faster, though less accurate method for testing distances. Maybe faster?\n   * @param A\n   * @param B\n   * @returns\n   */\n  static fastDist = (A: number[], B: number[]): number[] => {\n    const V = [B[0] - A[0], B[1] - A[1]];\n    const aV = [Math.abs(V[0]), Math.abs(V[1])];\n    let r = 1 / Math.max(aV[0], aV[1]);\n    r = r * (1.29289 - (aV[0] + aV[1]) * r * 0.29289);\n    return [V[0] * r, V[1] * r];\n  };\n\n  /**\n   * Interpolate from A to B when curVAL goes fromVAL: number[] => to\n   * @param A\n   * @param B\n   * @param from Starting value\n   * @param to Ending value\n   * @param s Strength\n   */\n  static int = (A: IVec, B: IVec, from: number, to: number, s = 1): IVec => {\n    const t = (Vec.clamp(from, to) - from) / (to - from);\n    return Vec.add(Vec.mul(A, 1 - t), Vec.mul(B, s));\n  };\n\n  /**\n   * Check of two vectors are identical.\n   * @param A\n   * @param B\n   */\n  static isEqual = (A: number[], B: number[]): boolean => {\n    return A[0] === B[0] && A[1] === B[1];\n  };\n\n  /**\n   * Get whether p1 is left of p2, relative to pc.\n   * @param p1\n   * @param pc\n   * @param p2\n   */\n  static isLeft = (p1: number[], pc: number[], p2: number[]): number => {\n    //  isLeft: >0 for counterclockwise\n    //          =0 for none (degenerate)\n    //          <0 for clockwise\n    return (\n      (pc[0] - p1[0]) * (p2[1] - p1[1]) - (p2[0] - p1[0]) * (pc[1] - p1[1])\n    );\n  };\n\n  /**\n   * Length of the vector\n   * @param A\n   */\n  static len = (A: number[]): number => {\n    return Math.hypot(A[0], A[1]);\n  };\n\n  /**\n   * Length of the vector squared\n   * @param A\n   */\n  static len2 = (A: number[]): number => {\n    return A[0] * A[0] + A[1] * A[1];\n  };\n\n  /**\n   * Interpolate vector A to B with a scalar t\n   * @param A\n   * @param B\n   * @param t scalar\n   */\n  static lrp = (A: IVec, B: IVec, t: number): IVec => {\n    return Vec.add(A, Vec.mul(Vec.sub(B, A), t));\n  };\n\n  /**\n   * Get a vector comprised of the maximum of two or more vectors.\n   */\n  static max = (...v: number[][]) => {\n    return [Math.max(...v.map(a => a[0])), Math.max(...v.map(a => a[1]))];\n  };\n\n  /**\n   * Mean between two vectors or mid vector between two vectors\n   * @param A\n   * @param B\n   */\n  static med = (A: IVec, B: IVec): IVec => {\n    return Vec.mul(Vec.add(A, B), 0.5);\n  };\n\n  /**\n   * Get a vector comprised of the minimum of two or more vectors.\n   */\n  static min = (...v: number[][]) => {\n    return [Math.min(...v.map(a => a[0])), Math.min(...v.map(a => a[1]))];\n  };\n\n  /**\n   * Vector multiplication by scalar\n   * @param A\n   * @param n\n   */\n  static mul = (A: IVec, n: number): IVec => {\n    return [A[0] * n, A[1] * n];\n  };\n\n  /**\n   * Multiple two vectors.\n   * @param A\n   * @param B\n   */\n  static mulV = (A: IVec, B: IVec): IVec => {\n    return [A[0] * B[0], A[1] * B[1]];\n  };\n\n  /**\n   * Get the nearest point on a bounding box to a point P.\n   * @param bounds The bounding box\n   * @param P The point point\n   * @returns\n   */\n  static nearestPointOnBounds = (\n    bounds: {\n      minX: number;\n      minY: number;\n      maxX: number;\n      maxY: number;\n    },\n    P: number[]\n  ): number[] => {\n    return [\n      Vec.clamp(P[0], bounds.minX, bounds.maxX),\n      Vec.clamp(P[1], bounds.minY, bounds.maxY),\n    ];\n  };\n\n  /**\n   * Get the nearest point on a line segment between A and B\n   * @param A The start of the line segment\n   * @param B The end of the line segment\n   * @param P The off-line point\n   * @param clamp Whether to clamp the point between A and B.\n   * @returns\n   */\n  static nearestPointOnLineSegment = (\n    A: IVec,\n    B: IVec,\n    P: IVec,\n    clamp = true\n  ): IVec => {\n    const u = Vec.uni(Vec.sub(B, A));\n    const C = Vec.add(A, Vec.mul(u, Vec.pry(Vec.sub(P, A), u)));\n\n    if (clamp) {\n      if (C[0] < Math.min(A[0], B[0])) return A[0] < B[0] ? A : B;\n      if (C[0] > Math.max(A[0], B[0])) return A[0] > B[0] ? A : B;\n      if (C[1] < Math.min(A[1], B[1])) return A[1] < B[1] ? A : B;\n      if (C[1] > Math.max(A[1], B[1])) return A[1] > B[1] ? A : B;\n    }\n\n    return C;\n  };\n\n  /**\n   * Get the nearest point on a line with a known unit vector that passes through point A\n   * @param A Any point on the line\n   * @param u The unit vector for the line.\n   * @param P A point not on the line to test.\n   * @returns\n   */\n  static nearestPointOnLineThroughPoint = (A: IVec, u: IVec, P: IVec): IVec => {\n    return Vec.add(A, Vec.mul(u, Vec.pry(Vec.sub(P, A), u)));\n  };\n\n  /**\n   * Negate a vector.\n   * @param A\n   */\n  static neg = (A: number[]): number[] => {\n    return [-A[0], -A[1]];\n  };\n\n  /**\n   * Get normalized / unit vector.\n   * @param A\n   */\n  static normalize = (A: IVec): IVec => {\n    return Vec.uni(A);\n  };\n\n  /**\n   * Push a point A towards point B by a given distance.\n   * @param A\n   * @param B\n   * @param d\n   * @returns\n   */\n  static nudge = (A: IVec, B: IVec, d: number): number[] => {\n    if (Vec.isEqual(A, B)) return A;\n    return Vec.add(A, Vec.mul(Vec.uni(Vec.sub(B, A)), d));\n  };\n\n  /**\n   * Push a point in a given angle by a given distance.\n   * @param A\n   * @param B\n   * @param d\n   */\n  static nudgeAtAngle = (A: number[], a: number, d: number): number[] => {\n    return [Math.cos(a) * d + A[0], Math.sin(a) * d + A[1]];\n  };\n\n  /**\n   * Perpendicular rotation of a vector A\n   * @param A\n   */\n  static per = (A: IVec): IVec => {\n    return [A[1], -A[0]];\n  };\n\n  static pointOffset = (A: IVec, B: IVec, offset: number): IVec => {\n    let u = Vec.uni(Vec.sub(B, A));\n    if (Vec.isEqual(A, B)) u = A;\n    return Vec.add(A, Vec.mul(u, offset));\n  };\n\n  /**\n   * Get an array of points between two points.\n   * @param A The first point.\n   * @param B The second point.\n   * @param steps The number of points to return.\n   */\n  static pointsBetween = (A: IVec, B: IVec, steps = 6): number[][] => {\n    return Array.from({ length: steps }).map((_, i) => {\n      const t = i / (steps - 1);\n      const k = Math.min(1, 0.5 + Math.abs(0.5 - t));\n      return [...Vec.lrp(A, B, t), k];\n    });\n  };\n\n  /**\n   * Project A over B\n   * @param A\n   * @param B\n   */\n  static pry = (A: number[], B: number[]): number => {\n    return Vec.dpr(A, B) / Vec.len(B);\n  };\n\n  static rescale = (a: number[], n: number): number[] => {\n    const l = Vec.len(a);\n    return [(n * a[0]) / l, (n * a[1]) / l];\n  };\n\n  /**\n   * Vector rotation by r (radians)\n   * @param A\n   * @param r rotation in radians\n   */\n  static rot = (A: number[], r = 0): IVec => {\n    return [\n      A[0] * Math.cos(r) - A[1] * Math.sin(r),\n      A[0] * Math.sin(r) + A[1] * Math.cos(r),\n    ];\n  };\n\n  /**\n   * Rotate a vector around another vector by r (radians)\n   * @param A vector\n   * @param C center\n   * @param r rotation in radians\n   */\n  static rotWith = (A: IVec, C: IVec, r = 0): IVec => {\n    if (r === 0) return A;\n\n    const s = Math.sin(r);\n    const c = Math.cos(r);\n\n    const px = A[0] - C[0];\n    const py = A[1] - C[1];\n\n    const nx = px * c - py * s;\n    const ny = px * s + py * c;\n\n    return [nx + C[0], ny + C[1]];\n  };\n\n  /**\n   * Get the slope between two points.\n   * @param A\n   * @param B\n   */\n  static slope = (A: number[], B: number[]) => {\n    if (A[0] === B[0]) return NaN;\n    return (A[1] - B[1]) / (A[0] - B[0]);\n  };\n\n  /**\n   * Subtract vectors.\n   * @param A\n   * @param B\n   */\n  static sub = (A: IVec, B: IVec): IVec => {\n    return [A[0] - B[0], A[1] - B[1]];\n  };\n\n  /**\n   * Subtract scalar from vector.\n   * @param A\n   * @param B\n   */\n  static subScalar = (A: IVec, n: number): IVec => {\n    return [A[0] - n, A[1] - n];\n  };\n\n  /**\n   * Get the tangent between two vectors.\n   * @param A\n   * @param B\n   * @returns\n   */\n  static tangent = (A: IVec, B: IVec): IVec => {\n    return Vec.uni(Vec.sub(A, B));\n  };\n\n  /**\n   * Round a vector to two decimal places.\n   * @param a\n   */\n  static toFixed = (a: number[]): number[] => {\n    return a.map(v => Math.round(v * 100) / 100);\n  };\n\n  static toPoint = (v: IVec) => {\n    return {\n      x: v[0],\n      y: v[1],\n    };\n  };\n\n  /**\n   * Round a vector to a precision length.\n   * @param a\n   * @param n\n   */\n  static toPrecision = (a: number[], n = 4): number[] => {\n    return [+a[0].toPrecision(n), +a[1].toPrecision(n)];\n  };\n\n  static toVec = (v: { x: number; y: number }): IVec => [v.x, v.y];\n\n  /**\n   * Get normalized / unit vector.\n   * @param A\n   */\n  static uni = (A: IVec): IVec => {\n    return Vec.div(A, Vec.len(A));\n  };\n\n  /**\n   * Get the vector from vectors A to B.\n   * @param A\n   * @param B\n   */\n  static vec = (A: IVec, B: IVec): IVec => {\n    // A, B as vectors get the vector from A to B\n    return [B[0] - A[0], B[1] - A[1]];\n  };\n\n  /**\n   * Clamp a value into a range.\n   * @param n\n   * @param min\n   */\n  static clamp(n: number, min: number): number;\n\n  // eslint-disable-next-line @typescript-eslint/unified-signatures\n  static clamp(n: number, min: number, max: number): number;\n\n  static clamp(n: number, min: number, max?: number): number {\n    return Math.max(min, max !== undefined ? Math.min(n, max) : n);\n  }\n\n  /**\n   * Clamp a value into a range.\n   * @param n\n   * @param min\n   */\n  static clampV(A: IVec, min: number, max?: number): IVec;\n\n  static clampV(A: number[], min: number): number[];\n\n  // eslint-disable-next-line @typescript-eslint/unified-signatures\n  static clampV(A: number[], min: number, max: number): number[];\n\n  static clampV(A: number[], min: number, max?: number): number[] {\n    return A.map(n =>\n      max !== undefined ? Vec.clamp(n, min, max) : Vec.clamp(n, min)\n    );\n  }\n\n  /**\n   * Cross (for point in polygon)\n   *\n   */\n  static cross(x: number[], y: number[], z: number[]): number {\n    return (y[0] - x[0]) * (z[1] - x[1]) - (z[0] - x[0]) * (y[1] - x[1]);\n  }\n\n  /**\n   * Snap vector to nearest step.\n   * @param A\n   * @param step\n   * @example\n   * ```ts\n   * Vec.snap([10.5, 28], 10) // [10, 30]\n   * ```\n   */\n  static snap(a: number[], step = 1) {\n    return [Math.round(a[0] / step) * step, Math.round(a[1] / step) * step];\n  }\n}\n","import { type IVec, Vec } from './vec.js';\n\n/**\n * PointLocation is an implementation of IVec with in/out vectors and tangent.\n * This is useful when dealing with path.\n */\nexport class PointLocation extends Array<number> implements IVec {\n  _in: IVec = [0, 0];\n\n  _out: IVec = [0, 0];\n\n  // the tangent belongs to the point on the element outline\n  _tangent: IVec = [0, 0];\n\n  [0]: number;\n\n  [1]: number;\n\n  get absIn() {\n    return Vec.add(this, this._in);\n  }\n\n  get absOut() {\n    return Vec.add(this, this._out);\n  }\n\n  get in() {\n    return this._in;\n  }\n\n  set in(value: IVec) {\n    this._in = value;\n  }\n\n  override get length() {\n    return super.length as 2;\n  }\n\n  get out() {\n    return this._out;\n  }\n\n  set out(value: IVec) {\n    this._out = value;\n  }\n\n  get tangent() {\n    return this._tangent;\n  }\n\n  set tangent(value: IVec) {\n    this._tangent = value;\n  }\n\n  constructor(\n    point: IVec = [0, 0],\n    tangent: IVec = [0, 0],\n    inVec: IVec = [0, 0],\n    outVec: IVec = [0, 0]\n  ) {\n    super(2);\n    this[0] = point[0];\n    this[1] = point[1];\n    this._tangent = tangent;\n    this._in = inVec;\n    this._out = outVec;\n  }\n\n  static fromVec(vec: IVec) {\n    const point = new PointLocation();\n    point[0] = vec[0];\n    point[1] = vec[1];\n    return point;\n  }\n\n  clone() {\n    return new PointLocation(\n      this as unknown as IVec,\n      this._tangent,\n      this._in,\n      this._out\n    );\n  }\n\n  setVec(vec: IVec) {\n    this[0] = vec[0];\n    this[1] = vec[1];\n    return this;\n  }\n\n  toVec(): IVec {\n    return [this[0], this[1]];\n  }\n}\n","import type { Bound, IBound } from './model/bound.js';\nimport { PointLocation } from './model/point-location.js';\nimport { type IVec, Vec } from './model/vec.js';\n\nexport const EPSILON = 1e-12;\nexport const MACHINE_EPSILON = 1.12e-16;\nexport const PI2 = Math.PI * 2;\nexport const CURVETIME_EPSILON = 1e-8;\n\nexport function randomSeed(): number {\n  return Math.floor(Math.random() * 2 ** 31);\n}\n\n/**\n * Calculates the intersection point of two line segments.\n *\n * @param sp - Start point of the first line segment [x, y]\n * @param ep - End point of the first line segment [x, y]\n * @param sp2 - Start point of the second line segment [x, y]\n * @param ep2 - End point of the second line segment [x, y]\n * @param infinite - If true, treats the lines as infinite lines rather than line segments\n * @returns The intersection point [x, y] if the lines intersect, null if they are parallel or coincident\n *\n * @example\n * const intersection = lineIntersects([0, 0], [2, 2], [0, 2], [2, 0]);\n * // Returns [1, 1] - the intersection point of the two line segments\n *\n * @example\n * const parallel = lineIntersects([0, 0], [2, 2], [0, 1], [2, 3], true);\n * // Returns null - the lines are parallel\n */\nexport function lineIntersects(\n  sp: IVec,\n  ep: IVec,\n  sp2: IVec,\n  ep2: IVec,\n  infinite = false\n): IVec | null {\n  const v1 = Vec.sub(ep, sp);\n  const v2 = Vec.sub(ep2, sp2);\n  const cross = Vec.cpr(v1, v2);\n  // Avoid divisions by 0, and errors when getting too close to 0\n  if (almostEqual(cross, 0, MACHINE_EPSILON)) return null;\n  const d = Vec.sub(sp, sp2);\n  let u1 = Vec.cpr(v2, d) / cross;\n  const u2 = Vec.cpr(v1, d) / cross,\n    // Check the ranges of the u parameters if the line is not\n    // allowed to extend beyond the definition points, but\n    // compare with EPSILON tolerance over the [0, 1] bounds.\n    epsilon = /*#=*/ EPSILON,\n    uMin = -epsilon,\n    uMax = 1 + epsilon;\n\n  if (infinite || (uMin < u1 && u1 < uMax && uMin < u2 && u2 < uMax)) {\n    // Address the tolerance at the bounds by clipping to\n    // the actual range.\n    if (!infinite) {\n      u1 = clamp(u1, 0, 1);\n    }\n    return Vec.lrp(sp, ep, u1);\n  }\n\n  return null;\n}\n\n/**\n * Finds the nearest point on a polygon to a given point.\n *\n * @param points - Array of points defining the polygon vertices [x, y][]\n * @param point - The point to find the nearest point to [x, y]\n * @returns The nearest point on the polygon to the given point\n * @throws Error if points array is empty or has less than 2 points\n */\nexport function polygonNearestPoint(points: IVec[], point: IVec) {\n  const len = points.length;\n  if (len < 2) {\n    throw new Error('Polygon must have at least 2 points');\n  }\n\n  let rst: IVec = points[0]; // Initialize with first point as fallback\n  let dis = Vec.dist(points[0], point);\n\n  for (let i = 0; i < len; i++) {\n    const p = points[i];\n    const p2 = points[(i + 1) % len];\n    const temp = Vec.nearestPointOnLineSegment(p, p2, point, true);\n    const curDis = Vec.dist(temp, point);\n    if (curDis < dis) {\n      dis = curDis;\n      rst = temp;\n    }\n  }\n  return rst;\n}\n\nexport function polygonPointDistance(points: IVec[], point: IVec) {\n  const nearest = polygonNearestPoint(points, point);\n  return Vec.dist(nearest, point);\n}\n\nexport function rotatePoints<T extends IVec>(\n  points: T[],\n  center: IVec,\n  rotate: number\n): T[] {\n  const rad = toRadian(rotate);\n  return points.map(p => Vec.rotWith(p, center, rad)) as T[];\n}\n\nexport function rotatePoint(\n  point: [number, number],\n  center: IVec,\n  rotate: number\n): [number, number] {\n  const rad = toRadian(rotate);\n  return Vec.add(center, Vec.rot(Vec.sub(point, center), rad)) as [\n    number,\n    number,\n  ];\n}\n\nexport function toRadian(angle: number) {\n  return (angle * Math.PI) / 180;\n}\n\nexport function isPointOnLineSegment(point: IVec, line: IVec[]) {\n  const [sp, ep] = line;\n  const v1 = Vec.sub(point, sp);\n  const v2 = Vec.sub(point, ep);\n  return almostEqual(Vec.cpr(v1, v2), 0, 0.01) && Vec.dpr(v1, v2) <= 0;\n}\n\nexport function polygonGetPointTangent(points: IVec[], point: IVec): IVec {\n  const len = points.length;\n  for (let i = 0; i < len; i++) {\n    const p = points[i];\n    const p2 = points[(i + 1) % len];\n    if (isPointOnLineSegment(point, [p, p2])) {\n      return Vec.normalize(Vec.sub(p2, p));\n    }\n  }\n  return [0, 0];\n}\n\nexport function linePolygonIntersects(\n  sp: IVec,\n  ep: IVec,\n  points: IVec[]\n): PointLocation[] | null {\n  const result: PointLocation[] = [];\n  const len = points.length;\n\n  for (let i = 0; i < len; i++) {\n    const p = points[i];\n    const p2 = points[(i + 1) % len];\n    const rst = lineIntersects(sp, ep, p, p2);\n    if (rst) {\n      const v = new PointLocation(rst);\n      v.tangent = Vec.normalize(Vec.sub(p2, p));\n      result.push(v);\n    }\n  }\n\n  return result.length ? result : null;\n}\n\nexport function linePolylineIntersects(\n  sp: IVec,\n  ep: IVec,\n  points: IVec[]\n): PointLocation[] | null {\n  const result: PointLocation[] = [];\n  const len = points.length;\n\n  for (let i = 0; i < len - 1; i++) {\n    const p = points[i];\n    const p2 = points[i + 1];\n    const rst = lineIntersects(sp, ep, p, p2);\n    if (rst) {\n      result.push(new PointLocation(rst, Vec.normalize(Vec.sub(p2, p))));\n    }\n  }\n\n  return result.length ? result : null;\n}\n\nexport function polyLineNearestPoint(points: IVec[], point: IVec) {\n  const len = points.length;\n  let rst: IVec;\n  let dis = Infinity;\n  for (let i = 0; i < len - 1; i++) {\n    const p = points[i];\n    const p2 = points[i + 1];\n    const temp = Vec.nearestPointOnLineSegment(p, p2, point, true);\n    const curDis = Vec.dist(temp, point);\n    if (curDis < dis) {\n      dis = curDis;\n      rst = temp;\n    }\n  }\n  return rst!;\n}\n\nexport function isPointOnlines(\n  element: Bound,\n  points: readonly [number, number][],\n  rotate: number,\n  hitPoint: [number, number],\n  threshold: number\n): boolean {\n  // credit to Excalidraw hitTestFreeDrawElement\n\n  let x: number;\n  let y: number;\n\n  if (rotate === 0) {\n    x = hitPoint[0] - element.x;\n    y = hitPoint[1] - element.y;\n  } else {\n    // Counter-rotate the point around center before testing\n    const { minX, minY, maxX, maxY } = element;\n    const rotatedPoint = rotatePoint(\n      hitPoint,\n      [minX + (maxX - minX) / 2, minY + (maxY - minY) / 2],\n      -rotate\n    ) as [number, number];\n    x = rotatedPoint[0] - element.x;\n    y = rotatedPoint[1] - element.y;\n  }\n\n  let [A, B] = points;\n  let P: readonly [number, number];\n\n  // For freedraw dots\n  if (\n    distance2d(A[0], A[1], x, y) < threshold ||\n    distance2d(B[0], B[1], x, y) < threshold\n  ) {\n    return true;\n  }\n\n  // For freedraw lines\n  for (let i = 0; i < points.length; i++) {\n    const delta = [B[0] - A[0], B[1] - A[1]];\n    const length = Math.hypot(delta[1], delta[0]);\n\n    const U = [delta[0] / length, delta[1] / length];\n    const C = [x - A[0], y - A[1]];\n    const d = (C[0] * U[0] + C[1] * U[1]) / Math.hypot(U[1], U[0]);\n    P = [A[0] + U[0] * d, A[1] + U[1] * d];\n\n    const da = distance2d(P[0], P[1], A[0], A[1]);\n    const db = distance2d(P[0], P[1], B[0], B[1]);\n\n    P = db < da && da > length ? B : da < db && db > length ? A : P;\n\n    if (Math.hypot(y - P[1], x - P[0]) < threshold) {\n      return true;\n    }\n\n    A = B;\n    B = points[i + 1];\n  }\n\n  return false;\n}\n\nexport const distance2d = (x1: number, y1: number, x2: number, y2: number) => {\n  const xd = x2 - x1;\n  const yd = y2 - y1;\n  return Math.hypot(xd, yd);\n};\n\nfunction square(num: number) {\n  return num * num;\n}\n\nfunction sumSqr(v: IVec, w: IVec) {\n  return square(v[0] - w[0]) + square(v[1] - w[1]);\n}\n\nfunction distToSegmentSquared(p: IVec, v: IVec, w: IVec) {\n  const l2 = sumSqr(v, w);\n\n  if (l2 == 0) return sumSqr(p, v);\n  let t = ((p[0] - v[0]) * (w[0] - v[0]) + (p[1] - v[1]) * (w[1] - v[1])) / l2;\n\n  t = Math.max(0, Math.min(1, t));\n\n  return sumSqr(p, [v[0] + t * (w[0] - v[0]), v[1] + t * (w[1] - v[1])]);\n}\n\nfunction distToSegment(p: IVec, v: IVec, w: IVec) {\n  return Math.sqrt(distToSegmentSquared(p, v, w));\n}\n\nexport function isPointIn(a: IBound, x: number, y: number): boolean {\n  return a.x <= x && x <= a.x + a.w && a.y <= y && y <= a.y + a.h;\n}\n\nexport function intersects(a: IBound, b: IBound): boolean {\n  return (\n    a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y\n  );\n}\n\nexport function almostEqual(a: number, b: number, epsilon = 0.0001) {\n  return Math.abs(a - b) < epsilon;\n}\n\nexport function isVecZero(v: IVec) {\n  return v.every(n => isZero(n));\n}\n\nexport function isZero(x: number) {\n  return x >= -EPSILON && x <= EPSILON;\n}\n\nexport function pointAlmostEqual(a: IVec, b: IVec, _epsilon = 0.0001) {\n  return a.length === b.length && a.every((v, i) => almostEqual(v, b[i]));\n}\n\nexport function clamp(n: number, min: number, max?: number): number {\n  return Math.max(min, max !== undefined ? Math.min(n, max) : n);\n}\n\nexport function pointInEllipse(\n  A: IVec,\n  C: IVec,\n  rx: number,\n  ry: number,\n  rotation = 0\n): boolean {\n  const cos = Math.cos(rotation);\n  const sin = Math.sin(rotation);\n  const delta = Vec.sub(A, C);\n  const tdx = cos * delta[0] + sin * delta[1];\n  const tdy = sin * delta[0] - cos * delta[1];\n\n  return (tdx * tdx) / (rx * rx) + (tdy * tdy) / (ry * ry) <= 1;\n}\n\nexport function pointInPolygon(p: IVec, points: IVec[]): boolean {\n  let wn = 0; // winding number\n\n  points.forEach((a, i) => {\n    const b = points[(i + 1) % points.length];\n    if (a[1] <= p[1]) {\n      if (b[1] > p[1] && Vec.cross(a, b, p) > 0) {\n        wn += 1;\n      }\n    } else if (b[1] <= p[1] && Vec.cross(a, b, p) < 0) {\n      wn -= 1;\n    }\n  });\n\n  return wn !== 0;\n}\n\nexport function pointOnEllipse(\n  point: IVec,\n  rx: number,\n  ry: number,\n  threshold: number\n): boolean {\n  // slope of point\n  const t = point[1] / point[0];\n  const squaredX =\n    (square(rx) * square(ry)) / (square(rx) * square(t) + square(ry));\n  const squaredY =\n    (square(rx) * square(ry) - square(ry) * squaredX) / square(rx);\n\n  return (\n    Math.abs(\n      Math.sqrt(square(point[1]) + square(point[0])) -\n        Math.sqrt(squaredX + squaredY)\n    ) < threshold\n  );\n}\n\nexport function pointOnPolygonStoke(\n  p: IVec,\n  points: IVec[],\n  threshold: number\n): boolean {\n  for (let i = 0; i < points.length; ++i) {\n    const next = i + 1 === points.length ? 0 : i + 1;\n    if (distToSegment(p, points[i], points[next]) <= threshold) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\nexport function getPolygonPathFromPoints(\n  points: IVec[],\n  closed = true\n): string {\n  const len = points.length;\n  if (len < 2) return ``;\n\n  const a = points[0];\n  const b = points[1];\n\n  let res = `M${a[0].toFixed(2)},${a[1].toFixed()}L${b[0].toFixed(2)},${b[1].toFixed()}`;\n\n  for (let i = 2; i < len; i++) {\n    const a = points[i];\n    res += `L${a[0].toFixed(2)},${a[1].toFixed()}`;\n  }\n\n  if (closed) res += 'Z';\n  return res;\n}\nexport function getSvgPathFromStroke(points: IVec[], closed = true): string {\n  const len = points.length;\n\n  if (len < 4) {\n    return ``;\n  }\n\n  let a = points[0];\n  let b = points[1];\n  const c = points[2];\n\n  let result = `M${a[0].toFixed(2)},${a[1].toFixed(2)} Q${b[0].toFixed(\n    2\n  )},${b[1].toFixed(2)} ${average(b[0], c[0]).toFixed(2)},${average(\n    b[1],\n    c[1]\n  ).toFixed(2)} T`;\n\n  for (let i = 2, max = len - 1; i < max; i++) {\n    a = points[i];\n    b = points[i + 1];\n    result += `${average(a[0], b[0]).toFixed(2)},${average(a[1], b[1]).toFixed(\n      2\n    )} `;\n  }\n\n  if (closed) {\n    result += 'Z';\n  }\n\n  return result;\n}\n\nfunction average(a: number, b: number): number {\n  return (a + b) / 2;\n}\n\n//reference https://www.xarg.org/book/computer-graphics/line-segment-ellipse-intersection/\nexport function lineEllipseIntersects(\n  A: IVec,\n  B: IVec,\n  C: IVec,\n  rx: number,\n  ry: number,\n  rad = 0\n) {\n  A = Vec.rot(Vec.sub(A, C), -rad);\n  B = Vec.rot(Vec.sub(B, C), -rad);\n\n  rx *= rx;\n  ry *= ry;\n\n  const rst: IVec[] = [];\n\n  const v = Vec.sub(B, A);\n\n  const a = rx * v[1] * v[1] + ry * v[0] * v[0];\n  const b = 2 * (rx * A[1] * v[1] + ry * A[0] * v[0]);\n  const c = rx * A[1] * A[1] + ry * A[0] * A[0] - rx * ry;\n\n  const D = b * b - 4 * a * c; // Discriminant\n\n  if (D >= 0) {\n    const sqrtD = Math.sqrt(D);\n    const t1 = (-b + sqrtD) / (2 * a);\n    const t2 = (-b - sqrtD) / (2 * a);\n\n    if (0 <= t1 && t1 <= 1)\n      rst.push(Vec.add(Vec.rot(Vec.add(Vec.mul(v, t1), A), rad), C));\n\n    if (0 <= t2 && t2 <= 1 && Math.abs(t1 - t2) > 1e-16)\n      rst.push(Vec.add(Vec.rot(Vec.add(Vec.mul(v, t2), A), rad), C));\n  }\n\n  if (rst.length === 0) return null;\n\n  return rst.map(v => {\n    const pl = new PointLocation(v);\n    const normalVector = Vec.uni(Vec.divV(Vec.sub(v, C), [rx * rx, ry * ry]));\n    pl.tangent = [-normalVector[1], normalVector[0]];\n    return pl;\n  });\n}\n\nexport function sign(number: number) {\n  return number > 0 ? 1 : -1;\n}\n\nexport function getPointFromBoundsWithRotation(\n  bounds: IBound,\n  point: IVec\n): IVec {\n  const { x, y, w, h, rotate } = bounds;\n\n  if (!rotate) return point;\n\n  const cx = x + w / 2;\n  const cy = y + h / 2;\n\n  const m = new DOMMatrix()\n    .translateSelf(cx, cy)\n    .rotateSelf(rotate)\n    .translateSelf(-cx, -cy);\n\n  const p = new DOMPoint(...point).matrixTransform(m);\n  return [p.x, p.y];\n}\n\nexport function normalizeDegAngle(angle: number) {\n  if (angle < 0) angle += 360;\n  angle %= 360;\n  return angle;\n}\n\nexport function toDegree(radian: number) {\n  return (radian * 180) / Math.PI;\n}\n\n// 0 means x axis, 1 means y axis\nexport function isOverlap(\n  line1: IVec[],\n  line2: IVec[],\n  axis: 0 | 1,\n  strict = true\n) {\n  const less = strict\n    ? (a: number, b: number) => a < b\n    : (a: number, b: number) => a <= b;\n  return !(\n    less(\n      Math.max(line1[0][axis], line1[1][axis]),\n      Math.min(line2[0][axis], line2[1][axis])\n    ) ||\n    less(\n      Math.max(line2[0][axis], line2[1][axis]),\n      Math.min(line1[0][axis], line1[1][axis])\n    )\n  );\n}\n\nexport function getCenterAreaBounds(bounds: IBound, ratio: number) {\n  const { x, y, w, h, rotate } = bounds;\n  const cx = x + w / 2;\n  const cy = y + h / 2;\n  const nw = w * ratio;\n  const nh = h * ratio;\n  return {\n    x: cx - nw / 2,\n    y: cy - nh / 2,\n    w: nw,\n    h: nh,\n    rotate,\n  };\n}\n","/**\n * XYWH represents the x, y, width, and height of an element or block.\n */\nexport type XYWH = [number, number, number, number];\n\n/**\n * SerializedXYWH is a string that represents the x, y, width, and height of a block.\n */\nexport type SerializedXYWH = `[${number},${number},${number},${number}]`;\n\nexport function serializeXYWH(\n  x: number,\n  y: number,\n  w: number,\n  h: number\n): SerializedXYWH {\n  return `[${x},${y},${w},${h}]`;\n}\n\nexport function deserializeXYWH(xywh: string): XYWH {\n  try {\n    return JSON.parse(xywh) as XYWH;\n  } catch (e) {\n    console.error('Failed to deserialize xywh', xywh);\n    console.error(e);\n\n    return [0, 0, 0, 0];\n  }\n}\n","import { EPSILON, lineIntersects, polygonPointDistance } from '../math.js';\nimport type { SerializedXYWH, XYWH } from '../xywh.js';\nimport { deserializeXYWH, serializeXYWH } from '../xywh.js';\nimport { type IVec, Vec } from './vec.js';\n\nexport function getIBoundFromPoints(\n  points: IVec[],\n  rotation = 0\n): IBound & {\n  maxX: number;\n  maxY: number;\n  minX: number;\n  minY: number;\n} {\n  let minX = Infinity;\n  let minY = Infinity;\n  let maxX = -Infinity;\n  let maxY = -Infinity;\n\n  if (points.length < 1) {\n    minX = 0;\n    minY = 0;\n    maxX = 1;\n    maxY = 1;\n  } else {\n    for (const [x, y] of points) {\n      minX = Math.min(x, minX);\n      minY = Math.min(y, minY);\n      maxX = Math.max(x, maxX);\n      maxY = Math.max(y, maxY);\n    }\n  }\n\n  if (rotation !== 0) {\n    return getIBoundFromPoints(\n      points.map(pt =>\n        Vec.rotWith(pt, [(minX + maxX) / 2, (minY + maxY) / 2], rotation)\n      )\n    );\n  }\n\n  return {\n    minX,\n    minY,\n    maxX,\n    maxY,\n    x: minX,\n    y: minY,\n    w: maxX - minX,\n    h: maxY - minY,\n  };\n}\n\n/**\n * Represents the x, y, width, and height of a block that can be easily accessed.\n */\nexport interface IBound {\n  x: number;\n  y: number;\n  w: number;\n  h: number;\n  rotate?: number;\n}\n\nexport class Bound implements IBound {\n  h: number;\n\n  w: number;\n\n  x: number;\n\n  y: number;\n\n  get bl(): IVec {\n    return [this.x, this.y + this.h];\n  }\n\n  get br(): IVec {\n    return [this.x + this.w, this.y + this.h];\n  }\n\n  get center(): IVec {\n    return [this.x + this.w / 2, this.y + this.h / 2];\n  }\n\n  set center([cx, cy]: IVec) {\n    const [px, py] = this.center;\n    this.x += cx - px;\n    this.y += cy - py;\n  }\n\n  get horizontalLine(): IVec[] {\n    return [\n      [this.x, this.y + this.h / 2],\n      [this.x + this.w, this.y + this.h / 2],\n    ];\n  }\n\n  get leftLine(): IVec[] {\n    return [\n      [this.x, this.y],\n      [this.x, this.y + this.h],\n    ];\n  }\n\n  get lowerLine(): IVec[] {\n    return [\n      [this.x, this.y + this.h],\n      [this.x + this.w, this.y + this.h],\n    ];\n  }\n\n  get maxX() {\n    return this.x + this.w;\n  }\n\n  get maxY() {\n    return this.y + this.h;\n  }\n\n  get midPoints(): IVec[] {\n    return [\n      [this.x + this.w / 2, this.y],\n      [this.x + this.w, this.y + this.h / 2],\n      [this.x + this.w / 2, this.y + this.h],\n      [this.x, this.y + this.h / 2],\n    ];\n  }\n\n  get minX() {\n    return this.x;\n  }\n\n  get minY() {\n    return this.y;\n  }\n\n  get points(): IVec[] {\n    return [\n      [this.x, this.y],\n      [this.x + this.w, this.y],\n      [this.x + this.w, this.y + this.h],\n      [this.x, this.y + this.h],\n    ];\n  }\n\n  get rightLine(): IVec[] {\n    return [\n      [this.x + this.w, this.y],\n      [this.x + this.w, this.y + this.h],\n    ];\n  }\n\n  get tl(): IVec {\n    return [this.x, this.y];\n  }\n\n  get tr(): IVec {\n    return [this.x + this.w, this.y];\n  }\n\n  get upperLine(): IVec[] {\n    return [\n      [this.x, this.y],\n      [this.x + this.w, this.y],\n    ];\n  }\n\n  get verticalLine(): IVec[] {\n    return [\n      [this.x + this.w / 2, this.y],\n      [this.x + this.w / 2, this.y + this.h],\n    ];\n  }\n\n  constructor(x = 0, y = 0, w = 0, h = 0) {\n    this.x = x;\n    this.y = y;\n    this.w = w;\n    this.h = h;\n  }\n\n  static deserialize(s: string) {\n    const [x, y, w, h] = deserializeXYWH(s);\n    return new Bound(x, y, w, h);\n  }\n\n  static from(arg1: IBound) {\n    return new Bound(arg1.x, arg1.y, arg1.w, arg1.h);\n  }\n\n  static fromCenter(center: IVec, width: number, height: number) {\n    const [x, y] = center;\n    return new Bound(x - width / 2, y - height / 2, width, height);\n  }\n\n  static fromDOMRect({ left, top, width, height }: DOMRect) {\n    return new Bound(left, top, width, height);\n  }\n\n  static fromPoints(points: IVec[]) {\n    return Bound.from(getIBoundFromPoints(points));\n  }\n\n  static fromXYWH(xywh: XYWH) {\n    return new Bound(xywh[0], xywh[1], xywh[2], xywh[3]);\n  }\n\n  static serialize(bound: IBound) {\n    return serializeXYWH(bound.x, bound.y, bound.w, bound.h);\n  }\n\n  clone(): Bound {\n    return new Bound(this.x, this.y, this.w, this.h);\n  }\n\n  contains(bound: Bound) {\n    return (\n      bound.x >= this.x &&\n      bound.y >= this.y &&\n      bound.maxX <= this.maxX &&\n      bound.maxY <= this.maxY\n    );\n  }\n\n  containsPoint([x, y]: IVec): boolean {\n    const { minX, minY, maxX, maxY } = this;\n    return minX <= x && x <= maxX && minY <= y && y <= maxY;\n  }\n\n  expand(margin: [number, number]): Bound;\n  expand(left: number, top?: number, right?: number, bottom?: number): Bound;\n  expand(\n    left: number | [number, number],\n    top?: number,\n    right?: number,\n    bottom?: number\n  ) {\n    if (Array.isArray(left)) {\n      const [x, y] = left;\n      return new Bound(this.x - x, this.y - y, this.w + x * 2, this.h + y * 2);\n    }\n\n    top ??= left;\n    right ??= left;\n    bottom ??= top;\n\n    return new Bound(\n      this.x - left,\n      this.y - top,\n      this.w + left + right,\n      this.h + top + bottom\n    );\n  }\n\n  getRelativePoint([x, y]: IVec): IVec {\n    return [this.x + x * this.w, this.y + y * this.h];\n  }\n\n  getVerticesAndMidpoints() {\n    return [...this.points, ...this.midPoints];\n  }\n\n  horizontalDistance(bound: Bound) {\n    return Math.min(\n      Math.abs(this.minX - bound.maxX),\n      Math.abs(this.maxX - bound.minX)\n    );\n  }\n\n  include(point: IVec) {\n    const x1 = Math.min(this.x, point[0]),\n      y1 = Math.min(this.y, point[1]),\n      x2 = Math.max(this.maxX, point[0]),\n      y2 = Math.max(this.maxY, point[1]);\n    return new Bound(x1, y1, x2 - x1, y2 - y1);\n  }\n\n  intersectLine(sp: IVec, ep: IVec, infinite = false) {\n    const rst: IVec[] = [];\n    (\n      [\n        [this.tl, this.tr],\n        [this.tl, this.bl],\n        [this.tr, this.br],\n        [this.bl, this.br],\n      ] as IVec[][]\n    ).forEach(([p1, p2]) => {\n      const p = lineIntersects(sp, ep, p1, p2, infinite);\n      if (p) rst.push(p);\n    });\n    return rst.length === 0 ? null : rst;\n  }\n\n  isHorizontalCross(bound: Bound) {\n    return !(this.maxY < bound.minY || this.minY > bound.maxY);\n  }\n\n  isIntersectWithBound(bound: Bound, epsilon = EPSILON) {\n    return (\n      bound.maxX > this.minX - epsilon &&\n      bound.maxY > this.minY - epsilon &&\n      bound.minX < this.maxX + epsilon &&\n      bound.minY < this.maxY + epsilon &&\n      !this.contains(bound) &&\n      !bound.contains(this)\n    );\n  }\n\n  isOverlapWithBound(bound: Bound, epsilon = EPSILON) {\n    return (\n      bound.maxX > this.minX - epsilon &&\n      bound.maxY > this.minY - epsilon &&\n      bound.minX < this.maxX + epsilon &&\n      bound.minY < this.maxY + epsilon\n    );\n  }\n\n  isPointInBound([x, y]: IVec, tolerance = 0.01) {\n    return (\n      x > this.minX + tolerance &&\n      x < this.maxX - tolerance &&\n      y > this.minY + tolerance &&\n      y < this.maxY - tolerance\n    );\n  }\n\n  isPointNearBound([x, y]: IVec, tolerance = 0.01) {\n    return polygonPointDistance(this.points, [x, y]) < tolerance;\n  }\n\n  isVerticalCross(bound: Bound) {\n    return !(this.maxX < bound.minX || this.minX > bound.maxX);\n  }\n\n  moveDelta(dx: number, dy: number) {\n    return new Bound(this.x + dx, this.y + dy, this.w, this.h);\n  }\n\n  serialize(): SerializedXYWH {\n    return serializeXYWH(this.x, this.y, this.w, this.h);\n  }\n\n  /**\n   * Convert a point to relative coordinates.\n   * @param point - The point to convert.\n   * @returns The normalized relative coordinates of the point.\n   */\n  toRelative([x, y]: IVec): IVec {\n    const normalizedX = this.w === 0 ? 0 : (x - this.x) / this.w;\n    const normalizedY = this.h === 0 ? 0 : (y - this.y) / this.h;\n    return [normalizedX, normalizedY];\n  }\n\n  toXYWH(): XYWH {\n    return [this.x, this.y, this.w, this.h];\n  }\n\n  unite(bound: Bound) {\n    const x1 = Math.min(this.x, bound.x),\n      y1 = Math.min(this.y, bound.y),\n      x2 = Math.max(this.maxX, bound.maxX),\n      y2 = Math.max(this.maxY, bound.maxY);\n    return new Bound(x1, y1, x2 - x1, y2 - y1);\n  }\n\n  verticalDistance(bound: Bound) {\n    return Math.min(\n      Math.abs(this.minY - bound.maxY),\n      Math.abs(this.maxY - bound.minY)\n    );\n  }\n}\n","import { Bound, getIBoundFromPoints, type IBound } from './model/bound.js';\nimport { type IVec } from './model/vec.js';\n\nfunction getExpandedBound(a: IBound, b: IBound): IBound {\n  const minX = Math.min(a.x, b.x);\n  const minY = Math.min(a.y, b.y);\n  const maxX = Math.max(a.x + a.w, b.x + b.w);\n  const maxY = Math.max(a.y + a.h, b.y + b.h);\n  const width = Math.abs(maxX - minX);\n  const height = Math.abs(maxY - minY);\n\n  return {\n    x: minX,\n    y: minY,\n    w: width,\n    h: height,\n  };\n}\n\nexport function getPointsFromBoundWithRotation(\n  bounds: IBound,\n  getPoints: (bounds: IBound) => IVec[] = ({ x, y, w, h }: IBound) => [\n    // left-top\n    [x, y],\n    // right-top\n    [x + w, y],\n    // right-bottom\n    [x + w, y + h],\n    // left-bottom\n    [x, y + h],\n  ],\n  resPadding: [number, number] = [0, 0]\n): IVec[] {\n  const { rotate } = bounds;\n  let points = getPoints({\n    x: bounds.x - resPadding[1],\n    y: bounds.y - resPadding[0],\n    w: bounds.w + resPadding[1] * 2,\n    h: bounds.h + resPadding[0] * 2,\n  });\n\n  if (rotate) {\n    const { x, y, w, h } = bounds;\n    const cx = x + w / 2;\n    const cy = y + h / 2;\n\n    const m = new DOMMatrix()\n      .translateSelf(cx, cy)\n      .rotateSelf(rotate)\n      .translateSelf(-cx, -cy);\n\n    points = points.map(point => {\n      const { x, y } = new DOMPoint(...point).matrixTransform(m);\n      return [x, y];\n    });\n  }\n\n  return points;\n}\n\nexport function getQuadBoundWithRotation(bounds: IBound): DOMRect {\n  const { x, y, w, h, rotate } = bounds;\n  const rect = new DOMRect(x, y, w, h);\n\n  if (!rotate) return rect;\n\n  return new DOMQuad(\n    ...getPointsFromBoundWithRotation(bounds).map(\n      point => new DOMPoint(...point)\n    )\n  ).getBounds();\n}\n\nexport function getBoundWithRotation(bound: IBound): IBound {\n  const { x, y, width: w, height: h } = getQuadBoundWithRotation(bound);\n  return { x, y, w, h };\n}\n\n/**\n * Returns the common bound of the given bounds.\n * The rotation of the bounds is not considered.\n * @param bounds\n * @returns\n */\nexport function getCommonBound(bounds: IBound[]): Bound | null {\n  if (!bounds.length) {\n    return null;\n  }\n\n  if (bounds.length === 1) {\n    const { x, y, w, h } = bounds[0];\n    return new Bound(x, y, w, h);\n  }\n\n  let result = bounds[0];\n\n  for (let i = 1; i < bounds.length; i++) {\n    result = getExpandedBound(result, bounds[i]);\n  }\n\n  return new Bound(result.x, result.y, result.w, result.h);\n}\n\n/**\n * Like `getCommonBound`, but considers the rotation of the bounds.\n * @returns\n */\nexport function getCommonBoundWithRotation(bounds: IBound[]): Bound {\n  if (bounds.length === 0) {\n    return new Bound(0, 0, 0, 0);\n  }\n\n  return bounds.reduce(\n    (pre, bound) => {\n      return pre.unite(\n        bound instanceof Bound ? bound : Bound.from(getBoundWithRotation(bound))\n      );\n    },\n    Bound.from(getBoundWithRotation(bounds[0]))\n  );\n}\n\nexport function getBoundFromPoints(points: IVec[]) {\n  return Bound.from(getIBoundFromPoints(points));\n}\n\nexport function inflateBound(bound: IBound, delta: number) {\n  const half = delta / 2;\n\n  const newBound = new Bound(\n    bound.x - half,\n    bound.y - half,\n    bound.w + delta,\n    bound.h + delta\n  );\n\n  if (newBound.w <= 0 || newBound.h <= 0) {\n    throw new Error('Invalid delta range or bound size.');\n  }\n\n  return newBound;\n}\n\nexport function transformPointsToNewBound<T extends { x: number; y: number }>(\n  points: T[],\n  oldBound: IBound,\n  oldMargin: number,\n  newBound: IBound,\n  newMargin: number\n) {\n  const wholeOldMargin = oldMargin * 2;\n  const wholeNewMargin = newMargin * 2;\n  const oldW = Math.max(oldBound.w - wholeOldMargin, 1);\n  const oldH = Math.max(oldBound.h - wholeOldMargin, 1);\n  const newW = Math.max(newBound.w - wholeNewMargin, 1);\n  const newH = Math.max(newBound.h - wholeNewMargin, 1);\n\n  const transformedPoints = points.map(p => {\n    return {\n      ...p,\n      x: newW * ((p.x - oldMargin) / oldW) + newMargin,\n      y: newH * ((p.y - oldMargin) / oldH) + newMargin,\n    } as T;\n  });\n\n  return {\n    points: transformedPoints,\n    bound: new Bound(\n      newBound.x,\n      newBound.y,\n      newW + wholeNewMargin,\n      newH + wholeNewMargin\n    ),\n  };\n}\n","export async function sleep(ms: number, signal?: AbortSignal): Promise<void> {\n  return new Promise(resolve => {\n    if (signal?.aborted) {\n      resolve();\n      return;\n    }\n    let resolved = false;\n    signal?.addEventListener('abort', () => {\n      if (!resolved) {\n        clearTimeout(timeId);\n        resolve();\n      }\n    });\n\n    const timeId = setTimeout(() => {\n      resolved = true;\n      resolve();\n    }, ms);\n  });\n}\n\nexport function noop(_?: unknown) {\n  return;\n}\n\nexport async function nextTick() {\n  // @ts-expect-error check window.scheduler\n  if ('scheduler' in window && 'yield' in window.scheduler) {\n    // @ts-expect-error check window.scheduler.yield\n    return window.scheduler.yield();\n  } else if (typeof requestIdleCallback !== 'undefined') {\n    return new Promise(resolve => requestIdleCallback(resolve));\n  } else {\n    return new Promise(resolve => setTimeout(resolve, 0));\n  }\n}\n","import * as Y from 'yjs';\n\nimport type { ProxyOptions } from './types';\n\nexport abstract class BaseReactiveYData<\n  T,\n  YSource extends Y.AbstractType<any>,\n> {\n  protected _getOrigin = (\n    doc: Y.Doc\n  ): {\n    doc: Y.Doc;\n    proxy: true;\n\n    target: BaseReactiveYData<any, any>;\n  } => {\n    return {\n      doc,\n      proxy: true,\n      target: this,\n    };\n  };\n\n  protected _onObserve = (event: Y.YEvent<any>, handler: () => void) => {\n    if (\n      event.transaction.origin?.force === true ||\n      (event.transaction.origin?.proxy !== true &&\n        (!event.transaction.local ||\n          event.transaction.origin instanceof Y.UndoManager))\n    ) {\n      handler();\n    }\n\n    const isLocal =\n      !event.transaction.origin ||\n      !this._ySource.doc ||\n      event.transaction.origin instanceof Y.UndoManager ||\n      event.transaction.origin.proxy\n        ? true\n        : event.transaction.origin === this._ySource.doc.clientID;\n\n    this._options?.onChange?.(this._proxy, isLocal);\n  };\n\n  protected abstract readonly _options?: ProxyOptions<T>;\n\n  protected abstract readonly _proxy: T;\n\n  protected _skipNext = false;\n\n  protected abstract readonly _source: T;\n\n  protected readonly _stashed = new Set<string | number>();\n\n  protected _transact = (doc: Y.Doc, fn: () => void) => {\n    doc.transact(fn, this._getOrigin(doc));\n  };\n\n  protected _updateWithSkip = (fn: () => void) => {\n    if (this._skipNext) {\n      return;\n    }\n    this._skipNext = true;\n    fn();\n    this._skipNext = false;\n  };\n\n  protected abstract readonly _ySource: YSource;\n\n  get proxy() {\n    return this._proxy;\n  }\n\n  abstract pop(prop: string | number): void;\n  abstract stash(prop: string | number): void;\n}\n","export const SCHEMA_NOT_FOUND_MESSAGE =\n  'Schema not found. The block flavour may not be registered.';\n\nexport const TEXT_UNIQ_IDENTIFIER = '$blocksuite:internal:text$';\nexport const NATIVE_UNIQ_IDENTIFIER = '$blocksuite:internal:native$';\n\nexport const SYS_KEYS = new Set(['id', 'flavour', 'children', 'version']);\n","import * as Y from 'yjs';\n\nimport { NATIVE_UNIQ_IDENTIFIER } from '../consts.js';\n\nexport type OnBoxedChange = (data: unknown, isLocal: boolean) => void;\n\n/**\n * Boxed is to store raw data in Yjs.\n * By default, store will try to convert a object to a Y.Map.\n * If you want to store a raw object for you want to manipulate the Y.Map directly, you can use Boxed.\n *\n * > [!NOTE]\n * > Please notice that the data will be stored in Y.Map anyway so it can not hold data structure like function.\n *\n * @example\n * ```ts\n * const boxedObject = new Boxed({ a: 1, b: 2 });\n * const boxedYMap = new Boxed(new Y.Map());\n * boxedObject.getValue().a; // 1\n * boxedYMap.getValue().set('a', 1);\n * boxedObject.setValue({ foo: 'bar' });\n * ```\n *\n * @typeParam T - The type of the value stored in the Boxed.\n *\n * @category Reactive\n */\nexport class Boxed<Value = unknown> {\n  /**\n   * Create a Boxed from a Y.Map.\n   * It is useful when you sync a Y.Map from remote.\n   *\n   * @typeParam Value - The type of the value.\n   *\n   * @example\n   * ```ts\n   * const doc1 = new Y.Doc();\n   * const doc2 = new Y.Doc();\n   * keepSynced(doc1, doc2);\n   *\n   * const data1 = doc1.getMap('data');\n   * const boxed1 = new Boxed({ a: 1, b: 2 });\n   * data1.set('boxed', boxed1.yMap);\n   *\n   * const data2 = doc2.getMap('data');\n   * const boxed2 = Boxed.from<{ a: number; b: number }>(data2.get('boxed'));\n   * ```\n   */\n  static from = <Value>(\n    map: Y.Map<unknown>,\n    /** @internal */\n    onChange?: OnBoxedChange\n  ): Boxed<Value> => {\n    const boxed = new Boxed<Value>(map.get('value') as Value);\n    if (onChange) {\n      boxed.bind(onChange);\n    }\n    return boxed;\n  };\n\n  /**\n   * Check if a value is a Boxed.\n   *\n   * @example\n   * ```ts\n   * const doc = new Y.Doc();\n   *\n   * const data = doc.getMap('data');\n   * const boxed = new Boxed({ a: 1, b: 2 });\n   * Boxed.is(boxed); // true\n   *\n   * data.set('boxed', boxed.yMap);\n   * Boxed.is(data.get('boxed)); // true\n   * ```\n   */\n  static is = (value: unknown): value is Boxed => {\n    return (\n      value instanceof Y.Map && value.get('type') === NATIVE_UNIQ_IDENTIFIER\n    );\n  };\n\n  private readonly _map: Y.Map<Value>;\n\n  private _onChange?: OnBoxedChange;\n\n  /**\n   * Get the current value of the Boxed.\n   */\n  getValue = () => {\n    return this._map.get('value');\n  };\n\n  /**\n   * Replace the current value of the Boxed.\n   *\n   * @param value - The new value to set.\n   */\n  setValue = (value: Value) => {\n    return this._map.set('value', value);\n  };\n\n  /** @internal */\n  get yMap() {\n    return this._map;\n  }\n\n  constructor(value: Value) {\n    if (\n      value instanceof Y.Map &&\n      value.doc &&\n      value.get('type') === NATIVE_UNIQ_IDENTIFIER\n    ) {\n      this._map = value;\n    } else {\n      this._map = new Y.Map();\n      this._map.set('type', NATIVE_UNIQ_IDENTIFIER as Value);\n      this._map.set('value', value);\n    }\n    this._map.observeDeep(events => {\n      events.forEach(event => {\n        const isLocal =\n          !event.transaction.origin ||\n          !this._map.doc ||\n          event.transaction.origin instanceof Y.UndoManager ||\n          event.transaction.origin.proxy\n            ? true\n            : event.transaction.origin === this._map.doc.clientID;\n        this._onChange?.(this.getValue(), isLocal);\n      });\n    });\n  }\n\n  /** @internal */\n  bind(onChange: OnBoxedChange) {\n    this._onChange = onChange;\n  }\n}\n","import type { BaseReactiveYData } from './base-reactive-data';\n\nexport const proxies = new WeakMap<any, BaseReactiveYData<any, any>>();\nexport const flatProxies = new WeakMap<any, BaseReactiveYData<any, any>>();\n","export function isPureObject(value: unknown): value is object {\n  return (\n    value !== null &&\n    typeof value === 'object' &&\n    Object.prototype.toString.call(value) === '[object Object]' &&\n    [Object, undefined, null].some(x => x === value.constructor)\n  );\n}\n","import { z } from 'zod';\n\nexport const baseTextAttributes = z.object({\n  bold: z.literal(true).optional().nullable().catch(undefined),\n  italic: z.literal(true).optional().nullable().catch(undefined),\n  underline: z.literal(true).optional().nullable().catch(undefined),\n  strike: z.literal(true).optional().nullable().catch(undefined),\n  code: z.literal(true).optional().nullable().catch(undefined),\n  link: z.string().optional().nullable().catch(undefined),\n});\n\nexport type BaseTextAttributes = z.infer<typeof baseTextAttributes>;\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { type Signal, signal } from '@preact/signals-core';\nimport * as Y from 'yjs';\n\nimport type { BaseTextAttributes } from './attributes';\nimport type { DeltaInsert, DeltaOperation, OnTextChange } from './types';\n\n/**\n * Text is an abstraction of Y.Text.\n * It provides useful methods to manipulate the text content.\n *\n * @example\n * ```ts\n * const text = new Text('Hello, world!');\n * text.insert(' blocksuite', 7);\n * text.delete(7, 1);\n * text.format(7, 1, { bold: true });\n * text.join(new Text(' blocksuite'));\n * text.split(7, 1);\n * ```\n *\n * Text {@link https://docs.yjs.dev/api/delta-format delta} is a format from Y.js.\n *\n * @category Reactive\n */\nexport class Text<\n  TextAttributes extends BaseTextAttributes = BaseTextAttributes,\n> {\n  private readonly _deltas$: Signal<DeltaOperation[]>;\n\n  private readonly _length$: Signal<number>;\n\n  private _onChange?: OnTextChange;\n\n  private readonly _yText: Y.Text;\n\n  /**\n   * Get the text delta as a signal.\n   */\n  get deltas$() {\n    return this._deltas$;\n  }\n\n  get length() {\n    return this._length$.value;\n  }\n\n  get yText() {\n    return this._yText;\n  }\n\n  /**\n   * @param input - The input can be a string, a Y.Text instance, or an array of DeltaInsert.\n   */\n  constructor(input?: Y.Text | string | DeltaInsert<TextAttributes>[]) {\n    let length = 0;\n    if (typeof input === 'string') {\n      const text = input.replaceAll('\\r\\n', '\\n');\n      length = text.length;\n      this._yText = new Y.Text(text);\n    } else if (input instanceof Y.Text) {\n      this._yText = input;\n      if (input.doc) {\n        length = input.length;\n      }\n    } else if (input instanceof Array) {\n      for (const delta of input) {\n        if (delta.insert) {\n          delta.insert = delta.insert.replaceAll('\\r\\n', '\\n');\n          length += delta.insert.length;\n        }\n      }\n      const yText = new Y.Text();\n      yText.applyDelta(input);\n      this._yText = yText;\n    } else {\n      this._yText = new Y.Text();\n    }\n\n    this._length$ = signal(length);\n    this._deltas$ = signal(this._yText.doc ? this._yText.toDelta() : []);\n    this._yText.observe(event => {\n      const isLocal =\n        !event.transaction.origin ||\n        !this._yText.doc ||\n        event.transaction.origin instanceof Y.UndoManager ||\n        event.transaction.origin.proxy\n          ? true\n          : event.transaction.origin === this._yText.doc.clientID;\n      this._length$.value = this._yText.length;\n      this._deltas$.value = this._yText.toDelta();\n      this._onChange?.(this._yText, isLocal);\n    });\n  }\n\n  private _transact(callback: () => void) {\n    const doc = this._yText.doc;\n    if (!doc) {\n      throw new BlockSuiteError(\n        ErrorCode.ReactiveProxyError,\n        'Failed to transact text! yText is not attached to a doc'\n      );\n    }\n    doc.transact(() => {\n      callback();\n    }, doc.clientID);\n  }\n\n  /**\n   * Apply a delta to the text.\n   *\n   * @param delta - The delta to apply.\n   *\n   * @example\n   * ```ts\n   * const text = new Text('Hello, world!');\n   * text.applyDelta([{insert: ' blocksuite', attributes: { bold: true }}]);\n   * ```\n   */\n  applyDelta(delta: DeltaOperation[]) {\n    this._transact(() => {\n      this._yText?.applyDelta(delta);\n    });\n  }\n\n  /**\n   * @internal\n   */\n  bind(onChange?: OnTextChange) {\n    this._onChange = onChange;\n  }\n\n  /**\n   * Clear the text content.\n   */\n  clear() {\n    if (!this._yText.length) {\n      return;\n    }\n    this._transact(() => {\n      this._yText.delete(0, this._yText.length);\n    });\n  }\n\n  /**\n   * Clone the text to a new Text instance.\n   *\n   * @returns A new Text instance.\n   */\n  clone() {\n    const text = new Text(this._yText.clone());\n    text.bind(this._onChange);\n    return text;\n  }\n\n  /**\n   * Delete the text content.\n   *\n   * @param index - The index to delete.\n   * @param length - The length to delete.\n   */\n  delete(index: number, length: number) {\n    if (length === 0) {\n      return;\n    }\n    if (index < 0 || length < 0 || index + length > this._yText.length) {\n      throw new BlockSuiteError(\n        ErrorCode.ReactiveProxyError,\n        'Failed to delete text! Index or length out of range, index: ' +\n          index +\n          ', length: ' +\n          length +\n          ', text length: ' +\n          this._yText.length\n      );\n    }\n    this._transact(() => {\n      this._yText.delete(index, length);\n    });\n  }\n\n  /**\n   * Format the text content.\n   *\n   * @param index - The index to format.\n   * @param length - The length to format.\n   * @param format - The format to apply.\n   *\n   * @example\n   * ```ts\n   * const text = new Text('Hello, world!');\n   * text.format(7, 1, { bold: true });\n   * ```\n   */\n  format(index: number, length: number, format: Record<string, unknown>) {\n    if (length === 0) {\n      return;\n    }\n    if (index < 0 || length < 0 || index + length > this._yText.length) {\n      throw new BlockSuiteError(\n        ErrorCode.ReactiveProxyError,\n        'Failed to format text! Index or length out of range, index: ' +\n          index +\n          ', length: ' +\n          length +\n          ', text length: ' +\n          this._yText.length\n      );\n    }\n    this._transact(() => {\n      this._yText.format(index, length, format);\n    });\n  }\n\n  /**\n   * Insert content at the specified index.\n   *\n   * @param content - The content to insert.\n   * @param index - The index to insert.\n   *\n   * @example\n   * ```ts\n   * const text = new Text('Hello, world!');\n   * text.insert(' blocksuite', 7);\n   * ```\n   */\n  insert(content: string, index: number, attributes?: Record<string, unknown>) {\n    if (!content.length) {\n      return;\n    }\n    if (index < 0 || index > this._yText.length) {\n      throw new BlockSuiteError(\n        ErrorCode.ReactiveProxyError,\n        'Failed to insert text! Index or length out of range, index: ' +\n          index +\n          ', length: ' +\n          content.length +\n          ', text length: ' +\n          this._yText.length\n      );\n    }\n    this._transact(() => {\n      this._yText.insert(index, content, attributes);\n    });\n  }\n\n  /**\n   * Join current text with another text.\n   *\n   * @param other - The other text to join.\n   *\n   * @example\n   * ```ts\n   * const text = new Text('Hello, world!');\n   * const other = new Text(' blocksuite');\n   * text.join(other);\n   * ```\n   */\n  join(other: Text) {\n    if (!other || !other.toDelta().length) {\n      return;\n    }\n    this._transact(() => {\n      const yOther = other._yText;\n      const delta: DeltaOperation[] = yOther.toDelta();\n      delta.unshift({ retain: this._yText.length });\n      this._yText.applyDelta(delta);\n    });\n  }\n\n  /**\n   * Replace the text content with a new content.\n   *\n   * @param index - The index to replace.\n   * @param length - The length to replace.\n   * @param content - The content to replace.\n   * @param attributes - The attributes to replace.\n   *\n   * @example\n   * ```ts\n   * const text = new Text('Hello, world!');\n   * text.replace(7, 1, ' blocksuite');\n   * ```\n   */\n  replace(\n    index: number,\n    length: number,\n    content: string,\n    attributes?: Record<string, unknown>\n  ) {\n    if (index < 0 || length < 0 || index + length > this._yText.length) {\n      throw new BlockSuiteError(\n        ErrorCode.ReactiveProxyError,\n        'Failed to replace text! The length of the text is' +\n          this._yText.length +\n          ', but you are trying to replace from' +\n          index +\n          'to' +\n          index +\n          length\n      );\n    }\n    this._transact(() => {\n      this._yText.delete(index, length);\n      this._yText.insert(index, content, attributes);\n    });\n  }\n\n  /**\n   * Slice the text to a delta.\n   *\n   * @param begin - The begin index.\n   * @param end - The end index.\n   *\n   * @returns The delta of the sliced text.\n   */\n  sliceToDelta(begin: number, end?: number): DeltaOperation[] {\n    const result: DeltaOperation[] = [];\n    if (end && begin >= end) {\n      return result;\n    }\n\n    if (begin === 0 && end === 0) {\n      return [];\n    }\n\n    const delta = this.toDelta();\n    if (begin < 1 && !end) {\n      return delta;\n    }\n\n    if (delta && delta instanceof Array) {\n      let charNum = 0;\n      // eslint-disable-next-line @typescript-eslint/prefer-for-of\n      for (let i = 0; i < delta.length; i++) {\n        const content = delta[i];\n        let contentText: string = content.insert || '';\n        const contentLen = contentText.length;\n\n        const isLastOp = end && charNum + contentLen > end;\n        const isFirstOp = charNum + contentLen > begin && result.length === 0;\n        if (isFirstOp && isLastOp) {\n          contentText = contentText.slice(begin - charNum, end - charNum);\n          result.push({\n            ...content,\n            insert: contentText,\n          });\n          break;\n        } else if (isFirstOp || isLastOp) {\n          contentText = isLastOp\n            ? contentText.slice(0, end - charNum)\n            : contentText.slice(begin - charNum);\n\n          result.push({\n            ...content,\n            insert: contentText,\n          });\n        } else {\n          result.length > 0 && result.push(content);\n        }\n\n        if (end && charNum + contentLen > end) {\n          break;\n        }\n\n        charNum = charNum + contentLen;\n      }\n    }\n    return result;\n  }\n\n  /**\n   * Split the text into another Text.\n   *\n   * @param index - The index to split.\n   * @param length - The length to split.\n   *\n   * @returns The right part of the text.\n   *\n   * @example\n   * ```ts\n   * const text = new Text('Hello, world!');\n   * text.split(7, 1);\n   * ```\n   *\n   * NOTE: The string included in [index, index + length) will be deleted.\n   *\n   * Here are three cases for point position(index + length):\n   *\n   * ```\n   * [{insert: 'abc', ...}, {insert: 'def', ...}, {insert: 'ghi', ...}]\n   * 1. abc|de|fghi\n   *    left: [{insert: 'abc', ...}]\n   *    right: [{insert: 'f', ...}, {insert: 'ghi', ...}]\n   * 2. abc|def|ghi\n   *    left: [{insert: 'abc', ...}]\n   *    right: [{insert: 'ghi', ...}]\n   * 3. abc|defg|hi\n   *    left: [{insert: 'abc', ...}]\n   *    right: [{insert: 'hi', ...}]\n   * ```\n   */\n  split(index: number, length = 0): Text {\n    if (index < 0 || length < 0 || index + length > this._yText.length) {\n      throw new BlockSuiteError(\n        ErrorCode.ReactiveProxyError,\n        'Failed to split text! Index or length out of range, index: ' +\n          index +\n          ', length: ' +\n          length +\n          ', text length: ' +\n          this._yText.length\n      );\n    }\n    const deltas = this._yText.toDelta();\n    if (!(deltas instanceof Array)) {\n      throw new BlockSuiteError(\n        ErrorCode.ReactiveProxyError,\n        'This text cannot be split because we failed to get the deltas of it.'\n      );\n    }\n    let tmpIndex = 0;\n    const rightDeltas: DeltaInsert<TextAttributes>[] = [];\n    for (let i = 0; i < deltas.length; i++) {\n      const insert = deltas[i].insert;\n      if (typeof insert === 'string') {\n        if (tmpIndex + insert.length >= index + length) {\n          const insertRight = insert.slice(index + length - tmpIndex);\n          rightDeltas.push({\n            insert: insertRight,\n            attributes: deltas[i].attributes,\n          });\n          rightDeltas.push(...deltas.slice(i + 1));\n          break;\n        }\n        tmpIndex += insert.length;\n      } else {\n        throw new BlockSuiteError(\n          ErrorCode.ReactiveProxyError,\n          'This text cannot be split because it contains non-string insert.'\n        );\n      }\n    }\n\n    this.delete(index, this.length - index);\n    const rightYText = new Y.Text();\n    rightYText.applyDelta(rightDeltas);\n    const rightText = new Text(rightYText);\n    rightText.bind(this._onChange);\n\n    return rightText;\n  }\n\n  /**\n   * Get the text delta.\n   *\n   * @returns The delta of the text.\n   */\n  toDelta(): DeltaOperation[] {\n    return this._yText?.toDelta() || [];\n  }\n\n  /**\n   * Get the text content as a string.\n   * In most cases, you should not use this method. It will lose the delta attributes information.\n   *\n   * @returns The text content.\n   */\n  toString() {\n    return this._yText?.toString() || '';\n  }\n}\n","import { Array as YArray, Map as YMap, Text as YText } from 'yjs';\n\nimport { Boxed } from './boxed.js';\nimport { isPureObject } from './is-pure-object.js';\nimport { Text } from './text/index.js';\nimport type { Native2Y, TransformOptions } from './types.js';\n\nexport function native2Y<T>(\n  value: T,\n  { deep = true, transform = x => x }: TransformOptions = {}\n): Native2Y<T> {\n  if (value instanceof Boxed) {\n    return transform(value.yMap, value) as Native2Y<T>;\n  }\n  if (value instanceof Text) {\n    if (value.yText.doc) {\n      return transform(value.yText.clone(), value) as Native2Y<T>;\n    }\n    return transform(value.yText, value) as Native2Y<T>;\n  }\n  if (Array.isArray(value)) {\n    const yArray: YArray<unknown> = new YArray<unknown>();\n    const result = value.map(item => {\n      return deep ? native2Y(item, { deep, transform }) : item;\n    });\n    yArray.insert(0, result);\n\n    return transform(yArray, value) as Native2Y<T>;\n  }\n  if (isPureObject(value)) {\n    const yMap = new YMap<unknown>();\n    Object.entries(value).forEach(([key, value]) => {\n      yMap.set(key, deep ? native2Y(value, { deep, transform }) : value);\n    });\n\n    return transform(yMap, value) as Native2Y<T>;\n  }\n\n  return transform(value, value) as Native2Y<T>;\n}\n\nexport function y2Native(\n  yAbstract: unknown,\n  { deep = true, transform = x => x }: TransformOptions = {}\n) {\n  if (Boxed.is(yAbstract)) {\n    const data = new Boxed(yAbstract);\n    return transform(data, yAbstract);\n  }\n  if (yAbstract instanceof YText) {\n    const data = new Text(yAbstract);\n    return transform(data, yAbstract);\n  }\n  if (yAbstract instanceof YArray) {\n    const data: unknown[] = yAbstract\n      .toArray()\n      .map(item => (deep ? y2Native(item, { deep, transform }) : item));\n\n    return transform(data, yAbstract);\n  }\n  if (yAbstract instanceof YMap) {\n    const data: Record<string, unknown> = Object.fromEntries(\n      Array.from(yAbstract.entries()).map(([key, value]) => {\n        return [key, deep ? y2Native(value, { deep, transform }) : value] as [\n          string,\n          unknown,\n        ];\n      })\n    );\n    return transform(data, yAbstract);\n  }\n\n  return transform(yAbstract, yAbstract);\n}\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport type { YArrayEvent, YMapEvent } from 'yjs';\nimport { Array as YArray, Map as YMap } from 'yjs';\n\nimport { BaseReactiveYData } from './base-reactive-data.js';\nimport { Boxed, type OnBoxedChange } from './boxed.js';\nimport { proxies } from './memory.js';\nimport { native2Y, y2Native } from './native-y.js';\nimport { type OnTextChange, Text } from './text/index.js';\nimport type { ProxyOptions, TransformOptions, UnRecord } from './types.js';\n\nexport class ReactiveYArray extends BaseReactiveYData<\n  unknown[],\n  YArray<unknown>\n> {\n  private readonly _observer = (event: YArrayEvent<unknown>) => {\n    this._onObserve(event, () => {\n      let retain = 0;\n      event.changes.delta.forEach(change => {\n        if (change.retain) {\n          retain += change.retain;\n          return;\n        }\n        if (change.delete) {\n          this._updateWithSkip(() => {\n            this._source.splice(retain, change.delete);\n          });\n          return;\n        }\n        if (change.insert) {\n          const _arr = [change.insert].flat();\n\n          const proxyList = _arr.map(value => createYProxy(value));\n\n          this._updateWithSkip(() => {\n            this._source.splice(retain, 0, ...proxyList);\n          });\n\n          retain += change.insert.length;\n        }\n      });\n    });\n  };\n\n  protected _getProxy = () => {\n    return new Proxy(this._source, {\n      has: (target, p) => {\n        return Reflect.has(target, p);\n      },\n      set: (target, p, value, receiver) => {\n        if (typeof p !== 'string') {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'key cannot be a symbol'\n          );\n        }\n\n        const index = Number(p);\n        if (this._skipNext || Number.isNaN(index)) {\n          return Reflect.set(target, p, value, receiver);\n        }\n\n        if (this._stashed.has(index)) {\n          const result = Reflect.set(target, p, value, receiver);\n          this._options.onChange?.(this._proxy, true);\n          return result;\n        }\n\n        const reactive = proxies.get(this._ySource);\n        if (!reactive) {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'YData is not subscribed before changes'\n          );\n        }\n        const doc = this._ySource.doc;\n        if (!doc) {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'YData is not bound to a Y.Doc'\n          );\n        }\n\n        const yData = native2Y(value);\n        this._transact(doc, () => {\n          if (index < this._ySource.length) {\n            this._ySource.delete(index, 1);\n          }\n          this._ySource.insert(index, [yData]);\n        });\n        const data = createYProxy(yData, this._options);\n        return Reflect.set(target, p, data, receiver);\n      },\n      get: (target, p, receiver) => {\n        if (p === 'splice') {\n          return (start: number, deleteCount?: number, ...items: unknown[]) => {\n            const doc = this._ySource.doc;\n            if (!doc) {\n              throw new BlockSuiteError(\n                ErrorCode.ReactiveProxyError,\n                'YData is not bound to a Y.Doc'\n              );\n            }\n            const count = deleteCount ?? target.length - start;\n            const yItems = items.map(item => native2Y(item));\n            this._transact(doc, () => {\n              this._ySource.delete(start, count);\n              this._ySource.insert(start, yItems);\n            });\n\n            const result = Array.prototype.splice.apply(target, [\n              start,\n              count,\n              ...yItems.map(yItem => createYProxy(yItem, this._options)),\n            ]);\n\n            return result;\n          };\n        }\n        if (p === 'shift') {\n          return () => {\n            const doc = this._ySource.doc;\n            if (!doc) {\n              throw new BlockSuiteError(\n                ErrorCode.ReactiveProxyError,\n                'YData is not bound to a Y.Doc'\n              );\n            }\n            if (target.length === 0) {\n              return undefined;\n            }\n            const result = Array.prototype.shift.call(target);\n            this._transact(doc, () => {\n              this._ySource.delete(0, 1);\n            });\n            return result;\n          };\n        }\n        if (p === 'unshift') {\n          return (...items: unknown[]) => {\n            const doc = this._ySource.doc;\n            if (!doc) {\n              throw new BlockSuiteError(\n                ErrorCode.ReactiveProxyError,\n                'YData is not bound to a Y.Doc'\n              );\n            }\n            const yItems = items.map(item => native2Y(item));\n            this._transact(doc, () => {\n              this._ySource.insert(0, yItems);\n            });\n            return Array.prototype.unshift.apply(\n              target,\n              yItems.map(yItem => createYProxy(yItem, this._options))\n            );\n          };\n        }\n        return Reflect.get(target, p, receiver);\n      },\n      deleteProperty: (target, p): boolean => {\n        if (typeof p !== 'string') {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'key cannot be a symbol'\n          );\n        }\n\n        const proxied = proxies.get(this._ySource);\n        if (!proxied) {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'YData is not subscribed before changes'\n          );\n        }\n        const doc = this._ySource.doc;\n        if (!doc) {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'YData is not bound to a Y.Doc'\n          );\n        }\n\n        const index = Number(p);\n        if (this._skipNext || Number.isNaN(index)) {\n          return Reflect.deleteProperty(target, p);\n        }\n\n        this._transact(doc, () => {\n          this._ySource.delete(index, 1);\n        });\n        return Reflect.deleteProperty(target, p);\n      },\n    });\n  };\n\n  protected readonly _proxy: unknown[];\n\n  constructor(\n    protected readonly _source: unknown[],\n    protected readonly _ySource: YArray<unknown>,\n    protected readonly _options: ProxyOptions<unknown[]>\n  ) {\n    super();\n    this._proxy = this._getProxy();\n    proxies.set(_ySource, this);\n    _ySource.observe(this._observer);\n  }\n\n  pop(prop: number) {\n    const value = this._source[prop];\n    this._stashed.delete(prop);\n    this._proxy[prop] = value;\n  }\n\n  stash(prop: number) {\n    this._stashed.add(prop);\n  }\n}\n\nexport class ReactiveYMap extends BaseReactiveYData<UnRecord, YMap<unknown>> {\n  private readonly _observer = (event: YMapEvent<unknown>) => {\n    this._onObserve(event, () => {\n      event.keysChanged.forEach(key => {\n        const type = event.changes.keys.get(key);\n        if (!type) {\n          return;\n        }\n        if (type.action === 'delete') {\n          this._updateWithSkip(() => {\n            delete this._source[key];\n          });\n        } else if (type.action === 'add' || type.action === 'update') {\n          const current = this._ySource.get(key);\n          this._updateWithSkip(() => {\n            this._source[key] = proxies.has(current)\n              ? proxies.get(current)\n              : createYProxy(current, this._options);\n          });\n        }\n      });\n    });\n  };\n\n  protected _getProxy = () => {\n    return new Proxy(this._source, {\n      has: (target, p) => {\n        return Reflect.has(target, p);\n      },\n      set: (target, p, value, receiver) => {\n        if (typeof p !== 'string') {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'key cannot be a symbol'\n          );\n        }\n        if (this._skipNext) {\n          return Reflect.set(target, p, value, receiver);\n        }\n\n        if (this._stashed.has(p)) {\n          const result = Reflect.set(target, p, value, receiver);\n          this._options.onChange?.(this._proxy, true);\n          return result;\n        }\n\n        const reactive = proxies.get(this._ySource);\n        if (!reactive) {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'YData is not subscribed before changes'\n          );\n        }\n        const doc = this._ySource.doc;\n        if (!doc) {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'YData is not bound to a Y.Doc'\n          );\n        }\n\n        const yData = native2Y(value);\n        this._transact(doc, () => {\n          this._ySource.set(p, yData);\n        });\n        const data = createYProxy(yData, this._options);\n        return Reflect.set(target, p, data, receiver);\n      },\n      get: (target, p, receiver) => {\n        return Reflect.get(target, p, receiver);\n      },\n      deleteProperty: (target, p) => {\n        if (typeof p !== 'string') {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'key cannot be a symbol'\n          );\n        }\n        if (this._skipNext) {\n          return Reflect.deleteProperty(target, p);\n        }\n\n        const proxied = proxies.get(this._ySource);\n        if (!proxied) {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'YData is not subscribed before changes'\n          );\n        }\n        const doc = this._ySource.doc;\n        if (!doc) {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'YData is not bound to a Y.Doc'\n          );\n        }\n\n        this._transact(doc, () => {\n          this._ySource.delete(p);\n        });\n\n        return Reflect.deleteProperty(target, p);\n      },\n    });\n  };\n\n  protected readonly _proxy: UnRecord;\n\n  // eslint-disable-next-line sonarjs/no-identical-functions\n  constructor(\n    protected readonly _source: UnRecord,\n    protected readonly _ySource: YMap<unknown>,\n    protected readonly _options: ProxyOptions<UnRecord>\n  ) {\n    super();\n    this._proxy = this._getProxy();\n    proxies.set(_ySource, this);\n    _ySource.observe(this._observer);\n  }\n\n  // eslint-disable-next-line sonarjs/no-identical-functions\n  pop(prop: string) {\n    const value = this._source[prop];\n    this._stashed.delete(prop);\n    this._proxy[prop] = value;\n  }\n\n  stash(prop: string) {\n    this._stashed.add(prop);\n  }\n}\n\nexport function createYProxy<Data>(\n  yAbstract: unknown,\n  options: ProxyOptions<Data> = {}\n): Data {\n  if (proxies.has(yAbstract)) {\n    return proxies.get(yAbstract)!.proxy as Data;\n  }\n\n  const transform: TransformOptions['transform'] = (value, origin) => {\n    if (value instanceof Text) {\n      value.bind(options.onChange as OnTextChange);\n      return value;\n    }\n    if (Boxed.is(origin)) {\n      (value as Boxed).bind(options.onChange as OnBoxedChange);\n      return value;\n    }\n    if (origin instanceof YArray) {\n      const data = new ReactiveYArray(\n        value as unknown[],\n        origin,\n        options as ProxyOptions<unknown[]>\n      );\n      return data.proxy;\n    }\n    if (origin instanceof YMap) {\n      const data = new ReactiveYMap(\n        value as UnRecord,\n        origin,\n        options as ProxyOptions<UnRecord>\n      );\n      return data.proxy;\n    }\n\n    return value;\n  };\n\n  return y2Native(yAbstract, { transform }) as Data;\n}\n","import { SYS_KEYS } from '../../consts';\nimport { Boxed } from '../boxed';\nimport { Text } from '../text';\nimport type { UnRecord } from '../types';\n\nexport const keyWithoutPrefix = (key: string) => key.replace(/(prop|sys):/, '');\n\nexport const keyWithPrefix = (key: string) =>\n  SYS_KEYS.has(key) ? `sys:${key}` : `prop:${key}`;\n\nconst proxySymbol = Symbol('proxy');\n\nexport function isProxy(value: unknown): boolean {\n  return proxySymbol in Object.getPrototypeOf(value);\n}\n\nexport function markProxy(value: UnRecord): UnRecord {\n  Object.setPrototypeOf(value, {\n    [proxySymbol]: true,\n  });\n  return value;\n}\n\nexport function isEmptyObject(obj: UnRecord): boolean {\n  return Object.keys(obj).length === 0;\n}\n\nexport function deleteEmptyObject(\n  obj: UnRecord,\n  key: string,\n  parent: UnRecord\n): void {\n  if (isEmptyObject(obj)) {\n    delete parent[key];\n  }\n}\n\nexport function getFirstKey(key: string): string {\n  const result = key.split('.').at(0);\n  if (!result) {\n    throw new Error(`Invalid key for: ${key}`);\n  }\n  return result;\n}\n\nexport function bindOnChangeIfNeed(value: unknown, onChange: () => void): void {\n  if (value instanceof Text || Boxed.is(value)) {\n    value.bind(onChange);\n  }\n}\n","import { BlockSuiteError } from '@blocksuite/global/exceptions';\nimport { Array as YArray, Map as YMap, Text as YText } from 'yjs';\n\nimport { Boxed } from '../boxed';\nimport { Text } from '../text';\nimport type { UnRecord } from '../types';\nimport type { CreateProxyOptions } from './types';\nimport { keyWithoutPrefix } from './utils';\n\ntype InitializeDataOptions = Pick<CreateProxyOptions, 'transform' | 'yMap'> & {\n  getProxy: (source: UnRecord, root: UnRecord, path?: string) => UnRecord;\n};\n\n// Create default data object from yjs map\nexport const initializeData = ({\n  getProxy,\n  transform,\n  yMap,\n}: InitializeDataOptions): UnRecord => {\n  const root: UnRecord = {};\n  Array.from(yMap.entries()).forEach(([key, value]) => {\n    if (key.startsWith('sys')) {\n      return;\n    }\n    const keys = keyWithoutPrefix(key).split('.');\n    const firstKey = keys[0];\n\n    let finalData = value;\n    if (Boxed.is(value)) {\n      finalData = transform(firstKey, new Boxed(value), value);\n    } else if (value instanceof YArray) {\n      finalData = transform(firstKey, value.toArray(), value);\n    } else if (value instanceof YText) {\n      const next = new Text(value);\n      finalData = transform(firstKey, next, value);\n    } else if (value instanceof YMap) {\n      throw new BlockSuiteError(\n        BlockSuiteError.ErrorCode.ReactiveProxyError,\n        'flatY2Native does not support Y.Map as value of Y.Map'\n      );\n    } else {\n      finalData = transform(firstKey, value, value);\n    }\n    const allLength = keys.length;\n    void keys.reduce((acc: UnRecord, key, index) => {\n      if (!acc[key] && index !== allLength - 1) {\n        const path = keys.slice(0, index + 1).join('.');\n        const data = getProxy({} as UnRecord, root, path);\n        acc[key] = data;\n      }\n      if (index === allLength - 1) {\n        acc[key] = finalData;\n      }\n      return acc[key] as UnRecord;\n    }, root);\n  });\n\n  return root;\n};\n","import { isPureObject } from '../is-pure-object';\nimport type { CreateProxyOptions } from './types';\n\ntype UpdateSignalOptions = Pick<\n  CreateProxyOptions,\n  | 'shouldByPassSignal'\n  | 'root'\n  | 'onChange'\n  | 'byPassSignalUpdate'\n  | 'basePath'\n  | 'shouldByPassYjs'\n> & {\n  firstKey: string;\n  value: unknown;\n  handleNestedUpdate: (signalKey: string) => void;\n};\n\nexport function signalUpdater({\n  root,\n  firstKey,\n  shouldByPassSignal,\n  byPassSignalUpdate,\n  onChange,\n  basePath,\n  value,\n  handleNestedUpdate,\n  shouldByPassYjs,\n}: UpdateSignalOptions): void {\n  const isRoot = !basePath;\n  if (shouldByPassSignal()) {\n    return;\n  }\n\n  const signalKey = `${firstKey}$`;\n  if (!(signalKey in root)) {\n    if (!isRoot) {\n      return;\n    }\n    handleNestedUpdate(signalKey);\n    return;\n  }\n  byPassSignalUpdate(() => {\n    const prev = root[firstKey];\n    const next = isRoot\n      ? value\n      : isPureObject(prev)\n        ? { ...prev }\n        : Array.isArray(prev)\n          ? [...prev]\n          : prev;\n    // @ts-expect-error allow magic props\n    root[signalKey].value = next;\n    // If the update is from yjs, it's already called from y-event-handler\n    if (!shouldByPassYjs()) {\n      onChange?.(firstKey, true);\n    }\n  });\n}\n","import { isPureObject } from '../is-pure-object';\nimport { native2Y } from '../native-y';\nimport type { CreateProxyOptions } from './types';\nimport {\n  bindOnChangeIfNeed,\n  getFirstKey,\n  keyWithoutPrefix,\n  keyWithPrefix,\n} from './utils';\n\ntype YMapOptions = Pick<\n  CreateProxyOptions,\n  'shouldByPassYjs' | 'yMap' | 'initialized' | 'onChange'\n> & {\n  fullPath: string;\n  value: unknown;\n};\n\nexport function yMapUpdater({\n  shouldByPassYjs,\n  yMap,\n  initialized,\n  onChange,\n  fullPath,\n  value,\n}: YMapOptions) {\n  const firstKey = getFirstKey(fullPath);\n  if (shouldByPassYjs()) {\n    return;\n  }\n  const list: Array<() => void> = [];\n  yMap.forEach((_, key) => {\n    if (initialized() && keyWithoutPrefix(key).startsWith(fullPath)) {\n      yMap.delete(key);\n    }\n  });\n  const run = (obj: object, basePath: string) => {\n    Object.entries(obj).forEach(([key, value]) => {\n      const fullPath = basePath ? `${basePath}.${key}` : key;\n      if (isPureObject(value)) {\n        run(value, fullPath);\n      } else {\n        list.push(() => {\n          bindOnChangeIfNeed(value, () => {\n            onChange?.(firstKey, true);\n          });\n          yMap.set(keyWithPrefix(fullPath), native2Y(value));\n        });\n      }\n    });\n  };\n  run(value as object, fullPath);\n  if (list.length && initialized()) {\n    yMap.doc?.transact(\n      () => {\n        list.forEach(fn => fn());\n      },\n      { proxy: true }\n    );\n  }\n}\n","import { signal } from '@preact/signals-core';\n\nimport { isPureObject } from '../is-pure-object';\nimport { native2Y } from '../native-y';\nimport type { UnRecord } from '../types';\nimport { signalUpdater } from './signal-updater';\nimport type { CreateProxyOptions } from './types';\nimport {\n  bindOnChangeIfNeed,\n  getFirstKey,\n  isProxy,\n  keyWithPrefix,\n  markProxy,\n} from './utils';\nimport { yMapUpdater } from './y-map-updater';\n\nexport function createProxy(options: CreateProxyOptions): UnRecord {\n  const { base } = options;\n\n  if (isProxy(base)) {\n    return base;\n  }\n\n  initializeProxy(options);\n\n  const proxyHandler = createProxyHandler(options);\n  const proxy = new Proxy(base, proxyHandler);\n  markProxy(proxy);\n\n  return proxy;\n}\n\nfunction initializeProxy(options: CreateProxyOptions) {\n  const { basePath, yMap, base, root } = options;\n\n  Object.entries(base).forEach(([key, value]) => {\n    if (isPureObject(value) && !isProxy(value)) {\n      const proxy = createProxy({\n        ...options,\n        yMap,\n        base: value as UnRecord,\n        root,\n        basePath: basePath ? `${basePath}.${key}` : key,\n      });\n      base[key] = proxy;\n    }\n  });\n}\n\nfunction updateSignal(\n  value: unknown,\n  prop: string,\n  receiver: any,\n  options: CreateProxyOptions\n) {\n  const {\n    root,\n    shouldByPassSignal,\n    byPassSignalUpdate,\n    onChange,\n    basePath,\n    initialized,\n    onDispose,\n    shouldByPassYjs,\n  } = options;\n\n  const fullPath = basePath ? `${basePath}.${prop}` : prop;\n  const firstKey = getFirstKey(fullPath);\n  signalUpdater({\n    root,\n    firstKey,\n    shouldByPassSignal,\n    shouldByPassYjs,\n    byPassSignalUpdate,\n    onChange,\n    basePath,\n    value,\n    handleNestedUpdate: (signalKey: string) => {\n      if (value === undefined) {\n        delete root[signalKey];\n        return;\n      }\n\n      const signalData = signal(value);\n      root[signalKey] = signalData;\n      const unsubscribe = signalData.subscribe(next => {\n        if (!initialized()) {\n          return;\n        }\n        byPassSignalUpdate(() => {\n          receiver[prop] = next;\n          onChange?.(firstKey, true);\n        });\n      });\n      const subscription = onDispose.subscribe(() => {\n        subscription.unsubscribe();\n        unsubscribe();\n      });\n    },\n  });\n}\n\nfunction createProxyHandler(\n  options: CreateProxyOptions\n): ProxyHandler<UnRecord> {\n  const {\n    yMap,\n    shouldByPassYjs,\n    basePath,\n    onChange,\n    initialized,\n    transform,\n    stashed,\n  } = options;\n\n  return {\n    has: (target, p) => {\n      return Reflect.has(target, p);\n    },\n    get: (target, p, receiver) => {\n      return Reflect.get(target, p, receiver);\n    },\n    set: (target, p, value, receiver) => {\n      if (typeof p === 'string') {\n        const fullPath = basePath ? `${basePath}.${p}` : p;\n        const firstKey = getFirstKey(fullPath);\n        const isStashed = stashed.has(firstKey);\n\n        if (isPureObject(value)) {\n          const syncYMap = () =>\n            yMapUpdater({\n              shouldByPassYjs,\n              yMap,\n              initialized,\n              onChange,\n              fullPath,\n              value,\n            });\n\n          if (!isStashed) {\n            syncYMap();\n          }\n\n          const next = createProxy({\n            ...options,\n            basePath: fullPath,\n            base: value as UnRecord,\n          });\n\n          const result = Reflect.set(target, p, next, receiver);\n          updateSignal(next, p, receiver, options);\n          return result;\n        }\n\n        bindOnChangeIfNeed(value, () => {\n          onChange?.(firstKey, true);\n        });\n        const yValue = native2Y(value);\n        const next = transform(firstKey, value, yValue);\n\n        if (!isStashed && initialized() && !shouldByPassYjs()) {\n          yMap.doc?.transact(\n            () => {\n              yMap.set(keyWithPrefix(fullPath), yValue);\n            },\n            { proxy: true }\n          );\n        }\n\n        const result = Reflect.set(target, p, next, receiver);\n        updateSignal(next, p, receiver, options);\n        return result;\n      }\n      return Reflect.set(target, p, value, receiver);\n    },\n    deleteProperty: (target, p) => {\n      if (typeof p === 'string') {\n        const fullPath = basePath ? `${basePath}.${p}` : p;\n        const firstKey = getFirstKey(fullPath);\n        const isStashed = stashed.has(firstKey);\n\n        if (!isStashed && initialized() && !shouldByPassYjs()) {\n          yMap.doc?.transact(\n            () => {\n              const fullKey = keyWithPrefix(fullPath);\n              yMap.forEach((_, key) => {\n                if (key.startsWith(fullKey)) {\n                  yMap.delete(key);\n                }\n              });\n            },\n            { proxy: true }\n          );\n        }\n\n        const result = Reflect.deleteProperty(target, p);\n        updateSignal(undefined, p, undefined, options);\n        return result;\n      }\n      return Reflect.deleteProperty(target, p);\n    },\n  };\n}\n","import type { Map as YMap, YMapEvent } from 'yjs';\n\nimport { y2Native } from '../native-y';\nimport type { UnRecord } from '../types';\nimport {\n  deleteEmptyObject,\n  getFirstKey,\n  isEmptyObject,\n  keyWithoutPrefix,\n} from './utils';\n\ntype YEventHandlerOptions = {\n  event: YMapEvent<unknown>;\n  yMap: YMap<unknown>;\n  proxy: UnRecord;\n  stashed: Set<string | number>;\n  updateWithYjsSkip: (fn: () => void) => void;\n  transform: (key: string, value: unknown, origin: unknown) => unknown;\n  onChange?: (key: string, isAdd: boolean) => void;\n};\n\n// update proxy when yjs map changes\nexport const getYEventHandler = (options: YEventHandlerOptions) => {\n  const { event } = options;\n  const { keysChanged, changes } = event;\n\n  keysChanged.forEach(key => {\n    const type = changes.keys.get(key);\n    if (!type) return;\n\n    if (type.action === 'update' || type.action === 'add') {\n      return handleUpdateOrAdd(key, options);\n    }\n    if (type.action === 'delete') {\n      return handleDelete(key, options);\n    }\n  });\n};\n\nfunction isStashed(key: string, stashed: Set<string | number>) {\n  const keyName: string = keyWithoutPrefix(key);\n  const firstKey = getFirstKey(keyName);\n  return stashed.has(firstKey);\n}\n\nfunction handleUpdateOrAdd(\n  key: string,\n  {\n    yMap,\n    proxy,\n    stashed,\n    updateWithYjsSkip,\n    transform,\n    onChange,\n  }: YEventHandlerOptions\n) {\n  if (isStashed(key, stashed)) {\n    return;\n  }\n  const keyName: string = keyWithoutPrefix(key);\n  const firstKey = getFirstKey(keyName);\n  updateWithYjsSkip(() => {\n    const value = yMap.get(key);\n    const keys = keyName.split('.');\n    void keys.reduce((acc, key, index, arr) => {\n      if (!acc[key] && index !== arr.length - 1) {\n        acc[key] = {};\n      }\n      if (index === arr.length - 1) {\n        acc[key] = y2Native(value, {\n          transform: (value, origin) => transform(firstKey, value, origin),\n        });\n      }\n      return acc[key] as UnRecord;\n    }, proxy as UnRecord);\n  });\n  onChange?.(firstKey, false);\n}\n\nfunction handleDelete(\n  key: string,\n  { proxy, stashed, updateWithYjsSkip, onChange }: YEventHandlerOptions\n) {\n  if (isStashed(key, stashed)) {\n    return;\n  }\n  const keyName: string = keyWithoutPrefix(key);\n  const firstKey = getFirstKey(keyName);\n  updateWithYjsSkip(() => {\n    const keys = keyName.split('.');\n    void keys.reduce((acc, key, index) => {\n      if (index === keys.length - 1) {\n        delete acc[key];\n        let curr = acc;\n        let parentKey = keys[index - 1];\n        let parent = proxy as UnRecord;\n        let path = keys.slice(0, -2);\n\n        for (let i = keys.length - 2; i > 0; i--) {\n          for (const pathKey of path) {\n            parent = parent[pathKey] as UnRecord;\n          }\n          if (!isEmptyObject(curr)) {\n            break;\n          }\n          deleteEmptyObject(curr, parentKey, parent);\n          curr = parent;\n          parentKey = keys[i - 1];\n          path = path.slice(0, -1);\n          parent = proxy as UnRecord;\n        }\n      }\n      return acc[key] as UnRecord;\n    }, proxy as UnRecord);\n  });\n  onChange?.(firstKey, false);\n}\n","import { signal } from '@preact/signals-core';\nimport type { Subject } from 'rxjs';\nimport { Array as YArray, type Map as YMap, type YMapEvent } from 'yjs';\n\nimport { BaseReactiveYData } from '../base-reactive-data';\nimport { Boxed, type OnBoxedChange } from '../boxed';\nimport { ReactiveYArray } from '../proxy';\nimport { type OnTextChange, Text } from '../text';\nimport type { ProxyOptions, UnRecord } from '../types';\nimport { initializeData } from './initialize';\nimport { createProxy } from './proxy';\nimport type { OnChange } from './types';\nimport { getYEventHandler } from './y-event-handler';\n\nexport class ReactiveFlatYMap extends BaseReactiveYData<\n  UnRecord,\n  YMap<unknown>\n> {\n  protected readonly _proxy: UnRecord;\n  protected readonly _source: UnRecord;\n  protected readonly _options?: ProxyOptions<UnRecord>;\n\n  private readonly _initialized;\n\n  private readonly _observer = (event: YMapEvent<unknown>) => {\n    const yMap = this._ySource;\n    const proxy = this._proxy;\n    this._onObserve(event, () => {\n      getYEventHandler({\n        yMap,\n        proxy,\n        stashed: this._stashed,\n        updateWithYjsSkip: this._updateWithYjsSkip,\n        transform: this._transform,\n        onChange: this._onChange,\n        event,\n      });\n    });\n  };\n\n  private readonly _transform = (\n    key: string,\n    value: unknown,\n    origin: unknown\n  ) => {\n    const onChange = this._getPropOnChange(key);\n    if (value instanceof Text) {\n      value.bind(onChange as OnTextChange);\n      return value;\n    }\n    if (Boxed.is(origin)) {\n      (value as Boxed).bind(onChange as OnBoxedChange);\n      return value;\n    }\n    if (origin instanceof YArray) {\n      const data = new ReactiveYArray(value as unknown[], origin, {\n        onChange,\n      });\n      return data.proxy;\n    }\n\n    return value;\n  };\n\n  private readonly _getPropOnChange = (key: string) => {\n    return (_: unknown, isLocal: boolean) => {\n      this._onChange?.(key, isLocal);\n    };\n  };\n\n  private _byPassYjs = false;\n\n  private readonly _getProxy = (\n    source: UnRecord,\n    root: UnRecord,\n    path?: string\n  ): UnRecord =>\n    createProxy({\n      yMap: this._ySource,\n      base: source,\n      root,\n      onDispose: this._onDispose,\n      shouldByPassSignal: () => this._skipNext,\n      byPassSignalUpdate: this._updateWithSkip,\n      shouldByPassYjs: () => this._byPassYjs,\n      basePath: path,\n      onChange: this._onChange,\n      transform: this._transform,\n      stashed: this._stashed,\n      initialized: () => this._initialized,\n    });\n\n  private readonly _updateWithYjsSkip = (fn: () => void) => {\n    this._byPassYjs = true;\n    fn();\n    this._byPassYjs = false;\n  };\n\n  constructor(\n    protected readonly _ySource: YMap<unknown>,\n    private readonly _onDispose: Subject<void>,\n    private readonly _onChange?: OnChange\n  ) {\n    super();\n    this._initialized = false;\n    const source = initializeData({\n      getProxy: this._getProxy,\n      transform: this._transform,\n      yMap: this._ySource,\n    });\n    this._source = source;\n\n    const proxy = this._getProxy(source, source);\n\n    Object.entries(source).forEach(([key, value]) => {\n      const signalData = signal(value);\n      source[`${key}$`] = signalData;\n      const unsubscribe = signalData.subscribe(next => {\n        if (!this._initialized) {\n          return;\n        }\n        this._updateWithSkip(() => {\n          proxy[key] = next;\n          this._onChange?.(key, true);\n        });\n      });\n      const subscription = _onDispose.subscribe(() => {\n        subscription.unsubscribe();\n        unsubscribe();\n      });\n    });\n\n    this._proxy = proxy;\n    this._ySource.observe(this._observer);\n    this._initialized = true;\n  }\n\n  pop = (prop: string): void => {\n    const value = this._source[prop];\n    this._stashed.delete(prop);\n    this._proxy[prop] = value;\n  };\n\n  stash = (prop: string): void => {\n    this._stashed.add(prop);\n  };\n}\n","import type { Disposable } from '@blocksuite/global/disposable';\nimport { computed, type Signal, signal } from '@preact/signals-core';\nimport { Subject } from 'rxjs';\nimport { take } from 'rxjs/operators';\n\nimport type { Text } from '../../reactive/index.js';\nimport type { Store } from '../store/store.js';\nimport type { YBlock } from './types.js';\nimport type { BlockSchemaType } from './zod.js';\n\ntype SignaledProps<Props> = Props & {\n  [P in keyof Props & string as `${P}$`]: Signal<Props[P]>;\n};\n\nconst modelLabel = Symbol('model_label');\n\nexport class BlockModel<Props extends object = object> {\n  private readonly _children = signal<string[]>([]);\n\n  private _store!: Store;\n\n  private readonly _childModels = computed(() => {\n    const value: BlockModel[] = [];\n    this._children.value.forEach(id => {\n      const block = this._store.getBlock$(id);\n      if (block) {\n        value.push(block.model);\n      }\n    });\n    return value;\n  });\n\n  private readonly _onCreated: Disposable;\n\n  private readonly _onDeleted: Disposable;\n\n  childMap = computed(() =>\n    this._children.value.reduce((map, id, index) => {\n      map.set(id, index);\n      return map;\n    }, new Map<string, number>())\n  );\n\n  created = new Subject<void>();\n\n  deleted = new Subject<void>();\n\n  id!: string;\n\n  schema!: BlockSchemaType;\n\n  isEmpty() {\n    return this.children.length === 0;\n  }\n\n  keys!: string[];\n\n  // This is used to avoid https://stackoverflow.com/questions/55886792/infer-typescript-generic-class-type\n  [modelLabel]: Props = 'type_info_label' as never;\n\n  pop!: (prop: keyof Props & string) => void;\n\n  propsUpdated = new Subject<{ key: string }>();\n\n  stash!: (prop: keyof Props & string) => void;\n\n  get text(): Text | undefined {\n    return (this.props as { text?: Text }).text;\n  }\n\n  set text(text: Text) {\n    if (this.keys.includes('text')) {\n      (this.props as { text?: Text }).text = text;\n    }\n  }\n\n  yBlock!: YBlock;\n\n  _props!: SignaledProps<Props>;\n\n  get props() {\n    if (!this._props) {\n      throw new Error('props is only supported in flat data model');\n    }\n    return this._props;\n  }\n\n  get flavour(): string {\n    return this.schema.model.flavour;\n  }\n\n  get version() {\n    return this.schema.version;\n  }\n\n  get children() {\n    return this._childModels.value;\n  }\n\n  get store() {\n    return this._store;\n  }\n\n  set store(doc: Store) {\n    this._store = doc;\n  }\n\n  get parent() {\n    return this.store.getParent(this);\n  }\n\n  get role() {\n    return this.schema.model.role;\n  }\n\n  constructor() {\n    this._onCreated = {\n      dispose: this.created.pipe(take(1)).subscribe(() => {\n        this._children.value = this.yBlock.get('sys:children').toArray();\n        this.yBlock.get('sys:children').observe(event => {\n          this._children.value = event.target.toArray();\n        });\n        this.yBlock.observe(event => {\n          if (event.keysChanged.has('sys:children')) {\n            this._children.value = this.yBlock.get('sys:children').toArray();\n          }\n        });\n      }).unsubscribe,\n    };\n    this._onDeleted = {\n      dispose: this.deleted.pipe(take(1)).subscribe(() => {\n        this._onCreated.dispose();\n      }).unsubscribe,\n    };\n  }\n\n  dispose() {\n    this.created.complete();\n    this.deleted.complete();\n    this.propsUpdated.complete();\n  }\n\n  firstChild(): BlockModel | null {\n    return this.children[0] || null;\n  }\n\n  lastChild(): BlockModel | null {\n    if (!this.children.length) {\n      return this;\n    }\n    return this.children[this.children.length - 1].lastChild();\n  }\n\n  [Symbol.dispose]() {\n    this._onCreated.dispose();\n    this._onDeleted.dispose();\n  }\n}\n","import type * as Y from 'yjs';\nimport { z } from 'zod';\n\nimport { Boxed, Text } from '../../reactive/index.js';\nimport type { BaseBlockTransformer } from '../../transformer/base.js';\nimport type { BlockModel } from './block-model.js';\n\nconst FlavourSchema = z.string();\nconst ParentSchema = z.array(z.string()).optional();\nconst ContentSchema = z.array(z.string()).optional();\nconst RoleSchema = z.string();\n\nexport type RoleType = 'root' | 'content' | string;\n\nexport interface InternalPrimitives {\n  Text: (input?: Y.Text | string) => Text;\n  Boxed: <T>(input: T) => Boxed<T>;\n}\n\nexport const internalPrimitives: InternalPrimitives = Object.freeze({\n  Text: (input: Y.Text | string = '') => new Text(input),\n  Boxed: <T>(input: T) => new Boxed(input),\n});\n\nexport const BlockSchema = z.object({\n  version: z.number(),\n  model: z.object({\n    role: RoleSchema,\n    flavour: FlavourSchema,\n    parent: ParentSchema,\n    children: ContentSchema,\n    isFlatData: z.boolean().optional(),\n    props: z\n      .function()\n      .args(z.custom<InternalPrimitives>())\n      .returns(z.record(z.any()))\n      .optional(),\n    toModel: z.function().args().returns(z.custom<BlockModel>()).optional(),\n  }),\n  transformer: z\n    .function()\n    .args(z.custom<Map<string, unknown>>())\n    .returns(z.custom<BaseBlockTransformer>())\n    .optional(),\n});\n\nexport type BlockSchemaType = z.infer<typeof BlockSchema>;\n\nexport type PropsGetter<Props> = (\n  internalPrimitives: InternalPrimitives\n) => Props;\n\nexport function defineBlockSchema<\n  Flavour extends string,\n  Role extends RoleType,\n  Props extends object,\n  Metadata extends Readonly<{\n    version: number;\n    role: Role;\n    parent?: string[];\n    children?: string[];\n    isFlatData?: boolean;\n  }>,\n  Model extends BlockModel<Props>,\n  Transformer extends BaseBlockTransformer<Props>,\n>(options: {\n  flavour: Flavour;\n  metadata: Metadata;\n  props?: (internalPrimitives: InternalPrimitives) => Props;\n  toModel?: () => Model;\n  transformer?: (transformerConfig: Map<string, unknown>) => Transformer;\n}): {\n  version: number;\n  model: {\n    props: PropsGetter<Props>;\n    flavour: Flavour;\n  } & Metadata;\n  transformer?: (transformerConfig: Map<string, unknown>) => Transformer;\n};\n\nexport function defineBlockSchema({\n  flavour,\n  props,\n  metadata,\n  toModel,\n  transformer,\n}: {\n  flavour: string;\n  metadata: {\n    version: number;\n    role: RoleType;\n    parent?: string[];\n    children?: string[];\n    isFlatData?: boolean;\n  };\n  props?: (internalPrimitives: InternalPrimitives) => Record<string, unknown>;\n  toModel?: () => BlockModel;\n  transformer?: (\n    transformerConfig: Map<string, unknown>\n  ) => BaseBlockTransformer;\n}): BlockSchemaType {\n  const schema = {\n    version: metadata.version,\n    model: {\n      role: metadata.role,\n      parent: metadata.parent,\n      children: metadata.children,\n      flavour,\n      props,\n      toModel,\n      isFlatData: metadata.isFlatData,\n    },\n    transformer,\n  } satisfies z.infer<typeof BlockSchema>;\n  BlockSchema.parse(schema);\n  return schema;\n}\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport * as Y from 'yjs';\n\nimport { ReactiveFlatYMap } from '../../reactive/flat-native-y/index.js';\nimport type { Schema } from '../../schema/schema.js';\nimport type { Store } from '../store/store.js';\nimport { BlockModel } from './block-model.js';\nimport type { YBlock } from './types.js';\nimport { internalPrimitives } from './zod.js';\n\nexport class FlatSyncController {\n  private _reactive!: ReactiveFlatYMap;\n\n  readonly flavour: string;\n\n  readonly id: string;\n\n  readonly model: BlockModel;\n\n  readonly version: number;\n\n  readonly yChildren: Y.Array<string[]>;\n\n  constructor(\n    readonly schema: Schema,\n    readonly yBlock: YBlock,\n    readonly doc?: Store,\n    readonly onChange?: (key: string, isLocal: boolean) => void\n  ) {\n    const { id, flavour, version, yChildren, props } = this._parseYBlock();\n\n    this.id = id;\n    this.flavour = flavour;\n    this.yChildren = yChildren;\n    this.version = version;\n\n    this.model = this._createModel(props);\n  }\n\n  private _createModel(props: Set<string>) {\n    const schema = this.schema.flavourSchemaMap.get(this.flavour);\n    if (!schema) {\n      throw new BlockSuiteError(\n        ErrorCode.ModelCRUDError,\n        `schema for flavour: ${this.flavour} not found`\n      );\n    }\n\n    const model = schema.model.toModel?.() ?? new BlockModel<object>();\n    model.schema = schema;\n\n    model.id = this.id;\n    model.keys = Array.from(props);\n    model.yBlock = this.yBlock;\n    const reactive = new ReactiveFlatYMap(\n      this.yBlock,\n      model.deleted,\n      this.onChange\n    );\n    this._reactive = reactive;\n    const proxy = reactive.proxy;\n    model._props = proxy;\n    model.stash = this.stash;\n    model.pop = this.pop;\n    if (this.doc) {\n      model.store = this.doc;\n    }\n\n    const defaultProps = schema.model.props?.(internalPrimitives);\n    if (defaultProps) {\n      Object.entries(defaultProps).forEach(([key, value]) => {\n        if (key in proxy) {\n          return;\n        }\n        if (value === undefined) return;\n        proxy[key] = value;\n      });\n    }\n\n    return model;\n  }\n\n  private _parseYBlock() {\n    let id: string | undefined;\n    let flavour: string | undefined;\n    let version: number | undefined;\n    let yChildren: Y.Array<string[]> | undefined;\n    const props: Set<string> = new Set();\n\n    this.yBlock.forEach((value, key) => {\n      if (key === 'sys:id' && typeof value === 'string') {\n        id = value;\n        return;\n      }\n      if (key === 'sys:flavour' && typeof value === 'string') {\n        flavour = value;\n        return;\n      }\n      if (key === 'sys:children' && value instanceof Y.Array) {\n        yChildren = value;\n        return;\n      }\n      if (key === 'sys:version' && typeof value === 'number') {\n        version = value;\n        return;\n      }\n      if (key.startsWith('prop:')) {\n        const keyName = key.replace('prop:', '');\n        const keys = keyName.split('.');\n        const propKey = keys[0];\n        props.add(propKey);\n        return;\n      }\n    });\n\n    if (!id) {\n      throw new BlockSuiteError(\n        ErrorCode.ModelCRUDError,\n        'block id is not found when creating model'\n      );\n    }\n    if (!flavour) {\n      throw new BlockSuiteError(\n        ErrorCode.ModelCRUDError,\n        'block flavour is not found when creating model'\n      );\n    }\n    if (!yChildren) {\n      throw new BlockSuiteError(\n        ErrorCode.ModelCRUDError,\n        'block children is not found when creating model'\n      );\n    }\n\n    const schema = this.schema.flavourSchemaMap.get(flavour);\n    if (!schema) {\n      throw new BlockSuiteError(\n        ErrorCode.ModelCRUDError,\n        `schema for flavour: ${flavour} not found`\n      );\n    }\n\n    if (typeof version !== 'number') {\n      // no version found in data, set to schema version\n      version = schema.version;\n    }\n\n    const defaultProps = schema.model.props?.(internalPrimitives);\n    // Set default props if not exists\n    if (defaultProps) {\n      Object.keys(defaultProps).forEach(key => {\n        if (props.has(key)) return;\n        props.add(key);\n      });\n    }\n\n    return {\n      id,\n      flavour,\n      version,\n      props,\n      yChildren,\n    };\n  }\n\n  get stash() {\n    return this._reactive.stash;\n  }\n\n  get pop() {\n    return this._reactive.pop;\n  }\n}\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { effect, signal } from '@preact/signals-core';\nimport { createMutex } from 'lib0/mutex.js';\nimport * as Y from 'yjs';\n\nimport {\n  Boxed,\n  createYProxy,\n  native2Y,\n  type UnRecord,\n  y2Native,\n} from '../../reactive/index.js';\nimport type { Schema } from '../../schema/schema.js';\nimport type { Store } from '../store/store.js';\nimport { BlockModel } from './block-model.js';\nimport type { YBlock } from './types.js';\nimport { internalPrimitives } from './zod.js';\n\n/**\n * @internal\n * SyncController is responsible for syncing the block data with Yjs.\n * It creates a proxy model that syncs with Yjs and provides a reactive interface.\n * It also handles the stashing and popping of props.\n * It will also provide signals for block props.\n *\n */\nexport class SyncController {\n  private _byPassProxy: boolean = false;\n\n  private readonly _byPassUpdate = (fn: () => void) => {\n    this._byPassProxy = true;\n    fn();\n    this._byPassProxy = false;\n  };\n\n  private readonly _mutex = createMutex();\n\n  private readonly _observeYBlockChanges = () => {\n    this.yBlock.observe(event => {\n      event.keysChanged.forEach(key => {\n        const type = event.changes.keys.get(key);\n        if (!type) {\n          return;\n        }\n        const isLocal =\n          !this.yBlock.doc ||\n          !event.transaction.origin ||\n          event.transaction.origin instanceof Y.UndoManager ||\n          event.transaction.origin.proxy\n            ? true\n            : event.transaction.origin === this.yBlock.doc.clientID;\n        if (type.action === 'update' || type.action === 'add') {\n          const value = this.yBlock.get(key);\n          const keyName = key.replace('prop:', '');\n          const proxy = this._getPropsProxy(keyName, value);\n          this._byPassUpdate(() => {\n            // @ts-expect-error allow magic props\n            this.model.props[keyName] = proxy;\n            const signalKey = `${keyName}$`;\n            this._mutex(() => {\n              if (signalKey in this.model.props) {\n                // @ts-expect-error allow magic props\n                this.model.props[signalKey].value = y2Native(value);\n              }\n            });\n          });\n          this.onChange?.(keyName, isLocal);\n          return;\n        }\n        if (type.action === 'delete') {\n          const keyName = key.replace('prop:', '');\n          this._byPassUpdate(() => {\n            // @ts-expect-error allow magic props\n            delete this.model.props[keyName];\n            if (`${keyName}$` in this.model.props) {\n              // @ts-expect-error allow magic props\n              this.model.props[`${keyName}$`].value = undefined;\n            }\n          });\n          this.onChange?.(keyName, isLocal);\n          return;\n        }\n      });\n    });\n  };\n\n  private readonly _stashed = new Set<string | number>();\n\n  readonly flavour: string;\n\n  readonly id: string;\n\n  readonly model: BlockModel;\n\n  readonly pop = (prop: string) => {\n    if (!this._stashed.has(prop)) return;\n    this._popProp(prop);\n  };\n\n  readonly stash = (prop: string) => {\n    if (this._stashed.has(prop)) return;\n\n    this._stashed.add(prop);\n    this._stashProp(prop);\n  };\n\n  readonly version: number;\n\n  readonly yChildren: Y.Array<string[]>;\n\n  constructor(\n    readonly schema: Schema,\n    readonly yBlock: YBlock,\n    readonly doc?: Store,\n    readonly onChange?: (key: string, isLocal: boolean) => void\n  ) {\n    const { id, flavour, version, yChildren, props } = this._parseYBlock();\n\n    this.id = id;\n    this.flavour = flavour;\n    this.yChildren = yChildren;\n    this.version = version;\n\n    this.model = this._createModel(props);\n\n    this._observeYBlockChanges();\n  }\n\n  private _createModel(props: UnRecord) {\n    const _mutex = this._mutex;\n    const schema = this.schema.flavourSchemaMap.get(this.flavour);\n    if (!schema) {\n      throw new BlockSuiteError(\n        ErrorCode.ModelCRUDError,\n        `schema for flavour: ${this.flavour} not found`\n      );\n    }\n\n    const model = schema.model.toModel?.() ?? new BlockModel<object>();\n    model.schema = schema;\n    const signalWithProps = Object.entries(props).reduce(\n      (acc, [key, value]) => {\n        const data = signal(value);\n        const dispose = effect(() => {\n          const value = data.value;\n          if (!this.model) return;\n          _mutex(() => {\n            // @ts-expect-error allow magic props\n            this.model.props[key] = value;\n          });\n        });\n        const subscription = model.deleted.subscribe(() => {\n          subscription.unsubscribe();\n          dispose();\n        });\n        return {\n          ...acc,\n          [`${key}$`]: data,\n          [key]: value,\n        };\n      },\n      {} as Record<string, unknown>\n    );\n\n    model.id = this.id;\n    model.keys = Object.keys(props);\n    model.yBlock = this.yBlock;\n    model.stash = this.stash;\n    model.pop = this.pop;\n    if (this.doc) {\n      model.store = this.doc;\n    }\n\n    const proxy = new Proxy(signalWithProps, {\n      has: (target, p) => {\n        return Reflect.has(target, p);\n      },\n      set: (target, p, value, receiver) => {\n        if (\n          !this._byPassProxy &&\n          typeof p === 'string' &&\n          model.keys.includes(p)\n        ) {\n          if (this._stashed.has(p)) {\n            setValue(target, p, value);\n            const result = Reflect.set(target, p, value, receiver);\n            this.onChange?.(p, true);\n            return result;\n          }\n\n          const yValue = native2Y(value);\n          if (this.yBlock.get(`prop:${p}`) === yValue) {\n            return Reflect.set(target, p, value, receiver);\n          }\n          this.yBlock.set(`prop:${p}`, yValue);\n          const proxy = this._getPropsProxy(p, yValue);\n          setValue(target, p, value);\n          return Reflect.set(target, p, proxy, receiver);\n        }\n\n        return Reflect.set(target, p, value, receiver);\n      },\n      get: (target, p, receiver) => {\n        return Reflect.get(target, p, receiver);\n      },\n      deleteProperty: (target, p) => {\n        if (\n          !this._byPassProxy &&\n          typeof p === 'string' &&\n          model.keys.includes(p)\n        ) {\n          this.yBlock.delete(`prop:${p}`);\n          setValue(target, p, undefined);\n        }\n\n        return Reflect.deleteProperty(target, p);\n      },\n    });\n    model._props = proxy;\n\n    function setValue(target: UnRecord, p: string, value: unknown) {\n      _mutex(() => {\n        // @ts-expect-error allow magic props\n        target[`${p}$`].value = value;\n      });\n    }\n    return model;\n  }\n\n  private _getPropsProxy(name: string, value: unknown) {\n    return createYProxy(value, {\n      onChange: (_, isLocal) => {\n        this.onChange?.(name, isLocal);\n        const signalKey = `${name}$`;\n        if (signalKey in this.model.props) {\n          this._mutex(() => {\n            // @ts-expect-error allow magic props\n            this.model.props[signalKey].value = y2Native(value);\n          });\n        }\n      },\n    });\n  }\n\n  private _parseYBlock() {\n    let id: string | undefined;\n    let flavour: string | undefined;\n    let version: number | undefined;\n    let yChildren: Y.Array<string[]> | undefined;\n    const props: Record<string, unknown> = {};\n\n    this.yBlock.forEach((value, key) => {\n      if (key.startsWith('prop:')) {\n        const keyName = key.replace('prop:', '');\n        props[keyName] = this._getPropsProxy(keyName, value);\n        return;\n      }\n      if (key === 'sys:id' && typeof value === 'string') {\n        id = value;\n        return;\n      }\n      if (key === 'sys:flavour' && typeof value === 'string') {\n        flavour = value;\n        return;\n      }\n      if (key === 'sys:children' && value instanceof Y.Array) {\n        yChildren = value;\n        return;\n      }\n      if (key === 'sys:version' && typeof value === 'number') {\n        version = value;\n        return;\n      }\n    });\n\n    if (!id) {\n      throw new BlockSuiteError(\n        ErrorCode.ModelCRUDError,\n        'block id is not found when creating model'\n      );\n    }\n    if (!flavour) {\n      throw new BlockSuiteError(\n        ErrorCode.ModelCRUDError,\n        'block flavour is not found when creating model'\n      );\n    }\n    if (!yChildren) {\n      throw new BlockSuiteError(\n        ErrorCode.ModelCRUDError,\n        'block children is not found when creating model'\n      );\n    }\n\n    const schema = this.schema.flavourSchemaMap.get(flavour);\n    if (!schema) {\n      throw new BlockSuiteError(\n        ErrorCode.ModelCRUDError,\n        `schema for flavour: ${flavour} not found`\n      );\n    }\n    const defaultProps = schema.model.props?.(internalPrimitives);\n\n    if (typeof version !== 'number') {\n      // no version found in data, set to schema version\n      version = schema.version;\n    }\n\n    // Set default props if not exists\n    if (defaultProps) {\n      Object.entries(defaultProps).forEach(([key, value]) => {\n        if (key in props) return;\n\n        const yValue = native2Y(value);\n        if (value !== undefined) {\n          this.yBlock.set(`prop:${key}`, yValue);\n        }\n        props[key] = this._getPropsProxy(key, yValue);\n      });\n    }\n\n    return {\n      id,\n      flavour,\n      version,\n      props,\n      yChildren,\n    };\n  }\n\n  private _popProp(prop: string) {\n    const model = this.model as BlockModel<Record<string, unknown>>;\n\n    const value = model.props[prop];\n    this._stashed.delete(prop);\n    model.props[prop] = value;\n  }\n\n  private _stashProp(prop: string) {\n    (this.model as BlockModel<Record<string, unknown>>).props[prop] = y2Native(\n      this.yBlock.get(`prop:${prop}`),\n      {\n        transform: (value, origin) => {\n          if (Boxed.is(origin)) {\n            return value;\n          }\n          if (origin instanceof Y.Map) {\n            return new Proxy(value as UnRecord, {\n              get: (target, p, receiver) => {\n                return Reflect.get(target, p, receiver);\n              },\n              set: (target, p, value, receiver) => {\n                const result = Reflect.set(target, p, value, receiver);\n                this.onChange?.(prop, true);\n                return result;\n              },\n              deleteProperty: (target, p) => {\n                const result = Reflect.deleteProperty(target, p);\n                this.onChange?.(prop, true);\n                return result;\n              },\n            });\n          }\n          if (origin instanceof Y.Array) {\n            return new Proxy(value as unknown[], {\n              get: (target, p, receiver) => {\n                return Reflect.get(target, p, receiver);\n              },\n              set: (target, p, value, receiver) => {\n                const index = Number(p);\n                if (Number.isNaN(index)) {\n                  return Reflect.set(target, p, value, receiver);\n                }\n                const result = Reflect.set(target, p, value, receiver);\n                this.onChange?.(prop, true);\n                return result;\n              },\n              deleteProperty: (target, p) => {\n                const result = Reflect.deleteProperty(target, p);\n                this.onChange?.(p as string, true);\n                return result;\n              },\n            });\n          }\n\n          return value;\n        },\n      }\n    );\n  }\n}\n","import type { Schema } from '../../schema/index.js';\nimport type { Store } from '../store/store.js';\nimport { FlatSyncController } from './flat-sync-controller.js';\nimport { SyncController } from './sync-controller.js';\nimport type { BlockOptions, YBlock } from './types.js';\n\nexport type BlockViewType = 'bypass' | 'display' | 'hidden';\n\nexport class Block {\n  private readonly _syncController: SyncController | FlatSyncController;\n\n  blockViewType: BlockViewType = 'display';\n\n  get flavour() {\n    return this._syncController.flavour;\n  }\n\n  get id() {\n    return this._syncController.id;\n  }\n\n  get model() {\n    return this._syncController.model;\n  }\n\n  get pop() {\n    return this._syncController.pop;\n  }\n\n  get stash() {\n    return this._syncController.stash;\n  }\n\n  get version() {\n    return this._syncController.version;\n  }\n\n  constructor(\n    readonly schema: Schema,\n    readonly yBlock: YBlock,\n    readonly doc?: Store,\n    readonly options: BlockOptions = {}\n  ) {\n    const onChange = !options.onChange\n      ? undefined\n      : (key: string, isLocal: boolean) => {\n          if (!this._syncController || !this.model) {\n            return;\n          }\n          options.onChange?.(this, key, isLocal);\n        };\n    const flavour = yBlock.get('sys:flavour') as string;\n    const blockSchema = this.schema.get(flavour);\n    if (blockSchema?.model.isFlatData) {\n      this._syncController = new FlatSyncController(\n        schema,\n        yBlock,\n        doc,\n        onChange\n      );\n    } else {\n      this._syncController = new SyncController(schema, yBlock, doc, onChange);\n    }\n  }\n}\n","import type { BlockModel } from './block-model.js';\n\ntype PropsInDraft = 'version' | 'flavour' | 'role' | 'id' | 'keys' | 'text';\n\ntype ModelProps<Model> = Model extends BlockModel<infer U> ? U : never;\n\nconst draftModelSymbol = Symbol('draftModel');\n\nexport type DraftModel<Model extends BlockModel = BlockModel> = Pick<\n  Model,\n  PropsInDraft\n> & {\n  children: DraftModel[];\n  props: ModelProps<Model>;\n  [draftModelSymbol]: true;\n};\n\nexport function toDraftModel<Model extends BlockModel = BlockModel>(\n  origin: Model\n): DraftModel<Model> {\n  const { id, version, flavour, role, keys, text, children } = origin;\n\n  const props = origin.keys.reduce((acc, key) => {\n    const target = origin.props;\n    const value = target[key as keyof typeof target];\n    return {\n      ...acc,\n      [key]: value,\n    };\n  }, {} as ModelProps<Model>);\n\n  return {\n    id,\n    version,\n    flavour,\n    role,\n    keys,\n    text,\n    children: children.map(toDraftModel),\n    props,\n  } as DraftModel<Model>;\n}\n","import type { ServiceVariant } from './types.js';\n\nexport const DEFAULT_SERVICE_VARIANT: ServiceVariant = 'default';\nexport const ROOT_SCOPE = [];\n","import { DEFAULT_SERVICE_VARIANT } from './consts.js';\nimport type { ServiceIdentifierValue } from './types.js';\n\nexport class RecursionLimitError extends Error {\n  constructor() {\n    super('Dynamic resolve recursion limit reached');\n  }\n}\n\nexport class CircularDependencyError extends Error {\n  constructor(readonly dependencyStack: ServiceIdentifierValue[]) {\n    super(\n      `A circular dependency was detected.\\n` +\n        stringifyDependencyStack(dependencyStack)\n    );\n  }\n}\n\nexport class ServiceNotFoundError extends Error {\n  constructor(readonly identifier: ServiceIdentifierValue) {\n    super(`Service ${stringifyIdentifier(identifier)} not found in container`);\n  }\n}\n\nexport class MissingDependencyError extends Error {\n  constructor(\n    readonly from: ServiceIdentifierValue,\n    readonly target: ServiceIdentifierValue,\n    readonly dependencyStack: ServiceIdentifierValue[]\n  ) {\n    super(\n      `Missing dependency ${stringifyIdentifier(\n        target\n      )} in creating service ${stringifyIdentifier(\n        from\n      )}.\\n${stringifyDependencyStack(dependencyStack)}`\n    );\n  }\n}\n\nexport class DuplicateServiceDefinitionError extends Error {\n  constructor(readonly identifier: ServiceIdentifierValue) {\n    super(`Service ${stringifyIdentifier(identifier)} already exists`);\n  }\n}\n\nfunction stringifyIdentifier(identifier: ServiceIdentifierValue) {\n  return `[${identifier.identifierName}]${\n    identifier.variant !== DEFAULT_SERVICE_VARIANT\n      ? `(${identifier.variant})`\n      : ''\n  }`;\n}\n\nfunction stringifyDependencyStack(dependencyStack: ServiceIdentifierValue[]) {\n  return dependencyStack\n    .map(identifier => `${stringifyIdentifier(identifier)}`)\n    .join(' -> ');\n}\n","// copied from https://github.com/shuding/stable-hash\n\n// Use WeakMap to store the object-key mapping so the objects can still be\n// garbage collected. WeakMap uses a hashtable under the hood, so the lookup\n// complexity is almost O(1).\nconst table = new WeakMap<object, string>();\n\n// A counter of the key.\nlet counter = 0;\n\n// A stable hash implementation that supports:\n//  - Fast and ensures unique hash properties\n//  - Handles unserializable values\n//  - Handles object key ordering\n//  - Generates short results\n//\n// This is not a serialization function, and the result is not guaranteed to be\n// parsable.\nexport function stableHash(arg: any): string {\n  const type = typeof arg;\n  const constructor = arg && arg.constructor;\n  const isDate = constructor === Date;\n\n  if (Object(arg) === arg && !isDate && constructor !== RegExp) {\n    // Object/function, not null/date/regexp. Use WeakMap to store the id first.\n    // If it's already hashed, directly return the result.\n    let result = table.get(arg);\n    if (result) return result;\n    // Store the hash first for circular reference detection before entering the\n    // recursive `stableHash` calls.\n    // For other objects like set and map, we use this id directly as the hash.\n    result = ++counter + '~';\n    table.set(arg, result);\n    let index: any;\n\n    if (constructor === Array) {\n      // Array.\n      result = '@';\n      for (index = 0; index < arg.length; index++) {\n        result += stableHash(arg[index]) + ',';\n      }\n      table.set(arg, result);\n    } else if (constructor === Object) {\n      // Object, sort keys.\n      result = '#';\n      const keys = Object.keys(arg).sort();\n      while ((index = keys.pop() as string) !== undefined) {\n        if (arg[index] !== undefined) {\n          result += index + ':' + stableHash(arg[index]) + ',';\n        }\n      }\n      table.set(arg, result);\n    }\n    return result;\n  }\n  if (isDate) return arg.toJSON();\n  if (type === 'symbol') return arg.toString();\n  return type === 'string' ? JSON.stringify(arg) : '' + arg;\n}\n","import { DEFAULT_SERVICE_VARIANT } from './consts.js';\nimport { stableHash } from './stable-hash.js';\nimport type {\n  ServiceIdentifier,\n  ServiceIdentifierValue,\n  ServiceVariant,\n  Type,\n} from './types.js';\n\n/**\n * create a ServiceIdentifier.\n *\n * ServiceIdentifier is used to identify a certain type of service. With the identifier, you can reference one or more services\n * without knowing the specific implementation, thereby achieving\n * [inversion of control](https://en.wikipedia.org/wiki/Inversion_of_control).\n *\n * @example\n * ```ts\n * // define a interface\n * interface Storage {\n *   get(key: string): string | null;\n *   set(key: string, value: string): void;\n * }\n *\n * // create a identifier\n * // NOTICE: Highly recommend to use the interface name as the identifier name,\n * // so that it is easy to understand. and it is legal to do so in TypeScript.\n * const Storage = createIdentifier<Storage>('Storage');\n *\n * // create a implementation\n * class LocalStorage implements Storage {\n *   get(key: string): string | null {\n *     return localStorage.getItem(key);\n *   }\n *   set(key: string, value: string): void {\n *     localStorage.setItem(key, value);\n *   }\n * }\n *\n * // register the implementation to the identifier\n * services.addImpl(Storage, LocalStorage);\n *\n * // get the implementation from the identifier\n * const storage = services.provider().get(Storage);\n * storage.set('foo', 'bar');\n * ```\n *\n * With identifier:\n *\n * * You can easily replace the implementation of a `Storage` without changing the code that uses it.\n * * You can easily mock a `Storage` for testing.\n *\n * # Variant\n *\n * Sometimes, you may want to register multiple implementations for the same interface.\n * For example, you may want have both `LocalStorage` and `SessionStorage` for `Storage`,\n * and use them in same time.\n *\n * In this case, you can use `variant` to distinguish them.\n *\n * ```ts\n * const Storage = createIdentifier<Storage>('Storage');\n * const LocalStorage = Storage('local');\n * const SessionStorage = Storage('session');\n *\n * services.addImpl(LocalStorage, LocalStorageImpl);\n * services.addImpl(SessionStorage, SessionStorageImpl);\n *\n * // get the implementation from the identifier\n * const localStorage = services.provider().get(LocalStorage);\n * const sessionStorage = services.provider().get(SessionStorage);\n * const storage = services.provider().getAll(Storage); // { local: LocalStorageImpl, session: SessionStorageImpl }\n * ```\n *\n * @param name unique name of the identifier.\n * @param variant The default variant name of the identifier, can be overridden by `identifier(\"variant\")`.\n */\nexport function createIdentifier<T>(\n  name: string,\n  variant: ServiceVariant = DEFAULT_SERVICE_VARIANT\n): ServiceIdentifier<T> &\n  (<U extends T = T>(variant: ServiceVariant) => ServiceIdentifier<U>) {\n  return Object.assign(\n    <U extends T = T>(variant: ServiceVariant) => {\n      return createIdentifier<U>(name, variant);\n    },\n    {\n      identifierName: name,\n      variant,\n    }\n  ) as never;\n}\n\n/**\n * Convert the constructor into a ServiceIdentifier.\n * As we always deal with ServiceIdentifier in the DI container.\n *\n * @internal\n */\nexport function createIdentifierFromConstructor<T>(\n  target: Type<T>\n): ServiceIdentifier<T> {\n  return createIdentifier<T>(`${target.name}${stableHash(target)}`);\n}\n\nexport function parseIdentifier(input: any): ServiceIdentifierValue {\n  if (input.identifierName) {\n    return input as ServiceIdentifierValue;\n  } else if (typeof input === 'function' && input.name) {\n    return createIdentifierFromConstructor(input);\n  } else {\n    throw new Error('Input is not a service identifier.');\n  }\n}\n","import type { Container } from './container.js';\nimport {\n  CircularDependencyError,\n  MissingDependencyError,\n  RecursionLimitError,\n  ServiceNotFoundError,\n} from './error.js';\nimport { parseIdentifier } from './identifier.js';\nimport type {\n  GeneralServiceIdentifier,\n  ServiceIdentifierValue,\n  ServiceVariant,\n} from './types.js';\n\nexport interface ResolveOptions {\n  sameScope?: boolean;\n  optional?: boolean;\n}\n\nexport abstract class ServiceProvider {\n  abstract container: Container;\n\n  get<T>(identifier: GeneralServiceIdentifier<T>, options?: ResolveOptions): T {\n    return this.getRaw(parseIdentifier(identifier), {\n      ...options,\n      optional: false,\n    });\n  }\n\n  getAll<T>(\n    identifier: GeneralServiceIdentifier<T>,\n    options?: ResolveOptions\n  ): Map<ServiceVariant, T> {\n    return this.getAllRaw(parseIdentifier(identifier), {\n      ...options,\n    });\n  }\n\n  abstract getAllRaw(\n    identifier: ServiceIdentifierValue,\n    options?: ResolveOptions\n  ): Map<ServiceVariant, any>;\n\n  getOptional<T>(\n    identifier: GeneralServiceIdentifier<T>,\n    options?: ResolveOptions\n  ): T | null {\n    return this.getRaw(parseIdentifier(identifier), {\n      ...options,\n      optional: true,\n    });\n  }\n\n  abstract getRaw(\n    identifier: ServiceIdentifierValue,\n    options?: ResolveOptions\n  ): any;\n}\n\nexport class ServiceCachePool {\n  cache = new Map<string, Map<ServiceVariant, any>>();\n\n  getOrInsert(identifier: ServiceIdentifierValue, insert: () => any) {\n    const cache = this.cache.get(identifier.identifierName) ?? new Map();\n    if (!cache.has(identifier.variant)) {\n      cache.set(identifier.variant, insert());\n    }\n    const cached = cache.get(identifier.variant);\n    this.cache.set(identifier.identifierName, cache);\n    return cached;\n  }\n}\n\nexport class ServiceResolver extends ServiceProvider {\n  container = this.provider.container;\n\n  constructor(\n    readonly provider: BasicServiceProvider,\n    readonly depth = 0,\n    readonly stack: ServiceIdentifierValue[] = []\n  ) {\n    super();\n  }\n\n  getAllRaw(\n    identifier: ServiceIdentifierValue,\n    { sameScope = false }: ResolveOptions = {}\n  ): Map<ServiceVariant, any> {\n    const vars = this.provider.container.getFactoryAll(\n      identifier,\n      this.provider.scope\n    );\n\n    if (vars === undefined) {\n      if (this.provider.parent && !sameScope) {\n        return this.provider.parent.getAllRaw(identifier);\n      }\n\n      return new Map();\n    }\n\n    const result = new Map<ServiceVariant, any>();\n\n    for (const [variant, factory] of vars) {\n      const service = this.provider.cache.getOrInsert(\n        { identifierName: identifier.identifierName, variant },\n        () => {\n          const nextResolver = this.track(identifier);\n          try {\n            return factory(nextResolver);\n          } catch (err) {\n            if (err instanceof ServiceNotFoundError) {\n              throw new MissingDependencyError(\n                identifier,\n                err.identifier,\n                this.stack\n              );\n            }\n            throw err;\n          }\n        }\n      );\n      result.set(variant, service);\n    }\n\n    return result;\n  }\n\n  getRaw(\n    identifier: ServiceIdentifierValue,\n    { sameScope = false, optional = false }: ResolveOptions = {}\n  ) {\n    const factory = this.provider.container.getFactory(\n      identifier,\n      this.provider.scope\n    );\n    if (!factory) {\n      if (this.provider.parent && !sameScope) {\n        return this.provider.parent.getRaw(identifier, {\n          sameScope,\n          optional,\n        });\n      }\n\n      if (optional) {\n        return undefined;\n      }\n      throw new ServiceNotFoundError(identifier);\n    }\n\n    return this.provider.cache.getOrInsert(identifier, () => {\n      const nextResolver = this.track(identifier);\n      try {\n        return factory(nextResolver);\n      } catch (err) {\n        if (err instanceof ServiceNotFoundError) {\n          throw new MissingDependencyError(\n            identifier,\n            err.identifier,\n            this.stack\n          );\n        }\n        throw err;\n      }\n    });\n  }\n\n  track(identifier: ServiceIdentifierValue): ServiceResolver {\n    const depth = this.depth + 1;\n    if (depth >= 100) {\n      throw new RecursionLimitError();\n    }\n    const circular = this.stack.find(\n      i =>\n        i.identifierName === identifier.identifierName &&\n        i.variant === identifier.variant\n    );\n    if (circular) {\n      throw new CircularDependencyError([...this.stack, identifier]);\n    }\n\n    return new ServiceResolver(this.provider, depth, [\n      ...this.stack,\n      identifier,\n    ]);\n  }\n}\n\nexport class BasicServiceProvider extends ServiceProvider {\n  readonly cache = new ServiceCachePool();\n\n  readonly container: Container;\n\n  constructor(\n    container: Container,\n    readonly scope: string[],\n    readonly parent: ServiceProvider | null\n  ) {\n    super();\n    this.container = container.clone();\n    this.container.addValue(ServiceProvider, this, {\n      scope: scope,\n      override: true,\n    });\n  }\n\n  getAllRaw(\n    identifier: ServiceIdentifierValue,\n    options?: ResolveOptions\n  ): Map<ServiceVariant, any> {\n    const resolver = new ServiceResolver(this);\n    return resolver.getAllRaw(identifier, options);\n  }\n\n  getRaw(identifier: ServiceIdentifierValue, options?: ResolveOptions) {\n    const resolver = new ServiceResolver(this);\n    return resolver.getRaw(identifier, options);\n  }\n}\n","import { ROOT_SCOPE } from './consts.js';\nimport type { ServiceScope } from './types.js';\n\nexport function createScope(\n  name: string,\n  base: ServiceScope = ROOT_SCOPE\n): ServiceScope {\n  return [...base, name];\n}\n\nexport function stringifyScope(scope: ServiceScope): string {\n  return scope.join('/');\n}\n","import { DEFAULT_SERVICE_VARIANT, ROOT_SCOPE } from './consts.js';\nimport { DuplicateServiceDefinitionError } from './error.js';\nimport { parseIdentifier } from './identifier.js';\nimport type { ServiceProvider } from './provider.js';\nimport { BasicServiceProvider } from './provider.js';\nimport { stringifyScope } from './scope.js';\nimport type {\n  GeneralServiceIdentifier,\n  ServiceFactory,\n  ServiceIdentifier,\n  ServiceIdentifierType,\n  ServiceIdentifierValue,\n  ServiceScope,\n  ServiceVariant,\n  Type,\n  TypesToDeps,\n} from './types.js';\n\n/**\n * A container of services.\n *\n * Container basically is a tuple of `[scope, identifier, variant, factory]` with some helper methods.\n * It just stores the definitions of services. It never holds any instances of services.\n *\n * # Usage\n *\n * ```ts\n * const services = new Container();\n * class ServiceA {\n *   // ...\n * }\n * // add a service\n * services.add(ServiceA);\n *\n * class ServiceB {\n *   constructor(serviceA: ServiceA) {}\n * }\n * // add a service with dependency\n * services.add(ServiceB, [ServiceA]);\n *                         ^ dependency class/identifier, match ServiceB's constructor\n *\n * const FeatureA = createIdentifier<FeatureA>('Config');\n *\n * // add a implementation for a service identifier\n * services.addImpl(FeatureA, ServiceA);\n *\n * // override a service\n * services.override(ServiceA, NewServiceA);\n *\n * // create a service provider\n * const provider = services.provider();\n * ```\n *\n * # The data structure\n *\n * The data structure of Container is a three-layer nested Map, used to represent the tuple of\n * `[scope, identifier, variant, factory]`.\n * Such a data structure ensures that a service factory can be uniquely determined by `[scope, identifier, variant]`.\n *\n * When a service added:\n *\n * ```ts\n * services.add(ServiceClass)\n * ```\n *\n * The data structure will be:\n *\n * ```ts\n * Map {\n *  '': Map {                      // scope\n *   'ServiceClass': Map {         // identifier\n *     'default':                  // variant\n *        () => new ServiceClass() // factory\n *  }\n * }\n * ```\n *\n * # Dependency relationship\n *\n * The dependency relationships of services are not actually stored in the Container,\n * but are transformed into a factory function when the service is added.\n *\n * For example:\n *\n * ```ts\n * services.add(ServiceB, [ServiceA]);\n *\n * // is equivalent to\n * services.addFactory(ServiceB, (provider) => new ServiceB(provider.get(ServiceA)));\n * ```\n *\n * For multiple implementations of the same service identifier, can be defined as:\n *\n * ```ts\n * services.add(ServiceB, [[FeatureA]]);\n *\n * // is equivalent to\n * services.addFactory(ServiceB, (provider) => new ServiceB(provider.getAll(FeatureA)));\n * ```\n */\nexport class Container {\n  private readonly services = new Map<\n    string,\n    Map<string, Map<ServiceVariant, ServiceFactory>>\n  >();\n\n  /**\n   * @see {@link ContainerEditor.add}\n   */\n  get add() {\n    return new ContainerEditor(this).add;\n  }\n\n  /**\n   * @see {@link ContainerEditor.addImpl}\n   */\n  get addImpl() {\n    return new ContainerEditor(this).addImpl;\n  }\n\n  /**\n   * Create an empty service container.\n   *\n   * same as `new Container()`\n   */\n  static get EMPTY() {\n    return new Container();\n  }\n\n  /**\n   * @see {@link ContainerEditor.scope}\n   */\n  get override() {\n    return new ContainerEditor(this).override;\n  }\n\n  /**\n   * @see {@link ContainerEditor.scope}\n   */\n  get scope() {\n    return new ContainerEditor(this).scope;\n  }\n\n  /**\n   * The number of services in the container.\n   */\n  get size() {\n    let size = 0;\n    for (const [, identifiers] of this.services) {\n      for (const [, variants] of identifiers) {\n        size += variants.size;\n      }\n    }\n    return size;\n  }\n\n  /**\n   * @internal Use {@link addImpl} instead.\n   */\n  addFactory<T>(\n    identifier: GeneralServiceIdentifier<T>,\n    factory: ServiceFactory<T>,\n    { scope, override }: { scope?: ServiceScope; override?: boolean } = {}\n  ) {\n    // convert scope to string\n    const normalizedScope = stringifyScope(scope ?? ROOT_SCOPE);\n    const normalizedIdentifier = parseIdentifier(identifier);\n    const normalizedVariant =\n      normalizedIdentifier.variant ?? DEFAULT_SERVICE_VARIANT;\n\n    const services =\n      this.services.get(normalizedScope) ??\n      new Map<string, Map<ServiceVariant, ServiceFactory>>();\n\n    const variants =\n      services.get(normalizedIdentifier.identifierName) ??\n      new Map<ServiceVariant, ServiceFactory>();\n\n    // throw if service already exists, unless it is an override\n    if (variants.has(normalizedVariant) && !override) {\n      throw new DuplicateServiceDefinitionError(normalizedIdentifier);\n    }\n    variants.set(normalizedVariant, factory);\n    services.set(normalizedIdentifier.identifierName, variants);\n    this.services.set(normalizedScope, services);\n  }\n\n  /**\n   * @internal Use {@link addImpl} instead.\n   */\n  addValue<T>(\n    identifier: GeneralServiceIdentifier<T>,\n    value: T,\n    { scope, override }: { scope?: ServiceScope; override?: boolean } = {}\n  ) {\n    this.addFactory(\n      parseIdentifier(identifier) as ServiceIdentifier<T>,\n      () => value,\n      {\n        scope,\n        override,\n      }\n    );\n  }\n\n  /**\n   * Clone the entire service container.\n   *\n   * This method is quite cheap as it only clones the references.\n   *\n   * @returns A new service container with the same services.\n   */\n  clone(): Container {\n    const di = new Container();\n    for (const [scope, identifiers] of this.services) {\n      const s = new Map();\n      for (const [identifier, variants] of identifiers) {\n        s.set(identifier, new Map(variants));\n      }\n      di.services.set(scope, s);\n    }\n    return di;\n  }\n\n  /**\n   * @internal\n   */\n  getFactory(\n    identifier: ServiceIdentifierValue,\n    scope: ServiceScope = ROOT_SCOPE\n  ): ServiceFactory | undefined {\n    return this.services\n      .get(stringifyScope(scope))\n      ?.get(identifier.identifierName)\n      ?.get(identifier.variant ?? DEFAULT_SERVICE_VARIANT);\n  }\n\n  /**\n   * @internal\n   */\n  getFactoryAll(\n    identifier: ServiceIdentifierValue,\n    scope: ServiceScope = ROOT_SCOPE\n  ): Map<ServiceVariant, ServiceFactory> {\n    return new Map(\n      this.services.get(stringifyScope(scope))?.get(identifier.identifierName)\n    );\n  }\n\n  /**\n   * Create a service provider from the container.\n   *\n   * @example\n   * ```ts\n   * provider() // create a service provider for root scope\n   * provider(ScopeA, parentProvider) // create a service provider for scope A\n   * ```\n   *\n   * @param scope The scope of the service provider, default to the root scope.\n   * @param parent The parent service provider, it is required if the scope is not the root scope.\n   */\n  provider(\n    scope: ServiceScope = ROOT_SCOPE,\n    parent: ServiceProvider | null = null\n  ): ServiceProvider {\n    return new BasicServiceProvider(this, scope, parent);\n  }\n}\n\n/**\n * A helper class to edit a service container.\n */\nclass ContainerEditor {\n  private currentScope: ServiceScope = ROOT_SCOPE;\n\n  /**\n   * Add a service to the container.\n   *\n   * @see {@link Container}\n   *\n   * @example\n   * ```ts\n   * add(ServiceClass, [dependencies, ...])\n   * ```\n   */\n  add = <\n    T extends new (...args: any) => any,\n    const Deps extends TypesToDeps<ConstructorParameters<T>> = TypesToDeps<\n      ConstructorParameters<T>\n    >,\n  >(\n    cls: T,\n    ...[deps]: Deps extends [] ? [] : [Deps]\n  ): this => {\n    this.container.addFactory<any>(\n      cls as any,\n      dependenciesToFactory(cls, deps as any),\n      { scope: this.currentScope }\n    );\n\n    return this;\n  };\n\n  /**\n   * Add an implementation for identifier to the container.\n   *\n   * @see {@link Container}\n   *\n   * @example\n   * ```ts\n   * addImpl(ServiceIdentifier, ServiceClass, [dependencies, ...])\n   * or\n   * addImpl(ServiceIdentifier, Instance)\n   * or\n   * addImpl(ServiceIdentifier, Factory)\n   * ```\n   */\n  addImpl = <\n    Arg1 extends ServiceIdentifier<any>,\n    Arg2 extends Type<Trait> | ServiceFactory<Trait> | Trait,\n    Trait = ServiceIdentifierType<Arg1>,\n    Deps extends Arg2 extends Type<Trait>\n      ? TypesToDeps<ConstructorParameters<Arg2>>\n      : [] = Arg2 extends Type<Trait>\n      ? TypesToDeps<ConstructorParameters<Arg2>>\n      : [],\n    Arg3 extends Deps = Deps,\n  >(\n    identifier: Arg1,\n    arg2: Arg2,\n    ...[arg3]: Arg3 extends [] ? [] : [Arg3]\n  ): this => {\n    if (arg2 instanceof Function) {\n      this.container.addFactory<any>(\n        identifier,\n        dependenciesToFactory(arg2, arg3 as any[]),\n        { scope: this.currentScope }\n      );\n    } else {\n      this.container.addValue(identifier, arg2 as any, {\n        scope: this.currentScope,\n      });\n    }\n\n    return this;\n  };\n\n  /**\n   * same as {@link addImpl} but this method will override the service if it exists.\n   *\n   * @see {@link Container}\n   *\n   * @example\n   * ```ts\n   * override(OriginServiceClass, NewServiceClass, [dependencies, ...])\n   * or\n   * override(ServiceIdentifier, ServiceClass, [dependencies, ...])\n   * or\n   * override(ServiceIdentifier, Instance)\n   * or\n   * override(ServiceIdentifier, Factory)\n   * ```\n   */\n  override = <\n    Arg1 extends ServiceIdentifier<any>,\n    Arg2 extends Type<Trait> | ServiceFactory<Trait> | Trait,\n    Trait = ServiceIdentifierType<Arg1>,\n    Deps extends Arg2 extends Type<Trait>\n      ? TypesToDeps<ConstructorParameters<Arg2>>\n      : [] = Arg2 extends Type<Trait>\n      ? TypesToDeps<ConstructorParameters<Arg2>>\n      : [],\n    Arg3 extends Deps = Deps,\n  >(\n    identifier: Arg1,\n    arg2: Arg2,\n    ...[arg3]: Arg3 extends [] ? [] : [Arg3]\n  ): this => {\n    if (arg2 instanceof Function) {\n      this.container.addFactory<any>(\n        identifier,\n        dependenciesToFactory(arg2, arg3 as any[]),\n        { scope: this.currentScope, override: true }\n      );\n    } else {\n      this.container.addValue(identifier, arg2 as any, {\n        scope: this.currentScope,\n        override: true,\n      });\n    }\n\n    return this;\n  };\n\n  /**\n   * Set the scope for the service registered subsequently\n   *\n   * @example\n   *\n   * ```ts\n   * const ScopeA = createScope('a');\n   *\n   * services.scope(ScopeA).add(XXXService, ...);\n   * ```\n   */\n  scope = (scope: ServiceScope): ContainerEditor => {\n    this.currentScope = scope;\n    return this;\n  };\n\n  constructor(private readonly container: Container) {}\n}\n\n/**\n * Convert dependencies definition to a factory function.\n */\nfunction dependenciesToFactory(\n  cls: any,\n  deps: any[] = []\n): ServiceFactory<any> {\n  return (provider: ServiceProvider) => {\n    const args = [];\n    for (const dep of deps) {\n      let isAll;\n      let identifier;\n      if (Array.isArray(dep)) {\n        if (dep.length !== 1) {\n          throw new Error('Invalid dependency');\n        }\n        isAll = true;\n        identifier = dep[0];\n      } else {\n        isAll = false;\n        identifier = dep;\n      }\n      if (isAll) {\n        args.push(Array.from(provider.getAll(identifier).values()));\n      } else {\n        args.push(provider.get(identifier));\n      }\n    }\n    if (isConstructor(cls)) {\n      return new cls(...args, provider);\n    } else {\n      return cls(...args, provider);\n    }\n  };\n}\n\n// a hack to check if a function is a constructor\n// https://github.com/zloirock/core-js/blob/232c8462c26c75864b4397b7f643a4f57c6981d5/packages/core-js/internals/is-constructor.js#L15\nfunction isConstructor(cls: unknown) {\n  try {\n    Reflect.construct(function () {}, [], cls as never);\n    return true;\n  } catch {\n    return false;\n  }\n}\n","import { createIdentifier } from '@blocksuite/global/di';\n\nimport type { Store } from './store';\n\nexport const StoreIdentifier = createIdentifier<Store>('Store');\n","import isMatch from 'lodash.ismatch';\n\nimport type { Block, BlockModel, BlockViewType } from '../block/index.js';\n\nexport type QueryMatch = {\n  id?: string;\n  flavour?: string;\n  props?: Record<string, unknown>;\n  viewType: BlockViewType;\n};\n\n/**\n * - `strict` means that only blocks that match the query will be included.\n * - `loose` means that all blocks will be included first, and then the blocks will be run through the query.\n * - `include` means that only blocks and their ancestors that match the query will be included.\n */\ntype QueryMode = 'strict' | 'loose' | 'include';\n\nexport type Query = {\n  match: QueryMatch[];\n  mode: QueryMode;\n};\n\nexport function runQuery(query: Query, block: Block) {\n  const blockViewType = getBlockViewType(query, block);\n  block.blockViewType = blockViewType;\n\n  if (blockViewType !== 'hidden') {\n    const queryMode = query.mode;\n    setAncestorsToDisplayIfHidden(queryMode, block);\n  }\n}\n\nfunction getBlockViewType(query: Query, block: Block): BlockViewType {\n  const flavour = block.model.flavour;\n  const id = block.model.id;\n  const queryMode = query.mode;\n  const props = block.model.keys.reduce(\n    (acc, key) => {\n      return {\n        ...acc,\n        [key]: block.model.props[key as keyof BlockModel['props']],\n      };\n    },\n    {} as Record<string, unknown>\n  );\n  let blockViewType: BlockViewType =\n    queryMode === 'loose' ? 'display' : 'hidden';\n\n  query.match.some(queryObject => {\n    const {\n      id: queryId,\n      flavour: queryFlavour,\n      props: queryProps,\n      viewType,\n    } = queryObject;\n    const matchQueryId = queryId == null ? true : queryId === id;\n    const matchQueryFlavour =\n      queryFlavour == null ? true : queryFlavour === flavour;\n    const matchQueryProps =\n      queryProps == null ? true : isMatch(props, queryProps);\n    if (matchQueryId && matchQueryFlavour && matchQueryProps) {\n      blockViewType = viewType;\n      return true;\n    }\n    return false;\n  });\n\n  return blockViewType;\n}\n\nfunction setAncestorsToDisplayIfHidden(mode: QueryMode, block: Block) {\n  const doc = block.model.store;\n  let parent = doc.getParent(block.model);\n  while (parent) {\n    const parentBlock = doc.getBlock(parent.id);\n    if (parentBlock && parentBlock.blockViewType === 'hidden') {\n      parentBlock.blockViewType = mode === 'include' ? 'display' : 'bypass';\n    }\n    parent = doc.getParent(parent);\n  }\n}\n","import { Subject, Subscription } from 'rxjs';\n\ntype DisposeCallback = () => void;\n\nexport interface Disposable {\n  dispose: DisposeCallback;\n}\n\nexport type DisposableMember =\n  | Disposable\n  | Subscription\n  | Subject<any>\n  | DisposeCallback;\n\nexport class DisposableGroup {\n  private _disposables: DisposableMember[] = [];\n\n  private _disposed = false;\n\n  get disposed() {\n    return this._disposed;\n  }\n\n  /**\n   * Add to group to be disposed with others.\n   * This will be immediately disposed if this group has already been disposed.\n   */\n  add(d: DisposableMember) {\n    if (this._disposed) {\n      disposeMember(d);\n      return;\n    }\n    this._disposables.push(d);\n  }\n\n  addFromEvent<N extends keyof WindowEventMap>(\n    element: Window,\n    eventName: N,\n    handler: (e: WindowEventMap[N]) => void,\n    options?: boolean | AddEventListenerOptions\n  ): void;\n  addFromEvent<N extends keyof DocumentEventMap>(\n    element: Document,\n    eventName: N,\n    handler: (e: DocumentEventMap[N]) => void,\n    eventOptions?: boolean | AddEventListenerOptions\n  ): void;\n  addFromEvent<N extends keyof HTMLElementEventMap>(\n    element: HTMLElement,\n    eventName: N,\n    handler: (e: HTMLElementEventMap[N]) => void,\n    eventOptions?: boolean | AddEventListenerOptions\n  ): void;\n  addFromEvent<N extends keyof VisualViewportEventMap>(\n    element: VisualViewport,\n    eventName: N,\n    handler: (e: VisualViewportEventMap[N]) => void,\n    eventOptions?: boolean | AddEventListenerOptions\n  ): void;\n  addFromEvent<N extends keyof VirtualKeyboardEventMap>(\n    element: VirtualKeyboard,\n    eventName: N,\n    handler: (e: VirtualKeyboardEventMap[N]) => void,\n    eventOptions?: boolean | AddEventListenerOptions\n  ): void;\n\n  addFromEvent(\n    target: HTMLElement | Window | Document | VisualViewport | VirtualKeyboard,\n    type: string,\n    handler: (e: Event) => void,\n    eventOptions?: boolean | AddEventListenerOptions\n  ) {\n    this.add({\n      dispose: () => {\n        target.removeEventListener(type, handler as () => void, eventOptions);\n      },\n    });\n    target.addEventListener(type, handler as () => void, eventOptions);\n  }\n\n  dispose() {\n    disposeAll(this._disposables);\n    this._disposables = [];\n    this._disposed = true;\n  }\n}\n\nexport function disposeMember(disposable: DisposableMember) {\n  try {\n    if (disposable instanceof Subscription) {\n      disposable.unsubscribe();\n    } else if (disposable instanceof Subject) {\n      disposable.complete();\n    } else if (typeof disposable === 'function') {\n      disposable();\n    } else {\n      disposable.dispose();\n    }\n  } catch (e) {\n    console.error(e);\n  }\n}\n\nfunction disposeAll(disposables: DisposableMember[]) {\n  disposables.forEach(disposeMember);\n}\n","import type { Container } from '@blocksuite/global/di';\n\n/**\n * # Understanding Extensions\n *\n * Extensions provide a way to extend the functionality of a system using dependency injection.\n * They allow you to register services, implementations, and factories in the DI container,\n * which can then be retrieved and used by different parts of the application.\n *\n * Extensions are particularly useful for:\n * - Registering different implementations for different types\n * - Creating pluggable architecture where components can be added or removed\n * - Managing dependencies between different parts of the application\n *\n * # Usage Example: Fruit Processing System\n *\n * Let's consider a fruit processing system where different types of fruits need\n * different processing methods. We'll show how to implement this using extensions.\n *\n * ## Step 1: Define the interfaces\n *\n * ```ts\n * interface FruitProcessor {\n *   process(fruit: Fruit): void;\n * }\n *\n * interface Fruit {\n *   type: string;\n *   // other properties\n * }\n * ```\n *\n * ## Step 2: Create a service identifier\n *\n * ```ts\n * import { createIdentifier } from '@blocksuite/global/di';\n *\n * const FruitProcessorProvider = createIdentifier<FruitProcessor>('fruit-processor-provider');\n * ```\n *\n * ## Step 3: Create implementations\n *\n * ```ts\n * class AppleProcessor implements FruitProcessor {\n *   process(fruit: Fruit): void {\n *     console.log('Slicing apple');\n *     // Apple-specific processing\n *   }\n * }\n *\n * class BananaProcessor implements FruitProcessor {\n *   process(fruit: Fruit): void {\n *     console.log('Peeling banana');\n *     // Banana-specific processing\n *   }\n * }\n * ```\n *\n * ## Step 4: Create an extension factory\n *\n * ```ts\n * const FruitProcessorExtension = (\n *   fruitType: string,\n *   implementation: new () => FruitProcessor\n * ): ExtensionType => {\n *   return {\n *     setup: di => {\n *       di.addImpl(FruitProcessorProvider(fruitType), implementation);\n *     }\n *   };\n * };\n * ```\n *\n * ## Step 5: Create concrete extensions\n *\n * ```ts\n * export const AppleProcessorExtension = FruitProcessorExtension('apple', AppleProcessor);\n * export const BananaProcessorExtension = FruitProcessorExtension('banana', BananaProcessor);\n * ```\n *\n * ## Step 6: Use the extensions\n *\n * ```ts\n * import { Container } from '@blocksuite/global/di';\n *\n * class FruitProcessingSystem {\n *   provider: ServiceProvider;\n *\n *   constructor(extensions: ExtensionType[]) {\n *     const container = new Container();\n *\n *     // Set up all extensions\n *     extensions.forEach(ext => ext.setup(container));\n *\n *     // Create a provider from the container\n *     this.provider = container.provider();\n *   }\n *\n *   processFruit(fruit: Fruit) {\n *     // Get the appropriate processor based on fruit type\n *     const processor = this.provider.get(FruitProcessorProvider(fruit.type));\n *\n *     // Process the fruit\n *     processor.process(fruit);\n *   }\n * }\n *\n * // Initialize the system with extensions\n * const system = new FruitProcessingSystem([\n *   AppleProcessorExtension,\n *   BananaProcessorExtension\n * ]);\n *\n * // Use the system\n * system.processFruit({ type: 'apple' });  // Output: Slicing apple\n * system.processFruit({ type: 'banana' }); // Output: Peeling banana\n * ```\n *\n * Note: We deliberately used a non-block specific example here. In BlockSuite, the extension\n * pattern can be applied to any entity that can be configured by third parties, not just blocks.\n * This includes different tools in the whiteboard, different column types in database blocks,\n * and many other extensible components. The pattern remains the same regardless of what you're extending.\n *\n * @category Extension\n */\nexport abstract class Extension {\n  static setup(_di: Container): void {\n    // do nothing\n  }\n}\n\nexport interface ExtensionType {\n  setup(di: Container): void;\n}\n","import { type Container, createIdentifier } from '@blocksuite/global/di';\nimport { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\n\nimport type { Store } from '../model/store';\nimport { StoreIdentifier } from '../model/store/identifier';\nimport { Extension } from './extension';\n\nexport const StoreExtensionIdentifier =\n  createIdentifier<StoreExtension>('StoreExtension');\n\nexport const storeExtensionSymbol = Symbol('StoreExtension');\n\n/**\n * Store extensions are used to extend the store.\n * They should be registered to the store. And they should be able to run in a none-dom environment.\n *\n * @category Extension\n */\nexport class StoreExtension extends Extension {\n  /**\n   * The key of the store extension.\n   * **You must override this property with a unique string.**\n   */\n  static readonly key: string;\n\n  constructor(readonly store: Store) {\n    super();\n  }\n\n  /**\n   * Lifecycle hook when the yjs document is loaded.\n   */\n  loaded() {}\n\n  /**\n   * Lifecycle hook when the yjs document is disposed.\n   */\n  disposed() {}\n\n  static readonly [storeExtensionSymbol] = true;\n\n  static override setup(di: Container) {\n    if (!this.key) {\n      throw new BlockSuiteError(\n        ErrorCode.ValueNotExists,\n        'Key is not defined in the StoreExtension'\n      );\n    }\n\n    di.add(this, [StoreIdentifier]);\n    di.addImpl(StoreExtensionIdentifier(this.key), provider =>\n      provider.get(this)\n    );\n  }\n}\n\nexport function isStoreExtensionConstructor(\n  extension: object\n): extension is typeof StoreExtension {\n  return storeExtensionSymbol in extension;\n}\n","import { signal } from '@preact/signals-core';\nimport { Subject } from 'rxjs';\nimport * as Y from 'yjs';\n\nimport type { Store } from '../../model';\nimport { StoreExtension } from '../store-extension';\n\nexport class HistoryExtension extends StoreExtension {\n  static override readonly key = 'history';\n\n  private readonly _history!: Y.UndoManager;\n\n  private readonly _canRedo = signal(false);\n\n  private readonly _canUndo = signal(false);\n\n  readonly onUpdated = new Subject<void>();\n\n  constructor(store: Store) {\n    super(store);\n\n    this._history = new Y.UndoManager([this.store.doc.yBlocks], {\n      trackedOrigins: new Set([this.store.doc.spaceDoc.clientID]),\n    });\n  }\n\n  private readonly _updateCanUndoRedoSignals = () => {\n    const canRedo = this._history.canRedo();\n    const canUndo = this._history.canUndo();\n    if (this._canRedo.peek() !== canRedo) {\n      this._canRedo.value = canRedo;\n    }\n    if (this._canUndo.peek() !== canUndo) {\n      this._canUndo.value = canUndo;\n    }\n  };\n\n  get canRedo() {\n    return this._canRedo.peek();\n  }\n\n  get canUndo() {\n    return this._canUndo.peek();\n  }\n\n  get canRedo$() {\n    return this._canRedo;\n  }\n\n  get canUndo$() {\n    return this._canUndo;\n  }\n\n  get undoManager() {\n    return this._history;\n  }\n\n  override loaded() {\n    this._updateCanUndoRedoSignals();\n    this._history.on('stack-cleared', this._historyObserver);\n    this._history.on('stack-item-added', this._historyObserver);\n    this._history.on('stack-item-popped', this._historyObserver);\n    this._history.on('stack-item-updated', this._historyObserver);\n  }\n\n  private readonly _historyObserver = () => {\n    this._updateCanUndoRedoSignals();\n    this.onUpdated.next();\n  };\n\n  override disposed() {\n    super.disposed();\n    this._history.off('stack-cleared', this._historyObserver);\n    this._history.off('stack-item-added', this._historyObserver);\n    this._history.off('stack-item-popped', this._historyObserver);\n    this._history.off('stack-item-updated', this._historyObserver);\n    this.onUpdated.complete();\n  }\n}\n","import { createIdentifier } from '@blocksuite/global/di';\n\nimport type { BlockSchemaType } from '../model/block/zod';\nimport type { ExtensionType } from './extension';\n\nexport const BlockSchemaIdentifier =\n  createIdentifier<BlockSchemaType>('BlockSchema');\n\nexport function BlockSchemaExtension(\n  blockSchema: BlockSchemaType\n): ExtensionType {\n  return {\n    setup: di => {\n      di.addImpl(\n        BlockSchemaIdentifier(blockSchema.model.flavour),\n        () => blockSchema\n      );\n    },\n  };\n}\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\n\nimport type { SelectionConstructor } from './types';\n\nexport type BaseSelectionOptions = {\n  blockId: string;\n};\n\nexport abstract class BaseSelection {\n  static readonly group: string;\n\n  static readonly type: string;\n\n  static readonly recoverable: boolean = false;\n\n  readonly blockId: string;\n\n  get group(): string {\n    return (this.constructor as SelectionConstructor).group;\n  }\n\n  get type(): string {\n    return (this.constructor as SelectionConstructor).type as string;\n  }\n\n  constructor({ blockId }: BaseSelectionOptions) {\n    this.blockId = blockId;\n  }\n\n  static fromJSON(_: Record<string, unknown>): BaseSelection {\n    throw new BlockSuiteError(\n      ErrorCode.SelectionError,\n      'You must override this method'\n    );\n  }\n\n  abstract equals(other: BaseSelection): boolean;\n\n  is<T extends SelectionConstructor>(\n    type: T\n  ): this is T extends SelectionConstructor<infer U> ? U : never {\n    return this.type === type.type;\n  }\n\n  abstract toJSON(): Record<string, unknown>;\n}\n","import { createIdentifier } from '@blocksuite/global/di';\n\nimport type { ExtensionType } from '../extension';\nimport type { SelectionConstructor } from './types';\n\nexport const SelectionIdentifier =\n  createIdentifier<SelectionConstructor>('Selection');\n\nexport function SelectionExtension(\n  selectionCtor: SelectionConstructor\n): ExtensionType {\n  return {\n    setup: di => {\n      di.addImpl(SelectionIdentifier(selectionCtor.type), () => selectionCtor);\n    },\n  };\n}\n","import { uuidv4 as uuidv4IdGenerator } from 'lib0/random.js';\nimport { nanoid as nanoidGenerator } from 'nanoid';\n\nexport type IdGenerator = () => string;\n\nexport const uuidv4: IdGenerator = () => {\n  return uuidv4IdGenerator();\n};\n\nexport const nanoid: IdGenerator = () => {\n  return nanoidGenerator(10);\n};\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { computed, signal } from '@preact/signals-core';\nimport { Subject } from 'rxjs';\n\nimport { nanoid } from '../../utils/id-generator';\nimport type { StackItem } from '../../yjs';\nimport { StoreExtension } from '../store-extension';\nimport type { BaseSelection } from './base';\nimport { SelectionIdentifier } from './identifier';\nimport type { SelectionConstructor } from './types';\n\nexport class StoreSelectionExtension extends StoreExtension {\n  static override readonly key = 'selection';\n\n  private readonly _id = `${this.store.id}:${nanoid()}`;\n  private _selectionConstructors: Record<string, SelectionConstructor> = {};\n  private readonly _selections = signal<BaseSelection[]>([]);\n  private readonly _remoteSelections = signal<Map<number, BaseSelection[]>>(\n    new Map()\n  );\n\n  private readonly _itemAdded = (event: { stackItem: StackItem }) => {\n    event.stackItem.meta.set('selection-state', this._selections.value);\n  };\n\n  private readonly _itemPopped = (event: { stackItem: StackItem }) => {\n    const selection = event.stackItem.meta.get('selection-state');\n    if (selection) {\n      this.set(selection as BaseSelection[]);\n    }\n  };\n\n  private readonly _jsonToSelection = (json: Record<string, unknown>) => {\n    const ctor = this._selectionConstructors[json.type as string];\n    if (!ctor) {\n      throw new BlockSuiteError(\n        ErrorCode.SelectionError,\n        `Unknown selection type: ${json.type}`\n      );\n    }\n    return ctor.fromJSON(json);\n  };\n\n  slots = {\n    changed: new Subject<BaseSelection[]>(),\n    remoteChanged: new Subject<Map<number, BaseSelection[]>>(),\n  };\n\n  override loaded() {\n    this.store.provider.getAll(SelectionIdentifier).forEach(ctor => {\n      [ctor].flat().forEach(ctor => {\n        this._selectionConstructors[ctor.type] = ctor;\n      });\n    });\n\n    this.store.awarenessStore.awareness.on(\n      'change',\n      (change: { updated: number[]; added: number[]; removed: number[] }) => {\n        const all = change.updated.concat(change.added).concat(change.removed);\n        const localClientID = this.store.awarenessStore.awareness.clientID;\n        const exceptLocal = all.filter(id => id !== localClientID);\n\n        // Only consider remote selections from other clients\n        if (exceptLocal.length > 0) {\n          const map = new Map<number, BaseSelection[]>();\n          this.store.awarenessStore.getStates().forEach((state, id) => {\n            if (id === this.store.awarenessStore.awareness.clientID) return;\n            // selection id starts with the same block collection id from others clients would be considered as remote selections\n            const selection = Object.entries(state.selectionV2)\n              .filter(([key]) => key.startsWith(this.store.id))\n              .flatMap(([_, selection]) => selection);\n\n            const selections = selection\n              .map(json => {\n                try {\n                  return this._jsonToSelection(json);\n                } catch (error) {\n                  console.error(\n                    'Parse remote selection failed:',\n                    id,\n                    json,\n                    error\n                  );\n                  return null;\n                }\n              })\n              .filter((sel): sel is BaseSelection => !!sel);\n\n            map.set(id, selections);\n          });\n          this._remoteSelections.value = map;\n          this.slots.remoteChanged.next(map);\n        }\n      }\n    );\n\n    this.store.history.undoManager.on('stack-item-added', this._itemAdded);\n    this.store.history.undoManager.on('stack-item-popped', this._itemPopped);\n  }\n\n  override disposed() {\n    super.disposed();\n    this.store.history.undoManager.off('stack-item-added', this._itemAdded);\n    this.store.history.undoManager.off('stack-item-popped', this._itemPopped);\n  }\n\n  get value() {\n    return this._selections.value;\n  }\n\n  get remoteSelections() {\n    return this._remoteSelections.value;\n  }\n\n  clear(types?: string[]) {\n    if (types) {\n      const values = this.value.filter(\n        selection => !types.includes(selection.type)\n      );\n      this.set(values);\n    } else {\n      this.set([]);\n    }\n  }\n\n  create<T extends SelectionConstructor>(\n    Type: T,\n    ...args: ConstructorParameters<T>\n  ): InstanceType<T> {\n    return new Type(...args) as InstanceType<T>;\n  }\n\n  getGroup(group: string) {\n    return this.value.filter(s => s.group === group);\n  }\n\n  filter<T extends SelectionConstructor>(type: T) {\n    return this.filter$(type).value;\n  }\n\n  filter$<T extends SelectionConstructor>(type: T) {\n    return computed(() =>\n      this.value.filter((sel): sel is InstanceType<T> => sel.is(type))\n    );\n  }\n\n  find<T extends SelectionConstructor>(type: T) {\n    return this.find$(type).value;\n  }\n\n  find$<T extends SelectionConstructor>(type: T) {\n    return computed(() =>\n      this.value.find((sel): sel is InstanceType<T> => sel.is(type))\n    );\n  }\n\n  set(selections: BaseSelection[]) {\n    this.store.awarenessStore.setLocalSelection(\n      this._id,\n      selections.map(s => s.toJSON())\n    );\n    this._selections.value = selections;\n    this.slots.changed.next(selections);\n  }\n\n  setGroup(group: string, selections: BaseSelection[]) {\n    const current = this.value.filter(s => s.group !== group);\n    this.set([...current, ...selections]);\n  }\n\n  // This method is used to clear **current editor's remote selections**\n  // When the editor is not active, the remote selections should be cleared\n  // So other editors won't see the remote selections from this editor\n  clearRemote() {\n    this.store.awarenessStore.setLocalSelection(this._id, []);\n  }\n\n  update(fn: (currentSelections: BaseSelection[]) => BaseSelection[]) {\n    const selections = fn(this.value);\n    this.set(selections);\n  }\n\n  fromJSON(json: Record<string, unknown>[]) {\n    const selections = json.map(json => {\n      return this._jsonToSelection(json);\n    });\n    return this.set(selections);\n  }\n}\n","import { createIdentifier } from '@blocksuite/global/di';\nimport type * as Y from 'yjs';\n\nimport type { Store, StoreOptions, YBlock } from '../../model';\nimport type { AwarenessStore } from '../../yjs';\nimport type { Workspace } from './workspace.js';\nimport type { DocMeta } from './workspace-meta.js';\n\nexport type GetStoreOptions = Omit<StoreOptions, 'schema' | 'doc'>;\nexport type RemoveStoreOptions = Pick<\n  StoreOptions,\n  'query' | 'id' | 'readonly'\n>;\n\nexport interface Doc {\n  readonly id: string;\n  get meta(): DocMeta | undefined;\n\n  remove(): void;\n  load(initFn?: () => void): void;\n  get ready(): boolean;\n  dispose(): void;\n\n  clear(): void;\n  getStore(options?: GetStoreOptions): Store;\n  removeStore(options: RemoveStoreOptions): void;\n\n  get loaded(): boolean;\n  get awarenessStore(): AwarenessStore;\n\n  get workspace(): Workspace;\n\n  get rootDoc(): Y.Doc;\n  get spaceDoc(): Y.Doc;\n  get yBlocks(): Y.Map<YBlock>;\n}\n\nexport const DocIdentifier = createIdentifier<Doc>('store-doc');\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\n\nexport class SchemaValidateError extends BlockSuiteError {\n  constructor(flavour: string, message: string) {\n    super(\n      ErrorCode.SchemaValidateError,\n      `Invalid schema for ${flavour}: ${message}`\n    );\n  }\n}\n","import { minimatch } from 'minimatch';\n\nimport { SCHEMA_NOT_FOUND_MESSAGE } from '../consts.js';\nimport { BlockSchema, type BlockSchemaType } from '../model/index.js';\nimport { SchemaValidateError } from './error.js';\n\n/**\n * Represents a schema manager for block flavours and their relationships.\n * Provides methods to register, validate, and query block schemas.\n */\nexport class Schema {\n  /**\n   * A map storing block flavour names to their corresponding schema definitions.\n   */\n  readonly flavourSchemaMap = new Map<string, BlockSchemaType>();\n\n  /**\n   * Safely validates the schema relationship for a given flavour, parent, and children.\n   * Returns true if valid, false otherwise (does not throw).\n   *\n   * @param flavour - The block flavour to validate.\n   * @param parentFlavour - The parent block flavour (optional).\n   * @param childFlavours - The child block flavours (optional).\n   * @returns True if the schema relationship is valid, false otherwise.\n   */\n  safeValidate = (\n    flavour: string,\n    parentFlavour?: string,\n    childFlavours?: string[]\n  ): boolean => {\n    try {\n      this.validate(flavour, parentFlavour, childFlavours);\n      return true;\n    } catch {\n      return false;\n    }\n  };\n\n  /**\n   * Retrieves the schema for a given block flavour.\n   *\n   * @param flavour - The block flavour name.\n   * @returns The corresponding BlockSchemaType or undefined if not found.\n   */\n  get(flavour: string) {\n    return this.flavourSchemaMap.get(flavour);\n  }\n\n  /**\n   * Validates the schema relationship for a given flavour, parent, and children.\n   * Throws SchemaValidateError if invalid.\n   *\n   * @param flavour - The block flavour to validate.\n   * @param parentFlavour - The parent block flavour (optional).\n   * @param childFlavours - The child block flavours (optional).\n   * @throws {SchemaValidateError} If the schema relationship is invalid.\n   */\n  validate = (\n    flavour: string,\n    parentFlavour?: string,\n    childFlavours?: string[]\n  ): void => {\n    const schema = this.flavourSchemaMap.get(flavour);\n    if (!schema) {\n      throw new SchemaValidateError(flavour, SCHEMA_NOT_FOUND_MESSAGE);\n    }\n\n    const validateChildren = () => {\n      childFlavours?.forEach(childFlavour => {\n        const childSchema = this.flavourSchemaMap.get(childFlavour);\n        if (!childSchema) {\n          throw new SchemaValidateError(childFlavour, SCHEMA_NOT_FOUND_MESSAGE);\n        }\n        this.validateSchema(childSchema, schema);\n      });\n    };\n\n    if (schema.model.role === 'root') {\n      if (parentFlavour) {\n        throw new SchemaValidateError(\n          schema.model.flavour,\n          'Root block cannot have parent.'\n        );\n      }\n\n      validateChildren();\n      return;\n    }\n\n    if (!parentFlavour) {\n      throw new SchemaValidateError(\n        schema.model.flavour,\n        'None root block must have parent.'\n      );\n    }\n\n    const parentSchema = this.flavourSchemaMap.get(parentFlavour);\n    if (!parentSchema) {\n      throw new SchemaValidateError(parentFlavour, SCHEMA_NOT_FOUND_MESSAGE);\n    }\n    this.validateSchema(schema, parentSchema);\n    validateChildren();\n  };\n\n  /**\n   * Returns an object mapping each registered flavour to its version number.\n   */\n  get versions() {\n    return Object.fromEntries(\n      Array.from(this.flavourSchemaMap.values()).map(\n        (schema): [string, number] => [schema.model.flavour, schema.version]\n      )\n    );\n  }\n\n  /**\n   * Checks if two flavours match, using minimatch for wildcard support.\n   *\n   * @param childFlavour - The child block flavour.\n   * @param parentFlavour - The parent block flavour.\n   * @returns True if the flavours match, false otherwise.\n   */\n  private _matchFlavour(childFlavour: string, parentFlavour: string) {\n    return (\n      minimatch(childFlavour, parentFlavour) ||\n      minimatch(parentFlavour, childFlavour)\n    );\n  }\n\n  /**\n   * Checks if two values match as either flavours or roles, supporting role syntax (e.g., '@role').\n   *\n   * @param childValue - The child value (flavour or role).\n   * @param parentValue - The parent value (flavour or role).\n   * @param childRole - The actual role of the child.\n   * @param parentRole - The actual role of the parent.\n   * @returns True if the values match as flavours or roles, false otherwise.\n   */\n  private _matchFlavourOrRole(\n    childValue: string,\n    parentValue: string,\n    childRole: string,\n    parentRole: string\n  ): boolean {\n    // Check if either value starts with '@' indicating it's a role\n    const isChildRole = childValue.startsWith('@');\n    const isParentRole = parentValue.startsWith('@');\n\n    // If both are roles, do exact match\n    if (isChildRole && isParentRole) {\n      return childValue === parentValue;\n    }\n    // If child is role, compare with parent's actual role\n    if (isChildRole) {\n      return childValue === `@${parentRole}`;\n    }\n    // If parent is role, compare with child's actual role\n    if (isParentRole) {\n      return parentValue === `@${childRole}`;\n    }\n    // If neither is role, use flavour matching\n    return this._matchFlavour(childValue, parentValue);\n  }\n\n  /**\n   * Validates if the parent schema is a valid parent for the child schema.\n   *\n   * @param child - The child block schema.\n   * @param parent - The parent block schema.\n   * @returns True if the parent is valid for the child, false otherwise.\n   */\n  private _validateParent(\n    child: BlockSchemaType,\n    parent: BlockSchemaType\n  ): boolean {\n    const _childFlavour = child.model.flavour;\n    const _parentFlavour = parent.model.flavour;\n    const _childRole = child.model.role;\n    const _parentRole = parent.model.role;\n\n    const childValidFlavourOrRole = child.model.parent || ['*'];\n    const parentValidFlavourOrRole = parent.model.children || ['*'];\n\n    return parentValidFlavourOrRole.some(parentValidFlavourOrRole => {\n      return childValidFlavourOrRole.some(childValidFlavourOrRole => {\n        if (\n          parentValidFlavourOrRole === '*' &&\n          childValidFlavourOrRole === '*'\n        ) {\n          return true;\n        }\n\n        if (parentValidFlavourOrRole === '*') {\n          return this._matchFlavourOrRole(\n            childValidFlavourOrRole,\n            _parentFlavour,\n            _childRole,\n            _parentRole\n          );\n        }\n\n        if (childValidFlavourOrRole === '*') {\n          return this._matchFlavourOrRole(\n            _childFlavour,\n            parentValidFlavourOrRole,\n            _childRole,\n            _parentRole\n          );\n        }\n\n        return (\n          this._matchFlavourOrRole(\n            _childFlavour,\n            parentValidFlavourOrRole,\n            _childRole,\n            _parentRole\n          ) &&\n          this._matchFlavourOrRole(\n            childValidFlavourOrRole,\n            _parentFlavour,\n            _childRole,\n            _parentRole\n          )\n        );\n      });\n    });\n  }\n\n  /**\n   * Validates the role relationship between child and parent schemas.\n   * Throws if the child is a root block but has a parent.\n   *\n   * @param child - The child block schema.\n   * @param parent - The parent block schema.\n   * @throws {SchemaValidateError} If the child is a root block with a parent.\n   */\n  private _validateRole(child: BlockSchemaType, parent: BlockSchemaType) {\n    const childRole = child.model.role;\n    const childFlavour = child.model.flavour;\n    const parentFlavour = parent.model.flavour;\n\n    if (childRole === 'root') {\n      throw new SchemaValidateError(\n        childFlavour,\n        `Root block cannot have parent: ${parentFlavour}.`\n      );\n    }\n  }\n\n  /**\n   * Checks if the child flavour is valid under the parent flavour.\n   *\n   * @param child - The child block flavour name.\n   * @param parent - The parent block flavour name.\n   * @returns True if the relationship is valid, false otherwise.\n   */\n  isValid(child: string, parent: string) {\n    const childSchema = this.flavourSchemaMap.get(child);\n    const parentSchema = this.flavourSchemaMap.get(parent);\n    if (!childSchema || !parentSchema) {\n      return false;\n    }\n    try {\n      this.validateSchema(childSchema, parentSchema);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Registers an array of block schemas into the schema manager.\n   *\n   * @param blockSchema - An array of block schema definitions to register.\n   * @returns The Schema instance (for chaining).\n   */\n  register(blockSchema: BlockSchemaType[]) {\n    blockSchema.forEach(schema => {\n      BlockSchema.parse(schema);\n      this.flavourSchemaMap.set(schema.model.flavour, schema);\n    });\n    return this;\n  }\n\n  /**\n   * Serializes the schema map to a plain object for JSON output.\n   *\n   * @returns An object mapping each flavour to its role, parent, and children.\n   */\n  toJSON() {\n    return Object.fromEntries(\n      Array.from(this.flavourSchemaMap.values()).map(\n        (schema): [string, Record<string, unknown>] => [\n          schema.model.flavour,\n          {\n            role: schema.model.role,\n            parent: schema.model.parent,\n            children: schema.model.children,\n          },\n        ]\n      )\n    );\n  }\n\n  /**\n   * Validates the relationship between a child and parent schema.\n   * Throws if the relationship is invalid.\n   *\n   * @param child - The child block schema.\n   * @param parent - The parent block schema.\n   * @throws {SchemaValidateError} If the relationship is invalid.\n   */\n  validateSchema(child: BlockSchemaType, parent: BlockSchemaType) {\n    this._validateRole(child, parent);\n\n    const relationCheckSuccess = this._validateParent(child, parent);\n\n    if (!relationCheckSuccess) {\n      throw new SchemaValidateError(\n        child.model.flavour,\n        `Block cannot have parent: ${parent.model.flavour}.`\n      );\n    }\n  }\n}\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\n\nimport type { BlockProps } from '../model';\nimport type { BlobCRUD } from './type';\n\ntype AssetsManagerConfig = {\n  blob: BlobCRUD;\n};\n\nfunction makeNewNameWhenConflict(names: Set<string>, name: string) {\n  let i = 1;\n  const ext = name.split('.').at(-1) ?? '';\n  let newName = name.replace(new RegExp(`.${ext}$`), ` (${i}).${ext}`);\n  while (names.has(newName)) {\n    newName = name.replace(new RegExp(`.${ext}$`), ` (${i}).${ext}`);\n    i++;\n  }\n  return newName;\n}\n\nexport class AssetsManager {\n  // `blockId` is the key.\n  readonly uploadingAssetsMap = new Map<\n    string,\n    {\n      blob: Blob;\n      abortController?: AbortController;\n      mapInto: (blobId: string) => Partial<BlockProps>;\n    }\n  >();\n\n  private readonly _assetsMap = new Map<string, Blob>();\n\n  private readonly _blob: BlobCRUD;\n\n  private readonly _names = new Set<string>();\n\n  private readonly _pathBlobIdMap = new Map<string, string>();\n\n  constructor(options: AssetsManagerConfig) {\n    this._blob = options.blob;\n  }\n\n  cleanup() {\n    this._assetsMap.clear();\n    this._names.clear();\n  }\n\n  getAssets() {\n    return this._assetsMap;\n  }\n\n  getPathBlobIdMap() {\n    return this._pathBlobIdMap;\n  }\n\n  isEmpty() {\n    return this._assetsMap.size === 0;\n  }\n\n  async readFromBlob(blobId: string) {\n    if (this._assetsMap.has(blobId)) return;\n    const blob = await this._blob.get(blobId);\n    if (!blob) {\n      console.error(`Blob ${blobId} not found in blob manager`);\n      return;\n    }\n    if (blob instanceof File) {\n      let file = blob;\n      if (this._names.has(blob.name)) {\n        const newName = makeNewNameWhenConflict(this._names, blob.name);\n        file = new File([blob], newName, { type: blob.type });\n      }\n      this._assetsMap.set(blobId, file);\n      this._names.add(file.name);\n      return;\n    }\n    if (blob.type && blob.type !== 'application/octet-stream') {\n      this._assetsMap.set(blobId, blob);\n      return;\n    }\n    // Guess the file type from the buffer\n    const buffer = await blob.arrayBuffer();\n    const FileType = await import('file-type');\n    const fileType = await FileType.fileTypeFromBuffer(buffer);\n    if (fileType) {\n      const file = new File([blob], '', { type: fileType.mime });\n      this._assetsMap.set(blobId, file);\n      return;\n    }\n    this._assetsMap.set(blobId, blob);\n  }\n\n  async writeToBlob(blobId: string) {\n    const blob = this._assetsMap.get(blobId);\n    if (!blob) {\n      throw new BlockSuiteError(\n        ErrorCode.TransformerError,\n        `Blob ${blobId} not found in assets manager`\n      );\n    }\n\n    await this._blob.set(blobId, blob);\n  }\n}\n","import { NATIVE_UNIQ_IDENTIFIER, TEXT_UNIQ_IDENTIFIER } from '../consts';\nimport { isPureObject } from '../reactive';\nimport { Boxed } from '../reactive/boxed';\nimport { Text } from '../reactive/text';\n\nexport function toJSON(value: unknown): unknown {\n  if (value instanceof Boxed) {\n    return {\n      [NATIVE_UNIQ_IDENTIFIER]: true,\n      value: value.getValue(),\n    };\n  }\n  if (value instanceof Text) {\n    return {\n      [TEXT_UNIQ_IDENTIFIER]: true,\n      delta: value.yText.toDelta(),\n    };\n  }\n  if (Array.isArray(value)) {\n    return value.map(toJSON);\n  }\n  if (isPureObject(value)) {\n    return Object.fromEntries(\n      Object.entries(value).map(([key, value]) => {\n        return [key, toJSON(value)];\n      })\n    );\n  }\n  return value;\n}\n\nexport function fromJSON(value: unknown): unknown {\n  if (Array.isArray(value)) {\n    return value.map(fromJSON);\n  }\n  if (typeof value === 'object' && value != null) {\n    if (Reflect.has(value, NATIVE_UNIQ_IDENTIFIER)) {\n      return new Boxed(Reflect.get(value, 'value'));\n    }\n    if (Reflect.has(value, TEXT_UNIQ_IDENTIFIER)) {\n      return new Text(Reflect.get(value, 'delta'));\n    }\n    return Object.fromEntries(\n      Object.entries(value).map(([key, value]) => {\n        return [key, fromJSON(value)];\n      })\n    );\n  }\n\n  return value;\n}\n","import { BlockModel } from '../model/block/block-model';\nimport { type DraftModel, toDraftModel } from '../model/block/draft';\nimport {\n  type InternalPrimitives,\n  internalPrimitives,\n} from '../model/block/zod';\nimport type { AssetsManager } from './assets';\nimport { fromJSON, toJSON } from './json';\nimport type { BlockSnapshot } from './type';\n\nexport type BlockSnapshotLeaf = Pick<\n  BlockSnapshot,\n  'id' | 'flavour' | 'props' | 'version'\n>;\n\nexport type FromSnapshotPayload = {\n  json: BlockSnapshotLeaf;\n  assets: AssetsManager;\n  children: BlockSnapshot[];\n};\n\nexport type ToSnapshotPayload<Props extends object> = {\n  model: DraftModel<BlockModel<Props>> | BlockModel<Props>;\n  assets: AssetsManager;\n};\n\nexport type SnapshotNode<Props extends object> = {\n  id: string;\n  flavour: string;\n  version: number;\n  props: Props;\n};\n\nexport class BaseBlockTransformer<Props extends object = object> {\n  protected _internal: InternalPrimitives = internalPrimitives;\n\n  protected _propsFromSnapshot(propsJson: Record<string, unknown>) {\n    return Object.fromEntries(\n      Object.entries(propsJson).map(([key, value]) => {\n        return [key, fromJSON(value)];\n      })\n    ) as Props;\n  }\n\n  protected _propsToSnapshot(model: DraftModel | BlockModel) {\n    let draftModel: DraftModel;\n    if (model instanceof BlockModel) {\n      draftModel = toDraftModel(model);\n    } else {\n      draftModel = model;\n    }\n    return Object.fromEntries(\n      draftModel.keys.map(key => {\n        const value = draftModel.props[key as keyof typeof draftModel.props];\n        return [key, toJSON(value)];\n      })\n    );\n  }\n\n  constructor(public readonly transformerConfigs: Map<string, unknown>) {}\n\n  fromSnapshot({\n    json,\n  }: FromSnapshotPayload): Promise<SnapshotNode<Props>> | SnapshotNode<Props> {\n    const { flavour, id, version, props: _props } = json;\n\n    const props = this._propsFromSnapshot(_props);\n\n    return {\n      id,\n      flavour,\n      version: version ?? -1,\n      props,\n    };\n  }\n\n  toSnapshot({ model }: ToSnapshotPayload<Props>): BlockSnapshotLeaf {\n    const { id, flavour, version } = model;\n\n    const props = this._propsToSnapshot(model);\n\n    return {\n      id,\n      flavour,\n      version,\n      props,\n    };\n  }\n}\n","import {\n  BlockModel,\n  type DraftModel,\n  type Store,\n  toDraftModel,\n} from '../model/index';\n\ntype SliceData = {\n  content: DraftModel[];\n  workspaceId: string;\n  pageId: string;\n};\n\nexport class Slice {\n  get content() {\n    return this.data.content;\n  }\n\n  get docId() {\n    return this.data.pageId;\n  }\n\n  get workspaceId() {\n    return this.data.workspaceId;\n  }\n\n  constructor(readonly data: SliceData) {}\n\n  static fromModels(doc: Store, models: DraftModel[] | BlockModel[]) {\n    const draftModels = models.map(model => {\n      if (model instanceof BlockModel) {\n        return toDraftModel(model);\n      }\n      return model;\n    });\n    return new Slice({\n      content: draftModels,\n      workspaceId: doc.workspace.id,\n      pageId: doc.id,\n    });\n  }\n}\n","import { z } from 'zod';\n\nimport type { DocMeta, DocsPropertiesMeta } from '../extension';\nimport type { Store } from '../model';\n\nexport type BlockSnapshot = {\n  type: 'block';\n  id: string;\n  flavour: string;\n  version?: number;\n  props: Record<string, unknown>;\n  children: BlockSnapshot[];\n};\n\nexport const BlockSnapshotSchema: z.ZodType<BlockSnapshot> = z.object({\n  type: z.literal('block'),\n  id: z.string(),\n  flavour: z.string(),\n  version: z.number().optional(),\n  props: z.record(z.unknown()),\n  children: z.lazy(() => BlockSnapshotSchema.array()),\n});\n\nexport type SliceSnapshot = {\n  type: 'slice';\n  content: BlockSnapshot[];\n  workspaceId: string;\n  pageId: string;\n};\n\nexport const SliceSnapshotSchema: z.ZodType<SliceSnapshot> = z.object({\n  type: z.literal('slice'),\n  content: BlockSnapshotSchema.array(),\n  workspaceId: z.string(),\n  pageId: z.string(),\n});\n\nexport type CollectionInfoSnapshot = {\n  id: string;\n  type: 'info';\n  properties: DocsPropertiesMeta;\n};\n\nexport type DocSnapshot = {\n  type: 'page';\n  meta: DocMeta;\n  blocks: BlockSnapshot;\n};\n\nconst DocMetaSchema = z.object({\n  id: z.string(),\n  title: z.string(),\n  createDate: z.number(),\n  tags: z.array(z.string()),\n});\n\nexport const DocSnapshotSchema: z.ZodType<DocSnapshot> = z.object({\n  type: z.literal('page'),\n  meta: DocMetaSchema,\n  blocks: BlockSnapshotSchema,\n});\n\nexport interface BlobCRUD {\n  get: (key: string) => Promise<Blob | null> | Blob | null;\n  set: (key: string, value: Blob) => Promise<string> | string;\n  delete: (key: string) => Promise<void> | void;\n  list: () => Promise<string[]> | string[];\n}\n\nexport interface DocCRUD {\n  create: (id: string) => Store;\n  get: (id: string) => Store | null;\n  delete: (id: string) => void;\n}\n","import { DisposableGroup } from '@blocksuite/global/disposable';\nimport { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { nextTick } from '@blocksuite/global/utils';\nimport { Subject } from 'rxjs';\n\nimport {\n  BlockModel,\n  type BlockSchemaType,\n  type DraftModel,\n  type Store,\n  toDraftModel,\n} from '../model/index.js';\nimport type { Schema } from '../schema/index.js';\nimport { AssetsManager } from './assets.js';\nimport { BaseBlockTransformer } from './base.js';\nimport type {\n  AfterExportPayload,\n  AfterImportPayload,\n  BeforeExportPayload,\n  BeforeImportPayload,\n  TransformerMiddleware,\n  TransformerSlots,\n} from './middleware.js';\nimport { Slice } from './slice.js';\nimport type {\n  BlobCRUD,\n  BlockSnapshot,\n  DocCRUD,\n  DocSnapshot,\n  SliceSnapshot,\n} from './type.js';\nimport {\n  BlockSnapshotSchema,\n  DocSnapshotSchema,\n  SliceSnapshotSchema,\n} from './type.js';\n\nexport type TransformerOptions = {\n  schema: Schema;\n  blobCRUD: BlobCRUD;\n  docCRUD: DocCRUD;\n  middlewares?: TransformerMiddleware[];\n};\n\ninterface FlatSnapshot {\n  snapshot: BlockSnapshot;\n  parentId?: string;\n  index?: number;\n}\n\ninterface DraftBlockTreeNode {\n  draft: DraftModel;\n  snapshot: BlockSnapshot;\n  children: Array<DraftBlockTreeNode>;\n}\n\n// The number of blocks to insert in one batch\nconst BATCH_SIZE = 100;\n\nexport class Transformer {\n  private readonly _adapterConfigs = new Map<string, string>();\n\n  private readonly _transformerConfigs = new Map<string, unknown>();\n\n  private readonly _assetsManager: AssetsManager;\n\n  private readonly _schema: Schema;\n\n  private readonly _docCRUD: DocCRUD;\n\n  private readonly _disposables: DisposableGroup = new DisposableGroup();\n\n  private readonly _slots: TransformerSlots = {\n    beforeImport: new Subject<BeforeImportPayload>(),\n    afterImport: new Subject<AfterImportPayload>(),\n    beforeExport: new Subject<BeforeExportPayload>(),\n    afterExport: new Subject<AfterExportPayload>(),\n  };\n\n  blockToSnapshot = (\n    model: DraftModel | BlockModel\n  ): BlockSnapshot | undefined => {\n    try {\n      const draftModel =\n        model instanceof BlockModel ? toDraftModel(model) : model;\n\n      const snapshot = this._blockToSnapshot(draftModel);\n\n      if (!snapshot) {\n        return;\n      }\n\n      BlockSnapshotSchema.parse(snapshot);\n\n      return snapshot;\n    } catch (error) {\n      console.error(`Error when transforming block to snapshot:`);\n      console.error(error);\n      return;\n    }\n  };\n\n  docToSnapshot = (doc: Store): DocSnapshot | undefined => {\n    try {\n      this._slots.beforeExport.next({\n        type: 'page',\n        page: doc,\n      });\n      const rootModel = doc.root;\n      const meta = this._exportDocMeta(doc);\n      if (!rootModel) {\n        throw new BlockSuiteError(\n          ErrorCode.TransformerError,\n          'Root block not found in doc'\n        );\n      }\n      const blocks = this.blockToSnapshot(toDraftModel(rootModel));\n      if (!blocks) {\n        return;\n      }\n      const docSnapshot: DocSnapshot = {\n        type: 'page',\n        meta,\n        blocks,\n      };\n      this._slots.afterExport.next({\n        type: 'page',\n        page: doc,\n        snapshot: docSnapshot,\n      });\n      DocSnapshotSchema.parse(docSnapshot);\n\n      return docSnapshot;\n    } catch (error) {\n      console.error(`Error when transforming doc to snapshot:`);\n      console.error(error);\n      return;\n    }\n  };\n\n  sliceToSnapshot = (slice: Slice): SliceSnapshot | undefined => {\n    try {\n      this._slots.beforeExport.next({\n        type: 'slice',\n        slice,\n      });\n      const { content, pageId, workspaceId } = slice.data;\n      const contentSnapshot = [];\n      for (const block of content) {\n        const blockSnapshot = this.blockToSnapshot(block);\n        if (!blockSnapshot) {\n          return;\n        }\n        contentSnapshot.push(blockSnapshot);\n      }\n      const snapshot: SliceSnapshot = {\n        type: 'slice',\n        workspaceId,\n        pageId,\n        content: contentSnapshot,\n      };\n      this._slots.afterExport.next({\n        type: 'slice',\n        slice,\n        snapshot,\n      });\n      SliceSnapshotSchema.parse(snapshot);\n\n      return snapshot;\n    } catch (error) {\n      console.error(`Error when transforming slice to snapshot:`);\n      console.error(error);\n      return;\n    }\n  };\n\n  snapshotToBlock = async (\n    snapshot: BlockSnapshot,\n    doc: Store,\n    parent?: string,\n    index?: number\n  ): Promise<BlockModel | undefined> => {\n    try {\n      BlockSnapshotSchema.parse(snapshot);\n      const model = await this._snapshotToBlock(snapshot, doc, parent, index);\n      if (!model) return;\n      return model;\n    } catch (error) {\n      console.error(`Error when transforming snapshot to block:`);\n      console.error(error);\n      return;\n    }\n  };\n\n  snapshotToDoc = async (snapshot: DocSnapshot): Promise<Store | undefined> => {\n    try {\n      this._slots.beforeImport.next({\n        type: 'page',\n        snapshot,\n      });\n      DocSnapshotSchema.parse(snapshot);\n      const { meta, blocks } = snapshot;\n      const doc = this.docCRUD.create(meta.id);\n      doc.load();\n      await this.snapshotToBlock(blocks, doc);\n      this._slots.afterImport.next({\n        type: 'page',\n        snapshot,\n        page: doc,\n      });\n\n      return doc;\n    } catch (error) {\n      console.error(`Error when transforming snapshot to doc:`);\n      console.error(error);\n      return;\n    }\n  };\n\n  snapshotToModelData = async (snapshot: BlockSnapshot) => {\n    try {\n      const { children, flavour, props, id } = snapshot;\n\n      const schema = this._getSchema(flavour);\n      const snapshotLeaf = {\n        id,\n        flavour,\n        props,\n      };\n      const transformer = this._getTransformer(schema);\n      const modelData = await transformer.fromSnapshot({\n        json: snapshotLeaf,\n        assets: this._assetsManager,\n        children,\n      });\n\n      return modelData;\n    } catch (error) {\n      console.error(`Error when transforming snapshot to model data:`);\n      console.error(error);\n      return;\n    }\n  };\n\n  snapshotToSlice = async (\n    snapshot: SliceSnapshot,\n    doc: Store,\n    parent?: string,\n    index?: number\n  ): Promise<Slice | undefined> => {\n    try {\n      SliceSnapshotSchema.parse(snapshot);\n\n      this._slots.beforeImport.next({\n        type: 'slice',\n        snapshot,\n      });\n\n      const { content, workspaceId, pageId } = snapshot;\n\n      // Create a temporary root snapshot to encompass all content blocks\n      const tmpRootSnapshot: BlockSnapshot = {\n        id: 'temporary-root',\n        flavour: 'affine:page',\n        props: {},\n        type: 'block',\n        children: content,\n      };\n\n      for (const block of content) {\n        this._triggerBeforeImportEvent(block, parent, index);\n      }\n      const flatSnapshots: FlatSnapshot[] = [];\n      this._flattenSnapshot(tmpRootSnapshot, flatSnapshots, parent, index);\n\n      const blockTree = await this._convertFlatSnapshots(flatSnapshots);\n      const first = content[0];\n\n      // check if the slice is already in the doc\n      if (first && doc.hasBlock(first.id)) {\n        // if the slice is already in the doc, we need to move the blocks instead of adding them\n        const models = content\n          .map(block => doc.getBlock(block.id)?.model)\n          .filter(Boolean) as BlockModel[];\n        const parentModel = parent ? doc.getBlock(parent)?.model : undefined;\n        if (!parentModel) {\n          throw new BlockSuiteError(\n            ErrorCode.TransformerError,\n            'Parent block not found in doc when moving slice'\n          );\n        }\n        const targetSibling =\n          index !== undefined ? parentModel.children[index] : null;\n        doc.moveBlocks(models, parentModel, targetSibling);\n      } else {\n        await this._insertBlockTree(blockTree.children, doc, parent, index);\n      }\n\n      const contentBlocks = blockTree.children\n        .map(tree => doc.getModelById(tree.draft.id))\n        .filter((x): x is BlockModel => x !== null)\n        .map(model => toDraftModel(model));\n\n      const slice = new Slice({\n        content: contentBlocks,\n        workspaceId,\n        pageId,\n      });\n\n      this._slots.afterImport.next({\n        type: 'slice',\n        snapshot,\n        slice,\n      });\n\n      return slice;\n    } catch (error) {\n      console.error(`Error when transforming snapshot to slice:`);\n      console.error(error);\n      return;\n    }\n  };\n\n  walk = (snapshot: DocSnapshot, callback: (block: BlockSnapshot) => void) => {\n    const walk = (block: BlockSnapshot) => {\n      try {\n        callback(block);\n      } catch (error) {\n        console.error(`Error when walking snapshot:`);\n        console.error(error);\n      }\n\n      if (block.children) {\n        block.children.forEach(walk);\n      }\n    };\n\n    walk(snapshot.blocks);\n  };\n\n  get adapterConfigs() {\n    return this._adapterConfigs;\n  }\n\n  get assets() {\n    return this._assetsManager.getAssets();\n  }\n\n  get assetsManager() {\n    return this._assetsManager;\n  }\n\n  get schema() {\n    return this._schema;\n  }\n\n  get docCRUD() {\n    return this._docCRUD;\n  }\n\n  constructor({\n    blobCRUD,\n    schema,\n    docCRUD,\n    middlewares = [],\n  }: TransformerOptions) {\n    this._assetsManager = new AssetsManager({ blob: blobCRUD });\n    this._schema = schema;\n    this._docCRUD = docCRUD;\n\n    middlewares.forEach(middleware => {\n      const cleanup = middleware({\n        slots: this._slots,\n        docCRUD: this._docCRUD,\n        assetsManager: this._assetsManager,\n        adapterConfigs: this._adapterConfigs,\n        transformerConfigs: this._transformerConfigs,\n      });\n      if (cleanup) {\n        this._disposables.add(cleanup);\n      }\n    });\n  }\n\n  private _blockToSnapshot(model: DraftModel): BlockSnapshot | null {\n    this._slots.beforeExport.next({\n      type: 'block',\n      model,\n    });\n\n    const schema = this._getSchema(model.flavour);\n    const transformer = this._getTransformer(schema);\n    const snapshotLeaf = transformer.toSnapshot({\n      model,\n      assets: this._assetsManager,\n    });\n    const children = model.children\n      .map(child => {\n        return this._blockToSnapshot(child);\n      })\n      .filter(Boolean) as BlockSnapshot[];\n    const snapshot: BlockSnapshot = {\n      type: 'block',\n      ...snapshotLeaf,\n      children,\n    };\n    this._slots.afterExport.next({\n      type: 'block',\n      model,\n      snapshot,\n    });\n\n    return snapshot;\n  }\n\n  private async _convertFlatSnapshots(flatSnapshots: FlatSnapshot[]) {\n    // Phase 1: Convert snapshots to draft models in series\n    // This is not time-consuming, this is faster than Promise.all\n    const draftModels = [];\n    for (const flat of flatSnapshots) {\n      const draft = await this._convertSnapshotToDraftModel(flat);\n      if (draft) {\n        draft.id = flat.snapshot.id;\n      }\n      draftModels.push({\n        draft,\n        snapshot: flat.snapshot,\n        parentId: flat.parentId,\n        index: flat.index,\n      });\n    }\n\n    // Phase 2: Filter out the models that failed to convert\n    const validDraftModels = draftModels.filter(item => !!item.draft) as {\n      draft: DraftModel;\n      snapshot: BlockSnapshot;\n      parentId?: string;\n      index?: number;\n    }[];\n\n    // Phase 3: Rebuild the block trees\n    const blockTree = this._rebuildBlockTree(validDraftModels);\n    return blockTree;\n  }\n\n  private async _convertSnapshotToDraftModel(\n    flat: FlatSnapshot\n  ): Promise<DraftModel | undefined> {\n    try {\n      const { children, flavour } = flat.snapshot;\n      const schema = this._getSchema(flavour);\n      const transformer = this._getTransformer(schema);\n      const { props } = await transformer.fromSnapshot({\n        json: {\n          id: flat.snapshot.id,\n          flavour: flat.snapshot.flavour,\n          props: flat.snapshot.props,\n        },\n        assets: this._assetsManager,\n        children,\n      });\n\n      return {\n        id: flat.snapshot.id,\n        flavour: flat.snapshot.flavour,\n        children: [],\n        props,\n      } as unknown as DraftModel;\n    } catch (error) {\n      console.error(`Error when transforming snapshot to model data:`);\n      console.error(error);\n      return;\n    }\n  }\n\n  private _exportDocMeta(doc: Store): DocSnapshot['meta'] {\n    const docMeta = doc.meta;\n\n    if (!docMeta) {\n      throw new BlockSuiteError(\n        ErrorCode.TransformerError,\n        'Doc meta not found'\n      );\n    }\n    return {\n      id: docMeta.id,\n      title: docMeta.title,\n      createDate: docMeta.createDate,\n      tags: [], // for backward compatibility\n    };\n  }\n\n  private _flattenSnapshot(\n    snapshot: BlockSnapshot,\n    flatSnapshots: FlatSnapshot[],\n    parentId?: string,\n    index?: number\n  ) {\n    flatSnapshots.push({ snapshot, parentId, index });\n    if (snapshot.children) {\n      snapshot.children.forEach((child, idx) => {\n        this._flattenSnapshot(child, flatSnapshots, snapshot.id, idx);\n      });\n    }\n  }\n\n  private _getSchema(flavour: string) {\n    const schema = this.schema.flavourSchemaMap.get(flavour);\n    if (!schema) {\n      throw new BlockSuiteError(\n        ErrorCode.TransformerError,\n        `Flavour schema not found for ${flavour}`\n      );\n    }\n    return schema;\n  }\n\n  private _getTransformer(schema: BlockSchemaType) {\n    return (\n      schema.transformer?.(this._transformerConfigs) ??\n      new BaseBlockTransformer(this._transformerConfigs)\n    );\n  }\n\n  private async _insertBlockTree(\n    nodes: DraftBlockTreeNode[],\n    doc: Store,\n    parentId?: string,\n    startIndex?: number,\n    counter: number = 0\n  ) {\n    for (let index = 0; index < nodes.length; index++) {\n      const node = nodes[index];\n      const { draft } = node;\n      const { id, flavour, props } = draft;\n\n      const actualIndex =\n        startIndex !== undefined ? startIndex + index : undefined;\n      doc.addBlock(flavour, { id, ...props }, parentId, actualIndex);\n\n      const model = doc.getBlock(id)?.model;\n      if (!model) {\n        throw new BlockSuiteError(\n          ErrorCode.TransformerError,\n          `Block not found by id ${id}`\n        );\n      }\n\n      this._slots.afterImport.next({\n        type: 'block',\n        model,\n        snapshot: node.snapshot,\n      });\n\n      counter++;\n      if (counter % BATCH_SIZE === 0) {\n        await nextTick();\n      }\n\n      if (node.children.length > 0) {\n        counter = await this._insertBlockTree(\n          node.children,\n          doc,\n          id,\n          undefined,\n          counter\n        );\n      }\n    }\n\n    return counter;\n  }\n\n  private _rebuildBlockTree(\n    draftModels: {\n      draft: DraftModel;\n      snapshot: BlockSnapshot;\n      parentId?: string;\n      index?: number;\n    }[]\n  ): DraftBlockTreeNode {\n    const nodeMap = new Map<string, DraftBlockTreeNode>();\n    // First pass: create nodes and add them to the map\n    draftModels.forEach(({ draft, snapshot }) => {\n      nodeMap.set(draft.id, { draft, snapshot, children: [] });\n    });\n    const root = nodeMap.get(draftModels[0].draft.id) as DraftBlockTreeNode;\n\n    // Second pass: build the tree structure\n    draftModels.forEach(({ draft, parentId, index }) => {\n      const node = nodeMap.get(draft.id);\n      if (!node) return;\n\n      if (parentId) {\n        const parentNode = nodeMap.get(parentId);\n        if (parentNode && index !== undefined) {\n          parentNode.children[index] = node;\n        }\n      }\n    });\n\n    if (!root) {\n      throw new Error('No root node found in the tree');\n    }\n\n    return root;\n  }\n\n  private async _snapshotToBlock(\n    snapshot: BlockSnapshot,\n    doc: Store,\n    parent?: string,\n    index?: number\n  ): Promise<BlockModel | null> {\n    this._triggerBeforeImportEvent(snapshot, parent, index);\n\n    const flatSnapshots: FlatSnapshot[] = [];\n    this._flattenSnapshot(snapshot, flatSnapshots, parent, index);\n\n    const blockTree = await this._convertFlatSnapshots(flatSnapshots);\n\n    await this._insertBlockTree([blockTree], doc, parent, index);\n\n    return doc.getBlock(snapshot.id)?.model ?? null;\n  }\n\n  private _triggerBeforeImportEvent(\n    snapshot: BlockSnapshot,\n    parent?: string,\n    index?: number\n  ) {\n    const traverseAndTrigger = (\n      node: BlockSnapshot,\n      parent?: string,\n      index?: number\n    ) => {\n      this._slots.beforeImport.next({\n        type: 'block',\n        snapshot: node,\n        parent: parent,\n        index: index,\n      });\n      if (node.children) {\n        node.children.forEach((child, idx) => {\n          traverseAndTrigger(child, node.id, idx);\n        });\n      }\n    };\n    traverseAndTrigger(snapshot, parent, index);\n  }\n\n  reset() {\n    this._assetsManager.cleanup();\n  }\n\n  [Symbol.dispose]() {\n    this._disposables.dispose();\n    this._assetsManager.cleanup();\n  }\n}\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport * as Y from 'yjs';\n\nimport { isPureObject, native2Y } from '../../reactive/index.js';\nimport type { Schema } from '../../schema/index.js';\nimport type { BlockModel } from '../block/block-model.js';\nimport type { YBlock } from '../block/types.js';\nimport { internalPrimitives } from '../block/zod.js';\n\nexport class DocCRUD {\n  get root(): string | null {\n    let rootId: string | null = null;\n    this._yBlocks.forEach(yBlock => {\n      const flavour = yBlock.get('sys:flavour') as string;\n      const schema = this._schema.flavourSchemaMap.get(flavour);\n      if (!schema) return;\n\n      if (schema.model.role === 'root') {\n        rootId = yBlock.get('sys:id') as string;\n      }\n    });\n    return rootId;\n  }\n\n  constructor(\n    private readonly _yBlocks: Y.Map<YBlock>,\n    private readonly _schema: Schema\n  ) {}\n\n  private _getSiblings<T>(\n    id: string,\n    fn: (index: number, parent: YBlock) => T\n  ) {\n    const parentId = this.getParent(id);\n    if (!parentId) return null;\n    const parent = this._yBlocks.get(parentId);\n    if (!parent) return null;\n\n    const children = parent.get('sys:children');\n    const index = children.toArray().indexOf(id);\n    if (index === -1) return null;\n\n    return fn(index, parent);\n  }\n\n  addBlock(\n    id: string,\n    flavour: string,\n    initialProps: Record<string, unknown> = {},\n    parent?: string | null,\n    parentIndex?: number\n  ) {\n    const schema = this._schema.flavourSchemaMap.get(flavour);\n    if (!schema) {\n      throw new BlockSuiteError(\n        ErrorCode.ModelCRUDError,\n        `schema for flavour: ${flavour} not found`\n      );\n    }\n\n    const hasBlock = this._yBlocks.has(id);\n    if (hasBlock) {\n      throw new BlockSuiteError(\n        ErrorCode.ModelCRUDError,\n        `Should not add existing block: ${id}`\n      );\n    }\n\n    const parentFlavour = parent\n      ? this._yBlocks.get(parent)?.get('sys:flavour')\n      : undefined;\n\n    this._schema.validate(flavour, parentFlavour as string);\n\n    const yBlock = new Y.Map() as YBlock;\n    this._yBlocks.set(id, yBlock);\n\n    const version = schema.version;\n    const children = (\n      initialProps.children as undefined | (string | BlockModel)[]\n    )?.map(child => (typeof child === 'string' ? child : child.id));\n\n    yBlock.set('sys:id', id);\n    yBlock.set('sys:flavour', flavour);\n    yBlock.set('sys:version', version);\n    yBlock.set('sys:children', Y.Array.from(children ?? []));\n\n    const defaultProps = schema.model.props?.(internalPrimitives) ?? {};\n    const props = {\n      ...defaultProps,\n      ...initialProps,\n    };\n\n    delete props.id;\n    delete props.flavour;\n    delete props.children;\n\n    const isFlatData = schema.model.isFlatData;\n    if (isFlatData) {\n      const run = (obj: unknown, basePath: string) => {\n        if (isPureObject(obj)) {\n          Object.entries(obj).forEach(([key, value]) => {\n            const fullPath = basePath ? `${basePath}.${key}` : key;\n            run(value, fullPath);\n          });\n        } else {\n          yBlock.set(`prop:${basePath}`, native2Y(obj));\n        }\n      };\n      run(props, '');\n    } else {\n      Object.entries(props).forEach(([key, value]) => {\n        if (value === undefined) return;\n\n        yBlock.set(`prop:${key}`, native2Y(value));\n      });\n    }\n\n    const parentId =\n      parent ?? (schema.model.role === 'root' ? null : this.root);\n\n    if (!parentId) return;\n\n    const yParent = this._yBlocks.get(parentId);\n    if (!yParent) return;\n\n    const yParentChildren = yParent.get('sys:children') as Y.Array<string>;\n    const index =\n      parentIndex != null\n        ? parentIndex > yParentChildren.length\n          ? yParentChildren.length\n          : parentIndex\n        : yParentChildren.length;\n    yParentChildren.insert(index, [id]);\n  }\n\n  deleteBlock(\n    id: string,\n    options: {\n      bringChildrenTo?: string;\n      deleteChildren?: boolean;\n    } = {\n      deleteChildren: true,\n    }\n  ) {\n    const { bringChildrenTo, deleteChildren } = options;\n    if (bringChildrenTo && deleteChildren) {\n      console.error(\n        'Cannot bring children to another block and delete them at the same time'\n      );\n      return;\n    }\n\n    const yModel = this._yBlocks.get(id);\n    if (!yModel) return;\n\n    const yModelChildren = yModel.get('sys:children') as Y.Array<string>;\n\n    const parent = this.getParent(id);\n\n    if (!parent) return;\n    const yParent = this._yBlocks.get(parent) as YBlock;\n    const yParentChildren = yParent.get('sys:children') as Y.Array<string>;\n    const modelIndex = yParentChildren.toArray().indexOf(id);\n\n    if (modelIndex > -1) {\n      yParentChildren.delete(modelIndex, 1);\n    }\n\n    const apply = () => {\n      if (bringChildrenTo) {\n        const bringChildrenToModel = () => {\n          if (!bringChildrenTo) {\n            throw new BlockSuiteError(\n              ErrorCode.ModelCRUDError,\n              'bringChildrenTo is not provided when deleting block'\n            );\n          }\n          const model = this._yBlocks.get(bringChildrenTo);\n          if (!model) return;\n          const bringFlavour = model.get('sys:flavour');\n\n          yModelChildren.forEach(child => {\n            const childModel = this._yBlocks.get(child);\n            if (!childModel) return;\n            this._schema.validate(\n              childModel.get('sys:flavour') as string,\n              bringFlavour as string\n            );\n          });\n\n          if (bringChildrenTo === parent) {\n            // When bring children to parent, insert children to the original position of model\n            yParentChildren.insert(modelIndex, yModelChildren.toArray());\n            return;\n          }\n\n          const yBringChildrenTo = this._yBlocks.get(bringChildrenTo);\n          if (!yBringChildrenTo) return;\n\n          const yBringChildrenToChildren = yBringChildrenTo.get(\n            'sys:children'\n          ) as Y.Array<string>;\n          yBringChildrenToChildren.push(yModelChildren.toArray());\n        };\n\n        bringChildrenToModel();\n        return;\n      }\n\n      if (deleteChildren) {\n        // delete children recursively\n        const deleteById = (id: string) => {\n          const yBlock = this._yBlocks.get(id) as YBlock;\n\n          const yChildren = yBlock.get('sys:children') as Y.Array<string>;\n          yChildren.forEach(id => deleteById(id));\n\n          this._yBlocks.delete(id);\n        };\n\n        yModelChildren.forEach(id => deleteById(id));\n      }\n    };\n\n    apply();\n\n    this._yBlocks.delete(id);\n  }\n\n  getNext(id: string) {\n    return this._getSiblings(\n      id,\n      (index, parent) =>\n        parent\n          .get('sys:children')\n          .toArray()\n          .at(index + 1) ?? null\n    );\n  }\n\n  getParent(targetId: string): string | null {\n    const root = this.root;\n    if (!root || root === targetId) return null;\n\n    const findParent = (parentId: string): string | null => {\n      const parentYBlock = this._yBlocks.get(parentId);\n      if (!parentYBlock) return null;\n\n      const children = parentYBlock.get('sys:children');\n\n      for (const childId of children.toArray()) {\n        if (childId === targetId) return parentId;\n\n        const parent = findParent(childId);\n        if (parent != null) return parent;\n      }\n\n      return null;\n    };\n\n    return findParent(root);\n  }\n\n  getPrev(id: string) {\n    return this._getSiblings(\n      id,\n      (index, parent) =>\n        parent\n          .get('sys:children')\n          .toArray()\n          .at(index - 1) ?? null\n    );\n  }\n\n  moveBlocks(\n    blocksToMove: string[],\n    newParent: string,\n    targetSibling: string | null = null,\n    shouldInsertBeforeSibling = true\n  ) {\n    if (\n      blocksToMove.length > 1 &&\n      targetSibling &&\n      blocksToMove.includes(targetSibling)\n    ) {\n      console.error(\n        'Cannot move blocks when the target sibling is in the blocks to move'\n      );\n      return;\n    }\n\n    if (blocksToMove.length === 1 && targetSibling === blocksToMove[0]) {\n      return;\n    }\n\n    if (blocksToMove.includes(newParent)) {\n      console.error(\n        'Cannot move blocks when the new parent is in the blocks to move'\n      );\n      return;\n    }\n\n    // A map to store parent block and their respective child blocks\n    const childBlocksPerParent = new Map<string, string[]>();\n\n    const parentBlock = this._yBlocks.get(newParent);\n    if (!parentBlock) return;\n\n    const parentFlavour = parentBlock.get('sys:flavour');\n\n    blocksToMove.forEach(blockId => {\n      const parent = this.getParent(blockId);\n      if (!parent) return;\n\n      const block = this._yBlocks.get(blockId);\n      if (!block) return;\n\n      this._schema.validate(\n        block.get('sys:flavour') as string,\n        parentFlavour as string\n      );\n\n      const children = childBlocksPerParent.get(parent);\n      if (!children) {\n        childBlocksPerParent.set(parent, [blockId]);\n        return;\n      }\n\n      const last = children[children.length - 1];\n      if (this.getNext(last) !== blockId) {\n        throw new BlockSuiteError(\n          ErrorCode.ModelCRUDError,\n          'The blocks to move are not contiguous under their parent'\n        );\n      }\n\n      children.push(blockId);\n    });\n\n    let insertIndex = 0;\n    Array.from(childBlocksPerParent.entries()).forEach(\n      ([parentBlock, blocksToMove], index) => {\n        const targetParentBlock = this._yBlocks.get(newParent);\n        if (!targetParentBlock) return;\n        const targetParentChildren = targetParentBlock.get('sys:children');\n        const sourceParentBlock = this._yBlocks.get(parentBlock);\n        if (!sourceParentBlock) return;\n        const sourceParentChildren = sourceParentBlock.get('sys:children');\n\n        // Get the IDs of blocks to move\n        // Remove the blocks from their current parent\n        const startIndex = sourceParentChildren\n          .toArray()\n          .findIndex(id => id === blocksToMove[0]);\n        sourceParentChildren.delete(startIndex, blocksToMove.length);\n\n        const updateInsertIndex = () => {\n          const first = index === 0;\n          if (!first) {\n            insertIndex++;\n            return;\n          }\n\n          if (!targetSibling) {\n            insertIndex = targetParentChildren.length;\n            return;\n          }\n\n          let targetIndex = targetParentChildren\n            .toArray()\n            .findIndex(id => id === targetSibling);\n          if (targetIndex === -1) {\n            console.error('Target sibling not found, just insert to the end');\n            targetIndex = targetParentChildren.length;\n          }\n          insertIndex = shouldInsertBeforeSibling\n            ? targetIndex\n            : targetIndex + 1;\n        };\n\n        updateInsertIndex();\n\n        targetParentChildren.insert(insertIndex, blocksToMove);\n      }\n    );\n  }\n\n  updateBlockChildren(id: string, children: string[]) {\n    const yBlock = this._yBlocks.get(id);\n    if (!yBlock) return;\n\n    const yChildrenArray = yBlock.get('sys:children') as Y.Array<string>;\n    yChildrenArray.delete(0, yChildrenArray.length);\n    yChildrenArray.push(children);\n  }\n}\n","import type { z } from 'zod';\n\nimport { SYS_KEYS } from '../../consts.js';\nimport type { BlockModel } from '../block/block-model.js';\nimport type { BlockProps, YBlock } from '../block/types.js';\nimport type { BlockSchema } from '../block/zod.js';\nimport { internalPrimitives } from '../block/zod.js';\n\nexport function syncBlockProps(\n  schema: z.infer<typeof BlockSchema>,\n  model: BlockModel,\n  yBlock: YBlock,\n  props: Partial<BlockProps>\n) {\n  const defaultProps = schema.model.props?.(internalPrimitives) ?? {};\n\n  Object.entries(props).forEach(([key, value]) => {\n    if (SYS_KEYS.has(key)) return;\n    if (value === undefined) return;\n\n    // @ts-expect-error allow props\n    model.props[key] = value;\n  });\n\n  // set default value\n  Object.entries(defaultProps).forEach(([key, value]) => {\n    const notExists =\n      !yBlock.has(`prop:${key}`) || yBlock.get(`prop:${key}`) === undefined;\n    if (!notExists) {\n      return;\n    }\n\n    // @ts-expect-error allow props\n    model[key] = value;\n  });\n}\n","import { Container, type ServiceProvider } from '@blocksuite/global/di';\nimport { DisposableGroup } from '@blocksuite/global/disposable';\nimport { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { computed, signal } from '@preact/signals-core';\nimport { Subject } from 'rxjs';\nimport * as Y from 'yjs';\n\nimport type { ExtensionType } from '../../extension/extension.js';\nimport {\n  BlockSchemaIdentifier,\n  type Doc,\n  HistoryExtension,\n  StoreExtensionIdentifier,\n  StoreSelectionExtension,\n} from '../../extension/index.js';\nimport { DocIdentifier } from '../../extension/workspace/doc.js';\nimport { Schema } from '../../schema/index.js';\nimport type { TransformerMiddleware } from '../../transformer/middleware.js';\nimport { Transformer } from '../../transformer/transformer.js';\nimport {\n  Block,\n  type BlockModel,\n  type BlockOptions,\n  type BlockProps,\n  type BlockSysProps,\n  type PropsOfModel,\n  type YBlock,\n} from '../block/index.js';\nimport { DocCRUD } from './crud.js';\nimport { StoreIdentifier } from './identifier.js';\nimport { type Query, runQuery } from './query.js';\nimport { syncBlockProps } from './utils.js';\n\nexport type StoreOptions = {\n  doc: Doc;\n  id?: string;\n  readonly?: boolean;\n  query?: Query;\n  provider?: ServiceProvider;\n  extensions?: ExtensionType[];\n};\n\ntype StoreBlockAddedPayload = {\n  /**\n   * The type of the event.\n   */\n  type: 'add';\n  /**\n   * The id of the block.\n   */\n  id: string;\n  /**\n   * Whether the event is triggered by local changes.\n   */\n  isLocal: boolean;\n  /**\n   * The flavour of the block.\n   */\n  flavour: string;\n  /**\n   * The model of the block.\n   */\n  model: BlockModel;\n  /**\n   * @internal\n   * Whether the event is triggered by initialization.\n   * FIXME: This seems not working as expected now.\n   */\n  init: boolean;\n};\n\ntype StoreBlockDeletedPayload = {\n  /**\n   * The type of the event.\n   */\n  type: 'delete';\n  /**\n   * The id of the block.\n   */\n  id: string;\n  /**\n   * Whether the event is triggered by local changes.\n   */\n  isLocal: boolean;\n  /**\n   * The flavour of the block.\n   */\n  flavour: string;\n  /**\n   * The parent id of the block.\n   */\n  parent: string;\n  /**\n   * The model of the block.\n   */\n  model: BlockModel;\n};\n\ntype StoreBlockUpdatedPayload = {\n  /**\n   * The type of the event.\n   */\n  type: 'update';\n  /**\n   * The id of the block.\n   */\n  id: string;\n  /**\n   * Whether the event is triggered by local changes.\n   */\n  isLocal: boolean;\n  /**\n   * The flavour of the block.\n   */\n  flavour: string;\n  /**\n   * The changed props of the block.\n   */\n  props: { key: string };\n};\n\ntype StoreBlockUpdatedPayloads =\n  | StoreBlockAddedPayload\n  | StoreBlockDeletedPayload\n  | StoreBlockUpdatedPayload;\n\n/**\n * Slots for receiving events from the store.\n * All events are rxjs Subjects, you can subscribe to them like this:\n *\n * ```ts\n * store.slots.ready.subscribe(() => {\n *   console.log('store is ready');\n * });\n * ```\n *\n * You can also use rxjs operators to handle the events.\n *\n * @interface\n * @category Store\n */\nexport type StoreSlots = {\n  /**\n   * This fires after `doc.load` is called.\n   * The Y.Doc is fully loaded and ready to use.\n   */\n  ready: Subject<void>;\n  /**\n   * This fires when the root block is added via API call or has just been initialized from existing ydoc.\n   * useful for internal block UI components to start subscribing following up events.\n   * Note that at this moment, the whole block tree may not be fully initialized yet.\n   */\n  rootAdded: Subject<string>;\n  /**\n   * This fires when the root block is deleted via API call or has just been removed from existing ydoc.\n   * In most cases, you don't need to subscribe to this event.\n   */\n  rootDeleted: Subject<string>;\n  /**\n   * This fires when a block is updated via API call or has just been updated from existing ydoc.\n   *\n   * The payload can have three types:\n   * - add: When a new block is added\n   * - delete: When a block is removed\n   * - update: When a block's properties are modified\n   *\n   */\n  blockUpdated: Subject<StoreBlockUpdatedPayloads>;\n  /** @internal */\n  yBlockUpdated: Subject<\n    | {\n        type: 'add';\n        id: string;\n        isLocal: boolean;\n      }\n    | {\n        type: 'delete';\n        id: string;\n        isLocal: boolean;\n      }\n  >;\n};\n\nconst internalExtensions = [StoreSelectionExtension, HistoryExtension];\n\n/**\n * Core store class that manages blocks and their lifecycle in BlockSuite\n * @remarks\n * The Store class is responsible for managing the lifecycle of blocks, handling transactions,\n * and maintaining the block tree structure.\n * A store is a piece of data created from one or a part of a Y.Doc.\n *\n * @category Store\n */\nexport class Store {\n  /** @internal */\n  readonly userExtensions: ExtensionType[];\n\n  /**\n   * Group of disposable resources managed by the store\n   *\n   * @category Store Lifecycle\n   */\n  disposableGroup = new DisposableGroup();\n\n  private readonly _provider: ServiceProvider;\n\n  private _shouldTransact = true;\n\n  private readonly _runQuery = (block: Block) => {\n    runQuery(this._query, block);\n  };\n\n  private readonly _doc: Doc;\n\n  private readonly _blocks = signal<Record<string, Block>>({});\n\n  private readonly _crud: DocCRUD;\n\n  private readonly _query: Query = {\n    match: [],\n    mode: 'loose',\n  };\n\n  private readonly _readonly = signal(false);\n\n  private readonly _isEmpty = computed(() => {\n    return this.root?.isEmpty() ?? true;\n  });\n\n  private readonly _schema: Schema;\n\n  /**\n   * Get the id of the store.\n   *\n   * @category Store Lifecycle\n   */\n  get id() {\n    return this._doc.id;\n  }\n\n  /**\n   * {@inheritDoc StoreSlots}\n   *\n   * @category Store Lifecycle\n   */\n  readonly slots: StoreSlots;\n\n  private get _yBlocks() {\n    return this._doc.yBlocks;\n  }\n\n  /**\n   * Get the {@link AwarenessStore} instance for current store\n   */\n  get awarenessStore() {\n    return this._doc.awarenessStore;\n  }\n\n  /**\n   * Get the di provider for current store.\n   *\n   * @category Extension\n   */\n  get provider() {\n    return this._provider;\n  }\n\n  /**\n   * Get the {@link BlobEngine} instance for current store.\n   */\n  get blobSync() {\n    return this.workspace.blobSync;\n  }\n\n  /**\n   * Get the {@link Doc} instance for current store.\n   */\n  get doc() {\n    return this._doc;\n  }\n\n  /**\n   * @internal\n   */\n  get blocks() {\n    return this._blocks;\n  }\n\n  /**\n   * Get the number of blocks in the store\n   *\n   * @category Block CRUD\n   */\n  get blockSize() {\n    return Object.values(this._blocks.peek()).length;\n  }\n\n  /**\n   * Check if the store can redo\n   *\n   * @category History\n   */\n  get canRedo() {\n    if (this.readonly) {\n      return false;\n    }\n    return this._history.canRedo;\n  }\n\n  /**\n   * Check if the store can undo\n   *\n   * @category History\n   */\n  get canUndo() {\n    if (this.readonly) {\n      return false;\n    }\n    return this._history.canUndo;\n  }\n\n  /**\n   * Undo the last transaction.\n   *\n   * @category History\n   */\n  undo = () => {\n    if (this.readonly) {\n      console.error('cannot undo in readonly mode');\n      return;\n    }\n    this._history.undoManager.undo();\n  };\n\n  /**\n   * Redo the last undone transaction.\n   *\n   * @category History\n   */\n  redo = () => {\n    if (this.readonly) {\n      console.error('cannot undo in readonly mode');\n      return;\n    }\n    this._history.undoManager.redo();\n  };\n\n  /**\n   * Reset the history of the store.\n   *\n   * @category History\n   */\n  resetHistory = () => {\n    return this._history.undoManager.clear();\n  };\n\n  /**\n   * Execute a transaction.\n   *\n   * @example\n   * ```ts\n   * store.transact(() => {\n   *   op1();\n   *   op2();\n   * });\n   * ```\n   *\n   * @category History\n   */\n  transact(fn: () => void, shouldTransact: boolean = this._shouldTransact) {\n    const spaceDoc = this._doc.spaceDoc;\n    spaceDoc.transact(\n      () => {\n        try {\n          fn();\n        } catch (e) {\n          console.error(\n            `An error occurred while Y.doc ${spaceDoc.guid} transacting:`\n          );\n          console.error(e);\n        }\n      },\n      shouldTransact ? this.spaceDoc.clientID : null\n    );\n  }\n\n  /**\n   * Execute a transaction without capturing the history.\n   *\n   * @example\n   * ```ts\n   * store.withoutTransact(() => {\n   *   op1();\n   *   op2();\n   * });\n   * ```\n   *\n   * @category History\n   */\n  withoutTransact(fn: () => void) {\n    this._shouldTransact = false;\n    fn();\n    this._shouldTransact = true;\n  }\n\n  /**\n   * Force the following history to be captured into a new stack.\n   *\n   * @example\n   * ```ts\n   * op1();\n   * op2();\n   * store.captureSync();\n   * op3();\n   *\n   * store.undo(); // undo op3\n   * store.undo(); // undo op1, op2\n   * ```\n   *\n   * @category History\n   */\n  captureSync = () => {\n    this._history.undoManager.stopCapturing();\n  };\n\n  /**\n   * Get the {@link Workspace} instance for current store.\n   */\n  get workspace() {\n    return this._doc.workspace;\n  }\n\n  /**\n   * Get the {@link Y.UndoManager} instance for current store.\n   *\n   * @category History\n   */\n  get history() {\n    return this._history;\n  }\n\n  /**\n   * Check if there are no blocks in the store.\n   *\n   * @category Block CRUD\n   */\n  get isEmpty() {\n    return this._isEmpty.peek();\n  }\n\n  /**\n   * Get the signal for the empty state of the store.\n   *\n   * @category Block CRUD\n   */\n  get isEmpty$() {\n    return this._isEmpty;\n  }\n\n  /**\n   * Check if the store is loaded.\n   *\n   * @category Store Lifecycle\n   */\n  get loaded() {\n    return this._doc.loaded;\n  }\n\n  /**\n   * Get the meta data of the store.\n   *\n   * @internal\n   */\n  get meta() {\n    return this._doc.meta;\n  }\n\n  /**\n   * Check if the store is readonly.\n   *\n   * @category Block CRUD\n   */\n  get readonly() {\n    return this._readonly.value === true;\n  }\n\n  /**\n   * Get the signal for the readonly state of the store.\n   *\n   * @category Block CRUD\n   */\n  get readonly$() {\n    return this._readonly;\n  }\n\n  /**\n   * Set the readonly state of the store.\n   *\n   * @category Block CRUD\n   */\n  set readonly(value: boolean) {\n    this._readonly.value = value;\n  }\n\n  /**\n   * Check if the store is ready.\n   * Which means the Y.Doc is loaded and the root block is added.\n   *\n   * @category Store Lifecycle\n   */\n  get ready() {\n    return this._doc.ready;\n  }\n\n  /**\n   * Get the root block of the store.\n   *\n   * @category Block CRUD\n   */\n  get root() {\n    const rootId = this._crud.root;\n    if (!rootId) return null;\n    return this.getBlock(rootId)?.model ?? null;\n  }\n\n  /**\n   * @internal\n   * Get the root Y.Doc of sub Y.Doc.\n   * In the current design, store is on a sub Y.Doc, and all sub docs have the same root Y.Doc.\n   */\n  get rootDoc() {\n    return this._doc.rootDoc;\n  }\n\n  /**\n   * Get the {@link Schema} instance of the store.\n   */\n  get schema() {\n    return this._schema;\n  }\n\n  /**\n   * @internal\n   * Get the Y.Doc instance of the store.\n   */\n  get spaceDoc() {\n    return this._doc.spaceDoc;\n  }\n\n  private _isDisposed = false;\n\n  private get _history() {\n    return this._provider.get(HistoryExtension);\n  }\n\n  /**\n   * @internal\n   * In most cases, you don't need to use the constructor directly.\n   * The store is created by the {@link Doc} instance.\n   */\n  constructor({ readonly, query, provider, extensions }: StoreOptions) {\n    this.slots = {\n      ready: new Subject(),\n      rootAdded: new Subject(),\n      rootDeleted: new Subject(),\n      blockUpdated: new Subject(),\n      yBlockUpdated: new Subject(),\n    };\n    this._schema = new Schema();\n\n    const container = new Container();\n    container.addImpl(StoreIdentifier, () => this);\n\n    internalExtensions.forEach(ext => {\n      ext.setup(container);\n    });\n\n    const userExtensions = extensions ?? [];\n    this.userExtensions = userExtensions;\n    userExtensions.forEach(extension => {\n      extension.setup(container);\n    });\n\n    this._provider = container.provider(undefined, provider);\n    this._provider.getAll(BlockSchemaIdentifier).forEach(schema => {\n      this._schema.register([schema]);\n    });\n    this._doc = this._provider.get(DocIdentifier);\n    this._crud = new DocCRUD(this._yBlocks, this._schema);\n    if (readonly !== undefined) {\n      this._readonly.value = readonly;\n    }\n    if (query) {\n      this._query = query;\n    }\n\n    this._yBlocks.observeDeep(this._handleYEvents);\n    this._yBlocks.forEach((_, id) => {\n      this._handleYBlockAdd(id, false);\n\n      if (id in this._blocks.peek()) {\n        return;\n      }\n      this._onBlockAdded(id, false, true);\n    });\n\n    this._subscribeToSlots();\n  }\n\n  private readonly _subscribeToSlots = () => {\n    this.disposableGroup.add(\n      this.slots.yBlockUpdated.subscribe(({ type, id, isLocal }) => {\n        switch (type) {\n          case 'add': {\n            this._onBlockAdded(id, isLocal, false);\n            return;\n          }\n          case 'delete': {\n            this._onBlockRemoved(id, isLocal);\n            return;\n          }\n        }\n      })\n    );\n    this.disposableGroup.add(this.slots.ready);\n    this.disposableGroup.add(this.slots.blockUpdated);\n    this.disposableGroup.add(this.slots.rootAdded);\n    this.disposableGroup.add(this.slots.rootDeleted);\n  };\n\n  private _getSiblings<T>(\n    block: BlockModel | string,\n    fn: (parent: BlockModel, index: number) => T\n  ) {\n    const parent = this.getParent(block);\n    if (!parent) return null;\n\n    const blockModel =\n      typeof block === 'string' ? this.getBlock(block)?.model : block;\n    if (!blockModel) return null;\n\n    const index = parent.children.indexOf(blockModel);\n    if (index === -1) return null;\n\n    return fn(parent, index);\n  }\n\n  private _onBlockAdded(id: string, isLocal: boolean, init: boolean) {\n    try {\n      if (id in this._blocks.peek()) {\n        return;\n      }\n      const yBlock = this._yBlocks.get(id);\n      if (!yBlock) {\n        console.warn(`Could not find block with id ${id}`);\n        return;\n      }\n\n      const options: BlockOptions = {\n        onChange: (block, key, isLocal) => {\n          if (key) {\n            block.model.propsUpdated.next({ key });\n          }\n\n          this.slots.blockUpdated.next({\n            type: 'update',\n            id,\n            flavour: block.flavour,\n            props: { key },\n            isLocal,\n          });\n        },\n      };\n\n      const block = new Block(this._schema, yBlock, this, options);\n      this._runQuery(block);\n\n      this._blocks.value = {\n        ...this._blocks.value,\n        [id]: block,\n      };\n      block.model.created.next();\n\n      if (block.model.role === 'root') {\n        this.slots.rootAdded.next(id);\n      }\n\n      this.slots.blockUpdated.next({\n        type: 'add',\n        id,\n        init,\n        flavour: block.model.flavour,\n        model: block.model,\n        isLocal,\n      });\n    } catch (e) {\n      console.error('An error occurred while adding block:');\n      console.error(e);\n    }\n  }\n\n  private _onBlockRemoved(id: string, isLocal: boolean) {\n    try {\n      const block = this.getBlock(id);\n      if (!block) return;\n\n      if (block.model.role === 'root') {\n        this.slots.rootDeleted.next(id);\n      }\n\n      this.slots.blockUpdated.next({\n        type: 'delete',\n        id,\n        flavour: block.flavour,\n        parent: this.getParent(block.model)?.id ?? '',\n        model: block.model,\n        isLocal,\n      });\n\n      const { [id]: _, ...blocks } = this._blocks.peek();\n      this._blocks.value = blocks;\n\n      block.model.deleted.next();\n      block.model.dispose();\n    } catch (e) {\n      console.error('An error occurred while removing block:');\n      console.error(e);\n    }\n  }\n\n  /**\n   * Creates and adds a new block to the store\n   * @param flavour - The block's flavour (type)\n   * @param blockProps - Optional properties for the new block\n   * @param parent - Optional parent block or parent block ID\n   * @param parentIndex - Optional index position in parent's children\n   * @returns The ID of the newly created block\n   * @throws {BlockSuiteError} When store is in readonly mode\n   *\n   * @category Block CRUD\n   */\n  addBlock<T extends BlockModel = BlockModel>(\n    flavour: string,\n    blockProps: Partial<(PropsOfModel<T> & BlockSysProps) | BlockProps> = {},\n    parent?: BlockModel | string | null,\n    parentIndex?: number\n  ): string {\n    if (this.readonly) {\n      throw new BlockSuiteError(\n        ErrorCode.ModelCRUDError,\n        'cannot modify data in readonly mode'\n      );\n    }\n\n    const id = blockProps.id ?? this._doc.workspace.idGenerator();\n\n    this.transact(() => {\n      this._crud.addBlock(\n        id,\n        flavour,\n        { ...blockProps },\n        typeof parent === 'string' ? parent : parent?.id,\n        parentIndex\n      );\n    });\n\n    return id;\n  }\n\n  /**\n   * Add multiple blocks to the store\n   * @param blocks - Array of blocks to add\n   * @param parent - Optional parent block or parent block ID\n   * @param parentIndex - Optional index position in parent's children\n   * @returns Array of IDs of the newly created blocks\n   *\n   * @category Block CRUD\n   */\n  addBlocks(\n    blocks: Array<{\n      flavour: string;\n      blockProps?: Partial<BlockProps & Omit<BlockProps, 'flavour' | 'id'>>;\n    }>,\n    parent?: BlockModel | string | null,\n    parentIndex?: number\n  ): string[] {\n    const ids: string[] = [];\n    blocks.forEach(block => {\n      const id = this.addBlock(\n        block.flavour as never,\n        block.blockProps ?? {},\n        parent,\n        parentIndex\n      );\n      ids.push(id);\n      typeof parentIndex === 'number' && parentIndex++;\n    });\n\n    return ids;\n  }\n\n  /**\n   * Add sibling blocks to the store\n   * @param targetModel - The target block model\n   * @param props - Array of block properties\n   * @param placement - Optional position to place the new blocks ('after' or 'before')\n   * @returns Array of IDs of the newly created blocks\n   *\n   * @category Block CRUD\n   */\n  addSiblingBlocks(\n    targetModel: BlockModel,\n    props: Array<Partial<BlockProps>>,\n    placement: 'after' | 'before' = 'after'\n  ): string[] {\n    if (!props.length) return [];\n    const parent = this.getParent(targetModel);\n    if (!parent) return [];\n\n    const targetIndex =\n      parent.children.findIndex(({ id }) => id === targetModel.id) ?? 0;\n    const insertIndex = placement === 'before' ? targetIndex : targetIndex + 1;\n\n    if (props.length <= 1) {\n      if (!props[0]?.flavour) return [];\n      const { flavour, ...blockProps } = props[0];\n      const id = this.addBlock(\n        flavour as never,\n        blockProps,\n        parent.id,\n        insertIndex\n      );\n      return [id];\n    }\n\n    const blocks: Array<{\n      flavour: string;\n      blockProps: Partial<BlockProps>;\n    }> = [];\n    props.forEach(prop => {\n      const { flavour, ...blockProps } = prop;\n      if (!flavour) return;\n      blocks.push({ flavour, blockProps });\n    });\n    return this.addBlocks(blocks, parent.id, insertIndex);\n  }\n\n  /**\n   * Updates a block's properties or executes a callback in a transaction\n   * @param modelOrId - The block model or block ID to update\n   * @param callBackOrProps - Either a callback function to execute or properties to update\n   * @throws {BlockSuiteError} When the block is not found or schema validation fails\n   *\n   * @category Block CRUD\n   */\n\n  updateBlock<T extends BlockModel = BlockModel>(\n    modelOrId: T | string,\n    callBackOrProps:\n      | (() => void)\n      | Partial<(PropsOfModel<T> & BlockSysProps) | BlockProps>\n  ) {\n    if (this.readonly) {\n      console.error('cannot modify data in readonly mode');\n      return;\n    }\n\n    const isCallback = typeof callBackOrProps === 'function';\n\n    const model =\n      typeof modelOrId === 'string'\n        ? this.getBlock(modelOrId)?.model\n        : modelOrId;\n    if (!model) {\n      throw new BlockSuiteError(\n        ErrorCode.ModelCRUDError,\n        `updating block: ${modelOrId} not found`\n      );\n    }\n\n    if (!isCallback) {\n      const parent = this.getParent(model);\n      this.schema.validate(\n        model.flavour,\n        parent?.flavour,\n        callBackOrProps.children?.map(child => child.flavour)\n      );\n    }\n\n    const yBlock = this._yBlocks.get(model.id);\n    if (!yBlock) {\n      throw new BlockSuiteError(\n        ErrorCode.ModelCRUDError,\n        `updating block: ${model.id} not found`\n      );\n    }\n\n    const block = this.getBlock(model.id);\n    if (!block) return;\n\n    this.transact(() => {\n      if (isCallback) {\n        callBackOrProps();\n        this._runQuery(block);\n        return;\n      }\n\n      if (callBackOrProps.children) {\n        this._crud.updateBlockChildren(\n          model.id,\n          callBackOrProps.children.map(child => child.id)\n        );\n      }\n\n      const schema = this.schema.flavourSchemaMap.get(model.flavour);\n      if (!schema) {\n        throw new BlockSuiteError(\n          ErrorCode.ModelCRUDError,\n          `schema for flavour: ${model.flavour} not found`\n        );\n      }\n      syncBlockProps(schema, model, yBlock, callBackOrProps);\n      this._runQuery(block);\n      return;\n    });\n  }\n\n  /**\n   * Delete a block from the store\n   * @param model - The block model or block ID to delete\n   * @param options - Optional options for the deletion\n   * @param options.bringChildrenTo - Optional block model to bring children to\n   * @param options.deleteChildren - Optional flag to delete children\n   *\n   * @category Block CRUD\n   */\n  deleteBlock(\n    model: BlockModel | string,\n    options: {\n      bringChildrenTo?: BlockModel;\n      deleteChildren?: boolean;\n    } = {\n      deleteChildren: true,\n    }\n  ) {\n    if (this.readonly) {\n      console.error('cannot modify data in readonly mode');\n      return;\n    }\n\n    const opts = (\n      options && options.bringChildrenTo\n        ? {\n            ...options,\n            bringChildrenTo: options.bringChildrenTo.id,\n          }\n        : options\n    ) as {\n      bringChildrenTo?: string;\n      deleteChildren?: boolean;\n    };\n\n    this.transact(() => {\n      this._crud.deleteBlock(\n        typeof model === 'string' ? model : model.id,\n        opts\n      );\n    });\n  }\n\n  /**\n   * Gets a block by its ID\n   * @param id - The block's ID\n   * @returns The block instance if found, undefined otherwise\n   *\n   * @category Block CRUD\n   */\n  getBlock(id: string): Block | undefined {\n    return this._blocks.peek()[id];\n  }\n\n  /**\n   * Gets a block by its ID\n   * @param id - The block's ID\n   * @returns The block instance in signal if found, undefined otherwise\n   *\n   * @category Block CRUD\n   */\n  getBlock$(id: string): Block | undefined {\n    return this._blocks.value[id];\n  }\n\n  /**\n   * Get a model by its ID\n   * @param id - The model's ID\n   * @returns The model instance if found, null otherwise\n   *\n   * @category Block CRUD\n   */\n  getModelById<Model extends BlockModel = BlockModel>(\n    id: string\n  ): Model | null {\n    return (this.getBlock(id)?.model ?? null) as Model | null;\n  }\n\n  /**\n   * Gets all blocks of specified flavour(s)\n   * @param blockFlavour - Single flavour or array of flavours to filter by\n   * @returns Array of matching blocks\n   *\n   * @category Block CRUD\n   */\n  getBlocksByFlavour(blockFlavour: string | string[]): Block[] {\n    const flavours =\n      typeof blockFlavour === 'string' ? [blockFlavour] : blockFlavour;\n\n    return Object.values(this._blocks.peek()).filter(({ flavour }) =>\n      flavours.includes(flavour)\n    );\n  }\n\n  /**\n   * Get all models in the store\n   * @returns Array of all models\n   *\n   * @category Block CRUD\n   */\n  getAllModels() {\n    return Object.values(this._blocks.peek()).map(block => block.model);\n  }\n\n  /**\n   * Get all models of specified flavour(s)\n   * @param blockFlavour - Single flavour or array of flavours to filter by\n   * @returns Array of matching models\n   *\n   * @category Block CRUD\n   */\n  getModelsByFlavour(blockFlavour: string | string[]): BlockModel[] {\n    return this.getBlocksByFlavour(blockFlavour).map(x => x.model);\n  }\n\n  /**\n   * Gets the parent block of a given block\n   * @param target - Block model or block ID to find parent for\n   * @returns The parent block model if found, null otherwise\n   *\n   * @category Block CRUD\n   */\n  getParent(target: BlockModel | string): BlockModel | null {\n    const targetId = typeof target === 'string' ? target : target.id;\n    const parentId = this._crud.getParent(targetId);\n    if (!parentId) return null;\n\n    const parent = this._blocks.peek()[parentId];\n    if (!parent) return null;\n\n    return parent.model;\n  }\n\n  /**\n   * Get the previous sibling block of a given block\n   * @param block - Block model or block ID to find previous sibling for\n   * @returns The previous sibling block model if found, null otherwise\n   *\n   * @category Block CRUD\n   */\n  getPrev(block: BlockModel | string) {\n    return this._getSiblings(\n      block,\n      (parent, index) => parent.children[index - 1] ?? null\n    );\n  }\n\n  /**\n   * Get all previous sibling blocks of a given block\n   * @param block - Block model or block ID to find previous siblings for\n   * @returns Array of previous sibling blocks if found, empty array otherwise\n   *\n   * @category Block CRUD\n   */\n  getPrevs(block: BlockModel | string) {\n    return (\n      this._getSiblings(block, (parent, index) =>\n        parent.children.slice(0, index)\n      ) ?? []\n    );\n  }\n\n  /**\n   * Get the next sibling block of a given block\n   * @param block - Block model or block ID to find next sibling for\n   * @returns The next sibling block model if found, null otherwise\n   *\n   * @category Block CRUD\n   */\n  getNext(block: BlockModel | string) {\n    return this._getSiblings(\n      block,\n      (parent, index) => parent.children[index + 1] ?? null\n    );\n  }\n\n  /**\n   * Get all next sibling blocks of a given block\n   * @param block - Block model or block ID to find next siblings for\n   * @returns Array of next sibling blocks if found, empty array otherwise\n   *\n   * @category Block CRUD\n   */\n  getNexts(block: BlockModel | string) {\n    return (\n      this._getSiblings(block, (parent, index) =>\n        parent.children.slice(index + 1)\n      ) ?? []\n    );\n  }\n\n  /**\n   * Check if a block exists by its ID\n   * @param id - The block's ID\n   * @returns True if the block exists, false otherwise\n   *\n   * @category Block CRUD\n   */\n  hasBlock(id: string) {\n    return id in this._blocks.peek();\n  }\n\n  /**\n   * Move blocks to a new parent block\n   * @param blocksToMove - Array of block models to move\n   * @param newParent - The new parent block model\n   * @param targetSibling - Optional target sibling block model\n   * @param shouldInsertBeforeSibling - Optional flag to insert before sibling\n   *\n   * @category Block CRUD\n   */\n  moveBlocks(\n    blocksToMove: BlockModel[],\n    newParent: BlockModel,\n    targetSibling: BlockModel | null = null,\n    shouldInsertBeforeSibling = true\n  ) {\n    if (this.readonly) {\n      console.error('Cannot modify data in read-only mode');\n      return;\n    }\n\n    this.transact(() => {\n      this._crud.moveBlocks(\n        blocksToMove.map(model => model.id),\n        newParent.id,\n        targetSibling?.id ?? null,\n        shouldInsertBeforeSibling\n      );\n    });\n  }\n\n  /**\n   * Creates a new transformer instance for the store\n   * @param middlewares - Optional array of transformer middlewares\n   * @returns A new Transformer instance\n   *\n   * @category Transformer\n   */\n  getTransformer(middlewares: TransformerMiddleware[] = []) {\n    return new Transformer({\n      schema: this.schema,\n      blobCRUD: this.workspace.blobSync,\n      docCRUD: {\n        create: (id: string) => this.workspace.createDoc(id).getStore({ id }),\n        get: (id: string) =>\n          this.workspace.getDoc(id)?.getStore({ id }) ?? null,\n        delete: (id: string) => this.workspace.removeDoc(id),\n      },\n      middlewares,\n    });\n  }\n\n  /**\n   * Get an extension instance from the store\n   * @returns The extension instance\n   *\n   * @example\n   * ```ts\n   * const extension = store.get(SomeExtension);\n   * ```\n   *\n   * @category Extension\n   */\n  get get() {\n    return this.provider.get.bind(this.provider);\n  }\n\n  /**\n   * Optional get an extension instance from the store.\n   * The major difference between `get` and `getOptional` is that `getOptional` will not throw an error if the extension is not found.\n   *\n   * @returns The extension instance\n   *\n   * @example\n   * ```ts\n   * const extension = store.getOptional(SomeExtension);\n   * ```\n   *\n   * @category Extension\n   */\n  get getOptional() {\n    return this.provider.getOptional.bind(this.provider);\n  }\n\n  /**\n   * Initializes and loads the store\n   * @param initFn - Optional initialization function\n   * @returns The store instance\n   *\n   * @category Store Lifecycle\n   */\n  load(initFn?: () => void) {\n    if (this._isDisposed) {\n      this.disposableGroup = new DisposableGroup();\n      this._subscribeToSlots();\n      this._isDisposed = false;\n    }\n\n    this._doc.load(initFn);\n    this._provider.getAll(StoreExtensionIdentifier).forEach(ext => {\n      ext.loaded();\n    });\n    this.slots.ready.next();\n    this.slots.rootAdded.next(this.root?.id ?? '');\n    return this;\n  }\n\n  /**\n   * Disposes the store and releases all resources\n   *\n   * @category Store Lifecycle\n   */\n  dispose() {\n    this._provider.getAll(StoreExtensionIdentifier).forEach(ext => {\n      ext.disposed();\n    });\n    if (this._doc.ready) {\n      this._yBlocks.unobserveDeep(this._handleYEvents);\n    }\n    this.slots.ready.complete();\n    this.slots.rootAdded.complete();\n    this.slots.rootDeleted.complete();\n    this.slots.blockUpdated.complete();\n    this.slots.yBlockUpdated.complete();\n    this.disposableGroup.dispose();\n    this._isDisposed = true;\n  }\n\n  private _handleYBlockAdd(id: string, isLocal: boolean) {\n    this.slots.yBlockUpdated.next({ type: 'add', id, isLocal });\n  }\n\n  private _handleYBlockDelete(id: string, isLocal: boolean) {\n    this.slots.yBlockUpdated.next({ type: 'delete', id, isLocal });\n  }\n\n  private _handleYEvent(event: Y.YEvent<YBlock | Y.Text | Y.Array<unknown>>) {\n    // event on top-level block store\n    if (event.target !== this._yBlocks) {\n      return;\n    }\n    const isLocal =\n      !event.transaction.origin ||\n      !this._yBlocks.doc ||\n      event.transaction.origin instanceof Y.UndoManager ||\n      event.transaction.origin.proxy\n        ? true\n        : event.transaction.origin === this._yBlocks.doc.clientID;\n    event.keys.forEach((value, id) => {\n      try {\n        if (value.action === 'add') {\n          this._handleYBlockAdd(id, isLocal);\n          return;\n        }\n        if (value.action === 'delete') {\n          this._handleYBlockDelete(id, isLocal);\n          return;\n        }\n      } catch (e) {\n        console.error('An error occurred while handling Yjs event:');\n        console.error(e);\n      }\n    });\n  }\n\n  private readonly _handleYEvents = (events: Y.YEvent<YBlock | Y.Text>[]) => {\n    events.forEach(event => this._handleYEvent(event));\n  };\n}\n","import type { Store } from '@blocksuite/store';\n\nimport {\n  type GfxCompatibleInterface,\n  type GfxGroupCompatibleInterface,\n  isGfxGroupCompatibleModel,\n} from '../gfx/model/base.js';\nimport type { GfxGroupModel, GfxModel } from '../gfx/model/model.js';\n\n/**\n * Get the top elements from the list of elements, which are in some tree structures.\n *\n * For example: a list `[G1, E1, G2, E2, E3, E4, G4, E5, E6]`,\n * and they are in the elements tree like:\n * ```\n *     G1         G4      E6\n *    /  \\        |\n *  E1   G2       E5\n *       / \\\n *      E2  G3*\n *         / \\\n *        E3 E4\n * ```\n * where the star symbol `*` denote it is not in the list.\n *\n * The result should be `[G1, G4, E6]`\n */\nexport function getTopElements(elements: GfxModel[]): GfxModel[] {\n  const results = new Set(elements);\n\n  elements = [...new Set(elements)];\n\n  elements.forEach(e1 => {\n    elements.forEach(e2 => {\n      if (isGfxGroupCompatibleModel(e1) && e1.hasDescendant(e2)) {\n        results.delete(e2);\n      }\n    });\n  });\n\n  return [...results];\n}\n\nfunction traverse(\n  element: GfxModel,\n  preCallback?: (element: GfxModel) => void | boolean,\n  postCallBack?: (element: GfxModel) => void\n) {\n  // avoid infinite loop caused by circular reference\n  const visited = new Set<GfxModel>();\n\n  const innerTraverse = (element: GfxModel) => {\n    if (visited.has(element)) return;\n    visited.add(element);\n\n    if (preCallback) {\n      const interrupt = preCallback(element);\n      if (interrupt) return;\n    }\n\n    if (isGfxGroupCompatibleModel(element)) {\n      element.childElements.forEach(child => {\n        innerTraverse(child);\n      });\n    }\n\n    postCallBack && postCallBack(element);\n  };\n\n  innerTraverse(element);\n}\n\nexport function descendantElementsImpl(\n  container: GfxGroupCompatibleInterface\n): GfxModel[] {\n  const results: GfxModel[] = [];\n  container.childElements.forEach(child => {\n    traverse(child, element => {\n      results.push(element);\n    });\n  });\n  return results;\n}\n\nexport function hasDescendantElementImpl(\n  container: GfxGroupCompatibleInterface,\n  element: GfxCompatibleInterface\n): boolean {\n  let _container = element.group;\n  while (_container) {\n    if (_container === container) return true;\n    _container = _container.group;\n  }\n  return false;\n}\n\n/**\n * This checker is used to prevent circular reference, when adding a child element to a container.\n */\nexport function canSafeAddToContainer(\n  container: GfxGroupModel,\n  element: GfxCompatibleInterface\n) {\n  if (\n    element === container ||\n    (isGfxGroupCompatibleModel(element) && element.hasDescendant(container))\n  ) {\n    return false;\n  }\n  return true;\n}\n\nexport function isLockedByAncestorImpl(\n  element: GfxCompatibleInterface\n): boolean {\n  return element.groups.some(isLockedBySelfImpl);\n}\n\nexport function isLockedBySelfImpl(element: GfxCompatibleInterface): boolean {\n  return element.lockedBySelf ?? false;\n}\n\nexport function isLockedImpl(element: GfxCompatibleInterface): boolean {\n  return isLockedBySelfImpl(element) || isLockedByAncestorImpl(element);\n}\n\nexport function lockElementImpl(doc: Store, element: GfxCompatibleInterface) {\n  doc.transact(() => {\n    element.lockedBySelf = true;\n  });\n}\n\nexport function unlockElementImpl(doc: Store, element: GfxCompatibleInterface) {\n  doc.transact(() => {\n    element.lockedBySelf = false;\n  });\n}\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport type { IVec, SerializedXYWH, XYWH } from '@blocksuite/global/gfx';\nimport {\n  Bound,\n  deserializeXYWH,\n  getBoundWithRotation,\n  getPointsFromBoundWithRotation,\n  linePolygonIntersects,\n  PointLocation,\n  polygonGetPointTangent,\n  polygonNearestPoint,\n  rotatePoints,\n} from '@blocksuite/global/gfx';\nimport type { Constructor } from '@blocksuite/global/utils';\nimport { BlockModel } from '@blocksuite/store';\n\nimport {\n  isLockedByAncestorImpl,\n  isLockedBySelfImpl,\n  isLockedImpl,\n  lockElementImpl,\n  unlockElementImpl,\n} from '../../utils/tree.js';\nimport type { EditorHost } from '../../view/index.js';\nimport type { GfxCompatibleInterface, PointTestOptions } from './base.js';\nimport type { GfxGroupModel } from './model.js';\nimport type { SurfaceBlockModel } from './surface/surface-model.js';\n\n/**\n * The props that a graphics block model should have.\n */\nexport type GfxCompatibleProps = {\n  xywh: SerializedXYWH;\n  index: string;\n  lockedBySelf?: boolean;\n};\n\n/**\n * This type include the common props for the graphic block model.\n * You can use this type with Omit to define the props of a graphic block model.\n */\nexport type GfxCommonBlockProps = GfxCompatibleProps & {\n  rotate: number;\n  scale: number;\n};\n\n/**\n * The graphic block model that can be rendered in the graphics mode.\n * All the graphic block model should extend this class.\n * You can use `GfxCompatibleBlockModel` to convert a BlockModel to a subclass that extends it.\n */\nexport class GfxBlockElementModel<\n    Props extends GfxCompatibleProps = GfxCompatibleProps,\n  >\n  extends BlockModel<Props>\n  implements GfxCompatibleInterface\n{\n  private _cacheDeserKey: string | null = null;\n\n  private _cacheDeserXYWH: XYWH | null = null;\n\n  private _externalXYWH: SerializedXYWH | undefined = undefined;\n\n  connectable = true;\n\n  get xywh() {\n    return this.props.xywh;\n  }\n\n  get xywh$() {\n    return this.props.xywh$;\n  }\n\n  set xywh(xywh: SerializedXYWH) {\n    this.props.xywh = xywh;\n  }\n\n  get index() {\n    return this.props.index;\n  }\n\n  get index$() {\n    return this.props.index$;\n  }\n\n  set index(index: string) {\n    this.props.index = index;\n  }\n\n  get lockedBySelf(): boolean | undefined {\n    return this.props.lockedBySelf;\n  }\n\n  get lockedBySelf$() {\n    return this.props.lockedBySelf$;\n  }\n\n  set lockedBySelf(lockedBySelf: boolean | undefined) {\n    this.props.lockedBySelf = lockedBySelf;\n  }\n\n  /**\n   * Defines the extension of the response area beyond the element's bounding box.\n   * This tuple specifies the horizontal and vertical margins to be added to the element's [x, y, width, height].\n   *\n   * The first value represents the horizontal extension (added to both left and right sides),\n   * and the second value represents the vertical extension (added to both top and bottom sides).\n   *\n   * The response area is computed as:\n   * `[x - horizontal, y - vertical, width + 2 * horizontal, height + 2 * vertical]`.\n   *\n   * Example:\n   * - Bounding box: `[0, 0, 100, 100]`, `responseExtension: [10, 20]`\n   *   Resulting response area: `[-10, -20, 120, 140]`.\n   * - `responseExtension: [0, 0]` keeps the response area equal to the bounding box.\n   */\n  responseExtension: [number, number] = [0, 0];\n\n  get rotate() {\n    if ('rotate' in this.props) {\n      return this.props.rotate as number;\n    }\n\n    return 0;\n  }\n\n  set rotate(rotate: number) {\n    if ('rotate' in this.props) {\n      this.props.rotate = rotate;\n    }\n  }\n\n  get deserializedXYWH() {\n    if (this._cacheDeserKey !== this.xywh || !this._cacheDeserXYWH) {\n      this._cacheDeserKey = this.xywh;\n      this._cacheDeserXYWH = deserializeXYWH(this.xywh);\n    }\n\n    return this._cacheDeserXYWH;\n  }\n\n  get elementBound() {\n    return Bound.from(getBoundWithRotation(this));\n  }\n\n  get externalBound(): Bound | null {\n    return this._externalXYWH ? Bound.deserialize(this._externalXYWH) : null;\n  }\n\n  get externalXYWH(): SerializedXYWH | undefined {\n    return this._externalXYWH;\n  }\n\n  set externalXYWH(xywh: SerializedXYWH | undefined) {\n    this._externalXYWH = xywh;\n  }\n\n  get group(): GfxGroupModel | null {\n    if (!this.surface) return null;\n\n    return this.surface.getGroup(this.id) ?? null;\n  }\n\n  get groups(): GfxGroupModel[] {\n    if (!this.surface) return [];\n\n    return this.surface.getGroups(this.id);\n  }\n\n  get h() {\n    return this.deserializedXYWH[3];\n  }\n\n  get responseBound() {\n    return this.elementBound.expand(this.responseExtension);\n  }\n\n  get surface(): SurfaceBlockModel | null {\n    const result = this.store.getBlocksByFlavour('affine:surface');\n    if (result.length === 0) return null;\n    return result[0].model as SurfaceBlockModel;\n  }\n\n  get w() {\n    return this.deserializedXYWH[2];\n  }\n\n  get x() {\n    return this.deserializedXYWH[0];\n  }\n\n  get y() {\n    return this.deserializedXYWH[1];\n  }\n\n  containsBound(bounds: Bound): boolean {\n    const bound = Bound.deserialize(this.xywh);\n    const points = getPointsFromBoundWithRotation({\n      x: bound.x,\n      y: bound.y,\n      w: bound.w,\n      h: bound.h,\n      rotate: this.rotate,\n    });\n    return points.some(point => bounds.containsPoint(point));\n  }\n\n  getLineIntersections(start: IVec, end: IVec): PointLocation[] | null {\n    const bound = Bound.deserialize(this.xywh);\n\n    return linePolygonIntersects(\n      start,\n      end,\n      rotatePoints(bound.points, bound.center, this.rotate ?? 0)\n    );\n  }\n\n  getNearestPoint(point: IVec): IVec {\n    const bound = Bound.deserialize(this.xywh);\n    return polygonNearestPoint(\n      rotatePoints(bound.points, bound.center, this.rotate ?? 0),\n      point\n    );\n  }\n\n  getRelativePointLocation(relativePoint: IVec): PointLocation {\n    const bound = Bound.deserialize(this.xywh);\n    const point = bound.getRelativePoint(relativePoint);\n    const rotatePoint = rotatePoints(\n      [point],\n      bound.center,\n      this.rotate ?? 0\n    )[0];\n    const points = rotatePoints(bound.points, bound.center, this.rotate ?? 0);\n    const tangent = polygonGetPointTangent(points, rotatePoint);\n\n    return new PointLocation(rotatePoint, tangent);\n  }\n\n  includesPoint(\n    x: number,\n    y: number,\n    opt: PointTestOptions,\n    __: EditorHost\n  ): boolean {\n    const bound = opt.useElementBound ? this.elementBound : this.responseBound;\n    return bound.isPointInBound([x, y], 0);\n  }\n\n  intersectsBound(bound: Bound): boolean {\n    return (\n      this.containsBound(bound) ||\n      bound.points.some((point, i, points) =>\n        this.getLineIntersections(point, points[(i + 1) % points.length])\n      )\n    );\n  }\n\n  isLocked(): boolean {\n    return isLockedImpl(this);\n  }\n\n  isLockedByAncestor(): boolean {\n    return isLockedByAncestorImpl(this);\n  }\n\n  isLockedBySelf(): boolean {\n    return isLockedBySelfImpl(this);\n  }\n\n  lock() {\n    lockElementImpl(this.store, this);\n  }\n\n  unlock() {\n    unlockElementImpl(this.store, this);\n  }\n}\n\n/**\n * Convert a BlockModel to a GfxBlockElementModel.\n * @param BlockModelSuperClass The BlockModel class to be converted.\n * @returns The returned class is a subclass of the GfxBlockElementModel class and the given BlockModelSuperClass.\n */\nexport function GfxCompatibleBlockModel<\n  Props extends GfxCompatibleProps,\n  T extends Constructor<BlockModel<Props>> = Constructor<BlockModel<Props>>,\n>(BlockModelSuperClass: T) {\n  if (BlockModelSuperClass === BlockModel) {\n    return GfxBlockElementModel as unknown as typeof GfxBlockElementModel<Props>;\n  } else {\n    let currentClass = BlockModelSuperClass;\n\n    while (\n      Object.getPrototypeOf(currentClass.prototype) !== BlockModel.prototype &&\n      Object.getPrototypeOf(currentClass.prototype) !== null\n    ) {\n      currentClass = Object.getPrototypeOf(currentClass.prototype).constructor;\n    }\n\n    if (Object.getPrototypeOf(currentClass.prototype) === null) {\n      throw new BlockSuiteError(\n        ErrorCode.GfxBlockElementError,\n        'The SuperClass is not a subclass of BlockModel'\n      );\n    }\n\n    Object.setPrototypeOf(\n      currentClass.prototype,\n      GfxBlockElementModel.prototype\n    );\n  }\n\n  return BlockModelSuperClass as unknown as typeof GfxBlockElementModel<Props>;\n}\n","import { createIdentifier } from '@blocksuite/global/di';\n\nimport type { Command } from './command/index.js';\nimport type { EventOptions, UIEventHandler } from './event/index.js';\nimport type { BlockService, LifeCycleWatcher } from './extension/index.js';\nimport type { BlockStdScope } from './scope/index.js';\nimport type { BlockViewType, WidgetViewType } from './spec/type.js';\n\nexport const BlockServiceIdentifier =\n  createIdentifier<BlockService>('BlockService');\n\nexport const BlockFlavourIdentifier = createIdentifier<{ flavour: string }>(\n  'BlockFlavour'\n);\n\nexport const CommandIdentifier = createIdentifier<Command>('Commands');\n\nexport const ConfigIdentifier =\n  createIdentifier<Record<string, unknown>>('Config');\n\nexport const BlockViewIdentifier = createIdentifier<BlockViewType>('BlockView');\n\nexport const WidgetViewIdentifier =\n  createIdentifier<WidgetViewType>('WidgetView');\n\nexport const LifeCycleWatcherIdentifier =\n  createIdentifier<LifeCycleWatcher>('LifeCycleWatcher');\n\nexport const StdIdentifier = createIdentifier<BlockStdScope>('Std');\n\nexport const KeymapIdentifier = createIdentifier<{\n  getter: (std: BlockStdScope) => Record<string, UIEventHandler>;\n  options?: EventOptions;\n}>('Keymap');\n","import type { ServiceIdentifier } from '@blocksuite/global/di';\n\nimport { LifeCycleWatcherIdentifier } from '../identifier.js';\nimport type { GfxController } from './controller.js';\n\nexport const gfxControllerKey = 'GfxController';\n\nexport const GfxControllerIdentifier = LifeCycleWatcherIdentifier(\n  gfxControllerKey\n) as ServiceIdentifier<GfxController>;\n","import {\n  Bound,\n  clamp,\n  type IPoint,\n  type IVec,\n  Vec,\n} from '@blocksuite/global/gfx';\nimport debounce from 'lodash-es/debounce';\nimport { BehaviorSubject, debounceTime, Subject } from 'rxjs';\n\nimport type { GfxViewportElement } from '.';\n\nfunction cutoff(value: number, ref: number, sign: number) {\n  if (sign > 0 && value > ref) return ref;\n  if (sign < 0 && value < ref) return ref;\n  return value;\n}\n\nexport const ZOOM_MAX = 6.0;\nexport const ZOOM_MIN = 0.1;\nexport const ZOOM_STEP = 0.25;\nexport const ZOOM_INITIAL = 1.0;\n\nexport const FIT_TO_SCREEN_PADDING = 100;\n\nexport interface ViewportRecord {\n  left: number;\n  top: number;\n  viewportX: number;\n  viewportY: number;\n  zoom: number;\n  viewScale: number;\n}\n\nexport function clientToModelCoord(\n  viewport: ViewportRecord,\n  clientCoord: [number, number]\n): IVec {\n  const { left, top, viewportX, viewportY, zoom, viewScale } = viewport;\n\n  const [clientX, clientY] = clientCoord;\n  const viewportInternalX = clientX - left;\n  const viewportInternalY = clientY - top;\n  const modelX = viewportX + viewportInternalX / zoom / viewScale;\n  const modelY = viewportY + viewportInternalY / zoom / viewScale;\n  return [modelX, modelY];\n}\n\nexport class Viewport {\n  private _cachedBoundingClientRect: DOMRect | null = null;\n\n  private _cachedOffsetWidth: number | null = null;\n\n  private _resizeObserver: ResizeObserver | null = null;\n\n  private readonly _resizeSubject = new Subject<{\n    width: number;\n    height: number;\n    left: number;\n    top: number;\n  }>();\n\n  private _isResizing = false;\n  private _initialTopLeft: IVec | null = null;\n\n  protected _center: IPoint = { x: 0, y: 0 };\n\n  protected _shell: HTMLElement | null = null;\n\n  protected _element: GfxViewportElement | null = null;\n\n  protected _height = 0;\n\n  protected _left = 0;\n\n  protected _locked = false;\n\n  protected _rafId: number | null = null;\n\n  protected _top = 0;\n\n  protected _width = 0;\n\n  protected _zoom: number = 1.0;\n\n  elementReady = new Subject<GfxViewportElement>();\n\n  sizeUpdated = new Subject<{\n    width: number;\n    height: number;\n    left: number;\n    top: number;\n  }>();\n\n  viewportMoved = new Subject<IVec>();\n\n  viewportUpdated = new Subject<{\n    zoom: number;\n    center: IVec;\n  }>();\n\n  zooming$ = new BehaviorSubject<boolean>(false);\n  panning$ = new BehaviorSubject<boolean>(false);\n\n  ZOOM_MAX = ZOOM_MAX;\n\n  ZOOM_MIN = ZOOM_MIN;\n\n  private readonly _resetZooming = debounce(() => {\n    this.zooming$.next(false);\n  }, 200);\n\n  private readonly _resetPanning = debounce(() => {\n    this.panning$.next(false);\n  }, 200);\n\n  constructor() {\n    const subscription = this.elementReady.subscribe(el => {\n      this._element = el;\n      subscription.unsubscribe();\n    });\n\n    this._setupResizeObserver();\n  }\n\n  private _setupResizeObserver() {\n    this._resizeSubject\n      .pipe(debounceTime(200))\n      .subscribe(({ width, height, left, top }) => {\n        if (!this._shell || !this._initialTopLeft) return;\n        this._completeResize(width, height, left, top);\n      });\n  }\n\n  private _completeResize(\n    width: number,\n    height: number,\n    left: number,\n    top: number\n  ) {\n    if (!this._initialTopLeft) return;\n\n    const [initialTopLeftX, initialTopLeftY] = this._initialTopLeft;\n    const newCenterX = initialTopLeftX + width / (2 * this.zoom);\n    const newCenterY = initialTopLeftY + height / (2 * this.zoom);\n\n    this.setCenter(newCenterX, newCenterY, false);\n    this._width = width;\n    this._height = height;\n    this._left = left;\n    this._top = top;\n    this._isResizing = false;\n    this._initialTopLeft = null;\n\n    this.sizeUpdated.next({\n      left,\n      top,\n      width,\n      height,\n    });\n  }\n\n  private _forceCompleteResize() {\n    if (this._isResizing && this._shell) {\n      const { width, height, left, top } = this.boundingClientRect;\n      this._completeResize(width, height, left, top);\n    }\n  }\n\n  get boundingClientRect() {\n    if (!this._shell) return new DOMRect(0, 0, 0, 0);\n    if (!this._cachedBoundingClientRect) {\n      this._cachedBoundingClientRect = this._shell.getBoundingClientRect();\n    }\n    return this._cachedBoundingClientRect;\n  }\n\n  get element() {\n    return this._element;\n  }\n\n  get center() {\n    return this._center;\n  }\n\n  get centerX() {\n    return this._center.x;\n  }\n\n  get centerY() {\n    return this._center.y;\n  }\n\n  get height() {\n    return this.boundingClientRect.height;\n  }\n\n  get left() {\n    return this._left;\n  }\n\n  // Does not allow the user to move and zoom the canvas in copilot tool\n  get locked() {\n    return this._locked;\n  }\n\n  set locked(locked: boolean) {\n    this._locked = locked;\n  }\n\n  /**\n   * Note this is different from the zoom property.\n   * The editor itself may be scaled by outer container which is common in nested editor scenarios.\n   * This property is used to calculate the scale of the editor.\n   */\n  get viewScale() {\n    if (\n      !this._shell ||\n      this._cachedOffsetWidth === null ||\n      this._cachedOffsetWidth === 0\n    )\n      return 1;\n    return this.boundingClientRect.width / this._cachedOffsetWidth;\n  }\n\n  get top() {\n    return this._top;\n  }\n\n  get translateX() {\n    return -this.viewportX * this.zoom;\n  }\n\n  get translateY() {\n    return -this.viewportY * this.zoom;\n  }\n\n  get viewportBounds() {\n    const { viewportMinXY, viewportMaxXY } = this;\n\n    return Bound.from({\n      ...viewportMinXY,\n      w: viewportMaxXY.x - viewportMinXY.x,\n      h: viewportMaxXY.y - viewportMinXY.y,\n    });\n  }\n\n  get viewportMaxXY() {\n    const { centerX, centerY, width, height, zoom } = this;\n    return {\n      x: centerX + width / 2 / zoom,\n      y: centerY + height / 2 / zoom,\n    };\n  }\n\n  get viewportMinXY() {\n    const { centerX, centerY, width, height, zoom } = this;\n    return {\n      x: centerX - width / 2 / zoom,\n      y: centerY - height / 2 / zoom,\n    };\n  }\n\n  get viewportX() {\n    const { centerX, width, zoom } = this;\n    return centerX - width / 2 / zoom;\n  }\n\n  get viewportY() {\n    const { centerY, height, zoom } = this;\n    return centerY - height / 2 / zoom;\n  }\n\n  get width() {\n    return this.boundingClientRect.width;\n  }\n\n  get zoom() {\n    return this._zoom;\n  }\n\n  applyDeltaCenter(deltaX: number, deltaY: number) {\n    this.setCenter(this.centerX + deltaX, this.centerY + deltaY);\n  }\n\n  clearViewportElement() {\n    if (this._resizeObserver && this._shell) {\n      this._resizeObserver.unobserve(this._shell);\n      this._resizeObserver.disconnect();\n    }\n    this._resizeObserver = null;\n    this._shell = null;\n    this._cachedBoundingClientRect = null;\n    this._cachedOffsetWidth = null;\n  }\n\n  dispose() {\n    this.clearViewportElement();\n    this.sizeUpdated.complete();\n    this.viewportMoved.complete();\n    this.viewportUpdated.complete();\n    this._resizeSubject.complete();\n    this.zooming$.complete();\n    this.panning$.complete();\n  }\n\n  getFitToScreenData(\n    bounds?: Bound | null,\n    padding: [number, number, number, number] = [0, 0, 0, 0],\n    maxZoom = ZOOM_MAX,\n    fitToScreenPadding = 100\n  ) {\n    let { centerX, centerY, zoom } = this;\n\n    if (!bounds) {\n      return { zoom, centerX, centerY };\n    }\n\n    const { x, y, w, h } = bounds;\n    const [pt, pr, pb, pl] = padding;\n    const { width, height } = this;\n\n    zoom = Math.min(\n      (width - fitToScreenPadding - (pr + pl)) / w,\n      (height - fitToScreenPadding - (pt + pb)) / h\n    );\n    zoom = clamp(zoom, ZOOM_MIN, clamp(maxZoom, ZOOM_MIN, ZOOM_MAX));\n\n    centerX = x + (w + pr / zoom) / 2 - pl / zoom / 2;\n    centerY = y + (h + pb / zoom) / 2 - pt / zoom / 2;\n\n    return { zoom, centerX, centerY };\n  }\n\n  isInViewport(bound: Bound) {\n    const viewportBounds = Bound.from(this.viewportBounds);\n    return (\n      viewportBounds.contains(bound) ||\n      viewportBounds.isIntersectWithBound(bound)\n    );\n  }\n\n  onResize() {\n    if (!this._shell) return;\n\n    if (!this._isResizing) {\n      this._isResizing = true;\n      this._initialTopLeft = this.toModelCoord(0, 0);\n    }\n\n    const { left, top, width, height } = this.boundingClientRect;\n    this._cachedOffsetWidth = this._shell.offsetWidth;\n\n    this._left = left;\n    this._top = top;\n    this._resizeSubject.next({\n      left,\n      top,\n      width,\n      height,\n    });\n  }\n\n  /**\n   * Set the center of the viewport.\n   * @param centerX The new x coordinate of the center of the viewport.\n   * @param centerY The new y coordinate of the center of the viewport.\n   * @param forceUpdate Whether to force complete any pending resize operations before setting the viewport.\n   */\n  setCenter(centerX: number, centerY: number, forceUpdate = true) {\n    if (forceUpdate && this._isResizing) {\n      this._forceCompleteResize();\n    }\n\n    this._center.x = centerX;\n    this._center.y = centerY;\n    this.panning$.next(true);\n    this.viewportUpdated.next({\n      zoom: this.zoom,\n      center: Vec.toVec(this.center) as IVec,\n    });\n    this._resetPanning();\n  }\n\n  setRect(left: number, top: number, width: number, height: number) {\n    if (this._isResizing) {\n      this._left = left;\n      this._top = top;\n      return;\n    }\n\n    this._left = left;\n    this._top = top;\n    this.sizeUpdated.next({\n      left,\n      top,\n      width,\n      height,\n    });\n  }\n\n  /**\n   * Set the viewport to the new zoom and center.\n   * @param newZoom The new zoom value.\n   * @param newCenter The new center of the viewport.\n   * @param smooth Whether to animate the zooming and panning.\n   * @param forceUpdate Whether to force complete any pending resize operations before setting the viewport.\n   */\n  setViewport(\n    newZoom: number,\n    newCenter = Vec.toVec(this.center),\n    smooth = false,\n    forceUpdate = true\n  ) {\n    // Force complete any pending resize operations if forceUpdate is true\n    if (forceUpdate && this._isResizing) {\n      this._forceCompleteResize();\n    }\n\n    const preZoom = this._zoom;\n    if (smooth) {\n      const cofficient = preZoom / newZoom;\n      if (cofficient === 1) {\n        this.smoothTranslate(newCenter[0], newCenter[1]);\n      } else {\n        const center = [this.centerX, this.centerY] as IVec;\n        const focusPoint = Vec.mul(\n          Vec.sub(newCenter, Vec.mul(center, cofficient)),\n          1 / (1 - cofficient)\n        );\n        this.smoothZoom(newZoom, Vec.toPoint(focusPoint));\n      }\n    } else {\n      this._center.x = newCenter[0];\n      this._center.y = newCenter[1];\n      this.setZoom(newZoom, undefined, false, forceUpdate);\n    }\n  }\n\n  /**\n   * Set the viewport to fit the bound with padding.\n   * @param bound The bound will be zoomed to fit the viewport.\n   * @param padding The padding will be applied to the bound after zooming, default is [0, 0, 0, 0],\n   *                the value may be reduced if there is not enough space for the padding.\n   *                Use decimal less than 1 to represent percentage padding. e.g. [0.1, 0.1, 0.1, 0.1] means 10% padding.\n   * @param smooth whether to animate the zooming\n   * @param forceUpdate whether to force complete any pending resize operations before setting the viewport\n   */\n  setViewportByBound(\n    bound: Bound,\n    padding: [number, number, number, number] = [0, 0, 0, 0],\n    smooth = false,\n    forceUpdate = true\n  ) {\n    let [pt, pr, pb, pl] = padding;\n\n    // Convert percentage padding to absolute values if they are between 0 and 1\n    if (pt > 0 && pt < 1) pt *= this.height;\n    if (pr > 0 && pr < 1) pr *= this.width;\n    if (pb > 0 && pb < 1) pb *= this.height;\n    if (pl > 0 && pl < 1) pl *= this.width;\n\n    // Calculate zoom\n    let zoom = Math.min(\n      (this.width - (pr + pl)) / bound.w,\n      (this.height - (pt + pb)) / bound.h\n    );\n\n    // Adjust padding if space is not enough\n    if (zoom < this.ZOOM_MIN) {\n      zoom = this.ZOOM_MIN;\n      const totalPaddingWidth = this.width - bound.w * zoom;\n      const totalPaddingHeight = this.height - bound.h * zoom;\n      pr = pl = Math.max(totalPaddingWidth / 2, 1);\n      pt = pb = Math.max(totalPaddingHeight / 2, 1);\n    }\n\n    // Ensure zoom does not exceed ZOOM_MAX\n    if (zoom > this.ZOOM_MAX) {\n      zoom = this.ZOOM_MAX;\n    }\n\n    const center = [\n      bound.x + (bound.w + pr / zoom) / 2 - pl / zoom / 2,\n      bound.y + (bound.h + pb / zoom) / 2 - pt / zoom / 2,\n    ] as IVec;\n\n    this.setViewport(zoom, center, smooth, forceUpdate);\n  }\n\n  /** This is the outer container of the viewport, which is the host of the viewport element */\n  setShellElement(el: HTMLElement) {\n    this._shell = el;\n    this._cachedBoundingClientRect = el.getBoundingClientRect();\n    this._cachedOffsetWidth = el.offsetWidth;\n\n    const { left, top, width, height } = this._cachedBoundingClientRect;\n    this.setRect(left, top, width, height);\n\n    this._resizeObserver = new ResizeObserver(() => {\n      this._cachedBoundingClientRect = null;\n      this._cachedOffsetWidth = null;\n      this.onResize();\n    });\n    this._resizeObserver.observe(el);\n  }\n\n  /**\n   * Set the viewport to the new zoom.\n   * @param zoom The new zoom value.\n   * @param focusPoint The point to focus on after zooming, default is the center of the viewport.\n   * @param wheel Whether the zoom is caused by wheel event.\n   * @param forceUpdate Whether to force complete any pending resize operations before setting the viewport.\n   */\n  setZoom(\n    zoom: number,\n    focusPoint?: IPoint,\n    wheel = false,\n    forceUpdate = true\n  ) {\n    if (forceUpdate && this._isResizing) {\n      this._forceCompleteResize();\n    }\n\n    const prevZoom = this.zoom;\n    focusPoint = (focusPoint ?? this._center) as IPoint;\n    this._zoom = clamp(zoom, this.ZOOM_MIN, this.ZOOM_MAX);\n    const newZoom = this.zoom;\n\n    const offset = Vec.sub(Vec.toVec(this.center), Vec.toVec(focusPoint));\n    const newCenter = Vec.add(\n      Vec.toVec(focusPoint),\n      Vec.mul(offset, prevZoom / newZoom)\n    );\n    if (wheel) {\n      this.zooming$.next(true);\n    }\n    this.setCenter(newCenter[0], newCenter[1], forceUpdate);\n    this.viewportUpdated.next({\n      zoom: this.zoom,\n      center: Vec.toVec(this.center) as IVec,\n    });\n    this._resetZooming();\n  }\n\n  smoothTranslate(x: number, y: number, numSteps = 10) {\n    const { center } = this;\n    const delta = { x: x - center.x, y: y - center.y };\n    const innerSmoothTranslate = () => {\n      if (this._rafId) cancelAnimationFrame(this._rafId);\n      this._rafId = requestAnimationFrame(() => {\n        const step = { x: delta.x / numSteps, y: delta.y / numSteps };\n        const nextCenter = {\n          x: this.centerX + step.x,\n          y: this.centerY + step.y,\n        };\n        const signX = delta.x > 0 ? 1 : -1;\n        const signY = delta.y > 0 ? 1 : -1;\n        nextCenter.x = cutoff(nextCenter.x, x, signX);\n        nextCenter.y = cutoff(nextCenter.y, y, signY);\n        this.setCenter(nextCenter.x, nextCenter.y, true);\n\n        if (nextCenter.x != x || nextCenter.y != y) innerSmoothTranslate();\n      });\n    };\n    innerSmoothTranslate();\n  }\n\n  smoothZoom(zoom: number, focusPoint?: IPoint, numSteps = 10) {\n    const delta = zoom - this.zoom;\n    if (this._rafId) cancelAnimationFrame(this._rafId);\n\n    const innerSmoothZoom = () => {\n      this._rafId = requestAnimationFrame(() => {\n        const sign = delta > 0 ? 1 : -1;\n        const step = delta / numSteps;\n        const nextZoom = cutoff(this.zoom + step, zoom, sign);\n\n        this.setZoom(nextZoom, focusPoint, undefined, true);\n\n        if (nextZoom != zoom) innerSmoothZoom();\n      });\n    };\n    innerSmoothZoom();\n  }\n\n  toModelBound(bound: Bound) {\n    const { w, h } = bound;\n    const [x, y] = this.toModelCoord(bound.x, bound.y);\n\n    return new Bound(x, y, w / this.zoom, h / this.zoom);\n  }\n\n  toModelCoord(\n    viewX: number,\n    viewY: number,\n    zoom = this.zoom,\n    center?: IPoint\n  ): IVec {\n    const { viewScale } = this;\n    const viewportX = center\n      ? center.x - this.width / 2 / zoom\n      : this.viewportX;\n    const viewportY = center\n      ? center.y - this.height / 2 / zoom\n      : this.viewportY;\n\n    return [\n      viewportX + viewX / zoom / viewScale,\n      viewportY + viewY / zoom / viewScale,\n    ];\n  }\n\n  toModelCoordFromClientCoord([x, y]: IVec): IVec {\n    return clientToModelCoord(this, [x, y]);\n  }\n\n  toViewBound(bound: Bound) {\n    const { w, h } = bound;\n    const [x, y] = this.toViewCoord(bound.x, bound.y);\n\n    return new Bound(x, y, w * this.zoom, h * this.zoom);\n  }\n\n  toViewCoord(modelX: number, modelY: number): IVec {\n    const { viewportX, viewportY, zoom, viewScale } = this;\n    return [\n      (modelX - viewportX) * zoom * viewScale,\n      (modelY - viewportY) * zoom * viewScale,\n    ];\n  }\n\n  toViewCoordFromClientCoord([x, y]: IVec): IVec {\n    const { left, top } = this;\n    return [x - left, y - top];\n  }\n\n  serializeRecord() {\n    return JSON.stringify({\n      left: this.left,\n      top: this.top,\n      viewportX: this.viewportX,\n      viewportY: this.viewportY,\n      zoom: this.zoom,\n      viewScale: this.viewScale,\n    });\n  }\n\n  deserializeRecord(record?: string) {\n    try {\n      const result = JSON.parse(record || '{}') as ViewportRecord;\n      if (!('zoom' in result)) return null;\n      return result;\n    } catch (error) {\n      console.error('Failed to deserialize viewport record:', error);\n      return null;\n    }\n  }\n}\n","import { BaseSelection, SelectionExtension } from '@blocksuite/store';\nimport z from 'zod';\n\nconst BlockSelectionSchema = z.object({\n  blockId: z.string(),\n});\n\nexport class BlockSelection extends BaseSelection {\n  static override group = 'note';\n\n  static override type = 'block';\n\n  static override fromJSON(json: Record<string, unknown>): BlockSelection {\n    const result = BlockSelectionSchema.parse(json);\n    return new BlockSelection(result);\n  }\n\n  override equals(other: BaseSelection): boolean {\n    if (other instanceof BlockSelection) {\n      return this.blockId === other.blockId;\n    }\n    return false;\n  }\n\n  override toJSON(): Record<string, unknown> {\n    return {\n      type: 'block',\n      blockId: this.blockId,\n    };\n  }\n}\n\nexport const BlockSelectionExtension = SelectionExtension(BlockSelection);\n","import { BaseSelection, SelectionExtension } from '@blocksuite/store';\nimport z from 'zod';\n\nconst SurfaceSelectionSchema = z.object({\n  blockId: z.string(),\n  elements: z.array(z.string()),\n  editing: z.boolean(),\n  inoperable: z.boolean().optional(),\n});\n\nexport class SurfaceSelection extends BaseSelection {\n  static override group = 'gfx';\n\n  static override type = 'surface';\n\n  static override recoverable = true;\n\n  readonly editing: boolean;\n\n  readonly elements: string[];\n\n  readonly inoperable: boolean;\n\n  constructor(\n    blockId: string,\n    elements: string[],\n    editing: boolean,\n    inoperable = false\n  ) {\n    super({ blockId });\n\n    this.elements = elements;\n    this.editing = editing;\n    this.inoperable = inoperable;\n  }\n\n  static override fromJSON(json: Record<string, unknown>): SurfaceSelection {\n    const { blockId, elements, editing, inoperable } =\n      SurfaceSelectionSchema.parse(json);\n    return new SurfaceSelection(blockId, elements, editing, inoperable);\n  }\n\n  override equals(other: BaseSelection): boolean {\n    if (other instanceof SurfaceSelection) {\n      return (\n        this.blockId === other.blockId &&\n        this.editing === other.editing &&\n        this.inoperable === other.inoperable &&\n        this.elements.length === other.elements.length &&\n        this.elements.every((id, idx) => id === other.elements[idx])\n      );\n    }\n\n    return false;\n  }\n\n  isEmpty() {\n    return this.elements.length === 0 && !this.editing;\n  }\n\n  override toJSON(): Record<string, unknown> {\n    return {\n      type: 'surface',\n      blockId: this.blockId,\n      elements: this.elements,\n      editing: this.editing,\n      inoperable: this.inoperable,\n    };\n  }\n}\n\nexport const SurfaceSelectionExtension = SelectionExtension(SurfaceSelection);\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport type { Constructor } from '@blocksuite/global/utils';\nimport type { LitElement } from 'lit';\n\ntype ValidatorFunction = (value: unknown) => boolean;\n\nexport const PropTypes = {\n  string: (value: unknown) => typeof value === 'string',\n  number: (value: unknown) => typeof value === 'number',\n  boolean: (value: unknown) => typeof value === 'boolean',\n  object: (value: unknown) => typeof value === 'object',\n  array: (value: unknown) => Array.isArray(value),\n  instanceOf: (expectedClass: Constructor) => (value: unknown) =>\n    value instanceof expectedClass,\n  arrayOf: (validator: ValidatorFunction) => (value: unknown) =>\n    Array.isArray(value) && value.every(validator),\n  recordOf: (validator: ValidatorFunction) => (value: unknown) => {\n    if (typeof value !== 'object' || value === null) return false;\n    return Object.values(value).every(validator);\n  },\n  of: (validator: ValidatorFunction) => (value: unknown) => validator(value),\n};\n\nfunction validatePropTypes<T extends InstanceType<Constructor>>(\n  instance: T,\n  propTypes: Record<string, ValidatorFunction>\n) {\n  for (const [propName, validator] of Object.entries(propTypes)) {\n    const key = propName as keyof T;\n    if (instance[key] === undefined) {\n      throw new BlockSuiteError(\n        ErrorCode.DefaultRuntimeError,\n        `Property ${propName} is required to ${instance.constructor.name}.`\n      );\n    }\n    if (validator && !validator(instance[key])) {\n      throw new BlockSuiteError(\n        ErrorCode.DefaultRuntimeError,\n        `Property ${propName} is invalid to ${instance.constructor.name}.`\n      );\n    }\n  }\n}\n\nexport function requiredProperties(\n  propTypes: Record<string, ValidatorFunction>\n) {\n  return function (constructor: Constructor<LitElement>) {\n    const connectedCallback = constructor.prototype.connectedCallback;\n\n    constructor.prototype.connectedCallback = function () {\n      if (connectedCallback) {\n        connectedCallback.call(this);\n      }\n      validatePropTypes(this, propTypes);\n    };\n  };\n}\n","/**\n * @license\n * Copyright 2023 Google LLC\n * SPDX-License-Identifier: BSD-3-Clause\n */\n\nimport { effect } from '@preact/signals-core';\nimport type { ReactiveElement } from 'lit';\n\ntype ReactiveElementConstructor = abstract new (\n  ...args: any[]\n) => ReactiveElement;\n\n/**\n * Adds the ability for a LitElement or other ReactiveElement class to\n * watch for access to Preact signals during the update lifecycle and\n * trigger a new update when signals values change.\n */\nexport function SignalWatcher<T extends ReactiveElementConstructor>(\n  Base: T\n): T {\n  abstract class SignalWatcher extends Base {\n    private __dispose?: () => void;\n\n    override connectedCallback(): void {\n      super.connectedCallback();\n      // In order to listen for signals again after re-connection, we must\n      // re-render to capture all the current signal accesses.\n      this.requestUpdate();\n    }\n\n    override disconnectedCallback(): void {\n      super.disconnectedCallback();\n      this.__dispose?.();\n    }\n\n    override performUpdate() {\n      // ReactiveElement.performUpdate() also does this check, so we want to\n      // also bail early so we don't erroneously appear to not depend on any\n      // signals.\n      if (this.isUpdatePending === false || this.isConnected === false) {\n        return;\n      }\n      // If we have a previous effect, dispose it\n      this.__dispose?.();\n\n      // Tracks whether the effect callback is triggered by this performUpdate\n      // call directly, or by a signal change.\n      let updateFromLit = true;\n\n      // We create a new effect to capture all signal access within the\n      // performUpdate phase (update, render, updated, etc) of the element.\n      // Q: Do we need to create a new effect each render?\n      // TODO: test various combinations of render triggers:\n      //  - from requestUpdate()\n      //  - from signals\n      //  - from both (do we get one or two re-renders)\n      // and see if we really need a new effect here.\n      this.__dispose = effect(() => {\n        if (updateFromLit) {\n          updateFromLit = false;\n          super.performUpdate();\n        } else {\n          // This branch is an effect run from Preact signals.\n          // This will cause another call into performUpdate, which will\n          // then create a new effect watching that update pass.\n          this.requestUpdate();\n        }\n      });\n    }\n  }\n  return SignalWatcher;\n}\n","import type { LitElement } from 'lit';\n\nimport { DisposableGroup } from '../disposable/index.js';\nimport type { Constructor } from '../utils/types.js';\n\n// See https://lit.dev/docs/composition/mixins/#mixins-in-typescript\n// This definition should be exported, see https://github.com/microsoft/TypeScript/issues/30355#issuecomment-839834550\nexport declare class DisposableClass {\n  protected _disposables: DisposableGroup;\n\n  readonly disposables: DisposableGroup;\n}\n\n/**\n * Mixin that adds a `_disposables: DisposableGroup` property to the class.\n *\n * The `_disposables` property is initialized in `connectedCallback` and disposed in `disconnectedCallback`.\n *\n * see https://lit.dev/docs/composition/mixins/\n *\n * @example\n * ```ts\n * class MyElement extends WithDisposable(ShadowlessElement) {\n *   onClick() {\n *     this._disposables.add(...);\n *   }\n * }\n * ```\n */\nexport function WithDisposable<T extends Constructor<LitElement>>(\n  SuperClass: T\n) {\n  class DerivedClass extends SuperClass {\n    protected _disposables = new DisposableGroup();\n\n    get disposables() {\n      return this._disposables;\n    }\n\n    override connectedCallback() {\n      super.connectedCallback();\n      if (this._disposables.disposed) {\n        this._disposables = new DisposableGroup();\n      }\n    }\n\n    override disconnectedCallback() {\n      super.disconnectedCallback();\n      this._disposables.dispose();\n    }\n  }\n  return DerivedClass as unknown as T & Constructor<DisposableClass>;\n}\n","import type { BlockModel } from '@blocksuite/store';\nimport { createContext } from '@lit/context';\n\nimport type { BlockService } from '../../extension/index.js';\n\nexport const modelContext = createContext<BlockModel>('model');\nexport const serviceContext = createContext<BlockService>('service');\nexport const blockComponentSymbol = Symbol('blockComponent');\nexport const WIDGET_ID_ATTR = 'data-widget-id';\nexport const BLOCK_ID_ATTR = 'data-block-id';\n","import type { Constructor } from '@blocksuite/global/utils';\nimport type { CSSResultGroup, CSSResultOrNative } from 'lit';\nimport { CSSResult, LitElement } from 'lit';\n\nexport class ShadowlessElement extends LitElement {\n  // Map of the number of styles injected into a node\n  // A reference count of the number of ShadowlessElements that are still connected\n  static connectedCount = new WeakMap<\n    Constructor, // class\n    WeakMap<Node, number>\n  >();\n\n  static onDisconnectedMap = new WeakMap<\n    Constructor, // class\n    WeakMap<Node, (() => void) | null>\n  >();\n\n  // styles registered in ShadowlessElement will be available globally\n  // even if the element is not being rendered\n  protected static override finalizeStyles(\n    styles?: CSSResultGroup\n  ): CSSResultOrNative[] {\n    const elementStyles = super.finalizeStyles(styles);\n    // XXX: This breaks component encapsulation and applies styles to the document.\n    // These styles should be manually scoped.\n    elementStyles.forEach((s: CSSResultOrNative) => {\n      if (s instanceof CSSResult && typeof document !== 'undefined') {\n        const styleRoot = document.head;\n        const style = document.createElement('style');\n        style.textContent = s.cssText;\n        styleRoot.append(style);\n      }\n    });\n    return elementStyles;\n  }\n\n  private getConnectedCount() {\n    const SE = this.constructor as typeof ShadowlessElement;\n    return SE.connectedCount.get(SE)?.get(this.getRootNode()) ?? 0;\n  }\n\n  private setConnectedCount(count: number) {\n    const SE = this.constructor as typeof ShadowlessElement;\n\n    if (!SE.connectedCount.has(SE)) {\n      SE.connectedCount.set(SE, new WeakMap());\n    }\n\n    SE.connectedCount.get(SE)?.set(this.getRootNode(), count);\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n    const parentRoot = this.getRootNode();\n    const SE = this.constructor as typeof ShadowlessElement;\n    const insideShadowRoot = parentRoot instanceof ShadowRoot;\n    const styleInjectedCount = this.getConnectedCount();\n\n    if (styleInjectedCount === 0 && insideShadowRoot) {\n      const elementStyles = SE.elementStyles;\n      const injectedStyles: HTMLStyleElement[] = [];\n      elementStyles.forEach((s: CSSResultOrNative) => {\n        if (s instanceof CSSResult && typeof document !== 'undefined') {\n          const style = document.createElement('style');\n          style.textContent = s.cssText;\n          parentRoot.prepend(style);\n          injectedStyles.push(style);\n        }\n      });\n      if (!SE.onDisconnectedMap.has(SE)) {\n        SE.onDisconnectedMap.set(SE, new WeakMap());\n      }\n      SE.onDisconnectedMap.get(SE)?.set(parentRoot, () => {\n        injectedStyles.forEach(style => style.remove());\n      });\n    }\n    this.setConnectedCount(styleInjectedCount + 1);\n  }\n\n  override createRenderRoot() {\n    return this;\n  }\n\n  override disconnectedCallback(): void {\n    const parentRoot = this.getRootNode();\n    super.disconnectedCallback();\n    const SE = this.constructor as typeof ShadowlessElement;\n    let styleInjectedCount = this.getConnectedCount();\n    styleInjectedCount--;\n    this.setConnectedCount(styleInjectedCount);\n\n    if (styleInjectedCount === 0) {\n      // remove the style element when the last shadowless element is disconnected in the parent root\n      SE.onDisconnectedMap.get(SE)?.get(parentRoot)?.();\n    }\n  }\n}\n","import {\n  BlockSuiteError,\n  ErrorCode,\n  handleError,\n} from '@blocksuite/global/exceptions';\nimport { SignalWatcher, WithDisposable } from '@blocksuite/global/lit';\nimport {\n  type BlockModel,\n  Store,\n  type StoreSelectionExtension,\n} from '@blocksuite/store';\nimport { createContext, provide } from '@lit/context';\nimport { css, LitElement, nothing, type TemplateResult } from 'lit';\nimport { property } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { html, type StaticValue, unsafeStatic } from 'lit/static-html.js';\n\nimport type { CommandManager } from '../../command/index.js';\nimport type { UIEventDispatcher } from '../../event/index.js';\nimport { WidgetViewIdentifier } from '../../identifier.js';\nimport type { RangeManager } from '../../inline/index.js';\nimport type { BlockStdScope } from '../../scope/std-scope.js';\nimport { PropTypes, requiredProperties } from '../decorators/index.js';\nimport type { ViewStore } from '../view-store.js';\nimport { BLOCK_ID_ATTR, WIDGET_ID_ATTR } from './consts.js';\nimport { ShadowlessElement } from './shadowless-element.js';\n\nexport const storeContext = createContext<Store>('store');\nexport const stdContext = createContext<BlockStdScope>('std');\n\n@requiredProperties({\n  store: PropTypes.instanceOf(Store),\n  std: PropTypes.object,\n})\nexport class EditorHost extends SignalWatcher(\n  WithDisposable(ShadowlessElement)\n) {\n  static override styles = css`\n    editor-host {\n      outline: none;\n      isolation: isolate;\n      display: block;\n      height: 100%;\n    }\n  `;\n\n  private readonly _renderModel = (model: BlockModel): TemplateResult => {\n    const { flavour } = model;\n    const block = this.store.getBlock(model.id);\n    if (!block || block.blockViewType === 'hidden') {\n      return html`${nothing}`;\n    }\n    const schema = this.store.schema.flavourSchemaMap.get(flavour);\n    const view = this.std.getView(flavour);\n    if (!schema || !view) {\n      console.warn(`Cannot find render flavour ${flavour}.`);\n      return html`${nothing}`;\n    }\n\n    const widgetViews = this.std.provider.getAll(WidgetViewIdentifier);\n    const widgets = Array.from(widgetViews.entries()).reduce(\n      (mapping, [key, tag]) => {\n        const [widgetFlavour, id] = key.split('|');\n        if (widgetFlavour === flavour) {\n          const template = html`<${tag} ${unsafeStatic(WIDGET_ID_ATTR)}=${id}></${tag}>`;\n          mapping[id] = template;\n        }\n        return mapping;\n      },\n      {} as Record<string, TemplateResult>\n    );\n\n    const tag = typeof view === 'function' ? view(model) : view;\n    return html`<${tag}\n      ${unsafeStatic(BLOCK_ID_ATTR)}=${model.id}\n      .widgets=${widgets}\n      .viewType=${block.blockViewType}\n    ></${tag}>`;\n  };\n\n  renderChildren = (\n    model: BlockModel,\n    filter?: (model: BlockModel) => boolean\n  ): TemplateResult => {\n    return html`${repeat(\n      model.children.filter(filter ?? (() => true)),\n      child => child.id,\n      child => this._renderModel(child)\n    )}`;\n  };\n\n  get command(): CommandManager {\n    return this.std.command;\n  }\n\n  get event(): UIEventDispatcher {\n    return this.std.event;\n  }\n\n  get range(): RangeManager {\n    return this.std.range;\n  }\n\n  get selection(): StoreSelectionExtension {\n    return this.std.selection;\n  }\n\n  get view(): ViewStore {\n    return this.std.view;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    if (!this.store.root) {\n      throw new BlockSuiteError(\n        ErrorCode.NoRootModelError,\n        'This doc is missing root block. Please initialize the default block structure before connecting the editor to DOM.'\n      );\n    }\n\n    this.std.mount();\n    this.tabIndex = 0;\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    this.std.unmount();\n  }\n\n  override async getUpdateComplete(): Promise<boolean> {\n    try {\n      const result = await super.getUpdateComplete();\n      const rootModel = this.store.root;\n      if (!rootModel) return result;\n\n      const view = this.std.getView(rootModel.flavour);\n      if (!view) return result;\n\n      const widgetViews = this.std.provider.getAll(\n        WidgetViewIdentifier(rootModel.flavour)\n      );\n      const widgetTags = Object.entries(widgetViews).reduce(\n        (mapping, [key, tag]) => {\n          const [widgetFlavour, id] = key.split('|');\n          if (widgetFlavour === rootModel.flavour) {\n            mapping[id] = tag;\n          }\n          return mapping;\n        },\n        {} as Record<string, StaticValue>\n      );\n      const elementsTags: StaticValue[] = [\n        typeof view === 'function' ? view(rootModel) : view,\n        ...Object.values(widgetTags),\n      ];\n      await Promise.all(\n        elementsTags.map(tag => {\n          const element = this.renderRoot.querySelector(tag._$litStatic$);\n          if (element instanceof LitElement) {\n            return element.updateComplete;\n          }\n          return null;\n        })\n      );\n      return result;\n    } catch (e) {\n      if (e instanceof Error) {\n        handleError(e);\n      } else {\n        console.error(e);\n      }\n      return true;\n    }\n  }\n\n  override render() {\n    const { root } = this.store;\n    if (!root) return nothing;\n\n    return this._renderModel(root);\n  }\n\n  @provide({ context: storeContext })\n  @property({ attribute: false })\n  accessor store!: Store;\n\n  @provide({ context: stdContext })\n  @property({ attribute: false })\n  accessor std!: BlockStdScope;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'editor-host': EditorHost;\n  }\n}\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { SignalWatcher, WithDisposable } from '@blocksuite/global/lit';\nimport { type BlockModel, type BlockViewType, Store } from '@blocksuite/store';\nimport { consume, provide } from '@lit/context';\nimport { computed } from '@preact/signals-core';\nimport { nothing, type TemplateResult } from 'lit';\nimport { property, state } from 'lit/decorators.js';\nimport { choose } from 'lit/directives/choose.js';\nimport { when } from 'lit/directives/when.js';\nimport { html } from 'lit/static-html.js';\n\nimport type { EventName, UIEventHandler } from '../../event/index.js';\nimport type { BlockService } from '../../extension/index.js';\nimport { BlockServiceIdentifier } from '../../identifier.js';\nimport type { BlockStdScope } from '../../scope/index.js';\nimport { BlockSelection } from '../../selection/index.js';\nimport { PropTypes, requiredProperties } from '../decorators/index.js';\nimport {\n  blockComponentSymbol,\n  modelContext,\n  serviceContext,\n} from './consts.js';\nimport { stdContext, storeContext } from './lit-host.js';\nimport { ShadowlessElement } from './shadowless-element.js';\nimport type { WidgetComponent } from './widget-component.js';\n\n@requiredProperties({\n  store: PropTypes.instanceOf(Store),\n  std: PropTypes.object,\n  widgets: PropTypes.recordOf(PropTypes.object),\n})\nexport class BlockComponent<\n  Model extends BlockModel = BlockModel,\n  Service extends BlockService = BlockService,\n  WidgetName extends string = string,\n> extends SignalWatcher(WithDisposable(ShadowlessElement)) {\n  @consume({ context: stdContext })\n  accessor std!: BlockStdScope;\n\n  selected$ = computed(() => {\n    const selection = this.std.selection.value.find(\n      selection => selection.blockId === this.model?.id\n    );\n    if (!selection) return false;\n    return selection.is(BlockSelection);\n  });\n\n  [blockComponentSymbol] = true;\n\n  handleEvent = (\n    name: EventName,\n    handler: UIEventHandler,\n    options?: { global?: boolean; flavour?: boolean }\n  ) => {\n    this._disposables.add(\n      this.std.event.add(name, handler, {\n        flavour: options?.global\n          ? undefined\n          : options?.flavour\n            ? this.model?.flavour\n            : undefined,\n        blockId: options?.global || options?.flavour ? undefined : this.blockId,\n      })\n    );\n  };\n\n  get blockId() {\n    return this.dataset.blockId as string;\n  }\n\n  get childBlocks() {\n    const childModels = this.model.children;\n    return childModels\n      .map(child => {\n        return this.std.view.getBlock(child.id);\n      })\n      .filter((x): x is BlockComponent => !!x);\n  }\n\n  get flavour(): string {\n    return this.model.flavour;\n  }\n\n  get host() {\n    return this.std.host;\n  }\n\n  get isVersionMismatch() {\n    const schema = this.store.schema.flavourSchemaMap.get(this.model.flavour);\n    if (!schema) {\n      console.warn(\n        `Schema not found for block ${this.model.id}, flavour ${this.model.flavour}`\n      );\n      return true;\n    }\n    const expectedVersion = schema.version;\n    const actualVersion = this.model.version;\n    if (expectedVersion !== actualVersion) {\n      console.warn(\n        `Version mismatch for block ${this.model.id}, expected ${expectedVersion}, actual ${actualVersion}`\n      );\n      return true;\n    }\n\n    return false;\n  }\n\n  get model() {\n    if (this._model) {\n      return this._model;\n    }\n    const model = this.store.getModelById<Model>(this.blockId);\n    if (!model) {\n      throw new BlockSuiteError(\n        ErrorCode.MissingViewModelError,\n        `Cannot find block model for id ${this.blockId}`\n      );\n    }\n    this._model = model;\n    return model;\n  }\n\n  get parentComponent(): BlockComponent | null {\n    const parent = this.model.parent;\n    if (!parent) return null;\n    return this.std.view.getBlock(parent.id);\n  }\n\n  get renderChildren() {\n    return this.host.renderChildren.bind(this);\n  }\n\n  get rootComponent(): BlockComponent | null {\n    const rootId = this.store.root?.id;\n    if (!rootId) {\n      return null;\n    }\n    const rootComponent = this.std.view.getBlock(rootId);\n    return rootComponent ?? null;\n  }\n\n  get selection() {\n    return this.std.selection;\n  }\n\n  get service(): Service {\n    if (this._service) {\n      return this._service;\n    }\n    const service = this.std.getOptional(\n      BlockServiceIdentifier(this.model.flavour)\n    );\n    this._service = service as Service;\n    return service as Service;\n  }\n\n  get topContenteditableElement(): BlockComponent | null {\n    return this.rootComponent;\n  }\n\n  get widgetComponents(): Partial<Record<WidgetName, WidgetComponent>> {\n    return Object.keys(this.widgets).reduce(\n      (mapping, key) => ({\n        ...mapping,\n        [key]: this.std.view.getWidget(key, this.blockId),\n      }),\n      {}\n    );\n  }\n\n  private _renderMismatchBlock(content: unknown) {\n    return when(\n      this.isVersionMismatch,\n      () => {\n        const actualVersion = this.model.version;\n        const schema = this.store.schema.flavourSchemaMap.get(\n          this.model.flavour\n        );\n        const expectedVersion = schema?.version ?? -1;\n        return this.renderVersionMismatch(expectedVersion, actualVersion);\n      },\n      () => content\n    );\n  }\n\n  private _renderViewType(content: unknown) {\n    return choose(this.viewType, [\n      ['display', () => content],\n      ['hidden', () => nothing],\n      ['bypass', () => this.renderChildren(this.model)],\n    ]);\n  }\n\n  addRenderer(renderer: (content: unknown) => unknown) {\n    this._renderers.push(renderer);\n  }\n\n  bindHotKey(\n    keymap: Record<string, UIEventHandler>,\n    options?: { global?: boolean; flavour?: boolean }\n  ) {\n    const dispose = this.std.event.bindHotkey(keymap, {\n      flavour: options?.global\n        ? undefined\n        : options?.flavour\n          ? this.model.flavour\n          : undefined,\n      blockId: options?.global || options?.flavour ? undefined : this.blockId,\n    });\n    this._disposables.add(dispose);\n    return dispose;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.std.view.setBlock(this);\n\n    const disposable = this.std.store.slots.blockUpdated.subscribe(\n      ({ type, id }) => {\n        if (id === this.model.id && type === 'delete') {\n          this.std.view.deleteBlock(this);\n          disposable.unsubscribe();\n        }\n      }\n    );\n    this._disposables.add(disposable);\n\n    this._disposables.add(\n      this.model.propsUpdated.subscribe(() => {\n        this.requestUpdate();\n      })\n    );\n  }\n\n  protected override async getUpdateComplete(): Promise<boolean> {\n    const result = await super.getUpdateComplete();\n    await Promise.all(this.childBlocks.map(el => el.updateComplete));\n    return result;\n  }\n\n  override render() {\n    return this._renderers.reduce(\n      (acc, cur) => cur.call(this, acc),\n      nothing as unknown\n    );\n  }\n\n  renderBlock(): unknown {\n    return nothing;\n  }\n\n  /**\n   * Render a warning message when the block version is mismatched.\n   * @param expectedVersion If the schema is not found, the expected version is -1.\n   *        Which means the block is not supported in the current editor.\n   * @param actualVersion The version of the block's crdt data.\n   */\n  renderVersionMismatch(\n    expectedVersion: number,\n    actualVersion: number\n  ): TemplateResult {\n    return html`\n      <dl class=\"version-mismatch-warning\" contenteditable=\"false\">\n        <dt>\n          <h4>Block Version Mismatched</h4>\n        </dt>\n        <dd>\n          <p>\n            We can not render this <var>${this.model.flavour}</var> block\n            because the version is mismatched.\n          </p>\n          <p>Editor version: <var>${expectedVersion}</var></p>\n          <p>Data version: <var>${actualVersion}</var></p>\n        </dd>\n      </dl>\n    `;\n  }\n\n  @provide({ context: modelContext as never })\n  @state()\n  private accessor _model: Model | null = null;\n\n  @state()\n  protected accessor _renderers: Array<(content: unknown) => unknown> = [\n    this.renderBlock,\n    this._renderMismatchBlock,\n    this._renderViewType,\n  ];\n\n  @provide({ context: serviceContext as never })\n  @state()\n  private accessor _service: Service | null = null;\n\n  @consume({ context: storeContext })\n  accessor store!: Store;\n\n  @property({ attribute: false })\n  accessor viewType: BlockViewType = 'display';\n\n  @property({\n    attribute: false,\n    hasChanged(value, oldValue) {\n      if (!value || !oldValue) {\n        return value !== oldValue;\n      }\n      // Is empty object\n      if (!Object.keys(value).length && !Object.keys(oldValue).length) {\n        return false;\n      }\n      return value !== oldValue;\n    },\n  })\n  accessor widgets!: Record<WidgetName, TemplateResult>;\n}\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { Bound } from '@blocksuite/global/gfx';\nimport { computed, effect, signal } from '@preact/signals-core';\nimport { nothing } from 'lit';\n\nimport type { BlockService } from '../../extension/index.js';\nimport { GfxControllerIdentifier } from '../../gfx/identifiers.js';\nimport type {\n  BoxSelectionContext,\n  DragMoveContext,\n  GfxViewTransformInterface,\n} from '../../gfx/interactivity/index.js';\nimport type { GfxBlockElementModel } from '../../gfx/model/gfx-block-model.js';\nimport { SurfaceSelection } from '../../selection/index.js';\nimport { BlockComponent } from './block-component.js';\n\nexport function isGfxBlockComponent(\n  element: unknown\n): element is GfxBlockComponent {\n  return (element as GfxBlockComponent)?.[GfxElementSymbol] === true;\n}\n\nexport const GfxElementSymbol = Symbol('GfxElement');\n\nfunction updateTransform(element: GfxBlockComponent) {\n  if (element.transformState$.value === 'idle') return;\n\n  const { viewport } = element.gfx;\n  element.dataset.viewportState = viewport.serializeRecord();\n  element.style.transformOrigin = '0 0';\n  element.style.transform = element.getCSSTransform();\n}\n\nfunction updateBlockVisibility(view: GfxBlockComponent) {\n  if (view.transformState$.value === 'active') {\n    view.style.visibility = 'visible';\n    view.style.pointerEvents = 'auto';\n    view.classList.remove('block-idle');\n    view.classList.add('block-active');\n  } else {\n    view.style.visibility = 'hidden';\n    view.style.pointerEvents = 'none';\n    view.classList.remove('block-active');\n    view.classList.add('block-idle');\n  }\n}\n\nfunction handleGfxConnection(instance: GfxBlockComponent) {\n  instance.style.position = 'absolute';\n\n  instance.disposables.add(\n    instance.gfx.viewport.viewportUpdated.subscribe(() => {\n      updateTransform(instance);\n    })\n  );\n\n  instance.disposables.add(\n    instance.store.slots.blockUpdated.subscribe(({ type, id }) => {\n      if (id === instance.model.id && type === 'update') {\n        updateTransform(instance);\n      }\n    })\n  );\n\n  instance.disposables.add(\n    effect(() => {\n      updateBlockVisibility(instance);\n      updateTransform(instance);\n    })\n  );\n}\n\nexport abstract class GfxBlockComponent<\n    Model extends GfxBlockElementModel = GfxBlockElementModel,\n    Service extends BlockService = BlockService,\n    WidgetName extends string = string,\n  >\n  extends BlockComponent<Model, Service, WidgetName>\n  implements GfxViewTransformInterface\n{\n  [GfxElementSymbol] = true;\n\n  readonly transformState$ = signal<'idle' | 'active'>('active');\n\n  get gfx() {\n    return this.std.get(GfxControllerIdentifier);\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n    handleGfxConnection(this);\n  }\n\n  onDragMove = ({ dx, dy, currentBound }: DragMoveContext) => {\n    this.model.xywh = currentBound.moveDelta(dx, dy).serialize();\n  };\n\n  onDragStart() {\n    this.model.stash('xywh');\n  }\n\n  onDragEnd() {\n    this.model.pop('xywh');\n  }\n\n  onBoxSelected(_: BoxSelectionContext) {}\n\n  getCSSTransform() {\n    const viewport = this.gfx.viewport;\n    const { translateX, translateY, zoom } = viewport;\n    const bound = Bound.deserialize(this.model.xywh);\n\n    const scaledX = bound.x * zoom;\n    const scaledY = bound.y * zoom;\n    const deltaX = scaledX - bound.x;\n    const deltaY = scaledY - bound.y;\n\n    return `translate(${translateX + deltaX}px, ${translateY + deltaY}px) scale(${zoom})`;\n  }\n\n  getRenderingRect() {\n    const { xywh$ } = this.model;\n\n    if (!xywh$) {\n      throw new BlockSuiteError(\n        ErrorCode.GfxBlockElementError,\n        `Error on rendering '${this.model.flavour}': Gfx block's model should have 'xywh' property.`\n      );\n    }\n\n    const [x, y, w, h] = JSON.parse(xywh$.value);\n\n    return { x, y, w, h, zIndex: this.toZIndex() };\n  }\n\n  override renderBlock() {\n    const { x, y, w, h, zIndex } = this.getRenderingRect();\n\n    if (this.style.left !== `${x}px`) this.style.left = `${x}px`;\n    if (this.style.top !== `${y}px`) this.style.top = `${y}px`;\n    if (this.style.width !== `${w}px`) this.style.width = `${w}px`;\n    if (this.style.height !== `${h}px`) this.style.height = `${h}px`;\n    if (this.style.zIndex !== zIndex) this.style.zIndex = zIndex;\n\n    return this.renderGfxBlock();\n  }\n\n  renderGfxBlock(): unknown {\n    return nothing;\n  }\n\n  renderPageContent(): unknown {\n    return nothing;\n  }\n\n  override async scheduleUpdate() {\n    const parent = this.parentElement;\n\n    if (this.hasUpdated || !parent || !('scheduleUpdateChildren' in parent)) {\n      return super.scheduleUpdate();\n    } else {\n      await (parent.scheduleUpdateChildren as (id: string) => Promise<void>)(\n        this.model.id\n      );\n\n      return super.scheduleUpdate();\n    }\n  }\n\n  toZIndex(): string {\n    return this.gfx.layer.getZIndex(this.model).toString() ?? '0';\n  }\n\n  updateZIndex(): void {\n    this.style.zIndex = this.toZIndex();\n  }\n}\n\nexport function toGfxBlockComponent<\n  Model extends GfxBlockElementModel,\n  Service extends BlockService,\n  WidgetName extends string,\n  B extends typeof BlockComponent<Model, Service, WidgetName>,\n>(CustomBlock: B) {\n  // @ts-expect-error ignore\n  return class extends CustomBlock {\n    [GfxElementSymbol] = true;\n\n    readonly transformState$ = signal<'idle' | 'active'>('active');\n\n    override selected$ = computed(() => {\n      const selection = this.std.selection.value.find(\n        selection => selection.blockId === this.model?.id\n      );\n      if (!selection) return false;\n      return selection.is(SurfaceSelection);\n    });\n\n    onDragMove({ dx, dy, currentBound }: DragMoveContext) {\n      this.model.xywh = currentBound.moveDelta(dx, dy).serialize();\n    }\n\n    onDragStart() {\n      this.model.stash('xywh');\n    }\n\n    onDragEnd() {\n      this.model.pop('xywh');\n    }\n\n    onBoxSelected(_: BoxSelectionContext) {}\n\n    get gfx() {\n      return this.std.get(GfxControllerIdentifier);\n    }\n\n    override connectedCallback(): void {\n      super.connectedCallback();\n      handleGfxConnection(this);\n    }\n\n    // eslint-disable-next-line sonarjs/no-identical-functions\n    getCSSTransform() {\n      const viewport = this.gfx.viewport;\n      const { translateX, translateY, zoom } = viewport;\n      const bound = Bound.deserialize(this.model.xywh);\n\n      const scaledX = bound.x * zoom;\n      const scaledY = bound.y * zoom;\n      const deltaX = scaledX - bound.x;\n      const deltaY = scaledY - bound.y;\n\n      return `translate(${translateX + deltaX}px, ${translateY + deltaY}px) scale(${zoom})`;\n    }\n\n    // eslint-disable-next-line sonarjs/no-identical-functions\n    getRenderingRect(): {\n      x: number;\n      y: number;\n      w: number | string;\n      h: number | string;\n      zIndex: string;\n    } {\n      const { xywh$ } = this.model;\n\n      if (!xywh$) {\n        throw new BlockSuiteError(\n          ErrorCode.GfxBlockElementError,\n          `Error on rendering '${this.model.flavour}': Gfx block's model should have 'xywh' property.`\n        );\n      }\n\n      const [x, y, w, h] = JSON.parse(xywh$.value);\n\n      return { x, y, w, h, zIndex: this.toZIndex() };\n    }\n\n    override renderBlock() {\n      const { x, y, w, h, zIndex } = this.getRenderingRect();\n\n      this.style.left = `${x}px`;\n      this.style.top = `${y}px`;\n      this.style.width = typeof w === 'number' ? `${w}px` : w;\n      this.style.height = typeof h === 'number' ? `${h}px` : h;\n      this.style.zIndex = zIndex;\n\n      return this.renderGfxBlock();\n    }\n\n    renderGfxBlock(): unknown {\n      return this.renderPageContent();\n    }\n\n    renderPageContent() {\n      return super.renderBlock();\n    }\n\n    // eslint-disable-next-line sonarjs/no-identical-functions\n    override async scheduleUpdate() {\n      const parent = this.parentElement;\n\n      if (this.hasUpdated || !parent || !('scheduleUpdateChildren' in parent)) {\n        return super.scheduleUpdate();\n      } else {\n        await (parent.scheduleUpdateChildren as (id: string) => Promise<void>)(\n          this.model.id\n        );\n\n        return super.scheduleUpdate();\n      }\n    }\n\n    toZIndex(): string {\n      return this.gfx.layer.getZIndex(this.model).toString() ?? '0';\n    }\n\n    updateZIndex(): void {\n      this.style.zIndex = this.toZIndex();\n    }\n  } as B & {\n    new (...args: any[]): GfxBlockComponent;\n  };\n}\n","import { WithDisposable } from '@blocksuite/global/lit';\nimport { batch } from '@preact/signals-core';\nimport { css, html } from 'lit';\nimport { property } from 'lit/decorators.js';\n\nimport {\n  type EditorHost,\n  isGfxBlockComponent,\n  ShadowlessElement,\n} from '../view';\nimport { PropTypes, requiredProperties } from '../view/decorators/required';\nimport { GfxControllerIdentifier } from './identifiers';\nimport { GfxBlockElementModel } from './model/gfx-block-model';\nimport { Viewport } from './viewport';\n\n/**\n * A wrapper around `requestConnectedFrame` that only calls at most once in one frame\n */\nexport function requestThrottledConnectedFrame<\n  T extends (...args: unknown[]) => void,\n>(func: T, element?: HTMLElement): T {\n  let raqId: number | undefined = undefined;\n  let latestArgs: unknown[] = [];\n\n  return ((...args: unknown[]) => {\n    latestArgs = args;\n\n    if (raqId === undefined) {\n      raqId = requestAnimationFrame(() => {\n        raqId = undefined;\n\n        if (!element || element.isConnected) {\n          func(...latestArgs);\n        }\n      });\n    }\n  }) as T;\n}\n\n@requiredProperties({\n  viewport: PropTypes.instanceOf(Viewport),\n})\nexport class GfxViewportElement extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    gfx-viewport {\n      position: absolute;\n      left: 0;\n      top: 0;\n      contain: size layout style;\n      display: block;\n      transform: none;\n    }\n\n    /* CSS for idle blocks that are hidden but maintain layout */\n    .block-idle {\n      visibility: hidden;\n      pointer-events: none;\n      will-change: transform;\n      contain: size layout style;\n    }\n\n    /* CSS for active blocks participating in viewport transformations */\n    .block-active {\n      visibility: visible;\n      pointer-events: auto;\n    }\n  `;\n\n  private readonly _hideOutsideAndNoSelectedBlock = () => {\n    if (!this.host) return;\n\n    const gfx = this.host.std.get(GfxControllerIdentifier);\n    const currentViewportModels = this.getModelsInViewport();\n    const currentSelectedModels = this._getSelectedModels();\n    const shouldBeVisible = new Set([\n      ...currentViewportModels,\n      ...currentSelectedModels,\n    ]);\n\n    const previousVisible = this._lastVisibleModels\n      ? new Set(this._lastVisibleModels)\n      : new Set<GfxBlockElementModel>();\n\n    batch(() => {\n      // Step 1: Activate all the blocks that should be visible\n      shouldBeVisible.forEach(model => {\n        const view = gfx.view.get(model);\n        if (!isGfxBlockComponent(view)) return;\n        view.transformState$.value = 'active';\n      });\n\n      // Step 2: Hide all the blocks that should not be visible\n      previousVisible.forEach(model => {\n        if (shouldBeVisible.has(model)) return;\n\n        const view = gfx.view.get(model);\n        if (!isGfxBlockComponent(view)) return;\n        view.transformState$.value = 'idle';\n      });\n    });\n\n    this._lastVisibleModels = shouldBeVisible;\n  };\n\n  private _lastVisibleModels?: Set<GfxBlockElementModel>;\n\n  private readonly _pendingChildrenUpdates: {\n    id: string;\n    resolve: () => void;\n  }[] = [];\n\n  private readonly _refreshViewport = requestThrottledConnectedFrame(() => {\n    this._hideOutsideAndNoSelectedBlock();\n  }, this);\n\n  private _updatingChildrenFlag = false;\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n\n    const viewportUpdateCallback = () => {\n      this._refreshViewport();\n    };\n\n    if (!this.enableChildrenSchedule) {\n      delete this.scheduleUpdateChildren;\n    }\n\n    this._hideOutsideAndNoSelectedBlock();\n    this.disposables.add(\n      this.viewport.viewportUpdated.subscribe(() => viewportUpdateCallback())\n    );\n    this.disposables.add(\n      this.viewport.sizeUpdated.subscribe(() => viewportUpdateCallback())\n    );\n  }\n\n  override render() {\n    return html``;\n  }\n\n  scheduleUpdateChildren? = (id: string) => {\n    const { promise, resolve } = Promise.withResolvers<void>();\n\n    this._pendingChildrenUpdates.push({ id, resolve });\n\n    if (!this._updatingChildrenFlag) {\n      this._updatingChildrenFlag = true;\n      const schedule = () => {\n        if (this._pendingChildrenUpdates.length) {\n          const childToUpdates = this._pendingChildrenUpdates.splice(\n            0,\n            this.maxConcurrentRenders\n          );\n\n          childToUpdates.forEach(({ resolve }) => resolve());\n\n          if (this._pendingChildrenUpdates.length) {\n            requestAnimationFrame(() => {\n              this.isConnected && schedule();\n            });\n          } else {\n            this._updatingChildrenFlag = false;\n          }\n        }\n      };\n\n      requestAnimationFrame(() => {\n        this.isConnected && schedule();\n      });\n    }\n\n    return promise;\n  };\n\n  private _getSelectedModels(): Set<GfxBlockElementModel> {\n    if (!this.host) return new Set();\n    const gfx = this.host.std.get(GfxControllerIdentifier);\n    return new Set(\n      gfx.selection.surfaceSelections\n        .flatMap(({ elements }) => elements)\n        .map(id => gfx.getElementById(id))\n        .filter(e => e instanceof GfxBlockElementModel)\n    );\n  }\n\n  @property({ attribute: false })\n  accessor getModelsInViewport: () => Set<GfxBlockElementModel> = () =>\n    new Set();\n\n  @property({ attribute: false })\n  accessor host: undefined | EditorHost;\n\n  @property({ type: Number })\n  accessor maxConcurrentRenders: number = 2;\n\n  @property({ attribute: false })\n  accessor enableChildrenSchedule: boolean = true;\n\n  @property({ attribute: false })\n  accessor viewport!: Viewport;\n\n  setBlocksActive(blockIds: string[]): void {\n    if (!this.host) return;\n    const gfx = this.host.std.get(GfxControllerIdentifier);\n\n    batch(() => {\n      blockIds.forEach(id => {\n        const view = gfx.view.get(id);\n        if (isGfxBlockComponent(view)) {\n          view.transformState$.value = 'active';\n        }\n      });\n    });\n  }\n\n  setBlocksIdle(blockIds: string[]): void {\n    if (!this.host) return;\n    const gfx = this.host.std.get(GfxControllerIdentifier);\n\n    batch(() => {\n      blockIds.forEach(id => {\n        const view = gfx.view.get(id);\n        if (isGfxBlockComponent(view)) {\n          view.transformState$.value = 'idle';\n        }\n      });\n    });\n  }\n}\n","const agent = globalThis.navigator?.userAgent ?? '';\nconst platform = globalThis.navigator?.platform || globalThis.process?.platform;\n\nexport const IS_WEB =\n  typeof window !== 'undefined' && typeof document !== 'undefined';\n\nexport const IS_NODE = typeof process !== 'undefined' && !IS_WEB;\n\nexport const IS_SAFARI = /Apple Computer/.test(globalThis.navigator?.vendor);\n\nexport const IS_FIREFOX =\n  IS_WEB && navigator.userAgent.toLowerCase().indexOf('firefox') > -1;\n\nexport const IS_ANDROID = /Android \\d/.test(agent);\n\nexport const IS_IOS =\n  IS_SAFARI &&\n  (/Mobile\\/\\w+/.test(agent) || globalThis.navigator?.maxTouchPoints > 2);\n\nexport const IS_MAC = /Mac/i.test(platform) || /darwin/.test(platform);\n\nexport const IS_IPAD =\n  /iPad/i.test(platform) ||\n  /iPad/i.test(agent) ||\n  (/Macintosh/i.test(agent) && globalThis.navigator?.maxTouchPoints > 2);\n\nexport const IS_WINDOWS = /Win/.test(platform) || /win32/.test(platform);\n\nexport const IS_LINUX = /Linux/.test(platform);\n\nexport const IS_MOBILE = IS_IOS || IS_IPAD || IS_ANDROID;\n","import { IS_SAFARI } from '@blocksuite/global/env';\n\nexport const ZERO_WIDTH_FOR_EMPTY_LINE = IS_SAFARI ? '\\u200C' : '\\u200B';\nexport const ZERO_WIDTH_FOR_EMBED_NODE = IS_SAFARI ? '\\u200B' : '\\u200C';\n\nexport const INLINE_ROOT_ATTR = 'data-v-root';\n","import type { InlineRange } from '../types.js';\n\nexport function isMaybeInlineRangeEqual(\n  a: InlineRange | null,\n  b: InlineRange | null\n): boolean {\n  return a === b || (a && b ? isInlineRangeEqual(a, b) : false);\n}\n\nexport function isInlineRangeContain(a: InlineRange, b: InlineRange): boolean {\n  return a.index <= b.index && a.index + a.length >= b.index + b.length;\n}\n\nexport function isInlineRangeEqual(a: InlineRange, b: InlineRange): boolean {\n  return a.index === b.index && a.length === b.length;\n}\n\nexport function isInlineRangeIntersect(\n  a: InlineRange,\n  b: InlineRange\n): boolean {\n  return a.index <= b.index + b.length && a.index + a.length >= b.index;\n}\n\nexport function isInlineRangeBefore(a: InlineRange, b: InlineRange): boolean {\n  return a.index + a.length <= b.index;\n}\n\nexport function isInlineRangeAfter(a: InlineRange, b: InlineRange): boolean {\n  return a.index >= b.index + b.length;\n}\n\nexport function isInlineRangeEdge(\n  index: InlineRange['index'],\n  range: InlineRange\n): boolean {\n  return index === range.index || index === range.index + range.length;\n}\n\nexport function isInlineRangeEdgeBefore(\n  index: InlineRange['index'],\n  range: InlineRange\n): boolean {\n  return index === range.index;\n}\n\nexport function isInlineRangeEdgeAfter(\n  index: InlineRange['index'],\n  range: InlineRange\n): boolean {\n  return index === range.index + range.length;\n}\n\nexport function isPoint(range: InlineRange): boolean {\n  return range.length === 0;\n}\n\nexport function mergeInlineRange(a: InlineRange, b: InlineRange): InlineRange {\n  const index = Math.min(a.index, b.index);\n  const length = Math.max(a.index + a.length, b.index + b.length) - index;\n  return { index, length };\n}\n\nexport function intersectInlineRange(\n  a: InlineRange,\n  b: InlineRange\n): InlineRange | null {\n  if (!isInlineRangeIntersect(a, b)) {\n    return null;\n  }\n  const index = Math.max(a.index, b.index);\n  const length = Math.min(a.index + a.length, b.index + b.length) - index;\n  return { index, length };\n}\n","import { DisposableGroup } from '@blocksuite/global/disposable';\nimport { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { SignalWatcher } from '@blocksuite/global/lit';\nimport type { BaseTextAttributes, DeltaInsert } from '@blocksuite/store';\nimport { effect, signal } from '@preact/signals-core';\nimport { html, LitElement } from 'lit';\nimport { property } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport { ZERO_WIDTH_FOR_EMPTY_LINE } from '../consts.js';\nimport type { InlineEditor } from '../inline-editor.js';\nimport { isInlineRangeIntersect } from '../utils/inline-range.js';\n\nexport class VElement<\n  T extends BaseTextAttributes = BaseTextAttributes,\n> extends SignalWatcher(LitElement) {\n  readonly disposables = new DisposableGroup();\n\n  readonly selected = signal(false);\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n\n    this.disposables.add(\n      effect(() => {\n        const inlineRange = this.inlineEditor?.inlineRange$.value;\n        this.selected.value =\n          !!inlineRange &&\n          isInlineRangeIntersect(inlineRange, {\n            index: this.startOffset,\n            length: this.endOffset - this.startOffset,\n          });\n      })\n    );\n  }\n\n  override createRenderRoot() {\n    return this;\n  }\n\n  override async getUpdateComplete(): Promise<boolean> {\n    const result = await super.getUpdateComplete();\n    const span = this.querySelector('[data-v-element=\"true\"]') as HTMLElement;\n    const el = span.firstElementChild as LitElement;\n    await el.updateComplete;\n    const vTexts = Array.from(this.querySelectorAll('v-text'));\n    await Promise.all(vTexts.map(vText => vText.updateComplete));\n    return result;\n  }\n\n  override render() {\n    const inlineEditor = this.inlineEditor;\n    const attributeRenderer = inlineEditor.attributeService.attributeRenderer;\n    const renderProps: Parameters<typeof attributeRenderer>[0] = {\n      delta: this.delta,\n      selected: this.selected.value,\n      startOffset: this.startOffset,\n      endOffset: this.endOffset,\n      lineIndex: this.lineIndex,\n      editor: inlineEditor,\n    };\n\n    const isEmbed = inlineEditor.isEmbed(this.delta);\n    if (isEmbed) {\n      if (this.delta.insert.length !== 1) {\n        throw new BlockSuiteError(\n          ErrorCode.InlineEditorError,\n          `The length of embed node should only be 1.\n          This seems to be an internal issue with inline editor.\n          Please go to https://github.com/toeverything/blocksuite/issues\n          to report it.`\n        );\n      }\n\n      return html`<span\n        data-v-embed=\"true\"\n        data-v-element=\"true\"\n        contenteditable=\"false\"\n        style=${styleMap({ userSelect: 'none' })}\n        >${attributeRenderer(renderProps)}</span\n      >`;\n    }\n\n    // we need to avoid \\n appearing before and after the span element, which will\n    // cause the unexpected space\n    return html`<span data-v-element=\"true\"\n      >${attributeRenderer(renderProps)}</span\n    >`;\n  }\n\n  @property({ type: Object })\n  accessor delta: DeltaInsert<T> = {\n    insert: ZERO_WIDTH_FOR_EMPTY_LINE,\n  };\n\n  @property({ attribute: false })\n  accessor endOffset!: number;\n\n  @property({ attribute: false })\n  accessor inlineEditor!: InlineEditor;\n\n  @property({ attribute: false })\n  accessor lineIndex!: number;\n\n  @property({ attribute: false })\n  accessor startOffset!: number;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'v-element': VElement;\n  }\n}\n","import { html } from 'lit';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nexport const EmbedGap = html`<span\n  data-v-embed-gap=\"true\"\n  style=${styleMap({\n    userSelect: 'text',\n    padding: '0 0.5px',\n    outline: 'none',\n  })}\n  ><v-text></v-text\n></span>`;\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport type { DeltaInsert } from '@blocksuite/store';\nimport { html, LitElement, type TemplateResult } from 'lit';\nimport { property } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport { INLINE_ROOT_ATTR, ZERO_WIDTH_FOR_EMPTY_LINE } from '../consts.js';\nimport type { InlineRootElement } from '../inline-editor.js';\nimport { EmbedGap } from './embed-gap.js';\n\nexport class VLine extends LitElement {\n  get inlineEditor() {\n    const rootElement = this.closest(\n      `[${INLINE_ROOT_ATTR}]`\n    ) as InlineRootElement;\n    if (!rootElement) {\n      throw new BlockSuiteError(\n        BlockSuiteError.ErrorCode.ValueNotExists,\n        'v-line must be inside a v-root'\n      );\n    }\n    const inlineEditor = rootElement.inlineEditor;\n    if (!inlineEditor) {\n      throw new BlockSuiteError(\n        BlockSuiteError.ErrorCode.ValueNotExists,\n        'v-line must be inside a v-root with inline-editor'\n      );\n    }\n\n    return inlineEditor;\n  }\n\n  get vElements() {\n    return Array.from(this.querySelectorAll('v-element'));\n  }\n\n  get vTextContent() {\n    return this.vElements.reduce((acc, el) => acc + el.delta.insert, '');\n  }\n\n  get vTextLength() {\n    return this.vElements.reduce((acc, el) => acc + el.delta.insert.length, 0);\n  }\n\n  // you should use vElements.length or vTextLength because v-element corresponds to the actual delta\n  get vTexts() {\n    return Array.from(this.querySelectorAll('v-text'));\n  }\n\n  override createRenderRoot() {\n    return this;\n  }\n\n  protected override firstUpdated(): void {\n    this.style.display = 'block';\n\n    this.addEventListener('mousedown', e => {\n      if (e.detail >= 2 && this.startOffset === this.endOffset) {\n        e.preventDefault();\n        return;\n      }\n\n      if (e.detail >= 3) {\n        e.preventDefault();\n        this.inlineEditor.setInlineRange({\n          index: this.startOffset,\n          length: this.endOffset - this.startOffset,\n        });\n      }\n    });\n  }\n\n  // vTexts.length > 0 does not mean the line is not empty,\n  override async getUpdateComplete() {\n    const result = await super.getUpdateComplete();\n    await Promise.all(this.vElements.map(el => el.updateComplete));\n    return result;\n  }\n\n  override render() {\n    if (!this.isConnected) return;\n\n    if (this.inlineEditor.vLineRenderer) {\n      return this.inlineEditor.vLineRenderer(this);\n    }\n    return this.renderVElements();\n  }\n\n  renderVElements() {\n    if (this.elements.length === 0) {\n      // don't use v-element because it not correspond to the actual delta\n      return html`\n        <div><v-text .str=${ZERO_WIDTH_FOR_EMPTY_LINE}></v-text></div>\n      `;\n    }\n\n    const inlineEditor = this.inlineEditor;\n    const renderElements = this.elements.flatMap(([template, delta], index) => {\n      if (inlineEditor.isEmbed(delta)) {\n        if (delta.insert.length !== 1) {\n          throw new BlockSuiteError(\n            ErrorCode.InlineEditorError,\n            `The length of embed node should only be 1.\n            This seems to be an internal issue with inline editor.\n            Please go to https://github.com/toeverything/blocksuite/issues\n            to report it.`\n          );\n        }\n        // we add `EmbedGap` to make cursor can be placed between embed elements\n        if (index === 0) {\n          const nextDelta = this.elements[index + 1]?.[1];\n          if (!nextDelta || inlineEditor.isEmbed(nextDelta)) {\n            return [EmbedGap, template, EmbedGap];\n          } else {\n            return [EmbedGap, template];\n          }\n        } else {\n          const nextDelta = this.elements[index + 1]?.[1];\n          if (!nextDelta || inlineEditor.isEmbed(nextDelta)) {\n            return [template, EmbedGap];\n          } else {\n            return [template];\n          }\n        }\n      }\n      return template;\n    });\n\n    // prettier will generate \\n and cause unexpected space and line break\n    // prettier-ignore\n    return html`<div style=${styleMap({\n      // this padding is used to make cursor can be placed at the\n      // start and end of the line when the first and last element is embed element\n      padding: '0 0.5px',\n      display: 'inline-block',\n    })}>${renderElements}</div>`;\n  }\n\n  @property({ attribute: false })\n  accessor elements: [TemplateResult<1>, DeltaInsert][] = [];\n\n  @property({ attribute: false })\n  accessor endOffset!: number;\n\n  @property({ attribute: false })\n  accessor index!: number;\n\n  @property({ attribute: false })\n  accessor startOffset!: number;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'v-line': VLine;\n  }\n}\n","import { html, LitElement } from 'lit';\nimport { property } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport { ZERO_WIDTH_FOR_EMPTY_LINE } from '../consts.js';\n\nexport class VText extends LitElement {\n  override createRenderRoot() {\n    return this;\n  }\n\n  override render() {\n    // we need to avoid \\n appearing before and after the span element, which will\n    // cause the sync problem about the cursor position\n    return html`<span\n      style=${styleMap({\n        'word-break': 'break-word',\n        'text-wrap': 'wrap',\n        'white-space-collapse': 'break-spaces',\n      })}\n      data-v-text=\"true\"\n      >${this.str}</span\n    >`;\n  }\n\n  @property({ attribute: false })\n  accessor str: string = ZERO_WIDTH_FOR_EMPTY_LINE;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'v-text': VText;\n  }\n}\n","import type { BaseTextAttributes } from '@blocksuite/store';\nimport { html } from 'lit';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { AttributeRenderer } from '../types.js';\n\nfunction inlineTextStyles(\n  props: BaseTextAttributes\n): ReturnType<typeof styleMap> {\n  let textDecorations = '';\n  if (props.underline) {\n    textDecorations += 'underline';\n  }\n  if (props.strike) {\n    textDecorations += ' line-through';\n  }\n\n  let inlineCodeStyle = {};\n  if (props.code) {\n    inlineCodeStyle = {\n      'font-family':\n        '\"SFMono-Regular\", Menlo, Consolas, \"PT Mono\", \"Liberation Mono\", Courier, monospace',\n      'line-height': 'normal',\n      background: 'rgba(135,131,120,0.15)',\n      color: '#EB5757',\n      'border-radius': '3px',\n      'font-size': '85%',\n      padding: '0.2em 0.4em',\n    };\n  }\n\n  return styleMap({\n    'font-weight': props.bold ? 'bold' : 'normal',\n    'font-style': props.italic ? 'italic' : 'normal',\n    'text-decoration': textDecorations.length > 0 ? textDecorations : 'none',\n    ...inlineCodeStyle,\n  });\n}\n\nexport const getDefaultAttributeRenderer =\n  <T extends BaseTextAttributes>(): AttributeRenderer<T> =>\n  ({ delta }) => {\n    const style = delta.attributes\n      ? inlineTextStyles(delta.attributes)\n      : styleMap({});\n    return html`<span style=${style}\n      ><v-text .str=${delta.insert}></v-text\n    ></span>`;\n  };\n","import type { BaseTextAttributes } from '@blocksuite/store';\n\nimport type { InlineEditor } from '../inline-editor.js';\nimport type { InlineRange } from '../types.js';\n\nexport interface BeforeinputHookCtx<TextAttributes extends BaseTextAttributes> {\n  inlineEditor: InlineEditor<TextAttributes>;\n  raw: InputEvent;\n  inlineRange: InlineRange;\n  data: string | null;\n  attributes: TextAttributes;\n}\nexport interface CompositionEndHookCtx<\n  TextAttributes extends BaseTextAttributes,\n> {\n  inlineEditor: InlineEditor<TextAttributes>;\n  raw: CompositionEvent;\n  inlineRange: InlineRange;\n  data: string | null;\n  attributes: TextAttributes;\n}\n\nexport type HookContext<TextAttributes extends BaseTextAttributes> =\n  | BeforeinputHookCtx<TextAttributes>\n  | CompositionEndHookCtx<TextAttributes>;\n\nexport class InlineHookService<TextAttributes extends BaseTextAttributes> {\n  constructor(\n    readonly editor: InlineEditor<TextAttributes>,\n    readonly hooks: {\n      beforeinput?: (props: BeforeinputHookCtx<TextAttributes>) => void;\n      compositionEnd?: (props: CompositionEndHookCtx<TextAttributes>) => void;\n    } = {}\n  ) {}\n}\n","import type { BaseTextAttributes, DeltaInsert } from '@blocksuite/store';\n\nexport function transformDelta<TextAttributes extends BaseTextAttributes>(\n  delta: DeltaInsert<TextAttributes>\n): (DeltaInsert<TextAttributes> | '\\n')[] {\n  const result: (DeltaInsert<TextAttributes> | '\\n')[] = [];\n\n  let tmpString = delta.insert;\n  while (tmpString.length > 0) {\n    const index = tmpString.indexOf('\\n');\n    if (index === -1) {\n      result.push({\n        insert: tmpString,\n        attributes: delta.attributes,\n      });\n      break;\n    }\n\n    if (tmpString.slice(0, index).length > 0) {\n      result.push({\n        insert: tmpString.slice(0, index),\n        attributes: delta.attributes,\n      });\n    }\n\n    result.push('\\n');\n    tmpString = tmpString.slice(index + 1);\n  }\n\n  return result;\n}\n\n/**\n * convert a delta insert array to chunks, each chunk is a line\n */\nexport function deltaInsertsToChunks<TextAttributes extends BaseTextAttributes>(\n  delta: DeltaInsert<TextAttributes>[]\n): DeltaInsert<TextAttributes>[][] {\n  if (delta.length === 0) {\n    return [[]];\n  }\n\n  const transformedDelta = delta.flatMap(transformDelta);\n\n  function* chunksGenerator(arr: (DeltaInsert<TextAttributes> | '\\n')[]) {\n    let start = 0;\n    for (let i = 0; i < arr.length; i++) {\n      if (arr[i] === '\\n') {\n        const chunk = arr.slice(start, i);\n        start = i + 1;\n        yield chunk as DeltaInsert<TextAttributes>[];\n      } else if (i === arr.length - 1) {\n        yield arr.slice(start) as DeltaInsert<TextAttributes>[];\n      }\n    }\n\n    if (arr.at(-1) === '\\n') {\n      yield [];\n    }\n  }\n\n  return Array.from(chunksGenerator(transformedDelta));\n}\n","import type { BaseTextAttributes, DeltaInsert } from '@blocksuite/store';\n\nimport { VElement } from '../components/v-element.js';\nimport type { InlineEditor } from '../inline-editor.js';\n\nexport function isInEmbedElement(node: Node): boolean {\n  if (node instanceof Element) {\n    if (node instanceof VElement) {\n      return node.querySelector('[data-v-embed=\"true\"]') !== null;\n    }\n    const vElement = node.closest('[data-v-embed=\"true\"]');\n    return !!vElement;\n  } else {\n    const vElement = node.parentElement?.closest('[data-v-embed=\"true\"]');\n    return !!vElement;\n  }\n}\n\nexport function isInEmbedGap(node: Node): boolean {\n  const el = node instanceof Element ? node : node.parentElement;\n  if (!el) return false;\n  return !!el.closest('[data-v-embed-gap=\"true\"]');\n}\n\nexport function transformDeltasToEmbedDeltas<\n  TextAttributes extends BaseTextAttributes = BaseTextAttributes,\n>(\n  editor: InlineEditor<TextAttributes>,\n  deltas: DeltaInsert<TextAttributes>[]\n): DeltaInsert<TextAttributes>[] {\n  // According to our regulations, the length of each \"embed\" node should only be 1.\n  // Therefore, if the length of an \"embed\" type node is greater than 1,\n  // we will divide it into multiple parts.\n  const result: DeltaInsert<TextAttributes>[] = [];\n  for (const delta of deltas) {\n    if (editor.isEmbed(delta)) {\n      const dividedDeltas = [...delta.insert].map(subInsert => ({\n        insert: subInsert,\n        attributes: delta.attributes,\n      }));\n      result.push(...dividedDeltas);\n    } else {\n      result.push(delta);\n    }\n  }\n  return result;\n}\n","import { VElement, VLine } from '../components/index.js';\n\nexport function isNativeTextInVText(text: unknown): text is Text {\n  return text instanceof Text && text.parentElement?.dataset.vText === 'true';\n}\n\nexport function isVElement(element: unknown): element is HTMLElement {\n  return (\n    element instanceof HTMLElement &&\n    (element.dataset.vElement === 'true' || element instanceof VElement)\n  );\n}\n\nexport function isVLine(element: unknown): element is HTMLElement {\n  return (\n    element instanceof HTMLElement &&\n    (element instanceof VLine || element.parentElement instanceof VLine)\n  );\n}\n\nexport function isInEmptyLine(element: Node) {\n  const el = element instanceof Element ? element : element.parentElement;\n  const vLine = el?.closest<VLine>('v-line');\n  return !!vLine && vLine.vTextLength === 0;\n}\n\nexport function isInlineRoot(element: unknown): element is HTMLElement {\n  return element instanceof HTMLElement && element.dataset.vRoot === 'true';\n}\n","import { ZERO_WIDTH_FOR_EMPTY_LINE } from '../consts.js';\n\nexport function calculateTextLength(text: Text): number {\n  if (text.wholeText === ZERO_WIDTH_FOR_EMPTY_LINE) {\n    return 0;\n  } else {\n    return text.wholeText.length;\n  }\n}\n\nexport function getTextNodesFromElement(element: Element): Text[] {\n  const textSpanElements = Array.from(\n    element.querySelectorAll('[data-v-text=\"true\"]')\n  );\n  const textNodes = textSpanElements.flatMap(textSpanElement => {\n    const textNode = Array.from(textSpanElement.childNodes).find(\n      (node): node is Text => node instanceof Text\n    );\n    if (!textNode) return [];\n\n    return textNode;\n  });\n\n  return textNodes;\n}\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\n\nimport type { VElement, VLine } from '../components/index.js';\nimport { INLINE_ROOT_ATTR, ZERO_WIDTH_FOR_EMPTY_LINE } from '../consts.js';\nimport type { DomPoint, TextPoint } from '../types.js';\nimport {\n  isInlineRoot,\n  isNativeTextInVText,\n  isVElement,\n  isVLine,\n} from './guard.js';\nimport { calculateTextLength, getTextNodesFromElement } from './text.js';\n\nexport function nativePointToTextPoint(\n  node: unknown,\n  offset: number\n): TextPoint | null {\n  if (isNativeTextInVText(node)) {\n    return [node, offset];\n  }\n\n  if (isVElement(node)) {\n    const texts = getTextNodesFromElement(node);\n    const vElement = texts[0].parentElement?.closest('[data-v-element=\"true\"]');\n\n    if (\n      texts.length === 1 &&\n      vElement instanceof HTMLElement &&\n      vElement.dataset.vEmbed === 'true'\n    ) {\n      return [texts[0], 0];\n    }\n\n    if (texts.length > 0) {\n      return texts[offset] ? [texts[offset], 0] : null;\n    }\n  }\n\n  if (isVLine(node) || isInlineRoot(node)) {\n    return getTextPointRoughlyFromElementByOffset(node, offset, true);\n  }\n\n  if (!(node instanceof Node)) {\n    return null;\n  }\n\n  const vNodes = getVNodesFromNode(node);\n\n  if (vNodes) {\n    return getTextPointFromVNodes(vNodes, node, offset);\n  }\n\n  return null;\n}\n\nexport function textPointToDomPoint(\n  text: Text,\n  offset: number,\n  rootElement: HTMLElement\n): DomPoint | null {\n  if (rootElement.dataset.vRoot !== 'true') {\n    throw new BlockSuiteError(\n      ErrorCode.InlineEditorError,\n      'textRangeToDomPoint should be called with editor root element'\n    );\n  }\n\n  if (!rootElement.contains(text)) return null;\n\n  const texts = getTextNodesFromElement(rootElement);\n  if (texts.length === 0) return null;\n\n  const goalIndex = texts.indexOf(text);\n  let index = 0;\n  for (const text of texts.slice(0, goalIndex)) {\n    index += calculateTextLength(text);\n  }\n\n  if (text.wholeText !== ZERO_WIDTH_FOR_EMPTY_LINE) {\n    index += offset;\n  }\n\n  const textParentElement = text.parentElement;\n  if (!textParentElement) {\n    throw new BlockSuiteError(\n      ErrorCode.InlineEditorError,\n      'text element parent not found'\n    );\n  }\n\n  const lineElement = textParentElement.closest('v-line');\n\n  if (!lineElement) {\n    throw new BlockSuiteError(\n      ErrorCode.InlineEditorError,\n      'line element not found'\n    );\n  }\n\n  const lineIndex = Array.from(rootElement.querySelectorAll('v-line')).indexOf(\n    lineElement\n  );\n\n  return { text, index: index + lineIndex };\n}\n\nfunction getVNodesFromNode(node: Node): VElement[] | VLine[] | null {\n  const vLine = node.parentElement?.closest('v-line');\n\n  if (vLine) {\n    return Array.from(vLine.querySelectorAll('v-element'));\n  }\n\n  const container =\n    node instanceof Element\n      ? node.closest(`[${INLINE_ROOT_ATTR}]`)\n      : node.parentElement?.closest(`[${INLINE_ROOT_ATTR}]`);\n\n  if (container) {\n    return Array.from(container.querySelectorAll('v-line'));\n  }\n\n  return null;\n}\n\nfunction getTextPointFromVNodes(\n  vNodes: VLine[] | VElement[],\n  node: Node,\n  offset: number\n): TextPoint | null {\n  const first = vNodes[0];\n  for (let i = 0; i < vNodes.length; i++) {\n    const vNode = vNodes[i];\n\n    if (i === 0 && AFollowedByB(node, vNode)) {\n      return getTextPointRoughlyFromElementByOffset(first, offset, true);\n    }\n\n    if (AInsideB(node, vNode)) {\n      return getTextPointRoughlyFromElementByOffset(first, offset, false);\n    }\n\n    if (i === vNodes.length - 1 && APrecededByB(node, vNode)) {\n      return getTextPointRoughlyFromElement(vNode);\n    }\n\n    if (\n      i < vNodes.length - 1 &&\n      APrecededByB(node, vNode) &&\n      AFollowedByB(node, vNodes[i + 1])\n    ) {\n      return getTextPointRoughlyFromElement(vNode);\n    }\n  }\n\n  return null;\n}\n\nfunction getTextPointRoughlyFromElement(element: Element): TextPoint | null {\n  const texts = getTextNodesFromElement(element);\n  if (texts.length === 0) return null;\n  const text = texts[texts.length - 1];\n  return [text, calculateTextLength(text)];\n}\n\nfunction getTextPointRoughlyFromElementByOffset(\n  element: Element,\n  offset: number,\n  fromStart: boolean\n): TextPoint | null {\n  const texts = getTextNodesFromElement(element);\n  if (texts.length === 0) return null;\n  const text = fromStart ? texts[0] : texts[texts.length - 1];\n  return [text, offset === 0 ? offset : text.length];\n}\n\nfunction AInsideB(a: Node, b: Node): boolean {\n  return (\n    b.compareDocumentPosition(a) === Node.DOCUMENT_POSITION_CONTAINED_BY ||\n    b.compareDocumentPosition(a) ===\n      (Node.DOCUMENT_POSITION_CONTAINED_BY | Node.DOCUMENT_POSITION_FOLLOWING)\n  );\n}\n\nfunction AFollowedByB(a: Node, b: Node): boolean {\n  return a.compareDocumentPosition(b) === Node.DOCUMENT_POSITION_FOLLOWING;\n}\n\nfunction APrecededByB(a: Node, b: Node): boolean {\n  return a.compareDocumentPosition(b) === Node.DOCUMENT_POSITION_PRECEDING;\n}\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport type * as Y from 'yjs';\n\nimport { VElement } from '../components/v-element.js';\nimport type { InlineRange } from '../types.js';\nimport { isInEmbedElement } from './embed.js';\nimport {\n  nativePointToTextPoint,\n  textPointToDomPoint,\n} from './point-conversion.js';\nimport { calculateTextLength, getTextNodesFromElement } from './text.js';\n\ntype InlineRangeRunnerContext = {\n  rootElement: HTMLElement;\n  range: Range;\n  yText: Y.Text;\n  startNode: Node | null;\n  startOffset: number;\n  startText: Text;\n  startTextOffset: number;\n  endNode: Node | null;\n  endOffset: number;\n  endText: Text;\n  endTextOffset: number;\n};\n\ntype Predict = (context: InlineRangeRunnerContext) => boolean;\ntype Handler = (context: InlineRangeRunnerContext) => InlineRange | null;\n\nconst rangeHasAnchorAndFocus: Predict = ({\n  rootElement,\n  startText,\n  endText,\n}) => {\n  return rootElement.contains(startText) && rootElement.contains(endText);\n};\n\nconst rangeHasAnchorAndFocusHandler: Handler = ({\n  rootElement,\n  startText,\n  endText,\n  startTextOffset,\n  endTextOffset,\n}) => {\n  const anchorDomPoint = textPointToDomPoint(\n    startText,\n    startTextOffset,\n    rootElement\n  );\n  const focusDomPoint = textPointToDomPoint(\n    endText,\n    endTextOffset,\n    rootElement\n  );\n\n  if (!anchorDomPoint || !focusDomPoint) {\n    return null;\n  }\n\n  return {\n    index: Math.min(anchorDomPoint.index, focusDomPoint.index),\n    length: Math.abs(anchorDomPoint.index - focusDomPoint.index),\n  };\n};\n\nconst rangeOnlyHasFocus: Predict = ({ rootElement, startText, endText }) => {\n  return !rootElement.contains(startText) && rootElement.contains(endText);\n};\n\nconst rangeOnlyHasFocusHandler: Handler = ({\n  rootElement,\n  endText,\n  endTextOffset,\n}) => {\n  const focusDomPoint = textPointToDomPoint(\n    endText,\n    endTextOffset,\n    rootElement\n  );\n\n  if (!focusDomPoint) {\n    return null;\n  }\n\n  return {\n    index: 0,\n    length: focusDomPoint.index,\n  };\n};\n\nconst rangeOnlyHasAnchor: Predict = ({ rootElement, startText, endText }) => {\n  return rootElement.contains(startText) && !rootElement.contains(endText);\n};\n\nconst rangeOnlyHasAnchorHandler: Handler = ({\n  yText,\n  rootElement,\n  startText,\n  startTextOffset,\n}) => {\n  const startDomPoint = textPointToDomPoint(\n    startText,\n    startTextOffset,\n    rootElement\n  );\n\n  if (!startDomPoint) {\n    return null;\n  }\n\n  return {\n    index: startDomPoint.index,\n    length: yText.length - startDomPoint.index,\n  };\n};\n\nconst rangeHasNoAnchorAndFocus: Predict = ({\n  rootElement,\n  startText,\n  endText,\n  range,\n}) => {\n  return (\n    !rootElement.contains(startText) &&\n    !rootElement.contains(endText) &&\n    range.intersectsNode(rootElement)\n  );\n};\n\nconst rangeHasNoAnchorAndFocusHandler: Handler = ({ yText }) => {\n  return {\n    index: 0,\n    length: yText.length,\n  };\n};\n\nconst buildContext = (\n  range: Range,\n  rootElement: HTMLElement,\n  yText: Y.Text\n): InlineRangeRunnerContext | null => {\n  const { startContainer, startOffset, endContainer, endOffset } = range;\n\n  const startTextPoint = nativePointToTextPoint(startContainer, startOffset);\n  const endTextPoint = nativePointToTextPoint(endContainer, endOffset);\n\n  if (!startTextPoint || !endTextPoint) {\n    return null;\n  }\n\n  const [startText, startTextOffset] = startTextPoint;\n  const [endText, endTextOffset] = endTextPoint;\n\n  return {\n    rootElement,\n    range,\n    yText,\n    startNode: startContainer,\n    startOffset,\n    endNode: endContainer,\n    endOffset,\n    startText,\n    startTextOffset,\n    endText,\n    endTextOffset,\n  };\n};\n\n/**\n * calculate the inline range from dom selection for **this Editor**\n * there are three cases when the inline range of this Editor is not null:\n * (In the following, \"|\" mean anchor and focus, each line is a separate Editor)\n * 1. anchor and focus are in this Editor\n *    aaaaaa\n *    b|bbbb|b\n *    cccccc\n *    the inline range of second Editor is {index: 1, length: 4}, the others are null\n * 2. anchor and focus one in this Editor, one in another Editor\n *    aaa|aaa    aaaaaa\n *    bbbbb|b or bbbbb|b\n *    cccccc     cc|cccc\n *    2.1\n *        the inline range of first Editor is {index: 3, length: 3}, the second is {index: 0, length: 5},\n *        the third is null\n *    2.2\n *        the inline range of first Editor is null, the second is {index: 5, length: 1},\n *        the third is {index: 0, length: 2}\n * 3. anchor and focus are in another Editor\n *    aa|aaaa\n *    bbbbbb\n *    cccc|cc\n *    the inline range of first Editor is {index: 2, length: 4},\n *    the second is {index: 0, length: 6}, the third is {index: 0, length: 4}\n */\nexport function domRangeToInlineRange(\n  range: Range,\n  rootElement: HTMLElement,\n  yText: Y.Text\n): InlineRange | null {\n  const context = buildContext(range, rootElement, yText);\n\n  if (!context) return null;\n\n  // handle embed\n  if (\n    context.startNode &&\n    context.startNode === context.endNode &&\n    isInEmbedElement(context.startNode)\n  ) {\n    const anchorDomPoint = textPointToDomPoint(\n      context.startText,\n      context.startTextOffset,\n      rootElement\n    );\n\n    if (anchorDomPoint) {\n      return {\n        index: anchorDomPoint.index,\n        length: 1,\n      };\n    }\n  }\n\n  // case 1\n  if (rangeHasAnchorAndFocus(context)) {\n    return rangeHasAnchorAndFocusHandler(context);\n  }\n\n  // case 2.1\n  if (rangeOnlyHasFocus(context)) {\n    return rangeOnlyHasFocusHandler(context);\n  }\n\n  // case 2.2\n  if (rangeOnlyHasAnchor(context)) {\n    return rangeOnlyHasAnchorHandler(context);\n  }\n\n  // case 3\n  if (rangeHasNoAnchorAndFocus(context)) {\n    return rangeHasNoAnchorAndFocusHandler(context);\n  }\n\n  return null;\n}\n\n/**\n * calculate the dom selection from inline range for **this Editor**\n */\nexport function inlineRangeToDomRange(\n  rootElement: HTMLElement,\n  inlineRange: InlineRange\n): Range | null {\n  const lineElements = Array.from(rootElement.querySelectorAll('v-line'));\n\n  // calculate anchorNode and focusNode\n  let startText: Text | null = null;\n  let endText: Text | null = null;\n  let anchorOffset = 0;\n  let focusOffset = 0;\n  let index = 0;\n\n  // eslint-disable-next-line @typescript-eslint/prefer-for-of\n  for (let i = 0; i < lineElements.length; i++) {\n    if (startText && endText) {\n      break;\n    }\n\n    const texts = getTextNodesFromElement(lineElements[i]);\n    if (texts.length === 0) {\n      return null;\n    }\n\n    for (const text of texts) {\n      const textLength = calculateTextLength(text);\n\n      if (!startText && index + textLength >= inlineRange.index) {\n        startText = text;\n        anchorOffset = inlineRange.index - index;\n      }\n      if (\n        !endText &&\n        index + textLength >= inlineRange.index + inlineRange.length\n      ) {\n        endText = text;\n        focusOffset = inlineRange.index + inlineRange.length - index;\n      }\n\n      if (startText && endText) {\n        break;\n      }\n\n      index += textLength;\n    }\n\n    // the one because of the line break\n    index += 1;\n  }\n\n  if (!startText || !endText) {\n    return null;\n  }\n\n  if (isInEmbedElement(startText)) {\n    const anchorVElement = startText.parentElement?.closest('v-element');\n    if (!anchorVElement) {\n      throw new BlockSuiteError(\n        ErrorCode.InlineEditorError,\n        'failed to find vElement for a text note in an embed element'\n      );\n    }\n    const nextSibling = anchorVElement.nextElementSibling;\n    if (!nextSibling) {\n      throw new BlockSuiteError(\n        ErrorCode.InlineEditorError,\n        'failed to find nextSibling sibling of an embed element'\n      );\n    }\n\n    const texts = getTextNodesFromElement(nextSibling);\n    if (texts.length === 0) {\n      throw new BlockSuiteError(\n        ErrorCode.InlineEditorError,\n        'text node in v-text not found'\n      );\n    }\n    if (nextSibling instanceof VElement) {\n      startText = texts[texts.length - 1];\n      anchorOffset = calculateTextLength(startText);\n    } else {\n      // nextSibling is a gap\n      startText = texts[0];\n      anchorOffset = 0;\n    }\n  }\n  if (isInEmbedElement(endText)) {\n    const focusVElement = endText.parentElement?.closest('v-element');\n    if (!focusVElement) {\n      throw new BlockSuiteError(\n        ErrorCode.InlineEditorError,\n        'failed to find vElement for a text note in an embed element'\n      );\n    }\n    const nextSibling = focusVElement.nextElementSibling;\n    if (!nextSibling) {\n      throw new BlockSuiteError(\n        ErrorCode.InlineEditorError,\n        'failed to find nextSibling sibling of an embed element'\n      );\n    }\n\n    const texts = getTextNodesFromElement(nextSibling);\n    if (texts.length === 0) {\n      throw new BlockSuiteError(\n        ErrorCode.InlineEditorError,\n        'text node in v-text not found'\n      );\n    }\n    endText = texts[0];\n    focusOffset = 0;\n  }\n\n  const range = document.createRange();\n  range.setStart(startText, anchorOffset);\n  range.setEnd(endText, focusOffset);\n\n  return range;\n}\n","import type { BaseTextAttributes } from '@blocksuite/store';\n\nimport type { InlineEditor } from '../inline-editor.js';\nimport type { InlineRange } from '../types.js';\n\nfunction handleInsertText<TextAttributes extends BaseTextAttributes>(\n  inlineRange: InlineRange,\n  data: string | null,\n  editor: InlineEditor,\n  attributes: TextAttributes\n) {\n  if (!data) return;\n  editor.insertText(inlineRange, data, attributes);\n  editor.setInlineRange({\n    index: inlineRange.index + data.length,\n    length: 0,\n  });\n}\n\nfunction handleInsertReplacementText<TextAttributes extends BaseTextAttributes>(\n  inlineRange: InlineRange,\n  data: string | null,\n  editor: InlineEditor,\n  attributes: TextAttributes\n) {\n  editor.getDeltasByInlineRange(inlineRange).forEach(deltaEntry => {\n    attributes = { ...deltaEntry[0].attributes, ...attributes };\n  });\n  if (data) {\n    editor.insertText(inlineRange, data, attributes);\n    editor.setInlineRange({\n      index: inlineRange.index + data.length,\n      length: 0,\n    });\n  }\n}\n\nfunction handleInsertParagraph(inlineRange: InlineRange, editor: InlineEditor) {\n  editor.insertLineBreak(inlineRange);\n  editor.setInlineRange({\n    index: inlineRange.index + 1,\n    length: 0,\n  });\n}\n\nfunction handleDelete(inlineRange: InlineRange, editor: InlineEditor) {\n  editor.deleteText(inlineRange);\n  editor.setInlineRange({\n    index: inlineRange.index,\n    length: 0,\n  });\n}\n\nexport function transformInput<TextAttributes extends BaseTextAttributes>(\n  inputType: string,\n  data: string | null,\n  attributes: TextAttributes,\n  inlineRange: InlineRange,\n  editor: InlineEditor\n) {\n  if (!editor.isValidInlineRange(inlineRange)) return;\n\n  if (inputType === 'insertText') {\n    handleInsertText(inlineRange, data, editor, attributes);\n  } else if (\n    inputType === 'insertParagraph' ||\n    inputType === 'insertLineBreak'\n  ) {\n    handleInsertParagraph(inlineRange, editor);\n  } else if (inputType.startsWith('delete')) {\n    handleDelete(inlineRange, editor);\n  } else if (inputType === 'insertReplacementText') {\n    // Spell Checker\n    handleInsertReplacementText(inlineRange, data, editor, attributes);\n  } else {\n    return;\n  }\n}\n","import { type BaseTextAttributes, baseTextAttributes } from '@blocksuite/store';\nimport type { z, ZodTypeDef } from 'zod';\n\nimport type { InlineEditor } from '../inline-editor.js';\nimport type { AttributeRenderer, InlineRange } from '../types.js';\nimport { getDefaultAttributeRenderer } from '../utils/index.js';\n\nexport class AttributeService<TextAttributes extends BaseTextAttributes> {\n  private _attributeRenderer: AttributeRenderer<TextAttributes> =\n    getDefaultAttributeRenderer<TextAttributes>();\n\n  private _attributeSchema: z.ZodSchema<TextAttributes, ZodTypeDef, unknown> =\n    baseTextAttributes as never;\n\n  private _marks: TextAttributes | null = null;\n\n  getFormat = (inlineRange: InlineRange, loose = false): TextAttributes => {\n    const deltas = this.editor.deltaService\n      .getDeltasByInlineRange(inlineRange)\n      .filter(([_, position]) => {\n        const deltaStart = position.index;\n        const deltaEnd = position.index + position.length;\n        const inlineStart = inlineRange.index;\n        const inlineEnd = inlineRange.index + inlineRange.length;\n\n        if (inlineStart === inlineEnd) {\n          return deltaStart < inlineStart && inlineStart <= deltaEnd;\n        } else {\n          return deltaEnd > inlineStart && deltaStart <= inlineEnd;\n        }\n      });\n    const maybeAttributesList = deltas.map(([delta]) => delta.attributes);\n    if (loose) {\n      return maybeAttributesList.reduce(\n        (acc, cur) => ({ ...acc, ...cur }),\n        {}\n      ) as TextAttributes;\n    }\n    if (\n      !maybeAttributesList.length ||\n      // some text does not have any attribute\n      maybeAttributesList.some(attributes => !attributes)\n    ) {\n      return {} as TextAttributes;\n    }\n    const attributesList = maybeAttributesList as TextAttributes[];\n    return attributesList.reduce((acc, cur) => {\n      const newFormat = {} as TextAttributes;\n      for (const key in acc) {\n        const typedKey = key as keyof TextAttributes;\n        // If the given range contains multiple different formats\n        // such as links with different values,\n        // we will treat it as having no format\n        if (acc[typedKey] === cur[typedKey]) {\n          // This cast is secure because we have checked that the value of the key is the same.\n\n          newFormat[typedKey] = acc[typedKey] as any;\n        }\n      }\n      return newFormat;\n    });\n  };\n\n  normalizeAttributes = (textAttributes?: TextAttributes) => {\n    if (!textAttributes) {\n      return undefined;\n    }\n    const attributeResult = this._attributeSchema.safeParse(textAttributes);\n    if (!attributeResult.success) {\n      console.error(attributeResult.error);\n      return undefined;\n    }\n    return Object.fromEntries(\n      // filter out undefined values\n      Object.entries(attributeResult.data).filter(([_, v]) => v !== undefined)\n    ) as TextAttributes;\n  };\n\n  resetMarks = (): void => {\n    this._marks = null;\n  };\n\n  setAttributeRenderer = (renderer: AttributeRenderer<TextAttributes>) => {\n    this._attributeRenderer = renderer;\n  };\n\n  setAttributeSchema = (\n    schema: z.ZodSchema<TextAttributes, ZodTypeDef, unknown>\n  ) => {\n    this._attributeSchema = schema;\n  };\n\n  setMarks = (marks: TextAttributes): void => {\n    this._marks = marks;\n  };\n\n  get attributeRenderer() {\n    return this._attributeRenderer;\n  }\n\n  get marks() {\n    return this._marks;\n  }\n\n  constructor(readonly editor: InlineEditor<TextAttributes>) {}\n}\n","import type { BaseTextAttributes, DeltaInsert } from '@blocksuite/store';\n\nimport type { InlineEditor } from '../inline-editor.js';\nimport type { DeltaEntry, InlineRange } from '../types.js';\nimport { transformDeltasToEmbedDeltas } from '../utils/index.js';\n\nexport class DeltaService<TextAttributes extends BaseTextAttributes> {\n  /**\n   * Here are examples of how this function computes and gets the delta.\n   *\n   * We have such a text:\n   * ```\n   * [\n   *   {\n   *      insert: 'aaa',\n   *      attributes: { bold: true },\n   *   },\n   *   {\n   *      insert: 'bbb',\n   *      attributes: { italic: true },\n   *   },\n   * ]\n   * ```\n   *\n   * `getDeltaByRangeIndex(0)` returns `{ insert: 'aaa', attributes: { bold: true } }`.\n   *\n   * `getDeltaByRangeIndex(1)` returns `{ insert: 'aaa', attributes: { bold: true } }`.\n   *\n   * `getDeltaByRangeIndex(3)` returns `{ insert: 'aaa', attributes: { bold: true } }`.\n   *\n   * `getDeltaByRangeIndex(4)` returns `{ insert: 'bbb', attributes: { italic: true } }`.\n   */\n  getDeltaByRangeIndex = (rangeIndex: number) => {\n    const deltas = this.editor.embedDeltas;\n\n    let index = 0;\n    for (const delta of deltas) {\n      if (index + delta.insert.length >= rangeIndex) {\n        return delta;\n      }\n      index += delta.insert.length;\n    }\n\n    return null;\n  };\n\n  /**\n   * Here are examples of how this function computes and gets the deltas.\n   *\n   * We have such a text:\n   * ```\n   * [\n   *   {\n   *      insert: 'aaa',\n   *      attributes: { bold: true },\n   *   },\n   *   {\n   *      insert: 'bbb',\n   *      attributes: { italic: true },\n   *   },\n   *   {\n   *      insert: 'ccc',\n   *      attributes: { underline: true },\n   *   },\n   * ]\n   * ```\n   *\n   * `getDeltasByInlineRange({ index: 0, length: 0 })` returns\n   * ```\n   * [{ insert: 'aaa', attributes: { bold: true }, }, { index: 0, length: 3, }]]\n   * ```\n   *\n   * `getDeltasByInlineRange({ index: 0, length: 1 })` returns\n   * ```\n   * [{ insert: 'aaa', attributes: { bold: true }, }, { index: 0, length: 3, }]]\n   * ```\n   *\n   * `getDeltasByInlineRange({ index: 0, length: 4 })` returns\n   * ```\n   * [{ insert: 'aaa', attributes: { bold: true }, }, { index: 0, length: 3, }],\n   *  [{ insert: 'bbb', attributes: { italic: true }, }, { index: 3, length: 3, }]]\n   * ```\n   *\n   * `getDeltasByInlineRange({ index: 3, length: 1 })` returns\n   * ```\n   * [{ insert: 'aaa', attributes: { bold: true }, }, { index: 0, length: 3, }],\n   *  [{ insert: 'bbb', attributes: { italic: true }, }, { index: 3, length: 3, }]]\n   * ```\n   *\n   * `getDeltasByInlineRange({ index: 3, length: 3 })` returns\n   * ```\n   * [{ insert: 'aaa', attributes: { bold: true }, }, { index: 0, length: 3, }],\n   *  [{ insert: 'bbb', attributes: { italic: true }, }, { index: 3, length: 3, }]]\n   * ```\n   *\n   *  `getDeltasByInlineRange({ index: 3, length: 4 })` returns\n   * ```\n   * [{ insert: 'aaa', attributes: { bold: true }, }, { index: 0, length: 3, }],\n   *  [{ insert: 'bbb', attributes: { italic: true }, }, { index: 3, length: 3, }],\n   *  [{ insert: 'ccc', attributes: { underline: true }, }, { index: 6, length: 3, }]]\n   * ```\n   */\n  getDeltasByInlineRange = (\n    inlineRange: InlineRange\n  ): DeltaEntry<TextAttributes>[] => {\n    return this.mapDeltasInInlineRange(\n      inlineRange,\n      (delta, index): DeltaEntry<TextAttributes> => [\n        delta,\n        { index, length: delta.insert.length },\n      ]\n    );\n  };\n\n  mapDeltasInInlineRange = <Result>(\n    inlineRange: InlineRange,\n    callback: (\n      delta: DeltaInsert<TextAttributes>,\n      rangeIndex: number,\n      deltaIndex: number\n    ) => Result\n  ) => {\n    const deltas = this.editor.embedDeltas;\n    const result: Result[] = [];\n\n    // eslint-disable-next-line sonarjs/no-ignored-return\n    deltas.reduce((rangeIndex, delta, deltaIndex) => {\n      const length = delta.insert.length;\n      const from = inlineRange.index - length;\n      const to = inlineRange.index + inlineRange.length;\n\n      const deltaInRange =\n        rangeIndex >= from &&\n        (rangeIndex < to ||\n          (inlineRange.length === 0 && rangeIndex === inlineRange.index));\n\n      if (deltaInRange) {\n        const value = callback(delta, rangeIndex, deltaIndex);\n        result.push(value);\n      }\n\n      return rangeIndex + length;\n    }, 0);\n\n    return result;\n  };\n\n  get embedDeltas() {\n    return transformDeltasToEmbedDeltas(this.editor, this.editor.yTextDeltas);\n  }\n\n  constructor(readonly editor: InlineEditor<TextAttributes>) {}\n}\n","import type { BaseTextAttributes } from '@blocksuite/store';\n\nimport type { InlineEditor } from '../inline-editor.js';\nimport type { InlineRange } from '../types.js';\nimport {\n  isInEmbedElement,\n  isInEmbedGap,\n  isInEmptyLine,\n} from '../utils/index.js';\nimport { isMaybeInlineRangeEqual } from '../utils/inline-range.js';\nimport { transformInput } from '../utils/transform-input.js';\nimport type { BeforeinputHookCtx, CompositionEndHookCtx } from './hook.js';\n\nexport class EventService<TextAttributes extends BaseTextAttributes> {\n  private _compositionInlineRange: InlineRange | null = null;\n\n  private _isComposing = false;\n\n  private readonly _isRangeCompletelyInRoot = (range: Range) => {\n    if (range.commonAncestorContainer.ownerDocument !== document) return false;\n\n    const rootElement = this.editor.rootElement;\n    if (!rootElement) return false;\n\n    const rootRange = document.createRange();\n    rootRange.selectNode(rootElement);\n\n    if (\n      range.startContainer.compareDocumentPosition(range.endContainer) &\n      Node.DOCUMENT_POSITION_FOLLOWING\n    ) {\n      return (\n        rootRange.comparePoint(range.startContainer, range.startOffset) >= 0 &&\n        rootRange.comparePoint(range.endContainer, range.endOffset) <= 0\n      );\n    } else {\n      return (\n        rootRange.comparePoint(range.endContainer, range.startOffset) >= 0 &&\n        rootRange.comparePoint(range.startContainer, range.endOffset) <= 0\n      );\n    }\n  };\n\n  private readonly _onBeforeInput = (event: InputEvent) => {\n    const range = this.editor.rangeService.getNativeRange();\n    if (\n      this.editor.isReadonly ||\n      this._isComposing ||\n      !range ||\n      !this._isRangeCompletelyInRoot(range)\n    )\n      return;\n\n    let inlineRange = this.editor.toInlineRange(range);\n    if (!inlineRange) return;\n\n    let ifHandleTargetRange = true;\n\n    if (event.inputType.startsWith('delete')) {\n      if (\n        isInEmbedGap(range.commonAncestorContainer) &&\n        inlineRange.length === 0 &&\n        inlineRange.index > 0\n      ) {\n        inlineRange = {\n          index: inlineRange.index - 1,\n          length: 1,\n        };\n        ifHandleTargetRange = false;\n      } else if (\n        isInEmptyLine(range.commonAncestorContainer) &&\n        inlineRange.length === 0 &&\n        inlineRange.index > 0\n        // eslint-disable-next-line sonarjs/no-duplicated-branches\n      ) {\n        // do not use target range when deleting across lines\n        // https://github.com/toeverything/blocksuite/issues/5381\n        inlineRange = {\n          index: inlineRange.index - 1,\n          length: 1,\n        };\n        ifHandleTargetRange = false;\n      }\n    }\n\n    if (ifHandleTargetRange) {\n      const targetRanges = event.getTargetRanges();\n      if (targetRanges.length > 0) {\n        const staticRange = targetRanges[0];\n        const range = document.createRange();\n        range.setStart(staticRange.startContainer, staticRange.startOffset);\n        range.setEnd(staticRange.endContainer, staticRange.endOffset);\n        const targetInlineRange = this.editor.toInlineRange(range);\n\n        if (!isMaybeInlineRangeEqual(inlineRange, targetInlineRange)) {\n          inlineRange = targetInlineRange;\n        }\n      }\n    }\n\n    if (!inlineRange) return;\n\n    event.preventDefault();\n\n    const ctx: BeforeinputHookCtx<TextAttributes> = {\n      inlineEditor: this.editor,\n      raw: event,\n      inlineRange,\n      data: event.data ?? event.dataTransfer?.getData('text/plain') ?? null,\n      attributes: {} as TextAttributes,\n    };\n    this.editor.hooks.beforeinput?.(ctx);\n\n    transformInput<TextAttributes>(\n      ctx.raw.inputType,\n      ctx.data,\n      ctx.attributes,\n      ctx.inlineRange,\n      this.editor as never\n    );\n\n    this.editor.slots.inputting.next(event.data ?? '');\n  };\n\n  private readonly _onClick = (event: MouseEvent) => {\n    // select embed element when click on it\n    if (event.target instanceof Node && isInEmbedElement(event.target)) {\n      const selection = document.getSelection();\n      if (!selection) return;\n      if (event.target instanceof HTMLElement) {\n        const vElement = event.target.closest('v-element');\n        if (vElement) {\n          selection.selectAllChildren(vElement);\n        }\n      } else {\n        const vElement = event.target.parentElement?.closest('v-element');\n        if (vElement) {\n          selection.selectAllChildren(vElement);\n        }\n      }\n    }\n  };\n\n  private readonly _onCompositionEnd = async (event: CompositionEvent) => {\n    this._isComposing = false;\n    if (!this.editor.rootElement || !this.editor.rootElement.isConnected) {\n      return;\n    }\n\n    const range = this.editor.rangeService.getNativeRange();\n    if (\n      this.editor.isReadonly ||\n      !range ||\n      !this._isRangeCompletelyInRoot(range)\n    )\n      return;\n\n    this.editor.rerenderWholeEditor();\n    await this.editor.waitForUpdate();\n\n    const inlineRange = this._compositionInlineRange;\n    if (!inlineRange) return;\n\n    event.preventDefault();\n\n    const ctx: CompositionEndHookCtx<TextAttributes> = {\n      inlineEditor: this.editor,\n      raw: event,\n      inlineRange,\n      data: event.data,\n      attributes: {} as TextAttributes,\n    };\n    this.editor.hooks.compositionEnd?.(ctx);\n\n    const { inlineRange: newInlineRange, data: newData } = ctx;\n    if (newData && newData.length > 0) {\n      this.editor.insertText(newInlineRange, newData, ctx.attributes);\n      this.editor.setInlineRange({\n        index: newInlineRange.index + newData.length,\n        length: 0,\n      });\n    }\n\n    this.editor.slots.inputting.next(event.data ?? '');\n  };\n\n  private readonly _onCompositionStart = (event: CompositionEvent) => {\n    this._isComposing = true;\n    if (!this.editor.rootElement) return;\n    // embeds is not editable and it will break IME\n    const embeds = this.editor.rootElement.querySelectorAll(\n      '[data-v-embed=\"true\"]'\n    );\n    embeds.forEach(embed => {\n      embed.removeAttribute('contenteditable');\n    });\n\n    const range = this.editor.rangeService.getNativeRange();\n    if (range) {\n      this._compositionInlineRange = this.editor.toInlineRange(range);\n    } else {\n      this._compositionInlineRange = null;\n    }\n\n    this.editor.slots.inputting.next(event.data ?? '');\n  };\n\n  private readonly _onCompositionUpdate = (event: CompositionEvent) => {\n    if (!this.editor.rootElement || !this.editor.rootElement.isConnected) {\n      return;\n    }\n\n    const range = this.editor.rangeService.getNativeRange();\n    if (\n      this.editor.isReadonly ||\n      !range ||\n      !this._isRangeCompletelyInRoot(range)\n    )\n      return;\n\n    this.editor.slots.inputting.next(event.data ?? '');\n  };\n\n  private readonly _onKeyDown = (event: KeyboardEvent) => {\n    const inlineRange = this.editor.getInlineRange();\n    if (!inlineRange) return;\n\n    this.editor.slots.keydown.next(event);\n\n    if (\n      !event.shiftKey &&\n      (event.key === 'ArrowLeft' || event.key === 'ArrowRight')\n    ) {\n      if (inlineRange.length !== 0) return;\n\n      const prevent = () => {\n        event.preventDefault();\n        event.stopPropagation();\n      };\n\n      const deltas = this.editor.getDeltasByInlineRange(inlineRange);\n      if (deltas.length === 2) {\n        if (event.key === 'ArrowLeft' && this.editor.isEmbed(deltas[0][0])) {\n          prevent();\n          this.editor.setInlineRange({\n            index: inlineRange.index - 1,\n            length: 1,\n          });\n        } else if (\n          event.key === 'ArrowRight' &&\n          this.editor.isEmbed(deltas[1][0])\n        ) {\n          prevent();\n          this.editor.setInlineRange({\n            index: inlineRange.index,\n            length: 1,\n          });\n        }\n      } else if (deltas.length === 1) {\n        const delta = deltas[0][0];\n        if (this.editor.isEmbed(delta)) {\n          if (event.key === 'ArrowLeft' && inlineRange.index - 1 >= 0) {\n            prevent();\n            this.editor.setInlineRange({\n              index: inlineRange.index - 1,\n              length: 1,\n            });\n          } else if (\n            event.key === 'ArrowRight' &&\n            inlineRange.index + 1 <= this.editor.yTextLength\n          ) {\n            prevent();\n            this.editor.setInlineRange({\n              index: inlineRange.index,\n              length: 1,\n            });\n          }\n        }\n      }\n    }\n  };\n\n  private readonly _onSelectionChange = () => {\n    const rootElement = this.editor.rootElement;\n    if (!rootElement) return;\n\n    const previousInlineRange = this.editor.getInlineRange();\n    if (this._isComposing) {\n      return;\n    }\n\n    const selection = document.getSelection();\n    if (!selection) return;\n    if (selection.rangeCount === 0) {\n      if (previousInlineRange !== null) {\n        this.editor.setInlineRange(null);\n      }\n\n      return;\n    }\n\n    const range = selection.getRangeAt(0);\n    if (!range.intersectsNode(rootElement)) {\n      const isContainerSelected =\n        range.endContainer.contains(rootElement) &&\n        Array.from(range.endContainer.childNodes).filter(\n          node => node instanceof HTMLElement\n        ).length === 1 &&\n        range.startContainer.contains(rootElement) &&\n        Array.from(range.startContainer.childNodes).filter(\n          node => node instanceof HTMLElement\n        ).length === 1;\n      if (isContainerSelected) {\n        this.editor.focusEnd();\n        return;\n      } else {\n        if (previousInlineRange !== null) {\n          this.editor.setInlineRange(null);\n        }\n        return;\n      }\n    }\n\n    const inlineRange = this.editor.toInlineRange(selection.getRangeAt(0));\n    if (!isMaybeInlineRangeEqual(previousInlineRange, inlineRange)) {\n      this.editor.rangeService.lockSyncInlineRange();\n      this.editor.setInlineRange(inlineRange);\n      this.editor.rangeService.unlockSyncInlineRange();\n    }\n  };\n\n  mount = () => {\n    const eventSource = this.editor.eventSource;\n    const rootElement = this.editor.rootElement;\n\n    if (!this.editor.inlineRangeProviderOverride) {\n      this.editor.disposables.addFromEvent(\n        document,\n        'selectionchange',\n        this._onSelectionChange\n      );\n    }\n\n    if (!eventSource) {\n      console.error('Mount inline editor without event source ready');\n      return;\n    }\n\n    this.editor.disposables.addFromEvent(\n      eventSource,\n      'beforeinput',\n      this._onBeforeInput\n    );\n    this.editor.disposables.addFromEvent(\n      eventSource,\n      'compositionstart',\n      this._onCompositionStart\n    );\n    this.editor.disposables.addFromEvent(\n      eventSource,\n      'compositionupdate',\n      this._onCompositionUpdate\n    );\n    this.editor.disposables.addFromEvent(eventSource, 'compositionend', e => {\n      this._onCompositionEnd(e).catch(console.error);\n    });\n    this.editor.disposables.addFromEvent(\n      eventSource,\n      'keydown',\n      this._onKeyDown\n    );\n    if (rootElement) {\n      this.editor.disposables.addFromEvent(rootElement, 'click', this._onClick);\n    }\n  };\n\n  get isComposing() {\n    return this._isComposing;\n  }\n\n  constructor(readonly editor: InlineEditor<TextAttributes>) {}\n}\n","import type { BaseTextAttributes } from '@blocksuite/store';\nimport { effect } from '@preact/signals-core';\nimport * as Y from 'yjs';\n\nimport type { VLine } from '../components/v-line.js';\nimport type { InlineEditor } from '../inline-editor.js';\nimport type { InlineRange, TextPoint } from '../types.js';\nimport { isInEmbedGap } from '../utils/embed.js';\nimport { isMaybeInlineRangeEqual } from '../utils/inline-range.js';\nimport {\n  domRangeToInlineRange,\n  inlineRangeToDomRange,\n} from '../utils/range-conversion.js';\nimport { calculateTextLength, getTextNodesFromElement } from '../utils/text.js';\n\nexport class RangeService<TextAttributes extends BaseTextAttributes> {\n  private _lastEndRelativePosition: Y.RelativePosition | null = null;\n\n  private _lastStartRelativePosition: Y.RelativePosition | null = null;\n\n  focusEnd = (): void => {\n    this.editor.setInlineRange({\n      index: this.editor.yTextLength,\n      length: 0,\n    });\n  };\n\n  focusIndex = (index: number): void => {\n    this.editor.setInlineRange({\n      index,\n      length: 0,\n    });\n  };\n\n  focusStart = (): void => {\n    this.editor.setInlineRange({\n      index: 0,\n      length: 0,\n    });\n  };\n\n  getInlineRangeFromElement = (element: Element): InlineRange | null => {\n    const range = document.createRange();\n    const text = element.querySelector('[data-v-text]');\n    if (!text) {\n      return null;\n    }\n    const textNode = text.childNodes[1];\n    if (!(textNode instanceof Text)) {\n      return null;\n    }\n    range.setStart(textNode, 0);\n    range.setEnd(textNode, textNode.textContent?.length ?? 0);\n    const inlineRange = this.toInlineRange(range);\n    return inlineRange;\n  };\n\n  // the number is related to the VLine's textLength\n  getLine = (\n    rangeIndex: InlineRange['index']\n  ): {\n    line: VLine;\n    lineIndex: number;\n    rangeIndexRelatedToLine: number;\n  } | null => {\n    const rootElement = this.editor.rootElement;\n    if (!rootElement) return null;\n\n    const lineElements = Array.from(rootElement.querySelectorAll('v-line'));\n\n    let beforeIndex = 0;\n    for (const [lineIndex, lineElement] of lineElements.entries()) {\n      if (\n        rangeIndex >= beforeIndex &&\n        rangeIndex < beforeIndex + lineElement.vTextLength + 1\n      ) {\n        return {\n          line: lineElement,\n          lineIndex,\n          rangeIndexRelatedToLine: rangeIndex - beforeIndex,\n        };\n      }\n      beforeIndex += lineElement.vTextLength + 1;\n    }\n\n    console.error('failed to find line');\n    return null;\n  };\n\n  getNativeRange = (): Range | null => {\n    const selection = this.getNativeSelection();\n    if (!selection) return null;\n    return selection.getRangeAt(0);\n  };\n\n  getNativeSelection = (): Selection | null => {\n    const selection = document.getSelection();\n    if (!selection) return null;\n    if (selection.rangeCount === 0) return null;\n\n    return selection;\n  };\n\n  getTextPoint = (rangeIndex: InlineRange['index']): TextPoint | null => {\n    const rootElement = this.editor.rootElement;\n    if (!rootElement) return null;\n\n    const vLines = Array.from(rootElement.querySelectorAll('v-line'));\n\n    let index = 0;\n    for (const vLine of vLines) {\n      const texts = getTextNodesFromElement(vLine);\n      if (texts.length === 0) {\n        return null;\n      }\n\n      for (const text of texts.filter(text => !isInEmbedGap(text))) {\n        if (!text.textContent) {\n          return null;\n        }\n        if (index + text.textContent.length >= rangeIndex) {\n          return [text, rangeIndex - index];\n        }\n        index += calculateTextLength(text);\n      }\n\n      index += 1;\n    }\n\n    return null;\n  };\n\n  /**\n   * There are two cases to have the second line:\n   * 1. long text auto wrap in span element\n   * 2. soft break\n   */\n  isFirstLine = (inlineRange: InlineRange | null): boolean => {\n    if (!inlineRange || inlineRange.length > 0) return false;\n\n    const range = this.toDomRange(inlineRange);\n    if (!range) {\n      console.error('failed to convert inline range to domRange');\n      return false;\n    }\n\n    // check case 1:\n    const beforeText = this.editor.yTextString.slice(0, inlineRange.index);\n    if (beforeText.includes('\\n')) {\n      return false;\n    }\n\n    // check case 2:\n    // If there is a wrapped text, there are two possible positions for\n    // cursor: (in first line and in second line)\n    // aaaaaaaa| or aaaaaaaa\n    // bb           |bb\n    // We have no way to distinguish them and we just assume that the cursor\n    // can not in the first line because if we apply the inline ranage manually the\n    // cursor will jump to the second line.\n    const container = range.commonAncestorContainer.parentElement;\n    if (!container) {\n      console.error('failed to get container');\n      return false;\n    }\n    const containerRect = container.getBoundingClientRect();\n    // There will be two rects if the cursor is at the edge of the line:\n    // aaaaaaaa| or aaaaaaaa\n    // bb           |bb\n    const rangeRects = range.getClientRects();\n    // We use last rect here to make sure we get the second rect.\n    // (Based on the assumption that the cursor can not in the first line)\n    const rangeRect = rangeRects[rangeRects.length - 1];\n    const tolerance = 1;\n    return Math.abs(rangeRect.top - containerRect.top) < tolerance;\n  };\n\n  /**\n   * There are two cases to have the second line:\n   * 1. long text auto wrap in span element\n   * 2. soft break\n   */\n  isLastLine = (inlineRange: InlineRange | null): boolean => {\n    if (!inlineRange || inlineRange.length > 0) return false;\n\n    // check case 1:\n    const afterText = this.editor.yTextString.slice(inlineRange.index);\n    if (afterText.includes('\\n')) {\n      return false;\n    }\n\n    const range = this.toDomRange(inlineRange);\n    if (!range) {\n      console.error('failed to convert inline range to domRange');\n      return false;\n    }\n\n    // check case 2:\n    // If there is a wrapped text, there are two possible positions for\n    // cursor: (in first line and in second line)\n    // aaaaaaaa| or aaaaaaaa\n    // bb           |bb\n    // We have no way to distinguish them and we just assume that the cursor\n    // can not in the first line because if we apply the inline range manually the\n    // cursor will jump to the second line.\n    const container = range.commonAncestorContainer.parentElement;\n    if (!container) {\n      console.error('failed to get container');\n      return false;\n    }\n    const containerRect = container.getBoundingClientRect();\n    // There will be two rects if the cursor is at the edge of the line:\n    // aaaaaaaa| or aaaaaaaa\n    // bb           |bb\n    const rangeRects = range.getClientRects();\n    // We use last rect here to make sure we get the second rect.\n    // (Based on the assumption that the cursor can not be in the first line)\n    const rangeRect = rangeRects[rangeRects.length - 1];\n\n    const tolerance = 1;\n    return Math.abs(rangeRect.bottom - containerRect.bottom) < tolerance;\n  };\n\n  isValidInlineRange = (inlineRange: InlineRange | null): boolean => {\n    return !(\n      inlineRange &&\n      (inlineRange.index < 0 ||\n        inlineRange.index + inlineRange.length > this.editor.yText.length)\n    );\n  };\n\n  mount = () => {\n    const editor = this.editor;\n    let lastInlineRange: InlineRange | null = editor.inlineRange$.value;\n    editor.disposables.add(\n      effect(() => {\n        const newInlineRange = editor.inlineRange$.value;\n        if (!editor.mounted) return;\n\n        const eq = isMaybeInlineRangeEqual(lastInlineRange, newInlineRange);\n        if (eq) return;\n        lastInlineRange = newInlineRange;\n\n        const yText = editor.yText;\n        if (newInlineRange) {\n          this._lastStartRelativePosition =\n            Y.createRelativePositionFromTypeIndex(yText, newInlineRange.index);\n          this._lastEndRelativePosition = Y.createRelativePositionFromTypeIndex(\n            yText,\n            newInlineRange.index + newInlineRange.length\n          );\n        } else {\n          this._lastStartRelativePosition = null;\n          this._lastEndRelativePosition = null;\n        }\n\n        if (editor.inlineRangeProviderOverride) return;\n\n        if (this.editor.renderService.rendering) {\n          const subscription = editor.slots.renderComplete.subscribe(() => {\n            subscription.unsubscribe();\n            this.syncInlineRange(newInlineRange);\n          });\n        } else {\n          this.syncInlineRange();\n        }\n      })\n    );\n  };\n\n  selectAll = (): void => {\n    this.editor.setInlineRange({\n      index: 0,\n      length: this.editor.yTextLength,\n    });\n  };\n\n  private _syncInlineRangeLock = false;\n  lockSyncInlineRange = () => {\n    this._syncInlineRangeLock = true;\n  };\n  unlockSyncInlineRange = () => {\n    this._syncInlineRangeLock = false;\n  };\n  /**\n   * sync the dom selection from inline range for **this Editor**\n   */\n  syncInlineRange = (inlineRange?: InlineRange | null) => {\n    if (!this.editor.mounted || this._syncInlineRangeLock) return;\n    inlineRange = inlineRange ?? this.editor.getInlineRange();\n\n    const handler = () => {\n      const selection = document.getSelection();\n      if (!selection) return;\n      if (!this.editor.rootElement) return;\n\n      if (inlineRange === null) {\n        if (selection.rangeCount > 0) {\n          const range = selection.getRangeAt(0);\n          if (range.intersectsNode(this.editor.rootElement)) {\n            selection.removeAllRanges();\n          }\n        }\n      } else {\n        try {\n          const newRange = this.toDomRange(inlineRange);\n          if (newRange) {\n            selection.removeAllRanges();\n            selection.addRange(newRange);\n            this.editor.rootElement.focus();\n\n            this.editor.slots.inlineRangeSync.next(newRange);\n          } else {\n            const subscription = this.editor.slots.renderComplete.subscribe(\n              () => {\n                subscription.unsubscribe();\n                this.syncInlineRange(inlineRange);\n              }\n            );\n          }\n        } catch (error) {\n          console.error('failed to apply inline range');\n          console.error(error);\n        }\n      }\n    };\n\n    if (this.editor.renderService.rendering) {\n      const subscription = this.editor.slots.renderComplete.subscribe(() => {\n        subscription.unsubscribe();\n        handler();\n      });\n    } else {\n      handler();\n    }\n  };\n\n  /**\n   * calculate the dom selection from inline ranage for **this Editor**\n   */\n  toDomRange = (inlineRange: InlineRange): Range | null => {\n    const rootElement = this.editor.rootElement;\n    if (!rootElement) return null;\n    return inlineRangeToDomRange(rootElement, inlineRange);\n  };\n\n  /**\n   * calculate the inline ranage from dom selection for **this Editor**\n   * there are three cases when the inline ranage of this Editor is not null:\n   * (In the following, \"|\" mean anchor and focus, each line is a separate Editor)\n   * 1. anchor and focus are in this Editor\n   *    ```\n   *    aaaaaa\n   *    b|bbbb|b\n   *    cccccc\n   *    ```\n   *    the inline ranage of second Editor is `{index: 1, length: 4}`, the others are null\n   * 2. anchor and focus one in this Editor, one in another Editor\n   *    ```\n   *    aaa|aaa    aaaaaa\n   *    bbbbb|b or bbbbb|b\n   *    cccccc     cc|cccc\n   *    ```\n   *    2.1\n   *        the inline ranage of first Editor is `{index: 3, length: 3}`, the second is `{index: 0, length: 5}`,\n   *        the third is null\n   *    2.2\n   *        the inline ranage of first Editor is null, the second is `{index: 5, length: 1}`,\n   *        the third is `{index: 0, length: 2}`\n   * 3. anchor and focus are in another Editor\n   *    ```\n   *    aa|aaaa\n   *    bbbbbb\n   *    cccc|cc\n   *    ```\n   *    the inline range of first Editor is `{index: 2, length: 4}`,\n   *    the second is `{index: 0, length: 6}`, the third is `{index: 0, length: 4}`\n   */\n  toInlineRange = (range: Range): InlineRange | null => {\n    const { rootElement, yText } = this.editor;\n    if (!rootElement || !yText) return null;\n    return domRangeToInlineRange(range, rootElement, yText);\n  };\n\n  get lastEndRelativePosition() {\n    return this._lastEndRelativePosition;\n  }\n\n  get lastStartRelativePosition() {\n    return this._lastStartRelativePosition;\n  }\n\n  constructor(readonly editor: InlineEditor<TextAttributes>) {}\n}\n","import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport type { BaseTextAttributes } from '@blocksuite/store';\nimport { html, render } from 'lit';\nimport { repeat } from 'lit/directives/repeat.js';\nimport * as Y from 'yjs';\n\nimport type { VLine } from '../components/v-line.js';\nimport type { InlineEditor } from '../inline-editor.js';\nimport type { InlineRange } from '../types.js';\nimport { deltaInsertsToChunks } from '../utils/delta-convert.js';\n\nexport class RenderService<TextAttributes extends BaseTextAttributes> {\n  private readonly _onYTextChange = (\n    _: Y.YTextEvent,\n    transaction: Y.Transaction\n  ) => {\n    this.editor.slots.textChange.next();\n\n    const yText = this.editor.yText;\n\n    if (yText.toString().includes('\\r')) {\n      throw new BlockSuiteError(\n        ErrorCode.InlineEditorError,\n        'yText must not contain \"\\\\r\" because it will break the range synchronization'\n      );\n    }\n\n    this.render();\n\n    const inlineRange = this.editor.inlineRange$.peek();\n    if (!inlineRange || transaction.local) return;\n\n    const lastStartRelativePosition = this.editor.lastStartRelativePosition;\n    const lastEndRelativePosition = this.editor.lastEndRelativePosition;\n    if (!lastStartRelativePosition || !lastEndRelativePosition) return;\n\n    const doc = this.editor.yText.doc;\n    if (!doc) {\n      console.error('doc is not found when syncing yText');\n      return;\n    }\n    const absoluteStart = Y.createAbsolutePositionFromRelativePosition(\n      lastStartRelativePosition,\n      doc\n    );\n    const absoluteEnd = Y.createAbsolutePositionFromRelativePosition(\n      lastEndRelativePosition,\n      doc\n    );\n\n    const startIndex = absoluteStart?.index;\n    const endIndex = absoluteEnd?.index;\n    if (!startIndex || !endIndex) return;\n\n    const newInlineRange: InlineRange = {\n      index: startIndex,\n      length: endIndex - startIndex,\n    };\n    if (!this.editor.isValidInlineRange(newInlineRange)) return;\n\n    this.editor.setInlineRange(newInlineRange);\n    this.editor.syncInlineRange();\n  };\n\n  mount = () => {\n    const editor = this.editor;\n    const yText = editor.yText;\n\n    yText.observe(this._onYTextChange);\n    editor.disposables.add({\n      dispose: () => {\n        yText.unobserve(this._onYTextChange);\n      },\n    });\n  };\n\n  private _rendering = false;\n  get rendering() {\n    return this._rendering;\n  }\n  // render current deltas to VLines\n  render = () => {\n    if (!this.editor.rootElement) return;\n\n    this._rendering = true;\n\n    const rootElement = this.editor.rootElement;\n    const embedDeltas = this.editor.deltaService.embedDeltas;\n    const chunks = deltaInsertsToChunks(embedDeltas);\n\n    let deltaIndex = 0;\n    // every chunk is a line\n    const lines = chunks.map((chunk, lineIndex) => {\n      if (lineIndex > 0) {\n        deltaIndex += 1; // for '\\n'\n      }\n\n      const lineStartOffset = deltaIndex;\n      if (chunk.length > 0) {\n        const elements: VLine['elements'] = chunk.map(delta => {\n          const startOffset = deltaIndex;\n          deltaIndex += delta.insert.length;\n          const endOffset = deltaIndex;\n\n          return [\n            html`<v-element\n              .inlineEditor=${this.editor}\n              .delta=${{\n                insert: delta.insert,\n                attributes: this.editor.attributeService.normalizeAttributes(\n                  delta.attributes\n                ),\n              }}\n              .startOffset=${startOffset}\n              .endOffset=${endOffset}\n              .lineIndex=${lineIndex}\n            ></v-element>`,\n            delta,\n          ];\n        });\n\n        return html`<v-line\n          .elements=${elements}\n          .index=${lineIndex}\n          .startOffset=${lineStartOffset}\n          .endOffset=${deltaIndex}\n        ></v-line>`;\n      } else {\n        return html`<v-line\n          .elements=${[]}\n          .index=${lineIndex}\n          .startOffset=${lineStartOffset}\n          .endOffset=${deltaIndex}\n        ></v-line>`;\n      }\n    });\n\n    try {\n      render(\n        repeat(\n          lines.map((line, i) => ({ line, index: i })),\n          entry => entry.index,\n          entry => entry.line\n        ),\n        rootElement\n      );\n    } catch {\n      // Lit may be crashed by IME input and we need to rerender whole editor for it\n      this.editor.rerenderWholeEditor();\n    }\n\n    this.editor\n      .waitForUpdate()\n      .then(() => {\n        this._rendering = false;\n        this.editor.slots.renderComplete.next();\n        this.editor.syncInlineRange();\n      })\n      .catch(console.error);\n  };\n\n  rerenderWholeEditor = () => {\n    const rootElement = this.editor.rootElement;\n\n    if (!rootElement || !rootElement.isConnected) return;\n\n    rootElement.replaceChildren();\n    // Because we bypassed Lit and disrupted the DOM structure, this will cause an inconsistency in the original state of `ChildPart`.\n    // Therefore, we need to remove the original `ChildPart`.\n    // https://github.com/lit/lit/blob/a2cd76cfdea4ed717362bb1db32710d70550469d/packages/lit-html/src/lit-html.ts#L2248\n\n    delete (rootElement as any)['_$litPart$'];\n    this.render();\n  };\n\n  waitForUpdate = async () => {\n    if (!this.editor.rootElement) return;\n    const vLines = Array.from(\n      this.editor.rootElement.querySelectorAll('v-line')\n    );\n    await Promise.all(vLines.map(line => line.updateComplete));\n  };\n\n  constructor(readonly editor: InlineEditor<TextAttributes>) {}\n}\n","import type { BaseTextAttributes, DeltaInsert } from '@blocksuite/store';\n\nimport type { InlineEditor } from '../inline-editor.js';\nimport type { InlineRange } from '../types.js';\nimport { intersectInlineRange } from '../utils/inline-range.js';\n\nexport class InlineTextService<TextAttributes extends BaseTextAttributes> {\n  deleteText = (inlineRange: InlineRange): void => {\n    if (this.editor.isReadonly) return;\n\n    this.transact(() => {\n      this.yText.delete(inlineRange.index, inlineRange.length);\n    });\n  };\n\n  formatText = (\n    inlineRange: InlineRange,\n    attributes: TextAttributes,\n    options: {\n      match?: (delta: DeltaInsert, deltaInlineRange: InlineRange) => boolean;\n      mode?: 'replace' | 'merge';\n      withoutTransact?: boolean;\n    } = {}\n  ): void => {\n    if (this.editor.isReadonly) return;\n\n    const {\n      match = () => true,\n      mode = 'merge',\n      withoutTransact = false,\n    } = options;\n    const deltas = this.editor.deltaService.getDeltasByInlineRange(inlineRange);\n\n    deltas\n      .filter(([delta, deltaInlineRange]) => match(delta, deltaInlineRange))\n      .forEach(([_delta, deltaInlineRange]) => {\n        const normalizedAttributes =\n          this.editor.attributeService.normalizeAttributes(attributes);\n        if (!normalizedAttributes) return;\n\n        const targetInlineRange = intersectInlineRange(\n          inlineRange,\n          deltaInlineRange\n        );\n        if (!targetInlineRange) return;\n\n        if (mode === 'replace') {\n          this.resetText(targetInlineRange);\n        }\n\n        this.transact(() => {\n          this.yText.format(\n            targetInlineRange.index,\n            targetInlineRange.length,\n            normalizedAttributes\n          );\n        }, withoutTransact);\n      });\n  };\n\n  insertLineBreak = (inlineRange: InlineRange): void => {\n    if (this.editor.isReadonly) return;\n\n    this.transact(() => {\n      this.yText.delete(inlineRange.index, inlineRange.length);\n      this.yText.insert(inlineRange.index, '\\n');\n    });\n  };\n\n  insertText = (\n    inlineRange: InlineRange,\n    text: string,\n    attributes: TextAttributes = {} as TextAttributes\n  ): void => {\n    if (this.editor.isReadonly) return;\n\n    if (!text || !text.length) return;\n\n    if (this.editor.attributeService.marks) {\n      attributes = { ...attributes, ...this.editor.attributeService.marks };\n    }\n    const normalizedAttributes =\n      this.editor.attributeService.normalizeAttributes(attributes);\n\n    this.transact(() => {\n      this.yText.delete(inlineRange.index, inlineRange.length);\n      this.yText.insert(inlineRange.index, text, normalizedAttributes);\n    });\n  };\n\n  resetText = (inlineRange: InlineRange): void => {\n    if (this.editor.isReadonly) return;\n\n    const coverDeltas: DeltaInsert[] = [];\n    for (\n      let i = inlineRange.index;\n      i <= inlineRange.index + inlineRange.length;\n      i++\n    ) {\n      const delta = this.editor.getDeltaByRangeIndex(i);\n      if (delta) {\n        coverDeltas.push(delta);\n      }\n    }\n\n    const unset = Object.fromEntries(\n      coverDeltas.flatMap(delta =>\n        delta.attributes\n          ? Object.keys(delta.attributes).map(key => [key, null])\n          : []\n      )\n    );\n\n    this.transact(() => {\n      this.yText.format(inlineRange.index, inlineRange.length, {\n        ...unset,\n      });\n    });\n  };\n\n  setText = (\n    text: string,\n    attributes: TextAttributes = {} as TextAttributes\n  ): void => {\n    if (this.editor.isReadonly) return;\n\n    this.transact(() => {\n      this.yText.delete(0, this.yText.length);\n      this.yText.insert(0, text, attributes);\n    });\n  };\n\n  readonly transact = this.editor.transact;\n\n  get yText() {\n    return this.editor.yText;\n  }\n\n  constructor(readonly editor: InlineEditor<TextAttributes>) {}\n}\n","import { DisposableGroup } from '@blocksuite/global/disposable';\nimport { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport type { BaseTextAttributes, DeltaInsert } from '@blocksuite/store';\nimport { type Signal, signal } from '@preact/signals-core';\nimport { nothing, render, type TemplateResult } from 'lit';\nimport { Subject } from 'rxjs';\nimport type * as Y from 'yjs';\n\nimport type { VLine } from './components/v-line.js';\nimport { INLINE_ROOT_ATTR } from './consts.js';\nimport { InlineHookService } from './services/hook.js';\nimport {\n  AttributeService,\n  DeltaService,\n  EventService,\n  RangeService,\n} from './services/index.js';\nimport { RenderService } from './services/render.js';\nimport { InlineTextService } from './services/text.js';\nimport type { InlineRange } from './types.js';\nimport { nativePointToTextPoint, textPointToDomPoint } from './utils/index.js';\nimport { getTextNodesFromElement } from './utils/text.js';\n\nexport type InlineRootElement<\n  T extends BaseTextAttributes = BaseTextAttributes,\n> = HTMLElement & {\n  inlineEditor: InlineEditor<T>;\n};\n\nexport interface InlineRangeProvider {\n  inlineRange$: Signal<InlineRange | null>;\n  setInlineRange(inlineRange: InlineRange | null): void;\n}\n\nexport class InlineEditor<\n  TextAttributes extends BaseTextAttributes = BaseTextAttributes,\n> {\n  static getTextNodesFromElement = getTextNodesFromElement;\n\n  static nativePointToTextPoint = nativePointToTextPoint;\n\n  static textPointToDomPoint = textPointToDomPoint;\n\n  readonly disposables = new DisposableGroup();\n\n  readonly attributeService: AttributeService<TextAttributes> =\n    new AttributeService<TextAttributes>(this);\n  getFormat = this.attributeService.getFormat;\n  normalizeAttributes = this.attributeService.normalizeAttributes;\n  resetMarks = this.attributeService.resetMarks;\n  setAttributeRenderer = this.attributeService.setAttributeRenderer;\n  setAttributeSchema = this.attributeService.setAttributeSchema;\n  setMarks = this.attributeService.setMarks;\n  get marks() {\n    return this.attributeService.marks;\n  }\n\n  readonly textService: InlineTextService<TextAttributes> =\n    new InlineTextService<TextAttributes>(this);\n  deleteText = this.textService.deleteText;\n  formatText = this.textService.formatText;\n  insertLineBreak = this.textService.insertLineBreak;\n  insertText = this.textService.insertText;\n  resetText = this.textService.resetText;\n  setText = this.textService.setText;\n\n  readonly deltaService: DeltaService<TextAttributes> =\n    new DeltaService<TextAttributes>(this);\n  getDeltaByRangeIndex = this.deltaService.getDeltaByRangeIndex;\n  getDeltasByInlineRange = this.deltaService.getDeltasByInlineRange;\n  mapDeltasInInlineRange = this.deltaService.mapDeltasInInlineRange;\n  get embedDeltas() {\n    return this.deltaService.embedDeltas;\n  }\n\n  readonly rangeService: RangeService<TextAttributes> =\n    new RangeService<TextAttributes>(this);\n  focusEnd = this.rangeService.focusEnd;\n  focusIndex = this.rangeService.focusIndex;\n  focusStart = this.rangeService.focusStart;\n  getInlineRangeFromElement = this.rangeService.getInlineRangeFromElement;\n  isFirstLine = this.rangeService.isFirstLine;\n  isLastLine = this.rangeService.isLastLine;\n  isValidInlineRange = this.rangeService.isValidInlineRange;\n  selectAll = this.rangeService.selectAll;\n  syncInlineRange = this.rangeService.syncInlineRange;\n  toDomRange = this.rangeService.toDomRange;\n  toInlineRange = this.rangeService.toInlineRange;\n  getLine = this.rangeService.getLine;\n  getNativeRange = this.rangeService.getNativeRange;\n  getNativeSelection = this.rangeService.getNativeSelection;\n  getTextPoint = this.rangeService.getTextPoint;\n  get lastStartRelativePosition() {\n    return this.rangeService.lastStartRelativePosition;\n  }\n  get lastEndRelativePosition() {\n    return this.rangeService.lastEndRelativePosition;\n  }\n\n  readonly eventService: EventService<TextAttributes> =\n    new EventService<TextAttributes>(this);\n  get isComposing() {\n    return this.eventService.isComposing;\n  }\n\n  readonly renderService: RenderService<TextAttributes> =\n    new RenderService<TextAttributes>(this);\n  waitForUpdate = this.renderService.waitForUpdate;\n  rerenderWholeEditor = this.renderService.rerenderWholeEditor;\n  render = this.renderService.render;\n  get rendering() {\n    return this.renderService.rendering;\n  }\n\n  readonly hooksService: InlineHookService<TextAttributes>;\n  get hooks() {\n    return this.hooksService.hooks;\n  }\n\n  private _eventSource: HTMLElement | null = null;\n  get eventSource() {\n    return this._eventSource;\n  }\n\n  private _isReadonly = false;\n  get isReadonly() {\n    return this._isReadonly;\n  }\n\n  private _mounted = false;\n  get mounted() {\n    return this._mounted;\n  }\n\n  private _rootElement: InlineRootElement<TextAttributes> | null = null;\n  get rootElement() {\n    return this._rootElement;\n  }\n\n  private readonly _inlineRangeProviderOverride: boolean;\n  get inlineRangeProviderOverride() {\n    return this._inlineRangeProviderOverride;\n  }\n  readonly inlineRangeProvider: InlineRangeProvider = {\n    inlineRange$: signal(null),\n    setInlineRange: inlineRange => {\n      this.inlineRange$.value = inlineRange;\n    },\n  };\n  get inlineRange$() {\n    return this.inlineRangeProvider.inlineRange$;\n  }\n  setInlineRange = (inlineRange: InlineRange | null) => {\n    this.inlineRangeProvider.setInlineRange(inlineRange);\n  };\n  getInlineRange = () => {\n    return this.inlineRange$.peek();\n  };\n\n  readonly slots = {\n    mounted: new Subject<void>(),\n    unmounted: new Subject<void>(),\n    renderComplete: new Subject<void>(),\n    textChange: new Subject<void>(),\n    inlineRangeSync: new Subject<Range | null>(),\n    /**\n     * Corresponding to the `compositionUpdate` and `beforeInput` events, and triggered only when the `inlineRange` is not null.\n     * The parameter is the `event.data`.\n     */\n    inputting: new Subject<string>(),\n    /**\n     * Triggered only when the `inlineRange` is not null.\n     */\n    keydown: new Subject<KeyboardEvent>(),\n  };\n\n  readonly vLineRenderer: ((vLine: VLine) => TemplateResult) | null;\n\n  readonly yText: Y.Text;\n  get yTextDeltas() {\n    return this.yText.toDelta();\n  }\n  get yTextLength() {\n    return this.yText.length;\n  }\n  get yTextString() {\n    return this.yText.toString();\n  }\n\n  readonly isEmbed: (delta: DeltaInsert<TextAttributes>) => boolean;\n\n  constructor(\n    yText: InlineEditor['yText'],\n    ops: {\n      isEmbed?: (delta: DeltaInsert<TextAttributes>) => boolean;\n      hooks?: InlineHookService<TextAttributes>['hooks'];\n      inlineRangeProvider?: InlineRangeProvider;\n      vLineRenderer?: (vLine: VLine) => TemplateResult;\n    } = {}\n  ) {\n    if (!yText.doc) {\n      throw new BlockSuiteError(\n        ErrorCode.InlineEditorError,\n        'yText must be attached to a Y.Doc'\n      );\n    }\n\n    if (yText.toString().includes('\\r')) {\n      throw new BlockSuiteError(\n        ErrorCode.InlineEditorError,\n        'yText must not contain \"\\\\r\" because it will break the range synchronization'\n      );\n    }\n\n    const {\n      isEmbed = () => false,\n      hooks = {},\n      inlineRangeProvider,\n      vLineRenderer = null,\n    } = ops;\n    this._inlineRangeProviderOverride = false;\n    this.yText = yText;\n    this.isEmbed = isEmbed;\n    this.vLineRenderer = vLineRenderer;\n    this.hooksService = new InlineHookService(this, hooks);\n    if (inlineRangeProvider) {\n      this.inlineRangeProvider = inlineRangeProvider;\n      this._inlineRangeProviderOverride = true;\n    }\n  }\n\n  mount(\n    rootElement: HTMLElement,\n    eventSource: HTMLElement = rootElement,\n    isReadonly = false\n  ) {\n    const inlineRoot = rootElement as InlineRootElement<TextAttributes>;\n    inlineRoot.inlineEditor = this;\n    this._rootElement = inlineRoot;\n    this._eventSource = eventSource;\n    this._eventSource.style.outline = 'none';\n    this._rootElement.dataset.vRoot = 'true';\n    this.setReadonly(isReadonly);\n\n    this._rootElement.replaceChildren();\n\n    delete (this.rootElement as any)['_$litPart$'];\n\n    this.eventService.mount();\n    this.rangeService.mount();\n    this.renderService.mount();\n\n    this._mounted = true;\n    this.slots.mounted.next();\n\n    this.render();\n  }\n\n  unmount() {\n    if (this.rootElement) {\n      if (this.rootElement.isConnected) {\n        render(nothing, this.rootElement);\n      }\n      this.rootElement.removeAttribute(INLINE_ROOT_ATTR);\n    }\n    this._rootElement = null;\n    this._mounted = false;\n    this.disposables.dispose();\n    this.slots.unmounted.next();\n  }\n\n  setReadonly(isReadonly: boolean): void {\n    const value = isReadonly ? 'false' : 'true';\n\n    if (this.rootElement && this.rootElement.contentEditable !== value) {\n      this.rootElement.contentEditable = value;\n    }\n\n    this._isReadonly = isReadonly;\n  }\n\n  /**\n   * @param withoutTransact Execute a transaction without capturing the history.\n   */\n  transact(fn: () => void, withoutTransact = false): void {\n    const doc = this.yText.doc;\n    if (!doc) {\n      throw new BlockSuiteError(\n        ErrorCode.InlineEditorError,\n        'yText is not attached to a doc'\n      );\n    }\n\n    doc.transact(fn, withoutTransact ? null : doc.clientID);\n  }\n}\n","import { GfxViewportElement } from './gfx/viewport-element.js';\nimport { VElement, VLine, VText } from './inline/index.js';\nimport { EditorHost } from './view/index.js';\n\nexport function effects() {\n  // editor host\n  customElements.define('editor-host', EditorHost);\n  // gfx\n  customElements.define('gfx-viewport', GfxViewportElement);\n  // inline\n  customElements.define('v-element', VElement);\n  customElements.define('v-line', VLine);\n  customElements.define('v-text', VText);\n}\n"],"file":"assets/chunk.URTPIBTY-BfW3KnjQ.js"}